"use strict";
(self["webpackChunkexb_client"] = self["webpackChunkexb_client"] || []).push([["vendors-extensions_widgets_arcgis_analysis_node_modules_arcgis_app-components_dist_esm_arcgis-9104bb"],{

/***/ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/arcgis-layer-view_14.entry.js":
/*!***********************************************************************************************************************!*\
  !*** ./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/arcgis-layer-view_14.entry.js ***!
  \***********************************************************************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   arcgis_layer_view: () => (/* binding */ ArcgisLayerView$1),
/* harmony export */   arcgis_layer_view_browse_layer: () => (/* binding */ ArcgisLayerViewBrowseLayer),
/* harmony export */   arcgis_layer_view_create: () => (/* binding */ ArcgisLayerViewCreate$1),
/* harmony export */   arcgis_layer_view_definition: () => (/* binding */ ArcgisLayerViewDefinition),
/* harmony export */   arcgis_layer_view_join: () => (/* binding */ ArcgisLayerView),
/* harmony export */   arcgis_layer_view_join_add_selection: () => (/* binding */ ArcgisLayerViewJoinAddSelection),
/* harmony export */   arcgis_layer_view_join_browse_layer: () => (/* binding */ ArcgisLayerViewJoinBrowseLayer),
/* harmony export */   arcgis_layer_view_join_config: () => (/* binding */ ArcgisLayerViewJoinConfig),
/* harmony export */   arcgis_layer_view_join_create: () => (/* binding */ ArcgisLayerViewJoinCreate),
/* harmony export */   arcgis_layer_view_join_target_selection: () => (/* binding */ ArcgisLayerViewJoinTargetSelection),
/* harmony export */   arcgis_layer_view_msg: () => (/* binding */ ArcgisLayerViewCreate),
/* harmony export */   arcgis_layer_view_overview: () => (/* binding */ ArcgisLayerViewOverview),
/* harmony export */   arcgis_layer_view_selection: () => (/* binding */ ArcgisLayerViewSelection),
/* harmony export */   arcgis_layer_view_swap_source: () => (/* binding */ ArcgisLayerViewSwapSource)
/* harmony export */ });
/* harmony import */ var _index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./index-92ebb396.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/index-92ebb396.js");
/* harmony import */ var _locale_13e00a75_js__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./locale-13e00a75.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/locale-13e00a75.js");
/* harmony import */ var _loadModules_aaf30bd6_js__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./loadModules-aaf30bd6.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/loadModules-aaf30bd6.js");
/* harmony import */ var _commonFunctions_5262b094_js__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ./commonFunctions-5262b094.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/commonFunctions-5262b094.js");
/* harmony import */ var _functional_c82f5ab9_js__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ./functional-c82f5ab9.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/functional-c82f5ab9.js");
/* harmony import */ var _languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! ./languageUtil-22258c90.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/languageUtil-22258c90.js");
/* harmony import */ var _portal_8714dc6c_js__WEBPACK_IMPORTED_MODULE_6__ = __webpack_require__(/*! ./portal-8714dc6c.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/portal-8714dc6c.js");
/* harmony import */ var _item_properties_e6412a9a_js__WEBPACK_IMPORTED_MODULE_7__ = __webpack_require__(/*! ./item-properties-e6412a9a.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/item-properties-e6412a9a.js");
/* harmony import */ var _localStorage_f63100ef_js__WEBPACK_IMPORTED_MODULE_8__ = __webpack_require__(/*! ./localStorage-f63100ef.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/localStorage-f63100ef.js");
/* harmony import */ var _dom_13f5b00c_js__WEBPACK_IMPORTED_MODULE_9__ = __webpack_require__(/*! ./dom-13f5b00c.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/dom-13f5b00c.js");
/* harmony import */ var _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_10__ = __webpack_require__(/*! ./commonEnums-f98a323c.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/commonEnums-f98a323c.js");
/* harmony import */ var _index_81d548b7_js__WEBPACK_IMPORTED_MODULE_11__ = __webpack_require__(/*! ./index-81d548b7.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/index-81d548b7.js");
/*!
 * All material copyright ESRI, All Rights Reserved, unless otherwise specified.
 * v3.0.99
 */













const CSS$9 = {
  panel: "panel",
  footer: "footer",
  errorContent: "error-content"
};

var flowStatus;
(function (flowStatus) {
  flowStatus[flowStatus["ERROR"] = 0] = "ERROR";
  flowStatus[flowStatus["LOADING"] = 1] = "LOADING";
  flowStatus[flowStatus["SELECTION"] = 2] = "SELECTION";
  flowStatus[flowStatus["OVERVIEW"] = 3] = "OVERVIEW";
  flowStatus[flowStatus["SWAP_SOURCE"] = 4] = "SWAP_SOURCE";
  flowStatus[flowStatus["BROWSE_LAYER"] = 5] = "BROWSE_LAYER";
  flowStatus[flowStatus["DEFINITION"] = 6] = "DEFINITION";
  flowStatus[flowStatus["FILTER"] = 7] = "FILTER";
  flowStatus[flowStatus["CREATE"] = 8] = "CREATE";
})(flowStatus || (flowStatus = {}));
var actions;
(function (actions) {
  actions[actions["CANCEL"] = 0] = "CANCEL";
  actions[actions["CREATE"] = 1] = "CREATE";
})(actions || (actions = {}));
/**
 * Checks if a featureEffect on a layer is empty
 * @param effect - layer.featureEffect
 */
function isEffectEmpty(effect) {
  if (!effect || !effect.filter) {
    return true;
  }
  const checkProps = ["geometry", "distance", "objectIds", "timeExtent", "where"];
  return !checkProps.some((prop) => effect.filter.hasOwnProperty(prop));
}
function createEffect(fl, FeatureEffect, props) {
  const { backgroundTheme } = props;
  let brightness = backgroundTheme === "light" ? 100 : 65;
  fl.featureEffect = new FeatureEffect({
    filter: {},
    excludedEffect: `grayscale(100%) opacity(30%) brightness(${brightness}%)`,
    excludedLabelsVisible: true
  });
}
function sameCoord(val1, val2) {
  return val1 === val2 || Math.round(val1 * 1000000) / 1000000 === Math.round(val2 * 1000000) / 1000000;
}
function sameSR(sp1, sp2) {
  // works for __esri.SpatialReference and JSON objects
  var mercator = [102113, 102100, 3857];
  if (sp1 &&
    sp2 &&
    (0,_commonFunctions_5262b094_js__WEBPACK_IMPORTED_MODULE_3__.i)(sp1.wkid) &&
    (0,_commonFunctions_5262b094_js__WEBPACK_IMPORTED_MODULE_3__.i)(sp2.wkid) &&
    mercator.indexOf(sp1.wkid) > -1 &&
    mercator.indexOf(sp2.wkid) > -1) {
    return true;
  }
  else if (sp1 &&
    sp2 &&
    (((0,_commonFunctions_5262b094_js__WEBPACK_IMPORTED_MODULE_3__.i)(sp1.wkid) && (0,_commonFunctions_5262b094_js__WEBPACK_IMPORTED_MODULE_3__.i)(sp2.wkid) && sp1.wkid == sp2.wkid) ||
      ((0,_commonFunctions_5262b094_js__WEBPACK_IMPORTED_MODULE_3__.i)(sp1.latestWkid) && (0,_commonFunctions_5262b094_js__WEBPACK_IMPORTED_MODULE_3__.i)(sp2.wkid) && sp1.latestWkid == sp2.wkid) ||
      ((0,_commonFunctions_5262b094_js__WEBPACK_IMPORTED_MODULE_3__.i)(sp1.wkid) && (0,_commonFunctions_5262b094_js__WEBPACK_IMPORTED_MODULE_3__.i)(sp2.latestWkid) && sp1.wkid == sp2.latestWkid) ||
      ((0,_commonFunctions_5262b094_js__WEBPACK_IMPORTED_MODULE_3__.i)(sp1.latestWkid) && (0,_commonFunctions_5262b094_js__WEBPACK_IMPORTED_MODULE_3__.i)(sp2.latestWkid) && sp1.latestWkid == sp2.latestWkid))) {
    return true;
  }
  else if (sp1 && sp2 && (0,_commonFunctions_5262b094_js__WEBPACK_IMPORTED_MODULE_3__.i)(sp1.wkt) && (0,_commonFunctions_5262b094_js__WEBPACK_IMPORTED_MODULE_3__.i)(sp2.wkt) && sp1.wkt === sp2.wkt) {
    return true;
  }
  return false;
}
/**
 *
 * @param props
 * @returns
 */
function getRequiredFieldNames(props, layer) {
  const requiredFieldTypes = [
    "oid",
    "esriFieldTypeOID",
    "global-id",
    "esriFieldTypeGlobalID",
    "geometry",
    "esriFieldTypeGeometry"
  ];
  let totalFields;
  if (layer) {
    totalFields = layer.fields;
  }
  else {
    const { definitionLayerId } = props;
    const adminLayerInfo = getAdminLayerInfo(definitionLayerId, props);
    totalFields = (adminLayerInfo === null || adminLayerInfo === void 0 ? void 0 : adminLayerInfo.fields) || getFL(definitionLayerId, props).fields;
  }
  return totalFields
    .filter((field) => requiredFieldTypes.indexOf(field.type) > -1 || (!field.nullable && !(0,_commonFunctions_5262b094_js__WEBPACK_IMPORTED_MODULE_3__.i)(field.defaultValue)))
    .map((field) => field.name);
}

/**
 * Initialize settings of current view
 */
async function initDefinitions(props) {
  var _a, _b, _c;
  const { viewItem, adminServiceInfo, layer } = props;
  const { modules } = props;
  if (!viewItem) {
    // use parent's definitionExpression as default filter
    if (layer.type === "group") {
      (_a = layer.layers) === null || _a === void 0 ? void 0 : _a.forEach((lyr) => {
        if (lyr.definitionExpression) {
          addViewLayerProps(lyr.layerId, { filter: lyr.definitionExpression }, props);
          applyLayerFilter(lyr.definitionExpression, lyr.layerId, props);
          lyr.definitionExpression = null;
        }
      });
      (_b = layer.tables) === null || _b === void 0 ? void 0 : _b.forEach((table) => {
        if (table.definitionExpression) {
          addViewLayerProps(table.layerId, { filter: table.definitionExpression }, props);
          applyLayerFilter(table.definitionExpression, table.layerId, props);
          table.definitionExpression = null;
        }
      });
    }
    else {
      if (layer.definitionExpression) {
        addViewLayerProps(layer.layerId, { filter: layer.definitionExpression }, props);
        applyLayerFilter(layer.definitionExpression, layer.layerId, props);
        layer.definitionExpression = null;
      }
    }
  }
  else {
    if (!adminServiceInfo) {
      // probably not a view yet
      return;
    }
    props.layerIds = [];
    getLayersAndTables(adminServiceInfo).forEach(async (layerInfo) => {
      var _a, _b, _c, _d;
      props.layerIds.push(layerInfo.id);
      const fields = [];
      layerInfo.fields.forEach((field) => {
        if (field.visible !== false) {
          fields.push(field.name);
        }
      });
      if (fields.length !== layerInfo.fields.length) {
        addViewLayerProps(layerInfo.id, { fields }, props);
      }
      const whereClause = layerInfo.viewDefinitionQuery;
      if (whereClause) {
        addViewLayerProps(layerInfo.id, { filter: whereClause }, props);
        applyLayerFilter(whereClause, layerInfo.id, props);
      }
      const aoiValue = (_d = (_c = (_b = (_a = layerInfo.adminLayerInfo) === null || _a === void 0 ? void 0 : _a.viewLayerDefinition) === null || _b === void 0 ? void 0 : _b.table) === null || _c === void 0 ? void 0 : _c.filter) === null || _d === void 0 ? void 0 : _d.value;
      if (aoiValue) {
        // don't need to check SR of saved AOI, any SR work
        addViewLayerProps(layerInfo.id, {
          aoi: JSON.parse(JSON.stringify(aoiValue.geometry))
        }, props);
        const geometry = aoiValue.geometry.rings
          ? modules.Polygon.fromJSON(aoiValue.geometry)
          : modules.Extent.fromJSON(aoiValue.geometry);
        applyLayerAOI(geometry, layerInfo.id, props);
      }
    });
    // set layer visibility on map and remove definitionExpression
    if (layer.type === "group") {
      layer.layers.forEach((fLayer) => {
        fLayer.visible = props.layerIds.indexOf(fLayer.layerId) > -1;
        fLayer.definitionExpression = null;
      });
      (_c = layer.tables) === null || _c === void 0 ? void 0 : _c.forEach((table) => {
        table.definitionExpression = null;
      });
    }
    else {
      layer.visible = props.layerIds.indexOf(layer.layerId) > -1;
      layer.definitionExpression = null;
    }
  }
}
/**
 * Returns true if the value is defined
 * @param layerId - layer id
 */
function getViewLayerProps(layerId, props) {
  const { viewProps } = props;
  return viewProps === null || viewProps === void 0 ? void 0 : viewProps.find((viewLayerProps) => layerId === viewLayerProps.layerId);
}
/**
 * check if one ViewLayerProp is empty, then delete it
 */
function sanitizeViewProps(props) {
  const { viewProps } = props;
  if (!viewProps) {
    return;
  }
  props.viewProps = viewProps.filter((viewLayerProps) => viewLayerProps.filter || viewLayerProps.aoi || viewLayerProps.fields);
  if (!props.viewProps.length) {
    props.viewProps = undefined;
  }
}
/**
 * add props for one layer
 */
function addViewLayerProps(layerId, addProps, props) {
  var _a;
  let viewLayerProps = getViewLayerProps(layerId, props);
  if (!viewLayerProps) {
    viewLayerProps = { layerId };
  }
  const newProps = Object.assign(Object.assign({}, viewLayerProps), addProps);
  props.viewProps = (_a = props.viewProps) === null || _a === void 0 ? void 0 : _a.filter((viewLayerProp) => viewLayerProp.layerId !== layerId);
  props.viewProps = props.viewProps || [];
  props.viewProps.push(newProps);
}

/**
 * Returns non-view FL
 * @param layerId - layer id
 */
function getFL(layerId, props) {
  const { layer } = props;
  return layer.type === "group"
    ? getLayersAndTables(layer).find((lyr) => lyr.layerId === layerId)
    : layer;
}
/**
 * apply filter to layer as effect
 * @param where - where clause
 * @param layerId - layer id
 */
async function applyLayerFilter(where, layerId, props) {
  const fl = getFL(layerId, props);
  if (fl.isTable) {
    return new Promise((resolve) => {
      resolve();
    });
  }
  const [FeatureEffect] = await (0,_loadModules_aaf30bd6_js__WEBPACK_IMPORTED_MODULE_2__.l)(["esri/layers/support/FeatureEffect"]);
  if (where) {
    let count = 0;
    // wait until the filter component is done
    const intervalHandler = setInterval(() => {
      var _a;
      if (!((_a = fl.featureEffect) === null || _a === void 0 ? void 0 : _a.filter)) {
        createEffect(fl, FeatureEffect, props);
      }
      fl.featureEffect.filter.where = where;
      count++;
      if (count === 3) {
        clearInterval(intervalHandler);
      }
    }, 200);
  }
  else {
    fl.featureEffect.filter.where = null;
    if (isEffectEmpty(fl.featureEffect)) {
      fl.featureEffect = null;
    }
  }
}
/**
 * apply AOI to layer as effect
 * @param graphic - Graphic with geometry
 * @param layerId - layer id
 */
async function applyLayerAOI(geometry, layerId, props) {
  const fl = getFL(layerId, props);
  const [FeatureEffect, Polygon, Extent] = await (0,_loadModules_aaf30bd6_js__WEBPACK_IMPORTED_MODULE_2__.l)([
    "esri/layers/support/FeatureEffect",
    "esri/geometry/Polygon",
    "esri/geometry/Extent"
  ]);
  if (geometry) {
    let count = 0;
    // wait until the filter component is done
    const intervalHandler = setInterval(() => {
      var _a;
      if (!((_a = fl.featureEffect) === null || _a === void 0 ? void 0 : _a.filter)) {
        createEffect(fl, FeatureEffect, props);
      }
      const geom = geometry.type === "polygon" ? Polygon.fromJSON(geometry.toJSON()) : Extent.fromJSON(geometry.toJSON());
      fl.featureEffect.filter.geometry = geom;
      count++;
      if (count === 3) {
        clearInterval(intervalHandler);
      }
    }, 200);
  }
  else {
    fl.featureEffect.filter.geometry = null;
    if (isEffectEmpty(fl.featureEffect)) {
      fl.featureEffect = null;
    }
  }
}
/**
 * get name of service from URL
 * @param portalItem - __esri.PortalItem
 * @return service name
 */
function getServiceName(portalItem) {
  var _a;
  const { url } = portalItem;
  if (!url) {
    return "";
  }
  const serverTypes = ["/FeatureServer", "/MapServer"];
  const serverType = (_a = serverTypes.filter((type) => url.toLowerCase().indexOf(type.toLowerCase()) > -1)) === null || _a === void 0 ? void 0 : _a[0];
  let title = "";
  if (serverType) {
    title = url.substring(0, url.indexOf(serverType));
    title = title.substring(title.lastIndexOf("/") + 1, title.length);
  }
  return title;
}
/**
 * get name of service from URL
 * @layer group layer or adminServiceInfo
 * @return Collecction of layers and tables
 */
function getLayersAndTables(layer) {
  var _a, _b, _c;
  if (((_a = layer.layers) === null || _a === void 0 ? void 0 : _a.length) && ((_b = layer.tables) === null || _b === void 0 ? void 0 : _b.length)) {
    return layer.layers.concat(layer.tables);
  }
  else if ((_c = layer.layers) === null || _c === void 0 ? void 0 : _c.length) {
    return layer.layers;
  }
  else {
    return layer.tables;
  }
}

async function canSwap(swapItem, props) {
  var _a, _b, _c, _d, _e;
  const { layerItem, layer, adminServiceInfo, modules, strings } = props;
  const { Layer, PortalItem } = modules;
  props.swapItem = props.swapLayer = undefined;
  if (layerItem.id === swapItem.id) {
    return Promise.resolve("");
  }
  const portalItem = PortalItem.fromJSON(swapItem);
  await portalItem.load();
  const swapLayer = await Layer.fromPortalItem({
    portalItem
  });
  if (layer.type !== swapLayer.type) {
    console.log("layer type does not match,", layer.type, "!=", swapLayer.type);
    return Promise.resolve(strings.msg.swapErrors.layerType);
  }
  if (layer.type === "group") {
    // group layer has no layers or tables at this point
    // loadAll() loads layers, tables (at v4.23) and capabilities
    await swapLayer.loadAll();
  }
  else {
    // "feature"
    await swapLayer.load();
  }
  // if view has editor tracking swap has to have it too (check service)
  // sync
  if (layer.type === "group") {
    // just need to check one sublayer/table
    const hasSync = adminServiceInfo.layers[0].capabilities.indexOf("Sync") > -1;
    const firstSwapLyr = (((_a = swapLayer.layers) === null || _a === void 0 ? void 0 : _a.length) ? swapLayer.layers : swapLayer.tables).getItemAt(0);
    const swapHasSync = firstSwapLyr.sourceJSON.capabilities.indexOf("Sync") > -1;
    if (hasSync !== swapHasSync) {
      console.log("new source layer Sync not matching");
      return Promise.resolve(strings.msg.swapErrors.sync);
    }
  }
  else {
    // "feature"
    const hasSync = adminServiceInfo.capabilities.indexOf("Sync") > -1;
    const swapHasSync = swapLayer.sourceJSON.capabilities.indexOf("Sync") > -1;
    if (hasSync !== swapHasSync) {
      console.log("new source layer Sync not matching");
      return Promise.resolve(strings.msg.swapErrors.sync);
    }
  }
  // same sublayers
  if (layer.type === "group") {
    // group layer has no layers or tables at this point
    // loadAll() loads layers and tables (at v4.23)
    if (((_b = layer.layers) === null || _b === void 0 ? void 0 : _b.length) !== ((_c = swapLayer.layers) === null || _c === void 0 ? void 0 : _c.length) || ((_d = layer.tables) === null || _d === void 0 ? void 0 : _d.length) !== ((_e = swapLayer.tables) === null || _e === void 0 ? void 0 : _e.length)) {
      console.log("layer sublayers count does not match");
      return Promise.resolve(strings.msg.swapErrors.layerCount);
    }
  }
  // Change in sublayers or fields
  if (layer.type === "group") {
    const layersAndTables = getLayersAndTables(layer);
    const swapLayersAndTables = getLayersAndTables(swapLayer);
    for (let i = 0; i < layersAndTables.length; i++) {
      const subLayer = layersAndTables.getItemAt(i);
      const swapSubLayer = swapLayersAndTables.getItemAt(i);
      //console.log("sublayer", i, subLayer, "==", swapSubLayer);
      let check = checkSubLayers(subLayer, swapSubLayer, props);
      if (check) {
        return Promise.resolve(check);
      }
      check = checkFields(subLayer, swapSubLayer, props);
      if (check) {
        return Promise.resolve(check);
      }
    }
  }
  else {
    // "feature"
    let check = checkSubLayers(layer, swapLayer, props);
    if (check) {
      return Promise.resolve(check);
    }
    check = checkFields(layer, swapLayer, props);
    if (check) {
      return Promise.resolve(check);
    }
  }
  props.swapItem = swapItem;
  props.swapLayer = swapLayer;
  return Promise.resolve(null);
}
async function swapSource(props) {
  var _a, _b;
  let { layer, layerIds, modules } = props;
  const { PortalItem } = modules;
  const { view, swapItem, swapLayer } = props;
  const [esriRequest] = await (0,_loadModules_aaf30bd6_js__WEBPACK_IMPORTED_MODULE_2__.l)(["esri/request"]);
  try {
    await emptyView(props, esriRequest);
    const portalItem = PortalItem.fromJSON(swapItem);
    await portalItem.load();
    //const oldLayerItem = props.layerItem;
    //const oldLayer = layer;
    props.layerItem = portalItem;
    props.layer = swapLayer;
    props.swapItem = props.swapLayer = undefined;
    // we want to behave as if we're creating a new view
    // current settings are based off the source item
    const savedViewItem = props.viewItem;
    props.viewItem = undefined;
    props.adminServiceInfo = undefined;
    await getAdminServiceInfo$1(props);
    await initialAddToDefinition(props, { serviceurl: savedViewItem.url }, esriRequest);
    props.viewItem = savedViewItem;
    // now get view info
    props.adminServiceInfo = undefined;
    await getAdminServiceInfo$1(props);
    /* console.log(
      "view adminServiceInfo layers",
      props.adminServiceInfo?.layers?.map((lyr: any) => {
        return {
          id: lyr.id,
          name: lyr.name,
          adminLayerInfo_filter: lyr.adminLayerInfo?.viewLayerDefinition?.table?.filter?.value,
          viewDefinitionQuery: lyr.viewDefinitionQuery,
          fields: lyr.fields.map((field: any) => `${field.name} (${field.visible})`)
        };
      })
    ); */
    // update map
    view.map.remove(layer);
    layer = props.layer;
    if (layer.type === "group") {
      if ((_a = layer.layers) === null || _a === void 0 ? void 0 : _a.length) {
        // has at least one spatial layer
        if (layerIds) {
          // only make included sublayers visible
          layer.layers.forEach((subLayer) => {
            subLayer.visible = layerIds.indexOf(subLayer.layerId) > -1;
          });
        }
        view.map.add(layer);
      }
      // default popups
      (_b = layer.layers) === null || _b === void 0 ? void 0 : _b.forEach((lyr) => {
        if (!lyr.popupTemplate && lyr.popupEnabled) {
          lyr.popupTemplate = lyr.createPopupTemplate();
        }
      });
    }
    else {
      if (!layer.isTable) {
        view.map.add(layer);
      }
      // default popup
      layer.popupTemplate = layer.createPopupTemplate();
    }
    // apply correct filter and AOI on map
    getLayersAndTables(props.adminServiceInfo).forEach(async (layerInfo) => {
      var _a, _b, _c, _d;
      const whereClause = layerInfo.viewDefinitionQuery;
      if (whereClause) {
        applyLayerFilter(whereClause, layerInfo.id, props);
      }
      const aoiValue = (_d = (_c = (_b = (_a = layerInfo.adminLayerInfo) === null || _a === void 0 ? void 0 : _a.viewLayerDefinition) === null || _b === void 0 ? void 0 : _b.table) === null || _c === void 0 ? void 0 : _c.filter) === null || _d === void 0 ? void 0 : _d.value;
      if (aoiValue) {
        const geometry = aoiValue.geometry.rings
          ? modules.Polygon.fromJSON(aoiValue.geometry)
          : modules.Extent.fromJSON(aoiValue.geometry);
        applyLayerAOI(geometry, layerInfo.id, props);
      }
    });
  }
  catch (e) {
    return new Promise((_, reject) => {
      reject(new Error("swap source failed"));
    });
  }
}
function checkSubLayers(layer, swapLayer, props) {
  const { strings } = props;
  if (layer.geometryType !== swapLayer.geometryType) {
    console.log("layer geometry type does not match");
    return strings.msg.swapErrors.geometryType;
  }
  if (JSON.stringify(layer.spatialReference.toJSON()) !== JSON.stringify(swapLayer.spatialReference.toJSON())) {
    console.log("layer spatial reference does not match");
    return strings.msg.swapErrors.spatialReference;
  }
  return null;
}
function checkFields(layer, swapLayer, props) {
  // all visible fields in current view must be contained in new source
  const { strings } = props;
  const requiredFieldNames = getRequiredFieldNames(props, layer);
  const viewLayerProps = getViewLayerProps(layer.layerId, props);
  let visFields;
  if (viewLayerProps === null || viewLayerProps === void 0 ? void 0 : viewLayerProps.fields) {
    const allFields = viewLayerProps.fields.concat(requiredFieldNames);
    visFields = layer.fields.filter((field) => allFields.indexOf(field.name) > -1);
  }
  else {
    visFields = layer.fields;
  }
  //console.log("checkFields - visFields", visFields.map((f) =>f.name));
  //console.log("swapLayer - fields", swapLayer.fields.map((f) => f.name));
  for (let i = 0; i < visFields.length; i++) {
    const field = visFields[i];
    const swapField = swapLayer.fields.find((swapField) => field.name === swapField.name);
    if (!swapField) {
      //if (["global-id", "oid"].indexOf(field.type) === -1) {
      console.log("layer", layer.layerId, layer.title, ": field", field.name, "missing in new source layer");
      return strings.msg.swapErrors.missingField;
      //} else {
      //  console.log("field", field.name, "missing in new source layer, ignoring");
      //}
    }
    else if (field.type !== swapField.type) {
      console.log("layer", layer.layerId, layer.title, ": field type of", field.name, "different in layers");
      return strings.msg.swapErrors.fieldType;
    }
  }
  return null;
}

/**
 * get a suggested title for the view
 * @param props - LayerViewProps
 */
async function getSuggestedTitle(props) {
  var _a, _b;
  const { layerItem, layer, strings } = props;
  const [esriRequest] = await (0,_loadModules_aaf30bd6_js__WEBPACK_IMPORTED_MODULE_2__.l)(["esri/request"]);
  const relatedUrl = `${layerItem.itemUrl}/relatedItems`;
  const relatedContent = {
    relationshipType: "Service2Service",
    direction: "forward"
  };
  const result = await esriRequest(relatedUrl, {
    query: Object.assign(Object.assign({}, relatedContent), { f: "json", token: layer.portalItem.portal.credential.token }),
    method: "post",
    responseType: "json"
  });
  // check with spaces and underscores
  const viewItems = ((_b = (_a = result === null || result === void 0 ? void 0 : result.data) === null || _a === void 0 ? void 0 : _a.relatedItems) === null || _b === void 0 ? void 0 : _b.filter((item) => item.type === "Feature Service" &&
    (item.title.indexOf(layerItem.title) > -1 ||
      item.title.indexOf(layerItem.title.replace(/ /g, "_")) > -1 ||
      item.title.replace(/ /g, "_").indexOf(layerItem.title) > -1))) || [];
  return `${layerItem.title}${viewItems.length ? ` ${viewItems.length + 1}` : ``} ${strings.createView.view}`;
}
/**
 * Make admin service info request for view layer
 * @param props - LayerViewProps
 */
async function getAdminServiceInfo$1(props, noCache) {
  const { layer, viewItem, adminServiceInfo } = props;
  if (adminServiceInfo) {
    return;
  }
  const serviceUrl = (viewItem === null || viewItem === void 0 ? void 0 : viewItem.url) || layer.portalItem.url;
  let adminUrl = serviceUrl.replace("/rest/services", "/rest/admin/services");
  if (noCache) {
    adminUrl += `${adminUrl.indexOf("?") > -1 ? "&" : "?"}_ts=${new Date().getTime()}`;
  }
  try {
    const [IdentityManager, esriRequest] = await (0,_loadModules_aaf30bd6_js__WEBPACK_IMPORTED_MODULE_2__.l)(["esri/identity/IdentityManager", "esri/request"]);
    await IdentityManager.getCredential(adminUrl);
    const response = await esriRequest(adminUrl, {
      query: { f: "json" }
    });
    props.adminServiceInfo = response.data;
  }
  catch (e) {
    return new Promise((_, reject) => {
      reject(new Error("could not get admin info"));
    });
  }
}
/**
 * Creates layer view
 * @param layerId - layer id
 * @param props - LayerViewProps
 */
function getAdminLayerInfo(layerId, props) {
  var _a, _b;
  const { adminServiceInfo } = props;
  const layer = (_a = adminServiceInfo === null || adminServiceInfo === void 0 ? void 0 : adminServiceInfo.layers) === null || _a === void 0 ? void 0 : _a.find((layer) => layer.id === layerId);
  if (!layer) {
    return (_b = adminServiceInfo === null || adminServiceInfo === void 0 ? void 0 : adminServiceInfo.tables) === null || _b === void 0 ? void 0 : _b.find((table) => table.id === layerId);
  }
  return layer;
}
/**
 * Returns true if the user made recent changes
 * @param props
 * @returns boolean
 */
function hasChanges(props) {
  const { layer, layerIds, adminServiceInfo } = props;
  if (layer.type === "group") {
    const layersAndTables = adminServiceInfo && getLayersAndTables(adminServiceInfo);
    const containsAllLayers = adminServiceInfo &&
      layersAndTables.length === layerIds.length &&
      layersAndTables.every((lyr) => layerIds.indexOf(lyr.id) > -1);
    return (!containsAllLayers ||
      getLayersAndTables(layer)
        .filter((fLayer) => layerIds.indexOf(fLayer.layerId) > -1)
        .some((fLayer) => hasLayerChanges(fLayer.layerId, props)));
  }
  else {
    return hasLayerChanges(layer.layerId, props);
  }
}
/**
 * Returns true if the user made recent changes to the feature layer
 * @param layerId
 * @param props
 * @returns
 */
function hasLayerChanges(layerId, props) {
  var _a, _b, _c, _d;
  const { viewItem } = props;
  const fLayer = getFL(layerId, props);
  const viewLayerProps = getViewLayerProps(layerId, props);
  const adminLayerInfo = getAdminLayerInfo(layerId, props);
  // ignore field.visible prop on parent layers
  const viewFields = viewItem && (adminLayerInfo === null || adminLayerInfo === void 0 ? void 0 : adminLayerInfo.fields)
    ? adminLayerInfo.fields.filter((field) => field.visible)
    : (adminLayerInfo === null || adminLayerInfo === void 0 ? void 0 : adminLayerInfo.fields) || fLayer.fields;
  if (viewLayerProps) {
    if (viewLayerProps.filter !== (adminLayerInfo === null || adminLayerInfo === void 0 ? void 0 : adminLayerInfo.viewDefinitionQuery) ||
      !!(viewLayerProps.fields && viewLayerProps.fields.length !== viewFields.length) ||
      !!(!viewLayerProps.fields && viewFields.length !== fLayer.fields.length) ||
      (!fLayer.isTable && !isSameAOI(viewLayerProps, adminLayerInfo))) {
      /* console.log(
        "hasLayerChanges=true (props) id:",
        layerId,
        "filter:",
        viewLayerProps.filter !== adminLayerInfo?.viewDefinitionQuery,
        //`(${viewLayerProps.filter}|${adminLayerInfo?.viewDefinitionQuery})`,
        "fields-has-props:",
        !!(viewLayerProps.fields && viewLayerProps.fields.length !== viewFields.length),
        "fields-no-props:",
        !!(!viewLayerProps.fields && viewFields.length !== fLayer.fields.length),
        "!sameAOI:",
        !isSameAOI(viewLayerProps, adminLayerInfo)
      ); */
      return true;
    }
  }
  else {
    if ((adminLayerInfo === null || adminLayerInfo === void 0 ? void 0 : adminLayerInfo.viewDefinitionQuery) ||
      viewFields.length < fLayer.fields.length ||
      (!fLayer.isTable && ((_d = (_c = (_b = (_a = adminLayerInfo === null || adminLayerInfo === void 0 ? void 0 : adminLayerInfo.adminLayerInfo) === null || _a === void 0 ? void 0 : _a.viewLayerDefinition) === null || _b === void 0 ? void 0 : _b.table) === null || _c === void 0 ? void 0 : _c.filter) === null || _d === void 0 ? void 0 : _d.value))) {
      return true;
    }
  }
  return false;
}
/**
 * Creates layer view
 * @param props - LayerViewProps
 * @param newItemProps - user input (NewItemProps)
 */
async function createView(props, newItemProps) {
  const [esriRequest] = await (0,_loadModules_aaf30bd6_js__WEBPACK_IMPORTED_MODULE_2__.l)(["esri/request"]);
  try {
    const createServiceResponse = await createService(props, newItemProps, esriRequest);
    //console.log("createServiceResponse", createServiceResponse);
    await initialAddToDefinition(props, createServiceResponse, esriRequest);
    await initialItemUpdate(props, createServiceResponse, newItemProps, esriRequest);
    await moveToFolder(props, createServiceResponse, newItemProps, esriRequest);
    return createServiceResponse.itemId;
  }
  catch (e) {
    return new Promise((_, reject) => {
      if (e.message === "service name already exists") {
        reject(e);
      }
      else {
        reject(new Error("createView failed"));
      }
    });
  }
}
/**
 * Creates layer view
 * @param props - LayerViewProps
 */
async function updateView(props) {
  const { viewItem } = props;
  const [esriRequest] = await (0,_loadModules_aaf30bd6_js__WEBPACK_IMPORTED_MODULE_2__.l)(["esri/request"]);
  try {
    const { addLayerIds, deleteLayerIds } = await updateDefinition(props, viewItem, esriRequest);
    await itemUpdate(props, addLayerIds, deleteLayerIds, esriRequest);
    return new Promise((resolve) => {
      resolve();
    });
  }
  catch (e) {
    return new Promise((_, reject) => {
      reject(new Error("updateView failed"));
    });
  }
}
/**
 * Removes all layers from the view
 * @param props - LayerViewProps
 */
async function emptyView(props, esriRequest) {
  var _a, _b;
  const { layer, viewItem, adminServiceInfo } = props;
  const portalItem = layer.portalItem;
  // delete
  const deleteLayerIds = [];
  (_a = adminServiceInfo === null || adminServiceInfo === void 0 ? void 0 : adminServiceInfo.layers) === null || _a === void 0 ? void 0 : _a.forEach((lyr) => {
    deleteLayerIds.push(lyr.id);
  });
  const deleteTableIds = [];
  (_b = adminServiceInfo === null || adminServiceInfo === void 0 ? void 0 : adminServiceInfo.tables) === null || _b === void 0 ? void 0 : _b.forEach((lyr) => {
    deleteTableIds.push(lyr.id);
  });
  if (deleteLayerIds.length || deleteTableIds.length) {
    const adminUrl = viewItem.url.replace("rest/services", "rest/admin/services");
    const deleteFromDefUrl = `${adminUrl}/deleteFromDefinition`;
    await deleteFromDefinitionRequest(deleteFromDefUrl, {
      layers: deleteLayerIds === null || deleteLayerIds === void 0 ? void 0 : deleteLayerIds.map((id) => {
        return { id };
      }),
      tables: deleteTableIds === null || deleteTableIds === void 0 ? void 0 : deleteTableIds.map((id) => {
        return { id };
      })
    }, portalItem, esriRequest);
  }
  return new Promise((resolve) => {
    resolve();
  });
}
function isSameAOI(viewLayerProps, adminLayerInfo) {
  var _a, _b, _c, _d;
  const adminAOIValue = (_d = (_c = (_b = (_a = adminLayerInfo === null || adminLayerInfo === void 0 ? void 0 : adminLayerInfo.adminLayerInfo) === null || _a === void 0 ? void 0 : _a.viewLayerDefinition) === null || _b === void 0 ? void 0 : _b.table) === null || _c === void 0 ? void 0 : _c.filter) === null || _d === void 0 ? void 0 : _d.value;
  //console.log("isSameAOI admin:", adminAOIValue?.geometry, "prop:", viewLayerProps?.aoi);
  if (!(viewLayerProps === null || viewLayerProps === void 0 ? void 0 : viewLayerProps.aoi) && !adminAOIValue) {
    return true;
  }
  else if (((viewLayerProps === null || viewLayerProps === void 0 ? void 0 : viewLayerProps.aoi) && !adminAOIValue) || (!(viewLayerProps === null || viewLayerProps === void 0 ? void 0 : viewLayerProps.aoi) && adminAOIValue)) {
    return false;
  }
  if ((viewLayerProps.aoi.rings && adminAOIValue.geometryType !== "esriGeometryPolygon") ||
    (viewLayerProps.aoi.xmin && adminAOIValue.geometryType !== "esriGeometryEnvelope")) {
    return false;
  }
  if (viewLayerProps.aoi.xmin) {
    const propsExt = viewLayerProps.aoi;
    const adminExt = adminAOIValue.geometry;
    // compare coords with a margin; service rounds passed in coords
    if (sameCoord(propsExt.xmin, adminExt.xmin) &&
      sameCoord(propsExt.xmax, adminExt.xmax) &&
      sameCoord(propsExt.ymin, adminExt.ymin) &&
      sameCoord(propsExt.ymax, adminExt.ymax)) {
      return true;
    }
    else {
      return false;
    }
  }
  else if (viewLayerProps.aoi.rings) {
    if (viewLayerProps.aoi.rings[0].length !== adminAOIValue.geometry.rings[0].length) {
      return false;
    }
    else {
      const isSame = viewLayerProps.aoi.rings[0].every((pt1) => {
        return adminAOIValue.geometry.rings[0].some((pt2) => {
          // compare coords with a margin; service rounds passed in coords
          return sameCoord(pt1[0], pt2[0]) && sameCoord(pt1[1], pt2[1]);
        });
      });
      return isSame;
    }
  }
}
async function createService(props, newItemProps, esriRequest) {
  var _a, _b, _c;
  const { layer, layerIds } = props;
  const portalItem = layer.portalItem;
  const portal = portalItem.portal;
  let fl = getFL(layerIds[0], props);
  const createServiceUrl = `${portal.restUrl}/content/users/${portalItem.owner}/createService`;
  const createParams = {
    name: newItemProps.title.replace(/ /g, "_"),
    isView: true,
    sourceSchemaChangesAllowed: true,
    isUpdatableView: true,
    spatialReference: (_a = fl.sourceJSON.extent) === null || _a === void 0 ? void 0 : _a.spatialReference,
    initialExtent: fl.sourceJSON.extent,
    capabilities: "Query",
    preserveLayerIds: true
  };
  if (portal.isPortal) {
    const dataSourceType = getDataSourceType$1(props);
    if (dataSourceType) {
      createParams.options = { dataSourceType };
    }
  }
  let createServiceContent = {
    createParameters: JSON.stringify(createParams),
    outputType: "featureService",
    tags: ((_b = newItemProps.tags) === null || _b === void 0 ? void 0 : _b.length) ? newItemProps.tags.toString() : undefined,
    snippet: newItemProps.summary,
    categories: (_c = newItemProps.categories) === null || _c === void 0 ? void 0 : _c.join(","),
    isView: true
  };
  try {
    const response = await esriRequest(createServiceUrl, {
      query: Object.assign(Object.assign({}, createServiceContent), { f: "json", token: portal.credential.token }),
      method: "post",
      responseType: "json"
    });
    //console.log("newServiceResponse", response);
    return response.data;
  }
  catch (e) {
    return new Promise((_, reject) => {
      if (e.message.indexOf(" already exists ") > -1) {
        reject(new Error("service name already exists"));
      }
      else {
        reject(new Error("create service failed"));
      }
    });
  }
}
function getDataSourceType$1(props) {
  var _a, _b, _c, _d;
  const { adminServiceInfo } = props;
  const dataSource = ((_b = (_a = adminServiceInfo === null || adminServiceInfo === void 0 ? void 0 : adminServiceInfo.adminServiceInfo) === null || _a === void 0 ? void 0 : _a.database) === null || _b === void 0 ? void 0 : _b.datasource) || {};
  const dataSourceType = ((_c = dataSource === null || dataSource === void 0 ? void 0 : dataSource.name) === null || _c === void 0 ? void 0 : _c.indexOf("/nosqlDatabases")) > -1
    ? "spatiotemporal"
    : ((_d = dataSource === null || dataSource === void 0 ? void 0 : dataSource.name) === null || _d === void 0 ? void 0 : _d.indexOf("/enterpriseDatabases")) > -1
      ? "relational"
      : null;
  return dataSourceType;
}
async function initialAddToDefinition(props, createServiceResponse, esriRequest) {
  /* TODO??
  updatePopupAfterFieldDefinitionChange: function(mapLayer) {

    if (!mapLayer.popupInfo || !mapLayer.popupInfo.fieldInfos) {
      return;
    }

    var fieldInfos = mapLayer.popupInfo.fieldInfos;
    var newFieldInfos = [];
    var defaultPopupInfo = arcgisonline.map.popup.getDefaultPopupInfo(mapLayer.serviceInfo, mapLayer.layer.isEditable(), mapLayer.layer);

    // remove fields that are not available anymore and add new fields
    dojo.forEach(defaultPopupInfo.fieldInfos, function(defInfo) {
      var curFInfo;
      dojo.forEach(fieldInfos, function(fInfo) {
        if (fInfo.fieldName === defInfo.fieldName) {
          curFInfo = fInfo;
        }
      });
      if (!curFInfo) {
        // add new fields to the popup
        newFieldInfos.push(defInfo);
      } else {
        // keep the one we have
        newFieldInfos.push(curFInfo);
      }
    });
    // keep special fields
    var relatedFieldPrefix = "relationships/";
    var expressionPrefix = "expression/";
    var rasterPrefix = "Raster.";
    dojo.forEach(fieldInfos, function(fInfo) {
      if (fInfo.fieldName.startsWith(relatedFieldPrefix) ||
        fInfo.fieldName.startsWith(expressionPrefix) ||
        fInfo.fieldName.startsWith(rasterPrefix)) {
        newFieldInfos.push(fInfo);
      }
    });
    if (dojo.json.stringify(mapLayer.popupInfo.fieldInfos) !== dojo.json.stringify(newFieldInfos)) {
      mapLayer.popupInfo.fieldInfos = newFieldInfos;
      arcgisonline.map.mapUtil.setInfoTemplate(mapLayer.layer, mapLayer.popupInfo);
      mapLayer.popupChanged = true;

      if (mapLayer.origItemLayers) {
        // save new popup on layer item

        var getItemLayerInfosHandler = function(){
          // mapLayer.origItemLayers contains what's saved on the item currently

          var itemData = arcgisonline.map.itemData.itemDataContents[mapLayer.itemId] || {};

          var id = parseInt(mapLayer.layer.url.substring(mapLayer.layer.url.lastIndexOf("/") + 1));
          var layerInfo = null;
          for (var i = 0; i < mapLayer.origItemLayers.length; i++) {
            if (mapLayer.origItemLayers[i].id === id) {
              layerInfo = mapLayer.origItemLayers[i];
              break;
            }
          }

          if (!layerInfo) {
            //should not happen
            return;
          }

          // only update popupInfo
          layerInfo.popupInfo = mapLayer.popupInfo;

          var json = {
            layers: mapLayer.origItemLayers
          };

          delete itemData.layers;
          json = dojo.mixin(itemData, json);

          var request = {
            text: dojo.json.stringify(json)
          };

          var user = arcgisonline.sharing.util.getUser();
          var url = esriGeowConfig.restBaseUrl + 'content/users/' + mapLayer.itemCard.owner; // user might be admin and item owner is someone else
          url += (mapLayer.itemCard.ownerFolder) ? ('/' + mapLayer.itemCard.ownerFolder) : '';
          url += '/items/' + mapLayer.itemCard.id + '/update';
          arcgisonline.sharing.util.postJson(request, url, dojo.hitch(this,function() {
            delete mapLayer.popupChanged;
          }));
        };

        // get the latest layerInfos from the item in case they got changed by another layer in the map
        arcgisonline.map.itemData.getItemLayerInfos(mapLayer, dojo.hitch(this, getItemLayerInfosHandler), dojo.hitch(this, getItemLayerInfosHandler));
      }
    }
  },
  */
  var _a, _b;
  const { layer, layerIds } = props;
  let layers, tables;
  if (layer.type === "group") {
    layers = (_a = layer.layers) === null || _a === void 0 ? void 0 : _a.filter((lyr) => layerIds.indexOf(lyr.layerId) > -1).map((lyr) => getDefLayerJSON(lyr, props)).toArray().reverse();
    tables = (_b = layer.tables) === null || _b === void 0 ? void 0 : _b.filter((lyr) => layerIds.indexOf(lyr.layerId) > -1).map((lyr) => getDefLayerJSON(lyr, props)).toArray().reverse();
  }
  else {
    if (layer.isTable) {
      tables = [getDefLayerJSON(layer, props)];
    }
    else {
      layers = [getDefLayerJSON(layer, props)];
    }
  }
  try {
    // the response from a createService call returns 'serviceurl'
    const adminUrl = createServiceResponse.serviceurl.replace("rest/services", "rest/admin/services");
    await addToDefinitionRequest$1(`${adminUrl}/addToDefinition`, {
      layers: layers,
      tables: tables
    }, esriRequest, props);
    await updateDefinitions(props, createServiceResponse, esriRequest);
    return new Promise((resolve) => {
      resolve();
    });
  }
  catch (e) {
    return new Promise((_, reject) => {
      reject(new Error("initialAddToDefinition failed"));
    });
  }
}
async function updateDefinitions(props, createServiceResponse, esriRequest) {
  const { layer, layerIds } = props;
  const { portalItem } = layer;
  const { portal } = portalItem;
  const adminUrl = createServiceResponse.serviceurl.replace("rest/services", "rest/admin/services");
  try {
    // now update definitions like filter, fields, and AOI
    // changing fields and AOI not supported with addToDefinition
    if (layer.type === "group") {
      const callInfos = [];
      const lyrs = getLayersAndTables(layer).filter((fLayer) => layerIds.indexOf(fLayer.layerId) > -1);
      // use for loop so await works
      for (let i = 0; i < lyrs.length; i++) {
        const fLayer = lyrs.getItemAt(i);
        if (hasLayerChanges(fLayer.layerId, props)) {
          const json = await getUpdateLayerJSON(fLayer, props);
          const updateDefUrl = `${adminUrl}/${fLayer.layerId}/updateDefinition`;
          callInfos.push({ updateDefUrl, json });
        }
      }
      if (callInfos.length) {
        if (portal.isPortal) {
          // can't handle simultaneous requests
          for (const callInfo of callInfos) {
            await updateDefinitionRequest(callInfo.updateDefUrl, callInfo.json, esriRequest, props);
          }
        }
        else {
          const calls = [];
          callInfos.forEach((callInfo) => {
            calls.push(updateDefinitionRequest(callInfo.updateDefUrl, callInfo.json, esriRequest, props));
          });
          await Promise.all(calls);
        }
      }
    }
    else {
      // not a group layer
      if (hasLayerChanges(layer.layerId, props)) {
        const json = await getUpdateLayerJSON(layer, props);
        const updateDefUrl = `${adminUrl}/${layer.layerId}/updateDefinition`;
        await updateDefinitionRequest(updateDefUrl, json, esriRequest, props);
      }
    }
    return new Promise((resolve) => {
      resolve();
    });
  }
  catch (e) {
    return new Promise((_, reject) => {
      reject(new Error("updateDefinitions failed"));
    });
  }
}
async function updateDefinition(props, viewItem, esriRequest) {
  /*
  TODO??
  if (arcgisonline.sharing.util.isPortal()) {
    // can't send all of those requests out at the same time [#19301]
  */
  var _a, _b, _c, _d;
  const { layer, layerIds, adminServiceInfo } = props;
  const portalItem = layer.portalItem;
  const { portal } = portalItem;
  const deleteLayerIds = [];
  const addLayerIds = [];
  try {
    // the response from an item card call returns 'url'
    const adminUrl = viewItem.url.replace("rest/services", "rest/admin/services");
    if (layer.type === "group") {
      // delete
      (_a = adminServiceInfo === null || adminServiceInfo === void 0 ? void 0 : adminServiceInfo.layers) === null || _a === void 0 ? void 0 : _a.forEach((lyr) => {
        if (layerIds.indexOf(lyr.id) === -1) {
          deleteLayerIds.push(lyr.id);
        }
      });
      const deleteTableIds = [];
      (_b = adminServiceInfo === null || adminServiceInfo === void 0 ? void 0 : adminServiceInfo.tables) === null || _b === void 0 ? void 0 : _b.forEach((lyr) => {
        if (layerIds.indexOf(lyr.id) === -1) {
          deleteTableIds.push(lyr.id);
        }
      });
      if (deleteLayerIds.length || deleteTableIds.length) {
        const deleteFromDefUrl = `${adminUrl}/deleteFromDefinition`;
        await deleteFromDefinitionRequest(deleteFromDefUrl, {
          layers: deleteLayerIds === null || deleteLayerIds === void 0 ? void 0 : deleteLayerIds.map((id) => {
            return { id };
          }),
          tables: deleteTableIds === null || deleteTableIds === void 0 ? void 0 : deleteTableIds.map((id) => {
            return { id };
          })
        }, portalItem, esriRequest);
        // do we need to remove relationships from existing view layers
        // pointing to any removed layers?
        let callInfos = [];
        getLayersAndTables(layer)
          .filter((fLayer) => layerIds.indexOf(fLayer.layerId) > -1)
          .forEach(async (fLayer) => {
          var _a, _b;
          if ((_a = fLayer.relationships) === null || _a === void 0 ? void 0 : _a.length) {
            // the original layer has relationships
            const viewLayerInfo = getLayersAndTables(adminServiceInfo).find((layerInfo) => layerInfo.id === fLayer.layerId);
            if ((_b = viewLayerInfo === null || viewLayerInfo === void 0 ? void 0 : viewLayerInfo.relationships) === null || _b === void 0 ? void 0 : _b.length) {
              // remove relationships pointing to newly removed layers
              const relationships = viewLayerInfo.relationships.filter((relationship) => deleteLayerIds.indexOf(relationship.relatedTableId) > -1 ||
                deleteTableIds.indexOf(relationship.relatedTableId) > -1);
              if (relationships.length) {
                // at least one relationship needs to be removed
                const json = {};
                json.relationships = relationships;
                const delFromDefUrl = `${adminUrl}/${fLayer.layerId}/deleteFromDefinition`;
                callInfos.push({ delFromDefUrl, json });
              }
            } // else view layer not yet part of view or already has all relationships
          }
        });
        if (callInfos.length) {
          if (portal.isPortal) {
            // can't handle simultaneous requests
            for (const callInfo of callInfos) {
              await deleteFromDefinitionRequest(callInfo.delFromDefUrl, callInfo.json, portalItem, esriRequest);
            }
          }
          else {
            const calls = [];
            callInfos.forEach((callInfo) => {
              calls.push(deleteFromDefinitionRequest(callInfo.delFromDefUrl, callInfo.json, portalItem, esriRequest));
            });
            await Promise.all(calls);
          }
        }
      }
      // add
      layerIds.forEach((id) => {
        if (!getLayersAndTables(adminServiceInfo).some((lyr) => lyr.id === id)) {
          addLayerIds.push(id);
        }
      });
      if (addLayerIds.length) {
        const layers = (_c = layer.layers) === null || _c === void 0 ? void 0 : _c.filter((lyr) => addLayerIds.indexOf(lyr.layerId) > -1).map((lyr) => getDefLayerJSON(lyr, props)).toArray().reverse();
        const tables = (_d = layer.tables) === null || _d === void 0 ? void 0 : _d.filter((lyr) => addLayerIds.indexOf(lyr.layerId) > -1).map((lyr) => getDefLayerJSON(lyr, props)).toArray().reverse();
        await addToDefinitionRequest$1(`${adminUrl}/addToDefinition`, {
          layers: layers,
          tables: tables
        }, esriRequest, props);
        // do we need to add relationships for any newly added layers?
        const callInfos = [];
        getLayersAndTables(layer)
          .filter((fLayer) => layerIds.indexOf(fLayer.layerId) > -1)
          .forEach(async (fLayer) => {
          var _a, _b;
          if ((_a = fLayer.relationships) === null || _a === void 0 ? void 0 : _a.length) {
            // the original layer has relationships
            const viewLayerInfo = getLayersAndTables(adminServiceInfo).find((layerInfo) => layerInfo.id === fLayer.layerId);
            if (viewLayerInfo) {
              // this view layer was not just added to the view
              if (((_b = fLayer.relationships) === null || _b === void 0 ? void 0 : _b.length) !== viewLayerInfo.relationships.length) {
                const json = {};
                // only add relationships pointing to newly added layers
                const relationships = fLayer.relationships.filter((relationship) => addLayerIds.indexOf(relationship.relatedTableId) > -1);
                json.relationships = relationships;
                const addToDefUrl = `${adminUrl}/${fLayer.layerId}/addToDefinition`;
                callInfos.push({ addToDefUrl, json });
              } // else view layer already has all relationships
            } // else we sent all relationships when adding the layer to the view earlier
          }
        });
        if (callInfos.length) {
          if (portal.isPortal) {
            // can't handle simultaneous requests
            for (const callInfo of callInfos) {
              await addToDefinitionRequest$1(callInfo.addToDefUrl, callInfo.json, esriRequest, props);
            }
          }
          else {
            const calls = [];
            callInfos.forEach((callInfo) => {
              calls.push(addToDefinitionRequest$1(callInfo.addToDefUrl, callInfo.json, esriRequest, props));
            });
            await Promise.all(calls);
          }
        }
      }
      // update fields, filter, AOI
      // also update the new layers that were just added
      const callInfos = [];
      const calls = [];
      const makeGetUpdateLayerJSONCall = async (callInfos, fLayer) => {
        const updateDefUrl = `${adminUrl}/${fLayer.layerId}/updateDefinition`;
        const json = await getUpdateLayerJSON(fLayer, props);
        callInfos.push({ updateDefUrl, json });
        return Promise.resolve();
      };
      getLayersAndTables(layer)
        .filter((fLayer) => layerIds.indexOf(fLayer.layerId) > -1)
        .forEach((fLayer) => {
        if (hasLayerChanges(fLayer.layerId, props)) {
          calls.push(makeGetUpdateLayerJSONCall(callInfos, fLayer));
        }
      });
      await Promise.all(calls);
      if (callInfos.length) {
        if (portal.isPortal) {
          for (const callInfo of callInfos) {
            await updateDefinitionRequest(callInfo.updateDefUrl, callInfo.json, esriRequest, props);
          }
        }
        else {
          const calls = [];
          callInfos.forEach((callInfo) => {
            calls.push(updateDefinitionRequest(callInfo.updateDefUrl, callInfo.json, esriRequest, props));
          });
          await Promise.all(calls);
        }
      }
    }
    else {
      // not a group layer
      if (hasLayerChanges(layer.layerId, props)) {
        const json = await getUpdateLayerJSON(layer, props);
        const updateDefUrl = `${adminUrl}/${layer.layerId}/updateDefinition`;
        await updateDefinitionRequest(updateDefUrl, json, esriRequest, props);
      }
    }
    return new Promise((resolve) => {
      resolve({ addLayerIds, deleteLayerIds });
    });
  }
  catch (e) {
    console.error(e);
    return new Promise((_, reject) => {
      reject(new Error("updateDefinition failed"));
    });
  }
}
async function updateDefinitionRequest(updateDefUrl, json, esriRequest, props, retry = false) {
  var _a;
  const { layer, viewItem } = props;
  const updateDefContent = {
    updateDefinition: JSON.stringify(json)
  };
  try {
    const portalItem = layer.portalItem;
    const portal = portalItem.portal;
    const isVelocityView = (viewItem === null || viewItem === void 0 ? void 0 : viewItem.typeKeywords.indexOf("IoTFeatureLayer")) > -1;
    const result = await esriRequest(updateDefUrl, {
      query: Object.assign(Object.assign({}, updateDefContent), { f: "json", async: !portal.isPortal && !isVelocityView, token: portal.credential.token }),
      method: "post",
      responseType: "json"
    });
    if (portal.isPortal || isVelocityView) {
      return new Promise((resolve) => {
        resolve();
      });
    }
    else {
      try {
        await pollForStatus$1((_a = result === null || result === void 0 ? void 0 : result.data) === null || _a === void 0 ? void 0 : _a.statusURL, {
          f: "json",
          token: portal.credential.token
        }, esriRequest);
        return new Promise((resolve) => {
          resolve();
        });
      }
      catch (e) {
        // update request worked; ignore the polling error
        //return new Promise((resolve) => {
        //  resolve();
        //});
        /* real error
        {
          "submissionTime": 1652480104360,
          "lastUpdatedTime": 1652480104360,
          "status": "Failed",
          "error": {
              "code": 500,
              "description": "Editing definition error - USA_West2_view"
          }
        }
        */
        return new Promise((_, reject) => {
          reject(new Error("updateDefinition request failed (poll)"));
        });
      }
    }
  }
  catch (e) {
    if (!retry) {
      // in case it's just a fluke
      return updateDefinitionRequest(updateDefUrl, json, esriRequest, props, true);
    }
    return new Promise((_, reject) => {
      reject(new Error("updateDefinition request failed"));
    });
  }
}
async function addToDefinitionRequest$1(addToDefUrl, json, esriRequest, props, retry = false) {
  var _a;
  const { layer, viewItem } = props;
  const addToDefContent = {
    addToDefinition: JSON.stringify(json)
  };
  try {
    const portalItem = layer.portalItem;
    const portal = portalItem.portal;
    const isVelocityView = (viewItem === null || viewItem === void 0 ? void 0 : viewItem.typeKeywords.indexOf("IoTFeatureLayer")) > -1;
    const result = await esriRequest(addToDefUrl, {
      query: Object.assign(Object.assign({}, addToDefContent), { f: "json", async: !portal.isPortal && !isVelocityView, token: portal.credential.token }),
      method: "post",
      responseType: "json"
    });
    if (portal.isPortal || isVelocityView) {
      return new Promise((resolve) => {
        resolve();
      });
    }
    else {
      try {
        await pollForStatus$1((_a = result === null || result === void 0 ? void 0 : result.data) === null || _a === void 0 ? void 0 : _a.statusURL, {
          f: "json",
          token: portal.credential.token
        }, esriRequest);
        return new Promise((resolve) => {
          resolve();
        });
      }
      catch (e) {
        // add request worked; ignore the polling error
        //return new Promise((resolve) => {
        //  resolve();
        //});
        /* real error
        {
          "submissionTime": 1652480104360,
          "lastUpdatedTime": 1652480104360,
          "status": "Failed",
          "error": {
              "code": 500,
              "description": "Editing definition error - USA_West2_view"
          }
      }
        */
        return new Promise((_, reject) => {
          reject(new Error("addToDefinition request failed (poll)"));
        });
      }
    }
  }
  catch (e) {
    if (!retry) {
      // in case it's just a fluke
      return addToDefinitionRequest$1(addToDefUrl, json, esriRequest, props, true);
    }
    return new Promise((_, reject) => {
      reject(new Error("addToDefinition request failed"));
    });
  }
}
async function deleteFromDefinitionRequest(deleteFromDefUrl, json, portalItem, esriRequest, retry = false) {
  const deleteFromDefContent = {
    deleteFromDefinition: JSON.stringify(json)
  };
  try {
    await esriRequest(deleteFromDefUrl, {
      query: Object.assign(Object.assign({}, deleteFromDefContent), { f: "json", token: portalItem.portal.credential.token }),
      method: "post",
      responseType: "json"
    });
    return new Promise((resolve) => {
      resolve();
    });
  }
  catch (e) {
    if (!retry) {
      // in case it's just a fluke
      return deleteFromDefinitionRequest(deleteFromDefUrl, json, portalItem, esriRequest, true);
    }
    return new Promise((_, reject) => {
      reject(new Error("deleteFromDefinition request failed"));
    });
  }
}
function getDefLayerJSON(fLayer, props) {
  /*
  // compared to service info response (layers, tables)....
  - no indexes
  - no fields
  - no serviceItemId
  - no serverGens
  - no relationships
  - + url
  - + attributes
  - + layerMetadataUrl
  - + mapViewerUrl
  - + mapViewerUrlWithGeocode
  - + newMapViewerUrl
  - + sceneViewerUrl
  - + adminLayerInfo
  */
  const { layer, layerItem } = props;
  const json = fLayer.sourceJSON;
  delete json.indexes;
  delete json.fields;
  delete json.serviceItemId;
  delete json.serverGens;
  delete json.relationships;
  json.url = `${fLayer.url}/${fLayer.layerId}?token=${layer.portalItem.portal.credential.token}`;
  json.adminLayerInfo = {
    viewLayerDefinition: {
      sourceServiceName: getServiceName(layerItem),
      sourceLayerId: fLayer.layerId,
      sourceLayerFields: "*"
    }
  };
  // can't update fields or AOI when adding layer to definition
  //console.log("getDefLayerJSON - id:", fLayer.layerId, json);
  return json;
}
async function getUpdateLayerJSON(fLayer, props) {
  var _a, _b, _c, _d, _e, _f, _g, _h, _j;
  const { modules } = props;
  const json = {};
  const viewLayerProps = getViewLayerProps(fLayer.layerId, props);
  if (viewLayerProps) {
    // filter
    json.viewDefinitionQuery = viewLayerProps.filter || "";
    // AOI
    if (viewLayerProps.aoi) {
      let aoi = viewLayerProps.aoi;
      // make sure SR fits to layer
      if (!sameSR(aoi.spatialReference, fLayer.spatialReference)) {
        await modules.projection.load();
        const geom = aoi.rings ? modules.Polygon.fromJSON(aoi) : modules.Extent.fromJSON(aoi);
        aoi = (_a = modules.projection.project(geom, fLayer.spatialReference)) === null || _a === void 0 ? void 0 : _a.toJSON();
      }
      const geometryType = aoi.rings ? "esriGeometryPolygon" : "esriGeometryEnvelope";
      json.viewLayerDefinition = {
        filter: {
          operator: "esriSpatialRelIntersects",
          value: {
            geometryType,
            geometry: aoi
          }
        }
      };
    }
    else {
      const adminLayerInfo = getAdminLayerInfo(fLayer.layerId, props);
      const aoiValue = (_e = (_d = (_c = (_b = adminLayerInfo === null || adminLayerInfo === void 0 ? void 0 : adminLayerInfo.adminLayerInfo) === null || _b === void 0 ? void 0 : _b.viewLayerDefinition) === null || _c === void 0 ? void 0 : _c.table) === null || _d === void 0 ? void 0 : _d.filter) === null || _e === void 0 ? void 0 : _e.value;
      if (aoiValue) {
        // only update if there was one before
        json.viewLayerDefinition = {
          filter: null
        };
      }
    }
    // fields
    if (viewLayerProps.fields) {
      json.fields = fLayer.fields.map((field) => {
        return {
          name: field.name,
          visible: viewLayerProps.fields.indexOf(field.name) > -1
        };
      });
    }
    else {
      // all fields are visible
      json.fields = fLayer.fields.map((field) => {
        return {
          name: field.name,
          visible: true
        };
      });
    }
  }
  else {
    // filter
    json.viewDefinitionQuery = "";
    // fields
    json.fields = fLayer.fields.map((field) => {
      return {
        name: field.name,
        visible: true
      };
    });
    // AOI
    const adminLayerInfo = getAdminLayerInfo(fLayer.layerId, props);
    const aoiValue = (_j = (_h = (_g = (_f = adminLayerInfo === null || adminLayerInfo === void 0 ? void 0 : adminLayerInfo.adminLayerInfo) === null || _f === void 0 ? void 0 : _f.viewLayerDefinition) === null || _g === void 0 ? void 0 : _g.table) === null || _h === void 0 ? void 0 : _h.filter) === null || _j === void 0 ? void 0 : _j.value;
    if (aoiValue) {
      // only update if there was one before
      json.viewLayerDefinition = {
        filter: null
      };
    }
  }
  //console.log("getUpdateLayerJSON - id:", fLayer.layerId, json);
  return json;
}
async function moveToFolder(props, createServiceResponse, newItemProps, esriRequest) {
  const { layer } = props;
  const portalItem = layer.portalItem;
  const { portal } = portalItem;
  if (!newItemProps.folder || !newItemProps.folder.id || newItemProps.folder.id === portalItem.owner) {
    // it's already in the home folder
    return;
  }
  let baseUrl = `${portal.restUrl}/content/users/${portalItem.owner}/items/`;
  const moveUrl = `${baseUrl}${createServiceResponse.itemId}/move`;
  const moveContent = {
    folder: newItemProps.folder.id
  };
  return await esriRequest(moveUrl, {
    query: Object.assign(Object.assign({}, moveContent), { f: "json", token: portal.credential.token }),
    method: "post",
    responseType: "json"
  });
}
async function initialItemUpdate(props, createServiceResponse, newItemProps, esriRequest) {
  var _a, _b, _c, _d, _e, _f, _g, _h, _j, _k, _l, _m, _o, _p;
  const { layer, layerIds } = props;
  const portalItem = layer.portalItem;
  const portal = portalItem.portal;
  const itemData = await layer.portalItem.fetchData();
  const hasData = (itemData === null || itemData === void 0 ? void 0 : itemData.layers) || (itemData === null || itemData === void 0 ? void 0 : itemData.tables);
  if (hasData) {
    itemData.layers = (_a = itemData.layers) === null || _a === void 0 ? void 0 : _a.filter((lyr) => layerIds.indexOf(lyr.id) > -1);
    itemData.tables = (_b = itemData.tables) === null || _b === void 0 ? void 0 : _b.filter((lyr) => layerIds.indexOf(lyr.id) > -1);
    // if there are no existing overrides for layers or tables keep them undefined
    if (layer.type === "group" && ((_c = layer.layers) === null || _c === void 0 ? void 0 : _c.length)) {
      itemData.layers = itemData.layers || undefined;
    }
    if (layer.type === "group" && ((_d = layer.tables) === null || _d === void 0 ? void 0 : _d.length)) {
      itemData.tables = itemData.tables || undefined;
    }
    // remove parent item definitionExpression
    (_e = itemData.layers) === null || _e === void 0 ? void 0 : _e.forEach((lyr) => {
      if (lyr.layerDefinition) {
        lyr.layerDefinition.definitionExpression = undefined;
      }
    });
    (_f = itemData.tables) === null || _f === void 0 ? void 0 : _f.forEach((table) => {
      if (table.layerDefinition) {
        table.layerDefinition.definitionExpression = undefined;
      }
    });
  }
  const updateUrl = `${portal.restUrl}/content/users/${portalItem.owner}/items/${createServiceResponse.itemId}/update`;
  // need to send some info again
  const updateContent = {
    title: newItemProps.title,
    tags: ((_g = newItemProps.tags) === null || _g === void 0 ? void 0 : _g.length) ? newItemProps.tags.toString() : undefined,
    snippet: newItemProps.summary,
    categories: (_h = newItemProps.categories) === null || _h === void 0 ? void 0 : _h.join(",")
    //extent: `${portalItem.extent.xmin},${portalItem.extent.ymin},${portalItem.extent.xmax},${portalItem.extent.ymax}`,
  };
  if (hasData) {
    updateContent.text = JSON.stringify(itemData);
  }
  if ((layer.type === "group" && ((_m = (_l = (_k = (_j = layer.layers) === null || _j === void 0 ? void 0 : _j.getItemAt(0)) === null || _k === void 0 ? void 0 : _k.fullExtent) === null || _l === void 0 ? void 0 : _l.spatialReference) === null || _m === void 0 ? void 0 : _m.wkt)) ||
    (layer.type === "feature" && ((_p = (_o = layer.fullExtent) === null || _o === void 0 ? void 0 : _o.spatialReference) === null || _p === void 0 ? void 0 : _p.wkt))) {
    // fix bad item extent created by the /refresh call sent from addToDefinition
    setTimeout(() => {
      const updateContent2 = {
        extent: `${portalItem.extent.xmin},${portalItem.extent.ymin},${portalItem.extent.xmax},${portalItem.extent.ymax}`
      };
      esriRequest(updateUrl, {
        query: Object.assign(Object.assign({}, updateContent2), { f: "json", token: portal.credential.token }),
        method: "post",
        responseType: "json"
      });
    }, 7000);
  }
  return await esriRequest(updateUrl, {
    query: Object.assign(Object.assign({}, updateContent), { f: "json", token: portal.credential.token }),
    method: "post",
    responseType: "json"
  });
}
async function itemUpdate(props, addLayerIds, deleteLayerIds, esriRequest) {
  var _a, _b, _c, _d, _e, _f, _g, _h;
  if (!addLayerIds.length && !deleteLayerIds.length) {
    // nothing to do
    return new Promise((resolve) => {
      resolve();
    });
  }
  const { layer, viewItem } = props;
  const portalItem = layer.portalItem;
  const portal = portalItem.portal;
  const itemData = await layer.portalItem.fetchData();
  let viewItemData = await viewItem.fetchData();
  if ((!itemData || (!itemData.layers && !itemData.tables)) &&
    (!viewItemData || (!viewItemData.layers && !viewItemData.tables))) {
    return new Promise((resolve) => {
      resolve();
    });
  }
  if (deleteLayerIds.length) {
    if ((_a = viewItemData === null || viewItemData === void 0 ? void 0 : viewItemData.layers) === null || _a === void 0 ? void 0 : _a.length) {
      viewItemData.layers = viewItemData.layers.filter((lyr) => deleteLayerIds.indexOf(lyr.id) === -1);
    }
    if ((_b = viewItemData === null || viewItemData === void 0 ? void 0 : viewItemData.tables) === null || _b === void 0 ? void 0 : _b.length) {
      viewItemData.tables = viewItemData.tables.filter((lyr) => deleteLayerIds.indexOf(lyr.id) === -1);
    }
  }
  // Do we already have a layers/tables list in the item /data object?
  // If so, are we adding some new layers/tables?
  // Then we have to make sure that we add these new layers/tables to the list
  // even if there are no existing overrides for them
  const viewItemHasContent = !!((_c = viewItemData === null || viewItemData === void 0 ? void 0 : viewItemData.layers) === null || _c === void 0 ? void 0 : _c.length) || !!((_d = viewItemData === null || viewItemData === void 0 ? void 0 : viewItemData.tables) === null || _d === void 0 ? void 0 : _d.length);
  if (addLayerIds.length) {
    const newLayers = [];
    const newTables = [];
    addLayerIds.forEach((id) => {
      const fLayer = getFL(id, props);
      if (!fLayer.isTable) {
        let newLayer;
        if (itemData === null || itemData === void 0 ? void 0 : itemData.layers) {
          newLayer = itemData.layers.find((lyr) => lyr.id === id);
          // remove parent item definitionExpression
          if (newLayer === null || newLayer === void 0 ? void 0 : newLayer.layerDefinition) {
            newLayer.layerDefinition.definitionExpression = undefined;
          }
        }
        if (!newLayer && viewItemHasContent) {
          // we must add the newly added layer to the item /data layers list
          // no overrides, add just id, don't need popup
          newLayer = { id };
        }
        if (newLayer) {
          newLayers.push(newLayer);
        }
      }
      else {
        // table
        let newTable;
        if (itemData === null || itemData === void 0 ? void 0 : itemData.tables) {
          newTable = itemData.tables.find((lyr) => lyr.id === id);
          // remove parent item definitionExpression
          if (newTable === null || newTable === void 0 ? void 0 : newTable.layerDefinition) {
            newTable.layerDefinition.definitionExpression = undefined;
          }
        }
        if (!newTable && viewItemHasContent) {
          // we must add the newly added layer to the item /data layers list
          // no overrides, add just id, don't need popup
          newTable = { id };
        }
        if (newTable) {
          newTables.push(newTable);
        }
      }
    });
    if (newLayers === null || newLayers === void 0 ? void 0 : newLayers.length) {
      viewItemData = viewItemData || {};
      viewItemData.layers = (viewItemData.layers || []).concat(newLayers);
      // make sure it follows the parent layer's order
      // the view service might have it differently (service bug)
      const ids = [];
      (_e = layer.layers) === null || _e === void 0 ? void 0 : _e.forEach((lyr) => {
        ids.unshift(lyr.layerId);
      });
      viewItemData.layers.sort((lyrA, lyrB) => (ids.indexOf(lyrA.id) < ids.indexOf(lyrB.id) ? -1 : 1));
    }
    if (newTables === null || newTables === void 0 ? void 0 : newTables.length) {
      viewItemData = viewItemData || {};
      viewItemData.tables = (viewItemData.tables || []).concat(newTables);
      // make sure it follows the parent layer's order
      // the view service might have it differently (service bug)
      const ids = [];
      (_f = layer.tables) === null || _f === void 0 ? void 0 : _f.forEach((lyr) => {
        ids.unshift(lyr.layerId);
      });
      viewItemData.tables.sort((lyrA, lyrB) => (ids.indexOf(lyrA.id) < ids.indexOf(lyrB.id) ? -1 : 1));
    }
  }
  const updateUrl = `${portal.restUrl}/content/users/${portalItem.owner}/items/${viewItem.id}/update`;
  // need to send some info again
  const updateContent = {
    tags: ((_g = viewItem.tags) === null || _g === void 0 ? void 0 : _g.length) ? viewItem.tags.toString() : undefined,
    snippet: viewItem.snippet,
    categories: (_h = viewItem.categories) === null || _h === void 0 ? void 0 : _h.join(","),
    //extent: `${viewItem.extent.xmin},${viewItem.extent.ymin},${viewItem.extent.xmax},${viewItem.extent.ymax}`,
    text: JSON.stringify(viewItemData)
  };
  return await esriRequest(updateUrl, {
    query: Object.assign(Object.assign({}, updateContent), { f: "json", token: portal.credential.token }),
    method: "post",
    responseType: "json"
  });
}
const pollForStatus$1 = async (url, params, esriRequest) => {
  var _a;
  if (!url) {
    throw new Error("pollForStatus: no status URL");
  }
  const pendingStatuses = ["processing", "partial", "Pending", "InProgress"];
  const successStatuses = ["completed", "Completed"];
  // Keep polling status until either completed or failed
  try {
    // Do failures report as success (status 200)? May need to manually throw error on status check failure
    const statusResponse = await esriRequest(url, { query: params });
    const status = (_a = statusResponse === null || statusResponse === void 0 ? void 0 : statusResponse.data) === null || _a === void 0 ? void 0 : _a.status;
    if (pendingStatuses.includes(status)) {
      await (0,_functional_c82f5ab9_js__WEBPACK_IMPORTED_MODULE_4__.t)(500);
      return pollForStatus$1(url, params, esriRequest);
    }
    else if (successStatuses.includes(status)) {
      return new Promise((resolve) => {
        resolve();
      });
    }
    else {
      return new Promise((_, reject) => {
        reject();
      });
    }
  }
  catch (e) {
    return new Promise((_, reject) => {
      reject(e);
    });
  }
};

const arcgisLayerViewCss = ".sc-arcgis-layer-view-h{height:100%}.panel.sc-arcgis-layer-view{height:100%}.footer.sc-arcgis-layer-view{width:100%}.error-content.sc-arcgis-layer-view{margin:0.5rem}";

const ArcgisLayerView$1 = class {
  constructor(hostRef) {
    (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.r)(this, hostRef);
    this.arcgisLayerViewCancel = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "arcgisLayerViewCancel", 7);
    this.arcgisLayerViewStepChange = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "arcgisLayerViewStepChange", 7);
    this.arcgisLayerViewCreated = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "arcgisLayerViewCreated", 7);
    this.arcgisLayerViewChanged = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "arcgisLayerViewChanged", 7);
    this.status = flowStatus.LOADING;
    // --------------------------------------------------------------------------
    //
    //  Private methods
    //
    // --------------------------------------------------------------------------
    this.goCancel = () => {
      this.arcgisLayerViewCancel.emit();
    };
    this.view = undefined;
    this.itemId = undefined;
    this.config = undefined;
    this.props = undefined;
    this.reRender = false;
  }
  arcgisLayerViewStatusHandler(event) {
    var _a;
    const { props } = this;
    const { detail } = event;
    this.status = detail.status;
    if ((_a = detail.layerIds) === null || _a === void 0 ? void 0 : _a.length) {
      props.layerIds = [...detail.layerIds];
    }
    if (this.status === flowStatus.SELECTION) {
      // we might change source item in this step...
      props.sourceItemId = props.layerItem.id;
      this.arcgisLayerViewStepChange.emit(1);
    }
    else if (this.status === flowStatus.OVERVIEW) {
      this.arcgisLayerViewStepChange.emit(2);
    }
    else if (this.status === flowStatus.CREATE) {
      this.arcgisLayerViewStepChange.emit(3);
    }
    this.reRender = !this.reRender;
  }
  async arcgisLayerViewCreateDoneHandler(event) {
    this.arcgisLayerViewCreated.emit(event.detail);
  }
  async arcgisLayerViewOverviewUpdatedHandler() {
    this.arcgisLayerViewChanged.emit(this.itemId);
  }
  arcgisLayerViewSelectionCancelHandler() {
    this.arcgisLayerViewCancel.emit();
  }
  arcgisLayerViewOverviewCancelHandler() {
    this.arcgisLayerViewCancel.emit();
  }
  arcgisLayerViewCreateCancelHandler() {
    this.arcgisLayerViewCancel.emit();
  }
  //--------------------------------------------------------------------------
  //
  //  Public Methods
  //
  //--------------------------------------------------------------------------
  async setStep(step) {
    const { props } = this;
    const { viewItem } = props;
    // close popovers
    document.body.querySelectorAll(".js-app-flyout").forEach((node) => {
      document.body.removeChild(node);
    });
    switch (step) {
      case 1:
        this.status = flowStatus.SELECTION;
        this.reRender = !this.reRender;
        break;
      case 2:
        this.status = flowStatus.OVERVIEW;
        this.reRender = !this.reRender;
        break;
      case 3:
        if (!viewItem) {
          this.status = flowStatus.CREATE;
          this.reRender = !this.reRender;
        }
        break;
    }
  }
  //--------------------------------------------------------------------------
  //
  //  Lifecycle
  //
  //--------------------------------------------------------------------------
  async componentWillLoad() {
    const { itemId, view, config } = this;
    const [strings] = await (0,_locale_13e00a75_js__WEBPACK_IMPORTED_MODULE_1__.g)(this.hostElement);
    this.strings = strings;
    this.props = { config, view, itemId, strings, layerIds: [], modules: {} };
  }
  async componentDidLoad() {
    var _a, _b, _c;
    let { props } = this;
    const { itemId, view } = props;
    if (!itemId) {
      console.error("itemId is a required property.");
      return;
    }
    try {
      const [PortalItem, Layer, Extent, projection, colorUtils, Polygon, esriRequest] = await (0,_loadModules_aaf30bd6_js__WEBPACK_IMPORTED_MODULE_2__.l)([
        "esri/portal/PortalItem",
        "esri/layers/Layer",
        "esri/geometry/Extent",
        "esri/geometry/projection",
        "esri/views/support/colorUtils",
        "esri/geometry/Polygon",
        "esri/request"
      ]);
      props.modules.PortalItem = PortalItem;
      props.modules.projection = projection;
      props.modules.Polygon = Polygon;
      props.modules.Extent = Extent;
      props.modules.Layer = Layer;
      const item = new PortalItem({
        id: itemId
      });
      await item.load();
      if (item.type !== "Feature Service") {
        console.error("Only Feature Service items are allowed.");
        return;
      }
      let viewItem, layerItem;
      if (((_a = item.typeKeywords) === null || _a === void 0 ? void 0 : _a.indexOf("View Service")) > -1) {
        // need to look for original item
        viewItem = item;
        await item
          .fetchRelatedItems({
          relationshipType: "Service2Data",
          direction: "forward"
        })
          .then(async (results) => {
          if (results.length) {
            layerItem = results[0];
          }
        });
      }
      else {
        layerItem = item;
      }
      if (!layerItem) {
        console.error("Could not find related item for view.");
        this.panelNode.loading = false;
        this.status = flowStatus.ERROR;
        this.reRender = !this.reRender;
        return;
      }
      props.sourceItemId = layerItem.id;
      let layerItemOwner = layerItem.portal.user;
      if (layerItem.portal.user.username !== layerItem.owner) {
        // get user info of owner
        await esriRequest(`${layerItem.portal.restUrl}/community/users/${layerItem.owner}`, {
          query: { f: "json" }
        }).then((userResult) => {
          if (userResult === null || userResult === void 0 ? void 0 : userResult.data) {
            layerItemOwner = userResult.data;
          }
        });
      }
      let gcsExtent = (viewItem || layerItem).extent;
      if (!gcsExtent) {
        gcsExtent = new Extent({
          xmin: -180,
          ymin: -90,
          xmax: 180,
          ymax: 90,
          spatialReference: 4326
        });
      }
      if (view.spatialReference.wkid !== 4326) {
        await projection.load();
        const extent = projection.project(gcsExtent, view.spatialReference);
        view.goTo(extent.expand(1.1));
      }
      else {
        view.goTo(gcsExtent.expand(1.1));
      }
      const backgroundTheme = await colorUtils.getBackgroundColorTheme(view);
      // layerItem (from relatedItems call) does not contain itemControl
      // need to get the item card again to get itemControl too
      // need itemControl to create indexes
      layerItem = new PortalItem({
        id: layerItem.id
      });
      await layerItem.load();
      const layer = await Layer.fromPortalItem({
        portalItem: layerItem
      });
      this.props = Object.assign(Object.assign({}, props), { layerItem, viewItem, layer, layerItemOwner, backgroundTheme });
      props = this.props;
      //console.log("**layerItem**", layerItem);
      //console.log("**viewItem**", viewItem);
      //console.log("**layer**", layer);
      if (layer.type === "group") {
        // group layer has no layers or tables at this point
        // loadAll() loads layers and tables (at v4.23)
        await layer.loadAll();
        if ((_b = layer.layers) === null || _b === void 0 ? void 0 : _b.length) {
          // has at least one spatial layer
          view.map.add(layer);
        }
        props.layerIds = getLayersAndTables(layer)
          .map((subLayer) => subLayer.layerId)
          .toArray();
        // default popups
        (_c = layer.layers) === null || _c === void 0 ? void 0 : _c.forEach((lyr) => {
          if (!lyr.popupTemplate && lyr.popupEnabled) {
            lyr.popupTemplate = lyr.createPopupTemplate();
          }
        });
      }
      else {
        await layer.load();
        if (!layer.isTable) {
          view.map.add(layer);
        }
        props.layerIds = [layer.layerId];
        // default popup
        layer.popupTemplate = layer.createPopupTemplate();
      }
      await getAdminServiceInfo$1(props);
      /* console.log(
        "view adminServiceInfo layers",
        props.adminServiceInfo?.layers?.map((lyr: any) => {
          return {
            id: lyr.id,
            name: lyr.name,
            adminLayerInfo_filter: lyr.adminLayerInfo?.viewLayerDefinition?.table?.filter?.value,
            viewDefinitionQuery: lyr.viewDefinitionQuery,
            fields: lyr.fields.map((field: any) => `${field.name} (${field.visible})`)
          };
        })
      ); */
      await initDefinitions(props);
      //console.log("initDefinitions", propsToString(props));
      // derivative layers
      props.derivativeLayers = { hasAny: false };
      if (viewItem) {
        const results = await item.fetchRelatedItems({
          relationshipType: "Service2Service",
          direction: "forward"
        });
        if (results.length) {
          props.derivativeLayers = {
            hasMS: results.find((item) => item.type === "Map Service"),
            hasVTL: results.find((item) => item.type === "Vector Tile Service"),
            hasWFS: results.find((item) => item.type === "WFS"),
            hasScene: results.find((item) => item.type === "Scene Service"),
            hasOGCFL: results.find((item) => item.type === "OGCFeatureServer")
          };
          if (props.derivativeLayers.hasMS ||
            props.derivativeLayers.hasVTL ||
            props.derivativeLayers.hasWFS ||
            props.derivativeLayers.hasScene ||
            props.derivativeLayers.hasOGCFL) {
            props.derivativeLayers.hasAny = true;
          }
        }
      }
      // sync and replicas
      if (viewItem && props.adminServiceInfo.capabilities.indexOf("Sync") > -1) {
        // check for replicas
        const replicaUrl = `${viewItem.url}/replicas`;
        await esriRequest(replicaUrl, {
          query: { f: "json" }
        }).then((replicaResult) => {
          var _a;
          props.hasReplicas = ((_a = replicaResult.data) === null || _a === void 0 ? void 0 : _a.length) > 0;
        });
      }
      this.status = flowStatus.SELECTION;
      this.reRender = !this.reRender;
      this.arcgisLayerViewStepChange.emit(1);
    }
    catch (e) {
      console.error(e);
      this.status = flowStatus.ERROR;
      this.reRender = !this.reRender;
    }
  }
  disconnectedCallback() {
    const { props } = this;
    const { view, layer } = props;
    view.map.remove(layer);
  }
  // --------------------------------------------------------------------------
  //
  //  Render Methods
  //
  //--------------------------------------------------------------------------
  render() {
    //console.log("render", propsToString(this.props), "status:", this.status);
    const { status } = this;
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)(_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.H, null, status === flowStatus.ERROR ? this.renderError() : null, status === flowStatus.LOADING ? this.renderLoading() : null, [flowStatus.SELECTION, flowStatus.SWAP_SOURCE, flowStatus.BROWSE_LAYER].includes(status)
      ? this.renderLayerSelection()
      : null, [flowStatus.OVERVIEW, flowStatus.DEFINITION, flowStatus.FILTER].includes(status)
      ? this.renderLayerOverview()
      : null, status === flowStatus.CREATE ? this.renderCreateView() : null));
  }
  renderError() {
    const { props } = this;
    const { viewItem, layerItem, strings } = props;
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-flow-item", { loading: false, heading: (viewItem === null || viewItem === void 0 ? void 0 : viewItem.title) || (layerItem === null || layerItem === void 0 ? void 0 : layerItem.title) || strings.msg.error, description: (viewItem === null || viewItem === void 0 ? void 0 : viewItem.title) || (layerItem === null || layerItem === void 0 ? void 0 : layerItem.title) ? strings.general.sourceLayer : undefined, class: CSS$9.panel, ref: (node) => (this.panelNode = node) }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS$9.errorContent }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-notice", { scale: "s", width: "full", open: true, icon: "exclamation-mark-triangle", kind: "danger" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { slot: "title" }, strings.msg.error), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { slot: "message" }, strings.msg.initFailed))), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { slot: "footer", class: CSS$9.footer }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { slot: "footer", onClick: this.goCancel, appearance: "transparent", width: "full" }, strings.general.cancel))));
  }
  renderLoading() {
    const { props } = this;
    const { viewItem, layerItem, strings } = props;
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-flow-item", { loading: true, heading: (viewItem === null || viewItem === void 0 ? void 0 : viewItem.title) || (layerItem === null || layerItem === void 0 ? void 0 : layerItem.title), description: strings.general.sourceLayer, class: CSS$9.panel, ref: (node) => (this.panelNode = node) }));
  }
  renderLayerSelection() {
    const { props, status } = this;
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-layer-view-selection", { key: `selection-${status}`, props: props, status: status }));
  }
  renderLayerOverview() {
    const { props, status } = this;
    const { definitionLayerId } = props;
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-layer-view-overview", { key: `overview-${status}-${definitionLayerId}`, props: props, status: status }));
  }
  renderCreateView() {
    const { props, status } = this;
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-layer-view-create", { key: `create-${status}`, props: props }));
  }
  get hostElement() { return (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.d)(this); }
};
ArcgisLayerView$1.style = arcgisLayerViewCss;

const arcgisLayerViewBrowseLayerCss = ".panel.sc-arcgis-layer-view-browse-layer{height:100%}";

const ArcgisLayerViewBrowseLayer = class {
  constructor(hostRef) {
    (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.r)(this, hostRef);
    this.arcgisLayerViewStatusChange = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "arcgisLayerViewStatusChange", 7);
    // --------------------------------------------------------------------------
    //
    //  Private methods
    //
    // --------------------------------------------------------------------------
    this.onBack = () => {
      this.arcgisLayerViewStatusChange.emit({ status: flowStatus.SWAP_SOURCE });
    };
    this.goSwapLayer = async (itemId) => {
      const { props, flowItemNode, hostElement } = this;
      const { strings } = props;
      const swapItem = this.items.find((item) => item.id === itemId);
      this.loading = true;
      const canSwapLayerErrorString = await canSwap(swapItem, this.props);
      if (canSwapLayerErrorString) {
        this.loading = false;
        this.msgNode = document.createElement("arcgis-layer-view-msg");
        this.msgNode.props = props;
        this.msgNode.flowItemElement = flowItemNode;
        this.msgNode.isError = true;
        this.msgNode.message = `${strings.msg.cannotSwap} ${canSwapLayerErrorString}`;
        hostElement.appendChild(this.msgNode);
        clearTimeout(this.timeoutHndl);
        this.timeoutHndl = setTimeout(() => {
          this.timeoutHndl = undefined;
          if (this.msgNode) {
            hostElement.removeChild(this.msgNode);
            this.msgNode = undefined;
          }
        }, 7000);
      }
      else {
        try {
          await swapSource(this.props);
          this.loading = false;
          this.msgNode = document.createElement("arcgis-layer-view-msg");
          this.msgNode.props = props;
          this.msgNode.flowItemElement = flowItemNode;
          this.msgNode.message = strings.msg.successSwap.replace("${source}", swapItem.title);
          this.msgNode.closeWithOK = true;
          this.msgNode.addEventListener("arcgisLayerViewMsgClosed", () => {
            this.msgNode = undefined;
            this.arcgisLayerViewStatusChange.emit({ status: flowStatus.SELECTION });
          });
          hostElement.appendChild(this.msgNode);
        }
        catch (e) {
          this.loading = false;
          this.msgNode = document.createElement("arcgis-layer-view-msg");
          this.msgNode.props = props;
          this.msgNode.flowItemElement = flowItemNode;
          this.msgNode.isError = true;
          this.msgNode.message = strings.msg.swapFailed;
          hostElement.appendChild(this.msgNode);
          clearTimeout(this.timeoutHndl);
          this.timeoutHndl = setTimeout(() => {
            this.timeoutHndl = undefined;
            if (this.msgNode) {
              hostElement.removeChild(this.msgNode);
              this.msgNode = undefined;
            }
          }, 7000);
        }
      }
    };
    this.props = undefined;
    this.reRender = false;
    this.loading = false;
    this.items = undefined;
    this.pagination = undefined;
    this.error = undefined;
  }
  arcgisLayerViewMsgClosedHandler() {
    if (this.msgNode) {
      this.hostElement.removeChild(this.msgNode);
      this.msgNode = undefined;
    }
    clearTimeout(this.timeoutHndl);
    this.timeoutHndl = undefined;
  }
  //--------------------------------------------------------------------------
  //
  //  Lifecycle
  //
  //--------------------------------------------------------------------------
  async componentDidLoad() {
    setTimeout(() => requestAnimationFrame(() => { var _a; return (_a = this.flowItemNode) === null || _a === void 0 ? void 0 : _a.setFocus(); }), 200);
  }
  // --------------------------------------------------------------------------
  //
  //  Render Methods
  //
  //--------------------------------------------------------------------------
  render() {
    const { props, loading, hostElement } = this;
    const { strings } = props;
    const rtl = (0,_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_5__.g)(hostElement) === "rtl";
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)(_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.H, { class: "calcite-match-height" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-flow-item", { heading: strings.swapSource.browseForLayerTitle, description: strings.swapSource.subTitle, loading: loading, class: {
        panel: true,
        [_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_5__.C.rtl]: rtl
      }, onCalciteFlowItemBack: this.onBack, ref: (node) => (this.flowItemNode = node) }, this.renderItemBrowser())));
  }
  renderItemBrowser() {
    const { props, pagination } = this;
    const { layer, sourceItemId, strings } = props;
    const { portalItem } = layer;
    const { portal } = portalItem;
    const user = portal.user;
    const query = `type:"Feature Service" typekeywords:"Hosted Service" -typekeywords:"View Service" owner:"${user.username}" -id:${sourceItemId}`;
    const baseUrl = `${(0,_portal_8714dc6c_js__WEBPACK_IMPORTED_MODULE_6__.g)(portal)}/home/`;
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-item-browser", { onArcgisItemBrowserUpdate: (e) => {
        const { results, num, start, total } = e.detail;
        this.items = results;
        this.pagination = { start, num, total };
      }, filter: query, portal: portal, user: user, api: 4, config: { baseUrl }, selection: "none" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-item-browser-top-bar", { slot: "top-bar" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-item-browser-search", { slot: "search", term: "" })), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-item-browser-sort", { options: ["modified", "title", "relevance"], slot: "sort" }), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-item-browser-content", { slot: "content" }, (this.items || []).map((item) => ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-item-browser-card", { item: item, portal: portal, baseUrl: baseUrl, key: item.id }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { id: `swap-action-${item.id}`, icon: "arrow-right-left", text: "", scale: "s", slot: "actions-end", onClick: this.goSwapLayer.bind(this, item.id) }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-tooltip", { slot: "tooltip", label: strings.general.swapSource, overlayPositioning: "fixed" }, strings.general.swapSource)))))), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-item-browser-pagination", { total: pagination === null || pagination === void 0 ? void 0 : pagination.total, start: pagination === null || pagination === void 0 ? void 0 : pagination.start, num: pagination === null || pagination === void 0 ? void 0 : pagination.num, slot: "pagination" })));
  }
  get hostElement() { return (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.d)(this); }
};
ArcgisLayerViewBrowseLayer.style = arcgisLayerViewBrowseLayerCss;

const CSS$8 = {
  panel: "panel",
  info: "info",
  footer: "footer"
};

const arcgisLayerViewCreateCss = ".panel.sc-arcgis-layer-view-create{height:100%}.info.sc-arcgis-layer-view-create{display:grid;grid-template-columns:repeat(1, minmax(0px, 1fr));gap:0.5rem;padding:1rem 0.75rem}.footer.sc-arcgis-layer-view-create{width:100%}";

const ArcgisLayerViewCreate$1 = class {
  constructor(hostRef) {
    (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.r)(this, hostRef);
    this.arcgisLayerViewStatusChange = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "arcgisLayerViewStatusChange", 7);
    this.arcgisLayerViewCreateDone = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "arcgisLayerViewCreateDone", 7);
    this.arcgisLayerViewCreateCancel = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "arcgisLayerViewCreateCancel", 7);
    // --------------------------------------------------------------------------
    //
    //  Private methods
    //
    // --------------------------------------------------------------------------
    this.goBack = () => {
      // save last settings
      const { props } = this;
      props.savedItemProps = {
        title: _item_properties_e6412a9a_js__WEBPACK_IMPORTED_MODULE_7__.i.title,
        tags: _item_properties_e6412a9a_js__WEBPACK_IMPORTED_MODULE_7__.i.tags,
        summary: _item_properties_e6412a9a_js__WEBPACK_IMPORTED_MODULE_7__.i.snippet,
        categories: _item_properties_e6412a9a_js__WEBPACK_IMPORTED_MODULE_7__.i.categories,
        folder: _item_properties_e6412a9a_js__WEBPACK_IMPORTED_MODULE_7__.i.folder
      };
      this.arcgisLayerViewStatusChange.emit({ status: flowStatus.OVERVIEW });
    };
    this.goCreate = async () => {
      const { props, flowItemNode, hostElement } = this;
      const { strings } = props;
      // in case the create call fails
      props.savedItemProps = {
        title: _item_properties_e6412a9a_js__WEBPACK_IMPORTED_MODULE_7__.i.title,
        tags: _item_properties_e6412a9a_js__WEBPACK_IMPORTED_MODULE_7__.i.tags,
        summary: _item_properties_e6412a9a_js__WEBPACK_IMPORTED_MODULE_7__.i.snippet,
        categories: _item_properties_e6412a9a_js__WEBPACK_IMPORTED_MODULE_7__.i.categories,
        folder: _item_properties_e6412a9a_js__WEBPACK_IMPORTED_MODULE_7__.i.folder
      };
      const newItemProps = {
        title: _item_properties_e6412a9a_js__WEBPACK_IMPORTED_MODULE_7__.i.title,
        tags: _item_properties_e6412a9a_js__WEBPACK_IMPORTED_MODULE_7__.i.tags,
        summary: _item_properties_e6412a9a_js__WEBPACK_IMPORTED_MODULE_7__.i.snippet,
        categories: _item_properties_e6412a9a_js__WEBPACK_IMPORTED_MODULE_7__.i.categories,
        folder: _item_properties_e6412a9a_js__WEBPACK_IMPORTED_MODULE_7__.i.folder
      };
      this.loading = true;
      try {
        this.viewItemId = await createView(props, newItemProps);
        this.loading = false;
        this.msgNode = document.createElement("arcgis-layer-view-msg");
        this.msgNode.props = props;
        this.msgNode.flowItemElement = flowItemNode;
        this.msgNode.message = strings.msg.created;
        hostElement.appendChild(this.msgNode);
        clearTimeout(this.timeoutHndl);
        this.timeoutHndl = setTimeout(() => {
          this.timeoutHndl = undefined;
          if (this.msgNode) {
            hostElement.removeChild(this.msgNode);
            this.msgNode = undefined;
            this.arcgisLayerViewCreateDone.emit(this.viewItemId);
          }
        }, 7000);
      }
      catch (e) {
        const { props, flowItemNode } = this;
        const { strings } = props;
        this.loading = false;
        console.error("could not create view", e);
        this.msgNode = document.createElement("arcgis-layer-view-msg");
        this.msgNode.props = props;
        this.msgNode.flowItemElement = flowItemNode;
        this.msgNode.isError = true;
        if (e.message === "service name already exists") {
          // going to have another string...
          this.msgNode.message = strings.msg.createFailed;
        }
        else {
          this.msgNode.message = strings.msg.createFailed;
        }
        hostElement.appendChild(this.msgNode);
        clearTimeout(this.timeoutHndl);
        this.timeoutHndl = setTimeout(() => {
          this.timeoutHndl = undefined;
          if (this.msgNode) {
            hostElement.removeChild(this.msgNode);
            this.msgNode = undefined;
          }
        }, 7000);
      }
    };
    this.goCancel = () => {
      this.arcgisLayerViewCreateCancel.emit();
    };
    this.props = undefined;
    this.reRender = false;
    this.loading = false;
    this.title = undefined;
  }
  arcgisLayerViewMsgClosedHandler() {
    if (this.msgNode) {
      this.hostElement.removeChild(this.msgNode);
      this.msgNode = undefined;
    }
    clearTimeout(this.timeoutHndl);
    this.timeoutHndl = undefined;
    if (this.viewItemId) {
      this.arcgisLayerViewCreateDone.emit(this.viewItemId);
    }
  }
  //--------------------------------------------------------------------------
  //
  //  Lifecycle
  //
  //--------------------------------------------------------------------------
  async componentWillLoad() {
    const { props } = this;
    this.title = await getSuggestedTitle(props);
  }
  async componentDidLoad() {
    requestAnimationFrame(() => { var _a; return (_a = this.backButtonNode) === null || _a === void 0 ? void 0 : _a.setFocus(); });
  }
  // --------------------------------------------------------------------------
  //
  //  Render Methods
  //
  //--------------------------------------------------------------------------
  render() {
    //console.log("render view-create", propsToString(this.props));
    const { props, loading } = this;
    const { viewItem, layerItem, strings } = props;
    const rtl = (0,_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_5__.g)(this.hostElement) === "rtl";
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)(_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.H, { class: "calcite-match-height" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-flow-item", { heading: strings.createView.create, description: (viewItem === null || viewItem === void 0 ? void 0 : viewItem.title) || (layerItem === null || layerItem === void 0 ? void 0 : layerItem.title), loading: loading, class: {
        panel: true,
        [_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_5__.C.rtl]: rtl
      }, ref: (node) => (this.flowItemNode = node) }, this.renderFooterButtons(), this.renderInfo())));
  }
  renderFooterButtons() {
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { slot: "footer", class: CSS$8.footer }, this.renderBack(), this.renderCreate(), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("br", null), this.renderCancel()));
  }
  renderBack() {
    const { props } = this;
    const { strings } = props;
    const isRtl = (0,_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_5__.g)(this.hostElement) === "rtl";
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { onClick: this.goBack, appearance: "outline-fill", width: "half", "icon-start": isRtl ? "arrow-right" : "arrow-left", ref: (node) => (this.backButtonNode = node) }, strings.general.back));
  }
  renderCreate() {
    const { props, title, titleError, summaryError } = this;
    const { layer, layerIds, strings } = props;
    const enabled = (layer === null || layer === void 0 ? void 0 : layer.loaded) && layerIds.length && title && !titleError && !summaryError;
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { disabled: !enabled, onClick: enabled && this.goCreate, appearance: "solid", width: "half", "icon-start": "plus-square", ref: (node) => (this.createButtonNode = node) }, strings.createView.create));
  }
  renderCancel() {
    const { props } = this;
    const { layer, layerIds, strings } = props;
    const enabled = (layer === null || layer === void 0 ? void 0 : layer.loaded) && layerIds.length;
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { disabled: !enabled, onClick: enabled && this.goCancel, appearance: "transparent", width: "full" }, strings.general.cancel));
  }
  renderInfo() {
    const { props, title } = this;
    const { layer, layerItemOwner, savedItemProps } = props;
    const { portalItem } = layer;
    const { portal } = portalItem;
    const user = portal.user;
    const config = { portal, user, api: 4 };
    if (savedItemProps) {
      _item_properties_e6412a9a_js__WEBPACK_IMPORTED_MODULE_7__.i.title = savedItemProps.title;
      _item_properties_e6412a9a_js__WEBPACK_IMPORTED_MODULE_7__.i.folder = savedItemProps.folder;
      _item_properties_e6412a9a_js__WEBPACK_IMPORTED_MODULE_7__.i.snippet = savedItemProps.summary || "";
      _item_properties_e6412a9a_js__WEBPACK_IMPORTED_MODULE_7__.i.categories = savedItemProps.categories;
      _item_properties_e6412a9a_js__WEBPACK_IMPORTED_MODULE_7__.i.tags = savedItemProps.tags;
    }
    else {
      _item_properties_e6412a9a_js__WEBPACK_IMPORTED_MODULE_7__.i.title = title;
      _item_properties_e6412a9a_js__WEBPACK_IMPORTED_MODULE_7__.i.folder =
        portalItem.ownerFolder &&
          {
            id: portalItem.ownerFolder,
            username: portalItem.owner
          };
      _item_properties_e6412a9a_js__WEBPACK_IMPORTED_MODULE_7__.i.snippet = portalItem.snippet || "";
      _item_properties_e6412a9a_js__WEBPACK_IMPORTED_MODULE_7__.i.categories = portalItem.categories;
      _item_properties_e6412a9a_js__WEBPACK_IMPORTED_MODULE_7__.i.tags = portalItem.tags;
    }
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS$8.info }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-item-properties", { portal: portal, user: user, api: 4, config: config, type: "Feature Service", scale: "s" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-title-input", { enablePublishing: true, onArcgisTitleInputChange: async (event) => {
        const node = event.target;
        const titleError = await node.validateTitle();
        if ((!this.titleError && titleError) || (this.titleError && !titleError)) {
          this.reRender = !this.reRender;
        }
        this.titleError = titleError;
      } }), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-folder-picker", { user: layerItemOwner }), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-categories-picker", null), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-tags-picker", null), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-summary-input", { onArcgisSummaryInputChange: async (event) => {
        const node = event.target;
        const summaryError = (await node.getErrorMessage());
        if ((!this.summaryError && summaryError) || (this.summaryError && !summaryError)) {
          this.reRender = !this.reRender;
        }
        this.summaryError = summaryError;
      } }))));
  }
  get hostElement() { return (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.d)(this); }
};
ArcgisLayerViewCreate$1.style = arcgisLayerViewCreateCss;

const CSS$7 = {
  panel: "panel",
  hook: "hook",
  notice: "notice",
  filterBlock: "filter-block",
  filterChevron: "filter-chevron",
  aoiGroup: "aoi-group",
  aoiButton: "aoi-button",
  textCenter: "text-center",
  selectFields: "select-fields"
};

const arcgisLayerViewDefinitionCss = ".panel.sc-arcgis-layer-view-definition{height:100%}.hook.sc-arcgis-layer-view-definition{height:1px}.notice.sc-arcgis-layer-view-definition{margin:8px}.filter-block.sc-arcgis-layer-view-definition{cursor:pointer}.filter-block.sc-arcgis-layer-view-definition:hover{background-color:var(--calcite-ui-foreground-2)}.filter-chevron.sc-arcgis-layer-view-definition{margin-right:0.5rem}.arcgis--rtl.sc-arcgis-layer-view-definition .filter-chevron.sc-arcgis-layer-view-definition{margin-left:0.5rem;margin-right:auto}.aoi-group.sc-arcgis-layer-view-definition{width:100%;margin-bottom:0.75rem}.aoi-button.sc-arcgis-layer-view-definition{margin-top:0.75rem;border-top-width:1px;border-top-style:solid;border-top-color:var(--calcite-ui-border-3)}.text-center.sc-arcgis-layer-view-definition{text-align:center}.select-fields.sc-arcgis-layer-view-definition{margin:0 0 5px 0}";

const ArcgisLayerViewDefinition = class {
  constructor(hostRef) {
    (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.r)(this, hostRef);
    this.arcgisLayerViewOverViewRefresh = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "arcgisLayerViewOverViewRefresh", 7);
    this.aoiSymbol = {
      type: "simple-fill",
      style: "solid",
      color: [0, 0, 0, 0],
      outline: {
        type: "simple-line",
        style: "solid",
        color: [255, 0, 0, 255],
        width: 2
      }
    };
    // --------------------------------------------------------------------------
    //
    //  Private methods
    //
    // --------------------------------------------------------------------------
    this.onBack = () => {
      this.arcgisLayerViewOverViewRefresh.emit();
    };
    // ---------  Filter  -------------------------------------------------------
    this.goFilter = () => {
      var _a;
      if ((_a = this.aoiBlockNode) === null || _a === void 0 ? void 0 : _a.open) {
        this.aoiBlockNode.open = false;
        this.onAOIToggle();
      }
      this.status = flowStatus.FILTER;
      this.reRender = !this.reRender;
    };
    this.onBackFilter = () => {
      this.status = flowStatus.DEFINITION;
      this.reRender = !this.reRender;
      setTimeout(() => { var _a; return (_a = this.filterActionNode) === null || _a === void 0 ? void 0 : _a.setFocus(); }, 200);
    };
    // ---------  AOI     -------------------------------------------------------
    this.onPolygonClick = (event) => {
      const { props } = this;
      const { strings } = props;
      const node = event.target;
      if (!node.active) {
        this.sketchViewModel.cancel();
        this.sketchViewModel.create("polygon");
        node.active = true;
        this.rectangleAction.active = false;
        this.drawLabel.innerHTML = strings.defineView.aoiPolygonDraw;
      }
    };
    this.onRectangleClick = (event) => {
      const { props } = this;
      const { strings } = props;
      const node = event.target;
      if (!node.active) {
        this.sketchViewModel.cancel();
        this.sketchViewModel.create("rectangle");
        node.active = true;
        this.polygonAction.active = false;
        this.drawLabel.innerHTML = strings.defineView.aoiRectangleDraw;
      }
    };
    this.onDeleteAOIClick = () => {
      const { props } = this;
      const { definitionLayerId, strings } = props;
      this.sketchViewModel.cancel();
      this.graphicsLayer.removeAll();
      const viewLayerProps = getViewLayerProps(definitionLayerId, props);
      if (viewLayerProps) {
        viewLayerProps.aoi = undefined;
      }
      sanitizeViewProps(props);
      applyLayerAOI(undefined, definitionLayerId, props);
      this.drawLabel.innerHTML = strings.defineView.aoiSelect;
      this.polygonAction.disabled = false;
      this.rectangleAction.disabled = false;
      this.aoiBlockNode.description = strings.defineView.aoiSubtext;
      this.reRender = !this.reRender;
    };
    this.onGraphicUpdate = (event) => {
      const { props } = this;
      const { view, definitionLayerId } = props;
      view.closePopup();
      if (event.state === "complete") {
        const sketchGraphic = event.graphics[0];
        const extent = sketchGraphic.geometry.extent;
        const pts = sketchGraphic.geometry.rings[0];
        let isRectangle = false;
        if (pts.length === 5 &&
          pts.indexOf([extent.xmin, extent.ymin]) > -1 &&
          pts.indexOf([extent.xmax, extent.ymax]) > -1) {
          isRectangle = true;
        }
        addViewLayerProps(definitionLayerId, {
          aoi: this.rectangleAction.active && isRectangle
            ? extent.toJSON()
            : sketchGraphic.geometry.toJSON()
        }, props);
        applyLayerAOI(sketchGraphic.geometry, definitionLayerId, props);
        if (this.rectangleAction.active && !isRectangle) {
          // user updated a rectangle to a polygon
          this.reRender = !this.reRender;
        }
      }
    };
    // ---------  Fields  -------------------------------------------------------
    this.selectFields = (fl) => {
      const { props, totalFields, requiredFieldNames } = this;
      const { view, definitionLayerId } = props;
      const viewLayerProps = getViewLayerProps(definitionLayerId, props);
      let fieldNames = [];
      if (viewLayerProps === null || viewLayerProps === void 0 ? void 0 : viewLayerProps.fields) {
        fieldNames = viewLayerProps.fields;
      }
      else {
        fieldNames = totalFields
          .filter((field) => requiredFieldNames.indexOf(field.name) === -1)
          .map((field) => field.name);
      }
      this.closeLayerViewDefinitionPopoversHandler();
      const nodeWidth = this.flowItemNode.getBoundingClientRect().width;
      this.arcgisFieldPickList = document.createElement("arcgis-field-pick-list");
      this.arcgisFieldPickList.popoverProps = {
        placement: "auto",
        offsetDistance: -1 * (nodeWidth ? nodeWidth - 5 : 215),
        offsetSkidding: 0,
        pointerDisabled: true,
        popoverWidth: nodeWidth ? nodeWidth + 30 : 280,
        refElement: this.flowItemNode
      };
      this.arcgisFieldPickList.fields = this.createPickListFields(fl);
      this.arcgisFieldPickList.layer = fl;
      this.arcgisFieldPickList.mapView = view;
      this.arcgisFieldPickList.showFieldInfo = true;
      this.arcgisFieldPickList.showFieldName = false;
      this.arcgisFieldPickList.selectedFields = fieldNames;
      this.arcgisFieldPickList.multiple = true;
      this.arcgisFieldPickList.addEventListener("arcgisFieldPickListDismissed", this.fieldPickListChanges);
      document.body.appendChild(this.arcgisFieldPickList);
      this.flowItemNode.disabled = true;
    };
    this.fieldPickListChanges = (event) => {
      var _a;
      event.stopPropagation();
      const { props, requiredFieldNames } = this;
      const { definitionLayerId } = props;
      const selectedFields = (_a = event.detail) === null || _a === void 0 ? void 0 : _a.selectedFields;
      this.removeFieldsPickList();
      if (selectedFields) {
        const adminLayerInfo = getAdminLayerInfo(definitionLayerId, props);
        const totalFields = (adminLayerInfo === null || adminLayerInfo === void 0 ? void 0 : adminLayerInfo.fields) || getFL(definitionLayerId, props).fields;
        // keep order like in service
        const selectedAndRequiredFields = totalFields
          .filter((field) => requiredFieldNames.indexOf(field.name) > -1 || selectedFields.indexOf(field.name) > -1)
          .map((field) => field.name);
        if (selectedAndRequiredFields.length < totalFields.length) {
          // subset of fields
          addViewLayerProps(definitionLayerId, {
            fields: selectedAndRequiredFields
          }, props);
        }
        else {
          // default; all fields
          let viewLayerProps = getViewLayerProps(definitionLayerId, props);
          if (viewLayerProps) {
            viewLayerProps.fields = undefined;
          }
          sanitizeViewProps(props);
        }
        this.reRender = !this.reRender;
      } // else user hit cancel or close
    };
    this.removeField = (fieldName) => {
      const { props, totalFields } = this;
      const { definitionLayerId } = props;
      let viewLayerProps = getViewLayerProps(definitionLayerId, props);
      if (!viewLayerProps) {
        viewLayerProps = {
          layerId: definitionLayerId
        };
        props.viewProps = props.viewProps || [];
        props.viewProps.push(viewLayerProps);
      }
      if (!viewLayerProps.fields) {
        viewLayerProps.fields = totalFields.map((field) => field.name);
      }
      viewLayerProps.fields.splice(viewLayerProps.fields.indexOf(fieldName), 1);
      this.reRender = !this.reRender;
    };
    this.props = undefined;
    this.status = undefined;
    this.reRender = false;
    this.loading = false;
  }
  closeLayerViewDefinitionPopoversHandler() {
    this.removeFieldsPickList();
  }
  //--------------------------------------------------------------------------
  //
  //  Lifecycle
  //
  //--------------------------------------------------------------------------
  async componentWillLoad() {
    var _a;
    const { props } = this;
    const { definitionLayerId } = props;
    this.fl = getFL(definitionLayerId, props);
    this.adminLayerInfo = getAdminLayerInfo(definitionLayerId, props);
    this.totalFields = ((_a = this.adminLayerInfo) === null || _a === void 0 ? void 0 : _a.fields) || getFL(definitionLayerId, props).fields;
    this.requiredFieldNames = getRequiredFieldNames(props);
  }
  async componentDidLoad() {
    setTimeout(() => requestAnimationFrame(() => { var _a; return (_a = this.flowItemNode) === null || _a === void 0 ? void 0 : _a.setFocus(); }), 200);
  }
  disconnectedCallback() {
    this.removeSketchViewModel();
  }
  // --------------------------------------------------------------------------
  //
  //  Render Methods
  //
  //--------------------------------------------------------------------------
  render() {
    //console.log("render view-definition", propsToString(this.props));
    const { props, status } = this;
    const { definitionLayerId, strings } = props;
    const fl = getFL(definitionLayerId, props);
    const rtl = (0,_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_5__.g)(this.hostElement) === "rtl";
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)(_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.H, { class: "calcite-match-height" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-flow-item", { heading: strings.defineView.definitions, description: fl.title, class: {
        panel: true,
        [_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_5__.C.rtl]: rtl
      }, onCalciteFlowItemBack: this.onBack, ref: (node) => (this.flowItemNode = node) }, this.renderInfo(), this.renderFilter(), this.renderAOI(), this.renderFields()), status === flowStatus.FILTER ? this.renderLayerFilter() : null));
  }
  renderInfo() {
    const { props } = this;
    const { config, strings } = props;
    const { helpBase, helpMap } = config;
    if ((0,_localStorage_f63100ef_js__WEBPACK_IMPORTED_MODULE_8__.g)(_localStorage_f63100ef_js__WEBPACK_IMPORTED_MODULE_8__.l.ARCGIS_COMPONENT_NOTIFICATIONS, _localStorage_f63100ef_js__WEBPACK_IMPORTED_MODULE_8__.a.LAYER_VIEW_DEFINITION_DISMISSED)) {
      return null;
    }
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-notice", { class: CSS$7.notice, open: true, closable: true, scale: "s", width: "auto", onCalciteNoticeClose: () => {
        (0,_localStorage_f63100ef_js__WEBPACK_IMPORTED_MODULE_8__.s)(_localStorage_f63100ef_js__WEBPACK_IMPORTED_MODULE_8__.l.ARCGIS_COMPONENT_NOTIFICATIONS, {
          key: _localStorage_f63100ef_js__WEBPACK_IMPORTED_MODULE_8__.a.LAYER_VIEW_DEFINITION_DISMISSED,
          value: "true"
        });
      } }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { slot: "title" }, strings.defineView.addDefinitions), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { slot: "message" }, strings.defineView.addDefinitionsMsg), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-link", { slot: "link", title: strings.defineView.moreAboutViews, target: "_blank", href: `${helpBase}${helpMap["120002839"]}` }, strings.defineView.moreAboutViews)));
  }
  renderFilter() {
    const { props } = this;
    const { definitionLayerId, strings } = props;
    const viewLayerProps = getViewLayerProps(definitionLayerId, props);
    const rtl = (0,_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_5__.g)(this.hostElement) === "rtl";
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-block", { heading: (viewLayerProps === null || viewLayerProps === void 0 ? void 0 : viewLayerProps.filter) ? strings.defineView.editFilter : strings.defineView.addFilter, collapsible: false, class: CSS$7.filterBlock, tabIndex: 0, onClick: this.goFilter }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-icon", { slot: "icon", icon: "filter", scale: "s" }), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { slot: "control", icon: rtl ? "chevron-left" : "chevron-right", class: CSS$7.filterChevron, scale: "s", text: (viewLayerProps === null || viewLayerProps === void 0 ? void 0 : viewLayerProps.filter) ? strings.defineView.editFilter : strings.defineView.addFilter, ref: (node) => (this.filterActionNode = node) })));
  }
  renderAOI() {
    const { props, fl } = this;
    const { definitionLayerId, strings } = props;
    if (fl.isTable) {
      return null;
    }
    const viewLayerProps = getViewLayerProps(definitionLayerId, props);
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-block", { heading: strings.defineView.areaOfInterest, description: !(viewLayerProps === null || viewLayerProps === void 0 ? void 0 : viewLayerProps.aoi) ? strings.defineView.aoiSubtext : undefined, collapsible: true, onCalciteBlockToggle: () => this.onAOIToggle(), ref: (node) => (this.aoiBlockNode = node) }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-icon", { slot: "icon", icon: "polygon", scale: "s" }), this.renderAOIContent()));
  }
  renderAOIContent() {
    const { props } = this;
    const { definitionLayerId, layerIds, strings } = props;
    const viewLayerProps = getViewLayerProps(definitionLayerId, props);
    const hasAOI = !!(viewLayerProps === null || viewLayerProps === void 0 ? void 0 : viewLayerProps.aoi);
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", null, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action-group", { layout: "grid", class: CSS$7.aoiGroup }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { icon: "polygon", appearance: "solid", alignment: "center", active: false, disabled: hasAOI, scale: "s", text: strings.defineView.aoiSketchPolygonLabel, title: strings.defineView.aoiSketchPolygonLabel, onClick: !hasAOI ? this.onPolygonClick : undefined, ref: (node) => (this.polygonAction = node) }), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { icon: "rectangle", appearance: "solid", alignment: "center", active: false, disabled: hasAOI, scale: "s", text: strings.defineView.aoiSketchRectangleLabel, title: strings.defineView.aoiSketchRectangleLabel, onClick: !hasAOI ? this.onRectangleClick : undefined, ref: (node) => (this.rectangleAction = node) }), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { icon: "trash", appearance: "solid", alignment: "center", scale: "s", disabled: !hasAOI, text: strings.defineView.aoiDeleteLabel, title: strings.defineView.aoiDeleteLabel, onClick: hasAOI ? this.onDeleteAOIClick : undefined })), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS$7.textCenter, ref: (node) => (this.drawLabel = node) }, !hasAOI ? strings.defineView.aoiSelect : strings.defineView.aoiRestart), layerIds.length > 1 ? ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { appearance: "transparent", width: "full", class: CSS$7.aoiButton, onClick: () => this.applyAOIToAll() }, strings.defineView.aoiApplyAll)) : null));
  }
  renderFields() {
    var _a;
    const { props, totalFields } = this;
    const { definitionLayerId, strings } = props;
    const viewLayerProps = getViewLayerProps(definitionLayerId, props);
    const totalFieldCount = totalFields.length;
    const fieldCountView = ((_a = viewLayerProps === null || viewLayerProps === void 0 ? void 0 : viewLayerProps.fields) === null || _a === void 0 ? void 0 : _a.length) || totalFieldCount;
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-block", { heading: strings.defineView.fields, description: `${fieldCountView}/${totalFieldCount}`, collapsible: true }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-icon", { slot: "icon", icon: "feature-details", scale: "s" }), this.renderFieldsContent()));
  }
  renderFieldsContent() {
    const { props, fl, requiredFieldNames, totalFields } = this;
    const { definitionLayerId, strings } = props;
    const viewLayerProps = getViewLayerProps(definitionLayerId, props);
    let fieldsList;
    if (viewLayerProps === null || viewLayerProps === void 0 ? void 0 : viewLayerProps.fields) {
      fieldsList = totalFields.filter((field) => viewLayerProps.fields.indexOf(field.name) > -1 ||
        requiredFieldNames.indexOf(field.name) > -1);
    }
    else {
      fieldsList = totalFields;
    }
    const hasFieldsToSelect = requiredFieldNames.length !== totalFields.length;
    const listItems = fieldsList.map((field) => {
      return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-list-item", { label: field.alias || field.name }, requiredFieldNames.indexOf(field.name) === -1 ? ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { icon: "x", scale: "s", text: strings.general.remove, slot: "actions-end", onClick: () => this.removeField(field.name) })) : null));
    });
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", null, hasFieldsToSelect && ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { class: CSS$7.selectFields, appearance: "outline-fill", round: true, label: strings.defineView.selectFields, scale: "s", width: "full", onClick: () => this.selectFields(fl), ref: (node) => (this.buttonNode = node) }, strings.defineView.selectFields)), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-list", null, listItems)));
  }
  renderLayerFilter() {
    const { props, fl } = this;
    const { view, definitionLayerId } = props;
    const viewLayerProps = getViewLayerProps(definitionLayerId, this.props);
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-filter", { key: `filter-${definitionLayerId}`, view: view, layer: fl, mode: "layer-view", viewFilter: viewLayerProps === null || viewLayerProps === void 0 ? void 0 : viewLayerProps.filter, dismissible: false, hideLayerTitle: false, onArcgisFilterPanelBackClick: this.onBackFilter, onArcgisFilterWhereChange: (event) => this.applyFilter(event.detail) }));
  }
  async applyFilter(where) {
    // apply filter after arcgis-filter component closed
    const { props } = this;
    const { definitionLayerId } = props;
    if (where) {
      addViewLayerProps(definitionLayerId, {
        filter: where
      }, props);
    }
    else {
      // default; no filter
      const viewLayerProps = getViewLayerProps(definitionLayerId, props);
      if (viewLayerProps) {
        viewLayerProps.filter = undefined;
      }
      sanitizeViewProps(props);
    }
    // filter component doesn't remove effect on layerView
    //await applyLayerFilter(where, definitionLayerId, props);
  }
  async onAOIToggle() {
    if (this.aoiBlockNode.open) {
      if (!this.SketchViewModel) {
        this.aoiBlockNode.loading = true;
        const [SketchViewModel, GraphicsLayer, Graphic, Polygon, Extent] = await (0,_loadModules_aaf30bd6_js__WEBPACK_IMPORTED_MODULE_2__.l)([
          "esri/widgets/Sketch/SketchViewModel",
          "esri/layers/GraphicsLayer",
          "esri/Graphic",
          "esri/geometry/Polygon",
          "esri/geometry/Extent"
        ]);
        this.SketchViewModel = SketchViewModel;
        this.GraphicsLayer = GraphicsLayer;
        this.Graphic = Graphic;
        this.Polygon = Polygon;
        this.Extent = Extent;
        this.aoiBlockNode.loading = false;
      }
      this.setupSketchViewModel();
    }
    else {
      this.removeSketchViewModel();
    }
  }
  setupSketchViewModel() {
    const { props, aoiSymbol } = this;
    const { layer, view, definitionLayerId } = props;
    this.defaultAutoOpenEnabled = view.popupEnabled;
    view.popupEnabled = false;
    if (this.graphicsLayer) {
      // done that already
      return;
    }
    this.graphicsLayer = new this.GraphicsLayer();
    view.map.add(this.graphicsLayer);
    const viewLayerProps = getViewLayerProps(definitionLayerId, props);
    if (viewLayerProps === null || viewLayerProps === void 0 ? void 0 : viewLayerProps.aoi) {
      // sketch only wants polygons
      const geom = viewLayerProps.aoi;
      const geometry = geom.rings
        ? this.Polygon.fromJSON(geom)
        : new this.Polygon({
          rings: [
            [geom.xmin, geom.ymin],
            [geom.xmin, geom.ymax],
            [geom.xmax, geom.ymax],
            [geom.xmax, geom.ymin],
            [geom.xmin, geom.ymin]
          ],
          spatialReference: viewLayerProps.aoi.spatialReference
        });
      const graphic = new this.Graphic({
        geometry,
        symbol: aoiSymbol
      });
      this.graphicsLayer.add(graphic);
    }
    this.sketchViewModel = new this.SketchViewModel({
      layer: this.graphicsLayer,
      view,
      polygonSymbol: aoiSymbol,
      updateOnGraphicClick: true
    });
    this.sketchViewModel.on("create", (event) => this.onGraphicCreate(event));
    this.sketchViewModel.on("update", this.onGraphicUpdate);
    const snapping = layer.type === "group"
      ? layer.layers.map((fLayer) => {
        return { layer: fLayer };
      })
      : [{ layer }];
    this.sketchViewModel.snappingOptions.featureSources = snapping;
    this.sketchViewModel.snappingOptions.enabled = true;
  }
  removeSketchViewModel() {
    var _a, _b;
    const { props, defaultAutoOpenEnabled } = this;
    const { view } = props;
    this.graphicsLayer && view.map.remove(this.graphicsLayer);
    (_a = this.graphicsLayer) === null || _a === void 0 ? void 0 : _a.destroy();
    this.graphicsLayer = undefined;
    (_b = this.sketchViewModel) === null || _b === void 0 ? void 0 : _b.destroy();
    this.sketchViewModel = undefined;
    view.popupEnabled = defaultAutoOpenEnabled;
  }
  onGraphicCreate(event) {
    const { props } = this;
    const { definitionLayerId, strings } = props;
    if (event.state === "start" && this.polygonAction.active) {
      this.drawLabel.innerHTML = strings.defineView.aoiPolygonEnd;
    }
    if (event.state === "complete") {
      const sketchGraphic = event.graphic;
      const extent = sketchGraphic.geometry.extent;
      addViewLayerProps(definitionLayerId, {
        aoi: !this.polygonAction.active ? extent.toJSON() : sketchGraphic.geometry.toJSON()
      }, props);
      applyLayerAOI(sketchGraphic.geometry, definitionLayerId, props);
      //console.log("create complete", propsToString(props));
      this.drawLabel.innerHTML = strings.defineView.aoiRestart;
      this.polygonAction.active = false;
      this.rectangleAction.active = false;
      this.polygonAction.disabled = true;
      this.rectangleAction.disabled = true;
      this.aoiBlockNode.description = undefined;
      this.reRender = !this.reRender;
    }
  }
  applyAOIToAll() {
    const { props } = this;
    const { definitionLayerId, layer } = props;
    if (layer.type !== "group") {
      return;
    }
    const viewLayerProps = getViewLayerProps(definitionLayerId, props);
    layer.layers.map((flayer) => {
      if (flayer.layerId !== definitionLayerId) {
        if (viewLayerProps === null || viewLayerProps === void 0 ? void 0 : viewLayerProps.aoi) {
          addViewLayerProps(flayer.layerId, {
            aoi: JSON.parse(JSON.stringify(viewLayerProps.aoi))
          }, props);
        }
        else {
          const viewLayerProps2 = getViewLayerProps(flayer.layerId, props);
          if (viewLayerProps2) {
            viewLayerProps2.aoi = undefined;
          }
          sanitizeViewProps(props);
        }
        if (viewLayerProps === null || viewLayerProps === void 0 ? void 0 : viewLayerProps.aoi) {
          const geometry = viewLayerProps.aoi.rings
            ? this.Polygon.fromJSON(viewLayerProps.aoi)
            : this.Extent.fromJSON(viewLayerProps.aoi);
          applyLayerAOI(geometry, flayer.layerId, props);
        }
        else {
          applyLayerAOI(undefined, flayer.layerId, props);
        }
      }
    });
  }
  createPickListFields(fl) {
    const { requiredFieldNames, props } = this;
    const adminLayerInfo = getAdminLayerInfo(fl.layerId, props);
    const totalFields = (adminLayerInfo === null || adminLayerInfo === void 0 ? void 0 : adminLayerInfo.fields) || getFL(fl.layerId, props).fields;
    return totalFields
      .filter((field) => requiredFieldNames.indexOf(field.name) === -1)
      .map((field) => {
      return {
        name: field.name,
        alias: field.alias || field.name,
        type: field.type
      };
    });
  }
  removeFieldsPickList() {
    this.flowItemNode.disabled = false;
    if (this.arcgisFieldPickList) {
      document.body.removeChild(this.arcgisFieldPickList);
      this.arcgisFieldPickList = null;
      setTimeout(() => {
        this.buttonNode.setFocus();
      }, 1);
    }
  }
  get hostElement() { return (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.d)(this); }
};
ArcgisLayerViewDefinition.style = arcgisLayerViewDefinitionCss;

var joinFlowStatus;
(function (joinFlowStatus) {
  joinFlowStatus[joinFlowStatus["ERROR"] = 0] = "ERROR";
  joinFlowStatus[joinFlowStatus["LOADING"] = 1] = "LOADING";
  joinFlowStatus[joinFlowStatus["TARGET_SELECTION"] = 2] = "TARGET_SELECTION";
  joinFlowStatus[joinFlowStatus["ADD_SELECTION"] = 3] = "ADD_SELECTION";
  joinFlowStatus[joinFlowStatus["BROWSE_LAYER"] = 4] = "BROWSE_LAYER";
  joinFlowStatus[joinFlowStatus["CONFIG"] = 5] = "CONFIG";
  joinFlowStatus[joinFlowStatus["CREATE"] = 6] = "CREATE";
})(joinFlowStatus || (joinFlowStatus = {}));
function getFieldAlias(layer, fieldName) {
  var _a;
  const { fields, popupTemplate } = layer;
  const fieldInfos = popupTemplate === null || popupTemplate === void 0 ? void 0 : popupTemplate.fieldInfos;
  const field = fields.find((field) => fieldName === field.name);
  return ((field && ((_a = fieldInfos === null || fieldInfos === void 0 ? void 0 : fieldInfos.find((fieldInfo) => fieldInfo.fieldName === field.name)) === null || _a === void 0 ? void 0 : _a.label)) ||
    (field === null || field === void 0 ? void 0 : field.alias) ||
    fieldName);
}
function getFieldType(layer, fieldName) {
  const { fields } = layer;
  const field = fields.find((field) => fieldName === field.name);
  return field === null || field === void 0 ? void 0 : field.type;
}
function getLayerType(layer, props) {
  const { strings } = props;
  return layer.isTable
    ? strings.general.table
    : layer.geometryType === "point" || layer.geometryType === "multipoint"
      ? strings.join.pointLayer
      : layer.geometryType === "polyline"
        ? strings.join.polylineLayer
        : layer.geometryType === "polygon"
          ? strings.join.polygonLayer
          : "";
}
function hasOBAC(layer) {
  var _a, _b;
  // Only if one of allowOthersToQuery/allowAnonymousToQuery is explicitly set to false do we block join.
  // If it's true or not there we don't block join
  return (layer.sourceJSON.ownershipBasedAccessControlForFeatures &&
    (((_a = layer.sourceJSON.ownershipBasedAccessControlForFeatures) === null || _a === void 0 ? void 0 : _a.allowAnonymousToQuery) === false ||
      ((_b = layer.sourceJSON.ownershipBasedAccessControlForFeatures) === null || _b === void 0 ? void 0 : _b.allowOthersToQuery) === false));
}

/**
 * get a suggested title for the joined view
 * @param props - LayerViewJoinProps
 */
async function getSuggestedTitleForJoin(props) {
  var _a, _b;
  const { targetItem, targetLayer, strings, modules } = props;
  const { esriRequest } = modules;
  const relatedUrl = `${targetItem.itemUrl}/relatedItems`;
  const relatedContent = {
    relationshipType: "Service2Service",
    direction: "forward"
  };
  const result = await esriRequest(relatedUrl, {
    query: Object.assign(Object.assign({}, relatedContent), { f: "json", token: targetLayer.portalItem.portal.credential.token }),
    method: "post",
    responseType: "json"
  });
  // check with spaces and underscores
  const viewItems = ((_b = (_a = result === null || result === void 0 ? void 0 : result.data) === null || _a === void 0 ? void 0 : _a.relatedItems) === null || _b === void 0 ? void 0 : _b.filter((item) => item.type === "Feature Service" &&
    (item.title.indexOf(targetItem.title) > -1 ||
      item.title.indexOf(targetItem.title.replace(/ /g, "_")) > -1 ||
      item.title.replace(/ /g, "_").indexOf(targetItem.title) > -1))) || [];
  return (strings.join.joinFeaturesTo.replace("${name}", targetItem.title) +
    `${viewItems.length ? ` ${viewItems.length + 1}` : ``} ${strings.createView.view}`);
}
/**
 * Creates join layer view
 * @param props - LayerViewJoinProps
 * @param newItemProps - user input (NewItemProps)
 */
async function createJoinView(props, newItemProps) {
  const { targetItem, targetLayer, targetLayerId, addLayer, addLayerId } = props;
  const isPortal = targetItem.portal.isPortal;
  const timeStamp = Date.now();
  const targetFL = (targetLayer.type === "group"
    ? getLayersAndTables(targetLayer).find((lyr) => lyr.layerId === targetLayerId)
    : targetLayer);
  const addFL = (addLayer.type === "group"
    ? getLayersAndTables(addLayer).find((lyr) => lyr.layerId === addLayerId)
    : addLayer);
  try {
    await getAdminServiceInfo(props);
    if (!isPortal) {
      await createIndexes(props);
    }
    const createServiceResponse = await createJoinService(props, newItemProps);
    const processProps = { newItemProps, createServiceResponse, timeStamp, targetFL, addFL };
    await addToDefinitionStatsTable(props, processProps);
    await addToDefinitionAttributeJoin(props, processProps);
    await joinItemUpdate(props, processProps);
    return createServiceResponse.itemId;
  }
  catch (e) {
    return new Promise((_, reject) => {
      reject(new Error("createJoinView failed"));
    });
  }
}
async function createJoinService(props, newItemProps) {
  const { targetItem, modules } = props;
  const { esriRequest } = modules;
  const { folder } = newItemProps;
  const isOwnerFolder = !folder || !folder.id || folder.id === targetItem.owner;
  const portal = targetItem.portal;
  const createServiceUrl = `${portal.restUrl}/content/users/${targetItem.owner}${!isOwnerFolder ? `/${folder.id}` : ""}/createService`;
  // not sure why we need to send all this in...
  const createParams = {
    serviceDescription: "",
    hasVersionedData: false,
    supportsDisconnectedEditing: false,
    hasStaticData: true,
    maxRecordCount: 2000,
    supportedQueryFormats: "JSON",
    capabilities: "Query",
    description: "",
    copyrightText: "",
    allowGeometryUpdates: false,
    // this causes issues in result layer when used in network tools "units":"esriMeters",
    syncEnabled: false,
    editorTrackingInfo: {
      enableEditorTracking: false,
      enableOwnershipAccessControl: false,
      allowOthersToUpdate: true,
      allowOthersToDelete: true
    },
    xssPreventionInfo: {
      xssPreventionEnabled: true,
      xssPreventionRule: "InputOnly",
      xssInputRule: "rejectInvalid"
    },
    tables: [],
    name: newItemProps.title.replace(/ /g, "_")
  };
  if (portal.isPortal) {
    const dataSourceType = await getDataSourceType(props);
    if (dataSourceType) {
      createParams.options = { dataSourceType };
    }
  }
  let createServiceContent = {
    createParameters: JSON.stringify(createParams),
    outputType: "featureService"
  };
  try {
    const response = await esriRequest(createServiceUrl, {
      query: Object.assign(Object.assign({}, createServiceContent), { f: "json", isView: true, token: portal.credential.token }),
      method: "post",
      responseType: "json"
    });
    return response.data;
  }
  catch (e) {
    return new Promise((_, reject) => {
      reject(new Error("create service failed"));
    });
  }
}
async function addToDefinitionStatsTable(props, processProps) {
  const { createServiceResponse, addFL, timeStamp } = processProps;
  const { addLayerId, joinOperation, attributeRelationships } = props;
  if (joinOperation.type !== "one-to-one" || joinOperation.matchType !== "summarize") {
    return;
  }
  try {
    const adminUrl = createServiceResponse.serviceurl.replace("rest/services", "rest/admin/services");
    const attributeFields = attributeRelationships.map((rel) => {
      var _a;
      return {
        name: rel.addFieldName,
        alias: ((_a = addFL.fields.find((field) => field.name === rel.addFieldName)) === null || _a === void 0 ? void 0 : _a.alias) || rel.addFieldName,
        source: rel.addFieldName
      };
    });
    const summarizeFields = [];
    joinOperation.statisticsFields.forEach((statsField) => {
      statsField.types.forEach((statsType) => {
        const type = statsType.toLowerCase();
        summarizeFields.push({
          name: `${statsField.fieldName}_${type}`,
          alias: `${statsField.fieldName}_${type}`,
          source: statsField.fieldName,
          statisticType: type === "mean" ? "avg" : type
        });
      });
    });
    const json = {
      layers: [
        {
          name: `${getSourceServiceName(addFL.url, props)}_StatsTable`,
          description: "tablestatsjoin",
          adminLayerInfo: {
            viewLayerDefinition: {
              table: {
                materialized: false,
                name: `${getSourceServiceName(addFL.url, props)}_${timeStamp}_StatsTable`,
                sourceServiceName: getSourceServiceName(addFL.url, props),
                sourceLayerId: addLayerId,
                sourceLayerFields: [
                  ...attributeFields,
                  {
                    name: "join_count",
                    alias: "join_count",
                    source: joinOperation.statisticsFields[0].fieldName,
                    statisticType: "count"
                  },
                  ...summarizeFields
                ],
                groupBy: attributeRelationships.map((rel) => rel.addFieldName).join(",")
              }
            }
          }
        }
      ]
    };
    await addToDefinitionRequest(`${adminUrl}/addToDefinition`, json, props);
    return new Promise((resolve) => {
      resolve();
    });
  }
  catch (e) {
    return new Promise((_, reject) => {
      reject(new Error("addToDefinition StatsTable failed"));
    });
  }
}
async function addToDefinitionAttributeJoin(props, processProps) {
  const { createServiceResponse, newItemProps, targetFL, addFL, timeStamp } = processProps;
  try {
    const adminUrl = createServiceResponse.serviceurl.replace("rest/services", "rest/admin/services");
    const json = getAttributeJoinJSON(props, newItemProps, targetFL, addFL, timeStamp);
    await addToDefinitionRequest(`${adminUrl}/addToDefinition`, json, props);
    return new Promise((resolve) => {
      resolve();
    });
  }
  catch (e) {
    return new Promise((_, reject) => {
      reject(new Error("addToDefinition AttributeJoin failed"));
    });
  }
}
function getAttributeJoinJSON(props, newItemProps, targetFL, addFL, timeStamp) {
  const { targetLayerId, addLayerId, joinOperation, attributeRelationships, adminServiceInfo } = props;
  const attributeFields = attributeRelationships.map((rel) => {
    var _a;
    return {
      name: rel.addFieldName,
      alias: ((_a = addFL.fields.find((field) => field.name === rel.addFieldName)) === null || _a === void 0 ? void 0 : _a.alias) || rel.addFieldName,
      source: rel.addFieldName
    };
  });
  let summarizeFields;
  if (joinOperation.type === "one-to-one" && joinOperation.matchType === "summarize") {
    summarizeFields = [];
    joinOperation.statisticsFields.forEach((statsField) => {
      statsField.types.forEach((statsType) => {
        const type = statsType.toLowerCase();
        summarizeFields.push({
          name: `${statsField.fieldName}_${type}`,
          alias: `${statsField.fieldName}_${type}`,
          source: `${statsField.fieldName}_${type}`
        });
      });
    });
  }
  const json = {};
  json.name = newItemProps.title.replace(/ /g, "_");
  json.displayField = "";
  json.description = "AttributeJoin";
  json.adminLayerInfo = {
    viewLayerDefinition: {
      table: {
        name: `${getSourceServiceName(targetFL.url, props)}_${timeStamp}_target`,
        sourceServiceName: getSourceServiceName(targetFL.url, props),
        sourceLayerId: targetLayerId,
        sourceLayerFields: targetFL.fields
          .filter((field) => field.type !== "oid")
          .map((field) => {
          return {
            name: field.name,
            alias: field.alias,
            source: field.name
          };
        }),
        relatedTables: [
          joinOperation.type === "one-to-one" && joinOperation.matchType === "summarize"
            ? {
              name: `${getSourceServiceName(addFL.url, props)}_StatsTable`,
              sourceServiceName: newItemProps.title.replace(/ /g, "_"),
              sourceLayerId: 0,
              sourceLayerFields: [
                ...attributeFields.filter((attrField) => !attributeRelationships.some((rel) => attrField.name === rel.addFieldName)),
                {
                  name: "join_count",
                  alias: "join_count",
                  source: "join_count"
                },
                ...summarizeFields
              ],
              type: joinOperation.joinType,
              parentKeyFields: attributeRelationships.map((rel) => rel.targetFieldName),
              keyFields: attributeRelationships.map((rel) => rel.addFieldName)
            }
            : {
              name: `${getSourceServiceName(addFL.url, props)}_${timeStamp}_join`,
              sourceServiceName: getSourceServiceName(addFL.url, props),
              sourceLayerId: addLayerId,
              sourceLayerFields: addFL.fields
                .filter((addField) => addField.type !== "oid")
                .map((addField) => {
                const isTaken = targetFL.fields.find((targetField) => targetField.name === addField.name);
                return {
                  name: isTaken ? `${addField.name}_${timeStamp}` : addField.name,
                  alias: addField.alias,
                  source: addField.name
                };
              }),
              type: joinOperation.joinType,
              parentKeyFields: attributeRelationships.map((rel) => rel.targetFieldName),
              keyFields: attributeRelationships.map((rel) => rel.addFieldName),
              topFilter: joinOperation.type === "one-to-one" && joinOperation.matchType === "first"
                ? {
                  groupByFields: attributeRelationships
                    .map((rel) => rel.addFieldName)
                    .join(","),
                  orderByFields: `${joinOperation.sortByFieldName} ${joinOperation.sortOrder}`,
                  topCount: 1
                }
                : undefined
            }
        ],
        materialized: false
      }
    },
    geometryField: targetFL.isTable
      ? null
      : {
        name: `${getSourceServiceName(targetFL.url, props)}_${timeStamp}_target.${adminServiceInfo.layers.find((lyr) => lyr.id === targetLayerId).adminLayerInfo.geometryField.name}`
      }
  };
  /* not sure why we send all via layers...
  let layers, tables;
  if (targetFL.isTable) {
    tables = [json];
  } else {
    layers = [json];
  }

  return {
    layers: layers,
    tables: tables
  }; */
  return {
    layers: [json]
  };
}
async function addToDefinitionRequest(addToDefUrl, json, props, retry = false) {
  const { modules } = props;
  const { esriRequest, IdentityManager } = modules;
  // addToDefUrl same server as targetLayer
  const credential = IdentityManager.findCredential(addToDefUrl);
  const addToDefContent = {
    addToDefinition: JSON.stringify(json)
  };
  try {
    await esriRequest(addToDefUrl, {
      query: Object.assign(Object.assign({}, addToDefContent), { f: "json", token: credential.token }),
      method: "post",
      responseType: "json"
    });
    return new Promise((resolve) => {
      resolve();
    });
  }
  catch (e) {
    if (!retry) {
      // in case it's just a fluke
      return addToDefinitionRequest(addToDefUrl, json, props, true);
    }
    return new Promise((_, reject) => {
      reject(new Error("addToDefinition request failed"));
    });
  }
}
function getSourceServiceName(url, props) {
  const { targetItem } = props;
  const { portal } = targetItem;
  const pos = url.indexOf("/services/") + "/services/".length;
  var serviceName = url.substring(pos, url.indexOf("/FeatureServer", pos));
  if (portal.isPortal) {
    serviceName = serviceName.replace("Hosted/", "");
  }
  return serviceName;
}
async function joinItemUpdate(props, processProps) {
  var _a, _b;
  const { createServiceResponse, newItemProps } = processProps;
  const { targetItem, modules } = props;
  const { esriRequest } = modules;
  const portal = targetItem.portal;
  const updateUrl = `${portal.restUrl}/content/users/${targetItem.owner}/items/${createServiceResponse.itemId}/update`;
  // need to send some info again
  const updateContent = {
    title: newItemProps.title,
    tags: ((_a = newItemProps.tags) === null || _a === void 0 ? void 0 : _a.length) ? newItemProps.tags.toString() : undefined,
    snippet: newItemProps.summary,
    categories: (_b = newItemProps.categories) === null || _b === void 0 ? void 0 : _b.join(",")
  };
  if (portal.isPortal) {
    updateContent.typeKeywords = "Multi Services View";
  }
  try {
    return await esriRequest(updateUrl, {
      query: Object.assign(Object.assign({}, updateContent), { f: "json", token: portal.credential.token }),
      method: "post",
      responseType: "json"
    });
  }
  catch (e) {
    return new Promise((_, reject) => {
      reject(new Error("item update request failed"));
    });
  }
}
async function getDataSourceType(props) {
  var _a, _b, _c, _d;
  await getAdminServiceInfo(props);
  const { adminServiceInfo } = props;
  const dataSource = ((_b = (_a = adminServiceInfo === null || adminServiceInfo === void 0 ? void 0 : adminServiceInfo.adminServiceInfo) === null || _a === void 0 ? void 0 : _a.database) === null || _b === void 0 ? void 0 : _b.datasource) || {};
  const dataSourceType = ((_c = dataSource === null || dataSource === void 0 ? void 0 : dataSource.name) === null || _c === void 0 ? void 0 : _c.indexOf("/nosqlDatabases")) > -1
    ? "spatiotemporal"
    : ((_d = dataSource === null || dataSource === void 0 ? void 0 : dataSource.name) === null || _d === void 0 ? void 0 : _d.indexOf("/enterpriseDatabases")) > -1
      ? "relational"
      : null;
  return dataSourceType;
}
async function getAdminServiceInfo(props, noCache) {
  const { targetLayer, adminServiceInfo, modules } = props;
  const { IdentityManager, esriRequest } = modules;
  if (adminServiceInfo) {
    return;
  }
  const serviceUrl = targetLayer.portalItem.url;
  let adminUrl = serviceUrl.replace("/rest/services", "/rest/admin/services");
  if (noCache) {
    adminUrl += `${adminUrl.indexOf("?") > -1 ? "&" : "?"}_ts=${new Date().getTime()}`;
  }
  try {
    await IdentityManager.getCredential(adminUrl);
    const response = await esriRequest(adminUrl, {
      query: { f: "json" }
    });
    props.adminServiceInfo = response.data;
  }
  catch (e) {
    return new Promise((_, reject) => {
      reject(new Error("could not get admin info"));
    });
  }
}
async function createIndexes(props) {
  const { targetLayer, targetLayerId, addLayer, addLayerId, attributeRelationships } = props;
  let fl = targetLayer.type === "group"
    ? getLayersAndTables(targetLayer).find((lyr) => lyr.layerId === targetLayerId)
    : targetLayer;
  let fieldNames = attributeRelationships.map((rel) => rel.targetFieldName);
  await createIndexesForLayer(fl, fieldNames, props);
  fl =
    addLayer.type === "group"
      ? getLayersAndTables(addLayer).find((lyr) => lyr.layerId === addLayerId)
      : addLayer;
  fieldNames = attributeRelationships.map((rel) => rel.addFieldName);
  await createIndexesForLayer(fl, fieldNames, props);
}
async function createIndexesForLayer(fl, fieldNames, props) {
  const json = {
    indexes: []
  };
  fl.sourceJSON.indexes = fl.sourceJSON.indexes || [];
  fieldNames.forEach((fieldName) => {
    if (!fl.sourceJSON.indexes.some((index) => index.fields === fieldName)) {
      // index doesn't exist yet
      json.indexes.push({
        name: `${fieldName}_Index`,
        fields: fieldName,
        isUnique: false,
        isAscending: true,
        description: `${fieldName}_Index`
      });
    }
  });
  if (json.indexes.length) {
    await executeCreateIndexes(json, fl, props);
  }
}
async function executeCreateIndexes(json, fl, props) {
  var _a;
  const { targetItem, modules } = props;
  const { IdentityManager } = modules;
  const adminUrl = fl.url.replace("/rest/services", "/rest/admin/services");
  const url = `${adminUrl}/${fl.layerId}/addToDefinition`;
  const credential = IdentityManager.findCredential(url);
  const isPortal = targetItem.portal.isPortal;
  const content = {
    f: "json",
    addToDefinition: JSON.stringify(json),
    async: !isPortal,
    token: credential.token
  };
  const result = await modules.esriRequest(url, {
    query: content,
    method: "post"
  });
  if (isPortal) {
    fl.sourceJSON.indexes = fl.sourceJSON.indexes || [];
    fl.sourceJSON.indexes = fl.sourceJSON.indexes.concat(json.indexes);
  }
  else {
    try {
      await pollForStatus((_a = result === null || result === void 0 ? void 0 : result.data) === null || _a === void 0 ? void 0 : _a.statusURL, {
        f: "json",
        token: credential.token
      }, props);
      fl.sourceJSON.indexes = fl.sourceJSON.indexes || [];
      fl.sourceJSON.indexes = fl.sourceJSON.indexes.concat(json.indexes);
    }
    catch (e) {
      // not a big problem if it didn't work
    }
  }
}
const pollForStatus = async (url, params, props) => {
  var _a;
  const { modules } = props;
  if (!url) {
    throw new Error("pollForStatus: no status URL");
  }
  const pendingStatuses = ["processing", "partial", "Pending", "InProgress"];
  const successStatuses = ["completed", "Completed"];
  // Keep polling status until either completed or failed
  try {
    // Do failures report as success (status 200)? May need to manually throw error on status check failure
    const statusResponse = await modules.esriRequest(url, { query: params });
    const status = (_a = statusResponse === null || statusResponse === void 0 ? void 0 : statusResponse.data) === null || _a === void 0 ? void 0 : _a.status;
    if (pendingStatuses.includes(status)) {
      await (0,_functional_c82f5ab9_js__WEBPACK_IMPORTED_MODULE_4__.t)(500);
      return pollForStatus(url, params, props);
    }
    else if (successStatuses.includes(status)) {
      return statusResponse;
    }
    else {
      throw statusResponse;
    }
  }
  catch (e) {
    console.error(e);
    throw e;
  }
};

const arcgisLayerViewJoinCss = ":host{height:100%}.panel{height:100%}.footer{width:100%}.error-content{margin:0.5rem}";

const ArcgisLayerView = class {
  constructor(hostRef) {
    (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.r)(this, hostRef);
    this.arcgisLayerViewJoinCancel = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "arcgisLayerViewJoinCancel", 7);
    this.arcgisLayerViewJoinTableClick = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "arcgisLayerViewJoinTableClick", 7);
    this.arcgisLayerViewJoinStepChange = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "arcgisLayerViewJoinStepChange", 7);
    this.arcgisLayerViewJoinCreated = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "arcgisLayerViewJoinCreated", 7);
    this.status = joinFlowStatus.LOADING;
    // --------------------------------------------------------------------------
    //
    //  Private methods
    //
    // --------------------------------------------------------------------------
    this.goCancel = () => {
      this.arcgisLayerViewJoinCancel.emit();
    };
    this.view = undefined;
    this.itemId = undefined;
    this.config = undefined;
    this.showTableOption = false;
  }
  arcgisLayerViewStatusHandler(event) {
    const { detail } = event;
    this.status = detail.status;
    /* if (detail.layerIds?.length) {
      props.layerIds = [...detail.layerIds];
    } */
    if (this.status === joinFlowStatus.TARGET_SELECTION) {
      //props.sourceItemId = props.layerItem.id;
      this.arcgisLayerViewJoinStepChange.emit(1);
    }
    else if (this.status === joinFlowStatus.ADD_SELECTION) {
      this.arcgisLayerViewJoinStepChange.emit(2);
    }
    else if (this.status === joinFlowStatus.CONFIG) {
      this.arcgisLayerViewJoinStepChange.emit(3);
    }
    else if (this.status === joinFlowStatus.CREATE) {
      this.arcgisLayerViewJoinStepChange.emit(4);
    }
    (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.hostElement);
  }
  async arcgisLayerViewJoinCreateDoneHandler(event) {
    this.arcgisLayerViewJoinCreated.emit(event.detail);
  }
  arcgisLayerViewJoinCreateCancelHandler() {
    this.arcgisLayerViewJoinCancel.emit();
  }
  //--------------------------------------------------------------------------
  //
  //  Public Methods
  //
  //--------------------------------------------------------------------------
  /*
   * Got to a certain step. If successful it will return true.
   * If it's not possible, because some user input is missing, then it will return false.
   */
  async setStep(step) {
    var _a, _b;
    const { props } = this;
    const { targetLayerId, addLayerId, attributeRelationships, joinOperation } = props;
    const addSelectionPossible = (0,_commonFunctions_5262b094_js__WEBPACK_IMPORTED_MODULE_3__.i)(targetLayerId);
    const configPossible = (0,_commonFunctions_5262b094_js__WEBPACK_IMPORTED_MODULE_3__.i)(addLayerId);
    const createPossible = (attributeRelationships === null || attributeRelationships === void 0 ? void 0 : attributeRelationships.find((rel) => rel.targetFieldName && rel.addFieldName)) &&
      joinOperation &&
      ((joinOperation.matchType === "first" &&
        joinOperation.sortByFieldName &&
        joinOperation.sortOrder) ||
        (joinOperation.matchType === "summarize" &&
          ((_a = joinOperation.statisticsFields) === null || _a === void 0 ? void 0 : _a.length) &&
          ((_b = joinOperation.statisticsFields) === null || _b === void 0 ? void 0 : _b[0].fieldName)));
    // close popovers
    document.body.querySelectorAll(".js-app-flyout").forEach((node) => {
      document.body.removeChild(node);
    });
    switch (step) {
      case 1:
        this.status = joinFlowStatus.TARGET_SELECTION;
        (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.hostElement);
        return new Promise((resolve) => resolve(true));
      case 2:
        if (addSelectionPossible) {
          this.status = joinFlowStatus.ADD_SELECTION;
          (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.hostElement);
          return new Promise((resolve) => resolve(true));
        }
        break;
      case 3:
        if (configPossible) {
          this.status = joinFlowStatus.CONFIG;
          (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.hostElement);
          return new Promise((resolve) => resolve(true));
        }
        break;
      case 4:
        if (createPossible) {
          this.status = joinFlowStatus.CREATE;
          (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.hostElement);
          return new Promise((resolve) => resolve(true));
        }
        break;
    }
    return new Promise((resolve) => resolve(false));
  }
  //--------------------------------------------------------------------------
  //
  //  Lifecycle
  //
  //--------------------------------------------------------------------------
  async componentWillLoad() {
    var _a, _b, _c, _d;
    const { itemId, view, showTableOption, config } = this;
    const [strings] = await (0,_locale_13e00a75_js__WEBPACK_IMPORTED_MODULE_1__.g)(this.hostElement, "arcgis-layer-view");
    this.strings = strings;
    this.props = { config, view, itemId, showTableOption, strings, modules: {} };
    let { props } = this;
    if (!itemId) {
      console.error("itemId is a required property.");
      return;
    }
    try {
      const [PortalItem, Layer, Extent, projection, Polygon, esriRequest, IdentityManager] = await (0,_loadModules_aaf30bd6_js__WEBPACK_IMPORTED_MODULE_2__.l)([
        "esri/portal/PortalItem",
        "esri/layers/Layer",
        "esri/geometry/Extent",
        "esri/geometry/projection",
        "esri/geometry/Polygon",
        "esri/request",
        "esri/identity/IdentityManager"
      ]);
      props.modules = {
        PortalItem,
        projection,
        Polygon,
        Extent,
        Layer,
        esriRequest,
        IdentityManager
      };
      const targetItem = new PortalItem({
        id: itemId
      });
      await targetItem.load();
      props.targetItemOwner = targetItem.portal.user;
      if (targetItem.portal.user.username !== targetItem.owner) {
        // get user info of owner
        await esriRequest(`${targetItem.portal.restUrl}/community/users/${targetItem.owner}`, {
          query: { f: "json" }
        }).then((userResult) => {
          if (userResult === null || userResult === void 0 ? void 0 : userResult.data) {
            props.targetItemOwner = userResult.data;
          }
        });
      }
      if (targetItem.type !== "Feature Service") {
        console.error("Only Feature Service items are allowed.");
        this.status = joinFlowStatus.ERROR;
        return;
      }
      if (((_a = targetItem.typeKeywords) === null || _a === void 0 ? void 0 : _a.indexOf("Hosted Service")) === -1) {
        console.error("Only hosted Feature Service items are allowed.");
        this.status = joinFlowStatus.ERROR;
        return;
      }
      if (targetItem.portal.user.username !== targetItem.owner &&
        targetItem.itemControl !== "admin") {
        console.error("Only owners and admins are allowed.");
        this.status = joinFlowStatus.ERROR;
        return;
      }
      if (((_b = targetItem.typeKeywords) === null || _b === void 0 ? void 0 : _b.indexOf("View Service")) > -1) {
        console.error("View items are not allowed.");
        this.status = joinFlowStatus.ERROR;
        return;
      }
      if ((targetItem === null || targetItem === void 0 ? void 0 : targetItem.typeKeywords.indexOf("IoTFeatureLayer")) > -1) {
        console.error("Velocity items are not allowed.");
        this.status = joinFlowStatus.ERROR;
        return;
      }
      let gcsExtent = targetItem.extent;
      if (!gcsExtent) {
        gcsExtent = new Extent({
          xmin: -180,
          ymin: -90,
          xmax: 180,
          ymax: 90,
          spatialReference: 4326
        });
      }
      if (view.spatialReference.wkid !== 4326) {
        await projection.load();
        const extent = projection.project(gcsExtent, view.spatialReference);
        view.goTo(extent.expand(1.1));
      }
      else {
        view.goTo(gcsExtent.expand(1.1));
      }
      const targetLayer = await Layer.fromPortalItem({
        portalItem: targetItem
      });
      //console.log("**targetLayer**", targetLayer);
      //console.log("**targetItem**", targetItem);
      if (targetLayer.type === "group") {
        // group layer has no layers or tables at this point
        // loadAll() loads layers and tables (at v4.23)
        await targetLayer.loadAll();
        if ((_c = targetLayer.layers) === null || _c === void 0 ? void 0 : _c.length) {
          // has at least one spatial layer
          view.map.add(targetLayer);
        }
        // default popups
        (_d = targetLayer.layers) === null || _d === void 0 ? void 0 : _d.forEach((lyr) => {
          if (!lyr.popupTemplate && lyr.popupEnabled) {
            lyr.popupTemplate = lyr.createPopupTemplate();
          }
        });
      }
      else {
        await targetLayer.load();
        if (!targetLayer.isTable) {
          view.map.add(targetLayer);
        }
        // default popup
        targetLayer.popupTemplate = targetLayer.createPopupTemplate();
      }
      if (targetItem.portal.isPortal) {
        // OBAC not supported in Enterprise
        if (targetLayer.type === "group") {
          if (!getLayersAndTables(targetLayer).find((fl) => !hasOBAC(fl))) {
            console.error("Layers with Ownership-Based Access Control are not allowed.");
          }
        }
        else if (hasOBAC(targetLayer)) {
          console.error("Layers with Ownership-Based Access Control are not allowed.");
        }
      }
      props.targetItem = targetItem;
      props.targetLayer = targetLayer;
      this.status = joinFlowStatus.TARGET_SELECTION;
    }
    catch (e) {
      console.error(e);
      this.status = joinFlowStatus.ERROR;
    }
  }
  async componentDidLoad() {
    this.arcgisLayerViewJoinStepChange.emit(1);
  }
  disconnectedCallback() {
    const { props } = this;
    const { view, targetLayer, addLayer } = props;
    view.map.remove(targetLayer);
    view.map.remove(addLayer);
  }
  // --------------------------------------------------------------------------
  //
  //  Render Methods
  //
  //--------------------------------------------------------------------------
  render() {
    //console.log("render", "status:", this.status);
    const { status } = this;
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)(_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.H, null, status === joinFlowStatus.ERROR ? this.renderError() : null, status === joinFlowStatus.LOADING ? this.renderLoading() : null, [joinFlowStatus.TARGET_SELECTION].includes(status)
      ? this.renderTargetLayerSelection()
      : null, [joinFlowStatus.ADD_SELECTION, joinFlowStatus.BROWSE_LAYER].includes(status)
      ? this.renderAddLayerSelection()
      : null, [joinFlowStatus.CONFIG].includes(status) ? this.renderConfig() : null, status === joinFlowStatus.CREATE ? this.renderCreateJoin() : null));
  }
  renderError() {
    const { props } = this;
    const { targetItem, strings } = props;
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-flow-item", { loading: false, heading: (targetItem === null || targetItem === void 0 ? void 0 : targetItem.title) || strings.msg.error, description: (targetItem === null || targetItem === void 0 ? void 0 : targetItem.title) ? strings.join.targetLayer : undefined, class: CSS$9.panel, ref: (node) => (this.flowItemNode = node) }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS$9.errorContent }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-notice", { scale: "s", width: "full", open: true, icon: "exclamation-mark-triangle", kind: "danger" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { slot: "title" }, strings.msg.error), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { slot: "message" }, strings.msg.initFailed))), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { slot: "footer", class: CSS$9.footer }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { slot: "footer", onClick: this.goCancel, appearance: "transparent", width: "full" }, strings.general.cancel))));
  }
  renderLoading() {
    const { props } = this;
    const { targetItem, strings } = props;
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-flow-item", { loading: true, heading: targetItem === null || targetItem === void 0 ? void 0 : targetItem.title, description: strings.join.targetLayer, class: CSS$9.panel, ref: (node) => (this.flowItemNode = node) }));
  }
  renderTargetLayerSelection() {
    const { props, status } = this;
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-layer-view-join-target-selection", { key: `target-selection-${status}`, props: props, status: status }));
  }
  renderAddLayerSelection() {
    const { props, status } = this;
    const { addItem } = props;
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-layer-view-join-add-selection", { key: `add-${status}-${addItem === null || addItem === void 0 ? void 0 : addItem.id}`, props: props, status: status }));
  }
  renderConfig() {
    const { props, status } = this;
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-layer-view-join-config", { key: `create-${status}`, props: props, onArcgisLayerViewJoinConfigTableClick: (event) => this.arcgisLayerViewJoinTableClick.emit(event.detail) }));
  }
  renderCreateJoin() {
    const { props, status } = this;
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-layer-view-join-create", { key: `create-${status}`, props: props }));
  }
  get hostElement() { return (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.d)(this); }
};
ArcgisLayerView.style = arcgisLayerViewJoinCss;

const CSS$6 = {
  flow: "flow",
  panel: "panel",
  footer: "footer",
  info: "info",
  listHeader: "list-header",
  text: "text",
  footerButton: "footer-button",
  browse: "browse"
};

const arcgisLayerViewJoinAddSelectionCss = ".flow{height:100%}.panel{height:100%}.footer{width:100%}.info{pointer-events:none;padding:1rem 0.75rem}.list-header{pointer-events:none;padding:1rem 0.75rem 0.3rem}.text{font-size:var(--calcite-font-size--2);line-height:1.375;color:var(--calcite-ui-text-3);transition-duration:150ms;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);pointer-events:none;word-wrap:break-word;word-break:break-word}.footer-button{margin:0 10px 5px 10px}.notice{margin:8px}.browse{width:100%}";

const ArcgisLayerViewJoinAddSelection = class {
  constructor(hostRef) {
    (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.r)(this, hostRef);
    this.arcgisLayerViewJoinStatusChange = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "arcgisLayerViewJoinStatusChange", 7);
    // --------------------------------------------------------------------------
    //
    //  Private methods
    //
    // --------------------------------------------------------------------------
    this.goBrowse = () => {
      this.arcgisLayerViewJoinStatusChange.emit({ status: joinFlowStatus.BROWSE_LAYER });
    };
    this.goBack = () => {
      this.arcgisLayerViewJoinStatusChange.emit({
        status: joinFlowStatus.TARGET_SELECTION
      });
    };
    this.goNext = () => {
      this.arcgisLayerViewJoinStatusChange.emit({
        status: joinFlowStatus.CONFIG
      });
    };
    this.onSelectionChange = () => {
      const { props } = this;
      this.listNode
        .querySelectorAll("calcite-pick-list-item")
        .forEach((item) => {
        if (item.selected) {
          props.addLayerId = item.value;
          (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.hostElement);
        }
      });
      props.attributeRelationships = undefined;
      props.joinOperation = undefined;
    };
    this.props = undefined;
    this.status = undefined;
  }
  //--------------------------------------------------------------------------
  //
  //  Lifecycle
  //
  //--------------------------------------------------------------------------
  componentWillLoad() {
    const { props } = this;
    const { addItem, targetItem, targetLayer } = props;
    if (!addItem && targetLayer.type === "group") {
      props.addItem = targetItem;
      props.addLayer = targetLayer;
    }
    if (props.addLayer && props.addLayer.type !== "group" && !(0,_commonFunctions_5262b094_js__WEBPACK_IMPORTED_MODULE_3__.i)(props.addLayerId)) {
      props.addLayerId = props.addLayer.layerId;
    }
  }
  componentDidLoad() {
    requestAnimationFrame(() => { var _a; return (_a = this.backButtonNode) === null || _a === void 0 ? void 0 : _a.setFocus(); });
  }
  componentDidRender() {
    const { props } = this;
    const { targetLayer, targetLayerId, addLayer, addLayerId } = props;
    if (targetLayer.type === "group") {
      getLayersAndTables(targetLayer).forEach((lyr) => {
        if (lyr.layerId !== targetLayerId) {
          lyr.visible = false;
        }
      });
    }
    if (addLayer && addLayer.type === "group" && (0,_commonFunctions_5262b094_js__WEBPACK_IMPORTED_MODULE_3__.i)(addLayerId)) {
      getLayersAndTables(addLayer).forEach((lyr) => {
        if (targetLayer.id !== addLayer.id || targetLayerId !== lyr.layerId) {
          lyr.visible = lyr.layerId === addLayerId;
        }
      });
    }
    else if (addLayer && addLayer.type !== "group") {
      addLayer.visible = true;
    }
  }
  // --------------------------------------------------------------------------
  //
  //  Render Methods
  //
  //--------------------------------------------------------------------------
  render() {
    const { props, status } = this;
    const { strings } = props;
    const rtl = (0,_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_5__.g)(this.hostElement) === "rtl";
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)(_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.H, { class: "calcite-match-height" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-flow", { class: CSS$6.flow, dir: (0,_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_5__.g)(this.hostElement) }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-flow-item", { description: strings.join.joinLayer, class: {
        panel: true,
        [_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_5__.C.rtl]: rtl
      }, ref: (node) => (this.flowItemNode = node) }, this.renderFooterButtons(), this.renderOBACMsg(), this.renderBrowse(), this.renderSublayers()), status === joinFlowStatus.BROWSE_LAYER && this.renderBrowseLayer())));
  }
  renderFooterButtons() {
    const { props } = this;
    const { addItem, addLayerId, addLayer, strings } = props;
    const isRtl = (0,_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_5__.g)(this.hostElement) === "rtl";
    let addFL;
    if (addLayer && addLayer.type === "group" && (0,_commonFunctions_5262b094_js__WEBPACK_IMPORTED_MODULE_3__.i)(addLayerId)) {
      getLayersAndTables(addLayer).forEach((lyr) => {
        if (addLayerId === lyr.layerId) {
          addFL = lyr;
        }
      });
    }
    else if (addLayer && addLayer.type !== "group") {
      addFL = addLayer;
    }
    const nextDisabled = !addLayer || !(0,_commonFunctions_5262b094_js__WEBPACK_IMPORTED_MODULE_3__.i)(addLayerId) || (addItem.portal.isPortal && hasOBAC(addFL));
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { slot: "footer", class: CSS$6.footer }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { onClick: this.goBack, appearance: "outline-fill", width: "half", "icon-start": isRtl ? "arrow-right" : "arrow-left", ref: (node) => (this.backButtonNode = node) }, strings.general.back), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { disabled: nextDisabled, onClick: !nextDisabled && this.goNext, appearance: "solid", width: "half", iconEnd: isRtl ? "arrow-left" : "arrow-right", ref: (node) => (this.nextButtonNode = node) }, strings.general.next)));
  }
  renderOBACMsg() {
    const { props } = this;
    const { config, addItem, addLayerId, addLayer, strings } = props;
    const { helpBase, helpMap } = config;
    if (!addLayer) {
      return;
    }
    if (!addItem.portal.isPortal) {
      // message only for Enterprise
      return;
    }
    let addFL;
    if (addLayer.type === "group" && (0,_commonFunctions_5262b094_js__WEBPACK_IMPORTED_MODULE_3__.i)(addLayerId)) {
      addFL = getLayersAndTables(addLayer).find((lyr) => addLayerId === lyr.layerId);
    }
    else if (addLayer.type !== "group") {
      addFL = addLayer;
    }
    else {
      return;
    }
    if (!hasOBAC(addFL)) {
      return;
    }
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-notice", { key: `${hasOBAC(addFL)}`, class: "notice", open: true, closable: false, scale: "s", width: "auto", kind: "warning", icon: "exclamation-mark-triangle" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { slot: "message" }, strings.join.obacNotSupportedMsg), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-link", { slot: "link", title: strings.join.learnMore, target: "_blank", href: `${helpBase}${helpMap["120004184"]}` }, strings.join.learnMore)));
  }
  renderBrowse() {
    const { props } = this;
    const { strings } = props;
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", null, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS$6.info }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS$6.text }, strings.join.selectAddLayerPanelDescription)), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS$6.footerButton }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { id: "arcgis-layer-view-join-browse", onClick: this.goBrowse, appearance: "outline-fill", width: "full", ref: (node) => (this.browseButtonNode = node) }, strings.join.browseForLayer))));
  }
  renderBrowseLayer() {
    const { props } = this;
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-layer-view-join-browse-layer", { props: props, class: CSS$6.browse, onArcgisLayerViewJoinStatusChange: (event) => {
        if (event.detail.status === joinFlowStatus.ADD_SELECTION) {
          // can't make it work without using an id
          // it seems the whole component reloads from scratch after this step here
          setTimeout(() => {
            var _a;
            return (_a = document.getElementById("arcgis-layer-view-join-browse")) === null || _a === void 0 ? void 0 : _a.setFocus();
          }, 400);
        }
      } }));
  }
  renderSublayers() {
    const { props } = this;
    const { targetLayer, addItem, addLayer, targetLayerId, strings } = props;
    if (!addLayer) {
      return null;
    }
    const listItems = [];
    if (addLayer.type === "group") {
      getLayersAndTables(addLayer).forEach((lyr) => {
        if (targetLayer.id !== addLayer.id || targetLayerId !== lyr.layerId) {
          listItems.unshift(this.renderSublayer(lyr));
        }
      });
    }
    else {
      listItems.push(this.renderSublayer(addLayer));
    }
    const str = strings.join.selectFromItem;
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)(_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.F, null, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS$6.listHeader }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS$6.text }, str.substring(0, str.indexOf("${")), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("b", null, addItem.title), str.substring(str.indexOf("}") + 1))), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-pick-list", { multiple: false, onCalciteListChange: this.onSelectionChange, ref: (node) => (this.listNode = node) }, listItems)));
  }
  renderSublayer(lyr) {
    const { props } = this;
    const { addLayerId } = props;
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-pick-list-item", { key: lyr.layerId, label: lyr.title, value: lyr.layerId, description: getLayerType(lyr, props), selected: addLayerId === lyr.layerId }));
  }
  get hostElement() { return (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.d)(this); }
};
ArcgisLayerViewJoinAddSelection.style = arcgisLayerViewJoinAddSelectionCss;

const arcgisLayerViewJoinBrowseLayerCss = ".panel.sc-arcgis-layer-view-join-browse-layer{height:100%}";

const ArcgisLayerViewJoinBrowseLayer = class {
  constructor(hostRef) {
    (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.r)(this, hostRef);
    this.arcgisLayerViewJoinStatusChange = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "arcgisLayerViewJoinStatusChange", 7);
    // --------------------------------------------------------------------------
    //
    //  Private methods
    //
    // --------------------------------------------------------------------------
    this.onBack = () => {
      this.arcgisLayerViewJoinStatusChange.emit({ status: joinFlowStatus.ADD_SELECTION });
    };
    this.goUseLayer = async (itemId) => {
      var _a, _b;
      const { props } = this;
      const { addLayer, targetLayer, view, modules } = props;
      this.loading = true;
      if (addLayer && addLayer.id !== targetLayer.id) {
        view.map.remove(addLayer);
      }
      const addItem = new modules.PortalItem({
        id: itemId
      });
      await addItem.load();
      const newAddLayer = await modules.Layer.fromPortalItem({
        portalItem: addItem
      });
      if (newAddLayer.type === "group") {
        // group layer has no layers or tables at this point
        // loadAll() loads layers and tables (at v4.23)
        await newAddLayer.loadAll();
        if ((_a = newAddLayer.layers) === null || _a === void 0 ? void 0 : _a.length) {
          // has at least one spatial layer
          view.map.add(newAddLayer);
        }
        // default popups
        (_b = newAddLayer.layers) === null || _b === void 0 ? void 0 : _b.forEach((lyr) => {
          if (!lyr.popupTemplate && lyr.popupEnabled) {
            lyr.popupTemplate = lyr.createPopupTemplate();
          }
        });
      }
      else {
        await newAddLayer.load();
        if (!newAddLayer.isTable) {
          view.map.add(newAddLayer);
        }
        // default popup
        newAddLayer.popupTemplate = newAddLayer.createPopupTemplate();
      }
      props.addItem = addItem;
      props.addLayer = newAddLayer;
      props.addLayerId = undefined;
      props.joinOperation = undefined;
      this.arcgisLayerViewJoinStatusChange.emit({ status: joinFlowStatus.ADD_SELECTION });
    };
    this.props = undefined;
    this.loading = false;
    this.items = undefined;
    this.pagination = undefined;
    this.error = undefined;
  }
  //--------------------------------------------------------------------------
  //
  //  Lifecycle
  //
  //--------------------------------------------------------------------------
  async componentDidLoad() {
    setTimeout(() => requestAnimationFrame(() => { var _a; return (_a = this.flowItemNode) === null || _a === void 0 ? void 0 : _a.setFocus(); }), 200);
  }
  // --------------------------------------------------------------------------
  //
  //  Render Methods
  //
  //--------------------------------------------------------------------------
  render() {
    const { props, loading, hostElement } = this;
    const { strings } = props;
    const rtl = (0,_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_5__.g)(hostElement) === "rtl";
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)(_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.H, { class: "calcite-match-height" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-flow-item", { heading: strings.join.browseForLayerTitle, description: strings.join.browseForLayerSubTitle, loading: loading, class: {
        panel: true,
        [_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_5__.C.rtl]: rtl
      }, onCalciteFlowItemBack: this.onBack, ref: (node) => (this.flowItemNode = node) }, this.renderItemBrowser())));
  }
  renderItemBrowser() {
    const { props, pagination } = this;
    const { targetItem, targetLayer, itemId, strings } = props;
    const { portalItem } = targetLayer;
    const { portal } = portalItem;
    const user = portal.user;
    const query = `type:"Feature Service" typekeywords:"Hosted Service" -typekeywords:"View Service" -typekeywords:"Spatiotemporal" owner:"${targetItem.owner}" -id:${itemId}`;
    const baseUrl = `${(0,_portal_8714dc6c_js__WEBPACK_IMPORTED_MODULE_6__.g)(portal)}/home/`;
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-item-browser", { onArcgisItemBrowserUpdate: (e) => {
        const { results, num, start, total } = e.detail;
        this.items = results;
        this.pagination = { start, num, total };
      }, filter: query, portal: portal, user: user, api: 4, config: { baseUrl }, selection: "none" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-item-browser-top-bar", { slot: "top-bar" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-item-browser-search", { slot: "search", term: "" })), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-item-browser-sort", { options: ["modified", "title", "relevance"], slot: "sort" }), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-item-browser-content", { slot: "content" }, (this.items || []).map((item) => ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-item-browser-card", { item: item, portal: portal, baseUrl: baseUrl, key: item.id }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { id: `join-action-${item.id}`, icon: "plus-circle", text: "", scale: "s", slot: "actions-end", onClick: this.goUseLayer.bind(this, item.id) }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-tooltip", { slot: "tooltip", label: strings.join.select, overlayPositioning: "fixed" }, strings.join.select)))))), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-item-browser-pagination", { total: pagination === null || pagination === void 0 ? void 0 : pagination.total, start: pagination === null || pagination === void 0 ? void 0 : pagination.start, num: pagination === null || pagination === void 0 ? void 0 : pagination.num, slot: "pagination" })));
  }
  get hostElement() { return (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.d)(this); }
};
ArcgisLayerViewJoinBrowseLayer.style = arcgisLayerViewJoinBrowseLayerCss;

const CSS$5 = {
  flow: "flow",
  panel: "panel",
  footer: "footer",
  layerSection: "layer-section",
  targetLayer: "target-layer",
  addLayer: "add-layer",
  layerHeader: "layer-header",
  layerTitle: "layer-title",
  layerIcon: "layer-icon",
  attributeRelationship: "attribute-relationship",
  removeAttributeRelationship: "remove-attribute-relationship",
  sortBySection: "sort-by-section",
  joinMatchTypeSection: "join-match-type-section",
  chip: "chip",
  separator: "separator",
  statsSection: "stats-section",
  statsFieldHeader: "stats-field-header",
  statsButton: "stats-button",
  selectAll: "select-all",
  select: "select"
};

const arcgisLayerViewJoinConfigCss = ".flow{height:100%}.panel{height:100%}.footer{width:100%}.layer-section{border:1px solid var(--calcite-ui-border-3);background-color:white;margin:10px}.target-layer{padding:10px;border-bottom:1px solid var(--calcite-ui-border-3);display:flex;justify-content:space-between}.add-layer{padding:10px;display:flex;justify-content:space-between}.layer-header{padding-bottom:3px;overflow-wrap:anywhere}.layer-title{font-weight:bold;overflow-wrap:anywhere}.layer-icon{align-self:center;cursor:pointer}.attribute-relationship{border:1px solid var(--calcite-ui-border-3);padding:10px 10px 0 10px;margin-bottom:10px}.remove-attribute-relationship{display:flex;justify-content:flex-end}.join-match-type-section{padding:10px 0}.info{display:flex;justify-content:space-between}.info-label{display:flex;align-items:center}.chip{margin-bottom:5px}.sort-by-section{border:1px solid var(--calcite-ui-border-3);padding:10px 10px 0 10px;margin:10px 0}.separator{border-bottom:1px solid var(--calcite-ui-border-3);margin:10px 0 15px 0}.stats-section{border:1px solid var(--calcite-ui-border-3);padding:10px 10px 0 10px;margin-bottom:10px}.stats-field-header{overflow-wrap:anywhere;width:100%}.stats-button{margin-bottom:10px}.select{cursor:pointer}";

const ArcgisLayerViewJoinConfig = class {
  constructor(hostRef) {
    (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.r)(this, hostRef);
    this.arcgisLayerViewJoinStatusChange = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "arcgisLayerViewJoinStatusChange", 7);
    this.arcgisLayerViewJoinConfigTableClick = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "arcgisLayerViewJoinConfigTableClick", 7);
    // --------------------------------------------------------------------------
    //
    //  Private methods
    //
    // --------------------------------------------------------------------------
    this.goBack = () => {
      this.arcgisLayerViewJoinStatusChange.emit({
        status: joinFlowStatus.ADD_SELECTION
      });
    };
    this.goNext = () => {
      const { props } = this;
      const { attributeRelationships } = props;
      // clean up
      props.attributeRelationships = attributeRelationships.filter((rel) => rel.targetFieldName && rel.addFieldName);
      this.arcgisLayerViewJoinStatusChange.emit({
        status: joinFlowStatus.CREATE
      });
    };
    this.onTargetFieldSelect = (rel) => {
      const { props, targetFL } = this;
      const { strings } = props;
      const { targetFieldName } = rel;
      const shapeFields = targetFL.fields.filter((field) => field.name.toLowerCase().startsWith("shape__"));
      this.openFieldPickList({
        layer: targetFL,
        fieldName: targetFieldName,
        multiple: false,
        heading: strings.join.targetFields,
        fieldTypes: [
          "small-integer",
          "big-integer",
          "integer",
          "single",
          "double",
          "long",
          "number",
          "date",
          "date-only",
          "time-only",
          "timestamp-offset",
          "string",
          "guid",
          "global-id"
        ],
        excludedFields: shapeFields.map((field) => field.name),
        buttonNode: this.targetFieldNode,
        onChange: (selectedFields) => {
          rel.targetFieldName = selectedFields[0];
          (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.hostElement);
        }
      });
    };
    this.onJoinFieldSelect = (rel) => {
      const { props, addFL } = this;
      const { strings } = props;
      const { addFieldName } = rel;
      const shapeFields = addFL.fields.filter((field) => field.name.toLowerCase().startsWith("shape__"));
      this.openFieldPickList({
        layer: addFL,
        fieldName: addFieldName,
        multiple: false,
        heading: strings.join.joinFields,
        fieldTypes: [
          "small-integer",
          "big-integer",
          "integer",
          "single",
          "double",
          "long",
          "number",
          "date",
          "date-only",
          "time-only",
          "timestamp-offset",
          "string",
          "guid",
          "global-id"
        ],
        excludedFields: shapeFields.map((field) => field.name),
        buttonNode: this.addFieldNode,
        onChange: (selectedFields) => {
          rel.addFieldName = selectedFields[0];
          (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.hostElement);
        }
      });
    };
    this.onSortByFieldSelect = () => {
      const { props, addFL } = this;
      const { joinOperation, strings } = props;
      const { sortByFieldName } = joinOperation;
      const shapeFields = addFL.fields.filter((field) => field.name.toLowerCase().startsWith("shape__"));
      this.openFieldPickList({
        layer: addFL,
        fieldName: sortByFieldName,
        multiple: false,
        heading: strings.join.joinFields,
        fieldTypes: [
          "small-integer",
          "big-integer",
          "integer",
          "single",
          "double",
          "long",
          "number",
          "date",
          "date-only",
          "time-only",
          "timestamp-offset",
          "oid"
        ],
        excludedFields: shapeFields.map((field) => field.name),
        buttonNode: this.sortByFieldNode,
        onChange: (selectedFields) => {
          joinOperation.sortByFieldName = selectedFields[0];
          (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.hostElement);
        }
      });
    };
    this.onStatsFieldSelect = () => {
      const { props, addFL } = this;
      const { joinOperation, strings } = props;
      const { statisticsFields } = joinOperation;
      const shapeFields = addFL.fields.filter((field) => field.name.toLowerCase().startsWith("shape__"));
      this.openFieldPickList({
        layer: addFL,
        fieldName: "",
        multiple: true,
        heading: strings.join.selectFields,
        fieldTypes: [
          "small-integer",
          "big-integer",
          "integer",
          "single",
          "double",
          "long",
          "number",
          "date",
          "date-only",
          "time-only",
          "timestamp-offset"
        ],
        excludedFields: statisticsFields
          .map((field) => field.fieldName)
          .concat(shapeFields.map((field) => field.name)),
        buttonNode: this.statsButtonNode,
        onChange: (selectedFields) => {
          selectedFields.forEach((fieldName) => {
            const isDate = ["date", "date-only", "time-only", "timestamp-offset"].indexOf(getFieldType(addFL, fieldName)) > -1;
            statisticsFields.push({ fieldName, types: [isDate ? "MIN" : "SUM"] });
          });
          (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.hostElement);
        }
      });
    };
    this.props = undefined;
    this.status = undefined;
    this.showTableOption = false;
  }
  //--------------------------------------------------------------------------
  //
  //  Lifecycle
  //
  //--------------------------------------------------------------------------
  async componentWillLoad() {
    var _a;
    const { props } = this;
    const { targetLayer, targetLayerId, addLayer, addLayerId, attributeRelationships, joinOperation } = props;
    this.targetFL = (targetLayer.type === "group"
      ? getLayersAndTables(targetLayer).find((lyr) => lyr.layerId === targetLayerId)
      : targetLayer);
    this.addFL = (addLayer.type === "group"
      ? getLayersAndTables(addLayer).find((lyr) => lyr.layerId === addLayerId)
      : addLayer);
    if (!(attributeRelationships === null || attributeRelationships === void 0 ? void 0 : attributeRelationships.length)) {
      props.attributeRelationships = [];
      // look for relationship fields
      const { targetFL, addFL } = this;
      if (targetFL.relationships && addFL.relationships) {
        const targetRels = targetFL.relationships.filter((rel) => rel.relatedTableId === addLayerId);
        const addRels = addFL.relationships.filter((rel) => rel.relatedTableId === targetLayerId);
        if (targetRels.length && addRels.length) {
          targetRels.forEach((targetRel) => {
            const addRel = addRels.find((addRel) => targetRel.id === addRel.id);
            if (addRel) {
              props.attributeRelationships.push({
                targetFieldName: targetRel.keyField,
                addFieldName: addRel.keyField
              });
            }
          });
        }
      }
      if (!((_a = props.attributeRelationships) === null || _a === void 0 ? void 0 : _a.length)) {
        props.attributeRelationships.push({});
      }
    }
    if (!joinOperation) {
      props.joinOperation = {
        type: "one-to-one",
        matchType: "first",
        sortByFieldName: this.addFL.objectIdField,
        sortOrder: "ASC",
        joinType: "INNER",
        statisticsFields: []
      };
    }
  }
  async componentDidLoad() {
    requestAnimationFrame(() => { var _a; return (_a = this.backButtonNode) === null || _a === void 0 ? void 0 : _a.setFocus(); });
  }
  disconnectedCallback() {
    this.removeInfoPopover();
  }
  // --------------------------------------------------------------------------
  //
  //  Render Methods
  //
  //--------------------------------------------------------------------------
  render() {
    const { props } = this;
    const { strings } = props;
    const rtl = (0,_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_5__.g)(this.hostElement) === "rtl";
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)(_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.H, { class: "calcite-match-height" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-flow", { class: CSS$5.flow, dir: (0,_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_5__.g)(this.hostElement) }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-flow-item", { heading: strings.join.configureJoin, class: {
        panel: true,
        [_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_5__.C.rtl]: rtl
      }, ref: (node) => (this.flowItemNode = node) }, this.renderFooterButtons(), this.renderContent()))));
  }
  renderFooterButtons() {
    var _a, _b;
    const { props } = this;
    const { attributeRelationships, joinOperation, strings } = props;
    const isRtl = (0,_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_5__.g)(this.hostElement) === "rtl";
    const nextEnabled = !!attributeRelationships.find((rel) => rel.targetFieldName && rel.addFieldName) &&
      (joinOperation.type === "one-to-many" ||
        (joinOperation.matchType === "first" &&
          joinOperation.sortByFieldName &&
          joinOperation.sortOrder) ||
        (joinOperation.matchType === "summarize" &&
          ((_a = joinOperation.statisticsFields) === null || _a === void 0 ? void 0 : _a.length) &&
          ((_b = joinOperation.statisticsFields) === null || _b === void 0 ? void 0 : _b[0].fieldName)));
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { slot: "footer", class: CSS$5.footer }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { onClick: this.goBack, appearance: "outline-fill", width: "half", "icon-start": isRtl ? "arrow-right" : "arrow-left", ref: (node) => (this.backButtonNode = node) }, strings.general.back), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { disabled: !nextEnabled, onClick: nextEnabled && this.goNext, appearance: "solid", width: "half", iconEnd: isRtl ? "arrow-left" : "arrow-right", ref: (node) => (this.nextButtonNode = node) }, strings.general.next)));
  }
  renderContent() {
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)(_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.F, null, this.renderLayers(), this.renderAttributeRelationships(), this.renderJoinOperation()));
  }
  renderLayers() {
    const { props, targetFL, addFL } = this;
    const { targetItem, targetLayer, targetLayerId, addItem, addLayer, addLayerId, showTableOption, strings } = props;
    const rtl = (0,_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_5__.g)(this.hostElement) === "rtl";
    const targetTitle = targetLayer.type === "group"
      ? rtl
        ? `${targetFL.title} / ${targetItem.title}`
        : `${targetItem.title} / ${targetFL.title}`
      : targetLayer.title;
    const addTitle = addLayer.type === "group"
      ? rtl
        ? `${addFL.title} / ${addItem.title}`
        : `${addItem.title} / ${addFL.title}`
      : addLayer.title;
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS$5.layerSection }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS$5.targetLayer }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", null, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS$5.layerHeader }, strings.join.targetLayer), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS$5.layerTitle }, targetTitle)), showTableOption && ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { scale: "s", icon: "table", class: CSS$5.layerIcon, text: strings.join.showTable, textEnabled: false, onClick: () => {
        var _a, _b;
        if (targetLayer.type === "group") {
          (_a = targetLayer.tables) === null || _a === void 0 ? void 0 : _a.forEach((lyr) => {
            if (lyr.layerId === targetLayerId) {
              this.arcgisLayerViewJoinConfigTableClick.emit(lyr);
            }
          });
          (_b = targetLayer.layers) === null || _b === void 0 ? void 0 : _b.forEach((lyr) => {
            if (lyr.layerId === targetLayerId) {
              this.arcgisLayerViewJoinConfigTableClick.emit(lyr);
            }
          });
        }
        else {
          this.arcgisLayerViewJoinConfigTableClick.emit(targetLayer);
        }
      } }))), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS$5.addLayer }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", null, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS$5.layerHeader }, strings.join.joinLayer), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS$5.layerTitle }, addTitle)), showTableOption && ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { scale: "s", icon: "table", class: CSS$5.layerIcon, text: strings.join.showTable, textEnabled: false, onClick: () => {
        var _a, _b;
        if (addLayer.type === "group") {
          (_a = addLayer.tables) === null || _a === void 0 ? void 0 : _a.forEach((lyr) => {
            if (lyr.layerId === addLayerId) {
              this.arcgisLayerViewJoinConfigTableClick.emit(lyr);
            }
          });
          (_b = addLayer.layers) === null || _b === void 0 ? void 0 : _b.forEach((lyr) => {
            if (lyr.layerId === addLayerId) {
              this.arcgisLayerViewJoinConfigTableClick.emit(lyr);
            }
          });
        }
        else {
          this.arcgisLayerViewJoinConfigTableClick.emit(addLayer);
        }
      } })))));
  }
  renderAttributeRelationships() {
    const { props } = this;
    const { attributeRelationships, strings } = props;
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-block", { heading: strings.join.attributeJoin, description: strings.join.attributeJoinMsg, open: true, collapsible: true, ref: (node) => (this.attrBlockNode = node) }, attributeRelationships.map((rel, idx) => this.renderAttributeRelationship(rel, idx)), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { onClick: () => {
        attributeRelationships.push({});
        (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.hostElement);
      }, appearance: "outline-fill", width: "full", ref: (node) => (this.fieldButtonNode = node) }, strings.join.fields)));
  }
  renderAttributeRelationship(rel, idx) {
    const { targetFL, addFL, props } = this;
    const { attributeRelationships, strings } = props;
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS$5.attributeRelationship }, attributeRelationships.length > 1 && ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS$5.removeAttributeRelationship }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { scale: "s", icon: "trash", text: strings.general.remove, onClick: () => {
        attributeRelationships.splice(idx, 1);
        (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.hostElement);
      } }))), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-label", null, strings.join.targetField, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { appearance: "outline-fill", kind: "neutral", width: "full", alignment: "icon-end-space-between", iconEnd: "chevron-down", onClick: () => this.onTargetFieldSelect(rel), ref: (node) => (this.targetFieldNode = node) }, rel.targetFieldName
      ? getFieldAlias(targetFL, rel.targetFieldName)
      : strings.join.selectField)), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-label", null, strings.join.joinField, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { appearance: "outline-fill", kind: "neutral", width: "full", alignment: "icon-end-space-between", iconEnd: "chevron-down", onClick: () => this.onJoinFieldSelect(rel), ref: (node) => (this.addFieldNode = node) }, rel.addFieldName ? getFieldAlias(addFL, rel.addFieldName) : strings.join.selectField))));
  }
  renderJoinOperation() {
    const { props } = this;
    const { joinOperation, strings } = props;
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-block", { heading: strings.join.joinSettings, description: strings.join.joinSettingsMsg, open: true, collapsible: true, ref: (node) => (this.operationBlockNode = node) }, this.renderJoinOperationType(), joinOperation.type === "one-to-one" && this.renderMatchType(), joinOperation.type === "one-to-one" &&
      joinOperation.matchType === "first" &&
      this.renderJoinOperationSortBy(), joinOperation.type === "one-to-one" &&
      joinOperation.matchType === "summarize" &&
      this.renderJoinOperationStatistics(), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS$5.separator }), this.renderJoinType()));
  }
  renderJoinOperationType() {
    const { props } = this;
    const { joinOperation, strings } = props;
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-label", null, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "info" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "info-label" }, strings.join.joinOperation), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { class: "link-info", tabindex: "0", scale: "s", icon: "information", onClick: (event) => this.handleInfoClick(event, "join-operation"), text: strings.join.moreInfo, ref: (element) => {
        this.joinOperationInfoIconNode = element;
        element.addEventListener("keyup", (event) => {
          event.stopPropagation();
          if (event.key === " " || (!this.infoPopoverNode && event.key === "Enter")) {
            this.handleInfoClick(event, "join-operation");
          }
        });
        element.addEventListener("keydown", (event) => {
          if (event.key === " ") {
            // prevent panel from scrolling
            event.stopPropagation();
            event.preventDefault();
          }
        });
      } })), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", null, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-chip", { value: "one-to-one", appearance: joinOperation.type === "one-to-one" ? "solid" : "outline-fill", kind: "brand", class: `${CSS$5.chip} ${joinOperation.type === "one-to-many" ? CSS$5.select : ""}`, onClick: joinOperation.type === "one-to-many"
        ? () => {
          joinOperation.type = "one-to-one";
          (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.hostElement);
        }
        : undefined }, strings.join.oneToOne), "\u00A0", (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-chip", { value: "one-to-many", appearance: joinOperation.type === "one-to-many" ? "solid" : "outline-fill", kind: "brand", class: `${CSS$5.chip} ${joinOperation.type === "one-to-one" ? CSS$5.select : ""}`, onClick: joinOperation.type === "one-to-one"
        ? () => {
          joinOperation.type = "one-to-many";
          (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.hostElement);
        }
        : undefined }, strings.join.oneToMany))));
  }
  renderMatchType() {
    const { props } = this;
    const { joinOperation, strings } = props;
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-radio-button-group", { name: "matchType", layout: "vertical", class: CSS$5.joinMatchTypeSection }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-label", { layout: "inline", class: CSS$5.select, onClick: () => {
        joinOperation.matchType = "first";
        (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.hostElement);
      } }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-radio-button", { checked: joinOperation.matchType === "first", value: "first", onClick: () => {
        joinOperation.matchType = "first";
        (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.hostElement);
      } }), strings.join.onlyFirst), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-label", { layout: "inline", class: CSS$5.select, onClick: () => {
        joinOperation.matchType = "summarize";
        (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.hostElement);
      } }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-radio-button", { checked: joinOperation.matchType === "summarize", value: "summarize", onClick: () => {
        joinOperation.matchType = "summarize";
        (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.hostElement);
      } }), strings.join.summarizeMatching)));
  }
  renderJoinOperationSortBy() {
    const { addFL, props } = this;
    const { joinOperation, strings } = props;
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS$5.sortBySection }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-label", null, strings.join.sortBy, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { appearance: "outline-fill", kind: "neutral", width: "full", alignment: "icon-end-space-between", iconEnd: "chevron-down", onClick: () => this.onSortByFieldSelect(), ref: (node) => (this.sortByFieldNode = node) }, getFieldAlias(addFL, joinOperation.sortByFieldName))), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-label", null, strings.join.sortOrder, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-select", { width: "full", onCalciteSelectChange: (event) => {
        const selectNode = event.target;
        joinOperation.sortOrder = selectNode.value;
        (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.hostElement);
      }, label: strings.join.sortOrder }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-option", { label: strings.join.asc, selected: joinOperation.sortOrder === "ASC", value: "ASC" }, strings.join.asc), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-option", { label: strings.join.desc, selected: joinOperation.sortOrder === "DESC", value: "DESC" }, strings.join.desc)))));
  }
  renderJoinOperationStatistics() {
    var _a;
    const { props, addFL } = this;
    const { joinOperation, strings } = props;
    const { statisticsFields } = joinOperation;
    const excludedFields = statisticsFields.map((field) => field.fieldName);
    const fieldTypes = [
      "small-integer",
      "big-integer",
      "integer",
      "single",
      "double",
      "long",
      "number",
      "date",
      "date-only",
      "time-only",
      "timestamp-offset"
    ];
    const layerFields = addFL.fields
      .filter((field) => excludedFields.indexOf(field.name) === -1)
      .filter((field) => fieldTypes.indexOf(field.type) > -1);
    const noMoreFields = !layerFields.length;
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)(_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.F, null, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-label", { scale: "l" }, strings.join.fieldStats), (_a = joinOperation.statisticsFields) === null || _a === void 0 ? void 0 :
      _a.map((statsField, idx) => this.renderJoinOperationStatistic(statsField, idx)), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { onClick: !noMoreFields && this.onStatsFieldSelect, appearance: "outline-fill", "icon-start": "plus", width: "full", disabled: noMoreFields, class: CSS$5.statsButton, ref: (node) => (this.statsButtonNode = node) }, strings.join.addStats)));
  }
  renderJoinOperationStatistic(statsField, idx) {
    const { props, addFL } = this;
    const { joinOperation, strings } = props;
    const isDate = ["date", "date-only", "time-only", "timestamp-offset"].indexOf(getFieldType(addFL, statsField.fieldName)) > -1;
    const hasAllTypes = isDate
      ? statsField.types.indexOf("MIN") > -1 && statsField.types.indexOf("MAX") > -1
      : statsField.types.indexOf("SUM") > -1 &&
        statsField.types.indexOf("MIN") > -1 &&
        statsField.types.indexOf("MAX") > -1 &&
        statsField.types.indexOf("MEAN") > -1 &&
        statsField.types.indexOf("STDDEV") > -1;
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS$5.statsSection }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-label", { class: CSS$5.statsFieldHeader, layout: "inline-space-between" }, getFieldAlias(addFL, statsField.fieldName), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { scale: "s", icon: "trash", text: strings.general.remove, onClick: () => {
        joinOperation.statisticsFields.splice(idx, 1);
        (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.hostElement);
      } })), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", null, !isDate && ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)(_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.F, null, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-chip", { value: "SUM", appearance: statsField.types.indexOf("SUM") > -1 ? "solid" : "outline-fill", kind: "brand", class: `${CSS$5.chip} ${statsField.types.length > 1 || statsField.types.indexOf("SUM") === -1
        ? CSS$5.select
        : ""}`, onClick: () => {
        statsField.types.indexOf("SUM") === -1
          ? statsField.types.push("SUM")
          : statsField.types.length > 1
            ? statsField.types.splice(statsField.types.indexOf("SUM"), 1)
            : undefined;
        (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.hostElement);
      } }, strings.join.sum), "\u00A0")), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-chip", { value: "MIN", appearance: statsField.types.indexOf("MIN") > -1 ? "solid" : "outline-fill", kind: "brand", class: `${CSS$5.chip} ${statsField.types.length > 1 || statsField.types.indexOf("MIN") === -1
        ? CSS$5.select
        : ""}`, onClick: () => {
        statsField.types.indexOf("MIN") === -1
          ? statsField.types.push("MIN")
          : statsField.types.length > 1
            ? statsField.types.splice(statsField.types.indexOf("MIN"), 1)
            : undefined;
        (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.hostElement);
      } }, strings.join.min), "\u00A0", (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-chip", { value: "MAX", appearance: statsField.types.indexOf("MAX") > -1 ? "solid" : "outline-fill", kind: "brand", class: `${CSS$5.chip} ${statsField.types.length > 1 || statsField.types.indexOf("MAX") === -1
        ? CSS$5.select
        : ""}`, onClick: () => {
        statsField.types.indexOf("MAX") === -1
          ? statsField.types.push("MAX")
          : statsField.types.length > 1
            ? statsField.types.splice(statsField.types.indexOf("MAX"), 1)
            : undefined;
        (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.hostElement);
      } }, strings.join.max), !isDate && ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)(_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.F, null, "\u00A0", (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-chip", { value: "MEAN", appearance: statsField.types.indexOf("MEAN") > -1 ? "solid" : "outline-fill", kind: "brand", class: `${CSS$5.chip} ${statsField.types.length > 1 || statsField.types.indexOf("MEAN") === -1
        ? CSS$5.select
        : ""}`, onClick: () => {
        statsField.types.indexOf("MEAN") === -1
          ? statsField.types.push("MEAN")
          : statsField.types.length > 1
            ? statsField.types.splice(statsField.types.indexOf("MEAN"), 1)
            : undefined;
        (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.hostElement);
      } }, strings.join.mean), "\u00A0", (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-chip", { value: "STDDEV", appearance: statsField.types.indexOf("STDDEV") > -1 ? "solid" : "outline-fill", kind: "brand", class: `${CSS$5.chip} ${statsField.types.length > 1 || statsField.types.indexOf("STDDEV") === -1
        ? CSS$5.select
        : ""}`, onClick: () => {
        statsField.types.indexOf("STDDEV") === -1
          ? statsField.types.push("STDDEV")
          : statsField.types.length > 1
            ? statsField.types.splice(statsField.types.indexOf("STDDEV"), 1)
            : undefined;
        (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.hostElement);
      } }, strings.join.stdDev))), !hasAllTypes && ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)(_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.F, null, "\u00A0", (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { appearance: "transparent", label: strings.join.selectAll, onClick: () => {
        !isDate && statsField.types.indexOf("SUM") === -1 && statsField.types.push("SUM");
        statsField.types.indexOf("MIN") === -1 && statsField.types.push("MIN");
        statsField.types.indexOf("MAX") === -1 && statsField.types.push("MAX");
        !isDate &&
          statsField.types.indexOf("MEAN") === -1 &&
          statsField.types.push("MEAN");
        !isDate &&
          statsField.types.indexOf("STDDEV") === -1 &&
          statsField.types.push("STDDEV");
        (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.hostElement);
      } }, strings.join.selectAll))))));
  }
  renderJoinType() {
    const { props } = this;
    const { joinOperation, strings } = props;
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-label", null, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "info" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "info-label" }, strings.join.joinType), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { class: "link-info", tabindex: "0", scale: "s", icon: "information", onClick: (event) => this.handleInfoClick(event, "join-type"), text: strings.join.moreInfo, ref: (element) => {
        this.joinTypeInfoIconNode = element;
        element.addEventListener("keyup", (event) => {
          event.stopPropagation();
          if (event.key === " " || (!this.infoPopoverNode && event.key === "Enter")) {
            this.handleInfoClick(event, "join-type");
          }
        });
        element.addEventListener("keydown", (event) => {
          if (event.key === " ") {
            // prevent panel from scrolling
            event.stopPropagation();
            event.preventDefault();
          }
        });
      } })), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", null, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-chip", { value: "inner-join", appearance: joinOperation.joinType === "INNER" ? "solid" : "outline-fill", kind: "brand", class: `${CSS$5.chip} ${joinOperation.joinType === "LEFT" ? CSS$5.select : ""}`, onClick: joinOperation.joinType === "LEFT"
        ? () => {
          joinOperation.joinType = "INNER";
          (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.hostElement);
        }
        : undefined }, strings.join.innerJoin), "\u00A0", (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-chip", { value: "left-join", appearance: joinOperation.joinType === "LEFT" ? "solid" : "outline-fill", kind: "brand", class: `${CSS$5.chip} ${joinOperation.joinType === "INNER" ? CSS$5.select : ""}`, onClick: joinOperation.joinType === "INNER"
        ? () => {
          joinOperation.joinType = "LEFT";
          (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.hostElement);
        }
        : undefined }, strings.join.leftJoin))));
  }
  openFieldPickList({ layer, fieldName, multiple, heading, fieldTypes, excludedFields, buttonNode, onChange }) {
    const { props, fieldPickListSortBy, flowItemNode } = this;
    const { view } = props;
    const nodeWidth = flowItemNode.getBoundingClientRect().width || 215;
    this.arcgisFieldPickList = document.createElement("arcgis-field-pick-list");
    this.arcgisFieldPickList.popoverProps = {
      placement: "auto",
      offsetDistance: -1 * (nodeWidth - 2),
      offsetSkidding: 0,
      pointerDisabled: true,
      popoverWidth: nodeWidth + 7,
      refElement: flowItemNode
    };
    this.arcgisFieldPickList.fields = this.createPickListFields(layer, fieldTypes, excludedFields);
    this.arcgisFieldPickList.layer = layer;
    this.arcgisFieldPickList.mapView = view;
    this.arcgisFieldPickList.showFieldInfo = true;
    this.arcgisFieldPickList.showFieldName = false;
    this.arcgisFieldPickList.selectedFields = fieldName ? [fieldName] : [];
    this.arcgisFieldPickList.sortBy = fieldPickListSortBy;
    this.arcgisFieldPickList.multiple = multiple;
    this.arcgisFieldPickList.heading = heading;
    this.arcgisFieldPickList.addEventListener("arcgisFieldPickListDismissed", (event) => {
      var _a;
      event.stopPropagation();
      const selectedFields = (_a = event.detail) === null || _a === void 0 ? void 0 : _a.selectedFields;
      flowItemNode.disabled = false;
      if (this.arcgisFieldPickList) {
        document.body.removeChild(this.arcgisFieldPickList);
        this.arcgisFieldPickList = null;
        setTimeout(() => {
          buttonNode.setFocus();
        }, 1);
      }
      if (selectedFields === null || selectedFields === void 0 ? void 0 : selectedFields.length) {
        onChange(selectedFields);
      } // else user hit cancel or close
    });
    this.arcgisFieldPickList.addEventListener("arcgisFieldPickListSortByChange", (event) => (this.fieldPickListSortBy = event.detail));
    document.body.appendChild(this.arcgisFieldPickList);
    flowItemNode.disabled = true;
  }
  createPickListFields(layer, fieldTypes, excludedFields) {
    const { fields, popupTemplate } = layer;
    const layerFields = fields
      .filter((field) => excludedFields.indexOf(field.name) === -1)
      .filter((field) => fieldTypes.indexOf(field.type) > -1);
    return layerFields.map((field) => {
      var _a, _b;
      return {
        name: field.name,
        alias: ((_b = (_a = popupTemplate === null || popupTemplate === void 0 ? void 0 : popupTemplate.fieldInfos) === null || _a === void 0 ? void 0 : _a.find((fieldInfo) => fieldInfo.fieldName === field.name)) === null || _b === void 0 ? void 0 : _b.label) || field.alias,
        type: field.type
      };
    });
  }
  handleInfoClick(event, type) {
    // don't execute the event on the entire tile
    event.stopPropagation();
    this.removeInfoPopover();
    const { props } = this;
    const refElement = type === "join-operation" ? this.joinOperationInfoIconNode : this.joinTypeInfoIconNode;
    this.infoPopoverNode = document.createElement("arcgis-layer-view-join-info-popover");
    this.infoPopoverNode.props = props;
    this.infoPopoverNode.type = type;
    this.infoPopoverNode.referenceElement = refElement;
    this.infoPopoverNode.addEventListener("arcgisLayerViewJoinInfoPopoverClose", (event) => {
      event.stopPropagation();
      this.removeInfoPopover();
      setTimeout(() => refElement.setFocus(), 200);
    });
    this.infoPopoverNode.addEventListener("arcgisLayerViewJoinInfoPopoverDisconnected", (event) => {
      event.stopPropagation();
      this.removeInfoPopover();
    });
    document.body.appendChild(this.infoPopoverNode);
    this.infoPopoverNode.setOpen(true);
    // need to wait until it's all visible
    setTimeout(() => this.infoPopoverNode.setFocus(), 100);
  }
  removeInfoPopover() {
    var _a;
    if (this.infoPopoverNode) {
      (_a = this.infoPopoverNode.parentNode) === null || _a === void 0 ? void 0 : _a.removeChild(this.infoPopoverNode);
      this.infoPopoverNode = null;
    }
  }
  get hostElement() { return (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.d)(this); }
};
ArcgisLayerViewJoinConfig.style = arcgisLayerViewJoinConfigCss;

const CSS$4 = {
  panel: "panel",
  info: "info",
  footer: "footer",
  layerSection: "layer-section",
  targetLayer: "target-layer",
  addLayer: "add-layer",
  layerHeader: "layer-header",
  layerTitle: "layer-title"
};

const arcgisLayerViewJoinCreateCss = ".panel.sc-arcgis-layer-view-join-create{height:100%}.info.sc-arcgis-layer-view-join-create{display:grid;grid-template-columns:repeat(1, minmax(0px, 1fr));gap:0.5rem;padding:0 0.75rem}.footer.sc-arcgis-layer-view-join-create{width:100%}.layer-section.sc-arcgis-layer-view-join-create{border:1px solid var(--calcite-ui-border-3);background-color:white;margin:10px}.target-layer.sc-arcgis-layer-view-join-create{padding:10px;border-bottom:1px solid var(--calcite-ui-border-3)}.add-layer.sc-arcgis-layer-view-join-create{padding:10px}.layer-header.sc-arcgis-layer-view-join-create{padding-bottom:3px}.layer-title.sc-arcgis-layer-view-join-create{font-weight:bold}.notice.sc-arcgis-layer-view-join-create{margin:8px}";

const ArcgisLayerViewJoinCreate = class {
  constructor(hostRef) {
    (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.r)(this, hostRef);
    this.arcgisLayerViewJoinStatusChange = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "arcgisLayerViewJoinStatusChange", 7);
    this.arcgisLayerViewJoinCreateDone = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "arcgisLayerViewJoinCreateDone", 7);
    this.arcgisLayerViewJoinCreateCancel = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "arcgisLayerViewJoinCreateCancel", 7);
    // --------------------------------------------------------------------------
    //
    //  Private methods
    //
    // --------------------------------------------------------------------------
    this.goBack = () => {
      // save last settings
      const { props } = this;
      props.savedItemProps = {
        title: _item_properties_e6412a9a_js__WEBPACK_IMPORTED_MODULE_7__.i.title,
        tags: _item_properties_e6412a9a_js__WEBPACK_IMPORTED_MODULE_7__.i.tags,
        summary: _item_properties_e6412a9a_js__WEBPACK_IMPORTED_MODULE_7__.i.snippet,
        categories: _item_properties_e6412a9a_js__WEBPACK_IMPORTED_MODULE_7__.i.categories,
        folder: _item_properties_e6412a9a_js__WEBPACK_IMPORTED_MODULE_7__.i.folder
      };
      this.arcgisLayerViewJoinStatusChange.emit({
        status: joinFlowStatus.CONFIG
      });
    };
    this.goCreate = async () => {
      const { props, flowItemNode, hostElement } = this;
      const { strings } = props;
      // in case the create call fails
      props.savedItemProps = {
        title: _item_properties_e6412a9a_js__WEBPACK_IMPORTED_MODULE_7__.i.title,
        tags: _item_properties_e6412a9a_js__WEBPACK_IMPORTED_MODULE_7__.i.tags,
        summary: _item_properties_e6412a9a_js__WEBPACK_IMPORTED_MODULE_7__.i.snippet,
        categories: _item_properties_e6412a9a_js__WEBPACK_IMPORTED_MODULE_7__.i.categories,
        folder: _item_properties_e6412a9a_js__WEBPACK_IMPORTED_MODULE_7__.i.folder
      };
      const newItemProps = {
        title: _item_properties_e6412a9a_js__WEBPACK_IMPORTED_MODULE_7__.i.title,
        tags: _item_properties_e6412a9a_js__WEBPACK_IMPORTED_MODULE_7__.i.tags,
        summary: _item_properties_e6412a9a_js__WEBPACK_IMPORTED_MODULE_7__.i.snippet,
        categories: _item_properties_e6412a9a_js__WEBPACK_IMPORTED_MODULE_7__.i.categories,
        folder: _item_properties_e6412a9a_js__WEBPACK_IMPORTED_MODULE_7__.i.folder
      };
      this.loading = true;
      try {
        this.viewItemId = await createJoinView(props, newItemProps);
        this.loading = false;
        this.msgNode = document.createElement("arcgis-layer-view-msg");
        this.msgNode.props = props;
        this.msgNode.flowItemElement = flowItemNode;
        this.msgNode.message = strings.msg.created;
        hostElement.appendChild(this.msgNode);
        clearTimeout(this.timeoutHndl);
        this.timeoutHndl = setTimeout(() => {
          this.timeoutHndl = undefined;
          if (this.msgNode) {
            hostElement.removeChild(this.msgNode);
            this.msgNode = undefined;
            this.arcgisLayerViewJoinCreateDone.emit(this.viewItemId);
          }
        }, 7000);
      }
      catch (e) {
        const { props, flowItemNode } = this;
        const { strings } = props;
        this.loading = false;
        console.error("could not create join view", e);
        this.msgNode = document.createElement("arcgis-layer-view-msg");
        this.msgNode.props = props;
        this.msgNode.flowItemElement = flowItemNode;
        this.msgNode.isError = true;
        this.msgNode.message = strings.msg.createFailed;
        hostElement.appendChild(this.msgNode);
        clearTimeout(this.timeoutHndl);
        this.timeoutHndl = setTimeout(() => {
          this.timeoutHndl = undefined;
          if (this.msgNode) {
            hostElement.removeChild(this.msgNode);
            this.msgNode = undefined;
          }
        }, 7000);
      }
    };
    this.goCancel = () => {
      this.arcgisLayerViewJoinCreateCancel.emit();
    };
    this.props = undefined;
    this.loading = false;
    this.title = undefined;
  }
  arcgisLayerViewMsgClosedHandler() {
    if (this.msgNode) {
      this.hostElement.removeChild(this.msgNode);
      this.msgNode = undefined;
    }
    clearTimeout(this.timeoutHndl);
    this.timeoutHndl = undefined;
    if (this.viewItemId) {
      this.arcgisLayerViewJoinCreateDone.emit(this.viewItemId);
    }
  }
  //--------------------------------------------------------------------------
  //
  //  Lifecycle
  //
  //--------------------------------------------------------------------------
  async componentWillLoad() {
    const { props } = this;
    const { targetLayer, targetLayerId, addLayer, addLayerId } = props;
    this.targetFL = (targetLayer.type === "group"
      ? getLayersAndTables(targetLayer).find((lyr) => lyr.layerId === targetLayerId)
      : targetLayer);
    this.addFL = (addLayer.type === "group"
      ? getLayersAndTables(addLayer).find((lyr) => lyr.layerId === addLayerId)
      : addLayer);
    this.title = await getSuggestedTitleForJoin(props);
  }
  async componentDidLoad() {
    requestAnimationFrame(() => { var _a; return (_a = this.backButtonNode) === null || _a === void 0 ? void 0 : _a.setFocus(); });
  }
  // --------------------------------------------------------------------------
  //
  //  Render Methods
  //
  //--------------------------------------------------------------------------
  render() {
    const { props, loading } = this;
    const { strings } = props;
    const rtl = (0,_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_5__.g)(this.hostElement) === "rtl";
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)(_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.H, { class: "calcite-match-height" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-flow-item", { heading: strings.join.create, loading: loading, class: {
        panel: true,
        [_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_5__.C.rtl]: rtl
      }, ref: (node) => (this.flowItemNode = node) }, this.renderFooterButtons(), this.renderNotice(), this.renderLayers(), this.renderInfo())));
  }
  renderFooterButtons() {
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { slot: "footer", class: CSS$4.footer }, this.renderBack(), this.renderCreate(), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("br", null), this.renderCancel()));
  }
  renderBack() {
    const { props } = this;
    const { strings } = props;
    const isRtl = (0,_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_5__.g)(this.hostElement) === "rtl";
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { onClick: this.goBack, appearance: "outline-fill", width: "half", "icon-start": isRtl ? "arrow-right" : "arrow-left", ref: (node) => (this.backButtonNode = node) }, strings.general.back));
  }
  renderCreate() {
    const { props, title, titleError, summaryError } = this;
    const { strings } = props;
    const enabled = title && !titleError && !summaryError;
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { disabled: !enabled, onClick: enabled && this.goCreate, appearance: "solid", width: "half", "icon-start": "plus-square", ref: (node) => (this.createButtonNode = node) }, strings.createView.create));
  }
  renderCancel() {
    const { props } = this;
    const { strings } = props;
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { onClick: this.goCancel, appearance: "transparent", width: "full" }, strings.general.cancel));
  }
  renderNotice() {
    {
      return;
    }
  }
  renderLayers() {
    const { props, targetFL, addFL } = this;
    const { targetItem, targetLayer, addItem, addLayer, strings } = props;
    const rtl = (0,_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_5__.g)(this.hostElement) === "rtl";
    const targetTitle = targetLayer.type === "group"
      ? rtl
        ? `${targetFL.title} / ${targetItem.title}`
        : `${targetItem.title} / ${targetFL.title}`
      : targetLayer.title;
    const addTitle = addLayer.type === "group"
      ? rtl
        ? `${addFL.title} / ${addItem.title}`
        : `${addItem.title} / ${addFL.title}`
      : addLayer.title;
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS$4.layerSection }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS$4.targetLayer }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS$4.layerHeader }, strings.join.targetLayer), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS$4.layerTitle }, targetTitle)), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS$4.addLayer }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS$4.layerHeader }, strings.join.joinLayer), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS$4.layerTitle }, addTitle))));
  }
  renderInfo() {
    const { props, title } = this;
    const { targetItem, targetItemOwner, savedItemProps } = props;
    const { portal } = targetItem;
    const user = portal.user;
    const config = { portal, user, api: 4 };
    if (savedItemProps) {
      _item_properties_e6412a9a_js__WEBPACK_IMPORTED_MODULE_7__.i.title = savedItemProps.title;
      _item_properties_e6412a9a_js__WEBPACK_IMPORTED_MODULE_7__.i.folder = savedItemProps.folder;
      _item_properties_e6412a9a_js__WEBPACK_IMPORTED_MODULE_7__.i.snippet = savedItemProps.summary || "";
      _item_properties_e6412a9a_js__WEBPACK_IMPORTED_MODULE_7__.i.categories = savedItemProps.categories;
      _item_properties_e6412a9a_js__WEBPACK_IMPORTED_MODULE_7__.i.tags = savedItemProps.tags;
    }
    else {
      _item_properties_e6412a9a_js__WEBPACK_IMPORTED_MODULE_7__.i.title = title;
      _item_properties_e6412a9a_js__WEBPACK_IMPORTED_MODULE_7__.i.folder =
        targetItem.ownerFolder &&
          {
            id: targetItem.ownerFolder,
            username: targetItem.owner
          };
      _item_properties_e6412a9a_js__WEBPACK_IMPORTED_MODULE_7__.i.snippet = targetItem.snippet || "";
      _item_properties_e6412a9a_js__WEBPACK_IMPORTED_MODULE_7__.i.categories = targetItem.categories;
      _item_properties_e6412a9a_js__WEBPACK_IMPORTED_MODULE_7__.i.tags = targetItem.tags;
    }
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS$4.info }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-item-properties", { portal: portal, user: user, api: 4, config: config, type: "Feature Service", scale: "s" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-title-input", { enablePublishing: true, onArcgisTitleInputChange: async (event) => {
        const node = event.target;
        const titleError = await node.validateTitle();
        if ((!this.titleError && titleError) || (this.titleError && !titleError)) {
          (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.hostElement);
        }
        this.titleError = titleError;
      } }), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-folder-picker", { user: targetItemOwner }), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-categories-picker", null), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-tags-picker", null), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-summary-input", { onArcgisSummaryInputChange: async (event) => {
        const node = event.target;
        const summaryError = (await node.getErrorMessage());
        if ((!this.summaryError && summaryError) || (this.summaryError && !summaryError)) {
          (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.hostElement);
        }
        this.summaryError = summaryError;
      } }))));
  }
  get hostElement() { return (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.d)(this); }
};
ArcgisLayerViewJoinCreate.style = arcgisLayerViewJoinCreateCss;

const CSS$3 = {
  flow: "flow",
  panel: "panel",
  footer: "footer",
  info: "info",
  text: "text"
};

const arcgisLayerViewJoinTargetSelectionCss = ".flow{height:100%}.panel{height:100%}.footer{width:100%}.info{pointer-events:none;padding:1rem 0.75rem}.text{font-size:var(--calcite-font-size--2);line-height:1.375;color:var(--calcite-ui-text-3);transition-duration:150ms;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);pointer-events:none}.notice{margin:8px}";

const ArcgisLayerViewJoinTargetSelection = class {
  constructor(hostRef) {
    (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.r)(this, hostRef);
    this.arcgisLayerViewJoinStatusChange = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "arcgisLayerViewJoinStatusChange", 7);
    // --------------------------------------------------------------------------
    //
    //  Private methods
    //
    // --------------------------------------------------------------------------
    this.goNext = () => {
      this.arcgisLayerViewJoinStatusChange.emit({
        status: joinFlowStatus.ADD_SELECTION
      });
    };
    this.onSelectionChange = () => {
      const { props } = this;
      const { targetLayer } = props;
      this.listNode
        .querySelectorAll("calcite-pick-list-item")
        .forEach((item) => {
        if (item.selected) {
          props.targetLayerId = item.value;
          (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.hostElement);
        }
        if (targetLayer.type === "group") {
          getLayersAndTables(targetLayer).find((subLayer) => subLayer.layerId === item.value).visible = item.selected;
        }
        else {
          targetLayer.visible = item.selected;
        }
      });
      props.attributeRelationships = undefined;
      props.joinOperation = undefined;
    };
    this.props = undefined;
    this.status = undefined;
  }
  //--------------------------------------------------------------------------
  //
  //  Lifecycle
  //
  //--------------------------------------------------------------------------
  async componentWillLoad() {
    const { props } = this;
    const { targetLayer } = props;
    if (targetLayer.type !== "group") {
      props.targetLayerId = targetLayer.layerId;
    }
  }
  async componentDidLoad() {
    requestAnimationFrame(() => { var _a; return (_a = this.listNode) === null || _a === void 0 ? void 0 : _a.setFocus(); });
  }
  // --------------------------------------------------------------------------
  //
  //  Render Methods
  //
  //--------------------------------------------------------------------------
  render() {
    //console.log("render target-selection", this.props, "status:", this.status);
    const { props } = this;
    const { targetItem, strings } = props;
    const rtl = (0,_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_5__.g)(this.hostElement) === "rtl";
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)(_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.H, { class: "calcite-match-height" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-flow", { class: CSS$3.flow, dir: (0,_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_5__.g)(this.hostElement) }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-flow-item", { heading: targetItem === null || targetItem === void 0 ? void 0 : targetItem.title, description: strings.join.targetLayer, class: {
        panel: true,
        [_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_5__.C.rtl]: rtl
      }, ref: (node) => (this.flowItemNode = node) }, this.renderFooterButtons(), this.renderOBACMsg(), this.renderInfo(), this.renderSublayers()))));
  }
  renderFooterButtons() {
    const { props } = this;
    const { targetItem, targetLayer, targetLayerId, strings } = props;
    const isRtl = (0,_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_5__.g)(this.hostElement) === "rtl";
    let targetFL;
    if (targetLayer.type === "group" && (0,_commonFunctions_5262b094_js__WEBPACK_IMPORTED_MODULE_3__.i)(targetLayerId)) {
      targetFL = getLayersAndTables(targetLayer).find((lyr) => targetLayerId === lyr.layerId);
    }
    else if (targetLayer.type !== "group") {
      targetFL = targetLayer;
    }
    const nextDisabled = !(0,_commonFunctions_5262b094_js__WEBPACK_IMPORTED_MODULE_3__.i)(targetLayerId) || (targetItem.portal.isPortal && hasOBAC(targetFL));
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { slot: "footer", class: CSS$3.footer }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { disabled: nextDisabled, onClick: !nextDisabled && this.goNext, appearance: "solid", width: "full", iconEnd: isRtl ? "arrow-left" : "arrow-right", ref: (node) => (this.nextButtonNode = node) }, strings.general.next)));
  }
  renderOBACMsg() {
    const { props } = this;
    const { config, targetItem, targetLayerId, targetLayer, strings } = props;
    const { helpBase, helpMap } = config;
    if (!targetItem.portal.isPortal) {
      // message only for Enterprise
      return;
    }
    let targetFL;
    if (targetLayer.type === "group" && (0,_commonFunctions_5262b094_js__WEBPACK_IMPORTED_MODULE_3__.i)(targetLayerId)) {
      targetFL = getLayersAndTables(targetLayer).find((lyr) => targetLayerId === lyr.layerId);
    }
    else if (targetLayer.type !== "group") {
      targetFL = targetLayer;
    }
    else {
      // no group sublayer selected yet
      return;
    }
    if (!hasOBAC(targetFL)) {
      return;
    }
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-notice", { key: `${hasOBAC(targetFL)}`, class: "notice", open: true, closable: false, scale: "s", width: "auto", kind: "warning", icon: "exclamation-mark-triangle" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { slot: "message" }, strings.join.obacNotSupportedMsg), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-link", { slot: "link", title: strings.join.learnMore, target: "_blank", href: `${helpBase}${helpMap["120004184"]}` }, strings.join.learnMore)));
  }
  renderInfo() {
    const { props } = this;
    const { strings } = props;
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS$3.info }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS$3.text }, strings.join.selectTargetLayerPanelDescription)));
  }
  renderSublayers() {
    var _a, _b;
    const { props } = this;
    const { targetLayer } = props;
    const listItems = [];
    if (targetLayer.type === "group") {
      (_a = targetLayer.tables) === null || _a === void 0 ? void 0 : _a.forEach((lyr) => {
        listItems.unshift(this.renderSublayer(lyr));
      });
      (_b = targetLayer.layers) === null || _b === void 0 ? void 0 : _b.forEach((lyr) => {
        listItems.unshift(this.renderSublayer(lyr));
      });
    }
    else {
      listItems.push(this.renderSublayer(targetLayer));
    }
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-pick-list", { multiple: false, onCalciteListChange: this.onSelectionChange, ref: (node) => (this.listNode = node) }, listItems));
  }
  renderSublayer(lyr) {
    const { props } = this;
    const { targetLayerId } = props;
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-pick-list-item", { key: lyr.layerId, label: lyr.title, value: lyr.layerId, description: getLayerType(lyr, props), selected: targetLayerId === lyr.layerId }));
  }
  get hostElement() { return (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.d)(this); }
};
ArcgisLayerViewJoinTargetSelection.style = arcgisLayerViewJoinTargetSelectionCss;

const ArcgisLayerViewCreate = class {
  constructor(hostRef) {
    (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.r)(this, hostRef);
    this.arcgisLayerViewMsgClosed = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "arcgisLayerViewMsgClosed", 7);
    this.props = undefined;
    this.flowItemElement = undefined;
    this.isError = false;
    this.isWarning = false;
    this.message = undefined;
    this.closeWithOK = undefined;
  }
  //--------------------------------------------------------------------------
  //
  //  Lifecycle
  //
  //--------------------------------------------------------------------------
  async componentDidLoad() {
    if (this.flowItemElement) {
      this.flowItemElement.disabled = true;
    }
    requestAnimationFrame(() => { var _a; return (_a = this.okNode) === null || _a === void 0 ? void 0 : _a.setFocus(); });
  }
  disconnectedCallback() {
    if (this.flowItemElement) {
      this.flowItemElement.disabled = false;
    }
  }
  // --------------------------------------------------------------------------
  //
  //  Render Methods
  //
  //--------------------------------------------------------------------------
  render() {
    const { props, hostElement, flowItemElement, isError, isWarning, message, closeWithOK } = this;
    const { strings } = props;
    const dir = (0,_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_5__.g)(hostElement);
    const panelWidth = Math.round(flowItemElement.getBoundingClientRect().width);
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)(_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.H, { class: "js-app-flyout" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-popover", { dir: dir, placement: "trailing-start", open: true, pointerDisabled: true, referenceElement: flowItemElement, offsetDistance: -1 * (panelWidth - 10), offsetSkidding: 200, label: message, style: {
        zIndex: "100",
        width: `${panelWidth - 20}px`
      } }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-notice", { scale: "s", width: "full", open: true, closable: !closeWithOK, icon: isError || isWarning ? "exclamation-mark-triangle" : "check-circle", kind: isError ? "danger" : isWarning ? "warning" : "success", onCalciteNoticeClose: () => {
        this.arcgisLayerViewMsgClosed.emit();
      } }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { slot: "title" }, isError ? strings.msg.error : isWarning ? strings.msg.warning : strings.msg.success), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { slot: "message", ref: (node) => {
        // must use div and ref, otherwise <b> inside the string doesn't work
        node.innerHTML = message;
      } }), closeWithOK && ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { appearance: "transparent", slot: "actions-end", onClick: () => {
        this.arcgisLayerViewMsgClosed.emit();
      }, ref: (node) => (this.okNode = node) }, strings.msg.ok))))));
  }
  get hostElement() { return (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.d)(this); }
};

const CSS$2 = {
  flow: "flow",
  panel: "panel",
  info: "info",
  infoDescription: "info-description",
  hasDefinitionIcon: "has-definition-icon",
  definitionIcon: "definition-icon",
  footer: "footer",
  footerTop: "footer-top"
};

const arcgisLayerViewOverviewCss = ".flow.sc-arcgis-layer-view-overview{height:100%}.panel.sc-arcgis-layer-view-overview{height:100%}.info.sc-arcgis-layer-view-overview{display:grid;grid-template-columns:repeat(1, minmax(0px, 1fr));gap:0.5rem;pointer-events:none;padding:1rem 0.75rem}.info-description.sc-arcgis-layer-view-overview{font-size:var(--calcite-font-size--2);line-height:1.375;color:var(--calcite-ui-text-3);transition-duration:150ms;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);pointer-events:none}.has-definition-icon.sc-arcgis-layer-view-overview{color:var(--calcite-ui-border-1);cursor:pointer}.definition-icon.sc-arcgis-layer-view-overview{color:var(--calcite-ui-text-2);cursor:pointer}.footer.sc-arcgis-layer-view-overview{width:100%}.footer-top.sc-arcgis-layer-view-overview{display:flex}";

const ArcgisLayerViewOverview = class {
  constructor(hostRef) {
    (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.r)(this, hostRef);
    this.arcgisLayerViewStatusChange = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "arcgisLayerViewStatusChange", 7);
    this.arcgisLayerViewOverviewUpdated = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "arcgisLayerViewOverviewUpdated", 7);
    this.arcgisLayerViewOverviewCancel = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "arcgisLayerViewOverviewCancel", 7);
    this.listItemNodes = [];
    // --------------------------------------------------------------------------
    //
    //  Private methods
    //
    // --------------------------------------------------------------------------
    this.goBack = () => {
      this.arcgisLayerViewStatusChange.emit({ status: flowStatus.SELECTION });
    };
    this.goNext = () => {
      this.arcgisLayerViewStatusChange.emit({ status: flowStatus.CREATE });
    };
    this.goUpdate = async () => {
      const { props, hostElement } = this;
      const { strings } = props;
      const showSuccessMsg = () => {
        this.msgNode = document.createElement("arcgis-layer-view-msg");
        this.msgNode.props = props;
        this.msgNode.flowItemElement = this.flowItemNode;
        this.msgNode.message = strings.msg.updated;
        hostElement.appendChild(this.msgNode);
        clearTimeout(this.timeoutHndl);
        this.timeoutHndl = setTimeout(() => {
          this.timeoutHndl = undefined;
          if (this.msgNode) {
            hostElement.removeChild(this.msgNode);
            this.msgNode = undefined;
            this.arcgisLayerViewOverviewUpdated.emit();
          }
        }, 7000);
      };
      const hasAnyChanges = hasChanges(props);
      if (!hasAnyChanges) {
        showSuccessMsg();
        return;
      }
      this.loading = true;
      try {
        // update view
        await updateView(this.props);
        // max-age cache is 30 sec; might not get the latest
        await this.getLatestAdminServiceInfo();
        if (hasChanges(this.props)) {
          // wait up to 30 sec with increasing interval
          // and make other adminServiceInfo requests
          // until we really have the latest
          let waitTime = 1000;
          const tryAgain = async () => {
            var _a, _b;
            await this.getLatestAdminServiceInfo();
            if (!hasChanges(this.props) || waitTime > 30000) {
              // need to get latest saved AOI because it rounds coordinates when saving
              (_b = (_a = this.props.adminServiceInfo) === null || _a === void 0 ? void 0 : _a.layers) === null || _b === void 0 ? void 0 : _b.forEach(async (layerInfo) => {
                var _a, _b, _c, _d;
                const aoiValue = (_d = (_c = (_b = (_a = layerInfo.adminLayerInfo) === null || _a === void 0 ? void 0 : _a.viewLayerDefinition) === null || _b === void 0 ? void 0 : _b.table) === null || _c === void 0 ? void 0 : _c.filter) === null || _d === void 0 ? void 0 : _d.value;
                if (aoiValue) {
                  addViewLayerProps(layerInfo.id, {
                    aoi: JSON.parse(JSON.stringify(aoiValue.geometry))
                  }, this.props);
                }
              });
            }
            else {
              waitTime *= 2;
              setTimeout(tryAgain, waitTime);
            }
          };
          setTimeout(tryAgain, waitTime);
        }
        this.loading = false;
        showSuccessMsg();
      }
      catch (e) {
        const { strings } = props;
        this.loading = false;
        console.error("could not create view", e);
        this.msgNode = document.createElement("arcgis-layer-view-msg");
        this.msgNode.props = props;
        this.msgNode.flowItemElement = this.flowItemNode;
        this.msgNode.isError = true;
        this.msgNode.message = strings.msg.updateFailed;
        hostElement.appendChild(this.msgNode);
        clearTimeout(this.timeoutHndl);
        this.timeoutHndl = setTimeout(() => {
          this.timeoutHndl = undefined;
          if (this.msgNode) {
            hostElement.removeChild(this.msgNode);
            this.msgNode = undefined;
          }
        }, 7000);
      }
    };
    this.goCancel = () => {
      this.arcgisLayerViewOverviewCancel.emit();
    };
    this.props = undefined;
    this.status = undefined;
    this.reRender = false;
    this.loading = false;
  }
  arcgisLayerViewOverviewRefreshHandler() {
    this.status = flowStatus.OVERVIEW;
    this.reRender = !this.reRender;
  }
  arcgisLayerViewMsgClosedHandler() {
    const { props } = this;
    const { strings } = props;
    if (this.msgNode) {
      if (this.msgNode.message === strings.msg.updated) {
        this.arcgisLayerViewOverviewUpdated.emit();
      }
      this.hostElement.removeChild(this.msgNode);
      this.msgNode = undefined;
    }
    clearTimeout(this.timeoutHndl);
    this.timeoutHndl = undefined;
  }
  //--------------------------------------------------------------------------
  //
  //  Lifecycle
  //
  //--------------------------------------------------------------------------
  async componentWillLoad() { }
  async componentDidLoad() {
    requestAnimationFrame(() => { var _a; return (_a = this.backButtonNode) === null || _a === void 0 ? void 0 : _a.setFocus(); });
  }
  // --------------------------------------------------------------------------
  //
  //  Render Methods
  //
  //--------------------------------------------------------------------------
  render() {
    //console.log("render view-overview", propsToString(this.props));
    const { props, status, loading } = this;
    const { viewItem, layerItem, strings } = props;
    const rtl = (0,_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_5__.g)(this.hostElement) === "rtl";
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)(_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.H, { class: "calcite-match-height" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-flow", { class: CSS$2.flow, dir: (0,_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_5__.g)(this.hostElement) }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-flow-item", { key: status, heading: strings.general.includedLayerPanelTitle, description: (viewItem === null || viewItem === void 0 ? void 0 : viewItem.title) || (layerItem === null || layerItem === void 0 ? void 0 : layerItem.title), loading: loading, class: {
        panel: true,
        [_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_5__.C.rtl]: rtl
      }, ref: (node) => (this.flowItemNode = node) }, this.renderFooterButtons(), this.renderInfo(), this.renderSublayers()), [flowStatus.DEFINITION, flowStatus.FILTER].includes(status)
      ? this.renderLayerDefinition()
      : null)));
  }
  renderFooterButtons() {
    const { props } = this;
    const { viewItem } = props;
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { slot: "footer", class: CSS$2.footer }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS$2.footerTop }, this.renderBack(), viewItem ? this.renderUpdate() : this.renderNext()), viewItem ? this.renderCancel() : null));
  }
  renderBack() {
    const { props } = this;
    const { strings } = props;
    const isRtl = (0,_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_5__.g)(this.hostElement) === "rtl";
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { slot: "footer", onClick: this.goBack, appearance: "outline-fill", width: "half", "icon-start": isRtl ? "arrow-right" : "arrow-left", ref: (node) => (this.backButtonNode = node) }, strings.general.back));
  }
  renderNext() {
    const { props } = this;
    const { strings } = props;
    const isRtl = (0,_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_5__.g)(this.hostElement) === "rtl";
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { slot: "footer", onClick: this.goNext, appearance: "solid", width: "half", iconEnd: isRtl ? "arrow-left" : "arrow-right", ref: (node) => (this.nextButtonNode = node) }, strings.general.next));
  }
  renderUpdate() {
    const { props } = this;
    const { strings } = props;
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { slot: "footer", onClick: this.goUpdate, appearance: "solid", width: "half", "icon-start": "plus-square", ref: (node) => (this.nextButtonNode = node) }, strings.general.update));
  }
  renderCancel() {
    const { props } = this;
    const { layer, layerIds, strings } = props;
    const enabled = (layer === null || layer === void 0 ? void 0 : layer.loaded) && layerIds.length;
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { disabled: !enabled, onClick: enabled && this.goCancel, appearance: "transparent", width: "full" }, strings.general.close));
  }
  renderInfo() {
    const { props } = this;
    const { strings } = props;
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "info" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS$2.infoDescription }, strings.general.includedLayerPanelDescription)));
  }
  renderSublayers() {
    var _a, _b;
    const { props } = this;
    const { layer, layerIds } = props;
    const listItems = [];
    if (layer.type === "group") {
      (_a = layer.tables) === null || _a === void 0 ? void 0 : _a.forEach((lyr) => {
        if (layerIds.includes(lyr.layerId)) {
          listItems.unshift(this.renderSublayer(lyr));
        }
      });
      (_b = layer.layers) === null || _b === void 0 ? void 0 : _b.forEach((lyr) => {
        if (layerIds.includes(lyr.layerId)) {
          listItems.unshift(this.renderSublayer(lyr));
        }
      });
    }
    else {
      listItems.push(this.renderSublayer(layer));
    }
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-list", { ref: (node) => (this.listNode = node) }, listItems));
  }
  renderSublayer(fl) {
    const { props } = this;
    const { strings } = props;
    const isRtl = (0,_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_5__.g)(this.hostElement) === "rtl";
    const viewLayerProps = getViewLayerProps(fl.layerId, props);
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-list-item", { key: fl.layerId, label: fl.title, description: fl.isTable ? strings.general.table : strings.general.layer, onClick: this.goDefinition.bind(this, fl.layerId), ref: (node) => {
        if (node) {
          this.listItemNodes[fl.layerId] = node;
        } // not sure why it's null sometimes
      } }, !!viewLayerProps ? ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-icon", { class: CSS$2.hasDefinitionIcon, slot: "content-end", icon: "sliders", scale: "s" })) : null, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-icon", { class: CSS$2.definitionIcon, slot: "content-end", icon: isRtl ? "chevron-left" : "chevron-right", scale: "s" })));
  }
  renderLayerDefinition() {
    const { props, status } = this;
    const { definitionLayerId } = props;
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-layer-view-definition", { key: `definition-${definitionLayerId}`, props: props, status: status, class: "calcite-match-height", onArcgisLayerViewOverViewRefresh: () => setTimeout(() => { var _a; return (_a = this.listItemNodes[definitionLayerId]) === null || _a === void 0 ? void 0 : _a.setFocus(); }, 200) }));
  }
  goDefinition(layerId) {
    const { props } = this;
    this.status = flowStatus.DEFINITION;
    props.definitionLayerId = layerId;
    this.reRender = !this.reRender;
  }
  async getLatestAdminServiceInfo() {
    this.props.adminServiceInfo = undefined;
    await getAdminServiceInfo$1(this.props, true);
    /* console.log(
      "updated view adminServiceInfo",
      this.props.adminServiceInfo?.layers?.map((lyr: any) => {
        return {
          id: lyr.id,
          name: lyr.name,
          adminLayerInfo_filter: lyr.adminLayerInfo?.viewLayerDefinition?.table?.filter?.value,
          viewDefinitionQuery: lyr.viewDefinitionQuery,
          fields: lyr.fields.map((field: any) => `${field.name} (${field.visible})`)
        };
      }),
      this.props.adminServiceInfo?.tables?.map((lyr: any) => {
        return {
          id: lyr.id,
          name: lyr.name,
          viewDefinitionQuery: lyr.viewDefinitionQuery,
          fields: lyr.fields.map((field: any) => `${field.name} (${field.visible})`)
        };
      })
    ); */
    this.reRender = !this.reRender;
  }
  get hostElement() { return (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.d)(this); }
};
ArcgisLayerViewOverview.style = arcgisLayerViewOverviewCss;

const CSS$1 = {
  flow: "flow",
  panel: "panel",
  footer: "footer",
  info: "info",
  infoHeading: "info-heading",
  infoDescription: "info-description",
  fixedListItem: "fixed-list-item"
};

const arcgisLayerViewSelectionCss = ".flow.sc-arcgis-layer-view-selection{height:100%}.panel.sc-arcgis-layer-view-selection{height:100%}.footer.sc-arcgis-layer-view-selection{width:100%}.info.sc-arcgis-layer-view-selection{display:grid;grid-template-columns:repeat(1, minmax(0px, 1fr));gap:0.5rem;pointer-events:none;padding:1rem 0.75rem}.info-heading.sc-arcgis-layer-view-selection{font-size:var(--calcite-font-size--1);line-height:1.375;color:var(--calcite-ui-text-2);transition-duration:150ms;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);font-weight:var(--calcite-font-weight-medium);pointer-events:none}.info-description.sc-arcgis-layer-view-selection{font-size:var(--calcite-font-size--2);line-height:1.375;color:var(--calcite-ui-text-3);transition-duration:150ms;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);pointer-events:none}.fixed-list-item.sc-arcgis-layer-view-selection{margin-bottom:10px}";

const ArcgisLayerViewSelection = class {
  constructor(hostRef) {
    (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.r)(this, hostRef);
    this.arcgisLayerViewStatusChange = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "arcgisLayerViewStatusChange", 7);
    this.arcgisLayerViewSelectionCancel = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "arcgisLayerViewSelectionCancel", 7);
    // --------------------------------------------------------------------------
    //
    //  Private methods
    //
    // --------------------------------------------------------------------------
    this.goNext = () => {
      const { props } = this;
      const { layerIds } = props;
      this.arcgisLayerViewStatusChange.emit({
        status: flowStatus.OVERVIEW,
        layerIds
      });
    };
    this.goSwapSource = () => {
      const { props } = this;
      const { layerIds } = props;
      this.arcgisLayerViewStatusChange.emit({
        status: flowStatus.SWAP_SOURCE,
        layerIds
      });
    };
    this.onSelectionChange = () => {
      const { props, hostElement } = this;
      const { layer, strings } = props;
      const layerIds = [];
      this.listNode
        .querySelectorAll("calcite-pick-list-item")
        .forEach((item) => {
        if (item.selected) {
          layerIds.push(item.value);
        }
        if (layer.type === "group") {
          getLayersAndTables(layer).find((subLayer) => subLayer.layerId === item.value).visible = item.selected;
        }
        else {
          layer.visible = item.selected;
        }
      });
      if (layerIds.length) {
        this.props.layerIds = layerIds;
      }
      else {
        // must have at least one layer selected
        this.msgNode = document.createElement("arcgis-layer-view-msg");
        this.msgNode.props = props;
        this.msgNode.flowItemElement = this.flowItemNode;
        this.msgNode.message = strings.msg.atLeastOne;
        this.msgNode.isWarning = true;
        hostElement.appendChild(this.msgNode);
        clearTimeout(this.timeoutHndl);
        this.timeoutHndl = setTimeout(() => {
          this.timeoutHndl = undefined;
          if (this.msgNode) {
            hostElement.removeChild(this.msgNode);
            this.msgNode = undefined;
            this.reRender = !this.reRender;
          }
        }, 7000);
        // check that last list item again
        this.listNode
          .querySelectorAll("calcite-pick-list-item")
          .forEach((item) => {
          if (props.layerIds.indexOf(item.value) > -1) {
            item.selected = true;
          }
        });
      }
      this.reRender = !this.reRender;
    };
    this.props = undefined;
    this.status = undefined;
    this.reRender = false;
  }
  arcgisLayerViewMsgClosedHandler() {
    if (this.msgNode) {
      this.hostElement.removeChild(this.msgNode);
      this.msgNode = undefined;
    }
    clearTimeout(this.timeoutHndl);
    this.timeoutHndl = undefined;
    this.reRender = !this.reRender;
  }
  //--------------------------------------------------------------------------
  //
  //  Lifecycle
  //
  //--------------------------------------------------------------------------
  async componentWillLoad() { }
  async componentDidLoad() {
    const { props } = this;
    const { derivativeLayers } = props;
    if (derivativeLayers.hasAny) {
      requestAnimationFrame(() => { var _a; return (_a = this.swapButtonNode) === null || _a === void 0 ? void 0 : _a.setFocus(); });
    }
    else {
      requestAnimationFrame(() => { var _a; return (_a = this.listNode) === null || _a === void 0 ? void 0 : _a.setFocus(); });
    }
  }
  // --------------------------------------------------------------------------
  //
  //  Render Methods
  //
  //--------------------------------------------------------------------------
  render() {
    //console.log("render view-selection", propsToString(this.props), "status:", this.status);
    const { props, status } = this;
    const { viewItem, layerItem, strings } = props;
    const rtl = (0,_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_5__.g)(this.hostElement) === "rtl";
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)(_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.H, { class: "calcite-match-height" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-flow", { class: CSS$1.flow, dir: (0,_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_5__.g)(this.hostElement) }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-flow-item", { heading: (viewItem === null || viewItem === void 0 ? void 0 : viewItem.title) || (layerItem === null || layerItem === void 0 ? void 0 : layerItem.title), description: strings.general.sourceLayer, class: {
        panel: true,
        [_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_5__.C.rtl]: rtl
      }, ref: (node) => (this.flowItemNode = node) }, this.renderFooterButtons(), this.renderInfo(), this.renderSublayers()), [flowStatus.SWAP_SOURCE, flowStatus.BROWSE_LAYER].includes(status)
      ? this.renderSwapSource()
      : null)));
  }
  renderFooterButtons() {
    const { props } = this;
    const { layer, layerIds, viewItem, derivativeLayers, hasReplicas, strings } = props;
    const isRtl = (0,_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_5__.g)(this.hostElement) === "rtl";
    const isVelocityView = (viewItem === null || viewItem === void 0 ? void 0 : viewItem.typeKeywords.indexOf("IoTFeatureLayer")) > -1;
    const hasSwapRights = !isVelocityView && ["admin", "update"].indexOf(viewItem === null || viewItem === void 0 ? void 0 : viewItem.itemControl) > -1;
    const nextEnabled = (layer === null || layer === void 0 ? void 0 : layer.loaded) && layerIds.length && !derivativeLayers.hasAny;
    if (hasSwapRights && derivativeLayers.hasAny) {
      return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { slot: "footer", class: "footer" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { onClick: !hasReplicas && this.goSwapSource, disabled: hasReplicas, appearance: "solid", width: "full", iconStart: "arrow-right-left", ref: (node) => (this.swapButtonNode = node) }, strings.general.swapSource), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { onClick: () => this.arcgisLayerViewSelectionCancel.emit(), appearance: "transparent", width: "full" }, strings.general.close)));
    }
    else {
      return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { slot: "footer", class: "footer" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { disabled: !nextEnabled, onClick: nextEnabled && this.goNext, appearance: "solid", width: "full", iconEnd: isRtl ? "arrow-left" : "arrow-right", ref: (node) => (this.nextButtonNode = node) }, strings.general.next), hasSwapRights && ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", null, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { disabled: !nextEnabled || hasReplicas, onClick: nextEnabled && !hasReplicas && this.goSwapSource, appearance: "transparent", width: "full", iconStart: "arrow-right-left", ref: (node) => (this.swapButtonNode = node) }, strings.general.swapSource)))));
    }
  }
  renderInfo() {
    const { props } = this;
    const { viewItem, derivativeLayers, hasReplicas, strings } = props;
    const hasSwapRights = ["admin", "update"].indexOf(viewItem === null || viewItem === void 0 ? void 0 : viewItem.itemControl) > -1;
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "info" }, derivativeLayers.hasAny ? ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-notice", { scale: "s", width: "full", open: true, icon: "information" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { slot: "message" }, strings.general.derivativeLayerNotice))) : null, hasReplicas && hasSwapRights ? ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-notice", { scale: "s", width: "full", open: true, icon: "information" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { slot: "message" }, strings.general.selectLayerPanelReplicaNotice))) : null, !derivativeLayers.hasAny ? ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", null, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS$1.infoHeading }, strings.general.selectLayerPanelTitle), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS$1.infoDescription }, strings.general.selectLayerPanelDescription))) : null));
  }
  renderSublayers() {
    const { props } = this;
    const { derivativeLayers } = props;
    if (derivativeLayers.hasAny) {
      return this.renderNonEditableSublayers();
    }
    else {
      return this.renderEditableSublayers();
    }
  }
  renderNonEditableSublayers() {
    var _a, _b;
    const { props } = this;
    const { layer, layerIds, strings } = props;
    const layerListItems = [];
    const tableListItems = [];
    if (layer.type === "group") {
      (_a = layer.tables) === null || _a === void 0 ? void 0 : _a.forEach((lyr) => {
        if (layerIds.indexOf(lyr.layerId) > -1) {
          tableListItems.unshift(this.renderNonEditableSublayer(lyr));
        }
      });
      (_b = layer.layers) === null || _b === void 0 ? void 0 : _b.forEach((lyr) => {
        if (layerIds.indexOf(lyr.layerId) > -1) {
          layerListItems.unshift(this.renderNonEditableSublayer(lyr));
        }
      });
    }
    else {
      (layer.isTable ? tableListItems : layerListItems).push(this.renderNonEditableSublayer(layer));
    }
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS$1.info }, layerListItems.length > 0 ? ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS$1.infoHeading }, strings.general.layers)) : null, layerListItems.length > 0 ? (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("ul", null, layerListItems) : null, tableListItems.length > 0 ? ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS$1.infoHeading }, strings.general.tables)) : null, tableListItems.length > 0 ? (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("ul", null, tableListItems) : null));
  }
  renderNonEditableSublayer(lyr) {
    return (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("li", { class: CSS$1.fixedListItem }, lyr.title);
  }
  renderEditableSublayers() {
    var _a, _b;
    const { props } = this;
    const { layer } = props;
    const listItems = [];
    if (layer.type === "group") {
      (_a = layer.tables) === null || _a === void 0 ? void 0 : _a.forEach((lyr) => {
        listItems.unshift(this.renderEditableSublayer(lyr));
      });
      (_b = layer.layers) === null || _b === void 0 ? void 0 : _b.forEach((lyr) => {
        listItems.unshift(this.renderEditableSublayer(lyr));
      });
    }
    else {
      listItems.push(this.renderEditableSublayer(layer));
    }
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-pick-list", { multiple: true, onCalciteListChange: this.onSelectionChange, ref: (node) => (this.listNode = node) }, listItems));
  }
  renderEditableSublayer(lyr) {
    const { props } = this;
    const { layerIds, strings } = props;
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-pick-list-item", { key: lyr.layerId, label: lyr.title, value: lyr.layerId, description: lyr.isTable ? strings.general.table : strings.general.layer, selected: layerIds.indexOf(lyr.layerId) > -1 }));
  }
  renderSwapSource() {
    const { props, status } = this;
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-layer-view-swap-source", {
      //key={`selection-${status}`}
      props: props, status: status, onArcgisLayerViewStatusChange: () => setTimeout(() => { var _a; return (_a = this.flowItemNode) === null || _a === void 0 ? void 0 : _a.setFocus(); }, 200)
    }));
  }
  get hostElement() { return (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.d)(this); }
};
ArcgisLayerViewSelection.style = arcgisLayerViewSelectionCss;

const CSS = {
  panel: "panel",
  browse: "browse",
  info: "info",
  text: "text",
  check: "check",
  checkText: "check-text",
  footerButton: "footer-button"
};

const arcgisLayerViewSwapSourceCss = ".panel.sc-arcgis-layer-view-swap-source{height:100%}.browse.sc-arcgis-layer-view-swap-source{width:100%}.info.sc-arcgis-layer-view-swap-source{margin:10px}.text.sc-arcgis-layer-view-swap-source{margin-bottom:8px}.check.sc-arcgis-layer-view-swap-source{color:green}.check-text.sc-arcgis-layer-view-swap-source{font-weight:bold}.footer-button.sc-arcgis-layer-view-swap-source{margin:0 10px 5px 10px}";

const ArcgisLayerViewSwapSource = class {
  constructor(hostRef) {
    (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.r)(this, hostRef);
    this.arcgisLayerViewStatusChange = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "arcgisLayerViewStatusChange", 7);
    // --------------------------------------------------------------------------
    //
    //  Private methods
    //
    // --------------------------------------------------------------------------
    this.onBack = () => {
      this.arcgisLayerViewStatusChange.emit({ status: flowStatus.SELECTION });
    };
    this.goBrowse = () => {
      this.arcgisLayerViewStatusChange.emit({ status: flowStatus.BROWSE_LAYER });
    };
    this.props = undefined;
    this.status = undefined;
    this.reRender = false;
    this.loading = false;
  }
  //--------------------------------------------------------------------------
  //
  //  Lifecycle
  //
  //--------------------------------------------------------------------------
  async componentDidLoad() {
    // requestAnimationFrame nor working the second time...
    setTimeout(() => requestAnimationFrame(() => { var _a; return (_a = this.flowItemNode) === null || _a === void 0 ? void 0 : _a.setFocus(); }), 200);
  }
  // --------------------------------------------------------------------------
  //
  //  Render Methods
  //
  //--------------------------------------------------------------------------
  render() {
    //console.log("render swap-source", propsToString(this.props), "status", this.status);
    const { props, status, loading } = this;
    const { strings } = props;
    const rtl = (0,_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_5__.g)(this.hostElement) === "rtl";
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)(_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.H, { class: "calcite-match-height" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-flow-item", { key: status, heading: strings.swapSource.title, description: strings.swapSource.subTitle, loading: loading, class: {
        panel: true,
        [_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_5__.C.rtl]: rtl
      }, onCalciteFlowItemBack: this.onBack, ref: (node) => (this.flowItemNode = node) }, this.renderInfo(), this.renderDerivativeInfo(), this.renderBrowse()), status === flowStatus.BROWSE_LAYER && this.renderBrowseLayer()));
  }
  renderInfo() {
    const { props } = this;
    const { strings } = props;
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS.info }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS.text }, strings.swapSource.msg1), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS.text }, strings.swapSource.msg2), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-label", { layout: "inline" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-icon", { icon: "check", class: CSS.check }), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("span", { class: CSS.checkText }, strings.swapSource.requirement1)), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-label", { layout: "inline" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-icon", { icon: "check", class: CSS.check }), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("span", { class: CSS.checkText }, strings.swapSource.requirement2)), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-label", { layout: "inline" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-icon", { icon: "check", class: CSS.check }), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("span", { class: CSS.checkText }, strings.swapSource.requirement3)), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS.text }, strings.swapSource.msg3)));
  }
  renderDerivativeInfo() {
    const { props } = this;
    const { derivativeLayers, strings } = props;
    if (!derivativeLayers.hasMS && !derivativeLayers.hasVTL && !derivativeLayers.hasScene) {
      return null;
    }
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS.info }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS.text }, strings.swapSource.derivativeMsg)));
  }
  renderBrowse() {
    const { props } = this;
    const { strings } = props;
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS.footerButton }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { id: "arcgis-layer-view-swap-source-browse", onClick: this.goBrowse, appearance: "outline-fill", width: "full", ref: (node) => (this.browseButtonNode = node) }, strings.swapSource.browseForLayer)));
  }
  renderBrowseLayer() {
    const { props } = this;
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-layer-view-browse-layer", { props: props, class: CSS.browse, onArcgisLayerViewStatusChange: (event) => {
        if (event.detail.status === flowStatus.SWAP_SOURCE) {
          // can't make it work without using an id
          // it seems the whole component reloads from scratch after this step here
          setTimeout(() => {
            var _a;
            return (_a = document.getElementById("arcgis-layer-view-swap-source-browse")) === null || _a === void 0 ? void 0 : _a.setFocus();
          }, 400);
        }
      } }));
  }
  get hostElement() { return (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.d)(this); }
};
ArcgisLayerViewSwapSource.style = arcgisLayerViewSwapSourceCss;




/***/ }),

/***/ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/functional-c82f5ab9.js":
/*!****************************************************************************************************************!*\
  !*** ./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/functional-c82f5ab9.js ***!
  \****************************************************************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   a: () => (/* binding */ arrayToLookupMap),
/* harmony export */   b: () => (/* binding */ unique),
/* harmony export */   c: () => (/* binding */ throttle),
/* harmony export */   d: () => (/* binding */ debounce),
/* harmony export */   e: () => (/* binding */ escapeRegExp),
/* harmony export */   f: () => (/* binding */ arraysAreEquivalent),
/* harmony export */   g: () => (/* binding */ chunk),
/* harmony export */   i: () => (/* binding */ isDefined),
/* harmony export */   m: () => (/* binding */ minDelay),
/* harmony export */   t: () => (/* binding */ timeout),
/* harmony export */   u: () => (/* binding */ uniqueBy)
/* harmony export */ });
/*!
 * All material copyright ESRI, All Rights Reserved, unless otherwise specified.
 * v3.0.99
 */
/**
 * Call a function only after it has not been called for n milliseconds
 * @param fn    - function to call
 * @param delay - delay in milliseconds
 */
const debounce = (fn, delay) => {
  let timeout;
  let status = "idle";
  function flush(...args) {
    status = "flushed";
    return debounced(...args);
  }
  function invoke(...args) {
    status = "invoked";
    return debounced(...args);
  }
  function cancel(...args) {
    status = "cancelled";
    return debounced(...args);
  }
  function getStatus() {
    return status;
  }
  const debounced = (...args) => new Promise((resolve) => {
    switch (status) {
      case "flushed":
        status = "idle";
        if (timeout) {
          clearTimeout(timeout);
          resolve(fn(...args));
        }
        else {
          resolve(null);
        }
        break;
      case "invoked":
        clearTimeout(timeout);
        status = "idle";
        resolve(fn(...args));
        break;
      case "cancelled":
        clearTimeout(timeout);
        status = "idle";
        resolve(null);
        break;
      default:
        if (timeout) {
          clearTimeout(timeout);
        }
        status = "pending";
        timeout = setTimeout(() => {
          status = "idle";
          return resolve(fn(...args));
        }, delay);
        break;
    }
  });
  debounced.flush = flush;
  debounced.invoke = invoke;
  debounced.cancel = cancel;
  debounced.getStatus = getStatus;
  return debounced;
};
/**
 * Call a function only after n milliseconds have elapsed
 * @param fn    - function to call
 * @param delay - delay in milliseconds
 */
const throttle = (fn, delay) => {
  let timeout;
  return (...args) => new Promise((resolve) => {
    if (timeout) {
      return;
    }
    timeout = setTimeout(() => {
      clearTimeout(timeout);
      timeout = undefined;
      resolve(fn(...args));
    }, delay);
  });
};
function escapeRegExp(str) {
  return str.replace(/[.*+?^${}()|[\]\\]/g, "\\$&"); // $& means the whole matched string
}
function isDefined(value) {
  return value !== undefined && value !== null;
}
/**
 * Set a minimum time for a promise to resolve (useful for preventing flash of loaders)
 */
async function minDelay(promise, minDelay) {
  await Promise.all([promise, timeout(minDelay)]);
  return promise;
}
/**
 * Helper method to inline setTimeout as an await in async functions
 */
function timeout(ms) {
  return new Promise((resolve) => setTimeout(resolve, ms));
}
const arrayToLookupMap = (dataArr, getKeyAndItem) => Object.fromEntries((dataArr || []).map((item) => {
  const { key, data } = getKeyAndItem(item);
  return [key, data];
}));
/**
 * Check whether two arrays have the same number of elements
 * and whether they contain the same elements
 * regardless of order
 */
const arraysAreEquivalent = (arr1, arr2) => arr1.length === arr2.length && arr1.reduce((memo, str) => memo && arr2.indexOf(str) > -1, true);
function uniqueBy(myArr, getItemId) {
  const resultArr = [];
  const lookupMap = {};
  myArr.forEach((item) => {
    const id = getItemId(item);
    if (lookupMap[id] == null) {
      lookupMap[id] = item;
      resultArr.push(item);
    }
  });
  return resultArr;
}
function unique(myArr) {
  const primitives = { boolean: {}, number: {}, string: {} };
  const objs = [];
  return myArr.filter((item) => {
    let type = typeof item;
    if (type in primitives) {
      return primitives[type].hasOwnProperty(item) ? false : (primitives[type][item] = true);
    }
    else {
      return objs.indexOf(item) >= 0 ? false : objs.push(item);
    }
  });
}
const chunk = (arr, size) => [...Array(Math.ceil(arr.length / size))].map((_, i) => arr.slice(size * i, size + size * i));




/***/ }),

/***/ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/index-81d548b7.js":
/*!***********************************************************************************************************!*\
  !*** ./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/index-81d548b7.js ***!
  \***********************************************************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   c: () => (/* binding */ createStore)
/* harmony export */ });
/* harmony import */ var _index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./index-92ebb396.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/index-92ebb396.js");
/*!
 * All material copyright ESRI, All Rights Reserved, unless otherwise specified.
 * v3.0.99
 */


const appendToMap = (map, propName, value) => {
    const items = map.get(propName);
    if (!items) {
        map.set(propName, [value]);
    }
    else if (!items.includes(value)) {
        items.push(value);
    }
};
const debounce = (fn, ms) => {
    let timeoutId;
    return (...args) => {
        if (timeoutId) {
            clearTimeout(timeoutId);
        }
        timeoutId = setTimeout(() => {
            timeoutId = 0;
            fn(...args);
        }, ms);
    };
};

/**
 * Check if a possible element isConnected.
 * The property might not be there, so we check for it.
 *
 * We want it to return true if isConnected is not a property,
 * otherwise we would remove these elements and would not update.
 *
 * Better leak in Edge than to be useless.
 */
const isConnected = (maybeElement) => !('isConnected' in maybeElement) || maybeElement.isConnected;
const cleanupElements = debounce((map) => {
    for (let key of map.keys()) {
        map.set(key, map.get(key).filter(isConnected));
    }
}, 2000);
const stencilSubscription = () => {
    if (typeof _index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.g !== 'function') {
        // If we are not in a stencil project, we do nothing.
        // This function is not really exported by @stencil/core.
        return {};
    }
    const elmsToUpdate = new Map();
    return {
        dispose: () => elmsToUpdate.clear(),
        get: (propName) => {
            const elm = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.g)();
            if (elm) {
                appendToMap(elmsToUpdate, propName, elm);
            }
        },
        set: (propName) => {
            const elements = elmsToUpdate.get(propName);
            if (elements) {
                elmsToUpdate.set(propName, elements.filter(_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.f));
            }
            cleanupElements(elmsToUpdate);
        },
        reset: () => {
            elmsToUpdate.forEach((elms) => elms.forEach(_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.f));
            cleanupElements(elmsToUpdate);
        },
    };
};

const unwrap = (val) => (typeof val === 'function' ? val() : val);
const createObservableMap = (defaultState, shouldUpdate = (a, b) => a !== b) => {
    const unwrappedState = unwrap(defaultState);
    let states = new Map(Object.entries(unwrappedState !== null && unwrappedState !== void 0 ? unwrappedState : {}));
    const handlers = {
        dispose: [],
        get: [],
        set: [],
        reset: [],
    };
    const reset = () => {
        var _a;
        // When resetting the state, the default state may be a function - unwrap it to invoke it.
        // otherwise, the state won't be properly reset
        states = new Map(Object.entries((_a = unwrap(defaultState)) !== null && _a !== void 0 ? _a : {}));
        handlers.reset.forEach((cb) => cb());
    };
    const dispose = () => {
        // Call first dispose as resetting the state would
        // cause less updates ;)
        handlers.dispose.forEach((cb) => cb());
        reset();
    };
    const get = (propName) => {
        handlers.get.forEach((cb) => cb(propName));
        return states.get(propName);
    };
    const set = (propName, value) => {
        const oldValue = states.get(propName);
        if (shouldUpdate(value, oldValue, propName)) {
            states.set(propName, value);
            handlers.set.forEach((cb) => cb(propName, value, oldValue));
        }
    };
    const state = (typeof Proxy === 'undefined'
        ? {}
        : new Proxy(unwrappedState, {
            get(_, propName) {
                return get(propName);
            },
            ownKeys(_) {
                return Array.from(states.keys());
            },
            getOwnPropertyDescriptor() {
                return {
                    enumerable: true,
                    configurable: true,
                };
            },
            has(_, propName) {
                return states.has(propName);
            },
            set(_, propName, value) {
                set(propName, value);
                return true;
            },
        }));
    const on = (eventName, callback) => {
        handlers[eventName].push(callback);
        return () => {
            removeFromArray(handlers[eventName], callback);
        };
    };
    const onChange = (propName, cb) => {
        const unSet = on('set', (key, newValue) => {
            if (key === propName) {
                cb(newValue);
            }
        });
        // We need to unwrap the defaultState because it might be a function.
        // Otherwise we might not be sending the right reset value.
        const unReset = on('reset', () => cb(unwrap(defaultState)[propName]));
        return () => {
            unSet();
            unReset();
        };
    };
    const use = (...subscriptions) => {
        const unsubs = subscriptions.reduce((unsubs, subscription) => {
            if (subscription.set) {
                unsubs.push(on('set', subscription.set));
            }
            if (subscription.get) {
                unsubs.push(on('get', subscription.get));
            }
            if (subscription.reset) {
                unsubs.push(on('reset', subscription.reset));
            }
            if (subscription.dispose) {
                unsubs.push(on('dispose', subscription.dispose));
            }
            return unsubs;
        }, []);
        return () => unsubs.forEach((unsub) => unsub());
    };
    const forceUpdate = (key) => {
        const oldValue = states.get(key);
        handlers.set.forEach((cb) => cb(key, oldValue, oldValue));
    };
    return {
        state,
        get,
        set,
        on,
        onChange,
        use,
        dispose,
        reset,
        forceUpdate,
    };
};
const removeFromArray = (array, item) => {
    const index = array.indexOf(item);
    if (index >= 0) {
        array[index] = array[array.length - 1];
        array.length--;
    }
};

const createStore = (defaultState, shouldUpdate) => {
    const map = createObservableMap(defaultState, shouldUpdate);
    map.use(stencilSubscription());
    return map;
};




/***/ }),

/***/ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/item-properties-e6412a9a.js":
/*!*********************************************************************************************************************!*\
  !*** ./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/item-properties-e6412a9a.js ***!
  \*********************************************************************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   a: () => (/* binding */ itemPropertiesStore),
/* harmony export */   i: () => (/* binding */ itemPropertiesState)
/* harmony export */ });
/* harmony import */ var _index_81d548b7_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./index-81d548b7.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/index-81d548b7.js");
/*!
 * All material copyright ESRI, All Rights Reserved, unless otherwise specified.
 * v3.0.99
 */


const itemPropertiesStore = (0,_index_81d548b7_js__WEBPACK_IMPORTED_MODULE_0__.c)({
  title: "",
  snippet: "",
  tags: [],
  categories: []
});
const itemPropertiesState = itemPropertiesStore.state;




/***/ }),

/***/ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/localStorage-f63100ef.js":
/*!******************************************************************************************************************!*\
  !*** ./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/localStorage-f63100ef.js ***!
  \******************************************************************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   a: () => (/* binding */ arcgisComponentNotificationsKeys),
/* harmony export */   g: () => (/* binding */ getSingleObjectLocalStorage),
/* harmony export */   l: () => (/* binding */ localStorageKeys),
/* harmony export */   s: () => (/* binding */ setSingleObjectLocalStorage)
/* harmony export */ });
/*!
 * All material copyright ESRI, All Rights Reserved, unless otherwise specified.
 * v3.0.99
 */
var localStorageKeys;
(function (localStorageKeys) {
  localStorageKeys["ARCGIS_COMPONENT_NOTIFICATIONS"] = "arcgisComponent_notifications";
})(localStorageKeys || (localStorageKeys = {}));
var arcgisComponentNotificationsKeys;
(function (arcgisComponentNotificationsKeys) {
  arcgisComponentNotificationsKeys["FEATURE_REDUCTION_WARNING_DISMISSED"] = "arcgis_feature_reduction_warning_dismissed";
  arcgisComponentNotificationsKeys["POPUP_WARNING_DISMISSED"] = "arcgis_popup_warning_dismissed";
  arcgisComponentNotificationsKeys["INCOMPATIBLE_VECTOR_SYMBOLS_DISMISSED"] = "arcgis_symbol_styler_incompatible_vector_symbols_dismissed";
  arcgisComponentNotificationsKeys["EFFECTS_TIP_DISMISSED"] = "arcgis_effects_tip_dismissed";
  arcgisComponentNotificationsKeys["LAYER_VIEW_DEFINITION_DISMISSED"] = "arcgis_layer_view_definition_dismissed";
  arcgisComponentNotificationsKeys["LAYER_OVERRIDE_STATUS_TIP_DISMISSED"] = "arcgis_layer_override_status_tip_dismissed";
  arcgisComponentNotificationsKeys["LAYER_VIEW_JOIN_TIP_DISMISSED"] = "arcgis_layer_view_join_tip_dismissed";
  arcgisComponentNotificationsKeys["MULTIDIMENSIONAL_INFO_TIP_DISMISSED"] = "arcgis_multidimensional_info_tip_dismissed";
})(arcgisComponentNotificationsKeys || (arcgisComponentNotificationsKeys = {}));
const getLocalStorage = (localStorageKey) => {
  return localStorage.getItem(localStorageKey);
};
const setLocalStorage = (localStorageKey, value) => {
  localStorage.setItem(localStorageKey, value);
};
const getObjectLocalStorage = (localStorageKey) => {
  return JSON.parse(getLocalStorage(localStorageKey)) || {};
};
const setSingleObjectLocalStorage = (localStorageKey, keyValueObject) => {
  const setLocalStorageVal = getObjectLocalStorage(localStorageKey);
  setLocalStorageVal[keyValueObject.key] = keyValueObject.value;
  setLocalStorage(localStorageKey, JSON.stringify(setLocalStorageVal));
};
const getSingleObjectLocalStorage = (localStorageKey, objectKey) => {
  const getLocalStorageVal = getObjectLocalStorage(localStorageKey);
  if (getLocalStorageVal === null || getLocalStorageVal === void 0 ? void 0 : getLocalStorageVal.hasOwnProperty(objectKey)) {
    return getLocalStorageVal[objectKey];
  }
  else {
    return null;
  }
};




/***/ }),

/***/ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/locale-13e00a75.js":
/*!************************************************************************************************************!*\
  !*** ./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/locale-13e00a75.js ***!
  \************************************************************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   a: () => (/* binding */ getComponentClosestLanguage),
/* harmony export */   g: () => (/* binding */ getLocaleComponentStrings)
/* harmony export */ });
/* harmony import */ var _dom_13f5b00c_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./dom-13f5b00c.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/dom-13f5b00c.js");
/* harmony import */ var _languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./languageUtil-22258c90.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/languageUtil-22258c90.js");
/* harmony import */ var _index_92ebb396_js__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./index-92ebb396.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/index-92ebb396.js");
/*!
 * All material copyright ESRI, All Rights Reserved, unless otherwise specified.
 * v3.0.99
 */




// https://medium.com/stencil-tricks/implementing-internationalisation-i18n-with-stencil-5e6559554117
function getComponentClosestLanguage(element) {
  var _a, _b, _c;
  const closestElement = (_a = (0,_dom_13f5b00c_js__WEBPACK_IMPORTED_MODULE_0__.c)(element, "[lang]")) !== null && _a !== void 0 ? _a : (_c = (_b = element.shadowRoot) === null || _b === void 0 ? void 0 : _b.ownerDocument) === null || _c === void 0 ? void 0 : _c.documentElement;
  // language set by the calling application or browser. defaults to english.
  const lang = ((closestElement === null || closestElement === void 0 ? void 0 : closestElement.lang) || (navigator === null || navigator === void 0 ? void 0 : navigator.language) || "en").toLowerCase();
  if (_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_1__.l.has(lang)) {
    return _languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_1__.l.get(lang);
  }
  else {
    // "ru-RU" maps to "ru" use case
    if (_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_1__.l.has(lang.slice(0, 2))) {
      return _languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_1__.l.get(lang.slice(0, 2));
    }
    else {
      return "en";
    }
  }
}
function getComponentClosestLanguageIntl(element) {
  var _a, _b, _c;
  // it's OK if we don't have the 4 letter language file for it
  // 4 letter language code needed for formatting numbers
  const closestElement = (_a = (0,_dom_13f5b00c_js__WEBPACK_IMPORTED_MODULE_0__.c)(element, "[lang]")) !== null && _a !== void 0 ? _a : (_c = (_b = element.shadowRoot) === null || _b === void 0 ? void 0 : _b.ownerDocument) === null || _c === void 0 ? void 0 : _c.documentElement;
  // language set by the calling application or browser. defaults to english.
  const lang = ((closestElement === null || closestElement === void 0 ? void 0 : closestElement.lang) || (navigator === null || navigator === void 0 ? void 0 : navigator.language) || "en").toLowerCase();
  if (_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_1__.l.has(lang)) {
    return _languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_1__.l.get(lang);
  }
  else {
    if (_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_1__.l.has(lang.slice(0, 2))) {
      // we support the 2 letter coded language
      // e.g. it-CH vs it
      return lang;
    }
    else {
      return "en";
    }
  }
}
function fetchLocaleStringsForComponent(componentName, locale) {
  return new Promise((resolve, reject) => {
    fetch((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_2__.a)(`../arcgis-app-assets/i18n/${componentName}.i18n.${locale}.json`)).then((result) => {
      if (result.ok)
        resolve(result.json());
      else
        reject();
    }, () => reject());
  });
}
const stringCache = {};
function fetchLocaleStringsFromCache(componentName, locale) {
  const id = `${componentName}${locale}`;
  if (!stringCache[id]) {
    stringCache[id] = fetchLocaleStringsForComponent(componentName, locale);
  }
  return stringCache[id];
}
/**
 * Get strings and language codes.
 * This method returns 2 language codes.
 * The first one returns a code that's also supported as a language file.
 * The second one returns a code where there is support for the first 2 letters of the code as part of a language file,
 * but will return the original 4 letter code from the page.
 * E.g. For "it-ch" it will return "it" as the first language code and "it-ch" as the second.
 * The second one is required for esri.intl.setLocale() to get the correct formatting.
 *
 * If a tagName is provided it will overwite the element's tagName
 *
 *  @return [ strings, first language code, second language code]
 */
async function getLocaleComponentStrings(element, tagName) {
  const componentName = tagName || element.tagName.toLowerCase();
  const componentLanguage = getComponentClosestLanguage(element);
  const componentLanguageIntl = getComponentClosestLanguageIntl(element);
  let strings;
  try {
    strings = await fetchLocaleStringsFromCache(componentName, componentLanguage);
  }
  catch (e) {
    console.warn(`no locale for ${componentName} (${componentLanguage}) loading default locale en.`);
    strings = await fetchLocaleStringsFromCache(componentName, "en");
  }
  return [strings, componentLanguage, componentLanguageIntl];
}




/***/ }),

/***/ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/portal-8714dc6c.js":
/*!************************************************************************************************************!*\
  !*** ./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/portal-8714dc6c.js ***!
  \************************************************************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   g: () => (/* binding */ getPortalBaseUrl)
/* harmony export */ });
/*!
 * All material copyright ESRI, All Rights Reserved, unless otherwise specified.
 * v3.0.99
 */
function getPortalBaseUrl(portal) {
  const { customBaseUrl, portalHostname, urlKey } = portal;
  const { protocol } = window.location;
  const url = urlKey ? `${urlKey}.${customBaseUrl}` : portalHostname;
  return `${protocol}//${url}`;
}




/***/ })

}]);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2lkZ2V0cy9jaHVua3MvYXJjZ2lzX2FuYWx5c2lzX25vZGVfbW9kdWxlc19hcmNnaXNfYXBwLWNvbXBvbmVudHNfZGlzdF9lc21fYXJjZ2lzLTkxMDRiYi5qcyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQzhJO0FBQ3hFO0FBQ1Q7QUFDRTtBQUNQO0FBQzBCO0FBQ3JCO0FBQ1k7QUFDcUc7QUFDbko7QUFDUTtBQUNOOztBQUU3QjtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxDQUFDLGdDQUFnQztBQUNqQztBQUNBO0FBQ0E7QUFDQTtBQUNBLENBQUMsMEJBQTBCO0FBQzNCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFVBQVUsa0JBQWtCO0FBQzVCO0FBQ0E7QUFDQSxjQUFjO0FBQ2QsK0RBQStELFdBQVc7QUFDMUU7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsSUFBSSwrREFBUztBQUNiLElBQUksK0RBQVM7QUFDYjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxNQUFNLCtEQUFTLGNBQWMsK0RBQVM7QUFDdEMsT0FBTywrREFBUyxvQkFBb0IsK0RBQVM7QUFDN0MsT0FBTywrREFBUyxjQUFjLCtEQUFTO0FBQ3ZDLE9BQU8sK0RBQVMsb0JBQW9CLCtEQUFTO0FBQzdDO0FBQ0E7QUFDQSx5QkFBeUIsK0RBQVMsYUFBYSwrREFBUztBQUN4RDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsWUFBWSxvQkFBb0I7QUFDaEM7QUFDQTtBQUNBO0FBQ0E7QUFDQSwyRkFBMkYsK0RBQVM7QUFDcEc7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsVUFBVSxvQ0FBb0M7QUFDOUMsVUFBVSxVQUFVO0FBQ3BCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSwyQ0FBMkMsa0NBQWtDO0FBQzdFO0FBQ0E7QUFDQTtBQUNBLE9BQU87QUFDUDtBQUNBO0FBQ0EsNkNBQTZDLG9DQUFvQztBQUNqRjtBQUNBO0FBQ0E7QUFDQSxPQUFPO0FBQ1A7QUFDQTtBQUNBO0FBQ0EsMkNBQTJDLG9DQUFvQztBQUMvRTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLE9BQU87QUFDUDtBQUNBLDBDQUEwQyxRQUFRO0FBQ2xEO0FBQ0E7QUFDQTtBQUNBLDBDQUEwQyxxQkFBcUI7QUFDL0Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsT0FBTztBQUNQO0FBQ0E7QUFDQSxPQUFPO0FBQ1A7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsVUFBVSxZQUFZO0FBQ3RCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFVBQVUsWUFBWTtBQUN0QjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSx1QkFBdUI7QUFDdkI7QUFDQSxpREFBaUQ7QUFDakQ7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFVBQVUsUUFBUTtBQUNsQjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0EsZ0NBQWdDLDJEQUFXO0FBQzNDO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGlEQUFpRCwyREFBVztBQUM1RDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsVUFBVSxNQUFNO0FBQ2hCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBLFVBQVUsdURBQXVEO0FBQ2pFLFVBQVUsb0JBQW9CO0FBQzlCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtB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SUFBSTtBQUM3Qjs7QUFFaUMiLCJzb3VyY2VzIjpbIndlYnBhY2s6Ly9leGItY2xpZW50Ly4vZXh0ZW5zaW9ucy93aWRnZXRzL2FyY2dpcy9hbmFseXNpcy9ub2RlX21vZHVsZXMvQGFyY2dpcy9hcHAtY29tcG9uZW50cy9kaXN0L2VzbS9hcmNnaXMtbGF5ZXItdmlld18xNC5lbnRyeS5qcyIsIndlYnBhY2s6Ly9leGItY2xpZW50Ly4vZXh0ZW5zaW9ucy93aWRnZXRzL2FyY2dpcy9hbmFseXNpcy9ub2RlX21vZHVsZXMvQGFyY2dpcy9hcHAtY29tcG9uZW50cy9kaXN0L2VzbS9mdW5jdGlvbmFsLWM4MmY1YWI5LmpzIiwid2VicGFjazovL2V4Yi1jbGllbnQvLi9leHRlbnNpb25zL3dpZGdldHMvYXJjZ2lzL2FuYWx5c2lzL25vZGVfbW9kdWxlcy9AYXJjZ2lzL2FwcC1jb21wb25lbnRzL2Rpc3QvZXNtL2luZGV4LTgxZDU0OGI3LmpzIiwid2VicGFjazovL2V4Yi1jbGllbnQvLi9leHRlbnNpb25zL3dpZGdldHMvYXJjZ2lzL2FuYWx5c2lzL25vZGVfbW9kdWxlcy9AYXJjZ2lzL2FwcC1jb21wb25lbnRzL2Rpc3QvZXNtL2l0ZW0tcHJvcGVydGllcy1lNjQxMmE5YS5qcyIsIndlYnBhY2s6Ly9leGItY2xpZW50Ly4vZXh0ZW5zaW9ucy93aWRnZXRzL2FyY2dpcy9hbmFseXNpcy9ub2RlX21vZHVsZXMvQGFyY2dpcy9hcHAtY29tcG9uZW50cy9kaXN0L2VzbS9sb2NhbFN0b3JhZ2UtZjYzMTAwZWYuanMiLCJ3ZWJwYWNrOi8vZXhiLWNsaWVudC8uL2V4dGVuc2lvbnMvd2lkZ2V0cy9hcmNnaXMvYW5hbHlzaXMvbm9kZV9tb2R1bGVzL0BhcmNnaXMvYXBwLWNvbXBvbmVudHMvZGlzdC9lc20vbG9jYWxlLTEzZTAwYTc1LmpzIiwid2VicGFjazovL2V4Yi1jbGllbnQvLi9leHRlbnNpb25zL3dpZGdldHMvYXJjZ2lzL2FuYWx5c2lzL25vZGVfbW9kdWxlcy9AYXJjZ2lzL2FwcC1jb21wb25lbnRzL2Rpc3QvZXNtL3BvcnRhbC04NzE0ZGM2Yy5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKiFcbiAqIEFsbCBtYXRlcmlhbCBjb3B5cmlnaHQgRVNSSSwgQWxsIFJpZ2h0cyBSZXNlcnZlZCwgdW5sZXNzIG90aGVyd2lzZSBzcGVjaWZpZWQuXG4gKiB2My4wLjk5XG4gKi9cbmltcG9ydCB7IHIgYXMgcmVnaXN0ZXJJbnN0YW5jZSwgYyBhcyBjcmVhdGVFdmVudCwgaCwgSCBhcyBIb3N0LCBkIGFzIGdldEVsZW1lbnQsIGYgYXMgZm9yY2VVcGRhdGUsIEYgYXMgRnJhZ21lbnQgfSBmcm9tICcuL2luZGV4LTkyZWJiMzk2LmpzJztcbmltcG9ydCB7IGcgYXMgZ2V0TG9jYWxlQ29tcG9uZW50U3RyaW5ncyB9IGZyb20gJy4vbG9jYWxlLTEzZTAwYTc1LmpzJztcbmltcG9ydCB7IGwgYXMgbG9hZE1vZHVsZXMgfSBmcm9tICcuL2xvYWRNb2R1bGVzLWFhZjMwYmQ2LmpzJztcbmltcG9ydCB7IGkgYXMgaXNEZWZpbmVkIH0gZnJvbSAnLi9jb21tb25GdW5jdGlvbnMtNTI2MmIwOTQuanMnO1xuaW1wb3J0IHsgdCBhcyB0aW1lb3V0IH0gZnJvbSAnLi9mdW5jdGlvbmFsLWM4MmY1YWI5LmpzJztcbmltcG9ydCB7IGcgYXMgZ2V0RWxlbWVudERpciwgQyBhcyBDU1NfVVRJTElUWSB9IGZyb20gJy4vbGFuZ3VhZ2VVdGlsLTIyMjU4YzkwLmpzJztcbmltcG9ydCB7IGcgYXMgZ2V0UG9ydGFsQmFzZVVybCB9IGZyb20gJy4vcG9ydGFsLTg3MTRkYzZjLmpzJztcbmltcG9ydCB7IGkgYXMgaXRlbVByb3BlcnRpZXNTdGF0ZSB9IGZyb20gJy4vaXRlbS1wcm9wZXJ0aWVzLWU2NDEyYTlhLmpzJztcbmltcG9ydCB7IGcgYXMgZ2V0U2luZ2xlT2JqZWN0TG9jYWxTdG9yYWdlLCBzIGFzIHNldFNpbmdsZU9iamVjdExvY2FsU3RvcmFnZSwgYSBhcyBhcmNnaXNDb21wb25lbnROb3RpZmljYXRpb25zS2V5cywgbCBhcyBsb2NhbFN0b3JhZ2VLZXlzIH0gZnJvbSAnLi9sb2NhbFN0b3JhZ2UtZjYzMTAwZWYuanMnO1xuaW1wb3J0ICcuL2RvbS0xM2Y1YjAwYy5qcyc7XG5pbXBvcnQgJy4vY29tbW9uRW51bXMtZjk4YTMyM2MuanMnO1xuaW1wb3J0ICcuL2luZGV4LTgxZDU0OGI3LmpzJztcblxuY29uc3QgQ1NTJDkgPSB7XG4gIHBhbmVsOiBcInBhbmVsXCIsXG4gIGZvb3RlcjogXCJmb290ZXJcIixcbiAgZXJyb3JDb250ZW50OiBcImVycm9yLWNvbnRlbnRcIlxufTtcblxudmFyIGZsb3dTdGF0dXM7XG4oZnVuY3Rpb24gKGZsb3dTdGF0dXMpIHtcbiAgZmxvd1N0YXR1c1tmbG93U3RhdHVzW1wiRVJST1JcIl0gPSAwXSA9IFwiRVJST1JcIjtcbiAgZmxvd1N0YXR1c1tmbG93U3RhdHVzW1wiTE9BRElOR1wiXSA9IDFdID0gXCJMT0FESU5HXCI7XG4gIGZsb3dTdGF0dXNbZmxvd1N0YXR1c1tcIlNFTEVDVElPTlwiXSA9IDJdID0gXCJTRUxFQ1RJT05cIjtcbiAgZmxvd1N0YXR1c1tmbG93U3RhdHVzW1wiT1ZFUlZJRVdcIl0gPSAzXSA9IFwiT1ZFUlZJRVdcIjtcbiAgZmxvd1N0YXR1c1tmbG93U3RhdHVzW1wiU1dBUF9TT1VSQ0VcIl0gPSA0XSA9IFwiU1dBUF9TT1VSQ0VcIjtcbiAgZmxvd1N0YXR1c1tmbG93U3RhdHVzW1wiQlJPV1NFX0xBWUVSXCJdID0gNV0gPSBcIkJST1dTRV9MQVlFUlwiO1xuICBmbG93U3RhdHVzW2Zsb3dTdGF0dXNbXCJERUZJTklUSU9OXCJdID0gNl0gPSBcIkRFRklOSVRJT05cIjtcbiAgZmxvd1N0YXR1c1tmbG93U3RhdHVzW1wiRklMVEVSXCJdID0gN10gPSBcIkZJTFRFUlwiO1xuICBmbG93U3RhdHVzW2Zsb3dTdGF0dXNbXCJDUkVBVEVcIl0gPSA4XSA9IFwiQ1JFQVRFXCI7XG59KShmbG93U3RhdHVzIHx8IChmbG93U3RhdHVzID0ge30pKTtcbnZhciBhY3Rpb25zO1xuKGZ1bmN0aW9uIChhY3Rpb25zKSB7XG4gIGFjdGlvbnNbYWN0aW9uc1tcIkNBTkNFTFwiXSA9IDBdID0gXCJDQU5DRUxcIjtcbiAgYWN0aW9uc1thY3Rpb25zW1wiQ1JFQVRFXCJdID0gMV0gPSBcIkNSRUFURVwiO1xufSkoYWN0aW9ucyB8fCAoYWN0aW9ucyA9IHt9KSk7XG4vKipcbiAqIENoZWNrcyBpZiBhIGZlYXR1cmVFZmZlY3Qgb24gYSBsYXllciBpcyBlbXB0eVxuICogQHBhcmFtIGVmZmVjdCAtIGxheWVyLmZlYXR1cmVFZmZlY3RcbiAqL1xuZnVuY3Rpb24gaXNFZmZlY3RFbXB0eShlZmZlY3QpIHtcbiAgaWYgKCFlZmZlY3QgfHwgIWVmZmVjdC5maWx0ZXIpIHtcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuICBjb25zdCBjaGVja1Byb3BzID0gW1wiZ2VvbWV0cnlcIiwgXCJkaXN0YW5jZVwiLCBcIm9iamVjdElkc1wiLCBcInRpbWVFeHRlbnRcIiwgXCJ3aGVyZVwiXTtcbiAgcmV0dXJuICFjaGVja1Byb3BzLnNvbWUoKHByb3ApID0+IGVmZmVjdC5maWx0ZXIuaGFzT3duUHJvcGVydHkocHJvcCkpO1xufVxuZnVuY3Rpb24gY3JlYXRlRWZmZWN0KGZsLCBGZWF0dXJlRWZmZWN0LCBwcm9wcykge1xuICBjb25zdCB7IGJhY2tncm91bmRUaGVtZSB9ID0gcHJvcHM7XG4gIGxldCBicmlnaHRuZXNzID0gYmFja2dyb3VuZFRoZW1lID09PSBcImxpZ2h0XCIgPyAxMDAgOiA2NTtcbiAgZmwuZmVhdHVyZUVmZmVjdCA9IG5ldyBGZWF0dXJlRWZmZWN0KHtcbiAgICBmaWx0ZXI6IHt9LFxuICAgIGV4Y2x1ZGVkRWZmZWN0OiBgZ3JheXNjYWxlKDEwMCUpIG9wYWNpdHkoMzAlKSBicmlnaHRuZXNzKCR7YnJpZ2h0bmVzc30lKWAsXG4gICAgZXhjbHVkZWRMYWJlbHNWaXNpYmxlOiB0cnVlXG4gIH0pO1xufVxuZnVuY3Rpb24gc2FtZUNvb3JkKHZhbDEsIHZhbDIpIHtcbiAgcmV0dXJuIHZhbDEgPT09IHZhbDIgfHwgTWF0aC5yb3VuZCh2YWwxICogMTAwMDAwMCkgLyAxMDAwMDAwID09PSBNYXRoLnJvdW5kKHZhbDIgKiAxMDAwMDAwKSAvIDEwMDAwMDA7XG59XG5mdW5jdGlvbiBzYW1lU1Ioc3AxLCBzcDIpIHtcbiAgLy8gd29ya3MgZm9yIF9fZXNyaS5TcGF0aWFsUmVmZXJlbmNlIGFuZCBKU09OIG9iamVjdHNcbiAgdmFyIG1lcmNhdG9yID0gWzEwMjExMywgMTAyMTAwLCAzODU3XTtcbiAgaWYgKHNwMSAmJlxuICAgIHNwMiAmJlxuICAgIGlzRGVmaW5lZChzcDEud2tpZCkgJiZcbiAgICBpc0RlZmluZWQoc3AyLndraWQpICYmXG4gICAgbWVyY2F0b3IuaW5kZXhPZihzcDEud2tpZCkgPiAtMSAmJlxuICAgIG1lcmNhdG9yLmluZGV4T2Yoc3AyLndraWQpID4gLTEpIHtcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuICBlbHNlIGlmIChzcDEgJiZcbiAgICBzcDIgJiZcbiAgICAoKGlzRGVmaW5lZChzcDEud2tpZCkgJiYgaXNEZWZpbmVkKHNwMi53a2lkKSAmJiBzcDEud2tpZCA9PSBzcDIud2tpZCkgfHxcbiAgICAgIChpc0RlZmluZWQoc3AxLmxhdGVzdFdraWQpICYmIGlzRGVmaW5lZChzcDIud2tpZCkgJiYgc3AxLmxhdGVzdFdraWQgPT0gc3AyLndraWQpIHx8XG4gICAgICAoaXNEZWZpbmVkKHNwMS53a2lkKSAmJiBpc0RlZmluZWQoc3AyLmxhdGVzdFdraWQpICYmIHNwMS53a2lkID09IHNwMi5sYXRlc3RXa2lkKSB8fFxuICAgICAgKGlzRGVmaW5lZChzcDEubGF0ZXN0V2tpZCkgJiYgaXNEZWZpbmVkKHNwMi5sYXRlc3RXa2lkKSAmJiBzcDEubGF0ZXN0V2tpZCA9PSBzcDIubGF0ZXN0V2tpZCkpKSB7XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cbiAgZWxzZSBpZiAoc3AxICYmIHNwMiAmJiBpc0RlZmluZWQoc3AxLndrdCkgJiYgaXNEZWZpbmVkKHNwMi53a3QpICYmIHNwMS53a3QgPT09IHNwMi53a3QpIHtcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuICByZXR1cm4gZmFsc2U7XG59XG4vKipcbiAqXG4gKiBAcGFyYW0gcHJvcHNcbiAqIEByZXR1cm5zXG4gKi9cbmZ1bmN0aW9uIGdldFJlcXVpcmVkRmllbGROYW1lcyhwcm9wcywgbGF5ZXIpIHtcbiAgY29uc3QgcmVxdWlyZWRGaWVsZFR5cGVzID0gW1xuICAgIFwib2lkXCIsXG4gICAgXCJlc3JpRmllbGRUeXBlT0lEXCIsXG4gICAgXCJnbG9iYWwtaWRcIixcbiAgICBcImVzcmlGaWVsZFR5cGVHbG9iYWxJRFwiLFxuICAgIFwiZ2VvbWV0cnlcIixcbiAgICBcImVzcmlGaWVsZFR5cGVHZW9tZXRyeVwiXG4gIF07XG4gIGxldCB0b3RhbEZpZWxkcztcbiAgaWYgKGxheWVyKSB7XG4gICAgdG90YWxGaWVsZHMgPSBsYXllci5maWVsZHM7XG4gIH1cbiAgZWxzZSB7XG4gICAgY29uc3QgeyBkZWZpbml0aW9uTGF5ZXJJZCB9ID0gcHJvcHM7XG4gICAgY29uc3QgYWRtaW5MYXllckluZm8gPSBnZXRBZG1pbkxheWVySW5mbyhkZWZpbml0aW9uTGF5ZXJJZCwgcHJvcHMpO1xuICAgIHRvdGFsRmllbGRzID0gKGFkbWluTGF5ZXJJbmZvID09PSBudWxsIHx8IGFkbWluTGF5ZXJJbmZvID09PSB2b2lkIDAgPyB2b2lkIDAgOiBhZG1pbkxheWVySW5mby5maWVsZHMpIHx8IGdldEZMKGRlZmluaXRpb25MYXllcklkLCBwcm9wcykuZmllbGRzO1xuICB9XG4gIHJldHVybiB0b3RhbEZpZWxkc1xuICAgIC5maWx0ZXIoKGZpZWxkKSA9PiByZXF1aXJlZEZpZWxkVHlwZXMuaW5kZXhPZihmaWVsZC50eXBlKSA+IC0xIHx8ICghZmllbGQubnVsbGFibGUgJiYgIWlzRGVmaW5lZChmaWVsZC5kZWZhdWx0VmFsdWUpKSlcbiAgICAubWFwKChmaWVsZCkgPT4gZmllbGQubmFtZSk7XG59XG5cbi8qKlxuICogSW5pdGlhbGl6ZSBzZXR0aW5ncyBvZiBjdXJyZW50IHZpZXdcbiAqL1xuYXN5bmMgZnVuY3Rpb24gaW5pdERlZmluaXRpb25zKHByb3BzKSB7XG4gIHZhciBfYSwgX2IsIF9jO1xuICBjb25zdCB7IHZpZXdJdGVtLCBhZG1pblNlcnZpY2VJbmZvLCBsYXllciB9ID0gcHJvcHM7XG4gIGNvbnN0IHsgbW9kdWxlcyB9ID0gcHJvcHM7XG4gIGlmICghdmlld0l0ZW0pIHtcbiAgICAvLyB1c2UgcGFyZW50J3MgZGVmaW5pdGlvbkV4cHJlc3Npb24gYXMgZGVmYXVsdCBmaWx0ZXJcbiAgICBpZiAobGF5ZXIudHlwZSA9PT0gXCJncm91cFwiKSB7XG4gICAgICAoX2EgPSBsYXllci5sYXllcnMpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5mb3JFYWNoKChseXIpID0+IHtcbiAgICAgICAgaWYgKGx5ci5kZWZpbml0aW9uRXhwcmVzc2lvbikge1xuICAgICAgICAgIGFkZFZpZXdMYXllclByb3BzKGx5ci5sYXllcklkLCB7IGZpbHRlcjogbHlyLmRlZmluaXRpb25FeHByZXNzaW9uIH0sIHByb3BzKTtcbiAgICAgICAgICBhcHBseUxheWVyRmlsdGVyKGx5ci5kZWZpbml0aW9uRXhwcmVzc2lvbiwgbHlyLmxheWVySWQsIHByb3BzKTtcbiAgICAgICAgICBseXIuZGVmaW5pdGlvbkV4cHJlc3Npb24gPSBudWxsO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICAgIChfYiA9IGxheWVyLnRhYmxlcykgPT09IG51bGwgfHwgX2IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9iLmZvckVhY2goKHRhYmxlKSA9PiB7XG4gICAgICAgIGlmICh0YWJsZS5kZWZpbml0aW9uRXhwcmVzc2lvbikge1xuICAgICAgICAgIGFkZFZpZXdMYXllclByb3BzKHRhYmxlLmxheWVySWQsIHsgZmlsdGVyOiB0YWJsZS5kZWZpbml0aW9uRXhwcmVzc2lvbiB9LCBwcm9wcyk7XG4gICAgICAgICAgYXBwbHlMYXllckZpbHRlcih0YWJsZS5kZWZpbml0aW9uRXhwcmVzc2lvbiwgdGFibGUubGF5ZXJJZCwgcHJvcHMpO1xuICAgICAgICAgIHRhYmxlLmRlZmluaXRpb25FeHByZXNzaW9uID0gbnVsbDtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgaWYgKGxheWVyLmRlZmluaXRpb25FeHByZXNzaW9uKSB7XG4gICAgICAgIGFkZFZpZXdMYXllclByb3BzKGxheWVyLmxheWVySWQsIHsgZmlsdGVyOiBsYXllci5kZWZpbml0aW9uRXhwcmVzc2lvbiB9LCBwcm9wcyk7XG4gICAgICAgIGFwcGx5TGF5ZXJGaWx0ZXIobGF5ZXIuZGVmaW5pdGlvbkV4cHJlc3Npb24sIGxheWVyLmxheWVySWQsIHByb3BzKTtcbiAgICAgICAgbGF5ZXIuZGVmaW5pdGlvbkV4cHJlc3Npb24gPSBudWxsO1xuICAgICAgfVxuICAgIH1cbiAgfVxuICBlbHNlIHtcbiAgICBpZiAoIWFkbWluU2VydmljZUluZm8pIHtcbiAgICAgIC8vIHByb2JhYmx5IG5vdCBhIHZpZXcgeWV0XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHByb3BzLmxheWVySWRzID0gW107XG4gICAgZ2V0TGF5ZXJzQW5kVGFibGVzKGFkbWluU2VydmljZUluZm8pLmZvckVhY2goYXN5bmMgKGxheWVySW5mbykgPT4ge1xuICAgICAgdmFyIF9hLCBfYiwgX2MsIF9kO1xuICAgICAgcHJvcHMubGF5ZXJJZHMucHVzaChsYXllckluZm8uaWQpO1xuICAgICAgY29uc3QgZmllbGRzID0gW107XG4gICAgICBsYXllckluZm8uZmllbGRzLmZvckVhY2goKGZpZWxkKSA9PiB7XG4gICAgICAgIGlmIChmaWVsZC52aXNpYmxlICE9PSBmYWxzZSkge1xuICAgICAgICAgIGZpZWxkcy5wdXNoKGZpZWxkLm5hbWUpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICAgIGlmIChmaWVsZHMubGVuZ3RoICE9PSBsYXllckluZm8uZmllbGRzLmxlbmd0aCkge1xuICAgICAgICBhZGRWaWV3TGF5ZXJQcm9wcyhsYXllckluZm8uaWQsIHsgZmllbGRzIH0sIHByb3BzKTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IHdoZXJlQ2xhdXNlID0gbGF5ZXJJbmZvLnZpZXdEZWZpbml0aW9uUXVlcnk7XG4gICAgICBpZiAod2hlcmVDbGF1c2UpIHtcbiAgICAgICAgYWRkVmlld0xheWVyUHJvcHMobGF5ZXJJbmZvLmlkLCB7IGZpbHRlcjogd2hlcmVDbGF1c2UgfSwgcHJvcHMpO1xuICAgICAgICBhcHBseUxheWVyRmlsdGVyKHdoZXJlQ2xhdXNlLCBsYXllckluZm8uaWQsIHByb3BzKTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IGFvaVZhbHVlID0gKF9kID0gKF9jID0gKF9iID0gKF9hID0gbGF5ZXJJbmZvLmFkbWluTGF5ZXJJbmZvKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2Eudmlld0xheWVyRGVmaW5pdGlvbikgPT09IG51bGwgfHwgX2IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9iLnRhYmxlKSA9PT0gbnVsbCB8fCBfYyA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2MuZmlsdGVyKSA9PT0gbnVsbCB8fCBfZCA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2QudmFsdWU7XG4gICAgICBpZiAoYW9pVmFsdWUpIHtcbiAgICAgICAgLy8gZG9uJ3QgbmVlZCB0byBjaGVjayBTUiBvZiBzYXZlZCBBT0ksIGFueSBTUiB3b3JrXG4gICAgICAgIGFkZFZpZXdMYXllclByb3BzKGxheWVySW5mby5pZCwge1xuICAgICAgICAgIGFvaTogSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShhb2lWYWx1ZS5nZW9tZXRyeSkpXG4gICAgICAgIH0sIHByb3BzKTtcbiAgICAgICAgY29uc3QgZ2VvbWV0cnkgPSBhb2lWYWx1ZS5nZW9tZXRyeS5yaW5nc1xuICAgICAgICAgID8gbW9kdWxlcy5Qb2x5Z29uLmZyb21KU09OKGFvaVZhbHVlLmdlb21ldHJ5KVxuICAgICAgICAgIDogbW9kdWxlcy5FeHRlbnQuZnJvbUpTT04oYW9pVmFsdWUuZ2VvbWV0cnkpO1xuICAgICAgICBhcHBseUxheWVyQU9JKGdlb21ldHJ5LCBsYXllckluZm8uaWQsIHByb3BzKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICAvLyBzZXQgbGF5ZXIgdmlzaWJpbGl0eSBvbiBtYXAgYW5kIHJlbW92ZSBkZWZpbml0aW9uRXhwcmVzc2lvblxuICAgIGlmIChsYXllci50eXBlID09PSBcImdyb3VwXCIpIHtcbiAgICAgIGxheWVyLmxheWVycy5mb3JFYWNoKChmTGF5ZXIpID0+IHtcbiAgICAgICAgZkxheWVyLnZpc2libGUgPSBwcm9wcy5sYXllcklkcy5pbmRleE9mKGZMYXllci5sYXllcklkKSA+IC0xO1xuICAgICAgICBmTGF5ZXIuZGVmaW5pdGlvbkV4cHJlc3Npb24gPSBudWxsO1xuICAgICAgfSk7XG4gICAgICAoX2MgPSBsYXllci50YWJsZXMpID09PSBudWxsIHx8IF9jID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYy5mb3JFYWNoKCh0YWJsZSkgPT4ge1xuICAgICAgICB0YWJsZS5kZWZpbml0aW9uRXhwcmVzc2lvbiA9IG51bGw7XG4gICAgICB9KTtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICBsYXllci52aXNpYmxlID0gcHJvcHMubGF5ZXJJZHMuaW5kZXhPZihsYXllci5sYXllcklkKSA+IC0xO1xuICAgICAgbGF5ZXIuZGVmaW5pdGlvbkV4cHJlc3Npb24gPSBudWxsO1xuICAgIH1cbiAgfVxufVxuLyoqXG4gKiBSZXR1cm5zIHRydWUgaWYgdGhlIHZhbHVlIGlzIGRlZmluZWRcbiAqIEBwYXJhbSBsYXllcklkIC0gbGF5ZXIgaWRcbiAqL1xuZnVuY3Rpb24gZ2V0Vmlld0xheWVyUHJvcHMobGF5ZXJJZCwgcHJvcHMpIHtcbiAgY29uc3QgeyB2aWV3UHJvcHMgfSA9IHByb3BzO1xuICByZXR1cm4gdmlld1Byb3BzID09PSBudWxsIHx8IHZpZXdQcm9wcyA9PT0gdm9pZCAwID8gdm9pZCAwIDogdmlld1Byb3BzLmZpbmQoKHZpZXdMYXllclByb3BzKSA9PiBsYXllcklkID09PSB2aWV3TGF5ZXJQcm9wcy5sYXllcklkKTtcbn1cbi8qKlxuICogY2hlY2sgaWYgb25lIFZpZXdMYXllclByb3AgaXMgZW1wdHksIHRoZW4gZGVsZXRlIGl0XG4gKi9cbmZ1bmN0aW9uIHNhbml0aXplVmlld1Byb3BzKHByb3BzKSB7XG4gIGNvbnN0IHsgdmlld1Byb3BzIH0gPSBwcm9wcztcbiAgaWYgKCF2aWV3UHJvcHMpIHtcbiAgICByZXR1cm47XG4gIH1cbiAgcHJvcHMudmlld1Byb3BzID0gdmlld1Byb3BzLmZpbHRlcigodmlld0xheWVyUHJvcHMpID0+IHZpZXdMYXllclByb3BzLmZpbHRlciB8fCB2aWV3TGF5ZXJQcm9wcy5hb2kgfHwgdmlld0xheWVyUHJvcHMuZmllbGRzKTtcbiAgaWYgKCFwcm9wcy52aWV3UHJvcHMubGVuZ3RoKSB7XG4gICAgcHJvcHMudmlld1Byb3BzID0gdW5kZWZpbmVkO1xuICB9XG59XG4vKipcbiAqIGFkZCBwcm9wcyBmb3Igb25lIGxheWVyXG4gKi9cbmZ1bmN0aW9uIGFkZFZpZXdMYXllclByb3BzKGxheWVySWQsIGFkZFByb3BzLCBwcm9wcykge1xuICB2YXIgX2E7XG4gIGxldCB2aWV3TGF5ZXJQcm9wcyA9IGdldFZpZXdMYXllclByb3BzKGxheWVySWQsIHByb3BzKTtcbiAgaWYgKCF2aWV3TGF5ZXJQcm9wcykge1xuICAgIHZpZXdMYXllclByb3BzID0geyBsYXllcklkIH07XG4gIH1cbiAgY29uc3QgbmV3UHJvcHMgPSBPYmplY3QuYXNzaWduKE9iamVjdC5hc3NpZ24oe30sIHZpZXdMYXllclByb3BzKSwgYWRkUHJvcHMpO1xuICBwcm9wcy52aWV3UHJvcHMgPSAoX2EgPSBwcm9wcy52aWV3UHJvcHMpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5maWx0ZXIoKHZpZXdMYXllclByb3ApID0+IHZpZXdMYXllclByb3AubGF5ZXJJZCAhPT0gbGF5ZXJJZCk7XG4gIHByb3BzLnZpZXdQcm9wcyA9IHByb3BzLnZpZXdQcm9wcyB8fCBbXTtcbiAgcHJvcHMudmlld1Byb3BzLnB1c2gobmV3UHJvcHMpO1xufVxuXG4vKipcbiAqIFJldHVybnMgbm9uLXZpZXcgRkxcbiAqIEBwYXJhbSBsYXllcklkIC0gbGF5ZXIgaWRcbiAqL1xuZnVuY3Rpb24gZ2V0RkwobGF5ZXJJZCwgcHJvcHMpIHtcbiAgY29uc3QgeyBsYXllciB9ID0gcHJvcHM7XG4gIHJldHVybiBsYXllci50eXBlID09PSBcImdyb3VwXCJcbiAgICA/IGdldExheWVyc0FuZFRhYmxlcyhsYXllcikuZmluZCgobHlyKSA9PiBseXIubGF5ZXJJZCA9PT0gbGF5ZXJJZClcbiAgICA6IGxheWVyO1xufVxuLyoqXG4gKiBhcHBseSBmaWx0ZXIgdG8gbGF5ZXIgYXMgZWZmZWN0XG4gKiBAcGFyYW0gd2hlcmUgLSB3aGVyZSBjbGF1c2VcbiAqIEBwYXJhbSBsYXllcklkIC0gbGF5ZXIgaWRcbiAqL1xuYXN5bmMgZnVuY3Rpb24gYXBwbHlMYXllckZpbHRlcih3aGVyZSwgbGF5ZXJJZCwgcHJvcHMpIHtcbiAgY29uc3QgZmwgPSBnZXRGTChsYXllcklkLCBwcm9wcyk7XG4gIGlmIChmbC5pc1RhYmxlKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7XG4gICAgICByZXNvbHZlKCk7XG4gICAgfSk7XG4gIH1cbiAgY29uc3QgW0ZlYXR1cmVFZmZlY3RdID0gYXdhaXQgbG9hZE1vZHVsZXMoW1wiZXNyaS9sYXllcnMvc3VwcG9ydC9GZWF0dXJlRWZmZWN0XCJdKTtcbiAgaWYgKHdoZXJlKSB7XG4gICAgbGV0IGNvdW50ID0gMDtcbiAgICAvLyB3YWl0IHVudGlsIHRoZSBmaWx0ZXIgY29tcG9uZW50IGlzIGRvbmVcbiAgICBjb25zdCBpbnRlcnZhbEhhbmRsZXIgPSBzZXRJbnRlcnZhbCgoKSA9PiB7XG4gICAgICB2YXIgX2E7XG4gICAgICBpZiAoISgoX2EgPSBmbC5mZWF0dXJlRWZmZWN0KSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EuZmlsdGVyKSkge1xuICAgICAgICBjcmVhdGVFZmZlY3QoZmwsIEZlYXR1cmVFZmZlY3QsIHByb3BzKTtcbiAgICAgIH1cbiAgICAgIGZsLmZlYXR1cmVFZmZlY3QuZmlsdGVyLndoZXJlID0gd2hlcmU7XG4gICAgICBjb3VudCsrO1xuICAgICAgaWYgKGNvdW50ID09PSAzKSB7XG4gICAgICAgIGNsZWFySW50ZXJ2YWwoaW50ZXJ2YWxIYW5kbGVyKTtcbiAgICAgIH1cbiAgICB9LCAyMDApO1xuICB9XG4gIGVsc2Uge1xuICAgIGZsLmZlYXR1cmVFZmZlY3QuZmlsdGVyLndoZXJlID0gbnVsbDtcbiAgICBpZiAoaXNFZmZlY3RFbXB0eShmbC5mZWF0dXJlRWZmZWN0KSkge1xuICAgICAgZmwuZmVhdHVyZUVmZmVjdCA9IG51bGw7XG4gICAgfVxuICB9XG59XG4vKipcbiAqIGFwcGx5IEFPSSB0byBsYXllciBhcyBlZmZlY3RcbiAqIEBwYXJhbSBncmFwaGljIC0gR3JhcGhpYyB3aXRoIGdlb21ldHJ5XG4gKiBAcGFyYW0gbGF5ZXJJZCAtIGxheWVyIGlkXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIGFwcGx5TGF5ZXJBT0koZ2VvbWV0cnksIGxheWVySWQsIHByb3BzKSB7XG4gIGNvbnN0IGZsID0gZ2V0RkwobGF5ZXJJZCwgcHJvcHMpO1xuICBjb25zdCBbRmVhdHVyZUVmZmVjdCwgUG9seWdvbiwgRXh0ZW50XSA9IGF3YWl0IGxvYWRNb2R1bGVzKFtcbiAgICBcImVzcmkvbGF5ZXJzL3N1cHBvcnQvRmVhdHVyZUVmZmVjdFwiLFxuICAgIFwiZXNyaS9nZW9tZXRyeS9Qb2x5Z29uXCIsXG4gICAgXCJlc3JpL2dlb21ldHJ5L0V4dGVudFwiXG4gIF0pO1xuICBpZiAoZ2VvbWV0cnkpIHtcbiAgICBsZXQgY291bnQgPSAwO1xuICAgIC8vIHdhaXQgdW50aWwgdGhlIGZpbHRlciBjb21wb25lbnQgaXMgZG9uZVxuICAgIGNvbnN0IGludGVydmFsSGFuZGxlciA9IHNldEludGVydmFsKCgpID0+IHtcbiAgICAgIHZhciBfYTtcbiAgICAgIGlmICghKChfYSA9IGZsLmZlYXR1cmVFZmZlY3QpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5maWx0ZXIpKSB7XG4gICAgICAgIGNyZWF0ZUVmZmVjdChmbCwgRmVhdHVyZUVmZmVjdCwgcHJvcHMpO1xuICAgICAgfVxuICAgICAgY29uc3QgZ2VvbSA9IGdlb21ldHJ5LnR5cGUgPT09IFwicG9seWdvblwiID8gUG9seWdvbi5mcm9tSlNPTihnZW9tZXRyeS50b0pTT04oKSkgOiBFeHRlbnQuZnJvbUpTT04oZ2VvbWV0cnkudG9KU09OKCkpO1xuICAgICAgZmwuZmVhdHVyZUVmZmVjdC5maWx0ZXIuZ2VvbWV0cnkgPSBnZW9tO1xuICAgICAgY291bnQrKztcbiAgICAgIGlmIChjb3VudCA9PT0gMykge1xuICAgICAgICBjbGVhckludGVydmFsKGludGVydmFsSGFuZGxlcik7XG4gICAgICB9XG4gICAgfSwgMjAwKTtcbiAgfVxuICBlbHNlIHtcbiAgICBmbC5mZWF0dXJlRWZmZWN0LmZpbHRlci5nZW9tZXRyeSA9IG51bGw7XG4gICAgaWYgKGlzRWZmZWN0RW1wdHkoZmwuZmVhdHVyZUVmZmVjdCkpIHtcbiAgICAgIGZsLmZlYXR1cmVFZmZlY3QgPSBudWxsO1xuICAgIH1cbiAgfVxufVxuLyoqXG4gKiBnZXQgbmFtZSBvZiBzZXJ2aWNlIGZyb20gVVJMXG4gKiBAcGFyYW0gcG9ydGFsSXRlbSAtIF9fZXNyaS5Qb3J0YWxJdGVtXG4gKiBAcmV0dXJuIHNlcnZpY2UgbmFtZVxuICovXG5mdW5jdGlvbiBnZXRTZXJ2aWNlTmFtZShwb3J0YWxJdGVtKSB7XG4gIHZhciBfYTtcbiAgY29uc3QgeyB1cmwgfSA9IHBvcnRhbEl0ZW07XG4gIGlmICghdXJsKSB7XG4gICAgcmV0dXJuIFwiXCI7XG4gIH1cbiAgY29uc3Qgc2VydmVyVHlwZXMgPSBbXCIvRmVhdHVyZVNlcnZlclwiLCBcIi9NYXBTZXJ2ZXJcIl07XG4gIGNvbnN0IHNlcnZlclR5cGUgPSAoX2EgPSBzZXJ2ZXJUeXBlcy5maWx0ZXIoKHR5cGUpID0+IHVybC50b0xvd2VyQ2FzZSgpLmluZGV4T2YodHlwZS50b0xvd2VyQ2FzZSgpKSA+IC0xKSkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hWzBdO1xuICBsZXQgdGl0bGUgPSBcIlwiO1xuICBpZiAoc2VydmVyVHlwZSkge1xuICAgIHRpdGxlID0gdXJsLnN1YnN0cmluZygwLCB1cmwuaW5kZXhPZihzZXJ2ZXJUeXBlKSk7XG4gICAgdGl0bGUgPSB0aXRsZS5zdWJzdHJpbmcodGl0bGUubGFzdEluZGV4T2YoXCIvXCIpICsgMSwgdGl0bGUubGVuZ3RoKTtcbiAgfVxuICByZXR1cm4gdGl0bGU7XG59XG4vKipcbiAqIGdldCBuYW1lIG9mIHNlcnZpY2UgZnJvbSBVUkxcbiAqIEBsYXllciBncm91cCBsYXllciBvciBhZG1pblNlcnZpY2VJbmZvXG4gKiBAcmV0dXJuIENvbGxlY2N0aW9uIG9mIGxheWVycyBhbmQgdGFibGVzXG4gKi9cbmZ1bmN0aW9uIGdldExheWVyc0FuZFRhYmxlcyhsYXllcikge1xuICB2YXIgX2EsIF9iLCBfYztcbiAgaWYgKCgoX2EgPSBsYXllci5sYXllcnMpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5sZW5ndGgpICYmICgoX2IgPSBsYXllci50YWJsZXMpID09PSBudWxsIHx8IF9iID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYi5sZW5ndGgpKSB7XG4gICAgcmV0dXJuIGxheWVyLmxheWVycy5jb25jYXQobGF5ZXIudGFibGVzKTtcbiAgfVxuICBlbHNlIGlmICgoX2MgPSBsYXllci5sYXllcnMpID09PSBudWxsIHx8IF9jID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYy5sZW5ndGgpIHtcbiAgICByZXR1cm4gbGF5ZXIubGF5ZXJzO1xuICB9XG4gIGVsc2Uge1xuICAgIHJldHVybiBsYXllci50YWJsZXM7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gY2FuU3dhcChzd2FwSXRlbSwgcHJvcHMpIHtcbiAgdmFyIF9hLCBfYiwgX2MsIF9kLCBfZTtcbiAgY29uc3QgeyBsYXllckl0ZW0sIGxheWVyLCBhZG1pblNlcnZpY2VJbmZvLCBtb2R1bGVzLCBzdHJpbmdzIH0gPSBwcm9wcztcbiAgY29uc3QgeyBMYXllciwgUG9ydGFsSXRlbSB9ID0gbW9kdWxlcztcbiAgcHJvcHMuc3dhcEl0ZW0gPSBwcm9wcy5zd2FwTGF5ZXIgPSB1bmRlZmluZWQ7XG4gIGlmIChsYXllckl0ZW0uaWQgPT09IHN3YXBJdGVtLmlkKSB7XG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShcIlwiKTtcbiAgfVxuICBjb25zdCBwb3J0YWxJdGVtID0gUG9ydGFsSXRlbS5mcm9tSlNPTihzd2FwSXRlbSk7XG4gIGF3YWl0IHBvcnRhbEl0ZW0ubG9hZCgpO1xuICBjb25zdCBzd2FwTGF5ZXIgPSBhd2FpdCBMYXllci5mcm9tUG9ydGFsSXRlbSh7XG4gICAgcG9ydGFsSXRlbVxuICB9KTtcbiAgaWYgKGxheWVyLnR5cGUgIT09IHN3YXBMYXllci50eXBlKSB7XG4gICAgY29uc29sZS5sb2coXCJsYXllciB0eXBlIGRvZXMgbm90IG1hdGNoLFwiLCBsYXllci50eXBlLCBcIiE9XCIsIHN3YXBMYXllci50eXBlKTtcbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHN0cmluZ3MubXNnLnN3YXBFcnJvcnMubGF5ZXJUeXBlKTtcbiAgfVxuICBpZiAobGF5ZXIudHlwZSA9PT0gXCJncm91cFwiKSB7XG4gICAgLy8gZ3JvdXAgbGF5ZXIgaGFzIG5vIGxheWVycyBvciB0YWJsZXMgYXQgdGhpcyBwb2ludFxuICAgIC8vIGxvYWRBbGwoKSBsb2FkcyBsYXllcnMsIHRhYmxlcyAoYXQgdjQuMjMpIGFuZCBjYXBhYmlsaXRpZXNcbiAgICBhd2FpdCBzd2FwTGF5ZXIubG9hZEFsbCgpO1xuICB9XG4gIGVsc2Uge1xuICAgIC8vIFwiZmVhdHVyZVwiXG4gICAgYXdhaXQgc3dhcExheWVyLmxvYWQoKTtcbiAgfVxuICAvLyBpZiB2aWV3IGhhcyBlZGl0b3IgdHJhY2tpbmcgc3dhcCBoYXMgdG8gaGF2ZSBpdCB0b28gKGNoZWNrIHNlcnZpY2UpXG4gIC8vIHN5bmNcbiAgaWYgKGxheWVyLnR5cGUgPT09IFwiZ3JvdXBcIikge1xuICAgIC8vIGp1c3QgbmVlZCB0byBjaGVjayBvbmUgc3VibGF5ZXIvdGFibGVcbiAgICBjb25zdCBoYXNTeW5jID0gYWRtaW5TZXJ2aWNlSW5mby5sYXllcnNbMF0uY2FwYWJpbGl0aWVzLmluZGV4T2YoXCJTeW5jXCIpID4gLTE7XG4gICAgY29uc3QgZmlyc3RTd2FwTHlyID0gKCgoX2EgPSBzd2FwTGF5ZXIubGF5ZXJzKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EubGVuZ3RoKSA/IHN3YXBMYXllci5sYXllcnMgOiBzd2FwTGF5ZXIudGFibGVzKS5nZXRJdGVtQXQoMCk7XG4gICAgY29uc3Qgc3dhcEhhc1N5bmMgPSBmaXJzdFN3YXBMeXIuc291cmNlSlNPTi5jYXBhYmlsaXRpZXMuaW5kZXhPZihcIlN5bmNcIikgPiAtMTtcbiAgICBpZiAoaGFzU3luYyAhPT0gc3dhcEhhc1N5bmMpIHtcbiAgICAgIGNvbnNvbGUubG9nKFwibmV3IHNvdXJjZSBsYXllciBTeW5jIG5vdCBtYXRjaGluZ1wiKTtcbiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoc3RyaW5ncy5tc2cuc3dhcEVycm9ycy5zeW5jKTtcbiAgICB9XG4gIH1cbiAgZWxzZSB7XG4gICAgLy8gXCJmZWF0dXJlXCJcbiAgICBjb25zdCBoYXNTeW5jID0gYWRtaW5TZXJ2aWNlSW5mby5jYXBhYmlsaXRpZXMuaW5kZXhPZihcIlN5bmNcIikgPiAtMTtcbiAgICBjb25zdCBzd2FwSGFzU3luYyA9IHN3YXBMYXllci5zb3VyY2VKU09OLmNhcGFiaWxpdGllcy5pbmRleE9mKFwiU3luY1wiKSA+IC0xO1xuICAgIGlmIChoYXNTeW5jICE9PSBzd2FwSGFzU3luYykge1xuICAgICAgY29uc29sZS5sb2coXCJuZXcgc291cmNlIGxheWVyIFN5bmMgbm90IG1hdGNoaW5nXCIpO1xuICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShzdHJpbmdzLm1zZy5zd2FwRXJyb3JzLnN5bmMpO1xuICAgIH1cbiAgfVxuICAvLyBzYW1lIHN1YmxheWVyc1xuICBpZiAobGF5ZXIudHlwZSA9PT0gXCJncm91cFwiKSB7XG4gICAgLy8gZ3JvdXAgbGF5ZXIgaGFzIG5vIGxheWVycyBvciB0YWJsZXMgYXQgdGhpcyBwb2ludFxuICAgIC8vIGxvYWRBbGwoKSBsb2FkcyBsYXllcnMgYW5kIHRhYmxlcyAoYXQgdjQuMjMpXG4gICAgaWYgKCgoX2IgPSBsYXllci5sYXllcnMpID09PSBudWxsIHx8IF9iID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYi5sZW5ndGgpICE9PSAoKF9jID0gc3dhcExheWVyLmxheWVycykgPT09IG51bGwgfHwgX2MgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9jLmxlbmd0aCkgfHwgKChfZCA9IGxheWVyLnRhYmxlcykgPT09IG51bGwgfHwgX2QgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9kLmxlbmd0aCkgIT09ICgoX2UgPSBzd2FwTGF5ZXIudGFibGVzKSA9PT0gbnVsbCB8fCBfZSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2UubGVuZ3RoKSkge1xuICAgICAgY29uc29sZS5sb2coXCJsYXllciBzdWJsYXllcnMgY291bnQgZG9lcyBub3QgbWF0Y2hcIik7XG4gICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHN0cmluZ3MubXNnLnN3YXBFcnJvcnMubGF5ZXJDb3VudCk7XG4gICAgfVxuICB9XG4gIC8vIENoYW5nZSBpbiBzdWJsYXllcnMgb3IgZmllbGRzXG4gIGlmIChsYXllci50eXBlID09PSBcImdyb3VwXCIpIHtcbiAgICBjb25zdCBsYXllcnNBbmRUYWJsZXMgPSBnZXRMYXllcnNBbmRUYWJsZXMobGF5ZXIpO1xuICAgIGNvbnN0IHN3YXBMYXllcnNBbmRUYWJsZXMgPSBnZXRMYXllcnNBbmRUYWJsZXMoc3dhcExheWVyKTtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxheWVyc0FuZFRhYmxlcy5sZW5ndGg7IGkrKykge1xuICAgICAgY29uc3Qgc3ViTGF5ZXIgPSBsYXllcnNBbmRUYWJsZXMuZ2V0SXRlbUF0KGkpO1xuICAgICAgY29uc3Qgc3dhcFN1YkxheWVyID0gc3dhcExheWVyc0FuZFRhYmxlcy5nZXRJdGVtQXQoaSk7XG4gICAgICAvL2NvbnNvbGUubG9nKFwic3VibGF5ZXJcIiwgaSwgc3ViTGF5ZXIsIFwiPT1cIiwgc3dhcFN1YkxheWVyKTtcbiAgICAgIGxldCBjaGVjayA9IGNoZWNrU3ViTGF5ZXJzKHN1YkxheWVyLCBzd2FwU3ViTGF5ZXIsIHByb3BzKTtcbiAgICAgIGlmIChjaGVjaykge1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKGNoZWNrKTtcbiAgICAgIH1cbiAgICAgIGNoZWNrID0gY2hlY2tGaWVsZHMoc3ViTGF5ZXIsIHN3YXBTdWJMYXllciwgcHJvcHMpO1xuICAgICAgaWYgKGNoZWNrKSB7XG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoY2hlY2spO1xuICAgICAgfVxuICAgIH1cbiAgfVxuICBlbHNlIHtcbiAgICAvLyBcImZlYXR1cmVcIlxuICAgIGxldCBjaGVjayA9IGNoZWNrU3ViTGF5ZXJzKGxheWVyLCBzd2FwTGF5ZXIsIHByb3BzKTtcbiAgICBpZiAoY2hlY2spIHtcbiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoY2hlY2spO1xuICAgIH1cbiAgICBjaGVjayA9IGNoZWNrRmllbGRzKGxheWVyLCBzd2FwTGF5ZXIsIHByb3BzKTtcbiAgICBpZiAoY2hlY2spIHtcbiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoY2hlY2spO1xuICAgIH1cbiAgfVxuICBwcm9wcy5zd2FwSXRlbSA9IHN3YXBJdGVtO1xuICBwcm9wcy5zd2FwTGF5ZXIgPSBzd2FwTGF5ZXI7XG4gIHJldHVybiBQcm9taXNlLnJlc29sdmUobnVsbCk7XG59XG5hc3luYyBmdW5jdGlvbiBzd2FwU291cmNlKHByb3BzKSB7XG4gIHZhciBfYSwgX2I7XG4gIGxldCB7IGxheWVyLCBsYXllcklkcywgbW9kdWxlcyB9ID0gcHJvcHM7XG4gIGNvbnN0IHsgUG9ydGFsSXRlbSB9ID0gbW9kdWxlcztcbiAgY29uc3QgeyB2aWV3LCBzd2FwSXRlbSwgc3dhcExheWVyIH0gPSBwcm9wcztcbiAgY29uc3QgW2VzcmlSZXF1ZXN0XSA9IGF3YWl0IGxvYWRNb2R1bGVzKFtcImVzcmkvcmVxdWVzdFwiXSk7XG4gIHRyeSB7XG4gICAgYXdhaXQgZW1wdHlWaWV3KHByb3BzLCBlc3JpUmVxdWVzdCk7XG4gICAgY29uc3QgcG9ydGFsSXRlbSA9IFBvcnRhbEl0ZW0uZnJvbUpTT04oc3dhcEl0ZW0pO1xuICAgIGF3YWl0IHBvcnRhbEl0ZW0ubG9hZCgpO1xuICAgIC8vY29uc3Qgb2xkTGF5ZXJJdGVtID0gcHJvcHMubGF5ZXJJdGVtO1xuICAgIC8vY29uc3Qgb2xkTGF5ZXIgPSBsYXllcjtcbiAgICBwcm9wcy5sYXllckl0ZW0gPSBwb3J0YWxJdGVtO1xuICAgIHByb3BzLmxheWVyID0gc3dhcExheWVyO1xuICAgIHByb3BzLnN3YXBJdGVtID0gcHJvcHMuc3dhcExheWVyID0gdW5kZWZpbmVkO1xuICAgIC8vIHdlIHdhbnQgdG8gYmVoYXZlIGFzIGlmIHdlJ3JlIGNyZWF0aW5nIGEgbmV3IHZpZXdcbiAgICAvLyBjdXJyZW50IHNldHRpbmdzIGFyZSBiYXNlZCBvZmYgdGhlIHNvdXJjZSBpdGVtXG4gICAgY29uc3Qgc2F2ZWRWaWV3SXRlbSA9IHByb3BzLnZpZXdJdGVtO1xuICAgIHByb3BzLnZpZXdJdGVtID0gdW5kZWZpbmVkO1xuICAgIHByb3BzLmFkbWluU2VydmljZUluZm8gPSB1bmRlZmluZWQ7XG4gICAgYXdhaXQgZ2V0QWRtaW5TZXJ2aWNlSW5mbyQxKHByb3BzKTtcbiAgICBhd2FpdCBpbml0aWFsQWRkVG9EZWZpbml0aW9uKHByb3BzLCB7IHNlcnZpY2V1cmw6IHNhdmVkVmlld0l0ZW0udXJsIH0sIGVzcmlSZXF1ZXN0KTtcbiAgICBwcm9wcy52aWV3SXRlbSA9IHNhdmVkVmlld0l0ZW07XG4gICAgLy8gbm93IGdldCB2aWV3IGluZm9cbiAgICBwcm9wcy5hZG1pblNlcnZpY2VJbmZvID0gdW5kZWZpbmVkO1xuICAgIGF3YWl0IGdldEFkbWluU2VydmljZUluZm8kMShwcm9wcyk7XG4gICAgLyogY29uc29sZS5sb2coXG4gICAgICBcInZpZXcgYWRtaW5TZXJ2aWNlSW5mbyBsYXllcnNcIixcbiAgICAgIHByb3BzLmFkbWluU2VydmljZUluZm8/LmxheWVycz8ubWFwKChseXI6IGFueSkgPT4ge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIGlkOiBseXIuaWQsXG4gICAgICAgICAgbmFtZTogbHlyLm5hbWUsXG4gICAgICAgICAgYWRtaW5MYXllckluZm9fZmlsdGVyOiBseXIuYWRtaW5MYXllckluZm8/LnZpZXdMYXllckRlZmluaXRpb24/LnRhYmxlPy5maWx0ZXI/LnZhbHVlLFxuICAgICAgICAgIHZpZXdEZWZpbml0aW9uUXVlcnk6IGx5ci52aWV3RGVmaW5pdGlvblF1ZXJ5LFxuICAgICAgICAgIGZpZWxkczogbHlyLmZpZWxkcy5tYXAoKGZpZWxkOiBhbnkpID0+IGAke2ZpZWxkLm5hbWV9ICgke2ZpZWxkLnZpc2libGV9KWApXG4gICAgICAgIH07XG4gICAgICB9KVxuICAgICk7ICovXG4gICAgLy8gdXBkYXRlIG1hcFxuICAgIHZpZXcubWFwLnJlbW92ZShsYXllcik7XG4gICAgbGF5ZXIgPSBwcm9wcy5sYXllcjtcbiAgICBpZiAobGF5ZXIudHlwZSA9PT0gXCJncm91cFwiKSB7XG4gICAgICBpZiAoKF9hID0gbGF5ZXIubGF5ZXJzKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EubGVuZ3RoKSB7XG4gICAgICAgIC8vIGhhcyBhdCBsZWFzdCBvbmUgc3BhdGlhbCBsYXllclxuICAgICAgICBpZiAobGF5ZXJJZHMpIHtcbiAgICAgICAgICAvLyBvbmx5IG1ha2UgaW5jbHVkZWQgc3VibGF5ZXJzIHZpc2libGVcbiAgICAgICAgICBsYXllci5sYXllcnMuZm9yRWFjaCgoc3ViTGF5ZXIpID0+IHtcbiAgICAgICAgICAgIHN1YkxheWVyLnZpc2libGUgPSBsYXllcklkcy5pbmRleE9mKHN1YkxheWVyLmxheWVySWQpID4gLTE7XG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICAgdmlldy5tYXAuYWRkKGxheWVyKTtcbiAgICAgIH1cbiAgICAgIC8vIGRlZmF1bHQgcG9wdXBzXG4gICAgICAoX2IgPSBsYXllci5sYXllcnMpID09PSBudWxsIHx8IF9iID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYi5mb3JFYWNoKChseXIpID0+IHtcbiAgICAgICAgaWYgKCFseXIucG9wdXBUZW1wbGF0ZSAmJiBseXIucG9wdXBFbmFibGVkKSB7XG4gICAgICAgICAgbHlyLnBvcHVwVGVtcGxhdGUgPSBseXIuY3JlYXRlUG9wdXBUZW1wbGF0ZSgpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICBpZiAoIWxheWVyLmlzVGFibGUpIHtcbiAgICAgICAgdmlldy5tYXAuYWRkKGxheWVyKTtcbiAgICAgIH1cbiAgICAgIC8vIGRlZmF1bHQgcG9wdXBcbiAgICAgIGxheWVyLnBvcHVwVGVtcGxhdGUgPSBsYXllci5jcmVhdGVQb3B1cFRlbXBsYXRlKCk7XG4gICAgfVxuICAgIC8vIGFwcGx5IGNvcnJlY3QgZmlsdGVyIGFuZCBBT0kgb24gbWFwXG4gICAgZ2V0TGF5ZXJzQW5kVGFibGVzKHByb3BzLmFkbWluU2VydmljZUluZm8pLmZvckVhY2goYXN5bmMgKGxheWVySW5mbykgPT4ge1xuICAgICAgdmFyIF9hLCBfYiwgX2MsIF9kO1xuICAgICAgY29uc3Qgd2hlcmVDbGF1c2UgPSBsYXllckluZm8udmlld0RlZmluaXRpb25RdWVyeTtcbiAgICAgIGlmICh3aGVyZUNsYXVzZSkge1xuICAgICAgICBhcHBseUxheWVyRmlsdGVyKHdoZXJlQ2xhdXNlLCBsYXllckluZm8uaWQsIHByb3BzKTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IGFvaVZhbHVlID0gKF9kID0gKF9jID0gKF9iID0gKF9hID0gbGF5ZXJJbmZvLmFkbWluTGF5ZXJJbmZvKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2Eudmlld0xheWVyRGVmaW5pdGlvbikgPT09IG51bGwgfHwgX2IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9iLnRhYmxlKSA9PT0gbnVsbCB8fCBfYyA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2MuZmlsdGVyKSA9PT0gbnVsbCB8fCBfZCA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2QudmFsdWU7XG4gICAgICBpZiAoYW9pVmFsdWUpIHtcbiAgICAgICAgY29uc3QgZ2VvbWV0cnkgPSBhb2lWYWx1ZS5nZW9tZXRyeS5yaW5nc1xuICAgICAgICAgID8gbW9kdWxlcy5Qb2x5Z29uLmZyb21KU09OKGFvaVZhbHVlLmdlb21ldHJ5KVxuICAgICAgICAgIDogbW9kdWxlcy5FeHRlbnQuZnJvbUpTT04oYW9pVmFsdWUuZ2VvbWV0cnkpO1xuICAgICAgICBhcHBseUxheWVyQU9JKGdlb21ldHJ5LCBsYXllckluZm8uaWQsIHByb3BzKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuICBjYXRjaCAoZSkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgoXywgcmVqZWN0KSA9PiB7XG4gICAgICByZWplY3QobmV3IEVycm9yKFwic3dhcCBzb3VyY2UgZmFpbGVkXCIpKTtcbiAgICB9KTtcbiAgfVxufVxuZnVuY3Rpb24gY2hlY2tTdWJMYXllcnMobGF5ZXIsIHN3YXBMYXllciwgcHJvcHMpIHtcbiAgY29uc3QgeyBzdHJpbmdzIH0gPSBwcm9wcztcbiAgaWYgKGxheWVyLmdlb21ldHJ5VHlwZSAhPT0gc3dhcExheWVyLmdlb21ldHJ5VHlwZSkge1xuICAgIGNvbnNvbGUubG9nKFwibGF5ZXIgZ2VvbWV0cnkgdHlwZSBkb2VzIG5vdCBtYXRjaFwiKTtcbiAgICByZXR1cm4gc3RyaW5ncy5tc2cuc3dhcEVycm9ycy5nZW9tZXRyeVR5cGU7XG4gIH1cbiAgaWYgKEpTT04uc3RyaW5naWZ5KGxheWVyLnNwYXRpYWxSZWZlcmVuY2UudG9KU09OKCkpICE9PSBKU09OLnN0cmluZ2lmeShzd2FwTGF5ZXIuc3BhdGlhbFJlZmVyZW5jZS50b0pTT04oKSkpIHtcbiAgICBjb25zb2xlLmxvZyhcImxheWVyIHNwYXRpYWwgcmVmZXJlbmNlIGRvZXMgbm90IG1hdGNoXCIpO1xuICAgIHJldHVybiBzdHJpbmdzLm1zZy5zd2FwRXJyb3JzLnNwYXRpYWxSZWZlcmVuY2U7XG4gIH1cbiAgcmV0dXJuIG51bGw7XG59XG5mdW5jdGlvbiBjaGVja0ZpZWxkcyhsYXllciwgc3dhcExheWVyLCBwcm9wcykge1xuICAvLyBhbGwgdmlzaWJsZSBmaWVsZHMgaW4gY3VycmVudCB2aWV3IG11c3QgYmUgY29udGFpbmVkIGluIG5ldyBzb3VyY2VcbiAgY29uc3QgeyBzdHJpbmdzIH0gPSBwcm9wcztcbiAgY29uc3QgcmVxdWlyZWRGaWVsZE5hbWVzID0gZ2V0UmVxdWlyZWRGaWVsZE5hbWVzKHByb3BzLCBsYXllcik7XG4gIGNvbnN0IHZpZXdMYXllclByb3BzID0gZ2V0Vmlld0xheWVyUHJvcHMobGF5ZXIubGF5ZXJJZCwgcHJvcHMpO1xuICBsZXQgdmlzRmllbGRzO1xuICBpZiAodmlld0xheWVyUHJvcHMgPT09IG51bGwgfHwgdmlld0xheWVyUHJvcHMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHZpZXdMYXllclByb3BzLmZpZWxkcykge1xuICAgIGNvbnN0IGFsbEZpZWxkcyA9IHZpZXdMYXllclByb3BzLmZpZWxkcy5jb25jYXQocmVxdWlyZWRGaWVsZE5hbWVzKTtcbiAgICB2aXNGaWVsZHMgPSBsYXllci5maWVsZHMuZmlsdGVyKChmaWVsZCkgPT4gYWxsRmllbGRzLmluZGV4T2YoZmllbGQubmFtZSkgPiAtMSk7XG4gIH1cbiAgZWxzZSB7XG4gICAgdmlzRmllbGRzID0gbGF5ZXIuZmllbGRzO1xuICB9XG4gIC8vY29uc29sZS5sb2coXCJjaGVja0ZpZWxkcyAtIHZpc0ZpZWxkc1wiLCB2aXNGaWVsZHMubWFwKChmKSA9PmYubmFtZSkpO1xuICAvL2NvbnNvbGUubG9nKFwic3dhcExheWVyIC0gZmllbGRzXCIsIHN3YXBMYXllci5maWVsZHMubWFwKChmKSA9PiBmLm5hbWUpKTtcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCB2aXNGaWVsZHMubGVuZ3RoOyBpKyspIHtcbiAgICBjb25zdCBmaWVsZCA9IHZpc0ZpZWxkc1tpXTtcbiAgICBjb25zdCBzd2FwRmllbGQgPSBzd2FwTGF5ZXIuZmllbGRzLmZpbmQoKHN3YXBGaWVsZCkgPT4gZmllbGQubmFtZSA9PT0gc3dhcEZpZWxkLm5hbWUpO1xuICAgIGlmICghc3dhcEZpZWxkKSB7XG4gICAgICAvL2lmIChbXCJnbG9iYWwtaWRcIiwgXCJvaWRcIl0uaW5kZXhPZihmaWVsZC50eXBlKSA9PT0gLTEpIHtcbiAgICAgIGNvbnNvbGUubG9nKFwibGF5ZXJcIiwgbGF5ZXIubGF5ZXJJZCwgbGF5ZXIudGl0bGUsIFwiOiBmaWVsZFwiLCBmaWVsZC5uYW1lLCBcIm1pc3NpbmcgaW4gbmV3IHNvdXJjZSBsYXllclwiKTtcbiAgICAgIHJldHVybiBzdHJpbmdzLm1zZy5zd2FwRXJyb3JzLm1pc3NpbmdGaWVsZDtcbiAgICAgIC8vfSBlbHNlIHtcbiAgICAgIC8vICBjb25zb2xlLmxvZyhcImZpZWxkXCIsIGZpZWxkLm5hbWUsIFwibWlzc2luZyBpbiBuZXcgc291cmNlIGxheWVyLCBpZ25vcmluZ1wiKTtcbiAgICAgIC8vfVxuICAgIH1cbiAgICBlbHNlIGlmIChmaWVsZC50eXBlICE9PSBzd2FwRmllbGQudHlwZSkge1xuICAgICAgY29uc29sZS5sb2coXCJsYXllclwiLCBsYXllci5sYXllcklkLCBsYXllci50aXRsZSwgXCI6IGZpZWxkIHR5cGUgb2ZcIiwgZmllbGQubmFtZSwgXCJkaWZmZXJlbnQgaW4gbGF5ZXJzXCIpO1xuICAgICAgcmV0dXJuIHN0cmluZ3MubXNnLnN3YXBFcnJvcnMuZmllbGRUeXBlO1xuICAgIH1cbiAgfVxuICByZXR1cm4gbnVsbDtcbn1cblxuLyoqXG4gKiBnZXQgYSBzdWdnZXN0ZWQgdGl0bGUgZm9yIHRoZSB2aWV3XG4gKiBAcGFyYW0gcHJvcHMgLSBMYXllclZpZXdQcm9wc1xuICovXG5hc3luYyBmdW5jdGlvbiBnZXRTdWdnZXN0ZWRUaXRsZShwcm9wcykge1xuICB2YXIgX2EsIF9iO1xuICBjb25zdCB7IGxheWVySXRlbSwgbGF5ZXIsIHN0cmluZ3MgfSA9IHByb3BzO1xuICBjb25zdCBbZXNyaVJlcXVlc3RdID0gYXdhaXQgbG9hZE1vZHVsZXMoW1wiZXNyaS9yZXF1ZXN0XCJdKTtcbiAgY29uc3QgcmVsYXRlZFVybCA9IGAke2xheWVySXRlbS5pdGVtVXJsfS9yZWxhdGVkSXRlbXNgO1xuICBjb25zdCByZWxhdGVkQ29udGVudCA9IHtcbiAgICByZWxhdGlvbnNoaXBUeXBlOiBcIlNlcnZpY2UyU2VydmljZVwiLFxuICAgIGRpcmVjdGlvbjogXCJmb3J3YXJkXCJcbiAgfTtcbiAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZXNyaVJlcXVlc3QocmVsYXRlZFVybCwge1xuICAgIHF1ZXJ5OiBPYmplY3QuYXNzaWduKE9iamVjdC5hc3NpZ24oe30sIHJlbGF0ZWRDb250ZW50KSwgeyBmOiBcImpzb25cIiwgdG9rZW46IGxheWVyLnBvcnRhbEl0ZW0ucG9ydGFsLmNyZWRlbnRpYWwudG9rZW4gfSksXG4gICAgbWV0aG9kOiBcInBvc3RcIixcbiAgICByZXNwb25zZVR5cGU6IFwianNvblwiXG4gIH0pO1xuICAvLyBjaGVjayB3aXRoIHNwYWNlcyBhbmQgdW5kZXJzY29yZXNcbiAgY29uc3Qgdmlld0l0ZW1zID0gKChfYiA9IChfYSA9IHJlc3VsdCA9PT0gbnVsbCB8fCByZXN1bHQgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHJlc3VsdC5kYXRhKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EucmVsYXRlZEl0ZW1zKSA9PT0gbnVsbCB8fCBfYiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2IuZmlsdGVyKChpdGVtKSA9PiBpdGVtLnR5cGUgPT09IFwiRmVhdHVyZSBTZXJ2aWNlXCIgJiZcbiAgICAoaXRlbS50aXRsZS5pbmRleE9mKGxheWVySXRlbS50aXRsZSkgPiAtMSB8fFxuICAgICAgaXRlbS50aXRsZS5pbmRleE9mKGxheWVySXRlbS50aXRsZS5yZXBsYWNlKC8gL2csIFwiX1wiKSkgPiAtMSB8fFxuICAgICAgaXRlbS50aXRsZS5yZXBsYWNlKC8gL2csIFwiX1wiKS5pbmRleE9mKGxheWVySXRlbS50aXRsZSkgPiAtMSkpKSB8fCBbXTtcbiAgcmV0dXJuIGAke2xheWVySXRlbS50aXRsZX0ke3ZpZXdJdGVtcy5sZW5ndGggPyBgICR7dmlld0l0ZW1zLmxlbmd0aCArIDF9YCA6IGBgfSAke3N0cmluZ3MuY3JlYXRlVmlldy52aWV3fWA7XG59XG4vKipcbiAqIE1ha2UgYWRtaW4gc2VydmljZSBpbmZvIHJlcXVlc3QgZm9yIHZpZXcgbGF5ZXJcbiAqIEBwYXJhbSBwcm9wcyAtIExheWVyVmlld1Byb3BzXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIGdldEFkbWluU2VydmljZUluZm8kMShwcm9wcywgbm9DYWNoZSkge1xuICBjb25zdCB7IGxheWVyLCB2aWV3SXRlbSwgYWRtaW5TZXJ2aWNlSW5mbyB9ID0gcHJvcHM7XG4gIGlmIChhZG1pblNlcnZpY2VJbmZvKSB7XG4gICAgcmV0dXJuO1xuICB9XG4gIGNvbnN0IHNlcnZpY2VVcmwgPSAodmlld0l0ZW0gPT09IG51bGwgfHwgdmlld0l0ZW0gPT09IHZvaWQgMCA/IHZvaWQgMCA6IHZpZXdJdGVtLnVybCkgfHwgbGF5ZXIucG9ydGFsSXRlbS51cmw7XG4gIGxldCBhZG1pblVybCA9IHNlcnZpY2VVcmwucmVwbGFjZShcIi9yZXN0L3NlcnZpY2VzXCIsIFwiL3Jlc3QvYWRtaW4vc2VydmljZXNcIik7XG4gIGlmIChub0NhY2hlKSB7XG4gICAgYWRtaW5VcmwgKz0gYCR7YWRtaW5VcmwuaW5kZXhPZihcIj9cIikgPiAtMSA/IFwiJlwiIDogXCI/XCJ9X3RzPSR7bmV3IERhdGUoKS5nZXRUaW1lKCl9YDtcbiAgfVxuICB0cnkge1xuICAgIGNvbnN0IFtJZGVudGl0eU1hbmFnZXIsIGVzcmlSZXF1ZXN0XSA9IGF3YWl0IGxvYWRNb2R1bGVzKFtcImVzcmkvaWRlbnRpdHkvSWRlbnRpdHlNYW5hZ2VyXCIsIFwiZXNyaS9yZXF1ZXN0XCJdKTtcbiAgICBhd2FpdCBJZGVudGl0eU1hbmFnZXIuZ2V0Q3JlZGVudGlhbChhZG1pblVybCk7XG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBlc3JpUmVxdWVzdChhZG1pblVybCwge1xuICAgICAgcXVlcnk6IHsgZjogXCJqc29uXCIgfVxuICAgIH0pO1xuICAgIHByb3BzLmFkbWluU2VydmljZUluZm8gPSByZXNwb25zZS5kYXRhO1xuICB9XG4gIGNhdGNoIChlKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChfLCByZWplY3QpID0+IHtcbiAgICAgIHJlamVjdChuZXcgRXJyb3IoXCJjb3VsZCBub3QgZ2V0IGFkbWluIGluZm9cIikpO1xuICAgIH0pO1xuICB9XG59XG4vKipcbiAqIENyZWF0ZXMgbGF5ZXIgdmlld1xuICogQHBhcmFtIGxheWVySWQgLSBsYXllciBpZFxuICogQHBhcmFtIHByb3BzIC0gTGF5ZXJWaWV3UHJvcHNcbiAqL1xuZnVuY3Rpb24gZ2V0QWRtaW5MYXllckluZm8obGF5ZXJJZCwgcHJvcHMpIHtcbiAgdmFyIF9hLCBfYjtcbiAgY29uc3QgeyBhZG1pblNlcnZpY2VJbmZvIH0gPSBwcm9wcztcbiAgY29uc3QgbGF5ZXIgPSAoX2EgPSBhZG1pblNlcnZpY2VJbmZvID09PSBudWxsIHx8IGFkbWluU2VydmljZUluZm8gPT09IHZvaWQgMCA/IHZvaWQgMCA6IGFkbWluU2VydmljZUluZm8ubGF5ZXJzKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EuZmluZCgobGF5ZXIpID0+IGxheWVyLmlkID09PSBsYXllcklkKTtcbiAgaWYgKCFsYXllcikge1xuICAgIHJldHVybiAoX2IgPSBhZG1pblNlcnZpY2VJbmZvID09PSBudWxsIHx8IGFkbWluU2VydmljZUluZm8gPT09IHZvaWQgMCA/IHZvaWQgMCA6IGFkbWluU2VydmljZUluZm8udGFibGVzKSA9PT0gbnVsbCB8fCBfYiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2IuZmluZCgodGFibGUpID0+IHRhYmxlLmlkID09PSBsYXllcklkKTtcbiAgfVxuICByZXR1cm4gbGF5ZXI7XG59XG4vKipcbiAqIFJldHVybnMgdHJ1ZSBpZiB0aGUgdXNlciBtYWRlIHJlY2VudCBjaGFuZ2VzXG4gKiBAcGFyYW0gcHJvcHNcbiAqIEByZXR1cm5zIGJvb2xlYW5cbiAqL1xuZnVuY3Rpb24gaGFzQ2hhbmdlcyhwcm9wcykge1xuICBjb25zdCB7IGxheWVyLCBsYXllcklkcywgYWRtaW5TZXJ2aWNlSW5mbyB9ID0gcHJvcHM7XG4gIGlmIChsYXllci50eXBlID09PSBcImdyb3VwXCIpIHtcbiAgICBjb25zdCBsYXllcnNBbmRUYWJsZXMgPSBhZG1pblNlcnZpY2VJbmZvICYmIGdldExheWVyc0FuZFRhYmxlcyhhZG1pblNlcnZpY2VJbmZvKTtcbiAgICBjb25zdCBjb250YWluc0FsbExheWVycyA9IGFkbWluU2VydmljZUluZm8gJiZcbiAgICAgIGxheWVyc0FuZFRhYmxlcy5sZW5ndGggPT09IGxheWVySWRzLmxlbmd0aCAmJlxuICAgICAgbGF5ZXJzQW5kVGFibGVzLmV2ZXJ5KChseXIpID0+IGxheWVySWRzLmluZGV4T2YobHlyLmlkKSA+IC0xKTtcbiAgICByZXR1cm4gKCFjb250YWluc0FsbExheWVycyB8fFxuICAgICAgZ2V0TGF5ZXJzQW5kVGFibGVzKGxheWVyKVxuICAgICAgICAuZmlsdGVyKChmTGF5ZXIpID0+IGxheWVySWRzLmluZGV4T2YoZkxheWVyLmxheWVySWQpID4gLTEpXG4gICAgICAgIC5zb21lKChmTGF5ZXIpID0+IGhhc0xheWVyQ2hhbmdlcyhmTGF5ZXIubGF5ZXJJZCwgcHJvcHMpKSk7XG4gIH1cbiAgZWxzZSB7XG4gICAgcmV0dXJuIGhhc0xheWVyQ2hhbmdlcyhsYXllci5sYXllcklkLCBwcm9wcyk7XG4gIH1cbn1cbi8qKlxuICogUmV0dXJucyB0cnVlIGlmIHRoZSB1c2VyIG1hZGUgcmVjZW50IGNoYW5nZXMgdG8gdGhlIGZlYXR1cmUgbGF5ZXJcbiAqIEBwYXJhbSBsYXllcklkXG4gKiBAcGFyYW0gcHJvcHNcbiAqIEByZXR1cm5zXG4gKi9cbmZ1bmN0aW9uIGhhc0xheWVyQ2hhbmdlcyhsYXllcklkLCBwcm9wcykge1xuICB2YXIgX2EsIF9iLCBfYywgX2Q7XG4gIGNvbnN0IHsgdmlld0l0ZW0gfSA9IHByb3BzO1xuICBjb25zdCBmTGF5ZXIgPSBnZXRGTChsYXllcklkLCBwcm9wcyk7XG4gIGNvbnN0IHZpZXdMYXllclByb3BzID0gZ2V0Vmlld0xheWVyUHJvcHMobGF5ZXJJZCwgcHJvcHMpO1xuICBjb25zdCBhZG1pbkxheWVySW5mbyA9IGdldEFkbWluTGF5ZXJJbmZvKGxheWVySWQsIHByb3BzKTtcbiAgLy8gaWdub3JlIGZpZWxkLnZpc2libGUgcHJvcCBvbiBwYXJlbnQgbGF5ZXJzXG4gIGNvbnN0IHZpZXdGaWVsZHMgPSB2aWV3SXRlbSAmJiAoYWRtaW5MYXllckluZm8gPT09IG51bGwgfHwgYWRtaW5MYXllckluZm8gPT09IHZvaWQgMCA/IHZvaWQgMCA6IGFkbWluTGF5ZXJJbmZvLmZpZWxkcylcbiAgICA/IGFkbWluTGF5ZXJJbmZvLmZpZWxkcy5maWx0ZXIoKGZpZWxkKSA9PiBmaWVsZC52aXNpYmxlKVxuICAgIDogKGFkbWluTGF5ZXJJbmZvID09PSBudWxsIHx8IGFkbWluTGF5ZXJJbmZvID09PSB2b2lkIDAgPyB2b2lkIDAgOiBhZG1pbkxheWVySW5mby5maWVsZHMpIHx8IGZMYXllci5maWVsZHM7XG4gIGlmICh2aWV3TGF5ZXJQcm9wcykge1xuICAgIGlmICh2aWV3TGF5ZXJQcm9wcy5maWx0ZXIgIT09IChhZG1pbkxheWVySW5mbyA9PT0gbnVsbCB8fCBhZG1pbkxheWVySW5mbyA9PT0gdm9pZCAwID8gdm9pZCAwIDogYWRtaW5MYXllckluZm8udmlld0RlZmluaXRpb25RdWVyeSkgfHxcbiAgICAgICEhKHZpZXdMYXllclByb3BzLmZpZWxkcyAmJiB2aWV3TGF5ZXJQcm9wcy5maWVsZHMubGVuZ3RoICE9PSB2aWV3RmllbGRzLmxlbmd0aCkgfHxcbiAgICAgICEhKCF2aWV3TGF5ZXJQcm9wcy5maWVsZHMgJiYgdmlld0ZpZWxkcy5sZW5ndGggIT09IGZMYXllci5maWVsZHMubGVuZ3RoKSB8fFxuICAgICAgKCFmTGF5ZXIuaXNUYWJsZSAmJiAhaXNTYW1lQU9JKHZpZXdMYXllclByb3BzLCBhZG1pbkxheWVySW5mbykpKSB7XG4gICAgICAvKiBjb25zb2xlLmxvZyhcbiAgICAgICAgXCJoYXNMYXllckNoYW5nZXM9dHJ1ZSAocHJvcHMpIGlkOlwiLFxuICAgICAgICBsYXllcklkLFxuICAgICAgICBcImZpbHRlcjpcIixcbiAgICAgICAgdmlld0xheWVyUHJvcHMuZmlsdGVyICE9PSBhZG1pbkxheWVySW5mbz8udmlld0RlZmluaXRpb25RdWVyeSxcbiAgICAgICAgLy9gKCR7dmlld0xheWVyUHJvcHMuZmlsdGVyfXwke2FkbWluTGF5ZXJJbmZvPy52aWV3RGVmaW5pdGlvblF1ZXJ5fSlgLFxuICAgICAgICBcImZpZWxkcy1oYXMtcHJvcHM6XCIsXG4gICAgICAgICEhKHZpZXdMYXllclByb3BzLmZpZWxkcyAmJiB2aWV3TGF5ZXJQcm9wcy5maWVsZHMubGVuZ3RoICE9PSB2aWV3RmllbGRzLmxlbmd0aCksXG4gICAgICAgIFwiZmllbGRzLW5vLXByb3BzOlwiLFxuICAgICAgICAhISghdmlld0xheWVyUHJvcHMuZmllbGRzICYmIHZpZXdGaWVsZHMubGVuZ3RoICE9PSBmTGF5ZXIuZmllbGRzLmxlbmd0aCksXG4gICAgICAgIFwiIXNhbWVBT0k6XCIsXG4gICAgICAgICFpc1NhbWVBT0kodmlld0xheWVyUHJvcHMsIGFkbWluTGF5ZXJJbmZvKVxuICAgICAgKTsgKi9cbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgfVxuICBlbHNlIHtcbiAgICBpZiAoKGFkbWluTGF5ZXJJbmZvID09PSBudWxsIHx8IGFkbWluTGF5ZXJJbmZvID09PSB2b2lkIDAgPyB2b2lkIDAgOiBhZG1pbkxheWVySW5mby52aWV3RGVmaW5pdGlvblF1ZXJ5KSB8fFxuICAgICAgdmlld0ZpZWxkcy5sZW5ndGggPCBmTGF5ZXIuZmllbGRzLmxlbmd0aCB8fFxuICAgICAgKCFmTGF5ZXIuaXNUYWJsZSAmJiAoKF9kID0gKF9jID0gKF9iID0gKF9hID0gYWRtaW5MYXllckluZm8gPT09IG51bGwgfHwgYWRtaW5MYXllckluZm8gPT09IHZvaWQgMCA/IHZvaWQgMCA6IGFkbWluTGF5ZXJJbmZvLmFkbWluTGF5ZXJJbmZvKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2Eudmlld0xheWVyRGVmaW5pdGlvbikgPT09IG51bGwgfHwgX2IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9iLnRhYmxlKSA9PT0gbnVsbCB8fCBfYyA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2MuZmlsdGVyKSA9PT0gbnVsbCB8fCBfZCA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2QudmFsdWUpKSkge1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICB9XG4gIHJldHVybiBmYWxzZTtcbn1cbi8qKlxuICogQ3JlYXRlcyBsYXllciB2aWV3XG4gKiBAcGFyYW0gcHJvcHMgLSBMYXllclZpZXdQcm9wc1xuICogQHBhcmFtIG5ld0l0ZW1Qcm9wcyAtIHVzZXIgaW5wdXQgKE5ld0l0ZW1Qcm9wcylcbiAqL1xuYXN5bmMgZnVuY3Rpb24gY3JlYXRlVmlldyhwcm9wcywgbmV3SXRlbVByb3BzKSB7XG4gIGNvbnN0IFtlc3JpUmVxdWVzdF0gPSBhd2FpdCBsb2FkTW9kdWxlcyhbXCJlc3JpL3JlcXVlc3RcIl0pO1xuICB0cnkge1xuICAgIGNvbnN0IGNyZWF0ZVNlcnZpY2VSZXNwb25zZSA9IGF3YWl0IGNyZWF0ZVNlcnZpY2UocHJvcHMsIG5ld0l0ZW1Qcm9wcywgZXNyaVJlcXVlc3QpO1xuICAgIC8vY29uc29sZS5sb2coXCJjcmVhdGVTZXJ2aWNlUmVzcG9uc2VcIiwgY3JlYXRlU2VydmljZVJlc3BvbnNlKTtcbiAgICBhd2FpdCBpbml0aWFsQWRkVG9EZWZpbml0aW9uKHByb3BzLCBjcmVhdGVTZXJ2aWNlUmVzcG9uc2UsIGVzcmlSZXF1ZXN0KTtcbiAgICBhd2FpdCBpbml0aWFsSXRlbVVwZGF0ZShwcm9wcywgY3JlYXRlU2VydmljZVJlc3BvbnNlLCBuZXdJdGVtUHJvcHMsIGVzcmlSZXF1ZXN0KTtcbiAgICBhd2FpdCBtb3ZlVG9Gb2xkZXIocHJvcHMsIGNyZWF0ZVNlcnZpY2VSZXNwb25zZSwgbmV3SXRlbVByb3BzLCBlc3JpUmVxdWVzdCk7XG4gICAgcmV0dXJuIGNyZWF0ZVNlcnZpY2VSZXNwb25zZS5pdGVtSWQ7XG4gIH1cbiAgY2F0Y2ggKGUpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKF8sIHJlamVjdCkgPT4ge1xuICAgICAgaWYgKGUubWVzc2FnZSA9PT0gXCJzZXJ2aWNlIG5hbWUgYWxyZWFkeSBleGlzdHNcIikge1xuICAgICAgICByZWplY3QoZSk7XG4gICAgICB9XG4gICAgICBlbHNlIHtcbiAgICAgICAgcmVqZWN0KG5ldyBFcnJvcihcImNyZWF0ZVZpZXcgZmFpbGVkXCIpKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxufVxuLyoqXG4gKiBDcmVhdGVzIGxheWVyIHZpZXdcbiAqIEBwYXJhbSBwcm9wcyAtIExheWVyVmlld1Byb3BzXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIHVwZGF0ZVZpZXcocHJvcHMpIHtcbiAgY29uc3QgeyB2aWV3SXRlbSB9ID0gcHJvcHM7XG4gIGNvbnN0IFtlc3JpUmVxdWVzdF0gPSBhd2FpdCBsb2FkTW9kdWxlcyhbXCJlc3JpL3JlcXVlc3RcIl0pO1xuICB0cnkge1xuICAgIGNvbnN0IHsgYWRkTGF5ZXJJZHMsIGRlbGV0ZUxheWVySWRzIH0gPSBhd2FpdCB1cGRhdGVEZWZpbml0aW9uKHByb3BzLCB2aWV3SXRlbSwgZXNyaVJlcXVlc3QpO1xuICAgIGF3YWl0IGl0ZW1VcGRhdGUocHJvcHMsIGFkZExheWVySWRzLCBkZWxldGVMYXllcklkcywgZXNyaVJlcXVlc3QpO1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4ge1xuICAgICAgcmVzb2x2ZSgpO1xuICAgIH0pO1xuICB9XG4gIGNhdGNoIChlKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChfLCByZWplY3QpID0+IHtcbiAgICAgIHJlamVjdChuZXcgRXJyb3IoXCJ1cGRhdGVWaWV3IGZhaWxlZFwiKSk7XG4gICAgfSk7XG4gIH1cbn1cbi8qKlxuICogUmVtb3ZlcyBhbGwgbGF5ZXJzIGZyb20gdGhlIHZpZXdcbiAqIEBwYXJhbSBwcm9wcyAtIExheWVyVmlld1Byb3BzXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIGVtcHR5Vmlldyhwcm9wcywgZXNyaVJlcXVlc3QpIHtcbiAgdmFyIF9hLCBfYjtcbiAgY29uc3QgeyBsYXllciwgdmlld0l0ZW0sIGFkbWluU2VydmljZUluZm8gfSA9IHByb3BzO1xuICBjb25zdCBwb3J0YWxJdGVtID0gbGF5ZXIucG9ydGFsSXRlbTtcbiAgLy8gZGVsZXRlXG4gIGNvbnN0IGRlbGV0ZUxheWVySWRzID0gW107XG4gIChfYSA9IGFkbWluU2VydmljZUluZm8gPT09IG51bGwgfHwgYWRtaW5TZXJ2aWNlSW5mbyA9PT0gdm9pZCAwID8gdm9pZCAwIDogYWRtaW5TZXJ2aWNlSW5mby5sYXllcnMpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5mb3JFYWNoKChseXIpID0+IHtcbiAgICBkZWxldGVMYXllcklkcy5wdXNoKGx5ci5pZCk7XG4gIH0pO1xuICBjb25zdCBkZWxldGVUYWJsZUlkcyA9IFtdO1xuICAoX2IgPSBhZG1pblNlcnZpY2VJbmZvID09PSBudWxsIHx8IGFkbWluU2VydmljZUluZm8gPT09IHZvaWQgMCA/IHZvaWQgMCA6IGFkbWluU2VydmljZUluZm8udGFibGVzKSA9PT0gbnVsbCB8fCBfYiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2IuZm9yRWFjaCgobHlyKSA9PiB7XG4gICAgZGVsZXRlVGFibGVJZHMucHVzaChseXIuaWQpO1xuICB9KTtcbiAgaWYgKGRlbGV0ZUxheWVySWRzLmxlbmd0aCB8fCBkZWxldGVUYWJsZUlkcy5sZW5ndGgpIHtcbiAgICBjb25zdCBhZG1pblVybCA9IHZpZXdJdGVtLnVybC5yZXBsYWNlKFwicmVzdC9zZXJ2aWNlc1wiLCBcInJlc3QvYWRtaW4vc2VydmljZXNcIik7XG4gICAgY29uc3QgZGVsZXRlRnJvbURlZlVybCA9IGAke2FkbWluVXJsfS9kZWxldGVGcm9tRGVmaW5pdGlvbmA7XG4gICAgYXdhaXQgZGVsZXRlRnJvbURlZmluaXRpb25SZXF1ZXN0KGRlbGV0ZUZyb21EZWZVcmwsIHtcbiAgICAgIGxheWVyczogZGVsZXRlTGF5ZXJJZHMgPT09IG51bGwgfHwgZGVsZXRlTGF5ZXJJZHMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGRlbGV0ZUxheWVySWRzLm1hcCgoaWQpID0+IHtcbiAgICAgICAgcmV0dXJuIHsgaWQgfTtcbiAgICAgIH0pLFxuICAgICAgdGFibGVzOiBkZWxldGVUYWJsZUlkcyA9PT0gbnVsbCB8fCBkZWxldGVUYWJsZUlkcyA9PT0gdm9pZCAwID8gdm9pZCAwIDogZGVsZXRlVGFibGVJZHMubWFwKChpZCkgPT4ge1xuICAgICAgICByZXR1cm4geyBpZCB9O1xuICAgICAgfSlcbiAgICB9LCBwb3J0YWxJdGVtLCBlc3JpUmVxdWVzdCk7XG4gIH1cbiAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7XG4gICAgcmVzb2x2ZSgpO1xuICB9KTtcbn1cbmZ1bmN0aW9uIGlzU2FtZUFPSSh2aWV3TGF5ZXJQcm9wcywgYWRtaW5MYXllckluZm8pIHtcbiAgdmFyIF9hLCBfYiwgX2MsIF9kO1xuICBjb25zdCBhZG1pbkFPSVZhbHVlID0gKF9kID0gKF9jID0gKF9iID0gKF9hID0gYWRtaW5MYXllckluZm8gPT09IG51bGwgfHwgYWRtaW5MYXllckluZm8gPT09IHZvaWQgMCA/IHZvaWQgMCA6IGFkbWluTGF5ZXJJbmZvLmFkbWluTGF5ZXJJbmZvKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2Eudmlld0xheWVyRGVmaW5pdGlvbikgPT09IG51bGwgfHwgX2IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9iLnRhYmxlKSA9PT0gbnVsbCB8fCBfYyA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2MuZmlsdGVyKSA9PT0gbnVsbCB8fCBfZCA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2QudmFsdWU7XG4gIC8vY29uc29sZS5sb2coXCJpc1NhbWVBT0kgYWRtaW46XCIsIGFkbWluQU9JVmFsdWU/Lmdlb21ldHJ5LCBcInByb3A6XCIsIHZpZXdMYXllclByb3BzPy5hb2kpO1xuICBpZiAoISh2aWV3TGF5ZXJQcm9wcyA9PT0gbnVsbCB8fCB2aWV3TGF5ZXJQcm9wcyA9PT0gdm9pZCAwID8gdm9pZCAwIDogdmlld0xheWVyUHJvcHMuYW9pKSAmJiAhYWRtaW5BT0lWYWx1ZSkge1xuICAgIHJldHVybiB0cnVlO1xuICB9XG4gIGVsc2UgaWYgKCgodmlld0xheWVyUHJvcHMgPT09IG51bGwgfHwgdmlld0xheWVyUHJvcHMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHZpZXdMYXllclByb3BzLmFvaSkgJiYgIWFkbWluQU9JVmFsdWUpIHx8ICghKHZpZXdMYXllclByb3BzID09PSBudWxsIHx8IHZpZXdMYXllclByb3BzID09PSB2b2lkIDAgPyB2b2lkIDAgOiB2aWV3TGF5ZXJQcm9wcy5hb2kpICYmIGFkbWluQU9JVmFsdWUpKSB7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG4gIGlmICgodmlld0xheWVyUHJvcHMuYW9pLnJpbmdzICYmIGFkbWluQU9JVmFsdWUuZ2VvbWV0cnlUeXBlICE9PSBcImVzcmlHZW9tZXRyeVBvbHlnb25cIikgfHxcbiAgICAodmlld0xheWVyUHJvcHMuYW9pLnhtaW4gJiYgYWRtaW5BT0lWYWx1ZS5nZW9tZXRyeVR5cGUgIT09IFwiZXNyaUdlb21ldHJ5RW52ZWxvcGVcIikpIHtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cbiAgaWYgKHZpZXdMYXllclByb3BzLmFvaS54bWluKSB7XG4gICAgY29uc3QgcHJvcHNFeHQgPSB2aWV3TGF5ZXJQcm9wcy5hb2k7XG4gICAgY29uc3QgYWRtaW5FeHQgPSBhZG1pbkFPSVZhbHVlLmdlb21ldHJ5O1xuICAgIC8vIGNvbXBhcmUgY29vcmRzIHdpdGggYSBtYXJnaW47IHNlcnZpY2Ugcm91bmRzIHBhc3NlZCBpbiBjb29yZHNcbiAgICBpZiAoc2FtZUNvb3JkKHByb3BzRXh0LnhtaW4sIGFkbWluRXh0LnhtaW4pICYmXG4gICAgICBzYW1lQ29vcmQocHJvcHNFeHQueG1heCwgYWRtaW5FeHQueG1heCkgJiZcbiAgICAgIHNhbWVDb29yZChwcm9wc0V4dC55bWluLCBhZG1pbkV4dC55bWluKSAmJlxuICAgICAgc2FtZUNvb3JkKHByb3BzRXh0LnltYXgsIGFkbWluRXh0LnltYXgpKSB7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICB9XG4gIGVsc2UgaWYgKHZpZXdMYXllclByb3BzLmFvaS5yaW5ncykge1xuICAgIGlmICh2aWV3TGF5ZXJQcm9wcy5hb2kucmluZ3NbMF0ubGVuZ3RoICE9PSBhZG1pbkFPSVZhbHVlLmdlb21ldHJ5LnJpbmdzWzBdLmxlbmd0aCkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgIGNvbnN0IGlzU2FtZSA9IHZpZXdMYXllclByb3BzLmFvaS5yaW5nc1swXS5ldmVyeSgocHQxKSA9PiB7XG4gICAgICAgIHJldHVybiBhZG1pbkFPSVZhbHVlLmdlb21ldHJ5LnJpbmdzWzBdLnNvbWUoKHB0MikgPT4ge1xuICAgICAgICAgIC8vIGNvbXBhcmUgY29vcmRzIHdpdGggYSBtYXJnaW47IHNlcnZpY2Ugcm91bmRzIHBhc3NlZCBpbiBjb29yZHNcbiAgICAgICAgICByZXR1cm4gc2FtZUNvb3JkKHB0MVswXSwgcHQyWzBdKSAmJiBzYW1lQ29vcmQocHQxWzFdLCBwdDJbMV0pO1xuICAgICAgICB9KTtcbiAgICAgIH0pO1xuICAgICAgcmV0dXJuIGlzU2FtZTtcbiAgICB9XG4gIH1cbn1cbmFzeW5jIGZ1bmN0aW9uIGNyZWF0ZVNlcnZpY2UocHJvcHMsIG5ld0l0ZW1Qcm9wcywgZXNyaVJlcXVlc3QpIHtcbiAgdmFyIF9hLCBfYiwgX2M7XG4gIGNvbnN0IHsgbGF5ZXIsIGxheWVySWRzIH0gPSBwcm9wcztcbiAgY29uc3QgcG9ydGFsSXRlbSA9IGxheWVyLnBvcnRhbEl0ZW07XG4gIGNvbnN0IHBvcnRhbCA9IHBvcnRhbEl0ZW0ucG9ydGFsO1xuICBsZXQgZmwgPSBnZXRGTChsYXllcklkc1swXSwgcHJvcHMpO1xuICBjb25zdCBjcmVhdGVTZXJ2aWNlVXJsID0gYCR7cG9ydGFsLnJlc3RVcmx9L2NvbnRlbnQvdXNlcnMvJHtwb3J0YWxJdGVtLm93bmVyfS9jcmVhdGVTZXJ2aWNlYDtcbiAgY29uc3QgY3JlYXRlUGFyYW1zID0ge1xuICAgIG5hbWU6IG5ld0l0ZW1Qcm9wcy50aXRsZS5yZXBsYWNlKC8gL2csIFwiX1wiKSxcbiAgICBpc1ZpZXc6IHRydWUsXG4gICAgc291cmNlU2NoZW1hQ2hhbmdlc0FsbG93ZWQ6IHRydWUsXG4gICAgaXNVcGRhdGFibGVWaWV3OiB0cnVlLFxuICAgIHNwYXRpYWxSZWZlcmVuY2U6IChfYSA9IGZsLnNvdXJjZUpTT04uZXh0ZW50KSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2Euc3BhdGlhbFJlZmVyZW5jZSxcbiAgICBpbml0aWFsRXh0ZW50OiBmbC5zb3VyY2VKU09OLmV4dGVudCxcbiAgICBjYXBhYmlsaXRpZXM6IFwiUXVlcnlcIixcbiAgICBwcmVzZXJ2ZUxheWVySWRzOiB0cnVlXG4gIH07XG4gIGlmIChwb3J0YWwuaXNQb3J0YWwpIHtcbiAgICBjb25zdCBkYXRhU291cmNlVHlwZSA9IGdldERhdGFTb3VyY2VUeXBlJDEocHJvcHMpO1xuICAgIGlmIChkYXRhU291cmNlVHlwZSkge1xuICAgICAgY3JlYXRlUGFyYW1zLm9wdGlvbnMgPSB7IGRhdGFTb3VyY2VUeXBlIH07XG4gICAgfVxuICB9XG4gIGxldCBjcmVhdGVTZXJ2aWNlQ29udGVudCA9IHtcbiAgICBjcmVhdGVQYXJhbWV0ZXJzOiBKU09OLnN0cmluZ2lmeShjcmVhdGVQYXJhbXMpLFxuICAgIG91dHB1dFR5cGU6IFwiZmVhdHVyZVNlcnZpY2VcIixcbiAgICB0YWdzOiAoKF9iID0gbmV3SXRlbVByb3BzLnRhZ3MpID09PSBudWxsIHx8IF9iID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYi5sZW5ndGgpID8gbmV3SXRlbVByb3BzLnRhZ3MudG9TdHJpbmcoKSA6IHVuZGVmaW5lZCxcbiAgICBzbmlwcGV0OiBuZXdJdGVtUHJvcHMuc3VtbWFyeSxcbiAgICBjYXRlZ29yaWVzOiAoX2MgPSBuZXdJdGVtUHJvcHMuY2F0ZWdvcmllcykgPT09IG51bGwgfHwgX2MgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9jLmpvaW4oXCIsXCIpLFxuICAgIGlzVmlldzogdHJ1ZVxuICB9O1xuICB0cnkge1xuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZXNyaVJlcXVlc3QoY3JlYXRlU2VydmljZVVybCwge1xuICAgICAgcXVlcnk6IE9iamVjdC5hc3NpZ24oT2JqZWN0LmFzc2lnbih7fSwgY3JlYXRlU2VydmljZUNvbnRlbnQpLCB7IGY6IFwianNvblwiLCB0b2tlbjogcG9ydGFsLmNyZWRlbnRpYWwudG9rZW4gfSksXG4gICAgICBtZXRob2Q6IFwicG9zdFwiLFxuICAgICAgcmVzcG9uc2VUeXBlOiBcImpzb25cIlxuICAgIH0pO1xuICAgIC8vY29uc29sZS5sb2coXCJuZXdTZXJ2aWNlUmVzcG9uc2VcIiwgcmVzcG9uc2UpO1xuICAgIHJldHVybiByZXNwb25zZS5kYXRhO1xuICB9XG4gIGNhdGNoIChlKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChfLCByZWplY3QpID0+IHtcbiAgICAgIGlmIChlLm1lc3NhZ2UuaW5kZXhPZihcIiBhbHJlYWR5IGV4aXN0cyBcIikgPiAtMSkge1xuICAgICAgICByZWplY3QobmV3IEVycm9yKFwic2VydmljZSBuYW1lIGFscmVhZHkgZXhpc3RzXCIpKTtcbiAgICAgIH1cbiAgICAgIGVsc2Uge1xuICAgICAgICByZWplY3QobmV3IEVycm9yKFwiY3JlYXRlIHNlcnZpY2UgZmFpbGVkXCIpKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxufVxuZnVuY3Rpb24gZ2V0RGF0YVNvdXJjZVR5cGUkMShwcm9wcykge1xuICB2YXIgX2EsIF9iLCBfYywgX2Q7XG4gIGNvbnN0IHsgYWRtaW5TZXJ2aWNlSW5mbyB9ID0gcHJvcHM7XG4gIGNvbnN0IGRhdGFTb3VyY2UgPSAoKF9iID0gKF9hID0gYWRtaW5TZXJ2aWNlSW5mbyA9PT0gbnVsbCB8fCBhZG1pblNlcnZpY2VJbmZvID09PSB2b2lkIDAgPyB2b2lkIDAgOiBhZG1pblNlcnZpY2VJbmZvLmFkbWluU2VydmljZUluZm8pID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5kYXRhYmFzZSkgPT09IG51bGwgfHwgX2IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9iLmRhdGFzb3VyY2UpIHx8IHt9O1xuICBjb25zdCBkYXRhU291cmNlVHlwZSA9ICgoX2MgPSBkYXRhU291cmNlID09PSBudWxsIHx8IGRhdGFTb3VyY2UgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGRhdGFTb3VyY2UubmFtZSkgPT09IG51bGwgfHwgX2MgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9jLmluZGV4T2YoXCIvbm9zcWxEYXRhYmFzZXNcIikpID4gLTFcbiAgICA/IFwic3BhdGlvdGVtcG9yYWxcIlxuICAgIDogKChfZCA9IGRhdGFTb3VyY2UgPT09IG51bGwgfHwgZGF0YVNvdXJjZSA9PT0gdm9pZCAwID8gdm9pZCAwIDogZGF0YVNvdXJjZS5uYW1lKSA9PT0gbnVsbCB8fCBfZCA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2QuaW5kZXhPZihcIi9lbnRlcnByaXNlRGF0YWJhc2VzXCIpKSA+IC0xXG4gICAgICA/IFwicmVsYXRpb25hbFwiXG4gICAgICA6IG51bGw7XG4gIHJldHVybiBkYXRhU291cmNlVHlwZTtcbn1cbmFzeW5jIGZ1bmN0aW9uIGluaXRpYWxBZGRUb0RlZmluaXRpb24ocHJvcHMsIGNyZWF0ZVNlcnZpY2VSZXNwb25zZSwgZXNyaVJlcXVlc3QpIHtcbiAgLyogVE9ETz8/XG4gIHVwZGF0ZVBvcHVwQWZ0ZXJGaWVsZERlZmluaXRpb25DaGFuZ2U6IGZ1bmN0aW9uKG1hcExheWVyKSB7XG5cbiAgICBpZiAoIW1hcExheWVyLnBvcHVwSW5mbyB8fCAhbWFwTGF5ZXIucG9wdXBJbmZvLmZpZWxkSW5mb3MpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB2YXIgZmllbGRJbmZvcyA9IG1hcExheWVyLnBvcHVwSW5mby5maWVsZEluZm9zO1xuICAgIHZhciBuZXdGaWVsZEluZm9zID0gW107XG4gICAgdmFyIGRlZmF1bHRQb3B1cEluZm8gPSBhcmNnaXNvbmxpbmUubWFwLnBvcHVwLmdldERlZmF1bHRQb3B1cEluZm8obWFwTGF5ZXIuc2VydmljZUluZm8sIG1hcExheWVyLmxheWVyLmlzRWRpdGFibGUoKSwgbWFwTGF5ZXIubGF5ZXIpO1xuXG4gICAgLy8gcmVtb3ZlIGZpZWxkcyB0aGF0IGFyZSBub3QgYXZhaWxhYmxlIGFueW1vcmUgYW5kIGFkZCBuZXcgZmllbGRzXG4gICAgZG9qby5mb3JFYWNoKGRlZmF1bHRQb3B1cEluZm8uZmllbGRJbmZvcywgZnVuY3Rpb24oZGVmSW5mbykge1xuICAgICAgdmFyIGN1ckZJbmZvO1xuICAgICAgZG9qby5mb3JFYWNoKGZpZWxkSW5mb3MsIGZ1bmN0aW9uKGZJbmZvKSB7XG4gICAgICAgIGlmIChmSW5mby5maWVsZE5hbWUgPT09IGRlZkluZm8uZmllbGROYW1lKSB7XG4gICAgICAgICAgY3VyRkluZm8gPSBmSW5mbztcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgICBpZiAoIWN1ckZJbmZvKSB7XG4gICAgICAgIC8vIGFkZCBuZXcgZmllbGRzIHRvIHRoZSBwb3B1cFxuICAgICAgICBuZXdGaWVsZEluZm9zLnB1c2goZGVmSW5mbyk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyBrZWVwIHRoZSBvbmUgd2UgaGF2ZVxuICAgICAgICBuZXdGaWVsZEluZm9zLnB1c2goY3VyRkluZm8pO1xuICAgICAgfVxuICAgIH0pO1xuICAgIC8vIGtlZXAgc3BlY2lhbCBmaWVsZHNcbiAgICB2YXIgcmVsYXRlZEZpZWxkUHJlZml4ID0gXCJyZWxhdGlvbnNoaXBzL1wiO1xuICAgIHZhciBleHByZXNzaW9uUHJlZml4ID0gXCJleHByZXNzaW9uL1wiO1xuICAgIHZhciByYXN0ZXJQcmVmaXggPSBcIlJhc3Rlci5cIjtcbiAgICBkb2pvLmZvckVhY2goZmllbGRJbmZvcywgZnVuY3Rpb24oZkluZm8pIHtcbiAgICAgIGlmIChmSW5mby5maWVsZE5hbWUuc3RhcnRzV2l0aChyZWxhdGVkRmllbGRQcmVmaXgpIHx8XG4gICAgICAgIGZJbmZvLmZpZWxkTmFtZS5zdGFydHNXaXRoKGV4cHJlc3Npb25QcmVmaXgpIHx8XG4gICAgICAgIGZJbmZvLmZpZWxkTmFtZS5zdGFydHNXaXRoKHJhc3RlclByZWZpeCkpIHtcbiAgICAgICAgbmV3RmllbGRJbmZvcy5wdXNoKGZJbmZvKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICBpZiAoZG9qby5qc29uLnN0cmluZ2lmeShtYXBMYXllci5wb3B1cEluZm8uZmllbGRJbmZvcykgIT09IGRvam8uanNvbi5zdHJpbmdpZnkobmV3RmllbGRJbmZvcykpIHtcbiAgICAgIG1hcExheWVyLnBvcHVwSW5mby5maWVsZEluZm9zID0gbmV3RmllbGRJbmZvcztcbiAgICAgIGFyY2dpc29ubGluZS5tYXAubWFwVXRpbC5zZXRJbmZvVGVtcGxhdGUobWFwTGF5ZXIubGF5ZXIsIG1hcExheWVyLnBvcHVwSW5mbyk7XG4gICAgICBtYXBMYXllci5wb3B1cENoYW5nZWQgPSB0cnVlO1xuXG4gICAgICBpZiAobWFwTGF5ZXIub3JpZ0l0ZW1MYXllcnMpIHtcbiAgICAgICAgLy8gc2F2ZSBuZXcgcG9wdXAgb24gbGF5ZXIgaXRlbVxuXG4gICAgICAgIHZhciBnZXRJdGVtTGF5ZXJJbmZvc0hhbmRsZXIgPSBmdW5jdGlvbigpe1xuICAgICAgICAgIC8vIG1hcExheWVyLm9yaWdJdGVtTGF5ZXJzIGNvbnRhaW5zIHdoYXQncyBzYXZlZCBvbiB0aGUgaXRlbSBjdXJyZW50bHlcblxuICAgICAgICAgIHZhciBpdGVtRGF0YSA9IGFyY2dpc29ubGluZS5tYXAuaXRlbURhdGEuaXRlbURhdGFDb250ZW50c1ttYXBMYXllci5pdGVtSWRdIHx8IHt9O1xuXG4gICAgICAgICAgdmFyIGlkID0gcGFyc2VJbnQobWFwTGF5ZXIubGF5ZXIudXJsLnN1YnN0cmluZyhtYXBMYXllci5sYXllci51cmwubGFzdEluZGV4T2YoXCIvXCIpICsgMSkpO1xuICAgICAgICAgIHZhciBsYXllckluZm8gPSBudWxsO1xuICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbWFwTGF5ZXIub3JpZ0l0ZW1MYXllcnMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgIGlmIChtYXBMYXllci5vcmlnSXRlbUxheWVyc1tpXS5pZCA9PT0gaWQpIHtcbiAgICAgICAgICAgICAgbGF5ZXJJbmZvID0gbWFwTGF5ZXIub3JpZ0l0ZW1MYXllcnNbaV07XG4gICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cblxuICAgICAgICAgIGlmICghbGF5ZXJJbmZvKSB7XG4gICAgICAgICAgICAvL3Nob3VsZCBub3QgaGFwcGVuXG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgLy8gb25seSB1cGRhdGUgcG9wdXBJbmZvXG4gICAgICAgICAgbGF5ZXJJbmZvLnBvcHVwSW5mbyA9IG1hcExheWVyLnBvcHVwSW5mbztcblxuICAgICAgICAgIHZhciBqc29uID0ge1xuICAgICAgICAgICAgbGF5ZXJzOiBtYXBMYXllci5vcmlnSXRlbUxheWVyc1xuICAgICAgICAgIH07XG5cbiAgICAgICAgICBkZWxldGUgaXRlbURhdGEubGF5ZXJzO1xuICAgICAgICAgIGpzb24gPSBkb2pvLm1peGluKGl0ZW1EYXRhLCBqc29uKTtcblxuICAgICAgICAgIHZhciByZXF1ZXN0ID0ge1xuICAgICAgICAgICAgdGV4dDogZG9qby5qc29uLnN0cmluZ2lmeShqc29uKVxuICAgICAgICAgIH07XG5cbiAgICAgICAgICB2YXIgdXNlciA9IGFyY2dpc29ubGluZS5zaGFyaW5nLnV0aWwuZ2V0VXNlcigpO1xuICAgICAgICAgIHZhciB1cmwgPSBlc3JpR2Vvd0NvbmZpZy5yZXN0QmFzZVVybCArICdjb250ZW50L3VzZXJzLycgKyBtYXBMYXllci5pdGVtQ2FyZC5vd25lcjsgLy8gdXNlciBtaWdodCBiZSBhZG1pbiBhbmQgaXRlbSBvd25lciBpcyBzb21lb25lIGVsc2VcbiAgICAgICAgICB1cmwgKz0gKG1hcExheWVyLml0ZW1DYXJkLm93bmVyRm9sZGVyKSA/ICgnLycgKyBtYXBMYXllci5pdGVtQ2FyZC5vd25lckZvbGRlcikgOiAnJztcbiAgICAgICAgICB1cmwgKz0gJy9pdGVtcy8nICsgbWFwTGF5ZXIuaXRlbUNhcmQuaWQgKyAnL3VwZGF0ZSc7XG4gICAgICAgICAgYXJjZ2lzb25saW5lLnNoYXJpbmcudXRpbC5wb3N0SnNvbihyZXF1ZXN0LCB1cmwsIGRvam8uaGl0Y2godGhpcyxmdW5jdGlvbigpIHtcbiAgICAgICAgICAgIGRlbGV0ZSBtYXBMYXllci5wb3B1cENoYW5nZWQ7XG4gICAgICAgICAgfSkpO1xuICAgICAgICB9O1xuXG4gICAgICAgIC8vIGdldCB0aGUgbGF0ZXN0IGxheWVySW5mb3MgZnJvbSB0aGUgaXRlbSBpbiBjYXNlIHRoZXkgZ290IGNoYW5nZWQgYnkgYW5vdGhlciBsYXllciBpbiB0aGUgbWFwXG4gICAgICAgIGFyY2dpc29ubGluZS5tYXAuaXRlbURhdGEuZ2V0SXRlbUxheWVySW5mb3MobWFwTGF5ZXIsIGRvam8uaGl0Y2godGhpcywgZ2V0SXRlbUxheWVySW5mb3NIYW5kbGVyKSwgZG9qby5oaXRjaCh0aGlzLCBnZXRJdGVtTGF5ZXJJbmZvc0hhbmRsZXIpKTtcbiAgICAgIH1cbiAgICB9XG4gIH0sXG4gICovXG4gIHZhciBfYSwgX2I7XG4gIGNvbnN0IHsgbGF5ZXIsIGxheWVySWRzIH0gPSBwcm9wcztcbiAgbGV0IGxheWVycywgdGFibGVzO1xuICBpZiAobGF5ZXIudHlwZSA9PT0gXCJncm91cFwiKSB7XG4gICAgbGF5ZXJzID0gKF9hID0gbGF5ZXIubGF5ZXJzKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EuZmlsdGVyKChseXIpID0+IGxheWVySWRzLmluZGV4T2YobHlyLmxheWVySWQpID4gLTEpLm1hcCgobHlyKSA9PiBnZXREZWZMYXllckpTT04obHlyLCBwcm9wcykpLnRvQXJyYXkoKS5yZXZlcnNlKCk7XG4gICAgdGFibGVzID0gKF9iID0gbGF5ZXIudGFibGVzKSA9PT0gbnVsbCB8fCBfYiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2IuZmlsdGVyKChseXIpID0+IGxheWVySWRzLmluZGV4T2YobHlyLmxheWVySWQpID4gLTEpLm1hcCgobHlyKSA9PiBnZXREZWZMYXllckpTT04obHlyLCBwcm9wcykpLnRvQXJyYXkoKS5yZXZlcnNlKCk7XG4gIH1cbiAgZWxzZSB7XG4gICAgaWYgKGxheWVyLmlzVGFibGUpIHtcbiAgICAgIHRhYmxlcyA9IFtnZXREZWZMYXllckpTT04obGF5ZXIsIHByb3BzKV07XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgbGF5ZXJzID0gW2dldERlZkxheWVySlNPTihsYXllciwgcHJvcHMpXTtcbiAgICB9XG4gIH1cbiAgdHJ5IHtcbiAgICAvLyB0aGUgcmVzcG9uc2UgZnJvbSBhIGNyZWF0ZVNlcnZpY2UgY2FsbCByZXR1cm5zICdzZXJ2aWNldXJsJ1xuICAgIGNvbnN0IGFkbWluVXJsID0gY3JlYXRlU2VydmljZVJlc3BvbnNlLnNlcnZpY2V1cmwucmVwbGFjZShcInJlc3Qvc2VydmljZXNcIiwgXCJyZXN0L2FkbWluL3NlcnZpY2VzXCIpO1xuICAgIGF3YWl0IGFkZFRvRGVmaW5pdGlvblJlcXVlc3QkMShgJHthZG1pblVybH0vYWRkVG9EZWZpbml0aW9uYCwge1xuICAgICAgbGF5ZXJzOiBsYXllcnMsXG4gICAgICB0YWJsZXM6IHRhYmxlc1xuICAgIH0sIGVzcmlSZXF1ZXN0LCBwcm9wcyk7XG4gICAgYXdhaXQgdXBkYXRlRGVmaW5pdGlvbnMocHJvcHMsIGNyZWF0ZVNlcnZpY2VSZXNwb25zZSwgZXNyaVJlcXVlc3QpO1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4ge1xuICAgICAgcmVzb2x2ZSgpO1xuICAgIH0pO1xuICB9XG4gIGNhdGNoIChlKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChfLCByZWplY3QpID0+IHtcbiAgICAgIHJlamVjdChuZXcgRXJyb3IoXCJpbml0aWFsQWRkVG9EZWZpbml0aW9uIGZhaWxlZFwiKSk7XG4gICAgfSk7XG4gIH1cbn1cbmFzeW5jIGZ1bmN0aW9uIHVwZGF0ZURlZmluaXRpb25zKHByb3BzLCBjcmVhdGVTZXJ2aWNlUmVzcG9uc2UsIGVzcmlSZXF1ZXN0KSB7XG4gIGNvbnN0IHsgbGF5ZXIsIGxheWVySWRzIH0gPSBwcm9wcztcbiAgY29uc3QgeyBwb3J0YWxJdGVtIH0gPSBsYXllcjtcbiAgY29uc3QgeyBwb3J0YWwgfSA9IHBvcnRhbEl0ZW07XG4gIGNvbnN0IGFkbWluVXJsID0gY3JlYXRlU2VydmljZVJlc3BvbnNlLnNlcnZpY2V1cmwucmVwbGFjZShcInJlc3Qvc2VydmljZXNcIiwgXCJyZXN0L2FkbWluL3NlcnZpY2VzXCIpO1xuICB0cnkge1xuICAgIC8vIG5vdyB1cGRhdGUgZGVmaW5pdGlvbnMgbGlrZSBmaWx0ZXIsIGZpZWxkcywgYW5kIEFPSVxuICAgIC8vIGNoYW5naW5nIGZpZWxkcyBhbmQgQU9JIG5vdCBzdXBwb3J0ZWQgd2l0aCBhZGRUb0RlZmluaXRpb25cbiAgICBpZiAobGF5ZXIudHlwZSA9PT0gXCJncm91cFwiKSB7XG4gICAgICBjb25zdCBjYWxsSW5mb3MgPSBbXTtcbiAgICAgIGNvbnN0IGx5cnMgPSBnZXRMYXllcnNBbmRUYWJsZXMobGF5ZXIpLmZpbHRlcigoZkxheWVyKSA9PiBsYXllcklkcy5pbmRleE9mKGZMYXllci5sYXllcklkKSA+IC0xKTtcbiAgICAgIC8vIHVzZSBmb3IgbG9vcCBzbyBhd2FpdCB3b3Jrc1xuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBseXJzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIGNvbnN0IGZMYXllciA9IGx5cnMuZ2V0SXRlbUF0KGkpO1xuICAgICAgICBpZiAoaGFzTGF5ZXJDaGFuZ2VzKGZMYXllci5sYXllcklkLCBwcm9wcykpIHtcbiAgICAgICAgICBjb25zdCBqc29uID0gYXdhaXQgZ2V0VXBkYXRlTGF5ZXJKU09OKGZMYXllciwgcHJvcHMpO1xuICAgICAgICAgIGNvbnN0IHVwZGF0ZURlZlVybCA9IGAke2FkbWluVXJsfS8ke2ZMYXllci5sYXllcklkfS91cGRhdGVEZWZpbml0aW9uYDtcbiAgICAgICAgICBjYWxsSW5mb3MucHVzaCh7IHVwZGF0ZURlZlVybCwganNvbiB9KTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgaWYgKGNhbGxJbmZvcy5sZW5ndGgpIHtcbiAgICAgICAgaWYgKHBvcnRhbC5pc1BvcnRhbCkge1xuICAgICAgICAgIC8vIGNhbid0IGhhbmRsZSBzaW11bHRhbmVvdXMgcmVxdWVzdHNcbiAgICAgICAgICBmb3IgKGNvbnN0IGNhbGxJbmZvIG9mIGNhbGxJbmZvcykge1xuICAgICAgICAgICAgYXdhaXQgdXBkYXRlRGVmaW5pdGlvblJlcXVlc3QoY2FsbEluZm8udXBkYXRlRGVmVXJsLCBjYWxsSW5mby5qc29uLCBlc3JpUmVxdWVzdCwgcHJvcHMpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICBjb25zdCBjYWxscyA9IFtdO1xuICAgICAgICAgIGNhbGxJbmZvcy5mb3JFYWNoKChjYWxsSW5mbykgPT4ge1xuICAgICAgICAgICAgY2FsbHMucHVzaCh1cGRhdGVEZWZpbml0aW9uUmVxdWVzdChjYWxsSW5mby51cGRhdGVEZWZVcmwsIGNhbGxJbmZvLmpzb24sIGVzcmlSZXF1ZXN0LCBwcm9wcykpO1xuICAgICAgICAgIH0pO1xuICAgICAgICAgIGF3YWl0IFByb21pc2UuYWxsKGNhbGxzKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgIC8vIG5vdCBhIGdyb3VwIGxheWVyXG4gICAgICBpZiAoaGFzTGF5ZXJDaGFuZ2VzKGxheWVyLmxheWVySWQsIHByb3BzKSkge1xuICAgICAgICBjb25zdCBqc29uID0gYXdhaXQgZ2V0VXBkYXRlTGF5ZXJKU09OKGxheWVyLCBwcm9wcyk7XG4gICAgICAgIGNvbnN0IHVwZGF0ZURlZlVybCA9IGAke2FkbWluVXJsfS8ke2xheWVyLmxheWVySWR9L3VwZGF0ZURlZmluaXRpb25gO1xuICAgICAgICBhd2FpdCB1cGRhdGVEZWZpbml0aW9uUmVxdWVzdCh1cGRhdGVEZWZVcmwsIGpzb24sIGVzcmlSZXF1ZXN0LCBwcm9wcyk7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4ge1xuICAgICAgcmVzb2x2ZSgpO1xuICAgIH0pO1xuICB9XG4gIGNhdGNoIChlKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChfLCByZWplY3QpID0+IHtcbiAgICAgIHJlamVjdChuZXcgRXJyb3IoXCJ1cGRhdGVEZWZpbml0aW9ucyBmYWlsZWRcIikpO1xuICAgIH0pO1xuICB9XG59XG5hc3luYyBmdW5jdGlvbiB1cGRhdGVEZWZpbml0aW9uKHByb3BzLCB2aWV3SXRlbSwgZXNyaVJlcXVlc3QpIHtcbiAgLypcbiAgVE9ETz8/XG4gIGlmIChhcmNnaXNvbmxpbmUuc2hhcmluZy51dGlsLmlzUG9ydGFsKCkpIHtcbiAgICAvLyBjYW4ndCBzZW5kIGFsbCBvZiB0aG9zZSByZXF1ZXN0cyBvdXQgYXQgdGhlIHNhbWUgdGltZSBbIzE5MzAxXVxuICAqL1xuICB2YXIgX2EsIF9iLCBfYywgX2Q7XG4gIGNvbnN0IHsgbGF5ZXIsIGxheWVySWRzLCBhZG1pblNlcnZpY2VJbmZvIH0gPSBwcm9wcztcbiAgY29uc3QgcG9ydGFsSXRlbSA9IGxheWVyLnBvcnRhbEl0ZW07XG4gIGNvbnN0IHsgcG9ydGFsIH0gPSBwb3J0YWxJdGVtO1xuICBjb25zdCBkZWxldGVMYXllcklkcyA9IFtdO1xuICBjb25zdCBhZGRMYXllcklkcyA9IFtdO1xuICB0cnkge1xuICAgIC8vIHRoZSByZXNwb25zZSBmcm9tIGFuIGl0ZW0gY2FyZCBjYWxsIHJldHVybnMgJ3VybCdcbiAgICBjb25zdCBhZG1pblVybCA9IHZpZXdJdGVtLnVybC5yZXBsYWNlKFwicmVzdC9zZXJ2aWNlc1wiLCBcInJlc3QvYWRtaW4vc2VydmljZXNcIik7XG4gICAgaWYgKGxheWVyLnR5cGUgPT09IFwiZ3JvdXBcIikge1xuICAgICAgLy8gZGVsZXRlXG4gICAgICAoX2EgPSBhZG1pblNlcnZpY2VJbmZvID09PSBudWxsIHx8IGFkbWluU2VydmljZUluZm8gPT09IHZvaWQgMCA/IHZvaWQgMCA6IGFkbWluU2VydmljZUluZm8ubGF5ZXJzKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EuZm9yRWFjaCgobHlyKSA9PiB7XG4gICAgICAgIGlmIChsYXllcklkcy5pbmRleE9mKGx5ci5pZCkgPT09IC0xKSB7XG4gICAgICAgICAgZGVsZXRlTGF5ZXJJZHMucHVzaChseXIuaWQpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICAgIGNvbnN0IGRlbGV0ZVRhYmxlSWRzID0gW107XG4gICAgICAoX2IgPSBhZG1pblNlcnZpY2VJbmZvID09PSBudWxsIHx8IGFkbWluU2VydmljZUluZm8gPT09IHZvaWQgMCA/IHZvaWQgMCA6IGFkbWluU2VydmljZUluZm8udGFibGVzKSA9PT0gbnVsbCB8fCBfYiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2IuZm9yRWFjaCgobHlyKSA9PiB7XG4gICAgICAgIGlmIChsYXllcklkcy5pbmRleE9mKGx5ci5pZCkgPT09IC0xKSB7XG4gICAgICAgICAgZGVsZXRlVGFibGVJZHMucHVzaChseXIuaWQpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICAgIGlmIChkZWxldGVMYXllcklkcy5sZW5ndGggfHwgZGVsZXRlVGFibGVJZHMubGVuZ3RoKSB7XG4gICAgICAgIGNvbnN0IGRlbGV0ZUZyb21EZWZVcmwgPSBgJHthZG1pblVybH0vZGVsZXRlRnJvbURlZmluaXRpb25gO1xuICAgICAgICBhd2FpdCBkZWxldGVGcm9tRGVmaW5pdGlvblJlcXVlc3QoZGVsZXRlRnJvbURlZlVybCwge1xuICAgICAgICAgIGxheWVyczogZGVsZXRlTGF5ZXJJZHMgPT09IG51bGwgfHwgZGVsZXRlTGF5ZXJJZHMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGRlbGV0ZUxheWVySWRzLm1hcCgoaWQpID0+IHtcbiAgICAgICAgICAgIHJldHVybiB7IGlkIH07XG4gICAgICAgICAgfSksXG4gICAgICAgICAgdGFibGVzOiBkZWxldGVUYWJsZUlkcyA9PT0gbnVsbCB8fCBkZWxldGVUYWJsZUlkcyA9PT0gdm9pZCAwID8gdm9pZCAwIDogZGVsZXRlVGFibGVJZHMubWFwKChpZCkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIHsgaWQgfTtcbiAgICAgICAgICB9KVxuICAgICAgICB9LCBwb3J0YWxJdGVtLCBlc3JpUmVxdWVzdCk7XG4gICAgICAgIC8vIGRvIHdlIG5lZWQgdG8gcmVtb3ZlIHJlbGF0aW9uc2hpcHMgZnJvbSBleGlzdGluZyB2aWV3IGxheWVyc1xuICAgICAgICAvLyBwb2ludGluZyB0byBhbnkgcmVtb3ZlZCBsYXllcnM/XG4gICAgICAgIGxldCBjYWxsSW5mb3MgPSBbXTtcbiAgICAgICAgZ2V0TGF5ZXJzQW5kVGFibGVzKGxheWVyKVxuICAgICAgICAgIC5maWx0ZXIoKGZMYXllcikgPT4gbGF5ZXJJZHMuaW5kZXhPZihmTGF5ZXIubGF5ZXJJZCkgPiAtMSlcbiAgICAgICAgICAuZm9yRWFjaChhc3luYyAoZkxheWVyKSA9PiB7XG4gICAgICAgICAgdmFyIF9hLCBfYjtcbiAgICAgICAgICBpZiAoKF9hID0gZkxheWVyLnJlbGF0aW9uc2hpcHMpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5sZW5ndGgpIHtcbiAgICAgICAgICAgIC8vIHRoZSBvcmlnaW5hbCBsYXllciBoYXMgcmVsYXRpb25zaGlwc1xuICAgICAgICAgICAgY29uc3Qgdmlld0xheWVySW5mbyA9IGdldExheWVyc0FuZFRhYmxlcyhhZG1pblNlcnZpY2VJbmZvKS5maW5kKChsYXllckluZm8pID0+IGxheWVySW5mby5pZCA9PT0gZkxheWVyLmxheWVySWQpO1xuICAgICAgICAgICAgaWYgKChfYiA9IHZpZXdMYXllckluZm8gPT09IG51bGwgfHwgdmlld0xheWVySW5mbyA9PT0gdm9pZCAwID8gdm9pZCAwIDogdmlld0xheWVySW5mby5yZWxhdGlvbnNoaXBzKSA9PT0gbnVsbCB8fCBfYiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2IubGVuZ3RoKSB7XG4gICAgICAgICAgICAgIC8vIHJlbW92ZSByZWxhdGlvbnNoaXBzIHBvaW50aW5nIHRvIG5ld2x5IHJlbW92ZWQgbGF5ZXJzXG4gICAgICAgICAgICAgIGNvbnN0IHJlbGF0aW9uc2hpcHMgPSB2aWV3TGF5ZXJJbmZvLnJlbGF0aW9uc2hpcHMuZmlsdGVyKChyZWxhdGlvbnNoaXApID0+IGRlbGV0ZUxheWVySWRzLmluZGV4T2YocmVsYXRpb25zaGlwLnJlbGF0ZWRUYWJsZUlkKSA+IC0xIHx8XG4gICAgICAgICAgICAgICAgZGVsZXRlVGFibGVJZHMuaW5kZXhPZihyZWxhdGlvbnNoaXAucmVsYXRlZFRhYmxlSWQpID4gLTEpO1xuICAgICAgICAgICAgICBpZiAocmVsYXRpb25zaGlwcy5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICAvLyBhdCBsZWFzdCBvbmUgcmVsYXRpb25zaGlwIG5lZWRzIHRvIGJlIHJlbW92ZWRcbiAgICAgICAgICAgICAgICBjb25zdCBqc29uID0ge307XG4gICAgICAgICAgICAgICAganNvbi5yZWxhdGlvbnNoaXBzID0gcmVsYXRpb25zaGlwcztcbiAgICAgICAgICAgICAgICBjb25zdCBkZWxGcm9tRGVmVXJsID0gYCR7YWRtaW5Vcmx9LyR7ZkxheWVyLmxheWVySWR9L2RlbGV0ZUZyb21EZWZpbml0aW9uYDtcbiAgICAgICAgICAgICAgICBjYWxsSW5mb3MucHVzaCh7IGRlbEZyb21EZWZVcmwsIGpzb24gfSk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gLy8gZWxzZSB2aWV3IGxheWVyIG5vdCB5ZXQgcGFydCBvZiB2aWV3IG9yIGFscmVhZHkgaGFzIGFsbCByZWxhdGlvbnNoaXBzXG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgaWYgKGNhbGxJbmZvcy5sZW5ndGgpIHtcbiAgICAgICAgICBpZiAocG9ydGFsLmlzUG9ydGFsKSB7XG4gICAgICAgICAgICAvLyBjYW4ndCBoYW5kbGUgc2ltdWx0YW5lb3VzIHJlcXVlc3RzXG4gICAgICAgICAgICBmb3IgKGNvbnN0IGNhbGxJbmZvIG9mIGNhbGxJbmZvcykge1xuICAgICAgICAgICAgICBhd2FpdCBkZWxldGVGcm9tRGVmaW5pdGlvblJlcXVlc3QoY2FsbEluZm8uZGVsRnJvbURlZlVybCwgY2FsbEluZm8uanNvbiwgcG9ydGFsSXRlbSwgZXNyaVJlcXVlc3QpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIGNvbnN0IGNhbGxzID0gW107XG4gICAgICAgICAgICBjYWxsSW5mb3MuZm9yRWFjaCgoY2FsbEluZm8pID0+IHtcbiAgICAgICAgICAgICAgY2FsbHMucHVzaChkZWxldGVGcm9tRGVmaW5pdGlvblJlcXVlc3QoY2FsbEluZm8uZGVsRnJvbURlZlVybCwgY2FsbEluZm8uanNvbiwgcG9ydGFsSXRlbSwgZXNyaVJlcXVlc3QpKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgYXdhaXQgUHJvbWlzZS5hbGwoY2FsbHMpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgLy8gYWRkXG4gICAgICBsYXllcklkcy5mb3JFYWNoKChpZCkgPT4ge1xuICAgICAgICBpZiAoIWdldExheWVyc0FuZFRhYmxlcyhhZG1pblNlcnZpY2VJbmZvKS5zb21lKChseXIpID0+IGx5ci5pZCA9PT0gaWQpKSB7XG4gICAgICAgICAgYWRkTGF5ZXJJZHMucHVzaChpZCk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgICAgaWYgKGFkZExheWVySWRzLmxlbmd0aCkge1xuICAgICAgICBjb25zdCBsYXllcnMgPSAoX2MgPSBsYXllci5sYXllcnMpID09PSBudWxsIHx8IF9jID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYy5maWx0ZXIoKGx5cikgPT4gYWRkTGF5ZXJJZHMuaW5kZXhPZihseXIubGF5ZXJJZCkgPiAtMSkubWFwKChseXIpID0+IGdldERlZkxheWVySlNPTihseXIsIHByb3BzKSkudG9BcnJheSgpLnJldmVyc2UoKTtcbiAgICAgICAgY29uc3QgdGFibGVzID0gKF9kID0gbGF5ZXIudGFibGVzKSA9PT0gbnVsbCB8fCBfZCA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2QuZmlsdGVyKChseXIpID0+IGFkZExheWVySWRzLmluZGV4T2YobHlyLmxheWVySWQpID4gLTEpLm1hcCgobHlyKSA9PiBnZXREZWZMYXllckpTT04obHlyLCBwcm9wcykpLnRvQXJyYXkoKS5yZXZlcnNlKCk7XG4gICAgICAgIGF3YWl0IGFkZFRvRGVmaW5pdGlvblJlcXVlc3QkMShgJHthZG1pblVybH0vYWRkVG9EZWZpbml0aW9uYCwge1xuICAgICAgICAgIGxheWVyczogbGF5ZXJzLFxuICAgICAgICAgIHRhYmxlczogdGFibGVzXG4gICAgICAgIH0sIGVzcmlSZXF1ZXN0LCBwcm9wcyk7XG4gICAgICAgIC8vIGRvIHdlIG5lZWQgdG8gYWRkIHJlbGF0aW9uc2hpcHMgZm9yIGFueSBuZXdseSBhZGRlZCBsYXllcnM/XG4gICAgICAgIGNvbnN0IGNhbGxJbmZvcyA9IFtdO1xuICAgICAgICBnZXRMYXllcnNBbmRUYWJsZXMobGF5ZXIpXG4gICAgICAgICAgLmZpbHRlcigoZkxheWVyKSA9PiBsYXllcklkcy5pbmRleE9mKGZMYXllci5sYXllcklkKSA+IC0xKVxuICAgICAgICAgIC5mb3JFYWNoKGFzeW5jIChmTGF5ZXIpID0+IHtcbiAgICAgICAgICB2YXIgX2EsIF9iO1xuICAgICAgICAgIGlmICgoX2EgPSBmTGF5ZXIucmVsYXRpb25zaGlwcykgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmxlbmd0aCkge1xuICAgICAgICAgICAgLy8gdGhlIG9yaWdpbmFsIGxheWVyIGhhcyByZWxhdGlvbnNoaXBzXG4gICAgICAgICAgICBjb25zdCB2aWV3TGF5ZXJJbmZvID0gZ2V0TGF5ZXJzQW5kVGFibGVzKGFkbWluU2VydmljZUluZm8pLmZpbmQoKGxheWVySW5mbykgPT4gbGF5ZXJJbmZvLmlkID09PSBmTGF5ZXIubGF5ZXJJZCk7XG4gICAgICAgICAgICBpZiAodmlld0xheWVySW5mbykge1xuICAgICAgICAgICAgICAvLyB0aGlzIHZpZXcgbGF5ZXIgd2FzIG5vdCBqdXN0IGFkZGVkIHRvIHRoZSB2aWV3XG4gICAgICAgICAgICAgIGlmICgoKF9iID0gZkxheWVyLnJlbGF0aW9uc2hpcHMpID09PSBudWxsIHx8IF9iID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYi5sZW5ndGgpICE9PSB2aWV3TGF5ZXJJbmZvLnJlbGF0aW9uc2hpcHMubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgY29uc3QganNvbiA9IHt9O1xuICAgICAgICAgICAgICAgIC8vIG9ubHkgYWRkIHJlbGF0aW9uc2hpcHMgcG9pbnRpbmcgdG8gbmV3bHkgYWRkZWQgbGF5ZXJzXG4gICAgICAgICAgICAgICAgY29uc3QgcmVsYXRpb25zaGlwcyA9IGZMYXllci5yZWxhdGlvbnNoaXBzLmZpbHRlcigocmVsYXRpb25zaGlwKSA9PiBhZGRMYXllcklkcy5pbmRleE9mKHJlbGF0aW9uc2hpcC5yZWxhdGVkVGFibGVJZCkgPiAtMSk7XG4gICAgICAgICAgICAgICAganNvbi5yZWxhdGlvbnNoaXBzID0gcmVsYXRpb25zaGlwcztcbiAgICAgICAgICAgICAgICBjb25zdCBhZGRUb0RlZlVybCA9IGAke2FkbWluVXJsfS8ke2ZMYXllci5sYXllcklkfS9hZGRUb0RlZmluaXRpb25gO1xuICAgICAgICAgICAgICAgIGNhbGxJbmZvcy5wdXNoKHsgYWRkVG9EZWZVcmwsIGpzb24gfSk7XG4gICAgICAgICAgICAgIH0gLy8gZWxzZSB2aWV3IGxheWVyIGFscmVhZHkgaGFzIGFsbCByZWxhdGlvbnNoaXBzXG4gICAgICAgICAgICB9IC8vIGVsc2Ugd2Ugc2VudCBhbGwgcmVsYXRpb25zaGlwcyB3aGVuIGFkZGluZyB0aGUgbGF5ZXIgdG8gdGhlIHZpZXcgZWFybGllclxuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIGlmIChjYWxsSW5mb3MubGVuZ3RoKSB7XG4gICAgICAgICAgaWYgKHBvcnRhbC5pc1BvcnRhbCkge1xuICAgICAgICAgICAgLy8gY2FuJ3QgaGFuZGxlIHNpbXVsdGFuZW91cyByZXF1ZXN0c1xuICAgICAgICAgICAgZm9yIChjb25zdCBjYWxsSW5mbyBvZiBjYWxsSW5mb3MpIHtcbiAgICAgICAgICAgICAgYXdhaXQgYWRkVG9EZWZpbml0aW9uUmVxdWVzdCQxKGNhbGxJbmZvLmFkZFRvRGVmVXJsLCBjYWxsSW5mby5qc29uLCBlc3JpUmVxdWVzdCwgcHJvcHMpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIGNvbnN0IGNhbGxzID0gW107XG4gICAgICAgICAgICBjYWxsSW5mb3MuZm9yRWFjaCgoY2FsbEluZm8pID0+IHtcbiAgICAgICAgICAgICAgY2FsbHMucHVzaChhZGRUb0RlZmluaXRpb25SZXF1ZXN0JDEoY2FsbEluZm8uYWRkVG9EZWZVcmwsIGNhbGxJbmZvLmpzb24sIGVzcmlSZXF1ZXN0LCBwcm9wcykpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBhd2FpdCBQcm9taXNlLmFsbChjYWxscyk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgICAvLyB1cGRhdGUgZmllbGRzLCBmaWx0ZXIsIEFPSVxuICAgICAgLy8gYWxzbyB1cGRhdGUgdGhlIG5ldyBsYXllcnMgdGhhdCB3ZXJlIGp1c3QgYWRkZWRcbiAgICAgIGNvbnN0IGNhbGxJbmZvcyA9IFtdO1xuICAgICAgY29uc3QgY2FsbHMgPSBbXTtcbiAgICAgIGNvbnN0IG1ha2VHZXRVcGRhdGVMYXllckpTT05DYWxsID0gYXN5bmMgKGNhbGxJbmZvcywgZkxheWVyKSA9PiB7XG4gICAgICAgIGNvbnN0IHVwZGF0ZURlZlVybCA9IGAke2FkbWluVXJsfS8ke2ZMYXllci5sYXllcklkfS91cGRhdGVEZWZpbml0aW9uYDtcbiAgICAgICAgY29uc3QganNvbiA9IGF3YWl0IGdldFVwZGF0ZUxheWVySlNPTihmTGF5ZXIsIHByb3BzKTtcbiAgICAgICAgY2FsbEluZm9zLnB1c2goeyB1cGRhdGVEZWZVcmwsIGpzb24gfSk7XG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKTtcbiAgICAgIH07XG4gICAgICBnZXRMYXllcnNBbmRUYWJsZXMobGF5ZXIpXG4gICAgICAgIC5maWx0ZXIoKGZMYXllcikgPT4gbGF5ZXJJZHMuaW5kZXhPZihmTGF5ZXIubGF5ZXJJZCkgPiAtMSlcbiAgICAgICAgLmZvckVhY2goKGZMYXllcikgPT4ge1xuICAgICAgICBpZiAoaGFzTGF5ZXJDaGFuZ2VzKGZMYXllci5sYXllcklkLCBwcm9wcykpIHtcbiAgICAgICAgICBjYWxscy5wdXNoKG1ha2VHZXRVcGRhdGVMYXllckpTT05DYWxsKGNhbGxJbmZvcywgZkxheWVyKSk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgICAgYXdhaXQgUHJvbWlzZS5hbGwoY2FsbHMpO1xuICAgICAgaWYgKGNhbGxJbmZvcy5sZW5ndGgpIHtcbiAgICAgICAgaWYgKHBvcnRhbC5pc1BvcnRhbCkge1xuICAgICAgICAgIGZvciAoY29uc3QgY2FsbEluZm8gb2YgY2FsbEluZm9zKSB7XG4gICAgICAgICAgICBhd2FpdCB1cGRhdGVEZWZpbml0aW9uUmVxdWVzdChjYWxsSW5mby51cGRhdGVEZWZVcmwsIGNhbGxJbmZvLmpzb24sIGVzcmlSZXF1ZXN0LCBwcm9wcyk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgIGNvbnN0IGNhbGxzID0gW107XG4gICAgICAgICAgY2FsbEluZm9zLmZvckVhY2goKGNhbGxJbmZvKSA9PiB7XG4gICAgICAgICAgICBjYWxscy5wdXNoKHVwZGF0ZURlZmluaXRpb25SZXF1ZXN0KGNhbGxJbmZvLnVwZGF0ZURlZlVybCwgY2FsbEluZm8uanNvbiwgZXNyaVJlcXVlc3QsIHByb3BzKSk7XG4gICAgICAgICAgfSk7XG4gICAgICAgICAgYXdhaXQgUHJvbWlzZS5hbGwoY2FsbHMpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgLy8gbm90IGEgZ3JvdXAgbGF5ZXJcbiAgICAgIGlmIChoYXNMYXllckNoYW5nZXMobGF5ZXIubGF5ZXJJZCwgcHJvcHMpKSB7XG4gICAgICAgIGNvbnN0IGpzb24gPSBhd2FpdCBnZXRVcGRhdGVMYXllckpTT04obGF5ZXIsIHByb3BzKTtcbiAgICAgICAgY29uc3QgdXBkYXRlRGVmVXJsID0gYCR7YWRtaW5Vcmx9LyR7bGF5ZXIubGF5ZXJJZH0vdXBkYXRlRGVmaW5pdGlvbmA7XG4gICAgICAgIGF3YWl0IHVwZGF0ZURlZmluaXRpb25SZXF1ZXN0KHVwZGF0ZURlZlVybCwganNvbiwgZXNyaVJlcXVlc3QsIHByb3BzKTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7XG4gICAgICByZXNvbHZlKHsgYWRkTGF5ZXJJZHMsIGRlbGV0ZUxheWVySWRzIH0pO1xuICAgIH0pO1xuICB9XG4gIGNhdGNoIChlKSB7XG4gICAgY29uc29sZS5lcnJvcihlKTtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKF8sIHJlamVjdCkgPT4ge1xuICAgICAgcmVqZWN0KG5ldyBFcnJvcihcInVwZGF0ZURlZmluaXRpb24gZmFpbGVkXCIpKTtcbiAgICB9KTtcbiAgfVxufVxuYXN5bmMgZnVuY3Rpb24gdXBkYXRlRGVmaW5pdGlvblJlcXVlc3QodXBkYXRlRGVmVXJsLCBqc29uLCBlc3JpUmVxdWVzdCwgcHJvcHMsIHJldHJ5ID0gZmFsc2UpIHtcbiAgdmFyIF9hO1xuICBjb25zdCB7IGxheWVyLCB2aWV3SXRlbSB9ID0gcHJvcHM7XG4gIGNvbnN0IHVwZGF0ZURlZkNvbnRlbnQgPSB7XG4gICAgdXBkYXRlRGVmaW5pdGlvbjogSlNPTi5zdHJpbmdpZnkoanNvbilcbiAgfTtcbiAgdHJ5IHtcbiAgICBjb25zdCBwb3J0YWxJdGVtID0gbGF5ZXIucG9ydGFsSXRlbTtcbiAgICBjb25zdCBwb3J0YWwgPSBwb3J0YWxJdGVtLnBvcnRhbDtcbiAgICBjb25zdCBpc1ZlbG9jaXR5VmlldyA9ICh2aWV3SXRlbSA9PT0gbnVsbCB8fCB2aWV3SXRlbSA9PT0gdm9pZCAwID8gdm9pZCAwIDogdmlld0l0ZW0udHlwZUtleXdvcmRzLmluZGV4T2YoXCJJb1RGZWF0dXJlTGF5ZXJcIikpID4gLTE7XG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZXNyaVJlcXVlc3QodXBkYXRlRGVmVXJsLCB7XG4gICAgICBxdWVyeTogT2JqZWN0LmFzc2lnbihPYmplY3QuYXNzaWduKHt9LCB1cGRhdGVEZWZDb250ZW50KSwgeyBmOiBcImpzb25cIiwgYXN5bmM6ICFwb3J0YWwuaXNQb3J0YWwgJiYgIWlzVmVsb2NpdHlWaWV3LCB0b2tlbjogcG9ydGFsLmNyZWRlbnRpYWwudG9rZW4gfSksXG4gICAgICBtZXRob2Q6IFwicG9zdFwiLFxuICAgICAgcmVzcG9uc2VUeXBlOiBcImpzb25cIlxuICAgIH0pO1xuICAgIGlmIChwb3J0YWwuaXNQb3J0YWwgfHwgaXNWZWxvY2l0eVZpZXcpIHtcbiAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4ge1xuICAgICAgICByZXNvbHZlKCk7XG4gICAgICB9KTtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCBwb2xsRm9yU3RhdHVzJDEoKF9hID0gcmVzdWx0ID09PSBudWxsIHx8IHJlc3VsdCA9PT0gdm9pZCAwID8gdm9pZCAwIDogcmVzdWx0LmRhdGEpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5zdGF0dXNVUkwsIHtcbiAgICAgICAgICBmOiBcImpzb25cIixcbiAgICAgICAgICB0b2tlbjogcG9ydGFsLmNyZWRlbnRpYWwudG9rZW5cbiAgICAgICAgfSwgZXNyaVJlcXVlc3QpO1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcbiAgICAgICAgICByZXNvbHZlKCk7XG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgICAgY2F0Y2ggKGUpIHtcbiAgICAgICAgLy8gdXBkYXRlIHJlcXVlc3Qgd29ya2VkOyBpZ25vcmUgdGhlIHBvbGxpbmcgZXJyb3JcbiAgICAgICAgLy9yZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcbiAgICAgICAgLy8gIHJlc29sdmUoKTtcbiAgICAgICAgLy99KTtcbiAgICAgICAgLyogcmVhbCBlcnJvclxuICAgICAgICB7XG4gICAgICAgICAgXCJzdWJtaXNzaW9uVGltZVwiOiAxNjUyNDgwMTA0MzYwLFxuICAgICAgICAgIFwibGFzdFVwZGF0ZWRUaW1lXCI6IDE2NTI0ODAxMDQzNjAsXG4gICAgICAgICAgXCJzdGF0dXNcIjogXCJGYWlsZWRcIixcbiAgICAgICAgICBcImVycm9yXCI6IHtcbiAgICAgICAgICAgICAgXCJjb2RlXCI6IDUwMCxcbiAgICAgICAgICAgICAgXCJkZXNjcmlwdGlvblwiOiBcIkVkaXRpbmcgZGVmaW5pdGlvbiBlcnJvciAtIFVTQV9XZXN0Ml92aWV3XCJcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgKi9cbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChfLCByZWplY3QpID0+IHtcbiAgICAgICAgICByZWplY3QobmV3IEVycm9yKFwidXBkYXRlRGVmaW5pdGlvbiByZXF1ZXN0IGZhaWxlZCAocG9sbClcIikpO1xuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbiAgY2F0Y2ggKGUpIHtcbiAgICBpZiAoIXJldHJ5KSB7XG4gICAgICAvLyBpbiBjYXNlIGl0J3MganVzdCBhIGZsdWtlXG4gICAgICByZXR1cm4gdXBkYXRlRGVmaW5pdGlvblJlcXVlc3QodXBkYXRlRGVmVXJsLCBqc29uLCBlc3JpUmVxdWVzdCwgcHJvcHMsIHRydWUpO1xuICAgIH1cbiAgICByZXR1cm4gbmV3IFByb21pc2UoKF8sIHJlamVjdCkgPT4ge1xuICAgICAgcmVqZWN0KG5ldyBFcnJvcihcInVwZGF0ZURlZmluaXRpb24gcmVxdWVzdCBmYWlsZWRcIikpO1xuICAgIH0pO1xuICB9XG59XG5hc3luYyBmdW5jdGlvbiBhZGRUb0RlZmluaXRpb25SZXF1ZXN0JDEoYWRkVG9EZWZVcmwsIGpzb24sIGVzcmlSZXF1ZXN0LCBwcm9wcywgcmV0cnkgPSBmYWxzZSkge1xuICB2YXIgX2E7XG4gIGNvbnN0IHsgbGF5ZXIsIHZpZXdJdGVtIH0gPSBwcm9wcztcbiAgY29uc3QgYWRkVG9EZWZDb250ZW50ID0ge1xuICAgIGFkZFRvRGVmaW5pdGlvbjogSlNPTi5zdHJpbmdpZnkoanNvbilcbiAgfTtcbiAgdHJ5IHtcbiAgICBjb25zdCBwb3J0YWxJdGVtID0gbGF5ZXIucG9ydGFsSXRlbTtcbiAgICBjb25zdCBwb3J0YWwgPSBwb3J0YWxJdGVtLnBvcnRhbDtcbiAgICBjb25zdCBpc1ZlbG9jaXR5VmlldyA9ICh2aWV3SXRlbSA9PT0gbnVsbCB8fCB2aWV3SXRlbSA9PT0gdm9pZCAwID8gdm9pZCAwIDogdmlld0l0ZW0udHlwZUtleXdvcmRzLmluZGV4T2YoXCJJb1RGZWF0dXJlTGF5ZXJcIikpID4gLTE7XG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZXNyaVJlcXVlc3QoYWRkVG9EZWZVcmwsIHtcbiAgICAgIHF1ZXJ5OiBPYmplY3QuYXNzaWduKE9iamVjdC5hc3NpZ24oe30sIGFkZFRvRGVmQ29udGVudCksIHsgZjogXCJqc29uXCIsIGFzeW5jOiAhcG9ydGFsLmlzUG9ydGFsICYmICFpc1ZlbG9jaXR5VmlldywgdG9rZW46IHBvcnRhbC5jcmVkZW50aWFsLnRva2VuIH0pLFxuICAgICAgbWV0aG9kOiBcInBvc3RcIixcbiAgICAgIHJlc3BvbnNlVHlwZTogXCJqc29uXCJcbiAgICB9KTtcbiAgICBpZiAocG9ydGFsLmlzUG9ydGFsIHx8IGlzVmVsb2NpdHlWaWV3KSB7XG4gICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcbiAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgfSk7XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgcG9sbEZvclN0YXR1cyQxKChfYSA9IHJlc3VsdCA9PT0gbnVsbCB8fCByZXN1bHQgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHJlc3VsdC5kYXRhKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2Euc3RhdHVzVVJMLCB7XG4gICAgICAgICAgZjogXCJqc29uXCIsXG4gICAgICAgICAgdG9rZW46IHBvcnRhbC5jcmVkZW50aWFsLnRva2VuXG4gICAgICAgIH0sIGVzcmlSZXF1ZXN0KTtcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7XG4gICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICAgIGNhdGNoIChlKSB7XG4gICAgICAgIC8vIGFkZCByZXF1ZXN0IHdvcmtlZDsgaWdub3JlIHRoZSBwb2xsaW5nIGVycm9yXG4gICAgICAgIC8vcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7XG4gICAgICAgIC8vICByZXNvbHZlKCk7XG4gICAgICAgIC8vfSk7XG4gICAgICAgIC8qIHJlYWwgZXJyb3JcbiAgICAgICAge1xuICAgICAgICAgIFwic3VibWlzc2lvblRpbWVcIjogMTY1MjQ4MDEwNDM2MCxcbiAgICAgICAgICBcImxhc3RVcGRhdGVkVGltZVwiOiAxNjUyNDgwMTA0MzYwLFxuICAgICAgICAgIFwic3RhdHVzXCI6IFwiRmFpbGVkXCIsXG4gICAgICAgICAgXCJlcnJvclwiOiB7XG4gICAgICAgICAgICAgIFwiY29kZVwiOiA1MDAsXG4gICAgICAgICAgICAgIFwiZGVzY3JpcHRpb25cIjogXCJFZGl0aW5nIGRlZmluaXRpb24gZXJyb3IgLSBVU0FfV2VzdDJfdmlld1wiXG4gICAgICAgICAgfVxuICAgICAgfVxuICAgICAgICAqL1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKF8sIHJlamVjdCkgPT4ge1xuICAgICAgICAgIHJlamVjdChuZXcgRXJyb3IoXCJhZGRUb0RlZmluaXRpb24gcmVxdWVzdCBmYWlsZWQgKHBvbGwpXCIpKTtcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfVxuICB9XG4gIGNhdGNoIChlKSB7XG4gICAgaWYgKCFyZXRyeSkge1xuICAgICAgLy8gaW4gY2FzZSBpdCdzIGp1c3QgYSBmbHVrZVxuICAgICAgcmV0dXJuIGFkZFRvRGVmaW5pdGlvblJlcXVlc3QkMShhZGRUb0RlZlVybCwganNvbiwgZXNyaVJlcXVlc3QsIHByb3BzLCB0cnVlKTtcbiAgICB9XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChfLCByZWplY3QpID0+IHtcbiAgICAgIHJlamVjdChuZXcgRXJyb3IoXCJhZGRUb0RlZmluaXRpb24gcmVxdWVzdCBmYWlsZWRcIikpO1xuICAgIH0pO1xuICB9XG59XG5hc3luYyBmdW5jdGlvbiBkZWxldGVGcm9tRGVmaW5pdGlvblJlcXVlc3QoZGVsZXRlRnJvbURlZlVybCwganNvbiwgcG9ydGFsSXRlbSwgZXNyaVJlcXVlc3QsIHJldHJ5ID0gZmFsc2UpIHtcbiAgY29uc3QgZGVsZXRlRnJvbURlZkNvbnRlbnQgPSB7XG4gICAgZGVsZXRlRnJvbURlZmluaXRpb246IEpTT04uc3RyaW5naWZ5KGpzb24pXG4gIH07XG4gIHRyeSB7XG4gICAgYXdhaXQgZXNyaVJlcXVlc3QoZGVsZXRlRnJvbURlZlVybCwge1xuICAgICAgcXVlcnk6IE9iamVjdC5hc3NpZ24oT2JqZWN0LmFzc2lnbih7fSwgZGVsZXRlRnJvbURlZkNvbnRlbnQpLCB7IGY6IFwianNvblwiLCB0b2tlbjogcG9ydGFsSXRlbS5wb3J0YWwuY3JlZGVudGlhbC50b2tlbiB9KSxcbiAgICAgIG1ldGhvZDogXCJwb3N0XCIsXG4gICAgICByZXNwb25zZVR5cGU6IFwianNvblwiXG4gICAgfSk7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7XG4gICAgICByZXNvbHZlKCk7XG4gICAgfSk7XG4gIH1cbiAgY2F0Y2ggKGUpIHtcbiAgICBpZiAoIXJldHJ5KSB7XG4gICAgICAvLyBpbiBjYXNlIGl0J3MganVzdCBhIGZsdWtlXG4gICAgICByZXR1cm4gZGVsZXRlRnJvbURlZmluaXRpb25SZXF1ZXN0KGRlbGV0ZUZyb21EZWZVcmwsIGpzb24sIHBvcnRhbEl0ZW0sIGVzcmlSZXF1ZXN0LCB0cnVlKTtcbiAgICB9XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChfLCByZWplY3QpID0+IHtcbiAgICAgIHJlamVjdChuZXcgRXJyb3IoXCJkZWxldGVGcm9tRGVmaW5pdGlvbiByZXF1ZXN0IGZhaWxlZFwiKSk7XG4gICAgfSk7XG4gIH1cbn1cbmZ1bmN0aW9uIGdldERlZkxheWVySlNPTihmTGF5ZXIsIHByb3BzKSB7XG4gIC8qXG4gIC8vIGNvbXBhcmVkIHRvIHNlcnZpY2UgaW5mbyByZXNwb25zZSAobGF5ZXJzLCB0YWJsZXMpLi4uLlxuICAtIG5vIGluZGV4ZXNcbiAgLSBubyBmaWVsZHNcbiAgLSBubyBzZXJ2aWNlSXRlbUlkXG4gIC0gbm8gc2VydmVyR2Vuc1xuICAtIG5vIHJlbGF0aW9uc2hpcHNcbiAgLSArIHVybFxuICAtICsgYXR0cmlidXRlc1xuICAtICsgbGF5ZXJNZXRhZGF0YVVybFxuICAtICsgbWFwVmlld2VyVXJsXG4gIC0gKyBtYXBWaWV3ZXJVcmxXaXRoR2VvY29kZVxuICAtICsgbmV3TWFwVmlld2VyVXJsXG4gIC0gKyBzY2VuZVZpZXdlclVybFxuICAtICsgYWRtaW5MYXllckluZm9cbiAgKi9cbiAgY29uc3QgeyBsYXllciwgbGF5ZXJJdGVtIH0gPSBwcm9wcztcbiAgY29uc3QganNvbiA9IGZMYXllci5zb3VyY2VKU09OO1xuICBkZWxldGUganNvbi5pbmRleGVzO1xuICBkZWxldGUganNvbi5maWVsZHM7XG4gIGRlbGV0ZSBqc29uLnNlcnZpY2VJdGVtSWQ7XG4gIGRlbGV0ZSBqc29uLnNlcnZlckdlbnM7XG4gIGRlbGV0ZSBqc29uLnJlbGF0aW9uc2hpcHM7XG4gIGpzb24udXJsID0gYCR7ZkxheWVyLnVybH0vJHtmTGF5ZXIubGF5ZXJJZH0/dG9rZW49JHtsYXllci5wb3J0YWxJdGVtLnBvcnRhbC5jcmVkZW50aWFsLnRva2VufWA7XG4gIGpzb24uYWRtaW5MYXllckluZm8gPSB7XG4gICAgdmlld0xheWVyRGVmaW5pdGlvbjoge1xuICAgICAgc291cmNlU2VydmljZU5hbWU6IGdldFNlcnZpY2VOYW1lKGxheWVySXRlbSksXG4gICAgICBzb3VyY2VMYXllcklkOiBmTGF5ZXIubGF5ZXJJZCxcbiAgICAgIHNvdXJjZUxheWVyRmllbGRzOiBcIipcIlxuICAgIH1cbiAgfTtcbiAgLy8gY2FuJ3QgdXBkYXRlIGZpZWxkcyBvciBBT0kgd2hlbiBhZGRpbmcgbGF5ZXIgdG8gZGVmaW5pdGlvblxuICAvL2NvbnNvbGUubG9nKFwiZ2V0RGVmTGF5ZXJKU09OIC0gaWQ6XCIsIGZMYXllci5sYXllcklkLCBqc29uKTtcbiAgcmV0dXJuIGpzb247XG59XG5hc3luYyBmdW5jdGlvbiBnZXRVcGRhdGVMYXllckpTT04oZkxheWVyLCBwcm9wcykge1xuICB2YXIgX2EsIF9iLCBfYywgX2QsIF9lLCBfZiwgX2csIF9oLCBfajtcbiAgY29uc3QgeyBtb2R1bGVzIH0gPSBwcm9wcztcbiAgY29uc3QganNvbiA9IHt9O1xuICBjb25zdCB2aWV3TGF5ZXJQcm9wcyA9IGdldFZpZXdMYXllclByb3BzKGZMYXllci5sYXllcklkLCBwcm9wcyk7XG4gIGlmICh2aWV3TGF5ZXJQcm9wcykge1xuICAgIC8vIGZpbHRlclxuICAgIGpzb24udmlld0RlZmluaXRpb25RdWVyeSA9IHZpZXdMYXllclByb3BzLmZpbHRlciB8fCBcIlwiO1xuICAgIC8vIEFPSVxuICAgIGlmICh2aWV3TGF5ZXJQcm9wcy5hb2kpIHtcbiAgICAgIGxldCBhb2kgPSB2aWV3TGF5ZXJQcm9wcy5hb2k7XG4gICAgICAvLyBtYWtlIHN1cmUgU1IgZml0cyB0byBsYXllclxuICAgICAgaWYgKCFzYW1lU1IoYW9pLnNwYXRpYWxSZWZlcmVuY2UsIGZMYXllci5zcGF0aWFsUmVmZXJlbmNlKSkge1xuICAgICAgICBhd2FpdCBtb2R1bGVzLnByb2plY3Rpb24ubG9hZCgpO1xuICAgICAgICBjb25zdCBnZW9tID0gYW9pLnJpbmdzID8gbW9kdWxlcy5Qb2x5Z29uLmZyb21KU09OKGFvaSkgOiBtb2R1bGVzLkV4dGVudC5mcm9tSlNPTihhb2kpO1xuICAgICAgICBhb2kgPSAoX2EgPSBtb2R1bGVzLnByb2plY3Rpb24ucHJvamVjdChnZW9tLCBmTGF5ZXIuc3BhdGlhbFJlZmVyZW5jZSkpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS50b0pTT04oKTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IGdlb21ldHJ5VHlwZSA9IGFvaS5yaW5ncyA/IFwiZXNyaUdlb21ldHJ5UG9seWdvblwiIDogXCJlc3JpR2VvbWV0cnlFbnZlbG9wZVwiO1xuICAgICAganNvbi52aWV3TGF5ZXJEZWZpbml0aW9uID0ge1xuICAgICAgICBmaWx0ZXI6IHtcbiAgICAgICAgICBvcGVyYXRvcjogXCJlc3JpU3BhdGlhbFJlbEludGVyc2VjdHNcIixcbiAgICAgICAgICB2YWx1ZToge1xuICAgICAgICAgICAgZ2VvbWV0cnlUeXBlLFxuICAgICAgICAgICAgZ2VvbWV0cnk6IGFvaVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfTtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICBjb25zdCBhZG1pbkxheWVySW5mbyA9IGdldEFkbWluTGF5ZXJJbmZvKGZMYXllci5sYXllcklkLCBwcm9wcyk7XG4gICAgICBjb25zdCBhb2lWYWx1ZSA9IChfZSA9IChfZCA9IChfYyA9IChfYiA9IGFkbWluTGF5ZXJJbmZvID09PSBudWxsIHx8IGFkbWluTGF5ZXJJbmZvID09PSB2b2lkIDAgPyB2b2lkIDAgOiBhZG1pbkxheWVySW5mby5hZG1pbkxheWVySW5mbykgPT09IG51bGwgfHwgX2IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9iLnZpZXdMYXllckRlZmluaXRpb24pID09PSBudWxsIHx8IF9jID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYy50YWJsZSkgPT09IG51bGwgfHwgX2QgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9kLmZpbHRlcikgPT09IG51bGwgfHwgX2UgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9lLnZhbHVlO1xuICAgICAgaWYgKGFvaVZhbHVlKSB7XG4gICAgICAgIC8vIG9ubHkgdXBkYXRlIGlmIHRoZXJlIHdhcyBvbmUgYmVmb3JlXG4gICAgICAgIGpzb24udmlld0xheWVyRGVmaW5pdGlvbiA9IHtcbiAgICAgICAgICBmaWx0ZXI6IG51bGxcbiAgICAgICAgfTtcbiAgICAgIH1cbiAgICB9XG4gICAgLy8gZmllbGRzXG4gICAgaWYgKHZpZXdMYXllclByb3BzLmZpZWxkcykge1xuICAgICAganNvbi5maWVsZHMgPSBmTGF5ZXIuZmllbGRzLm1hcCgoZmllbGQpID0+IHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBuYW1lOiBmaWVsZC5uYW1lLFxuICAgICAgICAgIHZpc2libGU6IHZpZXdMYXllclByb3BzLmZpZWxkcy5pbmRleE9mKGZpZWxkLm5hbWUpID4gLTFcbiAgICAgICAgfTtcbiAgICAgIH0pO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgIC8vIGFsbCBmaWVsZHMgYXJlIHZpc2libGVcbiAgICAgIGpzb24uZmllbGRzID0gZkxheWVyLmZpZWxkcy5tYXAoKGZpZWxkKSA9PiB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgbmFtZTogZmllbGQubmFtZSxcbiAgICAgICAgICB2aXNpYmxlOiB0cnVlXG4gICAgICAgIH07XG4gICAgICB9KTtcbiAgICB9XG4gIH1cbiAgZWxzZSB7XG4gICAgLy8gZmlsdGVyXG4gICAganNvbi52aWV3RGVmaW5pdGlvblF1ZXJ5ID0gXCJcIjtcbiAgICAvLyBmaWVsZHNcbiAgICBqc29uLmZpZWxkcyA9IGZMYXllci5maWVsZHMubWFwKChmaWVsZCkgPT4ge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgbmFtZTogZmllbGQubmFtZSxcbiAgICAgICAgdmlzaWJsZTogdHJ1ZVxuICAgICAgfTtcbiAgICB9KTtcbiAgICAvLyBBT0lcbiAgICBjb25zdCBhZG1pbkxheWVySW5mbyA9IGdldEFkbWluTGF5ZXJJbmZvKGZMYXllci5sYXllcklkLCBwcm9wcyk7XG4gICAgY29uc3QgYW9pVmFsdWUgPSAoX2ogPSAoX2ggPSAoX2cgPSAoX2YgPSBhZG1pbkxheWVySW5mbyA9PT0gbnVsbCB8fCBhZG1pbkxheWVySW5mbyA9PT0gdm9pZCAwID8gdm9pZCAwIDogYWRtaW5MYXllckluZm8uYWRtaW5MYXllckluZm8pID09PSBudWxsIHx8IF9mID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfZi52aWV3TGF5ZXJEZWZpbml0aW9uKSA9PT0gbnVsbCB8fCBfZyA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2cudGFibGUpID09PSBudWxsIHx8IF9oID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfaC5maWx0ZXIpID09PSBudWxsIHx8IF9qID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfai52YWx1ZTtcbiAgICBpZiAoYW9pVmFsdWUpIHtcbiAgICAgIC8vIG9ubHkgdXBkYXRlIGlmIHRoZXJlIHdhcyBvbmUgYmVmb3JlXG4gICAgICBqc29uLnZpZXdMYXllckRlZmluaXRpb24gPSB7XG4gICAgICAgIGZpbHRlcjogbnVsbFxuICAgICAgfTtcbiAgICB9XG4gIH1cbiAgLy9jb25zb2xlLmxvZyhcImdldFVwZGF0ZUxheWVySlNPTiAtIGlkOlwiLCBmTGF5ZXIubGF5ZXJJZCwganNvbik7XG4gIHJldHVybiBqc29uO1xufVxuYXN5bmMgZnVuY3Rpb24gbW92ZVRvRm9sZGVyKHByb3BzLCBjcmVhdGVTZXJ2aWNlUmVzcG9uc2UsIG5ld0l0ZW1Qcm9wcywgZXNyaVJlcXVlc3QpIHtcbiAgY29uc3QgeyBsYXllciB9ID0gcHJvcHM7XG4gIGNvbnN0IHBvcnRhbEl0ZW0gPSBsYXllci5wb3J0YWxJdGVtO1xuICBjb25zdCB7IHBvcnRhbCB9ID0gcG9ydGFsSXRlbTtcbiAgaWYgKCFuZXdJdGVtUHJvcHMuZm9sZGVyIHx8ICFuZXdJdGVtUHJvcHMuZm9sZGVyLmlkIHx8IG5ld0l0ZW1Qcm9wcy5mb2xkZXIuaWQgPT09IHBvcnRhbEl0ZW0ub3duZXIpIHtcbiAgICAvLyBpdCdzIGFscmVhZHkgaW4gdGhlIGhvbWUgZm9sZGVyXG4gICAgcmV0dXJuO1xuICB9XG4gIGxldCBiYXNlVXJsID0gYCR7cG9ydGFsLnJlc3RVcmx9L2NvbnRlbnQvdXNlcnMvJHtwb3J0YWxJdGVtLm93bmVyfS9pdGVtcy9gO1xuICBjb25zdCBtb3ZlVXJsID0gYCR7YmFzZVVybH0ke2NyZWF0ZVNlcnZpY2VSZXNwb25zZS5pdGVtSWR9L21vdmVgO1xuICBjb25zdCBtb3ZlQ29udGVudCA9IHtcbiAgICBmb2xkZXI6IG5ld0l0ZW1Qcm9wcy5mb2xkZXIuaWRcbiAgfTtcbiAgcmV0dXJuIGF3YWl0IGVzcmlSZXF1ZXN0KG1vdmVVcmwsIHtcbiAgICBxdWVyeTogT2JqZWN0LmFzc2lnbihPYmplY3QuYXNzaWduKHt9LCBtb3ZlQ29udGVudCksIHsgZjogXCJqc29uXCIsIHRva2VuOiBwb3J0YWwuY3JlZGVudGlhbC50b2tlbiB9KSxcbiAgICBtZXRob2Q6IFwicG9zdFwiLFxuICAgIHJlc3BvbnNlVHlwZTogXCJqc29uXCJcbiAgfSk7XG59XG5hc3luYyBmdW5jdGlvbiBpbml0aWFsSXRlbVVwZGF0ZShwcm9wcywgY3JlYXRlU2VydmljZVJlc3BvbnNlLCBuZXdJdGVtUHJvcHMsIGVzcmlSZXF1ZXN0KSB7XG4gIHZhciBfYSwgX2IsIF9jLCBfZCwgX2UsIF9mLCBfZywgX2gsIF9qLCBfaywgX2wsIF9tLCBfbywgX3A7XG4gIGNvbnN0IHsgbGF5ZXIsIGxheWVySWRzIH0gPSBwcm9wcztcbiAgY29uc3QgcG9ydGFsSXRlbSA9IGxheWVyLnBvcnRhbEl0ZW07XG4gIGNvbnN0IHBvcnRhbCA9IHBvcnRhbEl0ZW0ucG9ydGFsO1xuICBjb25zdCBpdGVtRGF0YSA9IGF3YWl0IGxheWVyLnBvcnRhbEl0ZW0uZmV0Y2hEYXRhKCk7XG4gIGNvbnN0IGhhc0RhdGEgPSAoaXRlbURhdGEgPT09IG51bGwgfHwgaXRlbURhdGEgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGl0ZW1EYXRhLmxheWVycykgfHwgKGl0ZW1EYXRhID09PSBudWxsIHx8IGl0ZW1EYXRhID09PSB2b2lkIDAgPyB2b2lkIDAgOiBpdGVtRGF0YS50YWJsZXMpO1xuICBpZiAoaGFzRGF0YSkge1xuICAgIGl0ZW1EYXRhLmxheWVycyA9IChfYSA9IGl0ZW1EYXRhLmxheWVycykgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmZpbHRlcigobHlyKSA9PiBsYXllcklkcy5pbmRleE9mKGx5ci5pZCkgPiAtMSk7XG4gICAgaXRlbURhdGEudGFibGVzID0gKF9iID0gaXRlbURhdGEudGFibGVzKSA9PT0gbnVsbCB8fCBfYiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2IuZmlsdGVyKChseXIpID0+IGxheWVySWRzLmluZGV4T2YobHlyLmlkKSA+IC0xKTtcbiAgICAvLyBpZiB0aGVyZSBhcmUgbm8gZXhpc3Rpbmcgb3ZlcnJpZGVzIGZvciBsYXllcnMgb3IgdGFibGVzIGtlZXAgdGhlbSB1bmRlZmluZWRcbiAgICBpZiAobGF5ZXIudHlwZSA9PT0gXCJncm91cFwiICYmICgoX2MgPSBsYXllci5sYXllcnMpID09PSBudWxsIHx8IF9jID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYy5sZW5ndGgpKSB7XG4gICAgICBpdGVtRGF0YS5sYXllcnMgPSBpdGVtRGF0YS5sYXllcnMgfHwgdW5kZWZpbmVkO1xuICAgIH1cbiAgICBpZiAobGF5ZXIudHlwZSA9PT0gXCJncm91cFwiICYmICgoX2QgPSBsYXllci50YWJsZXMpID09PSBudWxsIHx8IF9kID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfZC5sZW5ndGgpKSB7XG4gICAgICBpdGVtRGF0YS50YWJsZXMgPSBpdGVtRGF0YS50YWJsZXMgfHwgdW5kZWZpbmVkO1xuICAgIH1cbiAgICAvLyByZW1vdmUgcGFyZW50IGl0ZW0gZGVmaW5pdGlvbkV4cHJlc3Npb25cbiAgICAoX2UgPSBpdGVtRGF0YS5sYXllcnMpID09PSBudWxsIHx8IF9lID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfZS5mb3JFYWNoKChseXIpID0+IHtcbiAgICAgIGlmIChseXIubGF5ZXJEZWZpbml0aW9uKSB7XG4gICAgICAgIGx5ci5sYXllckRlZmluaXRpb24uZGVmaW5pdGlvbkV4cHJlc3Npb24gPSB1bmRlZmluZWQ7XG4gICAgICB9XG4gICAgfSk7XG4gICAgKF9mID0gaXRlbURhdGEudGFibGVzKSA9PT0gbnVsbCB8fCBfZiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2YuZm9yRWFjaCgodGFibGUpID0+IHtcbiAgICAgIGlmICh0YWJsZS5sYXllckRlZmluaXRpb24pIHtcbiAgICAgICAgdGFibGUubGF5ZXJEZWZpbml0aW9uLmRlZmluaXRpb25FeHByZXNzaW9uID0gdW5kZWZpbmVkO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG4gIGNvbnN0IHVwZGF0ZVVybCA9IGAke3BvcnRhbC5yZXN0VXJsfS9jb250ZW50L3VzZXJzLyR7cG9ydGFsSXRlbS5vd25lcn0vaXRlbXMvJHtjcmVhdGVTZXJ2aWNlUmVzcG9uc2UuaXRlbUlkfS91cGRhdGVgO1xuICAvLyBuZWVkIHRvIHNlbmQgc29tZSBpbmZvIGFnYWluXG4gIGNvbnN0IHVwZGF0ZUNvbnRlbnQgPSB7XG4gICAgdGl0bGU6IG5ld0l0ZW1Qcm9wcy50aXRsZSxcbiAgICB0YWdzOiAoKF9nID0gbmV3SXRlbVByb3BzLnRhZ3MpID09PSBudWxsIHx8IF9nID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfZy5sZW5ndGgpID8gbmV3SXRlbVByb3BzLnRhZ3MudG9TdHJpbmcoKSA6IHVuZGVmaW5lZCxcbiAgICBzbmlwcGV0OiBuZXdJdGVtUHJvcHMuc3VtbWFyeSxcbiAgICBjYXRlZ29yaWVzOiAoX2ggPSBuZXdJdGVtUHJvcHMuY2F0ZWdvcmllcykgPT09IG51bGwgfHwgX2ggPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9oLmpvaW4oXCIsXCIpXG4gICAgLy9leHRlbnQ6IGAke3BvcnRhbEl0ZW0uZXh0ZW50LnhtaW59LCR7cG9ydGFsSXRlbS5leHRlbnQueW1pbn0sJHtwb3J0YWxJdGVtLmV4dGVudC54bWF4fSwke3BvcnRhbEl0ZW0uZXh0ZW50LnltYXh9YCxcbiAgfTtcbiAgaWYgKGhhc0RhdGEpIHtcbiAgICB1cGRhdGVDb250ZW50LnRleHQgPSBKU09OLnN0cmluZ2lmeShpdGVtRGF0YSk7XG4gIH1cbiAgaWYgKChsYXllci50eXBlID09PSBcImdyb3VwXCIgJiYgKChfbSA9IChfbCA9IChfayA9IChfaiA9IGxheWVyLmxheWVycykgPT09IG51bGwgfHwgX2ogPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9qLmdldEl0ZW1BdCgwKSkgPT09IG51bGwgfHwgX2sgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9rLmZ1bGxFeHRlbnQpID09PSBudWxsIHx8IF9sID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfbC5zcGF0aWFsUmVmZXJlbmNlKSA9PT0gbnVsbCB8fCBfbSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX20ud2t0KSkgfHxcbiAgICAobGF5ZXIudHlwZSA9PT0gXCJmZWF0dXJlXCIgJiYgKChfcCA9IChfbyA9IGxheWVyLmZ1bGxFeHRlbnQpID09PSBudWxsIHx8IF9vID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfby5zcGF0aWFsUmVmZXJlbmNlKSA9PT0gbnVsbCB8fCBfcCA9PT0gdm9pZCAwID8gdm9pZCAwIDogX3Aud2t0KSkpIHtcbiAgICAvLyBmaXggYmFkIGl0ZW0gZXh0ZW50IGNyZWF0ZWQgYnkgdGhlIC9yZWZyZXNoIGNhbGwgc2VudCBmcm9tIGFkZFRvRGVmaW5pdGlvblxuICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgY29uc3QgdXBkYXRlQ29udGVudDIgPSB7XG4gICAgICAgIGV4dGVudDogYCR7cG9ydGFsSXRlbS5leHRlbnQueG1pbn0sJHtwb3J0YWxJdGVtLmV4dGVudC55bWlufSwke3BvcnRhbEl0ZW0uZXh0ZW50LnhtYXh9LCR7cG9ydGFsSXRlbS5leHRlbnQueW1heH1gXG4gICAgICB9O1xuICAgICAgZXNyaVJlcXVlc3QodXBkYXRlVXJsLCB7XG4gICAgICAgIHF1ZXJ5OiBPYmplY3QuYXNzaWduKE9iamVjdC5hc3NpZ24oe30sIHVwZGF0ZUNvbnRlbnQyKSwgeyBmOiBcImpzb25cIiwgdG9rZW46IHBvcnRhbC5jcmVkZW50aWFsLnRva2VuIH0pLFxuICAgICAgICBtZXRob2Q6IFwicG9zdFwiLFxuICAgICAgICByZXNwb25zZVR5cGU6IFwianNvblwiXG4gICAgICB9KTtcbiAgICB9LCA3MDAwKTtcbiAgfVxuICByZXR1cm4gYXdhaXQgZXNyaVJlcXVlc3QodXBkYXRlVXJsLCB7XG4gICAgcXVlcnk6IE9iamVjdC5hc3NpZ24oT2JqZWN0LmFzc2lnbih7fSwgdXBkYXRlQ29udGVudCksIHsgZjogXCJqc29uXCIsIHRva2VuOiBwb3J0YWwuY3JlZGVudGlhbC50b2tlbiB9KSxcbiAgICBtZXRob2Q6IFwicG9zdFwiLFxuICAgIHJlc3BvbnNlVHlwZTogXCJqc29uXCJcbiAgfSk7XG59XG5hc3luYyBmdW5jdGlvbiBpdGVtVXBkYXRlKHByb3BzLCBhZGRMYXllcklkcywgZGVsZXRlTGF5ZXJJZHMsIGVzcmlSZXF1ZXN0KSB7XG4gIHZhciBfYSwgX2IsIF9jLCBfZCwgX2UsIF9mLCBfZywgX2g7XG4gIGlmICghYWRkTGF5ZXJJZHMubGVuZ3RoICYmICFkZWxldGVMYXllcklkcy5sZW5ndGgpIHtcbiAgICAvLyBub3RoaW5nIHRvIGRvXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7XG4gICAgICByZXNvbHZlKCk7XG4gICAgfSk7XG4gIH1cbiAgY29uc3QgeyBsYXllciwgdmlld0l0ZW0gfSA9IHByb3BzO1xuICBjb25zdCBwb3J0YWxJdGVtID0gbGF5ZXIucG9ydGFsSXRlbTtcbiAgY29uc3QgcG9ydGFsID0gcG9ydGFsSXRlbS5wb3J0YWw7XG4gIGNvbnN0IGl0ZW1EYXRhID0gYXdhaXQgbGF5ZXIucG9ydGFsSXRlbS5mZXRjaERhdGEoKTtcbiAgbGV0IHZpZXdJdGVtRGF0YSA9IGF3YWl0IHZpZXdJdGVtLmZldGNoRGF0YSgpO1xuICBpZiAoKCFpdGVtRGF0YSB8fCAoIWl0ZW1EYXRhLmxheWVycyAmJiAhaXRlbURhdGEudGFibGVzKSkgJiZcbiAgICAoIXZpZXdJdGVtRGF0YSB8fCAoIXZpZXdJdGVtRGF0YS5sYXllcnMgJiYgIXZpZXdJdGVtRGF0YS50YWJsZXMpKSkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4ge1xuICAgICAgcmVzb2x2ZSgpO1xuICAgIH0pO1xuICB9XG4gIGlmIChkZWxldGVMYXllcklkcy5sZW5ndGgpIHtcbiAgICBpZiAoKF9hID0gdmlld0l0ZW1EYXRhID09PSBudWxsIHx8IHZpZXdJdGVtRGF0YSA9PT0gdm9pZCAwID8gdm9pZCAwIDogdmlld0l0ZW1EYXRhLmxheWVycykgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmxlbmd0aCkge1xuICAgICAgdmlld0l0ZW1EYXRhLmxheWVycyA9IHZpZXdJdGVtRGF0YS5sYXllcnMuZmlsdGVyKChseXIpID0+IGRlbGV0ZUxheWVySWRzLmluZGV4T2YobHlyLmlkKSA9PT0gLTEpO1xuICAgIH1cbiAgICBpZiAoKF9iID0gdmlld0l0ZW1EYXRhID09PSBudWxsIHx8IHZpZXdJdGVtRGF0YSA9PT0gdm9pZCAwID8gdm9pZCAwIDogdmlld0l0ZW1EYXRhLnRhYmxlcykgPT09IG51bGwgfHwgX2IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9iLmxlbmd0aCkge1xuICAgICAgdmlld0l0ZW1EYXRhLnRhYmxlcyA9IHZpZXdJdGVtRGF0YS50YWJsZXMuZmlsdGVyKChseXIpID0+IGRlbGV0ZUxheWVySWRzLmluZGV4T2YobHlyLmlkKSA9PT0gLTEpO1xuICAgIH1cbiAgfVxuICAvLyBEbyB3ZSBhbHJlYWR5IGhhdmUgYSBsYXllcnMvdGFibGVzIGxpc3QgaW4gdGhlIGl0ZW0gL2RhdGEgb2JqZWN0P1xuICAvLyBJZiBzbywgYXJlIHdlIGFkZGluZyBzb21lIG5ldyBsYXllcnMvdGFibGVzP1xuICAvLyBUaGVuIHdlIGhhdmUgdG8gbWFrZSBzdXJlIHRoYXQgd2UgYWRkIHRoZXNlIG5ldyBsYXllcnMvdGFibGVzIHRvIHRoZSBsaXN0XG4gIC8vIGV2ZW4gaWYgdGhlcmUgYXJlIG5vIGV4aXN0aW5nIG92ZXJyaWRlcyBmb3IgdGhlbVxuICBjb25zdCB2aWV3SXRlbUhhc0NvbnRlbnQgPSAhISgoX2MgPSB2aWV3SXRlbURhdGEgPT09IG51bGwgfHwgdmlld0l0ZW1EYXRhID09PSB2b2lkIDAgPyB2b2lkIDAgOiB2aWV3SXRlbURhdGEubGF5ZXJzKSA9PT0gbnVsbCB8fCBfYyA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2MubGVuZ3RoKSB8fCAhISgoX2QgPSB2aWV3SXRlbURhdGEgPT09IG51bGwgfHwgdmlld0l0ZW1EYXRhID09PSB2b2lkIDAgPyB2b2lkIDAgOiB2aWV3SXRlbURhdGEudGFibGVzKSA9PT0gbnVsbCB8fCBfZCA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2QubGVuZ3RoKTtcbiAgaWYgKGFkZExheWVySWRzLmxlbmd0aCkge1xuICAgIGNvbnN0IG5ld0xheWVycyA9IFtdO1xuICAgIGNvbnN0IG5ld1RhYmxlcyA9IFtdO1xuICAgIGFkZExheWVySWRzLmZvckVhY2goKGlkKSA9PiB7XG4gICAgICBjb25zdCBmTGF5ZXIgPSBnZXRGTChpZCwgcHJvcHMpO1xuICAgICAgaWYgKCFmTGF5ZXIuaXNUYWJsZSkge1xuICAgICAgICBsZXQgbmV3TGF5ZXI7XG4gICAgICAgIGlmIChpdGVtRGF0YSA9PT0gbnVsbCB8fCBpdGVtRGF0YSA9PT0gdm9pZCAwID8gdm9pZCAwIDogaXRlbURhdGEubGF5ZXJzKSB7XG4gICAgICAgICAgbmV3TGF5ZXIgPSBpdGVtRGF0YS5sYXllcnMuZmluZCgobHlyKSA9PiBseXIuaWQgPT09IGlkKTtcbiAgICAgICAgICAvLyByZW1vdmUgcGFyZW50IGl0ZW0gZGVmaW5pdGlvbkV4cHJlc3Npb25cbiAgICAgICAgICBpZiAobmV3TGF5ZXIgPT09IG51bGwgfHwgbmV3TGF5ZXIgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG5ld0xheWVyLmxheWVyRGVmaW5pdGlvbikge1xuICAgICAgICAgICAgbmV3TGF5ZXIubGF5ZXJEZWZpbml0aW9uLmRlZmluaXRpb25FeHByZXNzaW9uID0gdW5kZWZpbmVkO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAoIW5ld0xheWVyICYmIHZpZXdJdGVtSGFzQ29udGVudCkge1xuICAgICAgICAgIC8vIHdlIG11c3QgYWRkIHRoZSBuZXdseSBhZGRlZCBsYXllciB0byB0aGUgaXRlbSAvZGF0YSBsYXllcnMgbGlzdFxuICAgICAgICAgIC8vIG5vIG92ZXJyaWRlcywgYWRkIGp1c3QgaWQsIGRvbid0IG5lZWQgcG9wdXBcbiAgICAgICAgICBuZXdMYXllciA9IHsgaWQgfTtcbiAgICAgICAgfVxuICAgICAgICBpZiAobmV3TGF5ZXIpIHtcbiAgICAgICAgICBuZXdMYXllcnMucHVzaChuZXdMYXllcik7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGVsc2Uge1xuICAgICAgICAvLyB0YWJsZVxuICAgICAgICBsZXQgbmV3VGFibGU7XG4gICAgICAgIGlmIChpdGVtRGF0YSA9PT0gbnVsbCB8fCBpdGVtRGF0YSA9PT0gdm9pZCAwID8gdm9pZCAwIDogaXRlbURhdGEudGFibGVzKSB7XG4gICAgICAgICAgbmV3VGFibGUgPSBpdGVtRGF0YS50YWJsZXMuZmluZCgobHlyKSA9PiBseXIuaWQgPT09IGlkKTtcbiAgICAgICAgICAvLyByZW1vdmUgcGFyZW50IGl0ZW0gZGVmaW5pdGlvbkV4cHJlc3Npb25cbiAgICAgICAgICBpZiAobmV3VGFibGUgPT09IG51bGwgfHwgbmV3VGFibGUgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG5ld1RhYmxlLmxheWVyRGVmaW5pdGlvbikge1xuICAgICAgICAgICAgbmV3VGFibGUubGF5ZXJEZWZpbml0aW9uLmRlZmluaXRpb25FeHByZXNzaW9uID0gdW5kZWZpbmVkO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAoIW5ld1RhYmxlICYmIHZpZXdJdGVtSGFzQ29udGVudCkge1xuICAgICAgICAgIC8vIHdlIG11c3QgYWRkIHRoZSBuZXdseSBhZGRlZCBsYXllciB0byB0aGUgaXRlbSAvZGF0YSBsYXllcnMgbGlzdFxuICAgICAgICAgIC8vIG5vIG92ZXJyaWRlcywgYWRkIGp1c3QgaWQsIGRvbid0IG5lZWQgcG9wdXBcbiAgICAgICAgICBuZXdUYWJsZSA9IHsgaWQgfTtcbiAgICAgICAgfVxuICAgICAgICBpZiAobmV3VGFibGUpIHtcbiAgICAgICAgICBuZXdUYWJsZXMucHVzaChuZXdUYWJsZSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KTtcbiAgICBpZiAobmV3TGF5ZXJzID09PSBudWxsIHx8IG5ld0xheWVycyA9PT0gdm9pZCAwID8gdm9pZCAwIDogbmV3TGF5ZXJzLmxlbmd0aCkge1xuICAgICAgdmlld0l0ZW1EYXRhID0gdmlld0l0ZW1EYXRhIHx8IHt9O1xuICAgICAgdmlld0l0ZW1EYXRhLmxheWVycyA9ICh2aWV3SXRlbURhdGEubGF5ZXJzIHx8IFtdKS5jb25jYXQobmV3TGF5ZXJzKTtcbiAgICAgIC8vIG1ha2Ugc3VyZSBpdCBmb2xsb3dzIHRoZSBwYXJlbnQgbGF5ZXIncyBvcmRlclxuICAgICAgLy8gdGhlIHZpZXcgc2VydmljZSBtaWdodCBoYXZlIGl0IGRpZmZlcmVudGx5IChzZXJ2aWNlIGJ1ZylcbiAgICAgIGNvbnN0IGlkcyA9IFtdO1xuICAgICAgKF9lID0gbGF5ZXIubGF5ZXJzKSA9PT0gbnVsbCB8fCBfZSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2UuZm9yRWFjaCgobHlyKSA9PiB7XG4gICAgICAgIGlkcy51bnNoaWZ0KGx5ci5sYXllcklkKTtcbiAgICAgIH0pO1xuICAgICAgdmlld0l0ZW1EYXRhLmxheWVycy5zb3J0KChseXJBLCBseXJCKSA9PiAoaWRzLmluZGV4T2YobHlyQS5pZCkgPCBpZHMuaW5kZXhPZihseXJCLmlkKSA/IC0xIDogMSkpO1xuICAgIH1cbiAgICBpZiAobmV3VGFibGVzID09PSBudWxsIHx8IG5ld1RhYmxlcyA9PT0gdm9pZCAwID8gdm9pZCAwIDogbmV3VGFibGVzLmxlbmd0aCkge1xuICAgICAgdmlld0l0ZW1EYXRhID0gdmlld0l0ZW1EYXRhIHx8IHt9O1xuICAgICAgdmlld0l0ZW1EYXRhLnRhYmxlcyA9ICh2aWV3SXRlbURhdGEudGFibGVzIHx8IFtdKS5jb25jYXQobmV3VGFibGVzKTtcbiAgICAgIC8vIG1ha2Ugc3VyZSBpdCBmb2xsb3dzIHRoZSBwYXJlbnQgbGF5ZXIncyBvcmRlclxuICAgICAgLy8gdGhlIHZpZXcgc2VydmljZSBtaWdodCBoYXZlIGl0IGRpZmZlcmVudGx5IChzZXJ2aWNlIGJ1ZylcbiAgICAgIGNvbnN0IGlkcyA9IFtdO1xuICAgICAgKF9mID0gbGF5ZXIudGFibGVzKSA9PT0gbnVsbCB8fCBfZiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2YuZm9yRWFjaCgobHlyKSA9PiB7XG4gICAgICAgIGlkcy51bnNoaWZ0KGx5ci5sYXllcklkKTtcbiAgICAgIH0pO1xuICAgICAgdmlld0l0ZW1EYXRhLnRhYmxlcy5zb3J0KChseXJBLCBseXJCKSA9PiAoaWRzLmluZGV4T2YobHlyQS5pZCkgPCBpZHMuaW5kZXhPZihseXJCLmlkKSA/IC0xIDogMSkpO1xuICAgIH1cbiAgfVxuICBjb25zdCB1cGRhdGVVcmwgPSBgJHtwb3J0YWwucmVzdFVybH0vY29udGVudC91c2Vycy8ke3BvcnRhbEl0ZW0ub3duZXJ9L2l0ZW1zLyR7dmlld0l0ZW0uaWR9L3VwZGF0ZWA7XG4gIC8vIG5lZWQgdG8gc2VuZCBzb21lIGluZm8gYWdhaW5cbiAgY29uc3QgdXBkYXRlQ29udGVudCA9IHtcbiAgICB0YWdzOiAoKF9nID0gdmlld0l0ZW0udGFncykgPT09IG51bGwgfHwgX2cgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9nLmxlbmd0aCkgPyB2aWV3SXRlbS50YWdzLnRvU3RyaW5nKCkgOiB1bmRlZmluZWQsXG4gICAgc25pcHBldDogdmlld0l0ZW0uc25pcHBldCxcbiAgICBjYXRlZ29yaWVzOiAoX2ggPSB2aWV3SXRlbS5jYXRlZ29yaWVzKSA9PT0gbnVsbCB8fCBfaCA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2guam9pbihcIixcIiksXG4gICAgLy9leHRlbnQ6IGAke3ZpZXdJdGVtLmV4dGVudC54bWlufSwke3ZpZXdJdGVtLmV4dGVudC55bWlufSwke3ZpZXdJdGVtLmV4dGVudC54bWF4fSwke3ZpZXdJdGVtLmV4dGVudC55bWF4fWAsXG4gICAgdGV4dDogSlNPTi5zdHJpbmdpZnkodmlld0l0ZW1EYXRhKVxuICB9O1xuICByZXR1cm4gYXdhaXQgZXNyaVJlcXVlc3QodXBkYXRlVXJsLCB7XG4gICAgcXVlcnk6IE9iamVjdC5hc3NpZ24oT2JqZWN0LmFzc2lnbih7fSwgdXBkYXRlQ29udGVudCksIHsgZjogXCJqc29uXCIsIHRva2VuOiBwb3J0YWwuY3JlZGVudGlhbC50b2tlbiB9KSxcbiAgICBtZXRob2Q6IFwicG9zdFwiLFxuICAgIHJlc3BvbnNlVHlwZTogXCJqc29uXCJcbiAgfSk7XG59XG5jb25zdCBwb2xsRm9yU3RhdHVzJDEgPSBhc3luYyAodXJsLCBwYXJhbXMsIGVzcmlSZXF1ZXN0KSA9PiB7XG4gIHZhciBfYTtcbiAgaWYgKCF1cmwpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJwb2xsRm9yU3RhdHVzOiBubyBzdGF0dXMgVVJMXCIpO1xuICB9XG4gIGNvbnN0IHBlbmRpbmdTdGF0dXNlcyA9IFtcInByb2Nlc3NpbmdcIiwgXCJwYXJ0aWFsXCIsIFwiUGVuZGluZ1wiLCBcIkluUHJvZ3Jlc3NcIl07XG4gIGNvbnN0IHN1Y2Nlc3NTdGF0dXNlcyA9IFtcImNvbXBsZXRlZFwiLCBcIkNvbXBsZXRlZFwiXTtcbiAgLy8gS2VlcCBwb2xsaW5nIHN0YXR1cyB1bnRpbCBlaXRoZXIgY29tcGxldGVkIG9yIGZhaWxlZFxuICB0cnkge1xuICAgIC8vIERvIGZhaWx1cmVzIHJlcG9ydCBhcyBzdWNjZXNzIChzdGF0dXMgMjAwKT8gTWF5IG5lZWQgdG8gbWFudWFsbHkgdGhyb3cgZXJyb3Igb24gc3RhdHVzIGNoZWNrIGZhaWx1cmVcbiAgICBjb25zdCBzdGF0dXNSZXNwb25zZSA9IGF3YWl0IGVzcmlSZXF1ZXN0KHVybCwgeyBxdWVyeTogcGFyYW1zIH0pO1xuICAgIGNvbnN0IHN0YXR1cyA9IChfYSA9IHN0YXR1c1Jlc3BvbnNlID09PSBudWxsIHx8IHN0YXR1c1Jlc3BvbnNlID09PSB2b2lkIDAgPyB2b2lkIDAgOiBzdGF0dXNSZXNwb25zZS5kYXRhKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2Euc3RhdHVzO1xuICAgIGlmIChwZW5kaW5nU3RhdHVzZXMuaW5jbHVkZXMoc3RhdHVzKSkge1xuICAgICAgYXdhaXQgdGltZW91dCg1MDApO1xuICAgICAgcmV0dXJuIHBvbGxGb3JTdGF0dXMkMSh1cmwsIHBhcmFtcywgZXNyaVJlcXVlc3QpO1xuICAgIH1cbiAgICBlbHNlIGlmIChzdWNjZXNzU3RhdHVzZXMuaW5jbHVkZXMoc3RhdHVzKSkge1xuICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7XG4gICAgICAgIHJlc29sdmUoKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgoXywgcmVqZWN0KSA9PiB7XG4gICAgICAgIHJlamVjdCgpO1xuICAgICAgfSk7XG4gICAgfVxuICB9XG4gIGNhdGNoIChlKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChfLCByZWplY3QpID0+IHtcbiAgICAgIHJlamVjdChlKTtcbiAgICB9KTtcbiAgfVxufTtcblxuY29uc3QgYXJjZ2lzTGF5ZXJWaWV3Q3NzID0gXCIuc2MtYXJjZ2lzLWxheWVyLXZpZXctaHtoZWlnaHQ6MTAwJX0ucGFuZWwuc2MtYXJjZ2lzLWxheWVyLXZpZXd7aGVpZ2h0OjEwMCV9LmZvb3Rlci5zYy1hcmNnaXMtbGF5ZXItdmlld3t3aWR0aDoxMDAlfS5lcnJvci1jb250ZW50LnNjLWFyY2dpcy1sYXllci12aWV3e21hcmdpbjowLjVyZW19XCI7XG5cbmNvbnN0IEFyY2dpc0xheWVyVmlldyQxID0gY2xhc3Mge1xuICBjb25zdHJ1Y3Rvcihob3N0UmVmKSB7XG4gICAgcmVnaXN0ZXJJbnN0YW5jZSh0aGlzLCBob3N0UmVmKTtcbiAgICB0aGlzLmFyY2dpc0xheWVyVmlld0NhbmNlbCA9IGNyZWF0ZUV2ZW50KHRoaXMsIFwiYXJjZ2lzTGF5ZXJWaWV3Q2FuY2VsXCIsIDcpO1xuICAgIHRoaXMuYXJjZ2lzTGF5ZXJWaWV3U3RlcENoYW5nZSA9IGNyZWF0ZUV2ZW50KHRoaXMsIFwiYXJjZ2lzTGF5ZXJWaWV3U3RlcENoYW5nZVwiLCA3KTtcbiAgICB0aGlzLmFyY2dpc0xheWVyVmlld0NyZWF0ZWQgPSBjcmVhdGVFdmVudCh0aGlzLCBcImFyY2dpc0xheWVyVmlld0NyZWF0ZWRcIiwgNyk7XG4gICAgdGhpcy5hcmNnaXNMYXllclZpZXdDaGFuZ2VkID0gY3JlYXRlRXZlbnQodGhpcywgXCJhcmNnaXNMYXllclZpZXdDaGFuZ2VkXCIsIDcpO1xuICAgIHRoaXMuc3RhdHVzID0gZmxvd1N0YXR1cy5MT0FESU5HO1xuICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgLy9cbiAgICAvLyAgUHJpdmF0ZSBtZXRob2RzXG4gICAgLy9cbiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAgIHRoaXMuZ29DYW5jZWwgPSAoKSA9PiB7XG4gICAgICB0aGlzLmFyY2dpc0xheWVyVmlld0NhbmNlbC5lbWl0KCk7XG4gICAgfTtcbiAgICB0aGlzLnZpZXcgPSB1bmRlZmluZWQ7XG4gICAgdGhpcy5pdGVtSWQgPSB1bmRlZmluZWQ7XG4gICAgdGhpcy5jb25maWcgPSB1bmRlZmluZWQ7XG4gICAgdGhpcy5wcm9wcyA9IHVuZGVmaW5lZDtcbiAgICB0aGlzLnJlUmVuZGVyID0gZmFsc2U7XG4gIH1cbiAgYXJjZ2lzTGF5ZXJWaWV3U3RhdHVzSGFuZGxlcihldmVudCkge1xuICAgIHZhciBfYTtcbiAgICBjb25zdCB7IHByb3BzIH0gPSB0aGlzO1xuICAgIGNvbnN0IHsgZGV0YWlsIH0gPSBldmVudDtcbiAgICB0aGlzLnN0YXR1cyA9IGRldGFpbC5zdGF0dXM7XG4gICAgaWYgKChfYSA9IGRldGFpbC5sYXllcklkcykgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmxlbmd0aCkge1xuICAgICAgcHJvcHMubGF5ZXJJZHMgPSBbLi4uZGV0YWlsLmxheWVySWRzXTtcbiAgICB9XG4gICAgaWYgKHRoaXMuc3RhdHVzID09PSBmbG93U3RhdHVzLlNFTEVDVElPTikge1xuICAgICAgLy8gd2UgbWlnaHQgY2hhbmdlIHNvdXJjZSBpdGVtIGluIHRoaXMgc3RlcC4uLlxuICAgICAgcHJvcHMuc291cmNlSXRlbUlkID0gcHJvcHMubGF5ZXJJdGVtLmlkO1xuICAgICAgdGhpcy5hcmNnaXNMYXllclZpZXdTdGVwQ2hhbmdlLmVtaXQoMSk7XG4gICAgfVxuICAgIGVsc2UgaWYgKHRoaXMuc3RhdHVzID09PSBmbG93U3RhdHVzLk9WRVJWSUVXKSB7XG4gICAgICB0aGlzLmFyY2dpc0xheWVyVmlld1N0ZXBDaGFuZ2UuZW1pdCgyKTtcbiAgICB9XG4gICAgZWxzZSBpZiAodGhpcy5zdGF0dXMgPT09IGZsb3dTdGF0dXMuQ1JFQVRFKSB7XG4gICAgICB0aGlzLmFyY2dpc0xheWVyVmlld1N0ZXBDaGFuZ2UuZW1pdCgzKTtcbiAgICB9XG4gICAgdGhpcy5yZVJlbmRlciA9ICF0aGlzLnJlUmVuZGVyO1xuICB9XG4gIGFzeW5jIGFyY2dpc0xheWVyVmlld0NyZWF0ZURvbmVIYW5kbGVyKGV2ZW50KSB7XG4gICAgdGhpcy5hcmNnaXNMYXllclZpZXdDcmVhdGVkLmVtaXQoZXZlbnQuZGV0YWlsKTtcbiAgfVxuICBhc3luYyBhcmNnaXNMYXllclZpZXdPdmVydmlld1VwZGF0ZWRIYW5kbGVyKCkge1xuICAgIHRoaXMuYXJjZ2lzTGF5ZXJWaWV3Q2hhbmdlZC5lbWl0KHRoaXMuaXRlbUlkKTtcbiAgfVxuICBhcmNnaXNMYXllclZpZXdTZWxlY3Rpb25DYW5jZWxIYW5kbGVyKCkge1xuICAgIHRoaXMuYXJjZ2lzTGF5ZXJWaWV3Q2FuY2VsLmVtaXQoKTtcbiAgfVxuICBhcmNnaXNMYXllclZpZXdPdmVydmlld0NhbmNlbEhhbmRsZXIoKSB7XG4gICAgdGhpcy5hcmNnaXNMYXllclZpZXdDYW5jZWwuZW1pdCgpO1xuICB9XG4gIGFyY2dpc0xheWVyVmlld0NyZWF0ZUNhbmNlbEhhbmRsZXIoKSB7XG4gICAgdGhpcy5hcmNnaXNMYXllclZpZXdDYW5jZWwuZW1pdCgpO1xuICB9XG4gIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgLy9cbiAgLy8gIFB1YmxpYyBNZXRob2RzXG4gIC8vXG4gIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgYXN5bmMgc2V0U3RlcChzdGVwKSB7XG4gICAgY29uc3QgeyBwcm9wcyB9ID0gdGhpcztcbiAgICBjb25zdCB7IHZpZXdJdGVtIH0gPSBwcm9wcztcbiAgICAvLyBjbG9zZSBwb3BvdmVyc1xuICAgIGRvY3VtZW50LmJvZHkucXVlcnlTZWxlY3RvckFsbChcIi5qcy1hcHAtZmx5b3V0XCIpLmZvckVhY2goKG5vZGUpID0+IHtcbiAgICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQobm9kZSk7XG4gICAgfSk7XG4gICAgc3dpdGNoIChzdGVwKSB7XG4gICAgICBjYXNlIDE6XG4gICAgICAgIHRoaXMuc3RhdHVzID0gZmxvd1N0YXR1cy5TRUxFQ1RJT047XG4gICAgICAgIHRoaXMucmVSZW5kZXIgPSAhdGhpcy5yZVJlbmRlcjtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIDI6XG4gICAgICAgIHRoaXMuc3RhdHVzID0gZmxvd1N0YXR1cy5PVkVSVklFVztcbiAgICAgICAgdGhpcy5yZVJlbmRlciA9ICF0aGlzLnJlUmVuZGVyO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgMzpcbiAgICAgICAgaWYgKCF2aWV3SXRlbSkge1xuICAgICAgICAgIHRoaXMuc3RhdHVzID0gZmxvd1N0YXR1cy5DUkVBVEU7XG4gICAgICAgICAgdGhpcy5yZVJlbmRlciA9ICF0aGlzLnJlUmVuZGVyO1xuICAgICAgICB9XG4gICAgICAgIGJyZWFrO1xuICAgIH1cbiAgfVxuICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIC8vXG4gIC8vICBMaWZlY3ljbGVcbiAgLy9cbiAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICBhc3luYyBjb21wb25lbnRXaWxsTG9hZCgpIHtcbiAgICBjb25zdCB7IGl0ZW1JZCwgdmlldywgY29uZmlnIH0gPSB0aGlzO1xuICAgIGNvbnN0IFtzdHJpbmdzXSA9IGF3YWl0IGdldExvY2FsZUNvbXBvbmVudFN0cmluZ3ModGhpcy5ob3N0RWxlbWVudCk7XG4gICAgdGhpcy5zdHJpbmdzID0gc3RyaW5ncztcbiAgICB0aGlzLnByb3BzID0geyBjb25maWcsIHZpZXcsIGl0ZW1JZCwgc3RyaW5ncywgbGF5ZXJJZHM6IFtdLCBtb2R1bGVzOiB7fSB9O1xuICB9XG4gIGFzeW5jIGNvbXBvbmVudERpZExvYWQoKSB7XG4gICAgdmFyIF9hLCBfYiwgX2M7XG4gICAgbGV0IHsgcHJvcHMgfSA9IHRoaXM7XG4gICAgY29uc3QgeyBpdGVtSWQsIHZpZXcgfSA9IHByb3BzO1xuICAgIGlmICghaXRlbUlkKSB7XG4gICAgICBjb25zb2xlLmVycm9yKFwiaXRlbUlkIGlzIGEgcmVxdWlyZWQgcHJvcGVydHkuXCIpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0cnkge1xuICAgICAgY29uc3QgW1BvcnRhbEl0ZW0sIExheWVyLCBFeHRlbnQsIHByb2plY3Rpb24sIGNvbG9yVXRpbHMsIFBvbHlnb24sIGVzcmlSZXF1ZXN0XSA9IGF3YWl0IGxvYWRNb2R1bGVzKFtcbiAgICAgICAgXCJlc3JpL3BvcnRhbC9Qb3J0YWxJdGVtXCIsXG4gICAgICAgIFwiZXNyaS9sYXllcnMvTGF5ZXJcIixcbiAgICAgICAgXCJlc3JpL2dlb21ldHJ5L0V4dGVudFwiLFxuICAgICAgICBcImVzcmkvZ2VvbWV0cnkvcHJvamVjdGlvblwiLFxuICAgICAgICBcImVzcmkvdmlld3Mvc3VwcG9ydC9jb2xvclV0aWxzXCIsXG4gICAgICAgIFwiZXNyaS9nZW9tZXRyeS9Qb2x5Z29uXCIsXG4gICAgICAgIFwiZXNyaS9yZXF1ZXN0XCJcbiAgICAgIF0pO1xuICAgICAgcHJvcHMubW9kdWxlcy5Qb3J0YWxJdGVtID0gUG9ydGFsSXRlbTtcbiAgICAgIHByb3BzLm1vZHVsZXMucHJvamVjdGlvbiA9IHByb2plY3Rpb247XG4gICAgICBwcm9wcy5tb2R1bGVzLlBvbHlnb24gPSBQb2x5Z29uO1xuICAgICAgcHJvcHMubW9kdWxlcy5FeHRlbnQgPSBFeHRlbnQ7XG4gICAgICBwcm9wcy5tb2R1bGVzLkxheWVyID0gTGF5ZXI7XG4gICAgICBjb25zdCBpdGVtID0gbmV3IFBvcnRhbEl0ZW0oe1xuICAgICAgICBpZDogaXRlbUlkXG4gICAgICB9KTtcbiAgICAgIGF3YWl0IGl0ZW0ubG9hZCgpO1xuICAgICAgaWYgKGl0ZW0udHlwZSAhPT0gXCJGZWF0dXJlIFNlcnZpY2VcIikge1xuICAgICAgICBjb25zb2xlLmVycm9yKFwiT25seSBGZWF0dXJlIFNlcnZpY2UgaXRlbXMgYXJlIGFsbG93ZWQuXCIpO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBsZXQgdmlld0l0ZW0sIGxheWVySXRlbTtcbiAgICAgIGlmICgoKF9hID0gaXRlbS50eXBlS2V5d29yZHMpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5pbmRleE9mKFwiVmlldyBTZXJ2aWNlXCIpKSA+IC0xKSB7XG4gICAgICAgIC8vIG5lZWQgdG8gbG9vayBmb3Igb3JpZ2luYWwgaXRlbVxuICAgICAgICB2aWV3SXRlbSA9IGl0ZW07XG4gICAgICAgIGF3YWl0IGl0ZW1cbiAgICAgICAgICAuZmV0Y2hSZWxhdGVkSXRlbXMoe1xuICAgICAgICAgIHJlbGF0aW9uc2hpcFR5cGU6IFwiU2VydmljZTJEYXRhXCIsXG4gICAgICAgICAgZGlyZWN0aW9uOiBcImZvcndhcmRcIlxuICAgICAgICB9KVxuICAgICAgICAgIC50aGVuKGFzeW5jIChyZXN1bHRzKSA9PiB7XG4gICAgICAgICAgaWYgKHJlc3VsdHMubGVuZ3RoKSB7XG4gICAgICAgICAgICBsYXllckl0ZW0gPSByZXN1bHRzWzBdO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgICBlbHNlIHtcbiAgICAgICAgbGF5ZXJJdGVtID0gaXRlbTtcbiAgICAgIH1cbiAgICAgIGlmICghbGF5ZXJJdGVtKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoXCJDb3VsZCBub3QgZmluZCByZWxhdGVkIGl0ZW0gZm9yIHZpZXcuXCIpO1xuICAgICAgICB0aGlzLnBhbmVsTm9kZS5sb2FkaW5nID0gZmFsc2U7XG4gICAgICAgIHRoaXMuc3RhdHVzID0gZmxvd1N0YXR1cy5FUlJPUjtcbiAgICAgICAgdGhpcy5yZVJlbmRlciA9ICF0aGlzLnJlUmVuZGVyO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBwcm9wcy5zb3VyY2VJdGVtSWQgPSBsYXllckl0ZW0uaWQ7XG4gICAgICBsZXQgbGF5ZXJJdGVtT3duZXIgPSBsYXllckl0ZW0ucG9ydGFsLnVzZXI7XG4gICAgICBpZiAobGF5ZXJJdGVtLnBvcnRhbC51c2VyLnVzZXJuYW1lICE9PSBsYXllckl0ZW0ub3duZXIpIHtcbiAgICAgICAgLy8gZ2V0IHVzZXIgaW5mbyBvZiBvd25lclxuICAgICAgICBhd2FpdCBlc3JpUmVxdWVzdChgJHtsYXllckl0ZW0ucG9ydGFsLnJlc3RVcmx9L2NvbW11bml0eS91c2Vycy8ke2xheWVySXRlbS5vd25lcn1gLCB7XG4gICAgICAgICAgcXVlcnk6IHsgZjogXCJqc29uXCIgfVxuICAgICAgICB9KS50aGVuKCh1c2VyUmVzdWx0KSA9PiB7XG4gICAgICAgICAgaWYgKHVzZXJSZXN1bHQgPT09IG51bGwgfHwgdXNlclJlc3VsdCA9PT0gdm9pZCAwID8gdm9pZCAwIDogdXNlclJlc3VsdC5kYXRhKSB7XG4gICAgICAgICAgICBsYXllckl0ZW1Pd25lciA9IHVzZXJSZXN1bHQuZGF0YTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgICAgbGV0IGdjc0V4dGVudCA9ICh2aWV3SXRlbSB8fCBsYXllckl0ZW0pLmV4dGVudDtcbiAgICAgIGlmICghZ2NzRXh0ZW50KSB7XG4gICAgICAgIGdjc0V4dGVudCA9IG5ldyBFeHRlbnQoe1xuICAgICAgICAgIHhtaW46IC0xODAsXG4gICAgICAgICAgeW1pbjogLTkwLFxuICAgICAgICAgIHhtYXg6IDE4MCxcbiAgICAgICAgICB5bWF4OiA5MCxcbiAgICAgICAgICBzcGF0aWFsUmVmZXJlbmNlOiA0MzI2XG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgICAgaWYgKHZpZXcuc3BhdGlhbFJlZmVyZW5jZS53a2lkICE9PSA0MzI2KSB7XG4gICAgICAgIGF3YWl0IHByb2plY3Rpb24ubG9hZCgpO1xuICAgICAgICBjb25zdCBleHRlbnQgPSBwcm9qZWN0aW9uLnByb2plY3QoZ2NzRXh0ZW50LCB2aWV3LnNwYXRpYWxSZWZlcmVuY2UpO1xuICAgICAgICB2aWV3LmdvVG8oZXh0ZW50LmV4cGFuZCgxLjEpKTtcbiAgICAgIH1cbiAgICAgIGVsc2Uge1xuICAgICAgICB2aWV3LmdvVG8oZ2NzRXh0ZW50LmV4cGFuZCgxLjEpKTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IGJhY2tncm91bmRUaGVtZSA9IGF3YWl0IGNvbG9yVXRpbHMuZ2V0QmFja2dyb3VuZENvbG9yVGhlbWUodmlldyk7XG4gICAgICAvLyBsYXllckl0ZW0gKGZyb20gcmVsYXRlZEl0ZW1zIGNhbGwpIGRvZXMgbm90IGNvbnRhaW4gaXRlbUNvbnRyb2xcbiAgICAgIC8vIG5lZWQgdG8gZ2V0IHRoZSBpdGVtIGNhcmQgYWdhaW4gdG8gZ2V0IGl0ZW1Db250cm9sIHRvb1xuICAgICAgLy8gbmVlZCBpdGVtQ29udHJvbCB0byBjcmVhdGUgaW5kZXhlc1xuICAgICAgbGF5ZXJJdGVtID0gbmV3IFBvcnRhbEl0ZW0oe1xuICAgICAgICBpZDogbGF5ZXJJdGVtLmlkXG4gICAgICB9KTtcbiAgICAgIGF3YWl0IGxheWVySXRlbS5sb2FkKCk7XG4gICAgICBjb25zdCBsYXllciA9IGF3YWl0IExheWVyLmZyb21Qb3J0YWxJdGVtKHtcbiAgICAgICAgcG9ydGFsSXRlbTogbGF5ZXJJdGVtXG4gICAgICB9KTtcbiAgICAgIHRoaXMucHJvcHMgPSBPYmplY3QuYXNzaWduKE9iamVjdC5hc3NpZ24oe30sIHByb3BzKSwgeyBsYXllckl0ZW0sIHZpZXdJdGVtLCBsYXllciwgbGF5ZXJJdGVtT3duZXIsIGJhY2tncm91bmRUaGVtZSB9KTtcbiAgICAgIHByb3BzID0gdGhpcy5wcm9wcztcbiAgICAgIC8vY29uc29sZS5sb2coXCIqKmxheWVySXRlbSoqXCIsIGxheWVySXRlbSk7XG4gICAgICAvL2NvbnNvbGUubG9nKFwiKip2aWV3SXRlbSoqXCIsIHZpZXdJdGVtKTtcbiAgICAgIC8vY29uc29sZS5sb2coXCIqKmxheWVyKipcIiwgbGF5ZXIpO1xuICAgICAgaWYgKGxheWVyLnR5cGUgPT09IFwiZ3JvdXBcIikge1xuICAgICAgICAvLyBncm91cCBsYXllciBoYXMgbm8gbGF5ZXJzIG9yIHRhYmxlcyBhdCB0aGlzIHBvaW50XG4gICAgICAgIC8vIGxvYWRBbGwoKSBsb2FkcyBsYXllcnMgYW5kIHRhYmxlcyAoYXQgdjQuMjMpXG4gICAgICAgIGF3YWl0IGxheWVyLmxvYWRBbGwoKTtcbiAgICAgICAgaWYgKChfYiA9IGxheWVyLmxheWVycykgPT09IG51bGwgfHwgX2IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9iLmxlbmd0aCkge1xuICAgICAgICAgIC8vIGhhcyBhdCBsZWFzdCBvbmUgc3BhdGlhbCBsYXllclxuICAgICAgICAgIHZpZXcubWFwLmFkZChsYXllcik7XG4gICAgICAgIH1cbiAgICAgICAgcHJvcHMubGF5ZXJJZHMgPSBnZXRMYXllcnNBbmRUYWJsZXMobGF5ZXIpXG4gICAgICAgICAgLm1hcCgoc3ViTGF5ZXIpID0+IHN1YkxheWVyLmxheWVySWQpXG4gICAgICAgICAgLnRvQXJyYXkoKTtcbiAgICAgICAgLy8gZGVmYXVsdCBwb3B1cHNcbiAgICAgICAgKF9jID0gbGF5ZXIubGF5ZXJzKSA9PT0gbnVsbCB8fCBfYyA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2MuZm9yRWFjaCgobHlyKSA9PiB7XG4gICAgICAgICAgaWYgKCFseXIucG9wdXBUZW1wbGF0ZSAmJiBseXIucG9wdXBFbmFibGVkKSB7XG4gICAgICAgICAgICBseXIucG9wdXBUZW1wbGF0ZSA9IGx5ci5jcmVhdGVQb3B1cFRlbXBsYXRlKCk7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICAgIGVsc2Uge1xuICAgICAgICBhd2FpdCBsYXllci5sb2FkKCk7XG4gICAgICAgIGlmICghbGF5ZXIuaXNUYWJsZSkge1xuICAgICAgICAgIHZpZXcubWFwLmFkZChsYXllcik7XG4gICAgICAgIH1cbiAgICAgICAgcHJvcHMubGF5ZXJJZHMgPSBbbGF5ZXIubGF5ZXJJZF07XG4gICAgICAgIC8vIGRlZmF1bHQgcG9wdXBcbiAgICAgICAgbGF5ZXIucG9wdXBUZW1wbGF0ZSA9IGxheWVyLmNyZWF0ZVBvcHVwVGVtcGxhdGUoKTtcbiAgICAgIH1cbiAgICAgIGF3YWl0IGdldEFkbWluU2VydmljZUluZm8kMShwcm9wcyk7XG4gICAgICAvKiBjb25zb2xlLmxvZyhcbiAgICAgICAgXCJ2aWV3IGFkbWluU2VydmljZUluZm8gbGF5ZXJzXCIsXG4gICAgICAgIHByb3BzLmFkbWluU2VydmljZUluZm8/LmxheWVycz8ubWFwKChseXI6IGFueSkgPT4ge1xuICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBpZDogbHlyLmlkLFxuICAgICAgICAgICAgbmFtZTogbHlyLm5hbWUsXG4gICAgICAgICAgICBhZG1pbkxheWVySW5mb19maWx0ZXI6IGx5ci5hZG1pbkxheWVySW5mbz8udmlld0xheWVyRGVmaW5pdGlvbj8udGFibGU/LmZpbHRlcj8udmFsdWUsXG4gICAgICAgICAgICB2aWV3RGVmaW5pdGlvblF1ZXJ5OiBseXIudmlld0RlZmluaXRpb25RdWVyeSxcbiAgICAgICAgICAgIGZpZWxkczogbHlyLmZpZWxkcy5tYXAoKGZpZWxkOiBhbnkpID0+IGAke2ZpZWxkLm5hbWV9ICgke2ZpZWxkLnZpc2libGV9KWApXG4gICAgICAgICAgfTtcbiAgICAgICAgfSlcbiAgICAgICk7ICovXG4gICAgICBhd2FpdCBpbml0RGVmaW5pdGlvbnMocHJvcHMpO1xuICAgICAgLy9jb25zb2xlLmxvZyhcImluaXREZWZpbml0aW9uc1wiLCBwcm9wc1RvU3RyaW5nKHByb3BzKSk7XG4gICAgICAvLyBkZXJpdmF0aXZlIGxheWVyc1xuICAgICAgcHJvcHMuZGVyaXZhdGl2ZUxheWVycyA9IHsgaGFzQW55OiBmYWxzZSB9O1xuICAgICAgaWYgKHZpZXdJdGVtKSB7XG4gICAgICAgIGNvbnN0IHJlc3VsdHMgPSBhd2FpdCBpdGVtLmZldGNoUmVsYXRlZEl0ZW1zKHtcbiAgICAgICAgICByZWxhdGlvbnNoaXBUeXBlOiBcIlNlcnZpY2UyU2VydmljZVwiLFxuICAgICAgICAgIGRpcmVjdGlvbjogXCJmb3J3YXJkXCJcbiAgICAgICAgfSk7XG4gICAgICAgIGlmIChyZXN1bHRzLmxlbmd0aCkge1xuICAgICAgICAgIHByb3BzLmRlcml2YXRpdmVMYXllcnMgPSB7XG4gICAgICAgICAgICBoYXNNUzogcmVzdWx0cy5maW5kKChpdGVtKSA9PiBpdGVtLnR5cGUgPT09IFwiTWFwIFNlcnZpY2VcIiksXG4gICAgICAgICAgICBoYXNWVEw6IHJlc3VsdHMuZmluZCgoaXRlbSkgPT4gaXRlbS50eXBlID09PSBcIlZlY3RvciBUaWxlIFNlcnZpY2VcIiksXG4gICAgICAgICAgICBoYXNXRlM6IHJlc3VsdHMuZmluZCgoaXRlbSkgPT4gaXRlbS50eXBlID09PSBcIldGU1wiKSxcbiAgICAgICAgICAgIGhhc1NjZW5lOiByZXN1bHRzLmZpbmQoKGl0ZW0pID0+IGl0ZW0udHlwZSA9PT0gXCJTY2VuZSBTZXJ2aWNlXCIpLFxuICAgICAgICAgICAgaGFzT0dDRkw6IHJlc3VsdHMuZmluZCgoaXRlbSkgPT4gaXRlbS50eXBlID09PSBcIk9HQ0ZlYXR1cmVTZXJ2ZXJcIilcbiAgICAgICAgICB9O1xuICAgICAgICAgIGlmIChwcm9wcy5kZXJpdmF0aXZlTGF5ZXJzLmhhc01TIHx8XG4gICAgICAgICAgICBwcm9wcy5kZXJpdmF0aXZlTGF5ZXJzLmhhc1ZUTCB8fFxuICAgICAgICAgICAgcHJvcHMuZGVyaXZhdGl2ZUxheWVycy5oYXNXRlMgfHxcbiAgICAgICAgICAgIHByb3BzLmRlcml2YXRpdmVMYXllcnMuaGFzU2NlbmUgfHxcbiAgICAgICAgICAgIHByb3BzLmRlcml2YXRpdmVMYXllcnMuaGFzT0dDRkwpIHtcbiAgICAgICAgICAgIHByb3BzLmRlcml2YXRpdmVMYXllcnMuaGFzQW55ID0gdHJ1ZTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIC8vIHN5bmMgYW5kIHJlcGxpY2FzXG4gICAgICBpZiAodmlld0l0ZW0gJiYgcHJvcHMuYWRtaW5TZXJ2aWNlSW5mby5jYXBhYmlsaXRpZXMuaW5kZXhPZihcIlN5bmNcIikgPiAtMSkge1xuICAgICAgICAvLyBjaGVjayBmb3IgcmVwbGljYXNcbiAgICAgICAgY29uc3QgcmVwbGljYVVybCA9IGAke3ZpZXdJdGVtLnVybH0vcmVwbGljYXNgO1xuICAgICAgICBhd2FpdCBlc3JpUmVxdWVzdChyZXBsaWNhVXJsLCB7XG4gICAgICAgICAgcXVlcnk6IHsgZjogXCJqc29uXCIgfVxuICAgICAgICB9KS50aGVuKChyZXBsaWNhUmVzdWx0KSA9PiB7XG4gICAgICAgICAgdmFyIF9hO1xuICAgICAgICAgIHByb3BzLmhhc1JlcGxpY2FzID0gKChfYSA9IHJlcGxpY2FSZXN1bHQuZGF0YSkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmxlbmd0aCkgPiAwO1xuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICAgIHRoaXMuc3RhdHVzID0gZmxvd1N0YXR1cy5TRUxFQ1RJT047XG4gICAgICB0aGlzLnJlUmVuZGVyID0gIXRoaXMucmVSZW5kZXI7XG4gICAgICB0aGlzLmFyY2dpc0xheWVyVmlld1N0ZXBDaGFuZ2UuZW1pdCgxKTtcbiAgICB9XG4gICAgY2F0Y2ggKGUpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoZSk7XG4gICAgICB0aGlzLnN0YXR1cyA9IGZsb3dTdGF0dXMuRVJST1I7XG4gICAgICB0aGlzLnJlUmVuZGVyID0gIXRoaXMucmVSZW5kZXI7XG4gICAgfVxuICB9XG4gIGRpc2Nvbm5lY3RlZENhbGxiYWNrKCkge1xuICAgIGNvbnN0IHsgcHJvcHMgfSA9IHRoaXM7XG4gICAgY29uc3QgeyB2aWV3LCBsYXllciB9ID0gcHJvcHM7XG4gICAgdmlldy5tYXAucmVtb3ZlKGxheWVyKTtcbiAgfVxuICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAvL1xuICAvLyAgUmVuZGVyIE1ldGhvZHNcbiAgLy9cbiAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICByZW5kZXIoKSB7XG4gICAgLy9jb25zb2xlLmxvZyhcInJlbmRlclwiLCBwcm9wc1RvU3RyaW5nKHRoaXMucHJvcHMpLCBcInN0YXR1czpcIiwgdGhpcy5zdGF0dXMpO1xuICAgIGNvbnN0IHsgc3RhdHVzIH0gPSB0aGlzO1xuICAgIHJldHVybiAoaChIb3N0LCBudWxsLCBzdGF0dXMgPT09IGZsb3dTdGF0dXMuRVJST1IgPyB0aGlzLnJlbmRlckVycm9yKCkgOiBudWxsLCBzdGF0dXMgPT09IGZsb3dTdGF0dXMuTE9BRElORyA/IHRoaXMucmVuZGVyTG9hZGluZygpIDogbnVsbCwgW2Zsb3dTdGF0dXMuU0VMRUNUSU9OLCBmbG93U3RhdHVzLlNXQVBfU09VUkNFLCBmbG93U3RhdHVzLkJST1dTRV9MQVlFUl0uaW5jbHVkZXMoc3RhdHVzKVxuICAgICAgPyB0aGlzLnJlbmRlckxheWVyU2VsZWN0aW9uKClcbiAgICAgIDogbnVsbCwgW2Zsb3dTdGF0dXMuT1ZFUlZJRVcsIGZsb3dTdGF0dXMuREVGSU5JVElPTiwgZmxvd1N0YXR1cy5GSUxURVJdLmluY2x1ZGVzKHN0YXR1cylcbiAgICAgID8gdGhpcy5yZW5kZXJMYXllck92ZXJ2aWV3KClcbiAgICAgIDogbnVsbCwgc3RhdHVzID09PSBmbG93U3RhdHVzLkNSRUFURSA/IHRoaXMucmVuZGVyQ3JlYXRlVmlldygpIDogbnVsbCkpO1xuICB9XG4gIHJlbmRlckVycm9yKCkge1xuICAgIGNvbnN0IHsgcHJvcHMgfSA9IHRoaXM7XG4gICAgY29uc3QgeyB2aWV3SXRlbSwgbGF5ZXJJdGVtLCBzdHJpbmdzIH0gPSBwcm9wcztcbiAgICByZXR1cm4gKGgoXCJjYWxjaXRlLWZsb3ctaXRlbVwiLCB7IGxvYWRpbmc6IGZhbHNlLCBoZWFkaW5nOiAodmlld0l0ZW0gPT09IG51bGwgfHwgdmlld0l0ZW0gPT09IHZvaWQgMCA/IHZvaWQgMCA6IHZpZXdJdGVtLnRpdGxlKSB8fCAobGF5ZXJJdGVtID09PSBudWxsIHx8IGxheWVySXRlbSA9PT0gdm9pZCAwID8gdm9pZCAwIDogbGF5ZXJJdGVtLnRpdGxlKSB8fCBzdHJpbmdzLm1zZy5lcnJvciwgZGVzY3JpcHRpb246ICh2aWV3SXRlbSA9PT0gbnVsbCB8fCB2aWV3SXRlbSA9PT0gdm9pZCAwID8gdm9pZCAwIDogdmlld0l0ZW0udGl0bGUpIHx8IChsYXllckl0ZW0gPT09IG51bGwgfHwgbGF5ZXJJdGVtID09PSB2b2lkIDAgPyB2b2lkIDAgOiBsYXllckl0ZW0udGl0bGUpID8gc3RyaW5ncy5nZW5lcmFsLnNvdXJjZUxheWVyIDogdW5kZWZpbmVkLCBjbGFzczogQ1NTJDkucGFuZWwsIHJlZjogKG5vZGUpID0+ICh0aGlzLnBhbmVsTm9kZSA9IG5vZGUpIH0sIGgoXCJkaXZcIiwgeyBjbGFzczogQ1NTJDkuZXJyb3JDb250ZW50IH0sIGgoXCJjYWxjaXRlLW5vdGljZVwiLCB7IHNjYWxlOiBcInNcIiwgd2lkdGg6IFwiZnVsbFwiLCBvcGVuOiB0cnVlLCBpY29uOiBcImV4Y2xhbWF0aW9uLW1hcmstdHJpYW5nbGVcIiwga2luZDogXCJkYW5nZXJcIiB9LCBoKFwiZGl2XCIsIHsgc2xvdDogXCJ0aXRsZVwiIH0sIHN0cmluZ3MubXNnLmVycm9yKSwgaChcImRpdlwiLCB7IHNsb3Q6IFwibWVzc2FnZVwiIH0sIHN0cmluZ3MubXNnLmluaXRGYWlsZWQpKSksIGgoXCJkaXZcIiwgeyBzbG90OiBcImZvb3RlclwiLCBjbGFzczogQ1NTJDkuZm9vdGVyIH0sIGgoXCJjYWxjaXRlLWJ1dHRvblwiLCB7IHNsb3Q6IFwiZm9vdGVyXCIsIG9uQ2xpY2s6IHRoaXMuZ29DYW5jZWwsIGFwcGVhcmFuY2U6IFwidHJhbnNwYXJlbnRcIiwgd2lkdGg6IFwiZnVsbFwiIH0sIHN0cmluZ3MuZ2VuZXJhbC5jYW5jZWwpKSkpO1xuICB9XG4gIHJlbmRlckxvYWRpbmcoKSB7XG4gICAgY29uc3QgeyBwcm9wcyB9ID0gdGhpcztcbiAgICBjb25zdCB7IHZpZXdJdGVtLCBsYXllckl0ZW0sIHN0cmluZ3MgfSA9IHByb3BzO1xuICAgIHJldHVybiAoaChcImNhbGNpdGUtZmxvdy1pdGVtXCIsIHsgbG9hZGluZzogdHJ1ZSwgaGVhZGluZzogKHZpZXdJdGVtID09PSBudWxsIHx8IHZpZXdJdGVtID09PSB2b2lkIDAgPyB2b2lkIDAgOiB2aWV3SXRlbS50aXRsZSkgfHwgKGxheWVySXRlbSA9PT0gbnVsbCB8fCBsYXllckl0ZW0gPT09IHZvaWQgMCA/IHZvaWQgMCA6IGxheWVySXRlbS50aXRsZSksIGRlc2NyaXB0aW9uOiBzdHJpbmdzLmdlbmVyYWwuc291cmNlTGF5ZXIsIGNsYXNzOiBDU1MkOS5wYW5lbCwgcmVmOiAobm9kZSkgPT4gKHRoaXMucGFuZWxOb2RlID0gbm9kZSkgfSkpO1xuICB9XG4gIHJlbmRlckxheWVyU2VsZWN0aW9uKCkge1xuICAgIGNvbnN0IHsgcHJvcHMsIHN0YXR1cyB9ID0gdGhpcztcbiAgICByZXR1cm4gKGgoXCJhcmNnaXMtbGF5ZXItdmlldy1zZWxlY3Rpb25cIiwgeyBrZXk6IGBzZWxlY3Rpb24tJHtzdGF0dXN9YCwgcHJvcHM6IHByb3BzLCBzdGF0dXM6IHN0YXR1cyB9KSk7XG4gIH1cbiAgcmVuZGVyTGF5ZXJPdmVydmlldygpIHtcbiAgICBjb25zdCB7IHByb3BzLCBzdGF0dXMgfSA9IHRoaXM7XG4gICAgY29uc3QgeyBkZWZpbml0aW9uTGF5ZXJJZCB9ID0gcHJvcHM7XG4gICAgcmV0dXJuIChoKFwiYXJjZ2lzLWxheWVyLXZpZXctb3ZlcnZpZXdcIiwgeyBrZXk6IGBvdmVydmlldy0ke3N0YXR1c30tJHtkZWZpbml0aW9uTGF5ZXJJZH1gLCBwcm9wczogcHJvcHMsIHN0YXR1czogc3RhdHVzIH0pKTtcbiAgfVxuICByZW5kZXJDcmVhdGVWaWV3KCkge1xuICAgIGNvbnN0IHsgcHJvcHMsIHN0YXR1cyB9ID0gdGhpcztcbiAgICByZXR1cm4gKGgoXCJhcmNnaXMtbGF5ZXItdmlldy1jcmVhdGVcIiwgeyBrZXk6IGBjcmVhdGUtJHtzdGF0dXN9YCwgcHJvcHM6IHByb3BzIH0pKTtcbiAgfVxuICBnZXQgaG9zdEVsZW1lbnQoKSB7IHJldHVybiBnZXRFbGVtZW50KHRoaXMpOyB9XG59O1xuQXJjZ2lzTGF5ZXJWaWV3JDEuc3R5bGUgPSBhcmNnaXNMYXllclZpZXdDc3M7XG5cbmNvbnN0IGFyY2dpc0xheWVyVmlld0Jyb3dzZUxheWVyQ3NzID0gXCIucGFuZWwuc2MtYXJjZ2lzLWxheWVyLXZpZXctYnJvd3NlLWxheWVye2hlaWdodDoxMDAlfVwiO1xuXG5jb25zdCBBcmNnaXNMYXllclZpZXdCcm93c2VMYXllciA9IGNsYXNzIHtcbiAgY29uc3RydWN0b3IoaG9zdFJlZikge1xuICAgIHJlZ2lzdGVySW5zdGFuY2UodGhpcywgaG9zdFJlZik7XG4gICAgdGhpcy5hcmNnaXNMYXllclZpZXdTdGF0dXNDaGFuZ2UgPSBjcmVhdGVFdmVudCh0aGlzLCBcImFyY2dpc0xheWVyVmlld1N0YXR1c0NoYW5nZVwiLCA3KTtcbiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAgIC8vXG4gICAgLy8gIFByaXZhdGUgbWV0aG9kc1xuICAgIC8vXG4gICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICB0aGlzLm9uQmFjayA9ICgpID0+IHtcbiAgICAgIHRoaXMuYXJjZ2lzTGF5ZXJWaWV3U3RhdHVzQ2hhbmdlLmVtaXQoeyBzdGF0dXM6IGZsb3dTdGF0dXMuU1dBUF9TT1VSQ0UgfSk7XG4gICAgfTtcbiAgICB0aGlzLmdvU3dhcExheWVyID0gYXN5bmMgKGl0ZW1JZCkgPT4ge1xuICAgICAgY29uc3QgeyBwcm9wcywgZmxvd0l0ZW1Ob2RlLCBob3N0RWxlbWVudCB9ID0gdGhpcztcbiAgICAgIGNvbnN0IHsgc3RyaW5ncyB9ID0gcHJvcHM7XG4gICAgICBjb25zdCBzd2FwSXRlbSA9IHRoaXMuaXRlbXMuZmluZCgoaXRlbSkgPT4gaXRlbS5pZCA9PT0gaXRlbUlkKTtcbiAgICAgIHRoaXMubG9hZGluZyA9IHRydWU7XG4gICAgICBjb25zdCBjYW5Td2FwTGF5ZXJFcnJvclN0cmluZyA9IGF3YWl0IGNhblN3YXAoc3dhcEl0ZW0sIHRoaXMucHJvcHMpO1xuICAgICAgaWYgKGNhblN3YXBMYXllckVycm9yU3RyaW5nKSB7XG4gICAgICAgIHRoaXMubG9hZGluZyA9IGZhbHNlO1xuICAgICAgICB0aGlzLm1zZ05vZGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiYXJjZ2lzLWxheWVyLXZpZXctbXNnXCIpO1xuICAgICAgICB0aGlzLm1zZ05vZGUucHJvcHMgPSBwcm9wcztcbiAgICAgICAgdGhpcy5tc2dOb2RlLmZsb3dJdGVtRWxlbWVudCA9IGZsb3dJdGVtTm9kZTtcbiAgICAgICAgdGhpcy5tc2dOb2RlLmlzRXJyb3IgPSB0cnVlO1xuICAgICAgICB0aGlzLm1zZ05vZGUubWVzc2FnZSA9IGAke3N0cmluZ3MubXNnLmNhbm5vdFN3YXB9ICR7Y2FuU3dhcExheWVyRXJyb3JTdHJpbmd9YDtcbiAgICAgICAgaG9zdEVsZW1lbnQuYXBwZW5kQ2hpbGQodGhpcy5tc2dOb2RlKTtcbiAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMudGltZW91dEhuZGwpO1xuICAgICAgICB0aGlzLnRpbWVvdXRIbmRsID0gc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgdGhpcy50aW1lb3V0SG5kbCA9IHVuZGVmaW5lZDtcbiAgICAgICAgICBpZiAodGhpcy5tc2dOb2RlKSB7XG4gICAgICAgICAgICBob3N0RWxlbWVudC5yZW1vdmVDaGlsZCh0aGlzLm1zZ05vZGUpO1xuICAgICAgICAgICAgdGhpcy5tc2dOb2RlID0gdW5kZWZpbmVkO1xuICAgICAgICAgIH1cbiAgICAgICAgfSwgNzAwMCk7XG4gICAgICB9XG4gICAgICBlbHNlIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBhd2FpdCBzd2FwU291cmNlKHRoaXMucHJvcHMpO1xuICAgICAgICAgIHRoaXMubG9hZGluZyA9IGZhbHNlO1xuICAgICAgICAgIHRoaXMubXNnTm9kZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJhcmNnaXMtbGF5ZXItdmlldy1tc2dcIik7XG4gICAgICAgICAgdGhpcy5tc2dOb2RlLnByb3BzID0gcHJvcHM7XG4gICAgICAgICAgdGhpcy5tc2dOb2RlLmZsb3dJdGVtRWxlbWVudCA9IGZsb3dJdGVtTm9kZTtcbiAgICAgICAgICB0aGlzLm1zZ05vZGUubWVzc2FnZSA9IHN0cmluZ3MubXNnLnN1Y2Nlc3NTd2FwLnJlcGxhY2UoXCIke3NvdXJjZX1cIiwgc3dhcEl0ZW0udGl0bGUpO1xuICAgICAgICAgIHRoaXMubXNnTm9kZS5jbG9zZVdpdGhPSyA9IHRydWU7XG4gICAgICAgICAgdGhpcy5tc2dOb2RlLmFkZEV2ZW50TGlzdGVuZXIoXCJhcmNnaXNMYXllclZpZXdNc2dDbG9zZWRcIiwgKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5tc2dOb2RlID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgdGhpcy5hcmNnaXNMYXllclZpZXdTdGF0dXNDaGFuZ2UuZW1pdCh7IHN0YXR1czogZmxvd1N0YXR1cy5TRUxFQ1RJT04gfSk7XG4gICAgICAgICAgfSk7XG4gICAgICAgICAgaG9zdEVsZW1lbnQuYXBwZW5kQ2hpbGQodGhpcy5tc2dOb2RlKTtcbiAgICAgICAgfVxuICAgICAgICBjYXRjaCAoZSkge1xuICAgICAgICAgIHRoaXMubG9hZGluZyA9IGZhbHNlO1xuICAgICAgICAgIHRoaXMubXNnTm9kZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJhcmNnaXMtbGF5ZXItdmlldy1tc2dcIik7XG4gICAgICAgICAgdGhpcy5tc2dOb2RlLnByb3BzID0gcHJvcHM7XG4gICAgICAgICAgdGhpcy5tc2dOb2RlLmZsb3dJdGVtRWxlbWVudCA9IGZsb3dJdGVtTm9kZTtcbiAgICAgICAgICB0aGlzLm1zZ05vZGUuaXNFcnJvciA9IHRydWU7XG4gICAgICAgICAgdGhpcy5tc2dOb2RlLm1lc3NhZ2UgPSBzdHJpbmdzLm1zZy5zd2FwRmFpbGVkO1xuICAgICAgICAgIGhvc3RFbGVtZW50LmFwcGVuZENoaWxkKHRoaXMubXNnTm9kZSk7XG4gICAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMudGltZW91dEhuZGwpO1xuICAgICAgICAgIHRoaXMudGltZW91dEhuZGwgPSBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgIHRoaXMudGltZW91dEhuZGwgPSB1bmRlZmluZWQ7XG4gICAgICAgICAgICBpZiAodGhpcy5tc2dOb2RlKSB7XG4gICAgICAgICAgICAgIGhvc3RFbGVtZW50LnJlbW92ZUNoaWxkKHRoaXMubXNnTm9kZSk7XG4gICAgICAgICAgICAgIHRoaXMubXNnTm9kZSA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9LCA3MDAwKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH07XG4gICAgdGhpcy5wcm9wcyA9IHVuZGVmaW5lZDtcbiAgICB0aGlzLnJlUmVuZGVyID0gZmFsc2U7XG4gICAgdGhpcy5sb2FkaW5nID0gZmFsc2U7XG4gICAgdGhpcy5pdGVtcyA9IHVuZGVmaW5lZDtcbiAgICB0aGlzLnBhZ2luYXRpb24gPSB1bmRlZmluZWQ7XG4gICAgdGhpcy5lcnJvciA9IHVuZGVmaW5lZDtcbiAgfVxuICBhcmNnaXNMYXllclZpZXdNc2dDbG9zZWRIYW5kbGVyKCkge1xuICAgIGlmICh0aGlzLm1zZ05vZGUpIHtcbiAgICAgIHRoaXMuaG9zdEVsZW1lbnQucmVtb3ZlQ2hpbGQodGhpcy5tc2dOb2RlKTtcbiAgICAgIHRoaXMubXNnTm9kZSA9IHVuZGVmaW5lZDtcbiAgICB9XG4gICAgY2xlYXJUaW1lb3V0KHRoaXMudGltZW91dEhuZGwpO1xuICAgIHRoaXMudGltZW91dEhuZGwgPSB1bmRlZmluZWQ7XG4gIH1cbiAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAvL1xuICAvLyAgTGlmZWN5Y2xlXG4gIC8vXG4gIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgYXN5bmMgY29tcG9uZW50RGlkTG9hZCgpIHtcbiAgICBzZXRUaW1lb3V0KCgpID0+IHJlcXVlc3RBbmltYXRpb25GcmFtZSgoKSA9PiB7IHZhciBfYTsgcmV0dXJuIChfYSA9IHRoaXMuZmxvd0l0ZW1Ob2RlKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2Euc2V0Rm9jdXMoKTsgfSksIDIwMCk7XG4gIH1cbiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgLy9cbiAgLy8gIFJlbmRlciBNZXRob2RzXG4gIC8vXG4gIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgcmVuZGVyKCkge1xuICAgIGNvbnN0IHsgcHJvcHMsIGxvYWRpbmcsIGhvc3RFbGVtZW50IH0gPSB0aGlzO1xuICAgIGNvbnN0IHsgc3RyaW5ncyB9ID0gcHJvcHM7XG4gICAgY29uc3QgcnRsID0gZ2V0RWxlbWVudERpcihob3N0RWxlbWVudCkgPT09IFwicnRsXCI7XG4gICAgcmV0dXJuIChoKEhvc3QsIHsgY2xhc3M6IFwiY2FsY2l0ZS1tYXRjaC1oZWlnaHRcIiB9LCBoKFwiY2FsY2l0ZS1mbG93LWl0ZW1cIiwgeyBoZWFkaW5nOiBzdHJpbmdzLnN3YXBTb3VyY2UuYnJvd3NlRm9yTGF5ZXJUaXRsZSwgZGVzY3JpcHRpb246IHN0cmluZ3Muc3dhcFNvdXJjZS5zdWJUaXRsZSwgbG9hZGluZzogbG9hZGluZywgY2xhc3M6IHtcbiAgICAgICAgcGFuZWw6IHRydWUsXG4gICAgICAgIFtDU1NfVVRJTElUWS5ydGxdOiBydGxcbiAgICAgIH0sIG9uQ2FsY2l0ZUZsb3dJdGVtQmFjazogdGhpcy5vbkJhY2ssIHJlZjogKG5vZGUpID0+ICh0aGlzLmZsb3dJdGVtTm9kZSA9IG5vZGUpIH0sIHRoaXMucmVuZGVySXRlbUJyb3dzZXIoKSkpKTtcbiAgfVxuICByZW5kZXJJdGVtQnJvd3NlcigpIHtcbiAgICBjb25zdCB7IHByb3BzLCBwYWdpbmF0aW9uIH0gPSB0aGlzO1xuICAgIGNvbnN0IHsgbGF5ZXIsIHNvdXJjZUl0ZW1JZCwgc3RyaW5ncyB9ID0gcHJvcHM7XG4gICAgY29uc3QgeyBwb3J0YWxJdGVtIH0gPSBsYXllcjtcbiAgICBjb25zdCB7IHBvcnRhbCB9ID0gcG9ydGFsSXRlbTtcbiAgICBjb25zdCB1c2VyID0gcG9ydGFsLnVzZXI7XG4gICAgY29uc3QgcXVlcnkgPSBgdHlwZTpcIkZlYXR1cmUgU2VydmljZVwiIHR5cGVrZXl3b3JkczpcIkhvc3RlZCBTZXJ2aWNlXCIgLXR5cGVrZXl3b3JkczpcIlZpZXcgU2VydmljZVwiIG93bmVyOlwiJHt1c2VyLnVzZXJuYW1lfVwiIC1pZDoke3NvdXJjZUl0ZW1JZH1gO1xuICAgIGNvbnN0IGJhc2VVcmwgPSBgJHtnZXRQb3J0YWxCYXNlVXJsKHBvcnRhbCl9L2hvbWUvYDtcbiAgICByZXR1cm4gKGgoXCJhcmNnaXMtaXRlbS1icm93c2VyXCIsIHsgb25BcmNnaXNJdGVtQnJvd3NlclVwZGF0ZTogKGUpID0+IHtcbiAgICAgICAgY29uc3QgeyByZXN1bHRzLCBudW0sIHN0YXJ0LCB0b3RhbCB9ID0gZS5kZXRhaWw7XG4gICAgICAgIHRoaXMuaXRlbXMgPSByZXN1bHRzO1xuICAgICAgICB0aGlzLnBhZ2luYXRpb24gPSB7IHN0YXJ0LCBudW0sIHRvdGFsIH07XG4gICAgICB9LCBmaWx0ZXI6IHF1ZXJ5LCBwb3J0YWw6IHBvcnRhbCwgdXNlcjogdXNlciwgYXBpOiA0LCBjb25maWc6IHsgYmFzZVVybCB9LCBzZWxlY3Rpb246IFwibm9uZVwiIH0sIGgoXCJhcmNnaXMtaXRlbS1icm93c2VyLXRvcC1iYXJcIiwgeyBzbG90OiBcInRvcC1iYXJcIiB9LCBoKFwiYXJjZ2lzLWl0ZW0tYnJvd3Nlci1zZWFyY2hcIiwgeyBzbG90OiBcInNlYXJjaFwiLCB0ZXJtOiBcIlwiIH0pKSwgaChcImFyY2dpcy1pdGVtLWJyb3dzZXItc29ydFwiLCB7IG9wdGlvbnM6IFtcIm1vZGlmaWVkXCIsIFwidGl0bGVcIiwgXCJyZWxldmFuY2VcIl0sIHNsb3Q6IFwic29ydFwiIH0pLCBoKFwiYXJjZ2lzLWl0ZW0tYnJvd3Nlci1jb250ZW50XCIsIHsgc2xvdDogXCJjb250ZW50XCIgfSwgKHRoaXMuaXRlbXMgfHwgW10pLm1hcCgoaXRlbSkgPT4gKGgoXCJhcmNnaXMtaXRlbS1icm93c2VyLWNhcmRcIiwgeyBpdGVtOiBpdGVtLCBwb3J0YWw6IHBvcnRhbCwgYmFzZVVybDogYmFzZVVybCwga2V5OiBpdGVtLmlkIH0sIGgoXCJjYWxjaXRlLWFjdGlvblwiLCB7IGlkOiBgc3dhcC1hY3Rpb24tJHtpdGVtLmlkfWAsIGljb246IFwiYXJyb3ctcmlnaHQtbGVmdFwiLCB0ZXh0OiBcIlwiLCBzY2FsZTogXCJzXCIsIHNsb3Q6IFwiYWN0aW9ucy1lbmRcIiwgb25DbGljazogdGhpcy5nb1N3YXBMYXllci5iaW5kKHRoaXMsIGl0ZW0uaWQpIH0sIGgoXCJjYWxjaXRlLXRvb2x0aXBcIiwgeyBzbG90OiBcInRvb2x0aXBcIiwgbGFiZWw6IHN0cmluZ3MuZ2VuZXJhbC5zd2FwU291cmNlLCBvdmVybGF5UG9zaXRpb25pbmc6IFwiZml4ZWRcIiB9LCBzdHJpbmdzLmdlbmVyYWwuc3dhcFNvdXJjZSkpKSkpKSwgaChcImFyY2dpcy1pdGVtLWJyb3dzZXItcGFnaW5hdGlvblwiLCB7IHRvdGFsOiBwYWdpbmF0aW9uID09PSBudWxsIHx8IHBhZ2luYXRpb24gPT09IHZvaWQgMCA/IHZvaWQgMCA6IHBhZ2luYXRpb24udG90YWwsIHN0YXJ0OiBwYWdpbmF0aW9uID09PSBudWxsIHx8IHBhZ2luYXRpb24gPT09IHZvaWQgMCA/IHZvaWQgMCA6IHBhZ2luYXRpb24uc3RhcnQsIG51bTogcGFnaW5hdGlvbiA9PT0gbnVsbCB8fCBwYWdpbmF0aW9uID09PSB2b2lkIDAgPyB2b2lkIDAgOiBwYWdpbmF0aW9uLm51bSwgc2xvdDogXCJwYWdpbmF0aW9uXCIgfSkpKTtcbiAgfVxuICBnZXQgaG9zdEVsZW1lbnQoKSB7IHJldHVybiBnZXRFbGVtZW50KHRoaXMpOyB9XG59O1xuQXJjZ2lzTGF5ZXJWaWV3QnJvd3NlTGF5ZXIuc3R5bGUgPSBhcmNnaXNMYXllclZpZXdCcm93c2VMYXllckNzcztcblxuY29uc3QgQ1NTJDggPSB7XG4gIHBhbmVsOiBcInBhbmVsXCIsXG4gIGluZm86IFwiaW5mb1wiLFxuICBmb290ZXI6IFwiZm9vdGVyXCJcbn07XG5cbmNvbnN0IGFyY2dpc0xheWVyVmlld0NyZWF0ZUNzcyA9IFwiLnBhbmVsLnNjLWFyY2dpcy1sYXllci12aWV3LWNyZWF0ZXtoZWlnaHQ6MTAwJX0uaW5mby5zYy1hcmNnaXMtbGF5ZXItdmlldy1jcmVhdGV7ZGlzcGxheTpncmlkO2dyaWQtdGVtcGxhdGUtY29sdW1uczpyZXBlYXQoMSwgbWlubWF4KDBweCwgMWZyKSk7Z2FwOjAuNXJlbTtwYWRkaW5nOjFyZW0gMC43NXJlbX0uZm9vdGVyLnNjLWFyY2dpcy1sYXllci12aWV3LWNyZWF0ZXt3aWR0aDoxMDAlfVwiO1xuXG5jb25zdCBBcmNnaXNMYXllclZpZXdDcmVhdGUkMSA9IGNsYXNzIHtcbiAgY29uc3RydWN0b3IoaG9zdFJlZikge1xuICAgIHJlZ2lzdGVySW5zdGFuY2UodGhpcywgaG9zdFJlZik7XG4gICAgdGhpcy5hcmNnaXNMYXllclZpZXdTdGF0dXNDaGFuZ2UgPSBjcmVhdGVFdmVudCh0aGlzLCBcImFyY2dpc0xheWVyVmlld1N0YXR1c0NoYW5nZVwiLCA3KTtcbiAgICB0aGlzLmFyY2dpc0xheWVyVmlld0NyZWF0ZURvbmUgPSBjcmVhdGVFdmVudCh0aGlzLCBcImFyY2dpc0xheWVyVmlld0NyZWF0ZURvbmVcIiwgNyk7XG4gICAgdGhpcy5hcmNnaXNMYXllclZpZXdDcmVhdGVDYW5jZWwgPSBjcmVhdGVFdmVudCh0aGlzLCBcImFyY2dpc0xheWVyVmlld0NyZWF0ZUNhbmNlbFwiLCA3KTtcbiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAgIC8vXG4gICAgLy8gIFByaXZhdGUgbWV0aG9kc1xuICAgIC8vXG4gICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICB0aGlzLmdvQmFjayA9ICgpID0+IHtcbiAgICAgIC8vIHNhdmUgbGFzdCBzZXR0aW5nc1xuICAgICAgY29uc3QgeyBwcm9wcyB9ID0gdGhpcztcbiAgICAgIHByb3BzLnNhdmVkSXRlbVByb3BzID0ge1xuICAgICAgICB0aXRsZTogaXRlbVByb3BlcnRpZXNTdGF0ZS50aXRsZSxcbiAgICAgICAgdGFnczogaXRlbVByb3BlcnRpZXNTdGF0ZS50YWdzLFxuICAgICAgICBzdW1tYXJ5OiBpdGVtUHJvcGVydGllc1N0YXRlLnNuaXBwZXQsXG4gICAgICAgIGNhdGVnb3JpZXM6IGl0ZW1Qcm9wZXJ0aWVzU3RhdGUuY2F0ZWdvcmllcyxcbiAgICAgICAgZm9sZGVyOiBpdGVtUHJvcGVydGllc1N0YXRlLmZvbGRlclxuICAgICAgfTtcbiAgICAgIHRoaXMuYXJjZ2lzTGF5ZXJWaWV3U3RhdHVzQ2hhbmdlLmVtaXQoeyBzdGF0dXM6IGZsb3dTdGF0dXMuT1ZFUlZJRVcgfSk7XG4gICAgfTtcbiAgICB0aGlzLmdvQ3JlYXRlID0gYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgeyBwcm9wcywgZmxvd0l0ZW1Ob2RlLCBob3N0RWxlbWVudCB9ID0gdGhpcztcbiAgICAgIGNvbnN0IHsgc3RyaW5ncyB9ID0gcHJvcHM7XG4gICAgICAvLyBpbiBjYXNlIHRoZSBjcmVhdGUgY2FsbCBmYWlsc1xuICAgICAgcHJvcHMuc2F2ZWRJdGVtUHJvcHMgPSB7XG4gICAgICAgIHRpdGxlOiBpdGVtUHJvcGVydGllc1N0YXRlLnRpdGxlLFxuICAgICAgICB0YWdzOiBpdGVtUHJvcGVydGllc1N0YXRlLnRhZ3MsXG4gICAgICAgIHN1bW1hcnk6IGl0ZW1Qcm9wZXJ0aWVzU3RhdGUuc25pcHBldCxcbiAgICAgICAgY2F0ZWdvcmllczogaXRlbVByb3BlcnRpZXNTdGF0ZS5jYXRlZ29yaWVzLFxuICAgICAgICBmb2xkZXI6IGl0ZW1Qcm9wZXJ0aWVzU3RhdGUuZm9sZGVyXG4gICAgICB9O1xuICAgICAgY29uc3QgbmV3SXRlbVByb3BzID0ge1xuICAgICAgICB0aXRsZTogaXRlbVByb3BlcnRpZXNTdGF0ZS50aXRsZSxcbiAgICAgICAgdGFnczogaXRlbVByb3BlcnRpZXNTdGF0ZS50YWdzLFxuICAgICAgICBzdW1tYXJ5OiBpdGVtUHJvcGVydGllc1N0YXRlLnNuaXBwZXQsXG4gICAgICAgIGNhdGVnb3JpZXM6IGl0ZW1Qcm9wZXJ0aWVzU3RhdGUuY2F0ZWdvcmllcyxcbiAgICAgICAgZm9sZGVyOiBpdGVtUHJvcGVydGllc1N0YXRlLmZvbGRlclxuICAgICAgfTtcbiAgICAgIHRoaXMubG9hZGluZyA9IHRydWU7XG4gICAgICB0cnkge1xuICAgICAgICB0aGlzLnZpZXdJdGVtSWQgPSBhd2FpdCBjcmVhdGVWaWV3KHByb3BzLCBuZXdJdGVtUHJvcHMpO1xuICAgICAgICB0aGlzLmxvYWRpbmcgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5tc2dOb2RlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImFyY2dpcy1sYXllci12aWV3LW1zZ1wiKTtcbiAgICAgICAgdGhpcy5tc2dOb2RlLnByb3BzID0gcHJvcHM7XG4gICAgICAgIHRoaXMubXNnTm9kZS5mbG93SXRlbUVsZW1lbnQgPSBmbG93SXRlbU5vZGU7XG4gICAgICAgIHRoaXMubXNnTm9kZS5tZXNzYWdlID0gc3RyaW5ncy5tc2cuY3JlYXRlZDtcbiAgICAgICAgaG9zdEVsZW1lbnQuYXBwZW5kQ2hpbGQodGhpcy5tc2dOb2RlKTtcbiAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMudGltZW91dEhuZGwpO1xuICAgICAgICB0aGlzLnRpbWVvdXRIbmRsID0gc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgdGhpcy50aW1lb3V0SG5kbCA9IHVuZGVmaW5lZDtcbiAgICAgICAgICBpZiAodGhpcy5tc2dOb2RlKSB7XG4gICAgICAgICAgICBob3N0RWxlbWVudC5yZW1vdmVDaGlsZCh0aGlzLm1zZ05vZGUpO1xuICAgICAgICAgICAgdGhpcy5tc2dOb2RlID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgdGhpcy5hcmNnaXNMYXllclZpZXdDcmVhdGVEb25lLmVtaXQodGhpcy52aWV3SXRlbUlkKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0sIDcwMDApO1xuICAgICAgfVxuICAgICAgY2F0Y2ggKGUpIHtcbiAgICAgICAgY29uc3QgeyBwcm9wcywgZmxvd0l0ZW1Ob2RlIH0gPSB0aGlzO1xuICAgICAgICBjb25zdCB7IHN0cmluZ3MgfSA9IHByb3BzO1xuICAgICAgICB0aGlzLmxvYWRpbmcgPSBmYWxzZTtcbiAgICAgICAgY29uc29sZS5lcnJvcihcImNvdWxkIG5vdCBjcmVhdGUgdmlld1wiLCBlKTtcbiAgICAgICAgdGhpcy5tc2dOb2RlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImFyY2dpcy1sYXllci12aWV3LW1zZ1wiKTtcbiAgICAgICAgdGhpcy5tc2dOb2RlLnByb3BzID0gcHJvcHM7XG4gICAgICAgIHRoaXMubXNnTm9kZS5mbG93SXRlbUVsZW1lbnQgPSBmbG93SXRlbU5vZGU7XG4gICAgICAgIHRoaXMubXNnTm9kZS5pc0Vycm9yID0gdHJ1ZTtcbiAgICAgICAgaWYgKGUubWVzc2FnZSA9PT0gXCJzZXJ2aWNlIG5hbWUgYWxyZWFkeSBleGlzdHNcIikge1xuICAgICAgICAgIC8vIGdvaW5nIHRvIGhhdmUgYW5vdGhlciBzdHJpbmcuLi5cbiAgICAgICAgICB0aGlzLm1zZ05vZGUubWVzc2FnZSA9IHN0cmluZ3MubXNnLmNyZWF0ZUZhaWxlZDtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICB0aGlzLm1zZ05vZGUubWVzc2FnZSA9IHN0cmluZ3MubXNnLmNyZWF0ZUZhaWxlZDtcbiAgICAgICAgfVxuICAgICAgICBob3N0RWxlbWVudC5hcHBlbmRDaGlsZCh0aGlzLm1zZ05vZGUpO1xuICAgICAgICBjbGVhclRpbWVvdXQodGhpcy50aW1lb3V0SG5kbCk7XG4gICAgICAgIHRoaXMudGltZW91dEhuZGwgPSBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICB0aGlzLnRpbWVvdXRIbmRsID0gdW5kZWZpbmVkO1xuICAgICAgICAgIGlmICh0aGlzLm1zZ05vZGUpIHtcbiAgICAgICAgICAgIGhvc3RFbGVtZW50LnJlbW92ZUNoaWxkKHRoaXMubXNnTm9kZSk7XG4gICAgICAgICAgICB0aGlzLm1zZ05vZGUgPSB1bmRlZmluZWQ7XG4gICAgICAgICAgfVxuICAgICAgICB9LCA3MDAwKTtcbiAgICAgIH1cbiAgICB9O1xuICAgIHRoaXMuZ29DYW5jZWwgPSAoKSA9PiB7XG4gICAgICB0aGlzLmFyY2dpc0xheWVyVmlld0NyZWF0ZUNhbmNlbC5lbWl0KCk7XG4gICAgfTtcbiAgICB0aGlzLnByb3BzID0gdW5kZWZpbmVkO1xuICAgIHRoaXMucmVSZW5kZXIgPSBmYWxzZTtcbiAgICB0aGlzLmxvYWRpbmcgPSBmYWxzZTtcbiAgICB0aGlzLnRpdGxlID0gdW5kZWZpbmVkO1xuICB9XG4gIGFyY2dpc0xheWVyVmlld01zZ0Nsb3NlZEhhbmRsZXIoKSB7XG4gICAgaWYgKHRoaXMubXNnTm9kZSkge1xuICAgICAgdGhpcy5ob3N0RWxlbWVudC5yZW1vdmVDaGlsZCh0aGlzLm1zZ05vZGUpO1xuICAgICAgdGhpcy5tc2dOb2RlID0gdW5kZWZpbmVkO1xuICAgIH1cbiAgICBjbGVhclRpbWVvdXQodGhpcy50aW1lb3V0SG5kbCk7XG4gICAgdGhpcy50aW1lb3V0SG5kbCA9IHVuZGVmaW5lZDtcbiAgICBpZiAodGhpcy52aWV3SXRlbUlkKSB7XG4gICAgICB0aGlzLmFyY2dpc0xheWVyVmlld0NyZWF0ZURvbmUuZW1pdCh0aGlzLnZpZXdJdGVtSWQpO1xuICAgIH1cbiAgfVxuICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIC8vXG4gIC8vICBMaWZlY3ljbGVcbiAgLy9cbiAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICBhc3luYyBjb21wb25lbnRXaWxsTG9hZCgpIHtcbiAgICBjb25zdCB7IHByb3BzIH0gPSB0aGlzO1xuICAgIHRoaXMudGl0bGUgPSBhd2FpdCBnZXRTdWdnZXN0ZWRUaXRsZShwcm9wcyk7XG4gIH1cbiAgYXN5bmMgY29tcG9uZW50RGlkTG9hZCgpIHtcbiAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKCkgPT4geyB2YXIgX2E7IHJldHVybiAoX2EgPSB0aGlzLmJhY2tCdXR0b25Ob2RlKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2Euc2V0Rm9jdXMoKTsgfSk7XG4gIH1cbiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgLy9cbiAgLy8gIFJlbmRlciBNZXRob2RzXG4gIC8vXG4gIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgcmVuZGVyKCkge1xuICAgIC8vY29uc29sZS5sb2coXCJyZW5kZXIgdmlldy1jcmVhdGVcIiwgcHJvcHNUb1N0cmluZyh0aGlzLnByb3BzKSk7XG4gICAgY29uc3QgeyBwcm9wcywgbG9hZGluZyB9ID0gdGhpcztcbiAgICBjb25zdCB7IHZpZXdJdGVtLCBsYXllckl0ZW0sIHN0cmluZ3MgfSA9IHByb3BzO1xuICAgIGNvbnN0IHJ0bCA9IGdldEVsZW1lbnREaXIodGhpcy5ob3N0RWxlbWVudCkgPT09IFwicnRsXCI7XG4gICAgcmV0dXJuIChoKEhvc3QsIHsgY2xhc3M6IFwiY2FsY2l0ZS1tYXRjaC1oZWlnaHRcIiB9LCBoKFwiY2FsY2l0ZS1mbG93LWl0ZW1cIiwgeyBoZWFkaW5nOiBzdHJpbmdzLmNyZWF0ZVZpZXcuY3JlYXRlLCBkZXNjcmlwdGlvbjogKHZpZXdJdGVtID09PSBudWxsIHx8IHZpZXdJdGVtID09PSB2b2lkIDAgPyB2b2lkIDAgOiB2aWV3SXRlbS50aXRsZSkgfHwgKGxheWVySXRlbSA9PT0gbnVsbCB8fCBsYXllckl0ZW0gPT09IHZvaWQgMCA/IHZvaWQgMCA6IGxheWVySXRlbS50aXRsZSksIGxvYWRpbmc6IGxvYWRpbmcsIGNsYXNzOiB7XG4gICAgICAgIHBhbmVsOiB0cnVlLFxuICAgICAgICBbQ1NTX1VUSUxJVFkucnRsXTogcnRsXG4gICAgICB9LCByZWY6IChub2RlKSA9PiAodGhpcy5mbG93SXRlbU5vZGUgPSBub2RlKSB9LCB0aGlzLnJlbmRlckZvb3RlckJ1dHRvbnMoKSwgdGhpcy5yZW5kZXJJbmZvKCkpKSk7XG4gIH1cbiAgcmVuZGVyRm9vdGVyQnV0dG9ucygpIHtcbiAgICByZXR1cm4gKGgoXCJkaXZcIiwgeyBzbG90OiBcImZvb3RlclwiLCBjbGFzczogQ1NTJDguZm9vdGVyIH0sIHRoaXMucmVuZGVyQmFjaygpLCB0aGlzLnJlbmRlckNyZWF0ZSgpLCBoKFwiYnJcIiwgbnVsbCksIHRoaXMucmVuZGVyQ2FuY2VsKCkpKTtcbiAgfVxuICByZW5kZXJCYWNrKCkge1xuICAgIGNvbnN0IHsgcHJvcHMgfSA9IHRoaXM7XG4gICAgY29uc3QgeyBzdHJpbmdzIH0gPSBwcm9wcztcbiAgICBjb25zdCBpc1J0bCA9IGdldEVsZW1lbnREaXIodGhpcy5ob3N0RWxlbWVudCkgPT09IFwicnRsXCI7XG4gICAgcmV0dXJuIChoKFwiY2FsY2l0ZS1idXR0b25cIiwgeyBvbkNsaWNrOiB0aGlzLmdvQmFjaywgYXBwZWFyYW5jZTogXCJvdXRsaW5lLWZpbGxcIiwgd2lkdGg6IFwiaGFsZlwiLCBcImljb24tc3RhcnRcIjogaXNSdGwgPyBcImFycm93LXJpZ2h0XCIgOiBcImFycm93LWxlZnRcIiwgcmVmOiAobm9kZSkgPT4gKHRoaXMuYmFja0J1dHRvbk5vZGUgPSBub2RlKSB9LCBzdHJpbmdzLmdlbmVyYWwuYmFjaykpO1xuICB9XG4gIHJlbmRlckNyZWF0ZSgpIHtcbiAgICBjb25zdCB7IHByb3BzLCB0aXRsZSwgdGl0bGVFcnJvciwgc3VtbWFyeUVycm9yIH0gPSB0aGlzO1xuICAgIGNvbnN0IHsgbGF5ZXIsIGxheWVySWRzLCBzdHJpbmdzIH0gPSBwcm9wcztcbiAgICBjb25zdCBlbmFibGVkID0gKGxheWVyID09PSBudWxsIHx8IGxheWVyID09PSB2b2lkIDAgPyB2b2lkIDAgOiBsYXllci5sb2FkZWQpICYmIGxheWVySWRzLmxlbmd0aCAmJiB0aXRsZSAmJiAhdGl0bGVFcnJvciAmJiAhc3VtbWFyeUVycm9yO1xuICAgIHJldHVybiAoaChcImNhbGNpdGUtYnV0dG9uXCIsIHsgZGlzYWJsZWQ6ICFlbmFibGVkLCBvbkNsaWNrOiBlbmFibGVkICYmIHRoaXMuZ29DcmVhdGUsIGFwcGVhcmFuY2U6IFwic29saWRcIiwgd2lkdGg6IFwiaGFsZlwiLCBcImljb24tc3RhcnRcIjogXCJwbHVzLXNxdWFyZVwiLCByZWY6IChub2RlKSA9PiAodGhpcy5jcmVhdGVCdXR0b25Ob2RlID0gbm9kZSkgfSwgc3RyaW5ncy5jcmVhdGVWaWV3LmNyZWF0ZSkpO1xuICB9XG4gIHJlbmRlckNhbmNlbCgpIHtcbiAgICBjb25zdCB7IHByb3BzIH0gPSB0aGlzO1xuICAgIGNvbnN0IHsgbGF5ZXIsIGxheWVySWRzLCBzdHJpbmdzIH0gPSBwcm9wcztcbiAgICBjb25zdCBlbmFibGVkID0gKGxheWVyID09PSBudWxsIHx8IGxheWVyID09PSB2b2lkIDAgPyB2b2lkIDAgOiBsYXllci5sb2FkZWQpICYmIGxheWVySWRzLmxlbmd0aDtcbiAgICByZXR1cm4gKGgoXCJjYWxjaXRlLWJ1dHRvblwiLCB7IGRpc2FibGVkOiAhZW5hYmxlZCwgb25DbGljazogZW5hYmxlZCAmJiB0aGlzLmdvQ2FuY2VsLCBhcHBlYXJhbmNlOiBcInRyYW5zcGFyZW50XCIsIHdpZHRoOiBcImZ1bGxcIiB9LCBzdHJpbmdzLmdlbmVyYWwuY2FuY2VsKSk7XG4gIH1cbiAgcmVuZGVySW5mbygpIHtcbiAgICBjb25zdCB7IHByb3BzLCB0aXRsZSB9ID0gdGhpcztcbiAgICBjb25zdCB7IGxheWVyLCBsYXllckl0ZW1Pd25lciwgc2F2ZWRJdGVtUHJvcHMgfSA9IHByb3BzO1xuICAgIGNvbnN0IHsgcG9ydGFsSXRlbSB9ID0gbGF5ZXI7XG4gICAgY29uc3QgeyBwb3J0YWwgfSA9IHBvcnRhbEl0ZW07XG4gICAgY29uc3QgdXNlciA9IHBvcnRhbC51c2VyO1xuICAgIGNvbnN0IGNvbmZpZyA9IHsgcG9ydGFsLCB1c2VyLCBhcGk6IDQgfTtcbiAgICBpZiAoc2F2ZWRJdGVtUHJvcHMpIHtcbiAgICAgIGl0ZW1Qcm9wZXJ0aWVzU3RhdGUudGl0bGUgPSBzYXZlZEl0ZW1Qcm9wcy50aXRsZTtcbiAgICAgIGl0ZW1Qcm9wZXJ0aWVzU3RhdGUuZm9sZGVyID0gc2F2ZWRJdGVtUHJvcHMuZm9sZGVyO1xuICAgICAgaXRlbVByb3BlcnRpZXNTdGF0ZS5zbmlwcGV0ID0gc2F2ZWRJdGVtUHJvcHMuc3VtbWFyeSB8fCBcIlwiO1xuICAgICAgaXRlbVByb3BlcnRpZXNTdGF0ZS5jYXRlZ29yaWVzID0gc2F2ZWRJdGVtUHJvcHMuY2F0ZWdvcmllcztcbiAgICAgIGl0ZW1Qcm9wZXJ0aWVzU3RhdGUudGFncyA9IHNhdmVkSXRlbVByb3BzLnRhZ3M7XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgaXRlbVByb3BlcnRpZXNTdGF0ZS50aXRsZSA9IHRpdGxlO1xuICAgICAgaXRlbVByb3BlcnRpZXNTdGF0ZS5mb2xkZXIgPVxuICAgICAgICBwb3J0YWxJdGVtLm93bmVyRm9sZGVyICYmXG4gICAgICAgICAge1xuICAgICAgICAgICAgaWQ6IHBvcnRhbEl0ZW0ub3duZXJGb2xkZXIsXG4gICAgICAgICAgICB1c2VybmFtZTogcG9ydGFsSXRlbS5vd25lclxuICAgICAgICAgIH07XG4gICAgICBpdGVtUHJvcGVydGllc1N0YXRlLnNuaXBwZXQgPSBwb3J0YWxJdGVtLnNuaXBwZXQgfHwgXCJcIjtcbiAgICAgIGl0ZW1Qcm9wZXJ0aWVzU3RhdGUuY2F0ZWdvcmllcyA9IHBvcnRhbEl0ZW0uY2F0ZWdvcmllcztcbiAgICAgIGl0ZW1Qcm9wZXJ0aWVzU3RhdGUudGFncyA9IHBvcnRhbEl0ZW0udGFncztcbiAgICB9XG4gICAgcmV0dXJuIChoKFwiZGl2XCIsIHsgY2xhc3M6IENTUyQ4LmluZm8gfSwgaChcImFyY2dpcy1pdGVtLXByb3BlcnRpZXNcIiwgeyBwb3J0YWw6IHBvcnRhbCwgdXNlcjogdXNlciwgYXBpOiA0LCBjb25maWc6IGNvbmZpZywgdHlwZTogXCJGZWF0dXJlIFNlcnZpY2VcIiwgc2NhbGU6IFwic1wiIH0sIGgoXCJhcmNnaXMtdGl0bGUtaW5wdXRcIiwgeyBlbmFibGVQdWJsaXNoaW5nOiB0cnVlLCBvbkFyY2dpc1RpdGxlSW5wdXRDaGFuZ2U6IGFzeW5jIChldmVudCkgPT4ge1xuICAgICAgICBjb25zdCBub2RlID0gZXZlbnQudGFyZ2V0O1xuICAgICAgICBjb25zdCB0aXRsZUVycm9yID0gYXdhaXQgbm9kZS52YWxpZGF0ZVRpdGxlKCk7XG4gICAgICAgIGlmICgoIXRoaXMudGl0bGVFcnJvciAmJiB0aXRsZUVycm9yKSB8fCAodGhpcy50aXRsZUVycm9yICYmICF0aXRsZUVycm9yKSkge1xuICAgICAgICAgIHRoaXMucmVSZW5kZXIgPSAhdGhpcy5yZVJlbmRlcjtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnRpdGxlRXJyb3IgPSB0aXRsZUVycm9yO1xuICAgICAgfSB9KSwgaChcImFyY2dpcy1mb2xkZXItcGlja2VyXCIsIHsgdXNlcjogbGF5ZXJJdGVtT3duZXIgfSksIGgoXCJhcmNnaXMtY2F0ZWdvcmllcy1waWNrZXJcIiwgbnVsbCksIGgoXCJhcmNnaXMtdGFncy1waWNrZXJcIiwgbnVsbCksIGgoXCJhcmNnaXMtc3VtbWFyeS1pbnB1dFwiLCB7IG9uQXJjZ2lzU3VtbWFyeUlucHV0Q2hhbmdlOiBhc3luYyAoZXZlbnQpID0+IHtcbiAgICAgICAgY29uc3Qgbm9kZSA9IGV2ZW50LnRhcmdldDtcbiAgICAgICAgY29uc3Qgc3VtbWFyeUVycm9yID0gKGF3YWl0IG5vZGUuZ2V0RXJyb3JNZXNzYWdlKCkpO1xuICAgICAgICBpZiAoKCF0aGlzLnN1bW1hcnlFcnJvciAmJiBzdW1tYXJ5RXJyb3IpIHx8ICh0aGlzLnN1bW1hcnlFcnJvciAmJiAhc3VtbWFyeUVycm9yKSkge1xuICAgICAgICAgIHRoaXMucmVSZW5kZXIgPSAhdGhpcy5yZVJlbmRlcjtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnN1bW1hcnlFcnJvciA9IHN1bW1hcnlFcnJvcjtcbiAgICAgIH0gfSkpKSk7XG4gIH1cbiAgZ2V0IGhvc3RFbGVtZW50KCkgeyByZXR1cm4gZ2V0RWxlbWVudCh0aGlzKTsgfVxufTtcbkFyY2dpc0xheWVyVmlld0NyZWF0ZSQxLnN0eWxlID0gYXJjZ2lzTGF5ZXJWaWV3Q3JlYXRlQ3NzO1xuXG5jb25zdCBDU1MkNyA9IHtcbiAgcGFuZWw6IFwicGFuZWxcIixcbiAgaG9vazogXCJob29rXCIsXG4gIG5vdGljZTogXCJub3RpY2VcIixcbiAgZmlsdGVyQmxvY2s6IFwiZmlsdGVyLWJsb2NrXCIsXG4gIGZpbHRlckNoZXZyb246IFwiZmlsdGVyLWNoZXZyb25cIixcbiAgYW9pR3JvdXA6IFwiYW9pLWdyb3VwXCIsXG4gIGFvaUJ1dHRvbjogXCJhb2ktYnV0dG9uXCIsXG4gIHRleHRDZW50ZXI6IFwidGV4dC1jZW50ZXJcIixcbiAgc2VsZWN0RmllbGRzOiBcInNlbGVjdC1maWVsZHNcIlxufTtcblxuY29uc3QgYXJjZ2lzTGF5ZXJWaWV3RGVmaW5pdGlvbkNzcyA9IFwiLnBhbmVsLnNjLWFyY2dpcy1sYXllci12aWV3LWRlZmluaXRpb257aGVpZ2h0OjEwMCV9Lmhvb2suc2MtYXJjZ2lzLWxheWVyLXZpZXctZGVmaW5pdGlvbntoZWlnaHQ6MXB4fS5ub3RpY2Uuc2MtYXJjZ2lzLWxheWVyLXZpZXctZGVmaW5pdGlvbnttYXJnaW46OHB4fS5maWx0ZXItYmxvY2suc2MtYXJjZ2lzLWxheWVyLXZpZXctZGVmaW5pdGlvbntjdXJzb3I6cG9pbnRlcn0uZmlsdGVyLWJsb2NrLnNjLWFyY2dpcy1sYXllci12aWV3LWRlZmluaXRpb246aG92ZXJ7YmFja2dyb3VuZC1jb2xvcjp2YXIoLS1jYWxjaXRlLXVpLWZvcmVncm91bmQtMil9LmZpbHRlci1jaGV2cm9uLnNjLWFyY2dpcy1sYXllci12aWV3LWRlZmluaXRpb257bWFyZ2luLXJpZ2h0OjAuNXJlbX0uYXJjZ2lzLS1ydGwuc2MtYXJjZ2lzLWxheWVyLXZpZXctZGVmaW5pdGlvbiAuZmlsdGVyLWNoZXZyb24uc2MtYXJjZ2lzLWxheWVyLXZpZXctZGVmaW5pdGlvbnttYXJnaW4tbGVmdDowLjVyZW07bWFyZ2luLXJpZ2h0OmF1dG99LmFvaS1ncm91cC5zYy1hcmNnaXMtbGF5ZXItdmlldy1kZWZpbml0aW9ue3dpZHRoOjEwMCU7bWFyZ2luLWJvdHRvbTowLjc1cmVtfS5hb2ktYnV0dG9uLnNjLWFyY2dpcy1sYXllci12aWV3LWRlZmluaXRpb257bWFyZ2luLXRvcDowLjc1cmVtO2JvcmRlci10b3Atd2lkdGg6MXB4O2JvcmRlci10b3Atc3R5bGU6c29saWQ7Ym9yZGVyLXRvcC1jb2xvcjp2YXIoLS1jYWxjaXRlLXVpLWJvcmRlci0zKX0udGV4dC1jZW50ZXIuc2MtYXJjZ2lzLWxheWVyLXZpZXctZGVmaW5pdGlvbnt0ZXh0LWFsaWduOmNlbnRlcn0uc2VsZWN0LWZpZWxkcy5zYy1hcmNnaXMtbGF5ZXItdmlldy1kZWZpbml0aW9ue21hcmdpbjowIDAgNXB4IDB9XCI7XG5cbmNvbnN0IEFyY2dpc0xheWVyVmlld0RlZmluaXRpb24gPSBjbGFzcyB7XG4gIGNvbnN0cnVjdG9yKGhvc3RSZWYpIHtcbiAgICByZWdpc3Rlckluc3RhbmNlKHRoaXMsIGhvc3RSZWYpO1xuICAgIHRoaXMuYXJjZ2lzTGF5ZXJWaWV3T3ZlclZpZXdSZWZyZXNoID0gY3JlYXRlRXZlbnQodGhpcywgXCJhcmNnaXNMYXllclZpZXdPdmVyVmlld1JlZnJlc2hcIiwgNyk7XG4gICAgdGhpcy5hb2lTeW1ib2wgPSB7XG4gICAgICB0eXBlOiBcInNpbXBsZS1maWxsXCIsXG4gICAgICBzdHlsZTogXCJzb2xpZFwiLFxuICAgICAgY29sb3I6IFswLCAwLCAwLCAwXSxcbiAgICAgIG91dGxpbmU6IHtcbiAgICAgICAgdHlwZTogXCJzaW1wbGUtbGluZVwiLFxuICAgICAgICBzdHlsZTogXCJzb2xpZFwiLFxuICAgICAgICBjb2xvcjogWzI1NSwgMCwgMCwgMjU1XSxcbiAgICAgICAgd2lkdGg6IDJcbiAgICAgIH1cbiAgICB9O1xuICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgLy9cbiAgICAvLyAgUHJpdmF0ZSBtZXRob2RzXG4gICAgLy9cbiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAgIHRoaXMub25CYWNrID0gKCkgPT4ge1xuICAgICAgdGhpcy5hcmNnaXNMYXllclZpZXdPdmVyVmlld1JlZnJlc2guZW1pdCgpO1xuICAgIH07XG4gICAgLy8gLS0tLS0tLS0tICBGaWx0ZXIgIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICB0aGlzLmdvRmlsdGVyID0gKCkgPT4ge1xuICAgICAgdmFyIF9hO1xuICAgICAgaWYgKChfYSA9IHRoaXMuYW9pQmxvY2tOb2RlKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2Eub3Blbikge1xuICAgICAgICB0aGlzLmFvaUJsb2NrTm9kZS5vcGVuID0gZmFsc2U7XG4gICAgICAgIHRoaXMub25BT0lUb2dnbGUoKTtcbiAgICAgIH1cbiAgICAgIHRoaXMuc3RhdHVzID0gZmxvd1N0YXR1cy5GSUxURVI7XG4gICAgICB0aGlzLnJlUmVuZGVyID0gIXRoaXMucmVSZW5kZXI7XG4gICAgfTtcbiAgICB0aGlzLm9uQmFja0ZpbHRlciA9ICgpID0+IHtcbiAgICAgIHRoaXMuc3RhdHVzID0gZmxvd1N0YXR1cy5ERUZJTklUSU9OO1xuICAgICAgdGhpcy5yZVJlbmRlciA9ICF0aGlzLnJlUmVuZGVyO1xuICAgICAgc2V0VGltZW91dCgoKSA9PiB7IHZhciBfYTsgcmV0dXJuIChfYSA9IHRoaXMuZmlsdGVyQWN0aW9uTm9kZSkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLnNldEZvY3VzKCk7IH0sIDIwMCk7XG4gICAgfTtcbiAgICAvLyAtLS0tLS0tLS0gIEFPSSAgICAgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAgIHRoaXMub25Qb2x5Z29uQ2xpY2sgPSAoZXZlbnQpID0+IHtcbiAgICAgIGNvbnN0IHsgcHJvcHMgfSA9IHRoaXM7XG4gICAgICBjb25zdCB7IHN0cmluZ3MgfSA9IHByb3BzO1xuICAgICAgY29uc3Qgbm9kZSA9IGV2ZW50LnRhcmdldDtcbiAgICAgIGlmICghbm9kZS5hY3RpdmUpIHtcbiAgICAgICAgdGhpcy5za2V0Y2hWaWV3TW9kZWwuY2FuY2VsKCk7XG4gICAgICAgIHRoaXMuc2tldGNoVmlld01vZGVsLmNyZWF0ZShcInBvbHlnb25cIik7XG4gICAgICAgIG5vZGUuYWN0aXZlID0gdHJ1ZTtcbiAgICAgICAgdGhpcy5yZWN0YW5nbGVBY3Rpb24uYWN0aXZlID0gZmFsc2U7XG4gICAgICAgIHRoaXMuZHJhd0xhYmVsLmlubmVySFRNTCA9IHN0cmluZ3MuZGVmaW5lVmlldy5hb2lQb2x5Z29uRHJhdztcbiAgICAgIH1cbiAgICB9O1xuICAgIHRoaXMub25SZWN0YW5nbGVDbGljayA9IChldmVudCkgPT4ge1xuICAgICAgY29uc3QgeyBwcm9wcyB9ID0gdGhpcztcbiAgICAgIGNvbnN0IHsgc3RyaW5ncyB9ID0gcHJvcHM7XG4gICAgICBjb25zdCBub2RlID0gZXZlbnQudGFyZ2V0O1xuICAgICAgaWYgKCFub2RlLmFjdGl2ZSkge1xuICAgICAgICB0aGlzLnNrZXRjaFZpZXdNb2RlbC5jYW5jZWwoKTtcbiAgICAgICAgdGhpcy5za2V0Y2hWaWV3TW9kZWwuY3JlYXRlKFwicmVjdGFuZ2xlXCIpO1xuICAgICAgICBub2RlLmFjdGl2ZSA9IHRydWU7XG4gICAgICAgIHRoaXMucG9seWdvbkFjdGlvbi5hY3RpdmUgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5kcmF3TGFiZWwuaW5uZXJIVE1MID0gc3RyaW5ncy5kZWZpbmVWaWV3LmFvaVJlY3RhbmdsZURyYXc7XG4gICAgICB9XG4gICAgfTtcbiAgICB0aGlzLm9uRGVsZXRlQU9JQ2xpY2sgPSAoKSA9PiB7XG4gICAgICBjb25zdCB7IHByb3BzIH0gPSB0aGlzO1xuICAgICAgY29uc3QgeyBkZWZpbml0aW9uTGF5ZXJJZCwgc3RyaW5ncyB9ID0gcHJvcHM7XG4gICAgICB0aGlzLnNrZXRjaFZpZXdNb2RlbC5jYW5jZWwoKTtcbiAgICAgIHRoaXMuZ3JhcGhpY3NMYXllci5yZW1vdmVBbGwoKTtcbiAgICAgIGNvbnN0IHZpZXdMYXllclByb3BzID0gZ2V0Vmlld0xheWVyUHJvcHMoZGVmaW5pdGlvbkxheWVySWQsIHByb3BzKTtcbiAgICAgIGlmICh2aWV3TGF5ZXJQcm9wcykge1xuICAgICAgICB2aWV3TGF5ZXJQcm9wcy5hb2kgPSB1bmRlZmluZWQ7XG4gICAgICB9XG4gICAgICBzYW5pdGl6ZVZpZXdQcm9wcyhwcm9wcyk7XG4gICAgICBhcHBseUxheWVyQU9JKHVuZGVmaW5lZCwgZGVmaW5pdGlvbkxheWVySWQsIHByb3BzKTtcbiAgICAgIHRoaXMuZHJhd0xhYmVsLmlubmVySFRNTCA9IHN0cmluZ3MuZGVmaW5lVmlldy5hb2lTZWxlY3Q7XG4gICAgICB0aGlzLnBvbHlnb25BY3Rpb24uZGlzYWJsZWQgPSBmYWxzZTtcbiAgICAgIHRoaXMucmVjdGFuZ2xlQWN0aW9uLmRpc2FibGVkID0gZmFsc2U7XG4gICAgICB0aGlzLmFvaUJsb2NrTm9kZS5kZXNjcmlwdGlvbiA9IHN0cmluZ3MuZGVmaW5lVmlldy5hb2lTdWJ0ZXh0O1xuICAgICAgdGhpcy5yZVJlbmRlciA9ICF0aGlzLnJlUmVuZGVyO1xuICAgIH07XG4gICAgdGhpcy5vbkdyYXBoaWNVcGRhdGUgPSAoZXZlbnQpID0+IHtcbiAgICAgIGNvbnN0IHsgcHJvcHMgfSA9IHRoaXM7XG4gICAgICBjb25zdCB7IHZpZXcsIGRlZmluaXRpb25MYXllcklkIH0gPSBwcm9wcztcbiAgICAgIHZpZXcuY2xvc2VQb3B1cCgpO1xuICAgICAgaWYgKGV2ZW50LnN0YXRlID09PSBcImNvbXBsZXRlXCIpIHtcbiAgICAgICAgY29uc3Qgc2tldGNoR3JhcGhpYyA9IGV2ZW50LmdyYXBoaWNzWzBdO1xuICAgICAgICBjb25zdCBleHRlbnQgPSBza2V0Y2hHcmFwaGljLmdlb21ldHJ5LmV4dGVudDtcbiAgICAgICAgY29uc3QgcHRzID0gc2tldGNoR3JhcGhpYy5nZW9tZXRyeS5yaW5nc1swXTtcbiAgICAgICAgbGV0IGlzUmVjdGFuZ2xlID0gZmFsc2U7XG4gICAgICAgIGlmIChwdHMubGVuZ3RoID09PSA1ICYmXG4gICAgICAgICAgcHRzLmluZGV4T2YoW2V4dGVudC54bWluLCBleHRlbnQueW1pbl0pID4gLTEgJiZcbiAgICAgICAgICBwdHMuaW5kZXhPZihbZXh0ZW50LnhtYXgsIGV4dGVudC55bWF4XSkgPiAtMSkge1xuICAgICAgICAgIGlzUmVjdGFuZ2xlID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICBhZGRWaWV3TGF5ZXJQcm9wcyhkZWZpbml0aW9uTGF5ZXJJZCwge1xuICAgICAgICAgIGFvaTogdGhpcy5yZWN0YW5nbGVBY3Rpb24uYWN0aXZlICYmIGlzUmVjdGFuZ2xlXG4gICAgICAgICAgICA/IGV4dGVudC50b0pTT04oKVxuICAgICAgICAgICAgOiBza2V0Y2hHcmFwaGljLmdlb21ldHJ5LnRvSlNPTigpXG4gICAgICAgIH0sIHByb3BzKTtcbiAgICAgICAgYXBwbHlMYXllckFPSShza2V0Y2hHcmFwaGljLmdlb21ldHJ5LCBkZWZpbml0aW9uTGF5ZXJJZCwgcHJvcHMpO1xuICAgICAgICBpZiAodGhpcy5yZWN0YW5nbGVBY3Rpb24uYWN0aXZlICYmICFpc1JlY3RhbmdsZSkge1xuICAgICAgICAgIC8vIHVzZXIgdXBkYXRlZCBhIHJlY3RhbmdsZSB0byBhIHBvbHlnb25cbiAgICAgICAgICB0aGlzLnJlUmVuZGVyID0gIXRoaXMucmVSZW5kZXI7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9O1xuICAgIC8vIC0tLS0tLS0tLSAgRmllbGRzICAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgdGhpcy5zZWxlY3RGaWVsZHMgPSAoZmwpID0+IHtcbiAgICAgIGNvbnN0IHsgcHJvcHMsIHRvdGFsRmllbGRzLCByZXF1aXJlZEZpZWxkTmFtZXMgfSA9IHRoaXM7XG4gICAgICBjb25zdCB7IHZpZXcsIGRlZmluaXRpb25MYXllcklkIH0gPSBwcm9wcztcbiAgICAgIGNvbnN0IHZpZXdMYXllclByb3BzID0gZ2V0Vmlld0xheWVyUHJvcHMoZGVmaW5pdGlvbkxheWVySWQsIHByb3BzKTtcbiAgICAgIGxldCBmaWVsZE5hbWVzID0gW107XG4gICAgICBpZiAodmlld0xheWVyUHJvcHMgPT09IG51bGwgfHwgdmlld0xheWVyUHJvcHMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHZpZXdMYXllclByb3BzLmZpZWxkcykge1xuICAgICAgICBmaWVsZE5hbWVzID0gdmlld0xheWVyUHJvcHMuZmllbGRzO1xuICAgICAgfVxuICAgICAgZWxzZSB7XG4gICAgICAgIGZpZWxkTmFtZXMgPSB0b3RhbEZpZWxkc1xuICAgICAgICAgIC5maWx0ZXIoKGZpZWxkKSA9PiByZXF1aXJlZEZpZWxkTmFtZXMuaW5kZXhPZihmaWVsZC5uYW1lKSA9PT0gLTEpXG4gICAgICAgICAgLm1hcCgoZmllbGQpID0+IGZpZWxkLm5hbWUpO1xuICAgICAgfVxuICAgICAgdGhpcy5jbG9zZUxheWVyVmlld0RlZmluaXRpb25Qb3BvdmVyc0hhbmRsZXIoKTtcbiAgICAgIGNvbnN0IG5vZGVXaWR0aCA9IHRoaXMuZmxvd0l0ZW1Ob2RlLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLndpZHRoO1xuICAgICAgdGhpcy5hcmNnaXNGaWVsZFBpY2tMaXN0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImFyY2dpcy1maWVsZC1waWNrLWxpc3RcIik7XG4gICAgICB0aGlzLmFyY2dpc0ZpZWxkUGlja0xpc3QucG9wb3ZlclByb3BzID0ge1xuICAgICAgICBwbGFjZW1lbnQ6IFwiYXV0b1wiLFxuICAgICAgICBvZmZzZXREaXN0YW5jZTogLTEgKiAobm9kZVdpZHRoID8gbm9kZVdpZHRoIC0gNSA6IDIxNSksXG4gICAgICAgIG9mZnNldFNraWRkaW5nOiAwLFxuICAgICAgICBwb2ludGVyRGlzYWJsZWQ6IHRydWUsXG4gICAgICAgIHBvcG92ZXJXaWR0aDogbm9kZVdpZHRoID8gbm9kZVdpZHRoICsgMzAgOiAyODAsXG4gICAgICAgIHJlZkVsZW1lbnQ6IHRoaXMuZmxvd0l0ZW1Ob2RlXG4gICAgICB9O1xuICAgICAgdGhpcy5hcmNnaXNGaWVsZFBpY2tMaXN0LmZpZWxkcyA9IHRoaXMuY3JlYXRlUGlja0xpc3RGaWVsZHMoZmwpO1xuICAgICAgdGhpcy5hcmNnaXNGaWVsZFBpY2tMaXN0LmxheWVyID0gZmw7XG4gICAgICB0aGlzLmFyY2dpc0ZpZWxkUGlja0xpc3QubWFwVmlldyA9IHZpZXc7XG4gICAgICB0aGlzLmFyY2dpc0ZpZWxkUGlja0xpc3Quc2hvd0ZpZWxkSW5mbyA9IHRydWU7XG4gICAgICB0aGlzLmFyY2dpc0ZpZWxkUGlja0xpc3Quc2hvd0ZpZWxkTmFtZSA9IGZhbHNlO1xuICAgICAgdGhpcy5hcmNnaXNGaWVsZFBpY2tMaXN0LnNlbGVjdGVkRmllbGRzID0gZmllbGROYW1lcztcbiAgICAgIHRoaXMuYXJjZ2lzRmllbGRQaWNrTGlzdC5tdWx0aXBsZSA9IHRydWU7XG4gICAgICB0aGlzLmFyY2dpc0ZpZWxkUGlja0xpc3QuYWRkRXZlbnRMaXN0ZW5lcihcImFyY2dpc0ZpZWxkUGlja0xpc3REaXNtaXNzZWRcIiwgdGhpcy5maWVsZFBpY2tMaXN0Q2hhbmdlcyk7XG4gICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHRoaXMuYXJjZ2lzRmllbGRQaWNrTGlzdCk7XG4gICAgICB0aGlzLmZsb3dJdGVtTm9kZS5kaXNhYmxlZCA9IHRydWU7XG4gICAgfTtcbiAgICB0aGlzLmZpZWxkUGlja0xpc3RDaGFuZ2VzID0gKGV2ZW50KSA9PiB7XG4gICAgICB2YXIgX2E7XG4gICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgIGNvbnN0IHsgcHJvcHMsIHJlcXVpcmVkRmllbGROYW1lcyB9ID0gdGhpcztcbiAgICAgIGNvbnN0IHsgZGVmaW5pdGlvbkxheWVySWQgfSA9IHByb3BzO1xuICAgICAgY29uc3Qgc2VsZWN0ZWRGaWVsZHMgPSAoX2EgPSBldmVudC5kZXRhaWwpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5zZWxlY3RlZEZpZWxkcztcbiAgICAgIHRoaXMucmVtb3ZlRmllbGRzUGlja0xpc3QoKTtcbiAgICAgIGlmIChzZWxlY3RlZEZpZWxkcykge1xuICAgICAgICBjb25zdCBhZG1pbkxheWVySW5mbyA9IGdldEFkbWluTGF5ZXJJbmZvKGRlZmluaXRpb25MYXllcklkLCBwcm9wcyk7XG4gICAgICAgIGNvbnN0IHRvdGFsRmllbGRzID0gKGFkbWluTGF5ZXJJbmZvID09PSBudWxsIHx8IGFkbWluTGF5ZXJJbmZvID09PSB2b2lkIDAgPyB2b2lkIDAgOiBhZG1pbkxheWVySW5mby5maWVsZHMpIHx8IGdldEZMKGRlZmluaXRpb25MYXllcklkLCBwcm9wcykuZmllbGRzO1xuICAgICAgICAvLyBrZWVwIG9yZGVyIGxpa2UgaW4gc2VydmljZVxuICAgICAgICBjb25zdCBzZWxlY3RlZEFuZFJlcXVpcmVkRmllbGRzID0gdG90YWxGaWVsZHNcbiAgICAgICAgICAuZmlsdGVyKChmaWVsZCkgPT4gcmVxdWlyZWRGaWVsZE5hbWVzLmluZGV4T2YoZmllbGQubmFtZSkgPiAtMSB8fCBzZWxlY3RlZEZpZWxkcy5pbmRleE9mKGZpZWxkLm5hbWUpID4gLTEpXG4gICAgICAgICAgLm1hcCgoZmllbGQpID0+IGZpZWxkLm5hbWUpO1xuICAgICAgICBpZiAoc2VsZWN0ZWRBbmRSZXF1aXJlZEZpZWxkcy5sZW5ndGggPCB0b3RhbEZpZWxkcy5sZW5ndGgpIHtcbiAgICAgICAgICAvLyBzdWJzZXQgb2YgZmllbGRzXG4gICAgICAgICAgYWRkVmlld0xheWVyUHJvcHMoZGVmaW5pdGlvbkxheWVySWQsIHtcbiAgICAgICAgICAgIGZpZWxkczogc2VsZWN0ZWRBbmRSZXF1aXJlZEZpZWxkc1xuICAgICAgICAgIH0sIHByb3BzKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAvLyBkZWZhdWx0OyBhbGwgZmllbGRzXG4gICAgICAgICAgbGV0IHZpZXdMYXllclByb3BzID0gZ2V0Vmlld0xheWVyUHJvcHMoZGVmaW5pdGlvbkxheWVySWQsIHByb3BzKTtcbiAgICAgICAgICBpZiAodmlld0xheWVyUHJvcHMpIHtcbiAgICAgICAgICAgIHZpZXdMYXllclByb3BzLmZpZWxkcyA9IHVuZGVmaW5lZDtcbiAgICAgICAgICB9XG4gICAgICAgICAgc2FuaXRpemVWaWV3UHJvcHMocHJvcHMpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMucmVSZW5kZXIgPSAhdGhpcy5yZVJlbmRlcjtcbiAgICAgIH0gLy8gZWxzZSB1c2VyIGhpdCBjYW5jZWwgb3IgY2xvc2VcbiAgICB9O1xuICAgIHRoaXMucmVtb3ZlRmllbGQgPSAoZmllbGROYW1lKSA9PiB7XG4gICAgICBjb25zdCB7IHByb3BzLCB0b3RhbEZpZWxkcyB9ID0gdGhpcztcbiAgICAgIGNvbnN0IHsgZGVmaW5pdGlvbkxheWVySWQgfSA9IHByb3BzO1xuICAgICAgbGV0IHZpZXdMYXllclByb3BzID0gZ2V0Vmlld0xheWVyUHJvcHMoZGVmaW5pdGlvbkxheWVySWQsIHByb3BzKTtcbiAgICAgIGlmICghdmlld0xheWVyUHJvcHMpIHtcbiAgICAgICAgdmlld0xheWVyUHJvcHMgPSB7XG4gICAgICAgICAgbGF5ZXJJZDogZGVmaW5pdGlvbkxheWVySWRcbiAgICAgICAgfTtcbiAgICAgICAgcHJvcHMudmlld1Byb3BzID0gcHJvcHMudmlld1Byb3BzIHx8IFtdO1xuICAgICAgICBwcm9wcy52aWV3UHJvcHMucHVzaCh2aWV3TGF5ZXJQcm9wcyk7XG4gICAgICB9XG4gICAgICBpZiAoIXZpZXdMYXllclByb3BzLmZpZWxkcykge1xuICAgICAgICB2aWV3TGF5ZXJQcm9wcy5maWVsZHMgPSB0b3RhbEZpZWxkcy5tYXAoKGZpZWxkKSA9PiBmaWVsZC5uYW1lKTtcbiAgICAgIH1cbiAgICAgIHZpZXdMYXllclByb3BzLmZpZWxkcy5zcGxpY2Uodmlld0xheWVyUHJvcHMuZmllbGRzLmluZGV4T2YoZmllbGROYW1lKSwgMSk7XG4gICAgICB0aGlzLnJlUmVuZGVyID0gIXRoaXMucmVSZW5kZXI7XG4gICAgfTtcbiAgICB0aGlzLnByb3BzID0gdW5kZWZpbmVkO1xuICAgIHRoaXMuc3RhdHVzID0gdW5kZWZpbmVkO1xuICAgIHRoaXMucmVSZW5kZXIgPSBmYWxzZTtcbiAgICB0aGlzLmxvYWRpbmcgPSBmYWxzZTtcbiAgfVxuICBjbG9zZUxheWVyVmlld0RlZmluaXRpb25Qb3BvdmVyc0hhbmRsZXIoKSB7XG4gICAgdGhpcy5yZW1vdmVGaWVsZHNQaWNrTGlzdCgpO1xuICB9XG4gIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgLy9cbiAgLy8gIExpZmVjeWNsZVxuICAvL1xuICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIGFzeW5jIGNvbXBvbmVudFdpbGxMb2FkKCkge1xuICAgIHZhciBfYTtcbiAgICBjb25zdCB7IHByb3BzIH0gPSB0aGlzO1xuICAgIGNvbnN0IHsgZGVmaW5pdGlvbkxheWVySWQgfSA9IHByb3BzO1xuICAgIHRoaXMuZmwgPSBnZXRGTChkZWZpbml0aW9uTGF5ZXJJZCwgcHJvcHMpO1xuICAgIHRoaXMuYWRtaW5MYXllckluZm8gPSBnZXRBZG1pbkxheWVySW5mbyhkZWZpbml0aW9uTGF5ZXJJZCwgcHJvcHMpO1xuICAgIHRoaXMudG90YWxGaWVsZHMgPSAoKF9hID0gdGhpcy5hZG1pbkxheWVySW5mbykgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmZpZWxkcykgfHwgZ2V0RkwoZGVmaW5pdGlvbkxheWVySWQsIHByb3BzKS5maWVsZHM7XG4gICAgdGhpcy5yZXF1aXJlZEZpZWxkTmFtZXMgPSBnZXRSZXF1aXJlZEZpZWxkTmFtZXMocHJvcHMpO1xuICB9XG4gIGFzeW5jIGNvbXBvbmVudERpZExvYWQoKSB7XG4gICAgc2V0VGltZW91dCgoKSA9PiByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKCkgPT4geyB2YXIgX2E7IHJldHVybiAoX2EgPSB0aGlzLmZsb3dJdGVtTm9kZSkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLnNldEZvY3VzKCk7IH0pLCAyMDApO1xuICB9XG4gIGRpc2Nvbm5lY3RlZENhbGxiYWNrKCkge1xuICAgIHRoaXMucmVtb3ZlU2tldGNoVmlld01vZGVsKCk7XG4gIH1cbiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgLy9cbiAgLy8gIFJlbmRlciBNZXRob2RzXG4gIC8vXG4gIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgcmVuZGVyKCkge1xuICAgIC8vY29uc29sZS5sb2coXCJyZW5kZXIgdmlldy1kZWZpbml0aW9uXCIsIHByb3BzVG9TdHJpbmcodGhpcy5wcm9wcykpO1xuICAgIGNvbnN0IHsgcHJvcHMsIHN0YXR1cyB9ID0gdGhpcztcbiAgICBjb25zdCB7IGRlZmluaXRpb25MYXllcklkLCBzdHJpbmdzIH0gPSBwcm9wcztcbiAgICBjb25zdCBmbCA9IGdldEZMKGRlZmluaXRpb25MYXllcklkLCBwcm9wcyk7XG4gICAgY29uc3QgcnRsID0gZ2V0RWxlbWVudERpcih0aGlzLmhvc3RFbGVtZW50KSA9PT0gXCJydGxcIjtcbiAgICByZXR1cm4gKGgoSG9zdCwgeyBjbGFzczogXCJjYWxjaXRlLW1hdGNoLWhlaWdodFwiIH0sIGgoXCJjYWxjaXRlLWZsb3ctaXRlbVwiLCB7IGhlYWRpbmc6IHN0cmluZ3MuZGVmaW5lVmlldy5kZWZpbml0aW9ucywgZGVzY3JpcHRpb246IGZsLnRpdGxlLCBjbGFzczoge1xuICAgICAgICBwYW5lbDogdHJ1ZSxcbiAgICAgICAgW0NTU19VVElMSVRZLnJ0bF06IHJ0bFxuICAgICAgfSwgb25DYWxjaXRlRmxvd0l0ZW1CYWNrOiB0aGlzLm9uQmFjaywgcmVmOiAobm9kZSkgPT4gKHRoaXMuZmxvd0l0ZW1Ob2RlID0gbm9kZSkgfSwgdGhpcy5yZW5kZXJJbmZvKCksIHRoaXMucmVuZGVyRmlsdGVyKCksIHRoaXMucmVuZGVyQU9JKCksIHRoaXMucmVuZGVyRmllbGRzKCkpLCBzdGF0dXMgPT09IGZsb3dTdGF0dXMuRklMVEVSID8gdGhpcy5yZW5kZXJMYXllckZpbHRlcigpIDogbnVsbCkpO1xuICB9XG4gIHJlbmRlckluZm8oKSB7XG4gICAgY29uc3QgeyBwcm9wcyB9ID0gdGhpcztcbiAgICBjb25zdCB7IGNvbmZpZywgc3RyaW5ncyB9ID0gcHJvcHM7XG4gICAgY29uc3QgeyBoZWxwQmFzZSwgaGVscE1hcCB9ID0gY29uZmlnO1xuICAgIGlmIChnZXRTaW5nbGVPYmplY3RMb2NhbFN0b3JhZ2UobG9jYWxTdG9yYWdlS2V5cy5BUkNHSVNfQ09NUE9ORU5UX05PVElGSUNBVElPTlMsIGFyY2dpc0NvbXBvbmVudE5vdGlmaWNhdGlvbnNLZXlzLkxBWUVSX1ZJRVdfREVGSU5JVElPTl9ESVNNSVNTRUQpKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gICAgcmV0dXJuIChoKFwiY2FsY2l0ZS1ub3RpY2VcIiwgeyBjbGFzczogQ1NTJDcubm90aWNlLCBvcGVuOiB0cnVlLCBjbG9zYWJsZTogdHJ1ZSwgc2NhbGU6IFwic1wiLCB3aWR0aDogXCJhdXRvXCIsIG9uQ2FsY2l0ZU5vdGljZUNsb3NlOiAoKSA9PiB7XG4gICAgICAgIHNldFNpbmdsZU9iamVjdExvY2FsU3RvcmFnZShsb2NhbFN0b3JhZ2VLZXlzLkFSQ0dJU19DT01QT05FTlRfTk9USUZJQ0FUSU9OUywge1xuICAgICAgICAgIGtleTogYXJjZ2lzQ29tcG9uZW50Tm90aWZpY2F0aW9uc0tleXMuTEFZRVJfVklFV19ERUZJTklUSU9OX0RJU01JU1NFRCxcbiAgICAgICAgICB2YWx1ZTogXCJ0cnVlXCJcbiAgICAgICAgfSk7XG4gICAgICB9IH0sIGgoXCJkaXZcIiwgeyBzbG90OiBcInRpdGxlXCIgfSwgc3RyaW5ncy5kZWZpbmVWaWV3LmFkZERlZmluaXRpb25zKSwgaChcImRpdlwiLCB7IHNsb3Q6IFwibWVzc2FnZVwiIH0sIHN0cmluZ3MuZGVmaW5lVmlldy5hZGREZWZpbml0aW9uc01zZyksIGgoXCJjYWxjaXRlLWxpbmtcIiwgeyBzbG90OiBcImxpbmtcIiwgdGl0bGU6IHN0cmluZ3MuZGVmaW5lVmlldy5tb3JlQWJvdXRWaWV3cywgdGFyZ2V0OiBcIl9ibGFua1wiLCBocmVmOiBgJHtoZWxwQmFzZX0ke2hlbHBNYXBbXCIxMjAwMDI4MzlcIl19YCB9LCBzdHJpbmdzLmRlZmluZVZpZXcubW9yZUFib3V0Vmlld3MpKSk7XG4gIH1cbiAgcmVuZGVyRmlsdGVyKCkge1xuICAgIGNvbnN0IHsgcHJvcHMgfSA9IHRoaXM7XG4gICAgY29uc3QgeyBkZWZpbml0aW9uTGF5ZXJJZCwgc3RyaW5ncyB9ID0gcHJvcHM7XG4gICAgY29uc3Qgdmlld0xheWVyUHJvcHMgPSBnZXRWaWV3TGF5ZXJQcm9wcyhkZWZpbml0aW9uTGF5ZXJJZCwgcHJvcHMpO1xuICAgIGNvbnN0IHJ0bCA9IGdldEVsZW1lbnREaXIodGhpcy5ob3N0RWxlbWVudCkgPT09IFwicnRsXCI7XG4gICAgcmV0dXJuIChoKFwiY2FsY2l0ZS1ibG9ja1wiLCB7IGhlYWRpbmc6ICh2aWV3TGF5ZXJQcm9wcyA9PT0gbnVsbCB8fCB2aWV3TGF5ZXJQcm9wcyA9PT0gdm9pZCAwID8gdm9pZCAwIDogdmlld0xheWVyUHJvcHMuZmlsdGVyKSA/IHN0cmluZ3MuZGVmaW5lVmlldy5lZGl0RmlsdGVyIDogc3RyaW5ncy5kZWZpbmVWaWV3LmFkZEZpbHRlciwgY29sbGFwc2libGU6IGZhbHNlLCBjbGFzczogQ1NTJDcuZmlsdGVyQmxvY2ssIHRhYkluZGV4OiAwLCBvbkNsaWNrOiB0aGlzLmdvRmlsdGVyIH0sIGgoXCJjYWxjaXRlLWljb25cIiwgeyBzbG90OiBcImljb25cIiwgaWNvbjogXCJmaWx0ZXJcIiwgc2NhbGU6IFwic1wiIH0pLCBoKFwiY2FsY2l0ZS1hY3Rpb25cIiwgeyBzbG90OiBcImNvbnRyb2xcIiwgaWNvbjogcnRsID8gXCJjaGV2cm9uLWxlZnRcIiA6IFwiY2hldnJvbi1yaWdodFwiLCBjbGFzczogQ1NTJDcuZmlsdGVyQ2hldnJvbiwgc2NhbGU6IFwic1wiLCB0ZXh0OiAodmlld0xheWVyUHJvcHMgPT09IG51bGwgfHwgdmlld0xheWVyUHJvcHMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHZpZXdMYXllclByb3BzLmZpbHRlcikgPyBzdHJpbmdzLmRlZmluZVZpZXcuZWRpdEZpbHRlciA6IHN0cmluZ3MuZGVmaW5lVmlldy5hZGRGaWx0ZXIsIHJlZjogKG5vZGUpID0+ICh0aGlzLmZpbHRlckFjdGlvbk5vZGUgPSBub2RlKSB9KSkpO1xuICB9XG4gIHJlbmRlckFPSSgpIHtcbiAgICBjb25zdCB7IHByb3BzLCBmbCB9ID0gdGhpcztcbiAgICBjb25zdCB7IGRlZmluaXRpb25MYXllcklkLCBzdHJpbmdzIH0gPSBwcm9wcztcbiAgICBpZiAoZmwuaXNUYWJsZSkge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICAgIGNvbnN0IHZpZXdMYXllclByb3BzID0gZ2V0Vmlld0xheWVyUHJvcHMoZGVmaW5pdGlvbkxheWVySWQsIHByb3BzKTtcbiAgICByZXR1cm4gKGgoXCJjYWxjaXRlLWJsb2NrXCIsIHsgaGVhZGluZzogc3RyaW5ncy5kZWZpbmVWaWV3LmFyZWFPZkludGVyZXN0LCBkZXNjcmlwdGlvbjogISh2aWV3TGF5ZXJQcm9wcyA9PT0gbnVsbCB8fCB2aWV3TGF5ZXJQcm9wcyA9PT0gdm9pZCAwID8gdm9pZCAwIDogdmlld0xheWVyUHJvcHMuYW9pKSA/IHN0cmluZ3MuZGVmaW5lVmlldy5hb2lTdWJ0ZXh0IDogdW5kZWZpbmVkLCBjb2xsYXBzaWJsZTogdHJ1ZSwgb25DYWxjaXRlQmxvY2tUb2dnbGU6ICgpID0+IHRoaXMub25BT0lUb2dnbGUoKSwgcmVmOiAobm9kZSkgPT4gKHRoaXMuYW9pQmxvY2tOb2RlID0gbm9kZSkgfSwgaChcImNhbGNpdGUtaWNvblwiLCB7IHNsb3Q6IFwiaWNvblwiLCBpY29uOiBcInBvbHlnb25cIiwgc2NhbGU6IFwic1wiIH0pLCB0aGlzLnJlbmRlckFPSUNvbnRlbnQoKSkpO1xuICB9XG4gIHJlbmRlckFPSUNvbnRlbnQoKSB7XG4gICAgY29uc3QgeyBwcm9wcyB9ID0gdGhpcztcbiAgICBjb25zdCB7IGRlZmluaXRpb25MYXllcklkLCBsYXllcklkcywgc3RyaW5ncyB9ID0gcHJvcHM7XG4gICAgY29uc3Qgdmlld0xheWVyUHJvcHMgPSBnZXRWaWV3TGF5ZXJQcm9wcyhkZWZpbml0aW9uTGF5ZXJJZCwgcHJvcHMpO1xuICAgIGNvbnN0IGhhc0FPSSA9ICEhKHZpZXdMYXllclByb3BzID09PSBudWxsIHx8IHZpZXdMYXllclByb3BzID09PSB2b2lkIDAgPyB2b2lkIDAgOiB2aWV3TGF5ZXJQcm9wcy5hb2kpO1xuICAgIHJldHVybiAoaChcImRpdlwiLCBudWxsLCBoKFwiY2FsY2l0ZS1hY3Rpb24tZ3JvdXBcIiwgeyBsYXlvdXQ6IFwiZ3JpZFwiLCBjbGFzczogQ1NTJDcuYW9pR3JvdXAgfSwgaChcImNhbGNpdGUtYWN0aW9uXCIsIHsgaWNvbjogXCJwb2x5Z29uXCIsIGFwcGVhcmFuY2U6IFwic29saWRcIiwgYWxpZ25tZW50OiBcImNlbnRlclwiLCBhY3RpdmU6IGZhbHNlLCBkaXNhYmxlZDogaGFzQU9JLCBzY2FsZTogXCJzXCIsIHRleHQ6IHN0cmluZ3MuZGVmaW5lVmlldy5hb2lTa2V0Y2hQb2x5Z29uTGFiZWwsIHRpdGxlOiBzdHJpbmdzLmRlZmluZVZpZXcuYW9pU2tldGNoUG9seWdvbkxhYmVsLCBvbkNsaWNrOiAhaGFzQU9JID8gdGhpcy5vblBvbHlnb25DbGljayA6IHVuZGVmaW5lZCwgcmVmOiAobm9kZSkgPT4gKHRoaXMucG9seWdvbkFjdGlvbiA9IG5vZGUpIH0pLCBoKFwiY2FsY2l0ZS1hY3Rpb25cIiwgeyBpY29uOiBcInJlY3RhbmdsZVwiLCBhcHBlYXJhbmNlOiBcInNvbGlkXCIsIGFsaWdubWVudDogXCJjZW50ZXJcIiwgYWN0aXZlOiBmYWxzZSwgZGlzYWJsZWQ6IGhhc0FPSSwgc2NhbGU6IFwic1wiLCB0ZXh0OiBzdHJpbmdzLmRlZmluZVZpZXcuYW9pU2tldGNoUmVjdGFuZ2xlTGFiZWwsIHRpdGxlOiBzdHJpbmdzLmRlZmluZVZpZXcuYW9pU2tldGNoUmVjdGFuZ2xlTGFiZWwsIG9uQ2xpY2s6ICFoYXNBT0kgPyB0aGlzLm9uUmVjdGFuZ2xlQ2xpY2sgOiB1bmRlZmluZWQsIHJlZjogKG5vZGUpID0+ICh0aGlzLnJlY3RhbmdsZUFjdGlvbiA9IG5vZGUpIH0pLCBoKFwiY2FsY2l0ZS1hY3Rpb25cIiwgeyBpY29uOiBcInRyYXNoXCIsIGFwcGVhcmFuY2U6IFwic29saWRcIiwgYWxpZ25tZW50OiBcImNlbnRlclwiLCBzY2FsZTogXCJzXCIsIGRpc2FibGVkOiAhaGFzQU9JLCB0ZXh0OiBzdHJpbmdzLmRlZmluZVZpZXcuYW9pRGVsZXRlTGFiZWwsIHRpdGxlOiBzdHJpbmdzLmRlZmluZVZpZXcuYW9pRGVsZXRlTGFiZWwsIG9uQ2xpY2s6IGhhc0FPSSA/IHRoaXMub25EZWxldGVBT0lDbGljayA6IHVuZGVmaW5lZCB9KSksIGgoXCJkaXZcIiwgeyBjbGFzczogQ1NTJDcudGV4dENlbnRlciwgcmVmOiAobm9kZSkgPT4gKHRoaXMuZHJhd0xhYmVsID0gbm9kZSkgfSwgIWhhc0FPSSA/IHN0cmluZ3MuZGVmaW5lVmlldy5hb2lTZWxlY3QgOiBzdHJpbmdzLmRlZmluZVZpZXcuYW9pUmVzdGFydCksIGxheWVySWRzLmxlbmd0aCA+IDEgPyAoaChcImNhbGNpdGUtYnV0dG9uXCIsIHsgYXBwZWFyYW5jZTogXCJ0cmFuc3BhcmVudFwiLCB3aWR0aDogXCJmdWxsXCIsIGNsYXNzOiBDU1MkNy5hb2lCdXR0b24sIG9uQ2xpY2s6ICgpID0+IHRoaXMuYXBwbHlBT0lUb0FsbCgpIH0sIHN0cmluZ3MuZGVmaW5lVmlldy5hb2lBcHBseUFsbCkpIDogbnVsbCkpO1xuICB9XG4gIHJlbmRlckZpZWxkcygpIHtcbiAgICB2YXIgX2E7XG4gICAgY29uc3QgeyBwcm9wcywgdG90YWxGaWVsZHMgfSA9IHRoaXM7XG4gICAgY29uc3QgeyBkZWZpbml0aW9uTGF5ZXJJZCwgc3RyaW5ncyB9ID0gcHJvcHM7XG4gICAgY29uc3Qgdmlld0xheWVyUHJvcHMgPSBnZXRWaWV3TGF5ZXJQcm9wcyhkZWZpbml0aW9uTGF5ZXJJZCwgcHJvcHMpO1xuICAgIGNvbnN0IHRvdGFsRmllbGRDb3VudCA9IHRvdGFsRmllbGRzLmxlbmd0aDtcbiAgICBjb25zdCBmaWVsZENvdW50VmlldyA9ICgoX2EgPSB2aWV3TGF5ZXJQcm9wcyA9PT0gbnVsbCB8fCB2aWV3TGF5ZXJQcm9wcyA9PT0gdm9pZCAwID8gdm9pZCAwIDogdmlld0xheWVyUHJvcHMuZmllbGRzKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EubGVuZ3RoKSB8fCB0b3RhbEZpZWxkQ291bnQ7XG4gICAgcmV0dXJuIChoKFwiY2FsY2l0ZS1ibG9ja1wiLCB7IGhlYWRpbmc6IHN0cmluZ3MuZGVmaW5lVmlldy5maWVsZHMsIGRlc2NyaXB0aW9uOiBgJHtmaWVsZENvdW50Vmlld30vJHt0b3RhbEZpZWxkQ291bnR9YCwgY29sbGFwc2libGU6IHRydWUgfSwgaChcImNhbGNpdGUtaWNvblwiLCB7IHNsb3Q6IFwiaWNvblwiLCBpY29uOiBcImZlYXR1cmUtZGV0YWlsc1wiLCBzY2FsZTogXCJzXCIgfSksIHRoaXMucmVuZGVyRmllbGRzQ29udGVudCgpKSk7XG4gIH1cbiAgcmVuZGVyRmllbGRzQ29udGVudCgpIHtcbiAgICBjb25zdCB7IHByb3BzLCBmbCwgcmVxdWlyZWRGaWVsZE5hbWVzLCB0b3RhbEZpZWxkcyB9ID0gdGhpcztcbiAgICBjb25zdCB7IGRlZmluaXRpb25MYXllcklkLCBzdHJpbmdzIH0gPSBwcm9wcztcbiAgICBjb25zdCB2aWV3TGF5ZXJQcm9wcyA9IGdldFZpZXdMYXllclByb3BzKGRlZmluaXRpb25MYXllcklkLCBwcm9wcyk7XG4gICAgbGV0IGZpZWxkc0xpc3Q7XG4gICAgaWYgKHZpZXdMYXllclByb3BzID09PSBudWxsIHx8IHZpZXdMYXllclByb3BzID09PSB2b2lkIDAgPyB2b2lkIDAgOiB2aWV3TGF5ZXJQcm9wcy5maWVsZHMpIHtcbiAgICAgIGZpZWxkc0xpc3QgPSB0b3RhbEZpZWxkcy5maWx0ZXIoKGZpZWxkKSA9PiB2aWV3TGF5ZXJQcm9wcy5maWVsZHMuaW5kZXhPZihmaWVsZC5uYW1lKSA+IC0xIHx8XG4gICAgICAgIHJlcXVpcmVkRmllbGROYW1lcy5pbmRleE9mKGZpZWxkLm5hbWUpID4gLTEpO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgIGZpZWxkc0xpc3QgPSB0b3RhbEZpZWxkcztcbiAgICB9XG4gICAgY29uc3QgaGFzRmllbGRzVG9TZWxlY3QgPSByZXF1aXJlZEZpZWxkTmFtZXMubGVuZ3RoICE9PSB0b3RhbEZpZWxkcy5sZW5ndGg7XG4gICAgY29uc3QgbGlzdEl0ZW1zID0gZmllbGRzTGlzdC5tYXAoKGZpZWxkKSA9PiB7XG4gICAgICByZXR1cm4gKGgoXCJjYWxjaXRlLWxpc3QtaXRlbVwiLCB7IGxhYmVsOiBmaWVsZC5hbGlhcyB8fCBmaWVsZC5uYW1lIH0sIHJlcXVpcmVkRmllbGROYW1lcy5pbmRleE9mKGZpZWxkLm5hbWUpID09PSAtMSA/IChoKFwiY2FsY2l0ZS1hY3Rpb25cIiwgeyBpY29uOiBcInhcIiwgc2NhbGU6IFwic1wiLCB0ZXh0OiBzdHJpbmdzLmdlbmVyYWwucmVtb3ZlLCBzbG90OiBcImFjdGlvbnMtZW5kXCIsIG9uQ2xpY2s6ICgpID0+IHRoaXMucmVtb3ZlRmllbGQoZmllbGQubmFtZSkgfSkpIDogbnVsbCkpO1xuICAgIH0pO1xuICAgIHJldHVybiAoaChcImRpdlwiLCBudWxsLCBoYXNGaWVsZHNUb1NlbGVjdCAmJiAoaChcImNhbGNpdGUtYnV0dG9uXCIsIHsgY2xhc3M6IENTUyQ3LnNlbGVjdEZpZWxkcywgYXBwZWFyYW5jZTogXCJvdXRsaW5lLWZpbGxcIiwgcm91bmQ6IHRydWUsIGxhYmVsOiBzdHJpbmdzLmRlZmluZVZpZXcuc2VsZWN0RmllbGRzLCBzY2FsZTogXCJzXCIsIHdpZHRoOiBcImZ1bGxcIiwgb25DbGljazogKCkgPT4gdGhpcy5zZWxlY3RGaWVsZHMoZmwpLCByZWY6IChub2RlKSA9PiAodGhpcy5idXR0b25Ob2RlID0gbm9kZSkgfSwgc3RyaW5ncy5kZWZpbmVWaWV3LnNlbGVjdEZpZWxkcykpLCBoKFwiY2FsY2l0ZS1saXN0XCIsIG51bGwsIGxpc3RJdGVtcykpKTtcbiAgfVxuICByZW5kZXJMYXllckZpbHRlcigpIHtcbiAgICBjb25zdCB7IHByb3BzLCBmbCB9ID0gdGhpcztcbiAgICBjb25zdCB7IHZpZXcsIGRlZmluaXRpb25MYXllcklkIH0gPSBwcm9wcztcbiAgICBjb25zdCB2aWV3TGF5ZXJQcm9wcyA9IGdldFZpZXdMYXllclByb3BzKGRlZmluaXRpb25MYXllcklkLCB0aGlzLnByb3BzKTtcbiAgICByZXR1cm4gKGgoXCJhcmNnaXMtZmlsdGVyXCIsIHsga2V5OiBgZmlsdGVyLSR7ZGVmaW5pdGlvbkxheWVySWR9YCwgdmlldzogdmlldywgbGF5ZXI6IGZsLCBtb2RlOiBcImxheWVyLXZpZXdcIiwgdmlld0ZpbHRlcjogdmlld0xheWVyUHJvcHMgPT09IG51bGwgfHwgdmlld0xheWVyUHJvcHMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHZpZXdMYXllclByb3BzLmZpbHRlciwgZGlzbWlzc2libGU6IGZhbHNlLCBoaWRlTGF5ZXJUaXRsZTogZmFsc2UsIG9uQXJjZ2lzRmlsdGVyUGFuZWxCYWNrQ2xpY2s6IHRoaXMub25CYWNrRmlsdGVyLCBvbkFyY2dpc0ZpbHRlcldoZXJlQ2hhbmdlOiAoZXZlbnQpID0+IHRoaXMuYXBwbHlGaWx0ZXIoZXZlbnQuZGV0YWlsKSB9KSk7XG4gIH1cbiAgYXN5bmMgYXBwbHlGaWx0ZXIod2hlcmUpIHtcbiAgICAvLyBhcHBseSBmaWx0ZXIgYWZ0ZXIgYXJjZ2lzLWZpbHRlciBjb21wb25lbnQgY2xvc2VkXG4gICAgY29uc3QgeyBwcm9wcyB9ID0gdGhpcztcbiAgICBjb25zdCB7IGRlZmluaXRpb25MYXllcklkIH0gPSBwcm9wcztcbiAgICBpZiAod2hlcmUpIHtcbiAgICAgIGFkZFZpZXdMYXllclByb3BzKGRlZmluaXRpb25MYXllcklkLCB7XG4gICAgICAgIGZpbHRlcjogd2hlcmVcbiAgICAgIH0sIHByb3BzKTtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICAvLyBkZWZhdWx0OyBubyBmaWx0ZXJcbiAgICAgIGNvbnN0IHZpZXdMYXllclByb3BzID0gZ2V0Vmlld0xheWVyUHJvcHMoZGVmaW5pdGlvbkxheWVySWQsIHByb3BzKTtcbiAgICAgIGlmICh2aWV3TGF5ZXJQcm9wcykge1xuICAgICAgICB2aWV3TGF5ZXJQcm9wcy5maWx0ZXIgPSB1bmRlZmluZWQ7XG4gICAgICB9XG4gICAgICBzYW5pdGl6ZVZpZXdQcm9wcyhwcm9wcyk7XG4gICAgfVxuICAgIC8vIGZpbHRlciBjb21wb25lbnQgZG9lc24ndCByZW1vdmUgZWZmZWN0IG9uIGxheWVyVmlld1xuICAgIC8vYXdhaXQgYXBwbHlMYXllckZpbHRlcih3aGVyZSwgZGVmaW5pdGlvbkxheWVySWQsIHByb3BzKTtcbiAgfVxuICBhc3luYyBvbkFPSVRvZ2dsZSgpIHtcbiAgICBpZiAodGhpcy5hb2lCbG9ja05vZGUub3Blbikge1xuICAgICAgaWYgKCF0aGlzLlNrZXRjaFZpZXdNb2RlbCkge1xuICAgICAgICB0aGlzLmFvaUJsb2NrTm9kZS5sb2FkaW5nID0gdHJ1ZTtcbiAgICAgICAgY29uc3QgW1NrZXRjaFZpZXdNb2RlbCwgR3JhcGhpY3NMYXllciwgR3JhcGhpYywgUG9seWdvbiwgRXh0ZW50XSA9IGF3YWl0IGxvYWRNb2R1bGVzKFtcbiAgICAgICAgICBcImVzcmkvd2lkZ2V0cy9Ta2V0Y2gvU2tldGNoVmlld01vZGVsXCIsXG4gICAgICAgICAgXCJlc3JpL2xheWVycy9HcmFwaGljc0xheWVyXCIsXG4gICAgICAgICAgXCJlc3JpL0dyYXBoaWNcIixcbiAgICAgICAgICBcImVzcmkvZ2VvbWV0cnkvUG9seWdvblwiLFxuICAgICAgICAgIFwiZXNyaS9nZW9tZXRyeS9FeHRlbnRcIlxuICAgICAgICBdKTtcbiAgICAgICAgdGhpcy5Ta2V0Y2hWaWV3TW9kZWwgPSBTa2V0Y2hWaWV3TW9kZWw7XG4gICAgICAgIHRoaXMuR3JhcGhpY3NMYXllciA9IEdyYXBoaWNzTGF5ZXI7XG4gICAgICAgIHRoaXMuR3JhcGhpYyA9IEdyYXBoaWM7XG4gICAgICAgIHRoaXMuUG9seWdvbiA9IFBvbHlnb247XG4gICAgICAgIHRoaXMuRXh0ZW50ID0gRXh0ZW50O1xuICAgICAgICB0aGlzLmFvaUJsb2NrTm9kZS5sb2FkaW5nID0gZmFsc2U7XG4gICAgICB9XG4gICAgICB0aGlzLnNldHVwU2tldGNoVmlld01vZGVsKCk7XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgdGhpcy5yZW1vdmVTa2V0Y2hWaWV3TW9kZWwoKTtcbiAgICB9XG4gIH1cbiAgc2V0dXBTa2V0Y2hWaWV3TW9kZWwoKSB7XG4gICAgY29uc3QgeyBwcm9wcywgYW9pU3ltYm9sIH0gPSB0aGlzO1xuICAgIGNvbnN0IHsgbGF5ZXIsIHZpZXcsIGRlZmluaXRpb25MYXllcklkIH0gPSBwcm9wcztcbiAgICB0aGlzLmRlZmF1bHRBdXRvT3BlbkVuYWJsZWQgPSB2aWV3LnBvcHVwRW5hYmxlZDtcbiAgICB2aWV3LnBvcHVwRW5hYmxlZCA9IGZhbHNlO1xuICAgIGlmICh0aGlzLmdyYXBoaWNzTGF5ZXIpIHtcbiAgICAgIC8vIGRvbmUgdGhhdCBhbHJlYWR5XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRoaXMuZ3JhcGhpY3NMYXllciA9IG5ldyB0aGlzLkdyYXBoaWNzTGF5ZXIoKTtcbiAgICB2aWV3Lm1hcC5hZGQodGhpcy5ncmFwaGljc0xheWVyKTtcbiAgICBjb25zdCB2aWV3TGF5ZXJQcm9wcyA9IGdldFZpZXdMYXllclByb3BzKGRlZmluaXRpb25MYXllcklkLCBwcm9wcyk7XG4gICAgaWYgKHZpZXdMYXllclByb3BzID09PSBudWxsIHx8IHZpZXdMYXllclByb3BzID09PSB2b2lkIDAgPyB2b2lkIDAgOiB2aWV3TGF5ZXJQcm9wcy5hb2kpIHtcbiAgICAgIC8vIHNrZXRjaCBvbmx5IHdhbnRzIHBvbHlnb25zXG4gICAgICBjb25zdCBnZW9tID0gdmlld0xheWVyUHJvcHMuYW9pO1xuICAgICAgY29uc3QgZ2VvbWV0cnkgPSBnZW9tLnJpbmdzXG4gICAgICAgID8gdGhpcy5Qb2x5Z29uLmZyb21KU09OKGdlb20pXG4gICAgICAgIDogbmV3IHRoaXMuUG9seWdvbih7XG4gICAgICAgICAgcmluZ3M6IFtcbiAgICAgICAgICAgIFtnZW9tLnhtaW4sIGdlb20ueW1pbl0sXG4gICAgICAgICAgICBbZ2VvbS54bWluLCBnZW9tLnltYXhdLFxuICAgICAgICAgICAgW2dlb20ueG1heCwgZ2VvbS55bWF4XSxcbiAgICAgICAgICAgIFtnZW9tLnhtYXgsIGdlb20ueW1pbl0sXG4gICAgICAgICAgICBbZ2VvbS54bWluLCBnZW9tLnltaW5dXG4gICAgICAgICAgXSxcbiAgICAgICAgICBzcGF0aWFsUmVmZXJlbmNlOiB2aWV3TGF5ZXJQcm9wcy5hb2kuc3BhdGlhbFJlZmVyZW5jZVxuICAgICAgICB9KTtcbiAgICAgIGNvbnN0IGdyYXBoaWMgPSBuZXcgdGhpcy5HcmFwaGljKHtcbiAgICAgICAgZ2VvbWV0cnksXG4gICAgICAgIHN5bWJvbDogYW9pU3ltYm9sXG4gICAgICB9KTtcbiAgICAgIHRoaXMuZ3JhcGhpY3NMYXllci5hZGQoZ3JhcGhpYyk7XG4gICAgfVxuICAgIHRoaXMuc2tldGNoVmlld01vZGVsID0gbmV3IHRoaXMuU2tldGNoVmlld01vZGVsKHtcbiAgICAgIGxheWVyOiB0aGlzLmdyYXBoaWNzTGF5ZXIsXG4gICAgICB2aWV3LFxuICAgICAgcG9seWdvblN5bWJvbDogYW9pU3ltYm9sLFxuICAgICAgdXBkYXRlT25HcmFwaGljQ2xpY2s6IHRydWVcbiAgICB9KTtcbiAgICB0aGlzLnNrZXRjaFZpZXdNb2RlbC5vbihcImNyZWF0ZVwiLCAoZXZlbnQpID0+IHRoaXMub25HcmFwaGljQ3JlYXRlKGV2ZW50KSk7XG4gICAgdGhpcy5za2V0Y2hWaWV3TW9kZWwub24oXCJ1cGRhdGVcIiwgdGhpcy5vbkdyYXBoaWNVcGRhdGUpO1xuICAgIGNvbnN0IHNuYXBwaW5nID0gbGF5ZXIudHlwZSA9PT0gXCJncm91cFwiXG4gICAgICA/IGxheWVyLmxheWVycy5tYXAoKGZMYXllcikgPT4ge1xuICAgICAgICByZXR1cm4geyBsYXllcjogZkxheWVyIH07XG4gICAgICB9KVxuICAgICAgOiBbeyBsYXllciB9XTtcbiAgICB0aGlzLnNrZXRjaFZpZXdNb2RlbC5zbmFwcGluZ09wdGlvbnMuZmVhdHVyZVNvdXJjZXMgPSBzbmFwcGluZztcbiAgICB0aGlzLnNrZXRjaFZpZXdNb2RlbC5zbmFwcGluZ09wdGlvbnMuZW5hYmxlZCA9IHRydWU7XG4gIH1cbiAgcmVtb3ZlU2tldGNoVmlld01vZGVsKCkge1xuICAgIHZhciBfYSwgX2I7XG4gICAgY29uc3QgeyBwcm9wcywgZGVmYXVsdEF1dG9PcGVuRW5hYmxlZCB9ID0gdGhpcztcbiAgICBjb25zdCB7IHZpZXcgfSA9IHByb3BzO1xuICAgIHRoaXMuZ3JhcGhpY3NMYXllciAmJiB2aWV3Lm1hcC5yZW1vdmUodGhpcy5ncmFwaGljc0xheWVyKTtcbiAgICAoX2EgPSB0aGlzLmdyYXBoaWNzTGF5ZXIpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5kZXN0cm95KCk7XG4gICAgdGhpcy5ncmFwaGljc0xheWVyID0gdW5kZWZpbmVkO1xuICAgIChfYiA9IHRoaXMuc2tldGNoVmlld01vZGVsKSA9PT0gbnVsbCB8fCBfYiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2IuZGVzdHJveSgpO1xuICAgIHRoaXMuc2tldGNoVmlld01vZGVsID0gdW5kZWZpbmVkO1xuICAgIHZpZXcucG9wdXBFbmFibGVkID0gZGVmYXVsdEF1dG9PcGVuRW5hYmxlZDtcbiAgfVxuICBvbkdyYXBoaWNDcmVhdGUoZXZlbnQpIHtcbiAgICBjb25zdCB7IHByb3BzIH0gPSB0aGlzO1xuICAgIGNvbnN0IHsgZGVmaW5pdGlvbkxheWVySWQsIHN0cmluZ3MgfSA9IHByb3BzO1xuICAgIGlmIChldmVudC5zdGF0ZSA9PT0gXCJzdGFydFwiICYmIHRoaXMucG9seWdvbkFjdGlvbi5hY3RpdmUpIHtcbiAgICAgIHRoaXMuZHJhd0xhYmVsLmlubmVySFRNTCA9IHN0cmluZ3MuZGVmaW5lVmlldy5hb2lQb2x5Z29uRW5kO1xuICAgIH1cbiAgICBpZiAoZXZlbnQuc3RhdGUgPT09IFwiY29tcGxldGVcIikge1xuICAgICAgY29uc3Qgc2tldGNoR3JhcGhpYyA9IGV2ZW50LmdyYXBoaWM7XG4gICAgICBjb25zdCBleHRlbnQgPSBza2V0Y2hHcmFwaGljLmdlb21ldHJ5LmV4dGVudDtcbiAgICAgIGFkZFZpZXdMYXllclByb3BzKGRlZmluaXRpb25MYXllcklkLCB7XG4gICAgICAgIGFvaTogIXRoaXMucG9seWdvbkFjdGlvbi5hY3RpdmUgPyBleHRlbnQudG9KU09OKCkgOiBza2V0Y2hHcmFwaGljLmdlb21ldHJ5LnRvSlNPTigpXG4gICAgICB9LCBwcm9wcyk7XG4gICAgICBhcHBseUxheWVyQU9JKHNrZXRjaEdyYXBoaWMuZ2VvbWV0cnksIGRlZmluaXRpb25MYXllcklkLCBwcm9wcyk7XG4gICAgICAvL2NvbnNvbGUubG9nKFwiY3JlYXRlIGNvbXBsZXRlXCIsIHByb3BzVG9TdHJpbmcocHJvcHMpKTtcbiAgICAgIHRoaXMuZHJhd0xhYmVsLmlubmVySFRNTCA9IHN0cmluZ3MuZGVmaW5lVmlldy5hb2lSZXN0YXJ0O1xuICAgICAgdGhpcy5wb2x5Z29uQWN0aW9uLmFjdGl2ZSA9IGZhbHNlO1xuICAgICAgdGhpcy5yZWN0YW5nbGVBY3Rpb24uYWN0aXZlID0gZmFsc2U7XG4gICAgICB0aGlzLnBvbHlnb25BY3Rpb24uZGlzYWJsZWQgPSB0cnVlO1xuICAgICAgdGhpcy5yZWN0YW5nbGVBY3Rpb24uZGlzYWJsZWQgPSB0cnVlO1xuICAgICAgdGhpcy5hb2lCbG9ja05vZGUuZGVzY3JpcHRpb24gPSB1bmRlZmluZWQ7XG4gICAgICB0aGlzLnJlUmVuZGVyID0gIXRoaXMucmVSZW5kZXI7XG4gICAgfVxuICB9XG4gIGFwcGx5QU9JVG9BbGwoKSB7XG4gICAgY29uc3QgeyBwcm9wcyB9ID0gdGhpcztcbiAgICBjb25zdCB7IGRlZmluaXRpb25MYXllcklkLCBsYXllciB9ID0gcHJvcHM7XG4gICAgaWYgKGxheWVyLnR5cGUgIT09IFwiZ3JvdXBcIikge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb25zdCB2aWV3TGF5ZXJQcm9wcyA9IGdldFZpZXdMYXllclByb3BzKGRlZmluaXRpb25MYXllcklkLCBwcm9wcyk7XG4gICAgbGF5ZXIubGF5ZXJzLm1hcCgoZmxheWVyKSA9PiB7XG4gICAgICBpZiAoZmxheWVyLmxheWVySWQgIT09IGRlZmluaXRpb25MYXllcklkKSB7XG4gICAgICAgIGlmICh2aWV3TGF5ZXJQcm9wcyA9PT0gbnVsbCB8fCB2aWV3TGF5ZXJQcm9wcyA9PT0gdm9pZCAwID8gdm9pZCAwIDogdmlld0xheWVyUHJvcHMuYW9pKSB7XG4gICAgICAgICAgYWRkVmlld0xheWVyUHJvcHMoZmxheWVyLmxheWVySWQsIHtcbiAgICAgICAgICAgIGFvaTogSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeSh2aWV3TGF5ZXJQcm9wcy5hb2kpKVxuICAgICAgICAgIH0sIHByb3BzKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICBjb25zdCB2aWV3TGF5ZXJQcm9wczIgPSBnZXRWaWV3TGF5ZXJQcm9wcyhmbGF5ZXIubGF5ZXJJZCwgcHJvcHMpO1xuICAgICAgICAgIGlmICh2aWV3TGF5ZXJQcm9wczIpIHtcbiAgICAgICAgICAgIHZpZXdMYXllclByb3BzMi5hb2kgPSB1bmRlZmluZWQ7XG4gICAgICAgICAgfVxuICAgICAgICAgIHNhbml0aXplVmlld1Byb3BzKHByb3BzKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodmlld0xheWVyUHJvcHMgPT09IG51bGwgfHwgdmlld0xheWVyUHJvcHMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHZpZXdMYXllclByb3BzLmFvaSkge1xuICAgICAgICAgIGNvbnN0IGdlb21ldHJ5ID0gdmlld0xheWVyUHJvcHMuYW9pLnJpbmdzXG4gICAgICAgICAgICA/IHRoaXMuUG9seWdvbi5mcm9tSlNPTih2aWV3TGF5ZXJQcm9wcy5hb2kpXG4gICAgICAgICAgICA6IHRoaXMuRXh0ZW50LmZyb21KU09OKHZpZXdMYXllclByb3BzLmFvaSk7XG4gICAgICAgICAgYXBwbHlMYXllckFPSShnZW9tZXRyeSwgZmxheWVyLmxheWVySWQsIHByb3BzKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICBhcHBseUxheWVyQU9JKHVuZGVmaW5lZCwgZmxheWVyLmxheWVySWQsIHByb3BzKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuICB9XG4gIGNyZWF0ZVBpY2tMaXN0RmllbGRzKGZsKSB7XG4gICAgY29uc3QgeyByZXF1aXJlZEZpZWxkTmFtZXMsIHByb3BzIH0gPSB0aGlzO1xuICAgIGNvbnN0IGFkbWluTGF5ZXJJbmZvID0gZ2V0QWRtaW5MYXllckluZm8oZmwubGF5ZXJJZCwgcHJvcHMpO1xuICAgIGNvbnN0IHRvdGFsRmllbGRzID0gKGFkbWluTGF5ZXJJbmZvID09PSBudWxsIHx8IGFkbWluTGF5ZXJJbmZvID09PSB2b2lkIDAgPyB2b2lkIDAgOiBhZG1pbkxheWVySW5mby5maWVsZHMpIHx8IGdldEZMKGZsLmxheWVySWQsIHByb3BzKS5maWVsZHM7XG4gICAgcmV0dXJuIHRvdGFsRmllbGRzXG4gICAgICAuZmlsdGVyKChmaWVsZCkgPT4gcmVxdWlyZWRGaWVsZE5hbWVzLmluZGV4T2YoZmllbGQubmFtZSkgPT09IC0xKVxuICAgICAgLm1hcCgoZmllbGQpID0+IHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIG5hbWU6IGZpZWxkLm5hbWUsXG4gICAgICAgIGFsaWFzOiBmaWVsZC5hbGlhcyB8fCBmaWVsZC5uYW1lLFxuICAgICAgICB0eXBlOiBmaWVsZC50eXBlXG4gICAgICB9O1xuICAgIH0pO1xuICB9XG4gIHJlbW92ZUZpZWxkc1BpY2tMaXN0KCkge1xuICAgIHRoaXMuZmxvd0l0ZW1Ob2RlLmRpc2FibGVkID0gZmFsc2U7XG4gICAgaWYgKHRoaXMuYXJjZ2lzRmllbGRQaWNrTGlzdCkge1xuICAgICAgZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZCh0aGlzLmFyY2dpc0ZpZWxkUGlja0xpc3QpO1xuICAgICAgdGhpcy5hcmNnaXNGaWVsZFBpY2tMaXN0ID0gbnVsbDtcbiAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICB0aGlzLmJ1dHRvbk5vZGUuc2V0Rm9jdXMoKTtcbiAgICAgIH0sIDEpO1xuICAgIH1cbiAgfVxuICBnZXQgaG9zdEVsZW1lbnQoKSB7IHJldHVybiBnZXRFbGVtZW50KHRoaXMpOyB9XG59O1xuQXJjZ2lzTGF5ZXJWaWV3RGVmaW5pdGlvbi5zdHlsZSA9IGFyY2dpc0xheWVyVmlld0RlZmluaXRpb25Dc3M7XG5cbnZhciBqb2luRmxvd1N0YXR1cztcbihmdW5jdGlvbiAoam9pbkZsb3dTdGF0dXMpIHtcbiAgam9pbkZsb3dTdGF0dXNbam9pbkZsb3dTdGF0dXNbXCJFUlJPUlwiXSA9IDBdID0gXCJFUlJPUlwiO1xuICBqb2luRmxvd1N0YXR1c1tqb2luRmxvd1N0YXR1c1tcIkxPQURJTkdcIl0gPSAxXSA9IFwiTE9BRElOR1wiO1xuICBqb2luRmxvd1N0YXR1c1tqb2luRmxvd1N0YXR1c1tcIlRBUkdFVF9TRUxFQ1RJT05cIl0gPSAyXSA9IFwiVEFSR0VUX1NFTEVDVElPTlwiO1xuICBqb2luRmxvd1N0YXR1c1tqb2luRmxvd1N0YXR1c1tcIkFERF9TRUxFQ1RJT05cIl0gPSAzXSA9IFwiQUREX1NFTEVDVElPTlwiO1xuICBqb2luRmxvd1N0YXR1c1tqb2luRmxvd1N0YXR1c1tcIkJST1dTRV9MQVlFUlwiXSA9IDRdID0gXCJCUk9XU0VfTEFZRVJcIjtcbiAgam9pbkZsb3dTdGF0dXNbam9pbkZsb3dTdGF0dXNbXCJDT05GSUdcIl0gPSA1XSA9IFwiQ09ORklHXCI7XG4gIGpvaW5GbG93U3RhdHVzW2pvaW5GbG93U3RhdHVzW1wiQ1JFQVRFXCJdID0gNl0gPSBcIkNSRUFURVwiO1xufSkoam9pbkZsb3dTdGF0dXMgfHwgKGpvaW5GbG93U3RhdHVzID0ge30pKTtcbmZ1bmN0aW9uIGdldEZpZWxkQWxpYXMobGF5ZXIsIGZpZWxkTmFtZSkge1xuICB2YXIgX2E7XG4gIGNvbnN0IHsgZmllbGRzLCBwb3B1cFRlbXBsYXRlIH0gPSBsYXllcjtcbiAgY29uc3QgZmllbGRJbmZvcyA9IHBvcHVwVGVtcGxhdGUgPT09IG51bGwgfHwgcG9wdXBUZW1wbGF0ZSA9PT0gdm9pZCAwID8gdm9pZCAwIDogcG9wdXBUZW1wbGF0ZS5maWVsZEluZm9zO1xuICBjb25zdCBmaWVsZCA9IGZpZWxkcy5maW5kKChmaWVsZCkgPT4gZmllbGROYW1lID09PSBmaWVsZC5uYW1lKTtcbiAgcmV0dXJuICgoZmllbGQgJiYgKChfYSA9IGZpZWxkSW5mb3MgPT09IG51bGwgfHwgZmllbGRJbmZvcyA9PT0gdm9pZCAwID8gdm9pZCAwIDogZmllbGRJbmZvcy5maW5kKChmaWVsZEluZm8pID0+IGZpZWxkSW5mby5maWVsZE5hbWUgPT09IGZpZWxkLm5hbWUpKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EubGFiZWwpKSB8fFxuICAgIChmaWVsZCA9PT0gbnVsbCB8fCBmaWVsZCA9PT0gdm9pZCAwID8gdm9pZCAwIDogZmllbGQuYWxpYXMpIHx8XG4gICAgZmllbGROYW1lKTtcbn1cbmZ1bmN0aW9uIGdldEZpZWxkVHlwZShsYXllciwgZmllbGROYW1lKSB7XG4gIGNvbnN0IHsgZmllbGRzIH0gPSBsYXllcjtcbiAgY29uc3QgZmllbGQgPSBmaWVsZHMuZmluZCgoZmllbGQpID0+IGZpZWxkTmFtZSA9PT0gZmllbGQubmFtZSk7XG4gIHJldHVybiBmaWVsZCA9PT0gbnVsbCB8fCBmaWVsZCA9PT0gdm9pZCAwID8gdm9pZCAwIDogZmllbGQudHlwZTtcbn1cbmZ1bmN0aW9uIGdldExheWVyVHlwZShsYXllciwgcHJvcHMpIHtcbiAgY29uc3QgeyBzdHJpbmdzIH0gPSBwcm9wcztcbiAgcmV0dXJuIGxheWVyLmlzVGFibGVcbiAgICA/IHN0cmluZ3MuZ2VuZXJhbC50YWJsZVxuICAgIDogbGF5ZXIuZ2VvbWV0cnlUeXBlID09PSBcInBvaW50XCIgfHwgbGF5ZXIuZ2VvbWV0cnlUeXBlID09PSBcIm11bHRpcG9pbnRcIlxuICAgICAgPyBzdHJpbmdzLmpvaW4ucG9pbnRMYXllclxuICAgICAgOiBsYXllci5nZW9tZXRyeVR5cGUgPT09IFwicG9seWxpbmVcIlxuICAgICAgICA/IHN0cmluZ3Muam9pbi5wb2x5bGluZUxheWVyXG4gICAgICAgIDogbGF5ZXIuZ2VvbWV0cnlUeXBlID09PSBcInBvbHlnb25cIlxuICAgICAgICAgID8gc3RyaW5ncy5qb2luLnBvbHlnb25MYXllclxuICAgICAgICAgIDogXCJcIjtcbn1cbmZ1bmN0aW9uIGhhc09CQUMobGF5ZXIpIHtcbiAgdmFyIF9hLCBfYjtcbiAgLy8gT25seSBpZiBvbmUgb2YgYWxsb3dPdGhlcnNUb1F1ZXJ5L2FsbG93QW5vbnltb3VzVG9RdWVyeSBpcyBleHBsaWNpdGx5IHNldCB0byBmYWxzZSBkbyB3ZSBibG9jayBqb2luLlxuICAvLyBJZiBpdCdzIHRydWUgb3Igbm90IHRoZXJlIHdlIGRvbid0IGJsb2NrIGpvaW5cbiAgcmV0dXJuIChsYXllci5zb3VyY2VKU09OLm93bmVyc2hpcEJhc2VkQWNjZXNzQ29udHJvbEZvckZlYXR1cmVzICYmXG4gICAgKCgoX2EgPSBsYXllci5zb3VyY2VKU09OLm93bmVyc2hpcEJhc2VkQWNjZXNzQ29udHJvbEZvckZlYXR1cmVzKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EuYWxsb3dBbm9ueW1vdXNUb1F1ZXJ5KSA9PT0gZmFsc2UgfHxcbiAgICAgICgoX2IgPSBsYXllci5zb3VyY2VKU09OLm93bmVyc2hpcEJhc2VkQWNjZXNzQ29udHJvbEZvckZlYXR1cmVzKSA9PT0gbnVsbCB8fCBfYiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2IuYWxsb3dPdGhlcnNUb1F1ZXJ5KSA9PT0gZmFsc2UpKTtcbn1cblxuLyoqXG4gKiBnZXQgYSBzdWdnZXN0ZWQgdGl0bGUgZm9yIHRoZSBqb2luZWQgdmlld1xuICogQHBhcmFtIHByb3BzIC0gTGF5ZXJWaWV3Sm9pblByb3BzXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIGdldFN1Z2dlc3RlZFRpdGxlRm9ySm9pbihwcm9wcykge1xuICB2YXIgX2EsIF9iO1xuICBjb25zdCB7IHRhcmdldEl0ZW0sIHRhcmdldExheWVyLCBzdHJpbmdzLCBtb2R1bGVzIH0gPSBwcm9wcztcbiAgY29uc3QgeyBlc3JpUmVxdWVzdCB9ID0gbW9kdWxlcztcbiAgY29uc3QgcmVsYXRlZFVybCA9IGAke3RhcmdldEl0ZW0uaXRlbVVybH0vcmVsYXRlZEl0ZW1zYDtcbiAgY29uc3QgcmVsYXRlZENvbnRlbnQgPSB7XG4gICAgcmVsYXRpb25zaGlwVHlwZTogXCJTZXJ2aWNlMlNlcnZpY2VcIixcbiAgICBkaXJlY3Rpb246IFwiZm9yd2FyZFwiXG4gIH07XG4gIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGVzcmlSZXF1ZXN0KHJlbGF0ZWRVcmwsIHtcbiAgICBxdWVyeTogT2JqZWN0LmFzc2lnbihPYmplY3QuYXNzaWduKHt9LCByZWxhdGVkQ29udGVudCksIHsgZjogXCJqc29uXCIsIHRva2VuOiB0YXJnZXRMYXllci5wb3J0YWxJdGVtLnBvcnRhbC5jcmVkZW50aWFsLnRva2VuIH0pLFxuICAgIG1ldGhvZDogXCJwb3N0XCIsXG4gICAgcmVzcG9uc2VUeXBlOiBcImpzb25cIlxuICB9KTtcbiAgLy8gY2hlY2sgd2l0aCBzcGFjZXMgYW5kIHVuZGVyc2NvcmVzXG4gIGNvbnN0IHZpZXdJdGVtcyA9ICgoX2IgPSAoX2EgPSByZXN1bHQgPT09IG51bGwgfHwgcmVzdWx0ID09PSB2b2lkIDAgPyB2b2lkIDAgOiByZXN1bHQuZGF0YSkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLnJlbGF0ZWRJdGVtcykgPT09IG51bGwgfHwgX2IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9iLmZpbHRlcigoaXRlbSkgPT4gaXRlbS50eXBlID09PSBcIkZlYXR1cmUgU2VydmljZVwiICYmXG4gICAgKGl0ZW0udGl0bGUuaW5kZXhPZih0YXJnZXRJdGVtLnRpdGxlKSA+IC0xIHx8XG4gICAgICBpdGVtLnRpdGxlLmluZGV4T2YodGFyZ2V0SXRlbS50aXRsZS5yZXBsYWNlKC8gL2csIFwiX1wiKSkgPiAtMSB8fFxuICAgICAgaXRlbS50aXRsZS5yZXBsYWNlKC8gL2csIFwiX1wiKS5pbmRleE9mKHRhcmdldEl0ZW0udGl0bGUpID4gLTEpKSkgfHwgW107XG4gIHJldHVybiAoc3RyaW5ncy5qb2luLmpvaW5GZWF0dXJlc1RvLnJlcGxhY2UoXCIke25hbWV9XCIsIHRhcmdldEl0ZW0udGl0bGUpICtcbiAgICBgJHt2aWV3SXRlbXMubGVuZ3RoID8gYCAke3ZpZXdJdGVtcy5sZW5ndGggKyAxfWAgOiBgYH0gJHtzdHJpbmdzLmNyZWF0ZVZpZXcudmlld31gKTtcbn1cbi8qKlxuICogQ3JlYXRlcyBqb2luIGxheWVyIHZpZXdcbiAqIEBwYXJhbSBwcm9wcyAtIExheWVyVmlld0pvaW5Qcm9wc1xuICogQHBhcmFtIG5ld0l0ZW1Qcm9wcyAtIHVzZXIgaW5wdXQgKE5ld0l0ZW1Qcm9wcylcbiAqL1xuYXN5bmMgZnVuY3Rpb24gY3JlYXRlSm9pblZpZXcocHJvcHMsIG5ld0l0ZW1Qcm9wcykge1xuICBjb25zdCB7IHRhcmdldEl0ZW0sIHRhcmdldExheWVyLCB0YXJnZXRMYXllcklkLCBhZGRMYXllciwgYWRkTGF5ZXJJZCB9ID0gcHJvcHM7XG4gIGNvbnN0IGlzUG9ydGFsID0gdGFyZ2V0SXRlbS5wb3J0YWwuaXNQb3J0YWw7XG4gIGNvbnN0IHRpbWVTdGFtcCA9IERhdGUubm93KCk7XG4gIGNvbnN0IHRhcmdldEZMID0gKHRhcmdldExheWVyLnR5cGUgPT09IFwiZ3JvdXBcIlxuICAgID8gZ2V0TGF5ZXJzQW5kVGFibGVzKHRhcmdldExheWVyKS5maW5kKChseXIpID0+IGx5ci5sYXllcklkID09PSB0YXJnZXRMYXllcklkKVxuICAgIDogdGFyZ2V0TGF5ZXIpO1xuICBjb25zdCBhZGRGTCA9IChhZGRMYXllci50eXBlID09PSBcImdyb3VwXCJcbiAgICA/IGdldExheWVyc0FuZFRhYmxlcyhhZGRMYXllcikuZmluZCgobHlyKSA9PiBseXIubGF5ZXJJZCA9PT0gYWRkTGF5ZXJJZClcbiAgICA6IGFkZExheWVyKTtcbiAgdHJ5IHtcbiAgICBhd2FpdCBnZXRBZG1pblNlcnZpY2VJbmZvKHByb3BzKTtcbiAgICBpZiAoIWlzUG9ydGFsKSB7XG4gICAgICBhd2FpdCBjcmVhdGVJbmRleGVzKHByb3BzKTtcbiAgICB9XG4gICAgY29uc3QgY3JlYXRlU2VydmljZVJlc3BvbnNlID0gYXdhaXQgY3JlYXRlSm9pblNlcnZpY2UocHJvcHMsIG5ld0l0ZW1Qcm9wcyk7XG4gICAgY29uc3QgcHJvY2Vzc1Byb3BzID0geyBuZXdJdGVtUHJvcHMsIGNyZWF0ZVNlcnZpY2VSZXNwb25zZSwgdGltZVN0YW1wLCB0YXJnZXRGTCwgYWRkRkwgfTtcbiAgICBhd2FpdCBhZGRUb0RlZmluaXRpb25TdGF0c1RhYmxlKHByb3BzLCBwcm9jZXNzUHJvcHMpO1xuICAgIGF3YWl0IGFkZFRvRGVmaW5pdGlvbkF0dHJpYnV0ZUpvaW4ocHJvcHMsIHByb2Nlc3NQcm9wcyk7XG4gICAgYXdhaXQgam9pbkl0ZW1VcGRhdGUocHJvcHMsIHByb2Nlc3NQcm9wcyk7XG4gICAgcmV0dXJuIGNyZWF0ZVNlcnZpY2VSZXNwb25zZS5pdGVtSWQ7XG4gIH1cbiAgY2F0Y2ggKGUpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKF8sIHJlamVjdCkgPT4ge1xuICAgICAgcmVqZWN0KG5ldyBFcnJvcihcImNyZWF0ZUpvaW5WaWV3IGZhaWxlZFwiKSk7XG4gICAgfSk7XG4gIH1cbn1cbmFzeW5jIGZ1bmN0aW9uIGNyZWF0ZUpvaW5TZXJ2aWNlKHByb3BzLCBuZXdJdGVtUHJvcHMpIHtcbiAgY29uc3QgeyB0YXJnZXRJdGVtLCBtb2R1bGVzIH0gPSBwcm9wcztcbiAgY29uc3QgeyBlc3JpUmVxdWVzdCB9ID0gbW9kdWxlcztcbiAgY29uc3QgeyBmb2xkZXIgfSA9IG5ld0l0ZW1Qcm9wcztcbiAgY29uc3QgaXNPd25lckZvbGRlciA9ICFmb2xkZXIgfHwgIWZvbGRlci5pZCB8fCBmb2xkZXIuaWQgPT09IHRhcmdldEl0ZW0ub3duZXI7XG4gIGNvbnN0IHBvcnRhbCA9IHRhcmdldEl0ZW0ucG9ydGFsO1xuICBjb25zdCBjcmVhdGVTZXJ2aWNlVXJsID0gYCR7cG9ydGFsLnJlc3RVcmx9L2NvbnRlbnQvdXNlcnMvJHt0YXJnZXRJdGVtLm93bmVyfSR7IWlzT3duZXJGb2xkZXIgPyBgLyR7Zm9sZGVyLmlkfWAgOiBcIlwifS9jcmVhdGVTZXJ2aWNlYDtcbiAgLy8gbm90IHN1cmUgd2h5IHdlIG5lZWQgdG8gc2VuZCBhbGwgdGhpcyBpbi4uLlxuICBjb25zdCBjcmVhdGVQYXJhbXMgPSB7XG4gICAgc2VydmljZURlc2NyaXB0aW9uOiBcIlwiLFxuICAgIGhhc1ZlcnNpb25lZERhdGE6IGZhbHNlLFxuICAgIHN1cHBvcnRzRGlzY29ubmVjdGVkRWRpdGluZzogZmFsc2UsXG4gICAgaGFzU3RhdGljRGF0YTogdHJ1ZSxcbiAgICBtYXhSZWNvcmRDb3VudDogMjAwMCxcbiAgICBzdXBwb3J0ZWRRdWVyeUZvcm1hdHM6IFwiSlNPTlwiLFxuICAgIGNhcGFiaWxpdGllczogXCJRdWVyeVwiLFxuICAgIGRlc2NyaXB0aW9uOiBcIlwiLFxuICAgIGNvcHlyaWdodFRleHQ6IFwiXCIsXG4gICAgYWxsb3dHZW9tZXRyeVVwZGF0ZXM6IGZhbHNlLFxuICAgIC8vIHRoaXMgY2F1c2VzIGlzc3VlcyBpbiByZXN1bHQgbGF5ZXIgd2hlbiB1c2VkIGluIG5ldHdvcmsgdG9vbHMgXCJ1bml0c1wiOlwiZXNyaU1ldGVyc1wiLFxuICAgIHN5bmNFbmFibGVkOiBmYWxzZSxcbiAgICBlZGl0b3JUcmFja2luZ0luZm86IHtcbiAgICAgIGVuYWJsZUVkaXRvclRyYWNraW5nOiBmYWxzZSxcbiAgICAgIGVuYWJsZU93bmVyc2hpcEFjY2Vzc0NvbnRyb2w6IGZhbHNlLFxuICAgICAgYWxsb3dPdGhlcnNUb1VwZGF0ZTogdHJ1ZSxcbiAgICAgIGFsbG93T3RoZXJzVG9EZWxldGU6IHRydWVcbiAgICB9LFxuICAgIHhzc1ByZXZlbnRpb25JbmZvOiB7XG4gICAgICB4c3NQcmV2ZW50aW9uRW5hYmxlZDogdHJ1ZSxcbiAgICAgIHhzc1ByZXZlbnRpb25SdWxlOiBcIklucHV0T25seVwiLFxuICAgICAgeHNzSW5wdXRSdWxlOiBcInJlamVjdEludmFsaWRcIlxuICAgIH0sXG4gICAgdGFibGVzOiBbXSxcbiAgICBuYW1lOiBuZXdJdGVtUHJvcHMudGl0bGUucmVwbGFjZSgvIC9nLCBcIl9cIilcbiAgfTtcbiAgaWYgKHBvcnRhbC5pc1BvcnRhbCkge1xuICAgIGNvbnN0IGRhdGFTb3VyY2VUeXBlID0gYXdhaXQgZ2V0RGF0YVNvdXJjZVR5cGUocHJvcHMpO1xuICAgIGlmIChkYXRhU291cmNlVHlwZSkge1xuICAgICAgY3JlYXRlUGFyYW1zLm9wdGlvbnMgPSB7IGRhdGFTb3VyY2VUeXBlIH07XG4gICAgfVxuICB9XG4gIGxldCBjcmVhdGVTZXJ2aWNlQ29udGVudCA9IHtcbiAgICBjcmVhdGVQYXJhbWV0ZXJzOiBKU09OLnN0cmluZ2lmeShjcmVhdGVQYXJhbXMpLFxuICAgIG91dHB1dFR5cGU6IFwiZmVhdHVyZVNlcnZpY2VcIlxuICB9O1xuICB0cnkge1xuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZXNyaVJlcXVlc3QoY3JlYXRlU2VydmljZVVybCwge1xuICAgICAgcXVlcnk6IE9iamVjdC5hc3NpZ24oT2JqZWN0LmFzc2lnbih7fSwgY3JlYXRlU2VydmljZUNvbnRlbnQpLCB7IGY6IFwianNvblwiLCBpc1ZpZXc6IHRydWUsIHRva2VuOiBwb3J0YWwuY3JlZGVudGlhbC50b2tlbiB9KSxcbiAgICAgIG1ldGhvZDogXCJwb3N0XCIsXG4gICAgICByZXNwb25zZVR5cGU6IFwianNvblwiXG4gICAgfSk7XG4gICAgcmV0dXJuIHJlc3BvbnNlLmRhdGE7XG4gIH1cbiAgY2F0Y2ggKGUpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKF8sIHJlamVjdCkgPT4ge1xuICAgICAgcmVqZWN0KG5ldyBFcnJvcihcImNyZWF0ZSBzZXJ2aWNlIGZhaWxlZFwiKSk7XG4gICAgfSk7XG4gIH1cbn1cbmFzeW5jIGZ1bmN0aW9uIGFkZFRvRGVmaW5pdGlvblN0YXRzVGFibGUocHJvcHMsIHByb2Nlc3NQcm9wcykge1xuICBjb25zdCB7IGNyZWF0ZVNlcnZpY2VSZXNwb25zZSwgYWRkRkwsIHRpbWVTdGFtcCB9ID0gcHJvY2Vzc1Byb3BzO1xuICBjb25zdCB7IGFkZExheWVySWQsIGpvaW5PcGVyYXRpb24sIGF0dHJpYnV0ZVJlbGF0aW9uc2hpcHMgfSA9IHByb3BzO1xuICBpZiAoam9pbk9wZXJhdGlvbi50eXBlICE9PSBcIm9uZS10by1vbmVcIiB8fCBqb2luT3BlcmF0aW9uLm1hdGNoVHlwZSAhPT0gXCJzdW1tYXJpemVcIikge1xuICAgIHJldHVybjtcbiAgfVxuICB0cnkge1xuICAgIGNvbnN0IGFkbWluVXJsID0gY3JlYXRlU2VydmljZVJlc3BvbnNlLnNlcnZpY2V1cmwucmVwbGFjZShcInJlc3Qvc2VydmljZXNcIiwgXCJyZXN0L2FkbWluL3NlcnZpY2VzXCIpO1xuICAgIGNvbnN0IGF0dHJpYnV0ZUZpZWxkcyA9IGF0dHJpYnV0ZVJlbGF0aW9uc2hpcHMubWFwKChyZWwpID0+IHtcbiAgICAgIHZhciBfYTtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIG5hbWU6IHJlbC5hZGRGaWVsZE5hbWUsXG4gICAgICAgIGFsaWFzOiAoKF9hID0gYWRkRkwuZmllbGRzLmZpbmQoKGZpZWxkKSA9PiBmaWVsZC5uYW1lID09PSByZWwuYWRkRmllbGROYW1lKSkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmFsaWFzKSB8fCByZWwuYWRkRmllbGROYW1lLFxuICAgICAgICBzb3VyY2U6IHJlbC5hZGRGaWVsZE5hbWVcbiAgICAgIH07XG4gICAgfSk7XG4gICAgY29uc3Qgc3VtbWFyaXplRmllbGRzID0gW107XG4gICAgam9pbk9wZXJhdGlvbi5zdGF0aXN0aWNzRmllbGRzLmZvckVhY2goKHN0YXRzRmllbGQpID0+IHtcbiAgICAgIHN0YXRzRmllbGQudHlwZXMuZm9yRWFjaCgoc3RhdHNUeXBlKSA9PiB7XG4gICAgICAgIGNvbnN0IHR5cGUgPSBzdGF0c1R5cGUudG9Mb3dlckNhc2UoKTtcbiAgICAgICAgc3VtbWFyaXplRmllbGRzLnB1c2goe1xuICAgICAgICAgIG5hbWU6IGAke3N0YXRzRmllbGQuZmllbGROYW1lfV8ke3R5cGV9YCxcbiAgICAgICAgICBhbGlhczogYCR7c3RhdHNGaWVsZC5maWVsZE5hbWV9XyR7dHlwZX1gLFxuICAgICAgICAgIHNvdXJjZTogc3RhdHNGaWVsZC5maWVsZE5hbWUsXG4gICAgICAgICAgc3RhdGlzdGljVHlwZTogdHlwZSA9PT0gXCJtZWFuXCIgPyBcImF2Z1wiIDogdHlwZVxuICAgICAgICB9KTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICAgIGNvbnN0IGpzb24gPSB7XG4gICAgICBsYXllcnM6IFtcbiAgICAgICAge1xuICAgICAgICAgIG5hbWU6IGAke2dldFNvdXJjZVNlcnZpY2VOYW1lKGFkZEZMLnVybCwgcHJvcHMpfV9TdGF0c1RhYmxlYCxcbiAgICAgICAgICBkZXNjcmlwdGlvbjogXCJ0YWJsZXN0YXRzam9pblwiLFxuICAgICAgICAgIGFkbWluTGF5ZXJJbmZvOiB7XG4gICAgICAgICAgICB2aWV3TGF5ZXJEZWZpbml0aW9uOiB7XG4gICAgICAgICAgICAgIHRhYmxlOiB7XG4gICAgICAgICAgICAgICAgbWF0ZXJpYWxpemVkOiBmYWxzZSxcbiAgICAgICAgICAgICAgICBuYW1lOiBgJHtnZXRTb3VyY2VTZXJ2aWNlTmFtZShhZGRGTC51cmwsIHByb3BzKX1fJHt0aW1lU3RhbXB9X1N0YXRzVGFibGVgLFxuICAgICAgICAgICAgICAgIHNvdXJjZVNlcnZpY2VOYW1lOiBnZXRTb3VyY2VTZXJ2aWNlTmFtZShhZGRGTC51cmwsIHByb3BzKSxcbiAgICAgICAgICAgICAgICBzb3VyY2VMYXllcklkOiBhZGRMYXllcklkLFxuICAgICAgICAgICAgICAgIHNvdXJjZUxheWVyRmllbGRzOiBbXG4gICAgICAgICAgICAgICAgICAuLi5hdHRyaWJ1dGVGaWVsZHMsXG4gICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgIG5hbWU6IFwiam9pbl9jb3VudFwiLFxuICAgICAgICAgICAgICAgICAgICBhbGlhczogXCJqb2luX2NvdW50XCIsXG4gICAgICAgICAgICAgICAgICAgIHNvdXJjZTogam9pbk9wZXJhdGlvbi5zdGF0aXN0aWNzRmllbGRzWzBdLmZpZWxkTmFtZSxcbiAgICAgICAgICAgICAgICAgICAgc3RhdGlzdGljVHlwZTogXCJjb3VudFwiXG4gICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgLi4uc3VtbWFyaXplRmllbGRzXG4gICAgICAgICAgICAgICAgXSxcbiAgICAgICAgICAgICAgICBncm91cEJ5OiBhdHRyaWJ1dGVSZWxhdGlvbnNoaXBzLm1hcCgocmVsKSA9PiByZWwuYWRkRmllbGROYW1lKS5qb2luKFwiLFwiKVxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICBdXG4gICAgfTtcbiAgICBhd2FpdCBhZGRUb0RlZmluaXRpb25SZXF1ZXN0KGAke2FkbWluVXJsfS9hZGRUb0RlZmluaXRpb25gLCBqc29uLCBwcm9wcyk7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7XG4gICAgICByZXNvbHZlKCk7XG4gICAgfSk7XG4gIH1cbiAgY2F0Y2ggKGUpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKF8sIHJlamVjdCkgPT4ge1xuICAgICAgcmVqZWN0KG5ldyBFcnJvcihcImFkZFRvRGVmaW5pdGlvbiBTdGF0c1RhYmxlIGZhaWxlZFwiKSk7XG4gICAgfSk7XG4gIH1cbn1cbmFzeW5jIGZ1bmN0aW9uIGFkZFRvRGVmaW5pdGlvbkF0dHJpYnV0ZUpvaW4ocHJvcHMsIHByb2Nlc3NQcm9wcykge1xuICBjb25zdCB7IGNyZWF0ZVNlcnZpY2VSZXNwb25zZSwgbmV3SXRlbVByb3BzLCB0YXJnZXRGTCwgYWRkRkwsIHRpbWVTdGFtcCB9ID0gcHJvY2Vzc1Byb3BzO1xuICB0cnkge1xuICAgIGNvbnN0IGFkbWluVXJsID0gY3JlYXRlU2VydmljZVJlc3BvbnNlLnNlcnZpY2V1cmwucmVwbGFjZShcInJlc3Qvc2VydmljZXNcIiwgXCJyZXN0L2FkbWluL3NlcnZpY2VzXCIpO1xuICAgIGNvbnN0IGpzb24gPSBnZXRBdHRyaWJ1dGVKb2luSlNPTihwcm9wcywgbmV3SXRlbVByb3BzLCB0YXJnZXRGTCwgYWRkRkwsIHRpbWVTdGFtcCk7XG4gICAgYXdhaXQgYWRkVG9EZWZpbml0aW9uUmVxdWVzdChgJHthZG1pblVybH0vYWRkVG9EZWZpbml0aW9uYCwganNvbiwgcHJvcHMpO1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4ge1xuICAgICAgcmVzb2x2ZSgpO1xuICAgIH0pO1xuICB9XG4gIGNhdGNoIChlKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChfLCByZWplY3QpID0+IHtcbiAgICAgIHJlamVjdChuZXcgRXJyb3IoXCJhZGRUb0RlZmluaXRpb24gQXR0cmlidXRlSm9pbiBmYWlsZWRcIikpO1xuICAgIH0pO1xuICB9XG59XG5mdW5jdGlvbiBnZXRBdHRyaWJ1dGVKb2luSlNPTihwcm9wcywgbmV3SXRlbVByb3BzLCB0YXJnZXRGTCwgYWRkRkwsIHRpbWVTdGFtcCkge1xuICBjb25zdCB7IHRhcmdldExheWVySWQsIGFkZExheWVySWQsIGpvaW5PcGVyYXRpb24sIGF0dHJpYnV0ZVJlbGF0aW9uc2hpcHMsIGFkbWluU2VydmljZUluZm8gfSA9IHByb3BzO1xuICBjb25zdCBhdHRyaWJ1dGVGaWVsZHMgPSBhdHRyaWJ1dGVSZWxhdGlvbnNoaXBzLm1hcCgocmVsKSA9PiB7XG4gICAgdmFyIF9hO1xuICAgIHJldHVybiB7XG4gICAgICBuYW1lOiByZWwuYWRkRmllbGROYW1lLFxuICAgICAgYWxpYXM6ICgoX2EgPSBhZGRGTC5maWVsZHMuZmluZCgoZmllbGQpID0+IGZpZWxkLm5hbWUgPT09IHJlbC5hZGRGaWVsZE5hbWUpKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EuYWxpYXMpIHx8IHJlbC5hZGRGaWVsZE5hbWUsXG4gICAgICBzb3VyY2U6IHJlbC5hZGRGaWVsZE5hbWVcbiAgICB9O1xuICB9KTtcbiAgbGV0IHN1bW1hcml6ZUZpZWxkcztcbiAgaWYgKGpvaW5PcGVyYXRpb24udHlwZSA9PT0gXCJvbmUtdG8tb25lXCIgJiYgam9pbk9wZXJhdGlvbi5tYXRjaFR5cGUgPT09IFwic3VtbWFyaXplXCIpIHtcbiAgICBzdW1tYXJpemVGaWVsZHMgPSBbXTtcbiAgICBqb2luT3BlcmF0aW9uLnN0YXRpc3RpY3NGaWVsZHMuZm9yRWFjaCgoc3RhdHNGaWVsZCkgPT4ge1xuICAgICAgc3RhdHNGaWVsZC50eXBlcy5mb3JFYWNoKChzdGF0c1R5cGUpID0+IHtcbiAgICAgICAgY29uc3QgdHlwZSA9IHN0YXRzVHlwZS50b0xvd2VyQ2FzZSgpO1xuICAgICAgICBzdW1tYXJpemVGaWVsZHMucHVzaCh7XG4gICAgICAgICAgbmFtZTogYCR7c3RhdHNGaWVsZC5maWVsZE5hbWV9XyR7dHlwZX1gLFxuICAgICAgICAgIGFsaWFzOiBgJHtzdGF0c0ZpZWxkLmZpZWxkTmFtZX1fJHt0eXBlfWAsXG4gICAgICAgICAgc291cmNlOiBgJHtzdGF0c0ZpZWxkLmZpZWxkTmFtZX1fJHt0eXBlfWBcbiAgICAgICAgfSk7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxuICBjb25zdCBqc29uID0ge307XG4gIGpzb24ubmFtZSA9IG5ld0l0ZW1Qcm9wcy50aXRsZS5yZXBsYWNlKC8gL2csIFwiX1wiKTtcbiAganNvbi5kaXNwbGF5RmllbGQgPSBcIlwiO1xuICBqc29uLmRlc2NyaXB0aW9uID0gXCJBdHRyaWJ1dGVKb2luXCI7XG4gIGpzb24uYWRtaW5MYXllckluZm8gPSB7XG4gICAgdmlld0xheWVyRGVmaW5pdGlvbjoge1xuICAgICAgdGFibGU6IHtcbiAgICAgICAgbmFtZTogYCR7Z2V0U291cmNlU2VydmljZU5hbWUodGFyZ2V0RkwudXJsLCBwcm9wcyl9XyR7dGltZVN0YW1wfV90YXJnZXRgLFxuICAgICAgICBzb3VyY2VTZXJ2aWNlTmFtZTogZ2V0U291cmNlU2VydmljZU5hbWUodGFyZ2V0RkwudXJsLCBwcm9wcyksXG4gICAgICAgIHNvdXJjZUxheWVySWQ6IHRhcmdldExheWVySWQsXG4gICAgICAgIHNvdXJjZUxheWVyRmllbGRzOiB0YXJnZXRGTC5maWVsZHNcbiAgICAgICAgICAuZmlsdGVyKChmaWVsZCkgPT4gZmllbGQudHlwZSAhPT0gXCJvaWRcIilcbiAgICAgICAgICAubWFwKChmaWVsZCkgPT4ge1xuICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBuYW1lOiBmaWVsZC5uYW1lLFxuICAgICAgICAgICAgYWxpYXM6IGZpZWxkLmFsaWFzLFxuICAgICAgICAgICAgc291cmNlOiBmaWVsZC5uYW1lXG4gICAgICAgICAgfTtcbiAgICAgICAgfSksXG4gICAgICAgIHJlbGF0ZWRUYWJsZXM6IFtcbiAgICAgICAgICBqb2luT3BlcmF0aW9uLnR5cGUgPT09IFwib25lLXRvLW9uZVwiICYmIGpvaW5PcGVyYXRpb24ubWF0Y2hUeXBlID09PSBcInN1bW1hcml6ZVwiXG4gICAgICAgICAgICA/IHtcbiAgICAgICAgICAgICAgbmFtZTogYCR7Z2V0U291cmNlU2VydmljZU5hbWUoYWRkRkwudXJsLCBwcm9wcyl9X1N0YXRzVGFibGVgLFxuICAgICAgICAgICAgICBzb3VyY2VTZXJ2aWNlTmFtZTogbmV3SXRlbVByb3BzLnRpdGxlLnJlcGxhY2UoLyAvZywgXCJfXCIpLFxuICAgICAgICAgICAgICBzb3VyY2VMYXllcklkOiAwLFxuICAgICAgICAgICAgICBzb3VyY2VMYXllckZpZWxkczogW1xuICAgICAgICAgICAgICAgIC4uLmF0dHJpYnV0ZUZpZWxkcy5maWx0ZXIoKGF0dHJGaWVsZCkgPT4gIWF0dHJpYnV0ZVJlbGF0aW9uc2hpcHMuc29tZSgocmVsKSA9PiBhdHRyRmllbGQubmFtZSA9PT0gcmVsLmFkZEZpZWxkTmFtZSkpLFxuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgIG5hbWU6IFwiam9pbl9jb3VudFwiLFxuICAgICAgICAgICAgICAgICAgYWxpYXM6IFwiam9pbl9jb3VudFwiLFxuICAgICAgICAgICAgICAgICAgc291cmNlOiBcImpvaW5fY291bnRcIlxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgLi4uc3VtbWFyaXplRmllbGRzXG4gICAgICAgICAgICAgIF0sXG4gICAgICAgICAgICAgIHR5cGU6IGpvaW5PcGVyYXRpb24uam9pblR5cGUsXG4gICAgICAgICAgICAgIHBhcmVudEtleUZpZWxkczogYXR0cmlidXRlUmVsYXRpb25zaGlwcy5tYXAoKHJlbCkgPT4gcmVsLnRhcmdldEZpZWxkTmFtZSksXG4gICAgICAgICAgICAgIGtleUZpZWxkczogYXR0cmlidXRlUmVsYXRpb25zaGlwcy5tYXAoKHJlbCkgPT4gcmVsLmFkZEZpZWxkTmFtZSlcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIDoge1xuICAgICAgICAgICAgICBuYW1lOiBgJHtnZXRTb3VyY2VTZXJ2aWNlTmFtZShhZGRGTC51cmwsIHByb3BzKX1fJHt0aW1lU3RhbXB9X2pvaW5gLFxuICAgICAgICAgICAgICBzb3VyY2VTZXJ2aWNlTmFtZTogZ2V0U291cmNlU2VydmljZU5hbWUoYWRkRkwudXJsLCBwcm9wcyksXG4gICAgICAgICAgICAgIHNvdXJjZUxheWVySWQ6IGFkZExheWVySWQsXG4gICAgICAgICAgICAgIHNvdXJjZUxheWVyRmllbGRzOiBhZGRGTC5maWVsZHNcbiAgICAgICAgICAgICAgICAuZmlsdGVyKChhZGRGaWVsZCkgPT4gYWRkRmllbGQudHlwZSAhPT0gXCJvaWRcIilcbiAgICAgICAgICAgICAgICAubWFwKChhZGRGaWVsZCkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IGlzVGFrZW4gPSB0YXJnZXRGTC5maWVsZHMuZmluZCgodGFyZ2V0RmllbGQpID0+IHRhcmdldEZpZWxkLm5hbWUgPT09IGFkZEZpZWxkLm5hbWUpO1xuICAgICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgICBuYW1lOiBpc1Rha2VuID8gYCR7YWRkRmllbGQubmFtZX1fJHt0aW1lU3RhbXB9YCA6IGFkZEZpZWxkLm5hbWUsXG4gICAgICAgICAgICAgICAgICBhbGlhczogYWRkRmllbGQuYWxpYXMsXG4gICAgICAgICAgICAgICAgICBzb3VyY2U6IGFkZEZpZWxkLm5hbWVcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgdHlwZTogam9pbk9wZXJhdGlvbi5qb2luVHlwZSxcbiAgICAgICAgICAgICAgcGFyZW50S2V5RmllbGRzOiBhdHRyaWJ1dGVSZWxhdGlvbnNoaXBzLm1hcCgocmVsKSA9PiByZWwudGFyZ2V0RmllbGROYW1lKSxcbiAgICAgICAgICAgICAga2V5RmllbGRzOiBhdHRyaWJ1dGVSZWxhdGlvbnNoaXBzLm1hcCgocmVsKSA9PiByZWwuYWRkRmllbGROYW1lKSxcbiAgICAgICAgICAgICAgdG9wRmlsdGVyOiBqb2luT3BlcmF0aW9uLnR5cGUgPT09IFwib25lLXRvLW9uZVwiICYmIGpvaW5PcGVyYXRpb24ubWF0Y2hUeXBlID09PSBcImZpcnN0XCJcbiAgICAgICAgICAgICAgICA/IHtcbiAgICAgICAgICAgICAgICAgIGdyb3VwQnlGaWVsZHM6IGF0dHJpYnV0ZVJlbGF0aW9uc2hpcHNcbiAgICAgICAgICAgICAgICAgICAgLm1hcCgocmVsKSA9PiByZWwuYWRkRmllbGROYW1lKVxuICAgICAgICAgICAgICAgICAgICAuam9pbihcIixcIiksXG4gICAgICAgICAgICAgICAgICBvcmRlckJ5RmllbGRzOiBgJHtqb2luT3BlcmF0aW9uLnNvcnRCeUZpZWxkTmFtZX0gJHtqb2luT3BlcmF0aW9uLnNvcnRPcmRlcn1gLFxuICAgICAgICAgICAgICAgICAgdG9wQ291bnQ6IDFcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgOiB1bmRlZmluZWRcbiAgICAgICAgICAgIH1cbiAgICAgICAgXSxcbiAgICAgICAgbWF0ZXJpYWxpemVkOiBmYWxzZVxuICAgICAgfVxuICAgIH0sXG4gICAgZ2VvbWV0cnlGaWVsZDogdGFyZ2V0RkwuaXNUYWJsZVxuICAgICAgPyBudWxsXG4gICAgICA6IHtcbiAgICAgICAgbmFtZTogYCR7Z2V0U291cmNlU2VydmljZU5hbWUodGFyZ2V0RkwudXJsLCBwcm9wcyl9XyR7dGltZVN0YW1wfV90YXJnZXQuJHthZG1pblNlcnZpY2VJbmZvLmxheWVycy5maW5kKChseXIpID0+IGx5ci5pZCA9PT0gdGFyZ2V0TGF5ZXJJZCkuYWRtaW5MYXllckluZm8uZ2VvbWV0cnlGaWVsZC5uYW1lfWBcbiAgICAgIH1cbiAgfTtcbiAgLyogbm90IHN1cmUgd2h5IHdlIHNlbmQgYWxsIHZpYSBsYXllcnMuLi5cbiAgbGV0IGxheWVycywgdGFibGVzO1xuICBpZiAodGFyZ2V0RkwuaXNUYWJsZSkge1xuICAgIHRhYmxlcyA9IFtqc29uXTtcbiAgfSBlbHNlIHtcbiAgICBsYXllcnMgPSBbanNvbl07XG4gIH1cblxuICByZXR1cm4ge1xuICAgIGxheWVyczogbGF5ZXJzLFxuICAgIHRhYmxlczogdGFibGVzXG4gIH07ICovXG4gIHJldHVybiB7XG4gICAgbGF5ZXJzOiBbanNvbl1cbiAgfTtcbn1cbmFzeW5jIGZ1bmN0aW9uIGFkZFRvRGVmaW5pdGlvblJlcXVlc3QoYWRkVG9EZWZVcmwsIGpzb24sIHByb3BzLCByZXRyeSA9IGZhbHNlKSB7XG4gIGNvbnN0IHsgbW9kdWxlcyB9ID0gcHJvcHM7XG4gIGNvbnN0IHsgZXNyaVJlcXVlc3QsIElkZW50aXR5TWFuYWdlciB9ID0gbW9kdWxlcztcbiAgLy8gYWRkVG9EZWZVcmwgc2FtZSBzZXJ2ZXIgYXMgdGFyZ2V0TGF5ZXJcbiAgY29uc3QgY3JlZGVudGlhbCA9IElkZW50aXR5TWFuYWdlci5maW5kQ3JlZGVudGlhbChhZGRUb0RlZlVybCk7XG4gIGNvbnN0IGFkZFRvRGVmQ29udGVudCA9IHtcbiAgICBhZGRUb0RlZmluaXRpb246IEpTT04uc3RyaW5naWZ5KGpzb24pXG4gIH07XG4gIHRyeSB7XG4gICAgYXdhaXQgZXNyaVJlcXVlc3QoYWRkVG9EZWZVcmwsIHtcbiAgICAgIHF1ZXJ5OiBPYmplY3QuYXNzaWduKE9iamVjdC5hc3NpZ24oe30sIGFkZFRvRGVmQ29udGVudCksIHsgZjogXCJqc29uXCIsIHRva2VuOiBjcmVkZW50aWFsLnRva2VuIH0pLFxuICAgICAgbWV0aG9kOiBcInBvc3RcIixcbiAgICAgIHJlc3BvbnNlVHlwZTogXCJqc29uXCJcbiAgICB9KTtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcbiAgICAgIHJlc29sdmUoKTtcbiAgICB9KTtcbiAgfVxuICBjYXRjaCAoZSkge1xuICAgIGlmICghcmV0cnkpIHtcbiAgICAgIC8vIGluIGNhc2UgaXQncyBqdXN0IGEgZmx1a2VcbiAgICAgIHJldHVybiBhZGRUb0RlZmluaXRpb25SZXF1ZXN0KGFkZFRvRGVmVXJsLCBqc29uLCBwcm9wcywgdHJ1ZSk7XG4gICAgfVxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgoXywgcmVqZWN0KSA9PiB7XG4gICAgICByZWplY3QobmV3IEVycm9yKFwiYWRkVG9EZWZpbml0aW9uIHJlcXVlc3QgZmFpbGVkXCIpKTtcbiAgICB9KTtcbiAgfVxufVxuZnVuY3Rpb24gZ2V0U291cmNlU2VydmljZU5hbWUodXJsLCBwcm9wcykge1xuICBjb25zdCB7IHRhcmdldEl0ZW0gfSA9IHByb3BzO1xuICBjb25zdCB7IHBvcnRhbCB9ID0gdGFyZ2V0SXRlbTtcbiAgY29uc3QgcG9zID0gdXJsLmluZGV4T2YoXCIvc2VydmljZXMvXCIpICsgXCIvc2VydmljZXMvXCIubGVuZ3RoO1xuICB2YXIgc2VydmljZU5hbWUgPSB1cmwuc3Vic3RyaW5nKHBvcywgdXJsLmluZGV4T2YoXCIvRmVhdHVyZVNlcnZlclwiLCBwb3MpKTtcbiAgaWYgKHBvcnRhbC5pc1BvcnRhbCkge1xuICAgIHNlcnZpY2VOYW1lID0gc2VydmljZU5hbWUucmVwbGFjZShcIkhvc3RlZC9cIiwgXCJcIik7XG4gIH1cbiAgcmV0dXJuIHNlcnZpY2VOYW1lO1xufVxuYXN5bmMgZnVuY3Rpb24gam9pbkl0ZW1VcGRhdGUocHJvcHMsIHByb2Nlc3NQcm9wcykge1xuICB2YXIgX2EsIF9iO1xuICBjb25zdCB7IGNyZWF0ZVNlcnZpY2VSZXNwb25zZSwgbmV3SXRlbVByb3BzIH0gPSBwcm9jZXNzUHJvcHM7XG4gIGNvbnN0IHsgdGFyZ2V0SXRlbSwgbW9kdWxlcyB9ID0gcHJvcHM7XG4gIGNvbnN0IHsgZXNyaVJlcXVlc3QgfSA9IG1vZHVsZXM7XG4gIGNvbnN0IHBvcnRhbCA9IHRhcmdldEl0ZW0ucG9ydGFsO1xuICBjb25zdCB1cGRhdGVVcmwgPSBgJHtwb3J0YWwucmVzdFVybH0vY29udGVudC91c2Vycy8ke3RhcmdldEl0ZW0ub3duZXJ9L2l0ZW1zLyR7Y3JlYXRlU2VydmljZVJlc3BvbnNlLml0ZW1JZH0vdXBkYXRlYDtcbiAgLy8gbmVlZCB0byBzZW5kIHNvbWUgaW5mbyBhZ2FpblxuICBjb25zdCB1cGRhdGVDb250ZW50ID0ge1xuICAgIHRpdGxlOiBuZXdJdGVtUHJvcHMudGl0bGUsXG4gICAgdGFnczogKChfYSA9IG5ld0l0ZW1Qcm9wcy50YWdzKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EubGVuZ3RoKSA/IG5ld0l0ZW1Qcm9wcy50YWdzLnRvU3RyaW5nKCkgOiB1bmRlZmluZWQsXG4gICAgc25pcHBldDogbmV3SXRlbVByb3BzLnN1bW1hcnksXG4gICAgY2F0ZWdvcmllczogKF9iID0gbmV3SXRlbVByb3BzLmNhdGVnb3JpZXMpID09PSBudWxsIHx8IF9iID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYi5qb2luKFwiLFwiKVxuICB9O1xuICBpZiAocG9ydGFsLmlzUG9ydGFsKSB7XG4gICAgdXBkYXRlQ29udGVudC50eXBlS2V5d29yZHMgPSBcIk11bHRpIFNlcnZpY2VzIFZpZXdcIjtcbiAgfVxuICB0cnkge1xuICAgIHJldHVybiBhd2FpdCBlc3JpUmVxdWVzdCh1cGRhdGVVcmwsIHtcbiAgICAgIHF1ZXJ5OiBPYmplY3QuYXNzaWduKE9iamVjdC5hc3NpZ24oe30sIHVwZGF0ZUNvbnRlbnQpLCB7IGY6IFwianNvblwiLCB0b2tlbjogcG9ydGFsLmNyZWRlbnRpYWwudG9rZW4gfSksXG4gICAgICBtZXRob2Q6IFwicG9zdFwiLFxuICAgICAgcmVzcG9uc2VUeXBlOiBcImpzb25cIlxuICAgIH0pO1xuICB9XG4gIGNhdGNoIChlKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChfLCByZWplY3QpID0+IHtcbiAgICAgIHJlamVjdChuZXcgRXJyb3IoXCJpdGVtIHVwZGF0ZSByZXF1ZXN0IGZhaWxlZFwiKSk7XG4gICAgfSk7XG4gIH1cbn1cbmFzeW5jIGZ1bmN0aW9uIGdldERhdGFTb3VyY2VUeXBlKHByb3BzKSB7XG4gIHZhciBfYSwgX2IsIF9jLCBfZDtcbiAgYXdhaXQgZ2V0QWRtaW5TZXJ2aWNlSW5mbyhwcm9wcyk7XG4gIGNvbnN0IHsgYWRtaW5TZXJ2aWNlSW5mbyB9ID0gcHJvcHM7XG4gIGNvbnN0IGRhdGFTb3VyY2UgPSAoKF9iID0gKF9hID0gYWRtaW5TZXJ2aWNlSW5mbyA9PT0gbnVsbCB8fCBhZG1pblNlcnZpY2VJbmZvID09PSB2b2lkIDAgPyB2b2lkIDAgOiBhZG1pblNlcnZpY2VJbmZvLmFkbWluU2VydmljZUluZm8pID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5kYXRhYmFzZSkgPT09IG51bGwgfHwgX2IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9iLmRhdGFzb3VyY2UpIHx8IHt9O1xuICBjb25zdCBkYXRhU291cmNlVHlwZSA9ICgoX2MgPSBkYXRhU291cmNlID09PSBudWxsIHx8IGRhdGFTb3VyY2UgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGRhdGFTb3VyY2UubmFtZSkgPT09IG51bGwgfHwgX2MgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9jLmluZGV4T2YoXCIvbm9zcWxEYXRhYmFzZXNcIikpID4gLTFcbiAgICA/IFwic3BhdGlvdGVtcG9yYWxcIlxuICAgIDogKChfZCA9IGRhdGFTb3VyY2UgPT09IG51bGwgfHwgZGF0YVNvdXJjZSA9PT0gdm9pZCAwID8gdm9pZCAwIDogZGF0YVNvdXJjZS5uYW1lKSA9PT0gbnVsbCB8fCBfZCA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2QuaW5kZXhPZihcIi9lbnRlcnByaXNlRGF0YWJhc2VzXCIpKSA+IC0xXG4gICAgICA/IFwicmVsYXRpb25hbFwiXG4gICAgICA6IG51bGw7XG4gIHJldHVybiBkYXRhU291cmNlVHlwZTtcbn1cbmFzeW5jIGZ1bmN0aW9uIGdldEFkbWluU2VydmljZUluZm8ocHJvcHMsIG5vQ2FjaGUpIHtcbiAgY29uc3QgeyB0YXJnZXRMYXllciwgYWRtaW5TZXJ2aWNlSW5mbywgbW9kdWxlcyB9ID0gcHJvcHM7XG4gIGNvbnN0IHsgSWRlbnRpdHlNYW5hZ2VyLCBlc3JpUmVxdWVzdCB9ID0gbW9kdWxlcztcbiAgaWYgKGFkbWluU2VydmljZUluZm8pIHtcbiAgICByZXR1cm47XG4gIH1cbiAgY29uc3Qgc2VydmljZVVybCA9IHRhcmdldExheWVyLnBvcnRhbEl0ZW0udXJsO1xuICBsZXQgYWRtaW5VcmwgPSBzZXJ2aWNlVXJsLnJlcGxhY2UoXCIvcmVzdC9zZXJ2aWNlc1wiLCBcIi9yZXN0L2FkbWluL3NlcnZpY2VzXCIpO1xuICBpZiAobm9DYWNoZSkge1xuICAgIGFkbWluVXJsICs9IGAke2FkbWluVXJsLmluZGV4T2YoXCI/XCIpID4gLTEgPyBcIiZcIiA6IFwiP1wifV90cz0ke25ldyBEYXRlKCkuZ2V0VGltZSgpfWA7XG4gIH1cbiAgdHJ5IHtcbiAgICBhd2FpdCBJZGVudGl0eU1hbmFnZXIuZ2V0Q3JlZGVudGlhbChhZG1pblVybCk7XG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBlc3JpUmVxdWVzdChhZG1pblVybCwge1xuICAgICAgcXVlcnk6IHsgZjogXCJqc29uXCIgfVxuICAgIH0pO1xuICAgIHByb3BzLmFkbWluU2VydmljZUluZm8gPSByZXNwb25zZS5kYXRhO1xuICB9XG4gIGNhdGNoIChlKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChfLCByZWplY3QpID0+IHtcbiAgICAgIHJlamVjdChuZXcgRXJyb3IoXCJjb3VsZCBub3QgZ2V0IGFkbWluIGluZm9cIikpO1xuICAgIH0pO1xuICB9XG59XG5hc3luYyBmdW5jdGlvbiBjcmVhdGVJbmRleGVzKHByb3BzKSB7XG4gIGNvbnN0IHsgdGFyZ2V0TGF5ZXIsIHRhcmdldExheWVySWQsIGFkZExheWVyLCBhZGRMYXllcklkLCBhdHRyaWJ1dGVSZWxhdGlvbnNoaXBzIH0gPSBwcm9wcztcbiAgbGV0IGZsID0gdGFyZ2V0TGF5ZXIudHlwZSA9PT0gXCJncm91cFwiXG4gICAgPyBnZXRMYXllcnNBbmRUYWJsZXModGFyZ2V0TGF5ZXIpLmZpbmQoKGx5cikgPT4gbHlyLmxheWVySWQgPT09IHRhcmdldExheWVySWQpXG4gICAgOiB0YXJnZXRMYXllcjtcbiAgbGV0IGZpZWxkTmFtZXMgPSBhdHRyaWJ1dGVSZWxhdGlvbnNoaXBzLm1hcCgocmVsKSA9PiByZWwudGFyZ2V0RmllbGROYW1lKTtcbiAgYXdhaXQgY3JlYXRlSW5kZXhlc0ZvckxheWVyKGZsLCBmaWVsZE5hbWVzLCBwcm9wcyk7XG4gIGZsID1cbiAgICBhZGRMYXllci50eXBlID09PSBcImdyb3VwXCJcbiAgICAgID8gZ2V0TGF5ZXJzQW5kVGFibGVzKGFkZExheWVyKS5maW5kKChseXIpID0+IGx5ci5sYXllcklkID09PSBhZGRMYXllcklkKVxuICAgICAgOiBhZGRMYXllcjtcbiAgZmllbGROYW1lcyA9IGF0dHJpYnV0ZVJlbGF0aW9uc2hpcHMubWFwKChyZWwpID0+IHJlbC5hZGRGaWVsZE5hbWUpO1xuICBhd2FpdCBjcmVhdGVJbmRleGVzRm9yTGF5ZXIoZmwsIGZpZWxkTmFtZXMsIHByb3BzKTtcbn1cbmFzeW5jIGZ1bmN0aW9uIGNyZWF0ZUluZGV4ZXNGb3JMYXllcihmbCwgZmllbGROYW1lcywgcHJvcHMpIHtcbiAgY29uc3QganNvbiA9IHtcbiAgICBpbmRleGVzOiBbXVxuICB9O1xuICBmbC5zb3VyY2VKU09OLmluZGV4ZXMgPSBmbC5zb3VyY2VKU09OLmluZGV4ZXMgfHwgW107XG4gIGZpZWxkTmFtZXMuZm9yRWFjaCgoZmllbGROYW1lKSA9PiB7XG4gICAgaWYgKCFmbC5zb3VyY2VKU09OLmluZGV4ZXMuc29tZSgoaW5kZXgpID0+IGluZGV4LmZpZWxkcyA9PT0gZmllbGROYW1lKSkge1xuICAgICAgLy8gaW5kZXggZG9lc24ndCBleGlzdCB5ZXRcbiAgICAgIGpzb24uaW5kZXhlcy5wdXNoKHtcbiAgICAgICAgbmFtZTogYCR7ZmllbGROYW1lfV9JbmRleGAsXG4gICAgICAgIGZpZWxkczogZmllbGROYW1lLFxuICAgICAgICBpc1VuaXF1ZTogZmFsc2UsXG4gICAgICAgIGlzQXNjZW5kaW5nOiB0cnVlLFxuICAgICAgICBkZXNjcmlwdGlvbjogYCR7ZmllbGROYW1lfV9JbmRleGBcbiAgICAgIH0pO1xuICAgIH1cbiAgfSk7XG4gIGlmIChqc29uLmluZGV4ZXMubGVuZ3RoKSB7XG4gICAgYXdhaXQgZXhlY3V0ZUNyZWF0ZUluZGV4ZXMoanNvbiwgZmwsIHByb3BzKTtcbiAgfVxufVxuYXN5bmMgZnVuY3Rpb24gZXhlY3V0ZUNyZWF0ZUluZGV4ZXMoanNvbiwgZmwsIHByb3BzKSB7XG4gIHZhciBfYTtcbiAgY29uc3QgeyB0YXJnZXRJdGVtLCBtb2R1bGVzIH0gPSBwcm9wcztcbiAgY29uc3QgeyBJZGVudGl0eU1hbmFnZXIgfSA9IG1vZHVsZXM7XG4gIGNvbnN0IGFkbWluVXJsID0gZmwudXJsLnJlcGxhY2UoXCIvcmVzdC9zZXJ2aWNlc1wiLCBcIi9yZXN0L2FkbWluL3NlcnZpY2VzXCIpO1xuICBjb25zdCB1cmwgPSBgJHthZG1pblVybH0vJHtmbC5sYXllcklkfS9hZGRUb0RlZmluaXRpb25gO1xuICBjb25zdCBjcmVkZW50aWFsID0gSWRlbnRpdHlNYW5hZ2VyLmZpbmRDcmVkZW50aWFsKHVybCk7XG4gIGNvbnN0IGlzUG9ydGFsID0gdGFyZ2V0SXRlbS5wb3J0YWwuaXNQb3J0YWw7XG4gIGNvbnN0IGNvbnRlbnQgPSB7XG4gICAgZjogXCJqc29uXCIsXG4gICAgYWRkVG9EZWZpbml0aW9uOiBKU09OLnN0cmluZ2lmeShqc29uKSxcbiAgICBhc3luYzogIWlzUG9ydGFsLFxuICAgIHRva2VuOiBjcmVkZW50aWFsLnRva2VuXG4gIH07XG4gIGNvbnN0IHJlc3VsdCA9IGF3YWl0IG1vZHVsZXMuZXNyaVJlcXVlc3QodXJsLCB7XG4gICAgcXVlcnk6IGNvbnRlbnQsXG4gICAgbWV0aG9kOiBcInBvc3RcIlxuICB9KTtcbiAgaWYgKGlzUG9ydGFsKSB7XG4gICAgZmwuc291cmNlSlNPTi5pbmRleGVzID0gZmwuc291cmNlSlNPTi5pbmRleGVzIHx8IFtdO1xuICAgIGZsLnNvdXJjZUpTT04uaW5kZXhlcyA9IGZsLnNvdXJjZUpTT04uaW5kZXhlcy5jb25jYXQoanNvbi5pbmRleGVzKTtcbiAgfVxuICBlbHNlIHtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgcG9sbEZvclN0YXR1cygoX2EgPSByZXN1bHQgPT09IG51bGwgfHwgcmVzdWx0ID09PSB2b2lkIDAgPyB2b2lkIDAgOiByZXN1bHQuZGF0YSkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLnN0YXR1c1VSTCwge1xuICAgICAgICBmOiBcImpzb25cIixcbiAgICAgICAgdG9rZW46IGNyZWRlbnRpYWwudG9rZW5cbiAgICAgIH0sIHByb3BzKTtcbiAgICAgIGZsLnNvdXJjZUpTT04uaW5kZXhlcyA9IGZsLnNvdXJjZUpTT04uaW5kZXhlcyB8fCBbXTtcbiAgICAgIGZsLnNvdXJjZUpTT04uaW5kZXhlcyA9IGZsLnNvdXJjZUpTT04uaW5kZXhlcy5jb25jYXQoanNvbi5pbmRleGVzKTtcbiAgICB9XG4gICAgY2F0Y2ggKGUpIHtcbiAgICAgIC8vIG5vdCBhIGJpZyBwcm9ibGVtIGlmIGl0IGRpZG4ndCB3b3JrXG4gICAgfVxuICB9XG59XG5jb25zdCBwb2xsRm9yU3RhdHVzID0gYXN5bmMgKHVybCwgcGFyYW1zLCBwcm9wcykgPT4ge1xuICB2YXIgX2E7XG4gIGNvbnN0IHsgbW9kdWxlcyB9ID0gcHJvcHM7XG4gIGlmICghdXJsKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFwicG9sbEZvclN0YXR1czogbm8gc3RhdHVzIFVSTFwiKTtcbiAgfVxuICBjb25zdCBwZW5kaW5nU3RhdHVzZXMgPSBbXCJwcm9jZXNzaW5nXCIsIFwicGFydGlhbFwiLCBcIlBlbmRpbmdcIiwgXCJJblByb2dyZXNzXCJdO1xuICBjb25zdCBzdWNjZXNzU3RhdHVzZXMgPSBbXCJjb21wbGV0ZWRcIiwgXCJDb21wbGV0ZWRcIl07XG4gIC8vIEtlZXAgcG9sbGluZyBzdGF0dXMgdW50aWwgZWl0aGVyIGNvbXBsZXRlZCBvciBmYWlsZWRcbiAgdHJ5IHtcbiAgICAvLyBEbyBmYWlsdXJlcyByZXBvcnQgYXMgc3VjY2VzcyAoc3RhdHVzIDIwMCk/IE1heSBuZWVkIHRvIG1hbnVhbGx5IHRocm93IGVycm9yIG9uIHN0YXR1cyBjaGVjayBmYWlsdXJlXG4gICAgY29uc3Qgc3RhdHVzUmVzcG9uc2UgPSBhd2FpdCBtb2R1bGVzLmVzcmlSZXF1ZXN0KHVybCwgeyBxdWVyeTogcGFyYW1zIH0pO1xuICAgIGNvbnN0IHN0YXR1cyA9IChfYSA9IHN0YXR1c1Jlc3BvbnNlID09PSBudWxsIHx8IHN0YXR1c1Jlc3BvbnNlID09PSB2b2lkIDAgPyB2b2lkIDAgOiBzdGF0dXNSZXNwb25zZS5kYXRhKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2Euc3RhdHVzO1xuICAgIGlmIChwZW5kaW5nU3RhdHVzZXMuaW5jbHVkZXMoc3RhdHVzKSkge1xuICAgICAgYXdhaXQgdGltZW91dCg1MDApO1xuICAgICAgcmV0dXJuIHBvbGxGb3JTdGF0dXModXJsLCBwYXJhbXMsIHByb3BzKTtcbiAgICB9XG4gICAgZWxzZSBpZiAoc3VjY2Vzc1N0YXR1c2VzLmluY2x1ZGVzKHN0YXR1cykpIHtcbiAgICAgIHJldHVybiBzdGF0dXNSZXNwb25zZTtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICB0aHJvdyBzdGF0dXNSZXNwb25zZTtcbiAgICB9XG4gIH1cbiAgY2F0Y2ggKGUpIHtcbiAgICBjb25zb2xlLmVycm9yKGUpO1xuICAgIHRocm93IGU7XG4gIH1cbn07XG5cbmNvbnN0IGFyY2dpc0xheWVyVmlld0pvaW5Dc3MgPSBcIjpob3N0e2hlaWdodDoxMDAlfS5wYW5lbHtoZWlnaHQ6MTAwJX0uZm9vdGVye3dpZHRoOjEwMCV9LmVycm9yLWNvbnRlbnR7bWFyZ2luOjAuNXJlbX1cIjtcblxuY29uc3QgQXJjZ2lzTGF5ZXJWaWV3ID0gY2xhc3Mge1xuICBjb25zdHJ1Y3Rvcihob3N0UmVmKSB7XG4gICAgcmVnaXN0ZXJJbnN0YW5jZSh0aGlzLCBob3N0UmVmKTtcbiAgICB0aGlzLmFyY2dpc0xheWVyVmlld0pvaW5DYW5jZWwgPSBjcmVhdGVFdmVudCh0aGlzLCBcImFyY2dpc0xheWVyVmlld0pvaW5DYW5jZWxcIiwgNyk7XG4gICAgdGhpcy5hcmNnaXNMYXllclZpZXdKb2luVGFibGVDbGljayA9IGNyZWF0ZUV2ZW50KHRoaXMsIFwiYXJjZ2lzTGF5ZXJWaWV3Sm9pblRhYmxlQ2xpY2tcIiwgNyk7XG4gICAgdGhpcy5hcmNnaXNMYXllclZpZXdKb2luU3RlcENoYW5nZSA9IGNyZWF0ZUV2ZW50KHRoaXMsIFwiYXJjZ2lzTGF5ZXJWaWV3Sm9pblN0ZXBDaGFuZ2VcIiwgNyk7XG4gICAgdGhpcy5hcmNnaXNMYXllclZpZXdKb2luQ3JlYXRlZCA9IGNyZWF0ZUV2ZW50KHRoaXMsIFwiYXJjZ2lzTGF5ZXJWaWV3Sm9pbkNyZWF0ZWRcIiwgNyk7XG4gICAgdGhpcy5zdGF0dXMgPSBqb2luRmxvd1N0YXR1cy5MT0FESU5HO1xuICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgLy9cbiAgICAvLyAgUHJpdmF0ZSBtZXRob2RzXG4gICAgLy9cbiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAgIHRoaXMuZ29DYW5jZWwgPSAoKSA9PiB7XG4gICAgICB0aGlzLmFyY2dpc0xheWVyVmlld0pvaW5DYW5jZWwuZW1pdCgpO1xuICAgIH07XG4gICAgdGhpcy52aWV3ID0gdW5kZWZpbmVkO1xuICAgIHRoaXMuaXRlbUlkID0gdW5kZWZpbmVkO1xuICAgIHRoaXMuY29uZmlnID0gdW5kZWZpbmVkO1xuICAgIHRoaXMuc2hvd1RhYmxlT3B0aW9uID0gZmFsc2U7XG4gIH1cbiAgYXJjZ2lzTGF5ZXJWaWV3U3RhdHVzSGFuZGxlcihldmVudCkge1xuICAgIGNvbnN0IHsgZGV0YWlsIH0gPSBldmVudDtcbiAgICB0aGlzLnN0YXR1cyA9IGRldGFpbC5zdGF0dXM7XG4gICAgLyogaWYgKGRldGFpbC5sYXllcklkcz8ubGVuZ3RoKSB7XG4gICAgICBwcm9wcy5sYXllcklkcyA9IFsuLi5kZXRhaWwubGF5ZXJJZHNdO1xuICAgIH0gKi9cbiAgICBpZiAodGhpcy5zdGF0dXMgPT09IGpvaW5GbG93U3RhdHVzLlRBUkdFVF9TRUxFQ1RJT04pIHtcbiAgICAgIC8vcHJvcHMuc291cmNlSXRlbUlkID0gcHJvcHMubGF5ZXJJdGVtLmlkO1xuICAgICAgdGhpcy5hcmNnaXNMYXllclZpZXdKb2luU3RlcENoYW5nZS5lbWl0KDEpO1xuICAgIH1cbiAgICBlbHNlIGlmICh0aGlzLnN0YXR1cyA9PT0gam9pbkZsb3dTdGF0dXMuQUREX1NFTEVDVElPTikge1xuICAgICAgdGhpcy5hcmNnaXNMYXllclZpZXdKb2luU3RlcENoYW5nZS5lbWl0KDIpO1xuICAgIH1cbiAgICBlbHNlIGlmICh0aGlzLnN0YXR1cyA9PT0gam9pbkZsb3dTdGF0dXMuQ09ORklHKSB7XG4gICAgICB0aGlzLmFyY2dpc0xheWVyVmlld0pvaW5TdGVwQ2hhbmdlLmVtaXQoMyk7XG4gICAgfVxuICAgIGVsc2UgaWYgKHRoaXMuc3RhdHVzID09PSBqb2luRmxvd1N0YXR1cy5DUkVBVEUpIHtcbiAgICAgIHRoaXMuYXJjZ2lzTGF5ZXJWaWV3Sm9pblN0ZXBDaGFuZ2UuZW1pdCg0KTtcbiAgICB9XG4gICAgZm9yY2VVcGRhdGUodGhpcy5ob3N0RWxlbWVudCk7XG4gIH1cbiAgYXN5bmMgYXJjZ2lzTGF5ZXJWaWV3Sm9pbkNyZWF0ZURvbmVIYW5kbGVyKGV2ZW50KSB7XG4gICAgdGhpcy5hcmNnaXNMYXllclZpZXdKb2luQ3JlYXRlZC5lbWl0KGV2ZW50LmRldGFpbCk7XG4gIH1cbiAgYXJjZ2lzTGF5ZXJWaWV3Sm9pbkNyZWF0ZUNhbmNlbEhhbmRsZXIoKSB7XG4gICAgdGhpcy5hcmNnaXNMYXllclZpZXdKb2luQ2FuY2VsLmVtaXQoKTtcbiAgfVxuICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIC8vXG4gIC8vICBQdWJsaWMgTWV0aG9kc1xuICAvL1xuICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIC8qXG4gICAqIEdvdCB0byBhIGNlcnRhaW4gc3RlcC4gSWYgc3VjY2Vzc2Z1bCBpdCB3aWxsIHJldHVybiB0cnVlLlxuICAgKiBJZiBpdCdzIG5vdCBwb3NzaWJsZSwgYmVjYXVzZSBzb21lIHVzZXIgaW5wdXQgaXMgbWlzc2luZywgdGhlbiBpdCB3aWxsIHJldHVybiBmYWxzZS5cbiAgICovXG4gIGFzeW5jIHNldFN0ZXAoc3RlcCkge1xuICAgIHZhciBfYSwgX2I7XG4gICAgY29uc3QgeyBwcm9wcyB9ID0gdGhpcztcbiAgICBjb25zdCB7IHRhcmdldExheWVySWQsIGFkZExheWVySWQsIGF0dHJpYnV0ZVJlbGF0aW9uc2hpcHMsIGpvaW5PcGVyYXRpb24gfSA9IHByb3BzO1xuICAgIGNvbnN0IGFkZFNlbGVjdGlvblBvc3NpYmxlID0gaXNEZWZpbmVkKHRhcmdldExheWVySWQpO1xuICAgIGNvbnN0IGNvbmZpZ1Bvc3NpYmxlID0gaXNEZWZpbmVkKGFkZExheWVySWQpO1xuICAgIGNvbnN0IGNyZWF0ZVBvc3NpYmxlID0gKGF0dHJpYnV0ZVJlbGF0aW9uc2hpcHMgPT09IG51bGwgfHwgYXR0cmlidXRlUmVsYXRpb25zaGlwcyA9PT0gdm9pZCAwID8gdm9pZCAwIDogYXR0cmlidXRlUmVsYXRpb25zaGlwcy5maW5kKChyZWwpID0+IHJlbC50YXJnZXRGaWVsZE5hbWUgJiYgcmVsLmFkZEZpZWxkTmFtZSkpICYmXG4gICAgICBqb2luT3BlcmF0aW9uICYmXG4gICAgICAoKGpvaW5PcGVyYXRpb24ubWF0Y2hUeXBlID09PSBcImZpcnN0XCIgJiZcbiAgICAgICAgam9pbk9wZXJhdGlvbi5zb3J0QnlGaWVsZE5hbWUgJiZcbiAgICAgICAgam9pbk9wZXJhdGlvbi5zb3J0T3JkZXIpIHx8XG4gICAgICAgIChqb2luT3BlcmF0aW9uLm1hdGNoVHlwZSA9PT0gXCJzdW1tYXJpemVcIiAmJlxuICAgICAgICAgICgoX2EgPSBqb2luT3BlcmF0aW9uLnN0YXRpc3RpY3NGaWVsZHMpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5sZW5ndGgpICYmXG4gICAgICAgICAgKChfYiA9IGpvaW5PcGVyYXRpb24uc3RhdGlzdGljc0ZpZWxkcykgPT09IG51bGwgfHwgX2IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9iWzBdLmZpZWxkTmFtZSkpKTtcbiAgICAvLyBjbG9zZSBwb3BvdmVyc1xuICAgIGRvY3VtZW50LmJvZHkucXVlcnlTZWxlY3RvckFsbChcIi5qcy1hcHAtZmx5b3V0XCIpLmZvckVhY2goKG5vZGUpID0+IHtcbiAgICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQobm9kZSk7XG4gICAgfSk7XG4gICAgc3dpdGNoIChzdGVwKSB7XG4gICAgICBjYXNlIDE6XG4gICAgICAgIHRoaXMuc3RhdHVzID0gam9pbkZsb3dTdGF0dXMuVEFSR0VUX1NFTEVDVElPTjtcbiAgICAgICAgZm9yY2VVcGRhdGUodGhpcy5ob3N0RWxlbWVudCk7XG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gcmVzb2x2ZSh0cnVlKSk7XG4gICAgICBjYXNlIDI6XG4gICAgICAgIGlmIChhZGRTZWxlY3Rpb25Qb3NzaWJsZSkge1xuICAgICAgICAgIHRoaXMuc3RhdHVzID0gam9pbkZsb3dTdGF0dXMuQUREX1NFTEVDVElPTjtcbiAgICAgICAgICBmb3JjZVVwZGF0ZSh0aGlzLmhvc3RFbGVtZW50KTtcbiAgICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHJlc29sdmUodHJ1ZSkpO1xuICAgICAgICB9XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAzOlxuICAgICAgICBpZiAoY29uZmlnUG9zc2libGUpIHtcbiAgICAgICAgICB0aGlzLnN0YXR1cyA9IGpvaW5GbG93U3RhdHVzLkNPTkZJRztcbiAgICAgICAgICBmb3JjZVVwZGF0ZSh0aGlzLmhvc3RFbGVtZW50KTtcbiAgICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHJlc29sdmUodHJ1ZSkpO1xuICAgICAgICB9XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSA0OlxuICAgICAgICBpZiAoY3JlYXRlUG9zc2libGUpIHtcbiAgICAgICAgICB0aGlzLnN0YXR1cyA9IGpvaW5GbG93U3RhdHVzLkNSRUFURTtcbiAgICAgICAgICBmb3JjZVVwZGF0ZSh0aGlzLmhvc3RFbGVtZW50KTtcbiAgICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHJlc29sdmUodHJ1ZSkpO1xuICAgICAgICB9XG4gICAgICAgIGJyZWFrO1xuICAgIH1cbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHJlc29sdmUoZmFsc2UpKTtcbiAgfVxuICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIC8vXG4gIC8vICBMaWZlY3ljbGVcbiAgLy9cbiAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICBhc3luYyBjb21wb25lbnRXaWxsTG9hZCgpIHtcbiAgICB2YXIgX2EsIF9iLCBfYywgX2Q7XG4gICAgY29uc3QgeyBpdGVtSWQsIHZpZXcsIHNob3dUYWJsZU9wdGlvbiwgY29uZmlnIH0gPSB0aGlzO1xuICAgIGNvbnN0IFtzdHJpbmdzXSA9IGF3YWl0IGdldExvY2FsZUNvbXBvbmVudFN0cmluZ3ModGhpcy5ob3N0RWxlbWVudCwgXCJhcmNnaXMtbGF5ZXItdmlld1wiKTtcbiAgICB0aGlzLnN0cmluZ3MgPSBzdHJpbmdzO1xuICAgIHRoaXMucHJvcHMgPSB7IGNvbmZpZywgdmlldywgaXRlbUlkLCBzaG93VGFibGVPcHRpb24sIHN0cmluZ3MsIG1vZHVsZXM6IHt9IH07XG4gICAgbGV0IHsgcHJvcHMgfSA9IHRoaXM7XG4gICAgaWYgKCFpdGVtSWQpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoXCJpdGVtSWQgaXMgYSByZXF1aXJlZCBwcm9wZXJ0eS5cIik7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRyeSB7XG4gICAgICBjb25zdCBbUG9ydGFsSXRlbSwgTGF5ZXIsIEV4dGVudCwgcHJvamVjdGlvbiwgUG9seWdvbiwgZXNyaVJlcXVlc3QsIElkZW50aXR5TWFuYWdlcl0gPSBhd2FpdCBsb2FkTW9kdWxlcyhbXG4gICAgICAgIFwiZXNyaS9wb3J0YWwvUG9ydGFsSXRlbVwiLFxuICAgICAgICBcImVzcmkvbGF5ZXJzL0xheWVyXCIsXG4gICAgICAgIFwiZXNyaS9nZW9tZXRyeS9FeHRlbnRcIixcbiAgICAgICAgXCJlc3JpL2dlb21ldHJ5L3Byb2plY3Rpb25cIixcbiAgICAgICAgXCJlc3JpL2dlb21ldHJ5L1BvbHlnb25cIixcbiAgICAgICAgXCJlc3JpL3JlcXVlc3RcIixcbiAgICAgICAgXCJlc3JpL2lkZW50aXR5L0lkZW50aXR5TWFuYWdlclwiXG4gICAgICBdKTtcbiAgICAgIHByb3BzLm1vZHVsZXMgPSB7XG4gICAgICAgIFBvcnRhbEl0ZW0sXG4gICAgICAgIHByb2plY3Rpb24sXG4gICAgICAgIFBvbHlnb24sXG4gICAgICAgIEV4dGVudCxcbiAgICAgICAgTGF5ZXIsXG4gICAgICAgIGVzcmlSZXF1ZXN0LFxuICAgICAgICBJZGVudGl0eU1hbmFnZXJcbiAgICAgIH07XG4gICAgICBjb25zdCB0YXJnZXRJdGVtID0gbmV3IFBvcnRhbEl0ZW0oe1xuICAgICAgICBpZDogaXRlbUlkXG4gICAgICB9KTtcbiAgICAgIGF3YWl0IHRhcmdldEl0ZW0ubG9hZCgpO1xuICAgICAgcHJvcHMudGFyZ2V0SXRlbU93bmVyID0gdGFyZ2V0SXRlbS5wb3J0YWwudXNlcjtcbiAgICAgIGlmICh0YXJnZXRJdGVtLnBvcnRhbC51c2VyLnVzZXJuYW1lICE9PSB0YXJnZXRJdGVtLm93bmVyKSB7XG4gICAgICAgIC8vIGdldCB1c2VyIGluZm8gb2Ygb3duZXJcbiAgICAgICAgYXdhaXQgZXNyaVJlcXVlc3QoYCR7dGFyZ2V0SXRlbS5wb3J0YWwucmVzdFVybH0vY29tbXVuaXR5L3VzZXJzLyR7dGFyZ2V0SXRlbS5vd25lcn1gLCB7XG4gICAgICAgICAgcXVlcnk6IHsgZjogXCJqc29uXCIgfVxuICAgICAgICB9KS50aGVuKCh1c2VyUmVzdWx0KSA9PiB7XG4gICAgICAgICAgaWYgKHVzZXJSZXN1bHQgPT09IG51bGwgfHwgdXNlclJlc3VsdCA9PT0gdm9pZCAwID8gdm9pZCAwIDogdXNlclJlc3VsdC5kYXRhKSB7XG4gICAgICAgICAgICBwcm9wcy50YXJnZXRJdGVtT3duZXIgPSB1c2VyUmVzdWx0LmRhdGE7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICAgIGlmICh0YXJnZXRJdGVtLnR5cGUgIT09IFwiRmVhdHVyZSBTZXJ2aWNlXCIpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcihcIk9ubHkgRmVhdHVyZSBTZXJ2aWNlIGl0ZW1zIGFyZSBhbGxvd2VkLlwiKTtcbiAgICAgICAgdGhpcy5zdGF0dXMgPSBqb2luRmxvd1N0YXR1cy5FUlJPUjtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgaWYgKCgoX2EgPSB0YXJnZXRJdGVtLnR5cGVLZXl3b3JkcykgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmluZGV4T2YoXCJIb3N0ZWQgU2VydmljZVwiKSkgPT09IC0xKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoXCJPbmx5IGhvc3RlZCBGZWF0dXJlIFNlcnZpY2UgaXRlbXMgYXJlIGFsbG93ZWQuXCIpO1xuICAgICAgICB0aGlzLnN0YXR1cyA9IGpvaW5GbG93U3RhdHVzLkVSUk9SO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBpZiAodGFyZ2V0SXRlbS5wb3J0YWwudXNlci51c2VybmFtZSAhPT0gdGFyZ2V0SXRlbS5vd25lciAmJlxuICAgICAgICB0YXJnZXRJdGVtLml0ZW1Db250cm9sICE9PSBcImFkbWluXCIpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcihcIk9ubHkgb3duZXJzIGFuZCBhZG1pbnMgYXJlIGFsbG93ZWQuXCIpO1xuICAgICAgICB0aGlzLnN0YXR1cyA9IGpvaW5GbG93U3RhdHVzLkVSUk9SO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBpZiAoKChfYiA9IHRhcmdldEl0ZW0udHlwZUtleXdvcmRzKSA9PT0gbnVsbCB8fCBfYiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2IuaW5kZXhPZihcIlZpZXcgU2VydmljZVwiKSkgPiAtMSkge1xuICAgICAgICBjb25zb2xlLmVycm9yKFwiVmlldyBpdGVtcyBhcmUgbm90IGFsbG93ZWQuXCIpO1xuICAgICAgICB0aGlzLnN0YXR1cyA9IGpvaW5GbG93U3RhdHVzLkVSUk9SO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBpZiAoKHRhcmdldEl0ZW0gPT09IG51bGwgfHwgdGFyZ2V0SXRlbSA9PT0gdm9pZCAwID8gdm9pZCAwIDogdGFyZ2V0SXRlbS50eXBlS2V5d29yZHMuaW5kZXhPZihcIklvVEZlYXR1cmVMYXllclwiKSkgPiAtMSkge1xuICAgICAgICBjb25zb2xlLmVycm9yKFwiVmVsb2NpdHkgaXRlbXMgYXJlIG5vdCBhbGxvd2VkLlwiKTtcbiAgICAgICAgdGhpcy5zdGF0dXMgPSBqb2luRmxvd1N0YXR1cy5FUlJPUjtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgbGV0IGdjc0V4dGVudCA9IHRhcmdldEl0ZW0uZXh0ZW50O1xuICAgICAgaWYgKCFnY3NFeHRlbnQpIHtcbiAgICAgICAgZ2NzRXh0ZW50ID0gbmV3IEV4dGVudCh7XG4gICAgICAgICAgeG1pbjogLTE4MCxcbiAgICAgICAgICB5bWluOiAtOTAsXG4gICAgICAgICAgeG1heDogMTgwLFxuICAgICAgICAgIHltYXg6IDkwLFxuICAgICAgICAgIHNwYXRpYWxSZWZlcmVuY2U6IDQzMjZcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgICBpZiAodmlldy5zcGF0aWFsUmVmZXJlbmNlLndraWQgIT09IDQzMjYpIHtcbiAgICAgICAgYXdhaXQgcHJvamVjdGlvbi5sb2FkKCk7XG4gICAgICAgIGNvbnN0IGV4dGVudCA9IHByb2plY3Rpb24ucHJvamVjdChnY3NFeHRlbnQsIHZpZXcuc3BhdGlhbFJlZmVyZW5jZSk7XG4gICAgICAgIHZpZXcuZ29UbyhleHRlbnQuZXhwYW5kKDEuMSkpO1xuICAgICAgfVxuICAgICAgZWxzZSB7XG4gICAgICAgIHZpZXcuZ29UbyhnY3NFeHRlbnQuZXhwYW5kKDEuMSkpO1xuICAgICAgfVxuICAgICAgY29uc3QgdGFyZ2V0TGF5ZXIgPSBhd2FpdCBMYXllci5mcm9tUG9ydGFsSXRlbSh7XG4gICAgICAgIHBvcnRhbEl0ZW06IHRhcmdldEl0ZW1cbiAgICAgIH0pO1xuICAgICAgLy9jb25zb2xlLmxvZyhcIioqdGFyZ2V0TGF5ZXIqKlwiLCB0YXJnZXRMYXllcik7XG4gICAgICAvL2NvbnNvbGUubG9nKFwiKip0YXJnZXRJdGVtKipcIiwgdGFyZ2V0SXRlbSk7XG4gICAgICBpZiAodGFyZ2V0TGF5ZXIudHlwZSA9PT0gXCJncm91cFwiKSB7XG4gICAgICAgIC8vIGdyb3VwIGxheWVyIGhhcyBubyBsYXllcnMgb3IgdGFibGVzIGF0IHRoaXMgcG9pbnRcbiAgICAgICAgLy8gbG9hZEFsbCgpIGxvYWRzIGxheWVycyBhbmQgdGFibGVzIChhdCB2NC4yMylcbiAgICAgICAgYXdhaXQgdGFyZ2V0TGF5ZXIubG9hZEFsbCgpO1xuICAgICAgICBpZiAoKF9jID0gdGFyZ2V0TGF5ZXIubGF5ZXJzKSA9PT0gbnVsbCB8fCBfYyA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2MubGVuZ3RoKSB7XG4gICAgICAgICAgLy8gaGFzIGF0IGxlYXN0IG9uZSBzcGF0aWFsIGxheWVyXG4gICAgICAgICAgdmlldy5tYXAuYWRkKHRhcmdldExheWVyKTtcbiAgICAgICAgfVxuICAgICAgICAvLyBkZWZhdWx0IHBvcHVwc1xuICAgICAgICAoX2QgPSB0YXJnZXRMYXllci5sYXllcnMpID09PSBudWxsIHx8IF9kID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfZC5mb3JFYWNoKChseXIpID0+IHtcbiAgICAgICAgICBpZiAoIWx5ci5wb3B1cFRlbXBsYXRlICYmIGx5ci5wb3B1cEVuYWJsZWQpIHtcbiAgICAgICAgICAgIGx5ci5wb3B1cFRlbXBsYXRlID0gbHlyLmNyZWF0ZVBvcHVwVGVtcGxhdGUoKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgICAgZWxzZSB7XG4gICAgICAgIGF3YWl0IHRhcmdldExheWVyLmxvYWQoKTtcbiAgICAgICAgaWYgKCF0YXJnZXRMYXllci5pc1RhYmxlKSB7XG4gICAgICAgICAgdmlldy5tYXAuYWRkKHRhcmdldExheWVyKTtcbiAgICAgICAgfVxuICAgICAgICAvLyBkZWZhdWx0IHBvcHVwXG4gICAgICAgIHRhcmdldExheWVyLnBvcHVwVGVtcGxhdGUgPSB0YXJnZXRMYXllci5jcmVhdGVQb3B1cFRlbXBsYXRlKCk7XG4gICAgICB9XG4gICAgICBpZiAodGFyZ2V0SXRlbS5wb3J0YWwuaXNQb3J0YWwpIHtcbiAgICAgICAgLy8gT0JBQyBub3Qgc3VwcG9ydGVkIGluIEVudGVycHJpc2VcbiAgICAgICAgaWYgKHRhcmdldExheWVyLnR5cGUgPT09IFwiZ3JvdXBcIikge1xuICAgICAgICAgIGlmICghZ2V0TGF5ZXJzQW5kVGFibGVzKHRhcmdldExheWVyKS5maW5kKChmbCkgPT4gIWhhc09CQUMoZmwpKSkge1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcihcIkxheWVycyB3aXRoIE93bmVyc2hpcC1CYXNlZCBBY2Nlc3MgQ29udHJvbCBhcmUgbm90IGFsbG93ZWQuXCIpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBlbHNlIGlmIChoYXNPQkFDKHRhcmdldExheWVyKSkge1xuICAgICAgICAgIGNvbnNvbGUuZXJyb3IoXCJMYXllcnMgd2l0aCBPd25lcnNoaXAtQmFzZWQgQWNjZXNzIENvbnRyb2wgYXJlIG5vdCBhbGxvd2VkLlwiKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgcHJvcHMudGFyZ2V0SXRlbSA9IHRhcmdldEl0ZW07XG4gICAgICBwcm9wcy50YXJnZXRMYXllciA9IHRhcmdldExheWVyO1xuICAgICAgdGhpcy5zdGF0dXMgPSBqb2luRmxvd1N0YXR1cy5UQVJHRVRfU0VMRUNUSU9OO1xuICAgIH1cbiAgICBjYXRjaCAoZSkge1xuICAgICAgY29uc29sZS5lcnJvcihlKTtcbiAgICAgIHRoaXMuc3RhdHVzID0gam9pbkZsb3dTdGF0dXMuRVJST1I7XG4gICAgfVxuICB9XG4gIGFzeW5jIGNvbXBvbmVudERpZExvYWQoKSB7XG4gICAgdGhpcy5hcmNnaXNMYXllclZpZXdKb2luU3RlcENoYW5nZS5lbWl0KDEpO1xuICB9XG4gIGRpc2Nvbm5lY3RlZENhbGxiYWNrKCkge1xuICAgIGNvbnN0IHsgcHJvcHMgfSA9IHRoaXM7XG4gICAgY29uc3QgeyB2aWV3LCB0YXJnZXRMYXllciwgYWRkTGF5ZXIgfSA9IHByb3BzO1xuICAgIHZpZXcubWFwLnJlbW92ZSh0YXJnZXRMYXllcik7XG4gICAgdmlldy5tYXAucmVtb3ZlKGFkZExheWVyKTtcbiAgfVxuICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAvL1xuICAvLyAgUmVuZGVyIE1ldGhvZHNcbiAgLy9cbiAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICByZW5kZXIoKSB7XG4gICAgLy9jb25zb2xlLmxvZyhcInJlbmRlclwiLCBcInN0YXR1czpcIiwgdGhpcy5zdGF0dXMpO1xuICAgIGNvbnN0IHsgc3RhdHVzIH0gPSB0aGlzO1xuICAgIHJldHVybiAoaChIb3N0LCBudWxsLCBzdGF0dXMgPT09IGpvaW5GbG93U3RhdHVzLkVSUk9SID8gdGhpcy5yZW5kZXJFcnJvcigpIDogbnVsbCwgc3RhdHVzID09PSBqb2luRmxvd1N0YXR1cy5MT0FESU5HID8gdGhpcy5yZW5kZXJMb2FkaW5nKCkgOiBudWxsLCBbam9pbkZsb3dTdGF0dXMuVEFSR0VUX1NFTEVDVElPTl0uaW5jbHVkZXMoc3RhdHVzKVxuICAgICAgPyB0aGlzLnJlbmRlclRhcmdldExheWVyU2VsZWN0aW9uKClcbiAgICAgIDogbnVsbCwgW2pvaW5GbG93U3RhdHVzLkFERF9TRUxFQ1RJT04sIGpvaW5GbG93U3RhdHVzLkJST1dTRV9MQVlFUl0uaW5jbHVkZXMoc3RhdHVzKVxuICAgICAgPyB0aGlzLnJlbmRlckFkZExheWVyU2VsZWN0aW9uKClcbiAgICAgIDogbnVsbCwgW2pvaW5GbG93U3RhdHVzLkNPTkZJR10uaW5jbHVkZXMoc3RhdHVzKSA/IHRoaXMucmVuZGVyQ29uZmlnKCkgOiBudWxsLCBzdGF0dXMgPT09IGpvaW5GbG93U3RhdHVzLkNSRUFURSA/IHRoaXMucmVuZGVyQ3JlYXRlSm9pbigpIDogbnVsbCkpO1xuICB9XG4gIHJlbmRlckVycm9yKCkge1xuICAgIGNvbnN0IHsgcHJvcHMgfSA9IHRoaXM7XG4gICAgY29uc3QgeyB0YXJnZXRJdGVtLCBzdHJpbmdzIH0gPSBwcm9wcztcbiAgICByZXR1cm4gKGgoXCJjYWxjaXRlLWZsb3ctaXRlbVwiLCB7IGxvYWRpbmc6IGZhbHNlLCBoZWFkaW5nOiAodGFyZ2V0SXRlbSA9PT0gbnVsbCB8fCB0YXJnZXRJdGVtID09PSB2b2lkIDAgPyB2b2lkIDAgOiB0YXJnZXRJdGVtLnRpdGxlKSB8fCBzdHJpbmdzLm1zZy5lcnJvciwgZGVzY3JpcHRpb246ICh0YXJnZXRJdGVtID09PSBudWxsIHx8IHRhcmdldEl0ZW0gPT09IHZvaWQgMCA/IHZvaWQgMCA6IHRhcmdldEl0ZW0udGl0bGUpID8gc3RyaW5ncy5qb2luLnRhcmdldExheWVyIDogdW5kZWZpbmVkLCBjbGFzczogQ1NTJDkucGFuZWwsIHJlZjogKG5vZGUpID0+ICh0aGlzLmZsb3dJdGVtTm9kZSA9IG5vZGUpIH0sIGgoXCJkaXZcIiwgeyBjbGFzczogQ1NTJDkuZXJyb3JDb250ZW50IH0sIGgoXCJjYWxjaXRlLW5vdGljZVwiLCB7IHNjYWxlOiBcInNcIiwgd2lkdGg6IFwiZnVsbFwiLCBvcGVuOiB0cnVlLCBpY29uOiBcImV4Y2xhbWF0aW9uLW1hcmstdHJpYW5nbGVcIiwga2luZDogXCJkYW5nZXJcIiB9LCBoKFwiZGl2XCIsIHsgc2xvdDogXCJ0aXRsZVwiIH0sIHN0cmluZ3MubXNnLmVycm9yKSwgaChcImRpdlwiLCB7IHNsb3Q6IFwibWVzc2FnZVwiIH0sIHN0cmluZ3MubXNnLmluaXRGYWlsZWQpKSksIGgoXCJkaXZcIiwgeyBzbG90OiBcImZvb3RlclwiLCBjbGFzczogQ1NTJDkuZm9vdGVyIH0sIGgoXCJjYWxjaXRlLWJ1dHRvblwiLCB7IHNsb3Q6IFwiZm9vdGVyXCIsIG9uQ2xpY2s6IHRoaXMuZ29DYW5jZWwsIGFwcGVhcmFuY2U6IFwidHJhbnNwYXJlbnRcIiwgd2lkdGg6IFwiZnVsbFwiIH0sIHN0cmluZ3MuZ2VuZXJhbC5jYW5jZWwpKSkpO1xuICB9XG4gIHJlbmRlckxvYWRpbmcoKSB7XG4gICAgY29uc3QgeyBwcm9wcyB9ID0gdGhpcztcbiAgICBjb25zdCB7IHRhcmdldEl0ZW0sIHN0cmluZ3MgfSA9IHByb3BzO1xuICAgIHJldHVybiAoaChcImNhbGNpdGUtZmxvdy1pdGVtXCIsIHsgbG9hZGluZzogdHJ1ZSwgaGVhZGluZzogdGFyZ2V0SXRlbSA9PT0gbnVsbCB8fCB0YXJnZXRJdGVtID09PSB2b2lkIDAgPyB2b2lkIDAgOiB0YXJnZXRJdGVtLnRpdGxlLCBkZXNjcmlwdGlvbjogc3RyaW5ncy5qb2luLnRhcmdldExheWVyLCBjbGFzczogQ1NTJDkucGFuZWwsIHJlZjogKG5vZGUpID0+ICh0aGlzLmZsb3dJdGVtTm9kZSA9IG5vZGUpIH0pKTtcbiAgfVxuICByZW5kZXJUYXJnZXRMYXllclNlbGVjdGlvbigpIHtcbiAgICBjb25zdCB7IHByb3BzLCBzdGF0dXMgfSA9IHRoaXM7XG4gICAgcmV0dXJuIChoKFwiYXJjZ2lzLWxheWVyLXZpZXctam9pbi10YXJnZXQtc2VsZWN0aW9uXCIsIHsga2V5OiBgdGFyZ2V0LXNlbGVjdGlvbi0ke3N0YXR1c31gLCBwcm9wczogcHJvcHMsIHN0YXR1czogc3RhdHVzIH0pKTtcbiAgfVxuICByZW5kZXJBZGRMYXllclNlbGVjdGlvbigpIHtcbiAgICBjb25zdCB7IHByb3BzLCBzdGF0dXMgfSA9IHRoaXM7XG4gICAgY29uc3QgeyBhZGRJdGVtIH0gPSBwcm9wcztcbiAgICByZXR1cm4gKGgoXCJhcmNnaXMtbGF5ZXItdmlldy1qb2luLWFkZC1zZWxlY3Rpb25cIiwgeyBrZXk6IGBhZGQtJHtzdGF0dXN9LSR7YWRkSXRlbSA9PT0gbnVsbCB8fCBhZGRJdGVtID09PSB2b2lkIDAgPyB2b2lkIDAgOiBhZGRJdGVtLmlkfWAsIHByb3BzOiBwcm9wcywgc3RhdHVzOiBzdGF0dXMgfSkpO1xuICB9XG4gIHJlbmRlckNvbmZpZygpIHtcbiAgICBjb25zdCB7IHByb3BzLCBzdGF0dXMgfSA9IHRoaXM7XG4gICAgcmV0dXJuIChoKFwiYXJjZ2lzLWxheWVyLXZpZXctam9pbi1jb25maWdcIiwgeyBrZXk6IGBjcmVhdGUtJHtzdGF0dXN9YCwgcHJvcHM6IHByb3BzLCBvbkFyY2dpc0xheWVyVmlld0pvaW5Db25maWdUYWJsZUNsaWNrOiAoZXZlbnQpID0+IHRoaXMuYXJjZ2lzTGF5ZXJWaWV3Sm9pblRhYmxlQ2xpY2suZW1pdChldmVudC5kZXRhaWwpIH0pKTtcbiAgfVxuICByZW5kZXJDcmVhdGVKb2luKCkge1xuICAgIGNvbnN0IHsgcHJvcHMsIHN0YXR1cyB9ID0gdGhpcztcbiAgICByZXR1cm4gKGgoXCJhcmNnaXMtbGF5ZXItdmlldy1qb2luLWNyZWF0ZVwiLCB7IGtleTogYGNyZWF0ZS0ke3N0YXR1c31gLCBwcm9wczogcHJvcHMgfSkpO1xuICB9XG4gIGdldCBob3N0RWxlbWVudCgpIHsgcmV0dXJuIGdldEVsZW1lbnQodGhpcyk7IH1cbn07XG5BcmNnaXNMYXllclZpZXcuc3R5bGUgPSBhcmNnaXNMYXllclZpZXdKb2luQ3NzO1xuXG5jb25zdCBDU1MkNiA9IHtcbiAgZmxvdzogXCJmbG93XCIsXG4gIHBhbmVsOiBcInBhbmVsXCIsXG4gIGZvb3RlcjogXCJmb290ZXJcIixcbiAgaW5mbzogXCJpbmZvXCIsXG4gIGxpc3RIZWFkZXI6IFwibGlzdC1oZWFkZXJcIixcbiAgdGV4dDogXCJ0ZXh0XCIsXG4gIGZvb3RlckJ1dHRvbjogXCJmb290ZXItYnV0dG9uXCIsXG4gIGJyb3dzZTogXCJicm93c2VcIlxufTtcblxuY29uc3QgYXJjZ2lzTGF5ZXJWaWV3Sm9pbkFkZFNlbGVjdGlvbkNzcyA9IFwiLmZsb3d7aGVpZ2h0OjEwMCV9LnBhbmVse2hlaWdodDoxMDAlfS5mb290ZXJ7d2lkdGg6MTAwJX0uaW5mb3twb2ludGVyLWV2ZW50czpub25lO3BhZGRpbmc6MXJlbSAwLjc1cmVtfS5saXN0LWhlYWRlcntwb2ludGVyLWV2ZW50czpub25lO3BhZGRpbmc6MXJlbSAwLjc1cmVtIDAuM3JlbX0udGV4dHtmb250LXNpemU6dmFyKC0tY2FsY2l0ZS1mb250LXNpemUtLTIpO2xpbmUtaGVpZ2h0OjEuMzc1O2NvbG9yOnZhcigtLWNhbGNpdGUtdWktdGV4dC0zKTt0cmFuc2l0aW9uLWR1cmF0aW9uOjE1MG1zO3RyYW5zaXRpb24tdGltaW5nLWZ1bmN0aW9uOmN1YmljLWJlemllcigwLjQsIDAsIDAuMiwgMSk7cG9pbnRlci1ldmVudHM6bm9uZTt3b3JkLXdyYXA6YnJlYWstd29yZDt3b3JkLWJyZWFrOmJyZWFrLXdvcmR9LmZvb3Rlci1idXR0b257bWFyZ2luOjAgMTBweCA1cHggMTBweH0ubm90aWNle21hcmdpbjo4cHh9LmJyb3dzZXt3aWR0aDoxMDAlfVwiO1xuXG5jb25zdCBBcmNnaXNMYXllclZpZXdKb2luQWRkU2VsZWN0aW9uID0gY2xhc3Mge1xuICBjb25zdHJ1Y3Rvcihob3N0UmVmKSB7XG4gICAgcmVnaXN0ZXJJbnN0YW5jZSh0aGlzLCBob3N0UmVmKTtcbiAgICB0aGlzLmFyY2dpc0xheWVyVmlld0pvaW5TdGF0dXNDaGFuZ2UgPSBjcmVhdGVFdmVudCh0aGlzLCBcImFyY2dpc0xheWVyVmlld0pvaW5TdGF0dXNDaGFuZ2VcIiwgNyk7XG4gICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICAvL1xuICAgIC8vICBQcml2YXRlIG1ldGhvZHNcbiAgICAvL1xuICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgdGhpcy5nb0Jyb3dzZSA9ICgpID0+IHtcbiAgICAgIHRoaXMuYXJjZ2lzTGF5ZXJWaWV3Sm9pblN0YXR1c0NoYW5nZS5lbWl0KHsgc3RhdHVzOiBqb2luRmxvd1N0YXR1cy5CUk9XU0VfTEFZRVIgfSk7XG4gICAgfTtcbiAgICB0aGlzLmdvQmFjayA9ICgpID0+IHtcbiAgICAgIHRoaXMuYXJjZ2lzTGF5ZXJWaWV3Sm9pblN0YXR1c0NoYW5nZS5lbWl0KHtcbiAgICAgICAgc3RhdHVzOiBqb2luRmxvd1N0YXR1cy5UQVJHRVRfU0VMRUNUSU9OXG4gICAgICB9KTtcbiAgICB9O1xuICAgIHRoaXMuZ29OZXh0ID0gKCkgPT4ge1xuICAgICAgdGhpcy5hcmNnaXNMYXllclZpZXdKb2luU3RhdHVzQ2hhbmdlLmVtaXQoe1xuICAgICAgICBzdGF0dXM6IGpvaW5GbG93U3RhdHVzLkNPTkZJR1xuICAgICAgfSk7XG4gICAgfTtcbiAgICB0aGlzLm9uU2VsZWN0aW9uQ2hhbmdlID0gKCkgPT4ge1xuICAgICAgY29uc3QgeyBwcm9wcyB9ID0gdGhpcztcbiAgICAgIHRoaXMubGlzdE5vZGVcbiAgICAgICAgLnF1ZXJ5U2VsZWN0b3JBbGwoXCJjYWxjaXRlLXBpY2stbGlzdC1pdGVtXCIpXG4gICAgICAgIC5mb3JFYWNoKChpdGVtKSA9PiB7XG4gICAgICAgIGlmIChpdGVtLnNlbGVjdGVkKSB7XG4gICAgICAgICAgcHJvcHMuYWRkTGF5ZXJJZCA9IGl0ZW0udmFsdWU7XG4gICAgICAgICAgZm9yY2VVcGRhdGUodGhpcy5ob3N0RWxlbWVudCk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgICAgcHJvcHMuYXR0cmlidXRlUmVsYXRpb25zaGlwcyA9IHVuZGVmaW5lZDtcbiAgICAgIHByb3BzLmpvaW5PcGVyYXRpb24gPSB1bmRlZmluZWQ7XG4gICAgfTtcbiAgICB0aGlzLnByb3BzID0gdW5kZWZpbmVkO1xuICAgIHRoaXMuc3RhdHVzID0gdW5kZWZpbmVkO1xuICB9XG4gIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgLy9cbiAgLy8gIExpZmVjeWNsZVxuICAvL1xuICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIGNvbXBvbmVudFdpbGxMb2FkKCkge1xuICAgIGNvbnN0IHsgcHJvcHMgfSA9IHRoaXM7XG4gICAgY29uc3QgeyBhZGRJdGVtLCB0YXJnZXRJdGVtLCB0YXJnZXRMYXllciB9ID0gcHJvcHM7XG4gICAgaWYgKCFhZGRJdGVtICYmIHRhcmdldExheWVyLnR5cGUgPT09IFwiZ3JvdXBcIikge1xuICAgICAgcHJvcHMuYWRkSXRlbSA9IHRhcmdldEl0ZW07XG4gICAgICBwcm9wcy5hZGRMYXllciA9IHRhcmdldExheWVyO1xuICAgIH1cbiAgICBpZiAocHJvcHMuYWRkTGF5ZXIgJiYgcHJvcHMuYWRkTGF5ZXIudHlwZSAhPT0gXCJncm91cFwiICYmICFpc0RlZmluZWQocHJvcHMuYWRkTGF5ZXJJZCkpIHtcbiAgICAgIHByb3BzLmFkZExheWVySWQgPSBwcm9wcy5hZGRMYXllci5sYXllcklkO1xuICAgIH1cbiAgfVxuICBjb21wb25lbnREaWRMb2FkKCkge1xuICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZSgoKSA9PiB7IHZhciBfYTsgcmV0dXJuIChfYSA9IHRoaXMuYmFja0J1dHRvbk5vZGUpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5zZXRGb2N1cygpOyB9KTtcbiAgfVxuICBjb21wb25lbnREaWRSZW5kZXIoKSB7XG4gICAgY29uc3QgeyBwcm9wcyB9ID0gdGhpcztcbiAgICBjb25zdCB7IHRhcmdldExheWVyLCB0YXJnZXRMYXllcklkLCBhZGRMYXllciwgYWRkTGF5ZXJJZCB9ID0gcHJvcHM7XG4gICAgaWYgKHRhcmdldExheWVyLnR5cGUgPT09IFwiZ3JvdXBcIikge1xuICAgICAgZ2V0TGF5ZXJzQW5kVGFibGVzKHRhcmdldExheWVyKS5mb3JFYWNoKChseXIpID0+IHtcbiAgICAgICAgaWYgKGx5ci5sYXllcklkICE9PSB0YXJnZXRMYXllcklkKSB7XG4gICAgICAgICAgbHlyLnZpc2libGUgPSBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuICAgIGlmIChhZGRMYXllciAmJiBhZGRMYXllci50eXBlID09PSBcImdyb3VwXCIgJiYgaXNEZWZpbmVkKGFkZExheWVySWQpKSB7XG4gICAgICBnZXRMYXllcnNBbmRUYWJsZXMoYWRkTGF5ZXIpLmZvckVhY2goKGx5cikgPT4ge1xuICAgICAgICBpZiAodGFyZ2V0TGF5ZXIuaWQgIT09IGFkZExheWVyLmlkIHx8IHRhcmdldExheWVySWQgIT09IGx5ci5sYXllcklkKSB7XG4gICAgICAgICAgbHlyLnZpc2libGUgPSBseXIubGF5ZXJJZCA9PT0gYWRkTGF5ZXJJZDtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuICAgIGVsc2UgaWYgKGFkZExheWVyICYmIGFkZExheWVyLnR5cGUgIT09IFwiZ3JvdXBcIikge1xuICAgICAgYWRkTGF5ZXIudmlzaWJsZSA9IHRydWU7XG4gICAgfVxuICB9XG4gIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIC8vXG4gIC8vICBSZW5kZXIgTWV0aG9kc1xuICAvL1xuICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIHJlbmRlcigpIHtcbiAgICBjb25zdCB7IHByb3BzLCBzdGF0dXMgfSA9IHRoaXM7XG4gICAgY29uc3QgeyBzdHJpbmdzIH0gPSBwcm9wcztcbiAgICBjb25zdCBydGwgPSBnZXRFbGVtZW50RGlyKHRoaXMuaG9zdEVsZW1lbnQpID09PSBcInJ0bFwiO1xuICAgIHJldHVybiAoaChIb3N0LCB7IGNsYXNzOiBcImNhbGNpdGUtbWF0Y2gtaGVpZ2h0XCIgfSwgaChcImNhbGNpdGUtZmxvd1wiLCB7IGNsYXNzOiBDU1MkNi5mbG93LCBkaXI6IGdldEVsZW1lbnREaXIodGhpcy5ob3N0RWxlbWVudCkgfSwgaChcImNhbGNpdGUtZmxvdy1pdGVtXCIsIHsgZGVzY3JpcHRpb246IHN0cmluZ3Muam9pbi5qb2luTGF5ZXIsIGNsYXNzOiB7XG4gICAgICAgIHBhbmVsOiB0cnVlLFxuICAgICAgICBbQ1NTX1VUSUxJVFkucnRsXTogcnRsXG4gICAgICB9LCByZWY6IChub2RlKSA9PiAodGhpcy5mbG93SXRlbU5vZGUgPSBub2RlKSB9LCB0aGlzLnJlbmRlckZvb3RlckJ1dHRvbnMoKSwgdGhpcy5yZW5kZXJPQkFDTXNnKCksIHRoaXMucmVuZGVyQnJvd3NlKCksIHRoaXMucmVuZGVyU3VibGF5ZXJzKCkpLCBzdGF0dXMgPT09IGpvaW5GbG93U3RhdHVzLkJST1dTRV9MQVlFUiAmJiB0aGlzLnJlbmRlckJyb3dzZUxheWVyKCkpKSk7XG4gIH1cbiAgcmVuZGVyRm9vdGVyQnV0dG9ucygpIHtcbiAgICBjb25zdCB7IHByb3BzIH0gPSB0aGlzO1xuICAgIGNvbnN0IHsgYWRkSXRlbSwgYWRkTGF5ZXJJZCwgYWRkTGF5ZXIsIHN0cmluZ3MgfSA9IHByb3BzO1xuICAgIGNvbnN0IGlzUnRsID0gZ2V0RWxlbWVudERpcih0aGlzLmhvc3RFbGVtZW50KSA9PT0gXCJydGxcIjtcbiAgICBsZXQgYWRkRkw7XG4gICAgaWYgKGFkZExheWVyICYmIGFkZExheWVyLnR5cGUgPT09IFwiZ3JvdXBcIiAmJiBpc0RlZmluZWQoYWRkTGF5ZXJJZCkpIHtcbiAgICAgIGdldExheWVyc0FuZFRhYmxlcyhhZGRMYXllcikuZm9yRWFjaCgobHlyKSA9PiB7XG4gICAgICAgIGlmIChhZGRMYXllcklkID09PSBseXIubGF5ZXJJZCkge1xuICAgICAgICAgIGFkZEZMID0gbHlyO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG4gICAgZWxzZSBpZiAoYWRkTGF5ZXIgJiYgYWRkTGF5ZXIudHlwZSAhPT0gXCJncm91cFwiKSB7XG4gICAgICBhZGRGTCA9IGFkZExheWVyO1xuICAgIH1cbiAgICBjb25zdCBuZXh0RGlzYWJsZWQgPSAhYWRkTGF5ZXIgfHwgIWlzRGVmaW5lZChhZGRMYXllcklkKSB8fCAoYWRkSXRlbS5wb3J0YWwuaXNQb3J0YWwgJiYgaGFzT0JBQyhhZGRGTCkpO1xuICAgIHJldHVybiAoaChcImRpdlwiLCB7IHNsb3Q6IFwiZm9vdGVyXCIsIGNsYXNzOiBDU1MkNi5mb290ZXIgfSwgaChcImNhbGNpdGUtYnV0dG9uXCIsIHsgb25DbGljazogdGhpcy5nb0JhY2ssIGFwcGVhcmFuY2U6IFwib3V0bGluZS1maWxsXCIsIHdpZHRoOiBcImhhbGZcIiwgXCJpY29uLXN0YXJ0XCI6IGlzUnRsID8gXCJhcnJvdy1yaWdodFwiIDogXCJhcnJvdy1sZWZ0XCIsIHJlZjogKG5vZGUpID0+ICh0aGlzLmJhY2tCdXR0b25Ob2RlID0gbm9kZSkgfSwgc3RyaW5ncy5nZW5lcmFsLmJhY2spLCBoKFwiY2FsY2l0ZS1idXR0b25cIiwgeyBkaXNhYmxlZDogbmV4dERpc2FibGVkLCBvbkNsaWNrOiAhbmV4dERpc2FibGVkICYmIHRoaXMuZ29OZXh0LCBhcHBlYXJhbmNlOiBcInNvbGlkXCIsIHdpZHRoOiBcImhhbGZcIiwgaWNvbkVuZDogaXNSdGwgPyBcImFycm93LWxlZnRcIiA6IFwiYXJyb3ctcmlnaHRcIiwgcmVmOiAobm9kZSkgPT4gKHRoaXMubmV4dEJ1dHRvbk5vZGUgPSBub2RlKSB9LCBzdHJpbmdzLmdlbmVyYWwubmV4dCkpKTtcbiAgfVxuICByZW5kZXJPQkFDTXNnKCkge1xuICAgIGNvbnN0IHsgcHJvcHMgfSA9IHRoaXM7XG4gICAgY29uc3QgeyBjb25maWcsIGFkZEl0ZW0sIGFkZExheWVySWQsIGFkZExheWVyLCBzdHJpbmdzIH0gPSBwcm9wcztcbiAgICBjb25zdCB7IGhlbHBCYXNlLCBoZWxwTWFwIH0gPSBjb25maWc7XG4gICAgaWYgKCFhZGRMYXllcikge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAoIWFkZEl0ZW0ucG9ydGFsLmlzUG9ydGFsKSB7XG4gICAgICAvLyBtZXNzYWdlIG9ubHkgZm9yIEVudGVycHJpc2VcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgbGV0IGFkZEZMO1xuICAgIGlmIChhZGRMYXllci50eXBlID09PSBcImdyb3VwXCIgJiYgaXNEZWZpbmVkKGFkZExheWVySWQpKSB7XG4gICAgICBhZGRGTCA9IGdldExheWVyc0FuZFRhYmxlcyhhZGRMYXllcikuZmluZCgobHlyKSA9PiBhZGRMYXllcklkID09PSBseXIubGF5ZXJJZCk7XG4gICAgfVxuICAgIGVsc2UgaWYgKGFkZExheWVyLnR5cGUgIT09IFwiZ3JvdXBcIikge1xuICAgICAgYWRkRkwgPSBhZGRMYXllcjtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmICghaGFzT0JBQyhhZGRGTCkpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgcmV0dXJuIChoKFwiY2FsY2l0ZS1ub3RpY2VcIiwgeyBrZXk6IGAke2hhc09CQUMoYWRkRkwpfWAsIGNsYXNzOiBcIm5vdGljZVwiLCBvcGVuOiB0cnVlLCBjbG9zYWJsZTogZmFsc2UsIHNjYWxlOiBcInNcIiwgd2lkdGg6IFwiYXV0b1wiLCBraW5kOiBcIndhcm5pbmdcIiwgaWNvbjogXCJleGNsYW1hdGlvbi1tYXJrLXRyaWFuZ2xlXCIgfSwgaChcImRpdlwiLCB7IHNsb3Q6IFwibWVzc2FnZVwiIH0sIHN0cmluZ3Muam9pbi5vYmFjTm90U3VwcG9ydGVkTXNnKSwgaChcImNhbGNpdGUtbGlua1wiLCB7IHNsb3Q6IFwibGlua1wiLCB0aXRsZTogc3RyaW5ncy5qb2luLmxlYXJuTW9yZSwgdGFyZ2V0OiBcIl9ibGFua1wiLCBocmVmOiBgJHtoZWxwQmFzZX0ke2hlbHBNYXBbXCIxMjAwMDQxODRcIl19YCB9LCBzdHJpbmdzLmpvaW4ubGVhcm5Nb3JlKSkpO1xuICB9XG4gIHJlbmRlckJyb3dzZSgpIHtcbiAgICBjb25zdCB7IHByb3BzIH0gPSB0aGlzO1xuICAgIGNvbnN0IHsgc3RyaW5ncyB9ID0gcHJvcHM7XG4gICAgcmV0dXJuIChoKFwiZGl2XCIsIG51bGwsIGgoXCJkaXZcIiwgeyBjbGFzczogQ1NTJDYuaW5mbyB9LCBoKFwiZGl2XCIsIHsgY2xhc3M6IENTUyQ2LnRleHQgfSwgc3RyaW5ncy5qb2luLnNlbGVjdEFkZExheWVyUGFuZWxEZXNjcmlwdGlvbikpLCBoKFwiZGl2XCIsIHsgY2xhc3M6IENTUyQ2LmZvb3RlckJ1dHRvbiB9LCBoKFwiY2FsY2l0ZS1idXR0b25cIiwgeyBpZDogXCJhcmNnaXMtbGF5ZXItdmlldy1qb2luLWJyb3dzZVwiLCBvbkNsaWNrOiB0aGlzLmdvQnJvd3NlLCBhcHBlYXJhbmNlOiBcIm91dGxpbmUtZmlsbFwiLCB3aWR0aDogXCJmdWxsXCIsIHJlZjogKG5vZGUpID0+ICh0aGlzLmJyb3dzZUJ1dHRvbk5vZGUgPSBub2RlKSB9LCBzdHJpbmdzLmpvaW4uYnJvd3NlRm9yTGF5ZXIpKSkpO1xuICB9XG4gIHJlbmRlckJyb3dzZUxheWVyKCkge1xuICAgIGNvbnN0IHsgcHJvcHMgfSA9IHRoaXM7XG4gICAgcmV0dXJuIChoKFwiYXJjZ2lzLWxheWVyLXZpZXctam9pbi1icm93c2UtbGF5ZXJcIiwgeyBwcm9wczogcHJvcHMsIGNsYXNzOiBDU1MkNi5icm93c2UsIG9uQXJjZ2lzTGF5ZXJWaWV3Sm9pblN0YXR1c0NoYW5nZTogKGV2ZW50KSA9PiB7XG4gICAgICAgIGlmIChldmVudC5kZXRhaWwuc3RhdHVzID09PSBqb2luRmxvd1N0YXR1cy5BRERfU0VMRUNUSU9OKSB7XG4gICAgICAgICAgLy8gY2FuJ3QgbWFrZSBpdCB3b3JrIHdpdGhvdXQgdXNpbmcgYW4gaWRcbiAgICAgICAgICAvLyBpdCBzZWVtcyB0aGUgd2hvbGUgY29tcG9uZW50IHJlbG9hZHMgZnJvbSBzY3JhdGNoIGFmdGVyIHRoaXMgc3RlcCBoZXJlXG4gICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICB2YXIgX2E7XG4gICAgICAgICAgICByZXR1cm4gKF9hID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJhcmNnaXMtbGF5ZXItdmlldy1qb2luLWJyb3dzZVwiKSkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLnNldEZvY3VzKCk7XG4gICAgICAgICAgfSwgNDAwKTtcbiAgICAgICAgfVxuICAgICAgfSB9KSk7XG4gIH1cbiAgcmVuZGVyU3VibGF5ZXJzKCkge1xuICAgIGNvbnN0IHsgcHJvcHMgfSA9IHRoaXM7XG4gICAgY29uc3QgeyB0YXJnZXRMYXllciwgYWRkSXRlbSwgYWRkTGF5ZXIsIHRhcmdldExheWVySWQsIHN0cmluZ3MgfSA9IHByb3BzO1xuICAgIGlmICghYWRkTGF5ZXIpIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgICBjb25zdCBsaXN0SXRlbXMgPSBbXTtcbiAgICBpZiAoYWRkTGF5ZXIudHlwZSA9PT0gXCJncm91cFwiKSB7XG4gICAgICBnZXRMYXllcnNBbmRUYWJsZXMoYWRkTGF5ZXIpLmZvckVhY2goKGx5cikgPT4ge1xuICAgICAgICBpZiAodGFyZ2V0TGF5ZXIuaWQgIT09IGFkZExheWVyLmlkIHx8IHRhcmdldExheWVySWQgIT09IGx5ci5sYXllcklkKSB7XG4gICAgICAgICAgbGlzdEl0ZW1zLnVuc2hpZnQodGhpcy5yZW5kZXJTdWJsYXllcihseXIpKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgbGlzdEl0ZW1zLnB1c2godGhpcy5yZW5kZXJTdWJsYXllcihhZGRMYXllcikpO1xuICAgIH1cbiAgICBjb25zdCBzdHIgPSBzdHJpbmdzLmpvaW4uc2VsZWN0RnJvbUl0ZW07XG4gICAgcmV0dXJuIChoKEZyYWdtZW50LCBudWxsLCBoKFwiZGl2XCIsIHsgY2xhc3M6IENTUyQ2Lmxpc3RIZWFkZXIgfSwgaChcImRpdlwiLCB7IGNsYXNzOiBDU1MkNi50ZXh0IH0sIHN0ci5zdWJzdHJpbmcoMCwgc3RyLmluZGV4T2YoXCIke1wiKSksIGgoXCJiXCIsIG51bGwsIGFkZEl0ZW0udGl0bGUpLCBzdHIuc3Vic3RyaW5nKHN0ci5pbmRleE9mKFwifVwiKSArIDEpKSksIGgoXCJjYWxjaXRlLXBpY2stbGlzdFwiLCB7IG11bHRpcGxlOiBmYWxzZSwgb25DYWxjaXRlTGlzdENoYW5nZTogdGhpcy5vblNlbGVjdGlvbkNoYW5nZSwgcmVmOiAobm9kZSkgPT4gKHRoaXMubGlzdE5vZGUgPSBub2RlKSB9LCBsaXN0SXRlbXMpKSk7XG4gIH1cbiAgcmVuZGVyU3VibGF5ZXIobHlyKSB7XG4gICAgY29uc3QgeyBwcm9wcyB9ID0gdGhpcztcbiAgICBjb25zdCB7IGFkZExheWVySWQgfSA9IHByb3BzO1xuICAgIHJldHVybiAoaChcImNhbGNpdGUtcGljay1saXN0LWl0ZW1cIiwgeyBrZXk6IGx5ci5sYXllcklkLCBsYWJlbDogbHlyLnRpdGxlLCB2YWx1ZTogbHlyLmxheWVySWQsIGRlc2NyaXB0aW9uOiBnZXRMYXllclR5cGUobHlyLCBwcm9wcyksIHNlbGVjdGVkOiBhZGRMYXllcklkID09PSBseXIubGF5ZXJJZCB9KSk7XG4gIH1cbiAgZ2V0IGhvc3RFbGVtZW50KCkgeyByZXR1cm4gZ2V0RWxlbWVudCh0aGlzKTsgfVxufTtcbkFyY2dpc0xheWVyVmlld0pvaW5BZGRTZWxlY3Rpb24uc3R5bGUgPSBhcmNnaXNMYXllclZpZXdKb2luQWRkU2VsZWN0aW9uQ3NzO1xuXG5jb25zdCBhcmNnaXNMYXllclZpZXdKb2luQnJvd3NlTGF5ZXJDc3MgPSBcIi5wYW5lbC5zYy1hcmNnaXMtbGF5ZXItdmlldy1qb2luLWJyb3dzZS1sYXllcntoZWlnaHQ6MTAwJX1cIjtcblxuY29uc3QgQXJjZ2lzTGF5ZXJWaWV3Sm9pbkJyb3dzZUxheWVyID0gY2xhc3Mge1xuICBjb25zdHJ1Y3Rvcihob3N0UmVmKSB7XG4gICAgcmVnaXN0ZXJJbnN0YW5jZSh0aGlzLCBob3N0UmVmKTtcbiAgICB0aGlzLmFyY2dpc0xheWVyVmlld0pvaW5TdGF0dXNDaGFuZ2UgPSBjcmVhdGVFdmVudCh0aGlzLCBcImFyY2dpc0xheWVyVmlld0pvaW5TdGF0dXNDaGFuZ2VcIiwgNyk7XG4gICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICAvL1xuICAgIC8vICBQcml2YXRlIG1ldGhvZHNcbiAgICAvL1xuICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgdGhpcy5vbkJhY2sgPSAoKSA9PiB7XG4gICAgICB0aGlzLmFyY2dpc0xheWVyVmlld0pvaW5TdGF0dXNDaGFuZ2UuZW1pdCh7IHN0YXR1czogam9pbkZsb3dTdGF0dXMuQUREX1NFTEVDVElPTiB9KTtcbiAgICB9O1xuICAgIHRoaXMuZ29Vc2VMYXllciA9IGFzeW5jIChpdGVtSWQpID0+IHtcbiAgICAgIHZhciBfYSwgX2I7XG4gICAgICBjb25zdCB7IHByb3BzIH0gPSB0aGlzO1xuICAgICAgY29uc3QgeyBhZGRMYXllciwgdGFyZ2V0TGF5ZXIsIHZpZXcsIG1vZHVsZXMgfSA9IHByb3BzO1xuICAgICAgdGhpcy5sb2FkaW5nID0gdHJ1ZTtcbiAgICAgIGlmIChhZGRMYXllciAmJiBhZGRMYXllci5pZCAhPT0gdGFyZ2V0TGF5ZXIuaWQpIHtcbiAgICAgICAgdmlldy5tYXAucmVtb3ZlKGFkZExheWVyKTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IGFkZEl0ZW0gPSBuZXcgbW9kdWxlcy5Qb3J0YWxJdGVtKHtcbiAgICAgICAgaWQ6IGl0ZW1JZFxuICAgICAgfSk7XG4gICAgICBhd2FpdCBhZGRJdGVtLmxvYWQoKTtcbiAgICAgIGNvbnN0IG5ld0FkZExheWVyID0gYXdhaXQgbW9kdWxlcy5MYXllci5mcm9tUG9ydGFsSXRlbSh7XG4gICAgICAgIHBvcnRhbEl0ZW06IGFkZEl0ZW1cbiAgICAgIH0pO1xuICAgICAgaWYgKG5ld0FkZExheWVyLnR5cGUgPT09IFwiZ3JvdXBcIikge1xuICAgICAgICAvLyBncm91cCBsYXllciBoYXMgbm8gbGF5ZXJzIG9yIHRhYmxlcyBhdCB0aGlzIHBvaW50XG4gICAgICAgIC8vIGxvYWRBbGwoKSBsb2FkcyBsYXllcnMgYW5kIHRhYmxlcyAoYXQgdjQuMjMpXG4gICAgICAgIGF3YWl0IG5ld0FkZExheWVyLmxvYWRBbGwoKTtcbiAgICAgICAgaWYgKChfYSA9IG5ld0FkZExheWVyLmxheWVycykgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmxlbmd0aCkge1xuICAgICAgICAgIC8vIGhhcyBhdCBsZWFzdCBvbmUgc3BhdGlhbCBsYXllclxuICAgICAgICAgIHZpZXcubWFwLmFkZChuZXdBZGRMYXllcik7XG4gICAgICAgIH1cbiAgICAgICAgLy8gZGVmYXVsdCBwb3B1cHNcbiAgICAgICAgKF9iID0gbmV3QWRkTGF5ZXIubGF5ZXJzKSA9PT0gbnVsbCB8fCBfYiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2IuZm9yRWFjaCgobHlyKSA9PiB7XG4gICAgICAgICAgaWYgKCFseXIucG9wdXBUZW1wbGF0ZSAmJiBseXIucG9wdXBFbmFibGVkKSB7XG4gICAgICAgICAgICBseXIucG9wdXBUZW1wbGF0ZSA9IGx5ci5jcmVhdGVQb3B1cFRlbXBsYXRlKCk7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICAgIGVsc2Uge1xuICAgICAgICBhd2FpdCBuZXdBZGRMYXllci5sb2FkKCk7XG4gICAgICAgIGlmICghbmV3QWRkTGF5ZXIuaXNUYWJsZSkge1xuICAgICAgICAgIHZpZXcubWFwLmFkZChuZXdBZGRMYXllcik7XG4gICAgICAgIH1cbiAgICAgICAgLy8gZGVmYXVsdCBwb3B1cFxuICAgICAgICBuZXdBZGRMYXllci5wb3B1cFRlbXBsYXRlID0gbmV3QWRkTGF5ZXIuY3JlYXRlUG9wdXBUZW1wbGF0ZSgpO1xuICAgICAgfVxuICAgICAgcHJvcHMuYWRkSXRlbSA9IGFkZEl0ZW07XG4gICAgICBwcm9wcy5hZGRMYXllciA9IG5ld0FkZExheWVyO1xuICAgICAgcHJvcHMuYWRkTGF5ZXJJZCA9IHVuZGVmaW5lZDtcbiAgICAgIHByb3BzLmpvaW5PcGVyYXRpb24gPSB1bmRlZmluZWQ7XG4gICAgICB0aGlzLmFyY2dpc0xheWVyVmlld0pvaW5TdGF0dXNDaGFuZ2UuZW1pdCh7IHN0YXR1czogam9pbkZsb3dTdGF0dXMuQUREX1NFTEVDVElPTiB9KTtcbiAgICB9O1xuICAgIHRoaXMucHJvcHMgPSB1bmRlZmluZWQ7XG4gICAgdGhpcy5sb2FkaW5nID0gZmFsc2U7XG4gICAgdGhpcy5pdGVtcyA9IHVuZGVmaW5lZDtcbiAgICB0aGlzLnBhZ2luYXRpb24gPSB1bmRlZmluZWQ7XG4gICAgdGhpcy5lcnJvciA9IHVuZGVmaW5lZDtcbiAgfVxuICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIC8vXG4gIC8vICBMaWZlY3ljbGVcbiAgLy9cbiAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICBhc3luYyBjb21wb25lbnREaWRMb2FkKCkge1xuICAgIHNldFRpbWVvdXQoKCkgPT4gcmVxdWVzdEFuaW1hdGlvbkZyYW1lKCgpID0+IHsgdmFyIF9hOyByZXR1cm4gKF9hID0gdGhpcy5mbG93SXRlbU5vZGUpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5zZXRGb2N1cygpOyB9KSwgMjAwKTtcbiAgfVxuICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAvL1xuICAvLyAgUmVuZGVyIE1ldGhvZHNcbiAgLy9cbiAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICByZW5kZXIoKSB7XG4gICAgY29uc3QgeyBwcm9wcywgbG9hZGluZywgaG9zdEVsZW1lbnQgfSA9IHRoaXM7XG4gICAgY29uc3QgeyBzdHJpbmdzIH0gPSBwcm9wcztcbiAgICBjb25zdCBydGwgPSBnZXRFbGVtZW50RGlyKGhvc3RFbGVtZW50KSA9PT0gXCJydGxcIjtcbiAgICByZXR1cm4gKGgoSG9zdCwgeyBjbGFzczogXCJjYWxjaXRlLW1hdGNoLWhlaWdodFwiIH0sIGgoXCJjYWxjaXRlLWZsb3ctaXRlbVwiLCB7IGhlYWRpbmc6IHN0cmluZ3Muam9pbi5icm93c2VGb3JMYXllclRpdGxlLCBkZXNjcmlwdGlvbjogc3RyaW5ncy5qb2luLmJyb3dzZUZvckxheWVyU3ViVGl0bGUsIGxvYWRpbmc6IGxvYWRpbmcsIGNsYXNzOiB7XG4gICAgICAgIHBhbmVsOiB0cnVlLFxuICAgICAgICBbQ1NTX1VUSUxJVFkucnRsXTogcnRsXG4gICAgICB9LCBvbkNhbGNpdGVGbG93SXRlbUJhY2s6IHRoaXMub25CYWNrLCByZWY6IChub2RlKSA9PiAodGhpcy5mbG93SXRlbU5vZGUgPSBub2RlKSB9LCB0aGlzLnJlbmRlckl0ZW1Ccm93c2VyKCkpKSk7XG4gIH1cbiAgcmVuZGVySXRlbUJyb3dzZXIoKSB7XG4gICAgY29uc3QgeyBwcm9wcywgcGFnaW5hdGlvbiB9ID0gdGhpcztcbiAgICBjb25zdCB7IHRhcmdldEl0ZW0sIHRhcmdldExheWVyLCBpdGVtSWQsIHN0cmluZ3MgfSA9IHByb3BzO1xuICAgIGNvbnN0IHsgcG9ydGFsSXRlbSB9ID0gdGFyZ2V0TGF5ZXI7XG4gICAgY29uc3QgeyBwb3J0YWwgfSA9IHBvcnRhbEl0ZW07XG4gICAgY29uc3QgdXNlciA9IHBvcnRhbC51c2VyO1xuICAgIGNvbnN0IHF1ZXJ5ID0gYHR5cGU6XCJGZWF0dXJlIFNlcnZpY2VcIiB0eXBla2V5d29yZHM6XCJIb3N0ZWQgU2VydmljZVwiIC10eXBla2V5d29yZHM6XCJWaWV3IFNlcnZpY2VcIiAtdHlwZWtleXdvcmRzOlwiU3BhdGlvdGVtcG9yYWxcIiBvd25lcjpcIiR7dGFyZ2V0SXRlbS5vd25lcn1cIiAtaWQ6JHtpdGVtSWR9YDtcbiAgICBjb25zdCBiYXNlVXJsID0gYCR7Z2V0UG9ydGFsQmFzZVVybChwb3J0YWwpfS9ob21lL2A7XG4gICAgcmV0dXJuIChoKFwiYXJjZ2lzLWl0ZW0tYnJvd3NlclwiLCB7IG9uQXJjZ2lzSXRlbUJyb3dzZXJVcGRhdGU6IChlKSA9PiB7XG4gICAgICAgIGNvbnN0IHsgcmVzdWx0cywgbnVtLCBzdGFydCwgdG90YWwgfSA9IGUuZGV0YWlsO1xuICAgICAgICB0aGlzLml0ZW1zID0gcmVzdWx0cztcbiAgICAgICAgdGhpcy5wYWdpbmF0aW9uID0geyBzdGFydCwgbnVtLCB0b3RhbCB9O1xuICAgICAgfSwgZmlsdGVyOiBxdWVyeSwgcG9ydGFsOiBwb3J0YWwsIHVzZXI6IHVzZXIsIGFwaTogNCwgY29uZmlnOiB7IGJhc2VVcmwgfSwgc2VsZWN0aW9uOiBcIm5vbmVcIiB9LCBoKFwiYXJjZ2lzLWl0ZW0tYnJvd3Nlci10b3AtYmFyXCIsIHsgc2xvdDogXCJ0b3AtYmFyXCIgfSwgaChcImFyY2dpcy1pdGVtLWJyb3dzZXItc2VhcmNoXCIsIHsgc2xvdDogXCJzZWFyY2hcIiwgdGVybTogXCJcIiB9KSksIGgoXCJhcmNnaXMtaXRlbS1icm93c2VyLXNvcnRcIiwgeyBvcHRpb25zOiBbXCJtb2RpZmllZFwiLCBcInRpdGxlXCIsIFwicmVsZXZhbmNlXCJdLCBzbG90OiBcInNvcnRcIiB9KSwgaChcImFyY2dpcy1pdGVtLWJyb3dzZXItY29udGVudFwiLCB7IHNsb3Q6IFwiY29udGVudFwiIH0sICh0aGlzLml0ZW1zIHx8IFtdKS5tYXAoKGl0ZW0pID0+IChoKFwiYXJjZ2lzLWl0ZW0tYnJvd3Nlci1jYXJkXCIsIHsgaXRlbTogaXRlbSwgcG9ydGFsOiBwb3J0YWwsIGJhc2VVcmw6IGJhc2VVcmwsIGtleTogaXRlbS5pZCB9LCBoKFwiY2FsY2l0ZS1hY3Rpb25cIiwgeyBpZDogYGpvaW4tYWN0aW9uLSR7aXRlbS5pZH1gLCBpY29uOiBcInBsdXMtY2lyY2xlXCIsIHRleHQ6IFwiXCIsIHNjYWxlOiBcInNcIiwgc2xvdDogXCJhY3Rpb25zLWVuZFwiLCBvbkNsaWNrOiB0aGlzLmdvVXNlTGF5ZXIuYmluZCh0aGlzLCBpdGVtLmlkKSB9LCBoKFwiY2FsY2l0ZS10b29sdGlwXCIsIHsgc2xvdDogXCJ0b29sdGlwXCIsIGxhYmVsOiBzdHJpbmdzLmpvaW4uc2VsZWN0LCBvdmVybGF5UG9zaXRpb25pbmc6IFwiZml4ZWRcIiB9LCBzdHJpbmdzLmpvaW4uc2VsZWN0KSkpKSkpLCBoKFwiYXJjZ2lzLWl0ZW0tYnJvd3Nlci1wYWdpbmF0aW9uXCIsIHsgdG90YWw6IHBhZ2luYXRpb24gPT09IG51bGwgfHwgcGFnaW5hdGlvbiA9PT0gdm9pZCAwID8gdm9pZCAwIDogcGFnaW5hdGlvbi50b3RhbCwgc3RhcnQ6IHBhZ2luYXRpb24gPT09IG51bGwgfHwgcGFnaW5hdGlvbiA9PT0gdm9pZCAwID8gdm9pZCAwIDogcGFnaW5hdGlvbi5zdGFydCwgbnVtOiBwYWdpbmF0aW9uID09PSBudWxsIHx8IHBhZ2luYXRpb24gPT09IHZvaWQgMCA/IHZvaWQgMCA6IHBhZ2luYXRpb24ubnVtLCBzbG90OiBcInBhZ2luYXRpb25cIiB9KSkpO1xuICB9XG4gIGdldCBob3N0RWxlbWVudCgpIHsgcmV0dXJuIGdldEVsZW1lbnQodGhpcyk7IH1cbn07XG5BcmNnaXNMYXllclZpZXdKb2luQnJvd3NlTGF5ZXIuc3R5bGUgPSBhcmNnaXNMYXllclZpZXdKb2luQnJvd3NlTGF5ZXJDc3M7XG5cbmNvbnN0IENTUyQ1ID0ge1xuICBmbG93OiBcImZsb3dcIixcbiAgcGFuZWw6IFwicGFuZWxcIixcbiAgZm9vdGVyOiBcImZvb3RlclwiLFxuICBsYXllclNlY3Rpb246IFwibGF5ZXItc2VjdGlvblwiLFxuICB0YXJnZXRMYXllcjogXCJ0YXJnZXQtbGF5ZXJcIixcbiAgYWRkTGF5ZXI6IFwiYWRkLWxheWVyXCIsXG4gIGxheWVySGVhZGVyOiBcImxheWVyLWhlYWRlclwiLFxuICBsYXllclRpdGxlOiBcImxheWVyLXRpdGxlXCIsXG4gIGxheWVySWNvbjogXCJsYXllci1pY29uXCIsXG4gIGF0dHJpYnV0ZVJlbGF0aW9uc2hpcDogXCJhdHRyaWJ1dGUtcmVsYXRpb25zaGlwXCIsXG4gIHJlbW92ZUF0dHJpYnV0ZVJlbGF0aW9uc2hpcDogXCJyZW1vdmUtYXR0cmlidXRlLXJlbGF0aW9uc2hpcFwiLFxuICBzb3J0QnlTZWN0aW9uOiBcInNvcnQtYnktc2VjdGlvblwiLFxuICBqb2luTWF0Y2hUeXBlU2VjdGlvbjogXCJqb2luLW1hdGNoLXR5cGUtc2VjdGlvblwiLFxuICBjaGlwOiBcImNoaXBcIixcbiAgc2VwYXJhdG9yOiBcInNlcGFyYXRvclwiLFxuICBzdGF0c1NlY3Rpb246IFwic3RhdHMtc2VjdGlvblwiLFxuICBzdGF0c0ZpZWxkSGVhZGVyOiBcInN0YXRzLWZpZWxkLWhlYWRlclwiLFxuICBzdGF0c0J1dHRvbjogXCJzdGF0cy1idXR0b25cIixcbiAgc2VsZWN0QWxsOiBcInNlbGVjdC1hbGxcIixcbiAgc2VsZWN0OiBcInNlbGVjdFwiXG59O1xuXG5jb25zdCBhcmNnaXNMYXllclZpZXdKb2luQ29uZmlnQ3NzID0gXCIuZmxvd3toZWlnaHQ6MTAwJX0ucGFuZWx7aGVpZ2h0OjEwMCV9LmZvb3Rlcnt3aWR0aDoxMDAlfS5sYXllci1zZWN0aW9ue2JvcmRlcjoxcHggc29saWQgdmFyKC0tY2FsY2l0ZS11aS1ib3JkZXItMyk7YmFja2dyb3VuZC1jb2xvcjp3aGl0ZTttYXJnaW46MTBweH0udGFyZ2V0LWxheWVye3BhZGRpbmc6MTBweDtib3JkZXItYm90dG9tOjFweCBzb2xpZCB2YXIoLS1jYWxjaXRlLXVpLWJvcmRlci0zKTtkaXNwbGF5OmZsZXg7anVzdGlmeS1jb250ZW50OnNwYWNlLWJldHdlZW59LmFkZC1sYXllcntwYWRkaW5nOjEwcHg7ZGlzcGxheTpmbGV4O2p1c3RpZnktY29udGVudDpzcGFjZS1iZXR3ZWVufS5sYXllci1oZWFkZXJ7cGFkZGluZy1ib3R0b206M3B4O292ZXJmbG93LXdyYXA6YW55d2hlcmV9LmxheWVyLXRpdGxle2ZvbnQtd2VpZ2h0OmJvbGQ7b3ZlcmZsb3ctd3JhcDphbnl3aGVyZX0ubGF5ZXItaWNvbnthbGlnbi1zZWxmOmNlbnRlcjtjdXJzb3I6cG9pbnRlcn0uYXR0cmlidXRlLXJlbGF0aW9uc2hpcHtib3JkZXI6MXB4IHNvbGlkIHZhcigtLWNhbGNpdGUtdWktYm9yZGVyLTMpO3BhZGRpbmc6MTBweCAxMHB4IDAgMTBweDttYXJnaW4tYm90dG9tOjEwcHh9LnJlbW92ZS1hdHRyaWJ1dGUtcmVsYXRpb25zaGlwe2Rpc3BsYXk6ZmxleDtqdXN0aWZ5LWNvbnRlbnQ6ZmxleC1lbmR9LmpvaW4tbWF0Y2gtdHlwZS1zZWN0aW9ue3BhZGRpbmc6MTBweCAwfS5pbmZve2Rpc3BsYXk6ZmxleDtqdXN0aWZ5LWNvbnRlbnQ6c3BhY2UtYmV0d2Vlbn0uaW5mby1sYWJlbHtkaXNwbGF5OmZsZXg7YWxpZ24taXRlbXM6Y2VudGVyfS5jaGlwe21hcmdpbi1ib3R0b206NXB4fS5zb3J0LWJ5LXNlY3Rpb257Ym9yZGVyOjFweCBzb2xpZCB2YXIoLS1jYWxjaXRlLXVpLWJvcmRlci0zKTtwYWRkaW5nOjEwcHggMTBweCAwIDEwcHg7bWFyZ2luOjEwcHggMH0uc2VwYXJhdG9ye2JvcmRlci1ib3R0b206MXB4IHNvbGlkIHZhcigtLWNhbGNpdGUtdWktYm9yZGVyLTMpO21hcmdpbjoxMHB4IDAgMTVweCAwfS5zdGF0cy1zZWN0aW9ue2JvcmRlcjoxcHggc29saWQgdmFyKC0tY2FsY2l0ZS11aS1ib3JkZXItMyk7cGFkZGluZzoxMHB4IDEwcHggMCAxMHB4O21hcmdpbi1ib3R0b206MTBweH0uc3RhdHMtZmllbGQtaGVhZGVye292ZXJmbG93LXdyYXA6YW55d2hlcmU7d2lkdGg6MTAwJX0uc3RhdHMtYnV0dG9ue21hcmdpbi1ib3R0b206MTBweH0uc2VsZWN0e2N1cnNvcjpwb2ludGVyfVwiO1xuXG5jb25zdCBBcmNnaXNMYXllclZpZXdKb2luQ29uZmlnID0gY2xhc3Mge1xuICBjb25zdHJ1Y3Rvcihob3N0UmVmKSB7XG4gICAgcmVnaXN0ZXJJbnN0YW5jZSh0aGlzLCBob3N0UmVmKTtcbiAgICB0aGlzLmFyY2dpc0xheWVyVmlld0pvaW5TdGF0dXNDaGFuZ2UgPSBjcmVhdGVFdmVudCh0aGlzLCBcImFyY2dpc0xheWVyVmlld0pvaW5TdGF0dXNDaGFuZ2VcIiwgNyk7XG4gICAgdGhpcy5hcmNnaXNMYXllclZpZXdKb2luQ29uZmlnVGFibGVDbGljayA9IGNyZWF0ZUV2ZW50KHRoaXMsIFwiYXJjZ2lzTGF5ZXJWaWV3Sm9pbkNvbmZpZ1RhYmxlQ2xpY2tcIiwgNyk7XG4gICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICAvL1xuICAgIC8vICBQcml2YXRlIG1ldGhvZHNcbiAgICAvL1xuICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgdGhpcy5nb0JhY2sgPSAoKSA9PiB7XG4gICAgICB0aGlzLmFyY2dpc0xheWVyVmlld0pvaW5TdGF0dXNDaGFuZ2UuZW1pdCh7XG4gICAgICAgIHN0YXR1czogam9pbkZsb3dTdGF0dXMuQUREX1NFTEVDVElPTlxuICAgICAgfSk7XG4gICAgfTtcbiAgICB0aGlzLmdvTmV4dCA9ICgpID0+IHtcbiAgICAgIGNvbnN0IHsgcHJvcHMgfSA9IHRoaXM7XG4gICAgICBjb25zdCB7IGF0dHJpYnV0ZVJlbGF0aW9uc2hpcHMgfSA9IHByb3BzO1xuICAgICAgLy8gY2xlYW4gdXBcbiAgICAgIHByb3BzLmF0dHJpYnV0ZVJlbGF0aW9uc2hpcHMgPSBhdHRyaWJ1dGVSZWxhdGlvbnNoaXBzLmZpbHRlcigocmVsKSA9PiByZWwudGFyZ2V0RmllbGROYW1lICYmIHJlbC5hZGRGaWVsZE5hbWUpO1xuICAgICAgdGhpcy5hcmNnaXNMYXllclZpZXdKb2luU3RhdHVzQ2hhbmdlLmVtaXQoe1xuICAgICAgICBzdGF0dXM6IGpvaW5GbG93U3RhdHVzLkNSRUFURVxuICAgICAgfSk7XG4gICAgfTtcbiAgICB0aGlzLm9uVGFyZ2V0RmllbGRTZWxlY3QgPSAocmVsKSA9PiB7XG4gICAgICBjb25zdCB7IHByb3BzLCB0YXJnZXRGTCB9ID0gdGhpcztcbiAgICAgIGNvbnN0IHsgc3RyaW5ncyB9ID0gcHJvcHM7XG4gICAgICBjb25zdCB7IHRhcmdldEZpZWxkTmFtZSB9ID0gcmVsO1xuICAgICAgY29uc3Qgc2hhcGVGaWVsZHMgPSB0YXJnZXRGTC5maWVsZHMuZmlsdGVyKChmaWVsZCkgPT4gZmllbGQubmFtZS50b0xvd2VyQ2FzZSgpLnN0YXJ0c1dpdGgoXCJzaGFwZV9fXCIpKTtcbiAgICAgIHRoaXMub3BlbkZpZWxkUGlja0xpc3Qoe1xuICAgICAgICBsYXllcjogdGFyZ2V0RkwsXG4gICAgICAgIGZpZWxkTmFtZTogdGFyZ2V0RmllbGROYW1lLFxuICAgICAgICBtdWx0aXBsZTogZmFsc2UsXG4gICAgICAgIGhlYWRpbmc6IHN0cmluZ3Muam9pbi50YXJnZXRGaWVsZHMsXG4gICAgICAgIGZpZWxkVHlwZXM6IFtcbiAgICAgICAgICBcInNtYWxsLWludGVnZXJcIixcbiAgICAgICAgICBcImJpZy1pbnRlZ2VyXCIsXG4gICAgICAgICAgXCJpbnRlZ2VyXCIsXG4gICAgICAgICAgXCJzaW5nbGVcIixcbiAgICAgICAgICBcImRvdWJsZVwiLFxuICAgICAgICAgIFwibG9uZ1wiLFxuICAgICAgICAgIFwibnVtYmVyXCIsXG4gICAgICAgICAgXCJkYXRlXCIsXG4gICAgICAgICAgXCJkYXRlLW9ubHlcIixcbiAgICAgICAgICBcInRpbWUtb25seVwiLFxuICAgICAgICAgIFwidGltZXN0YW1wLW9mZnNldFwiLFxuICAgICAgICAgIFwic3RyaW5nXCIsXG4gICAgICAgICAgXCJndWlkXCIsXG4gICAgICAgICAgXCJnbG9iYWwtaWRcIlxuICAgICAgICBdLFxuICAgICAgICBleGNsdWRlZEZpZWxkczogc2hhcGVGaWVsZHMubWFwKChmaWVsZCkgPT4gZmllbGQubmFtZSksXG4gICAgICAgIGJ1dHRvbk5vZGU6IHRoaXMudGFyZ2V0RmllbGROb2RlLFxuICAgICAgICBvbkNoYW5nZTogKHNlbGVjdGVkRmllbGRzKSA9PiB7XG4gICAgICAgICAgcmVsLnRhcmdldEZpZWxkTmFtZSA9IHNlbGVjdGVkRmllbGRzWzBdO1xuICAgICAgICAgIGZvcmNlVXBkYXRlKHRoaXMuaG9zdEVsZW1lbnQpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9O1xuICAgIHRoaXMub25Kb2luRmllbGRTZWxlY3QgPSAocmVsKSA9PiB7XG4gICAgICBjb25zdCB7IHByb3BzLCBhZGRGTCB9ID0gdGhpcztcbiAgICAgIGNvbnN0IHsgc3RyaW5ncyB9ID0gcHJvcHM7XG4gICAgICBjb25zdCB7IGFkZEZpZWxkTmFtZSB9ID0gcmVsO1xuICAgICAgY29uc3Qgc2hhcGVGaWVsZHMgPSBhZGRGTC5maWVsZHMuZmlsdGVyKChmaWVsZCkgPT4gZmllbGQubmFtZS50b0xvd2VyQ2FzZSgpLnN0YXJ0c1dpdGgoXCJzaGFwZV9fXCIpKTtcbiAgICAgIHRoaXMub3BlbkZpZWxkUGlja0xpc3Qoe1xuICAgICAgICBsYXllcjogYWRkRkwsXG4gICAgICAgIGZpZWxkTmFtZTogYWRkRmllbGROYW1lLFxuICAgICAgICBtdWx0aXBsZTogZmFsc2UsXG4gICAgICAgIGhlYWRpbmc6IHN0cmluZ3Muam9pbi5qb2luRmllbGRzLFxuICAgICAgICBmaWVsZFR5cGVzOiBbXG4gICAgICAgICAgXCJzbWFsbC1pbnRlZ2VyXCIsXG4gICAgICAgICAgXCJiaWctaW50ZWdlclwiLFxuICAgICAgICAgIFwiaW50ZWdlclwiLFxuICAgICAgICAgIFwic2luZ2xlXCIsXG4gICAgICAgICAgXCJkb3VibGVcIixcbiAgICAgICAgICBcImxvbmdcIixcbiAgICAgICAgICBcIm51bWJlclwiLFxuICAgICAgICAgIFwiZGF0ZVwiLFxuICAgICAgICAgIFwiZGF0ZS1vbmx5XCIsXG4gICAgICAgICAgXCJ0aW1lLW9ubHlcIixcbiAgICAgICAgICBcInRpbWVzdGFtcC1vZmZzZXRcIixcbiAgICAgICAgICBcInN0cmluZ1wiLFxuICAgICAgICAgIFwiZ3VpZFwiLFxuICAgICAgICAgIFwiZ2xvYmFsLWlkXCJcbiAgICAgICAgXSxcbiAgICAgICAgZXhjbHVkZWRGaWVsZHM6IHNoYXBlRmllbGRzLm1hcCgoZmllbGQpID0+IGZpZWxkLm5hbWUpLFxuICAgICAgICBidXR0b25Ob2RlOiB0aGlzLmFkZEZpZWxkTm9kZSxcbiAgICAgICAgb25DaGFuZ2U6IChzZWxlY3RlZEZpZWxkcykgPT4ge1xuICAgICAgICAgIHJlbC5hZGRGaWVsZE5hbWUgPSBzZWxlY3RlZEZpZWxkc1swXTtcbiAgICAgICAgICBmb3JjZVVwZGF0ZSh0aGlzLmhvc3RFbGVtZW50KTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfTtcbiAgICB0aGlzLm9uU29ydEJ5RmllbGRTZWxlY3QgPSAoKSA9PiB7XG4gICAgICBjb25zdCB7IHByb3BzLCBhZGRGTCB9ID0gdGhpcztcbiAgICAgIGNvbnN0IHsgam9pbk9wZXJhdGlvbiwgc3RyaW5ncyB9ID0gcHJvcHM7XG4gICAgICBjb25zdCB7IHNvcnRCeUZpZWxkTmFtZSB9ID0gam9pbk9wZXJhdGlvbjtcbiAgICAgIGNvbnN0IHNoYXBlRmllbGRzID0gYWRkRkwuZmllbGRzLmZpbHRlcigoZmllbGQpID0+IGZpZWxkLm5hbWUudG9Mb3dlckNhc2UoKS5zdGFydHNXaXRoKFwic2hhcGVfX1wiKSk7XG4gICAgICB0aGlzLm9wZW5GaWVsZFBpY2tMaXN0KHtcbiAgICAgICAgbGF5ZXI6IGFkZEZMLFxuICAgICAgICBmaWVsZE5hbWU6IHNvcnRCeUZpZWxkTmFtZSxcbiAgICAgICAgbXVsdGlwbGU6IGZhbHNlLFxuICAgICAgICBoZWFkaW5nOiBzdHJpbmdzLmpvaW4uam9pbkZpZWxkcyxcbiAgICAgICAgZmllbGRUeXBlczogW1xuICAgICAgICAgIFwic21hbGwtaW50ZWdlclwiLFxuICAgICAgICAgIFwiYmlnLWludGVnZXJcIixcbiAgICAgICAgICBcImludGVnZXJcIixcbiAgICAgICAgICBcInNpbmdsZVwiLFxuICAgICAgICAgIFwiZG91YmxlXCIsXG4gICAgICAgICAgXCJsb25nXCIsXG4gICAgICAgICAgXCJudW1iZXJcIixcbiAgICAgICAgICBcImRhdGVcIixcbiAgICAgICAgICBcImRhdGUtb25seVwiLFxuICAgICAgICAgIFwidGltZS1vbmx5XCIsXG4gICAgICAgICAgXCJ0aW1lc3RhbXAtb2Zmc2V0XCIsXG4gICAgICAgICAgXCJvaWRcIlxuICAgICAgICBdLFxuICAgICAgICBleGNsdWRlZEZpZWxkczogc2hhcGVGaWVsZHMubWFwKChmaWVsZCkgPT4gZmllbGQubmFtZSksXG4gICAgICAgIGJ1dHRvbk5vZGU6IHRoaXMuc29ydEJ5RmllbGROb2RlLFxuICAgICAgICBvbkNoYW5nZTogKHNlbGVjdGVkRmllbGRzKSA9PiB7XG4gICAgICAgICAgam9pbk9wZXJhdGlvbi5zb3J0QnlGaWVsZE5hbWUgPSBzZWxlY3RlZEZpZWxkc1swXTtcbiAgICAgICAgICBmb3JjZVVwZGF0ZSh0aGlzLmhvc3RFbGVtZW50KTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfTtcbiAgICB0aGlzLm9uU3RhdHNGaWVsZFNlbGVjdCA9ICgpID0+IHtcbiAgICAgIGNvbnN0IHsgcHJvcHMsIGFkZEZMIH0gPSB0aGlzO1xuICAgICAgY29uc3QgeyBqb2luT3BlcmF0aW9uLCBzdHJpbmdzIH0gPSBwcm9wcztcbiAgICAgIGNvbnN0IHsgc3RhdGlzdGljc0ZpZWxkcyB9ID0gam9pbk9wZXJhdGlvbjtcbiAgICAgIGNvbnN0IHNoYXBlRmllbGRzID0gYWRkRkwuZmllbGRzLmZpbHRlcigoZmllbGQpID0+IGZpZWxkLm5hbWUudG9Mb3dlckNhc2UoKS5zdGFydHNXaXRoKFwic2hhcGVfX1wiKSk7XG4gICAgICB0aGlzLm9wZW5GaWVsZFBpY2tMaXN0KHtcbiAgICAgICAgbGF5ZXI6IGFkZEZMLFxuICAgICAgICBmaWVsZE5hbWU6IFwiXCIsXG4gICAgICAgIG11bHRpcGxlOiB0cnVlLFxuICAgICAgICBoZWFkaW5nOiBzdHJpbmdzLmpvaW4uc2VsZWN0RmllbGRzLFxuICAgICAgICBmaWVsZFR5cGVzOiBbXG4gICAgICAgICAgXCJzbWFsbC1pbnRlZ2VyXCIsXG4gICAgICAgICAgXCJiaWctaW50ZWdlclwiLFxuICAgICAgICAgIFwiaW50ZWdlclwiLFxuICAgICAgICAgIFwic2luZ2xlXCIsXG4gICAgICAgICAgXCJkb3VibGVcIixcbiAgICAgICAgICBcImxvbmdcIixcbiAgICAgICAgICBcIm51bWJlclwiLFxuICAgICAgICAgIFwiZGF0ZVwiLFxuICAgICAgICAgIFwiZGF0ZS1vbmx5XCIsXG4gICAgICAgICAgXCJ0aW1lLW9ubHlcIixcbiAgICAgICAgICBcInRpbWVzdGFtcC1vZmZzZXRcIlxuICAgICAgICBdLFxuICAgICAgICBleGNsdWRlZEZpZWxkczogc3RhdGlzdGljc0ZpZWxkc1xuICAgICAgICAgIC5tYXAoKGZpZWxkKSA9PiBmaWVsZC5maWVsZE5hbWUpXG4gICAgICAgICAgLmNvbmNhdChzaGFwZUZpZWxkcy5tYXAoKGZpZWxkKSA9PiBmaWVsZC5uYW1lKSksXG4gICAgICAgIGJ1dHRvbk5vZGU6IHRoaXMuc3RhdHNCdXR0b25Ob2RlLFxuICAgICAgICBvbkNoYW5nZTogKHNlbGVjdGVkRmllbGRzKSA9PiB7XG4gICAgICAgICAgc2VsZWN0ZWRGaWVsZHMuZm9yRWFjaCgoZmllbGROYW1lKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBpc0RhdGUgPSBbXCJkYXRlXCIsIFwiZGF0ZS1vbmx5XCIsIFwidGltZS1vbmx5XCIsIFwidGltZXN0YW1wLW9mZnNldFwiXS5pbmRleE9mKGdldEZpZWxkVHlwZShhZGRGTCwgZmllbGROYW1lKSkgPiAtMTtcbiAgICAgICAgICAgIHN0YXRpc3RpY3NGaWVsZHMucHVzaCh7IGZpZWxkTmFtZSwgdHlwZXM6IFtpc0RhdGUgPyBcIk1JTlwiIDogXCJTVU1cIl0gfSk7XG4gICAgICAgICAgfSk7XG4gICAgICAgICAgZm9yY2VVcGRhdGUodGhpcy5ob3N0RWxlbWVudCk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH07XG4gICAgdGhpcy5wcm9wcyA9IHVuZGVmaW5lZDtcbiAgICB0aGlzLnN0YXR1cyA9IHVuZGVmaW5lZDtcbiAgICB0aGlzLnNob3dUYWJsZU9wdGlvbiA9IGZhbHNlO1xuICB9XG4gIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgLy9cbiAgLy8gIExpZmVjeWNsZVxuICAvL1xuICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIGFzeW5jIGNvbXBvbmVudFdpbGxMb2FkKCkge1xuICAgIHZhciBfYTtcbiAgICBjb25zdCB7IHByb3BzIH0gPSB0aGlzO1xuICAgIGNvbnN0IHsgdGFyZ2V0TGF5ZXIsIHRhcmdldExheWVySWQsIGFkZExheWVyLCBhZGRMYXllcklkLCBhdHRyaWJ1dGVSZWxhdGlvbnNoaXBzLCBqb2luT3BlcmF0aW9uIH0gPSBwcm9wcztcbiAgICB0aGlzLnRhcmdldEZMID0gKHRhcmdldExheWVyLnR5cGUgPT09IFwiZ3JvdXBcIlxuICAgICAgPyBnZXRMYXllcnNBbmRUYWJsZXModGFyZ2V0TGF5ZXIpLmZpbmQoKGx5cikgPT4gbHlyLmxheWVySWQgPT09IHRhcmdldExheWVySWQpXG4gICAgICA6IHRhcmdldExheWVyKTtcbiAgICB0aGlzLmFkZEZMID0gKGFkZExheWVyLnR5cGUgPT09IFwiZ3JvdXBcIlxuICAgICAgPyBnZXRMYXllcnNBbmRUYWJsZXMoYWRkTGF5ZXIpLmZpbmQoKGx5cikgPT4gbHlyLmxheWVySWQgPT09IGFkZExheWVySWQpXG4gICAgICA6IGFkZExheWVyKTtcbiAgICBpZiAoIShhdHRyaWJ1dGVSZWxhdGlvbnNoaXBzID09PSBudWxsIHx8IGF0dHJpYnV0ZVJlbGF0aW9uc2hpcHMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGF0dHJpYnV0ZVJlbGF0aW9uc2hpcHMubGVuZ3RoKSkge1xuICAgICAgcHJvcHMuYXR0cmlidXRlUmVsYXRpb25zaGlwcyA9IFtdO1xuICAgICAgLy8gbG9vayBmb3IgcmVsYXRpb25zaGlwIGZpZWxkc1xuICAgICAgY29uc3QgeyB0YXJnZXRGTCwgYWRkRkwgfSA9IHRoaXM7XG4gICAgICBpZiAodGFyZ2V0RkwucmVsYXRpb25zaGlwcyAmJiBhZGRGTC5yZWxhdGlvbnNoaXBzKSB7XG4gICAgICAgIGNvbnN0IHRhcmdldFJlbHMgPSB0YXJnZXRGTC5yZWxhdGlvbnNoaXBzLmZpbHRlcigocmVsKSA9PiByZWwucmVsYXRlZFRhYmxlSWQgPT09IGFkZExheWVySWQpO1xuICAgICAgICBjb25zdCBhZGRSZWxzID0gYWRkRkwucmVsYXRpb25zaGlwcy5maWx0ZXIoKHJlbCkgPT4gcmVsLnJlbGF0ZWRUYWJsZUlkID09PSB0YXJnZXRMYXllcklkKTtcbiAgICAgICAgaWYgKHRhcmdldFJlbHMubGVuZ3RoICYmIGFkZFJlbHMubGVuZ3RoKSB7XG4gICAgICAgICAgdGFyZ2V0UmVscy5mb3JFYWNoKCh0YXJnZXRSZWwpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGFkZFJlbCA9IGFkZFJlbHMuZmluZCgoYWRkUmVsKSA9PiB0YXJnZXRSZWwuaWQgPT09IGFkZFJlbC5pZCk7XG4gICAgICAgICAgICBpZiAoYWRkUmVsKSB7XG4gICAgICAgICAgICAgIHByb3BzLmF0dHJpYnV0ZVJlbGF0aW9uc2hpcHMucHVzaCh7XG4gICAgICAgICAgICAgICAgdGFyZ2V0RmllbGROYW1lOiB0YXJnZXRSZWwua2V5RmllbGQsXG4gICAgICAgICAgICAgICAgYWRkRmllbGROYW1lOiBhZGRSZWwua2V5RmllbGRcbiAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGlmICghKChfYSA9IHByb3BzLmF0dHJpYnV0ZVJlbGF0aW9uc2hpcHMpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5sZW5ndGgpKSB7XG4gICAgICAgIHByb3BzLmF0dHJpYnV0ZVJlbGF0aW9uc2hpcHMucHVzaCh7fSk7XG4gICAgICB9XG4gICAgfVxuICAgIGlmICgham9pbk9wZXJhdGlvbikge1xuICAgICAgcHJvcHMuam9pbk9wZXJhdGlvbiA9IHtcbiAgICAgICAgdHlwZTogXCJvbmUtdG8tb25lXCIsXG4gICAgICAgIG1hdGNoVHlwZTogXCJmaXJzdFwiLFxuICAgICAgICBzb3J0QnlGaWVsZE5hbWU6IHRoaXMuYWRkRkwub2JqZWN0SWRGaWVsZCxcbiAgICAgICAgc29ydE9yZGVyOiBcIkFTQ1wiLFxuICAgICAgICBqb2luVHlwZTogXCJJTk5FUlwiLFxuICAgICAgICBzdGF0aXN0aWNzRmllbGRzOiBbXVxuICAgICAgfTtcbiAgICB9XG4gIH1cbiAgYXN5bmMgY29tcG9uZW50RGlkTG9hZCgpIHtcbiAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKCkgPT4geyB2YXIgX2E7IHJldHVybiAoX2EgPSB0aGlzLmJhY2tCdXR0b25Ob2RlKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2Euc2V0Rm9jdXMoKTsgfSk7XG4gIH1cbiAgZGlzY29ubmVjdGVkQ2FsbGJhY2soKSB7XG4gICAgdGhpcy5yZW1vdmVJbmZvUG9wb3ZlcigpO1xuICB9XG4gIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIC8vXG4gIC8vICBSZW5kZXIgTWV0aG9kc1xuICAvL1xuICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIHJlbmRlcigpIHtcbiAgICBjb25zdCB7IHByb3BzIH0gPSB0aGlzO1xuICAgIGNvbnN0IHsgc3RyaW5ncyB9ID0gcHJvcHM7XG4gICAgY29uc3QgcnRsID0gZ2V0RWxlbWVudERpcih0aGlzLmhvc3RFbGVtZW50KSA9PT0gXCJydGxcIjtcbiAgICByZXR1cm4gKGgoSG9zdCwgeyBjbGFzczogXCJjYWxjaXRlLW1hdGNoLWhlaWdodFwiIH0sIGgoXCJjYWxjaXRlLWZsb3dcIiwgeyBjbGFzczogQ1NTJDUuZmxvdywgZGlyOiBnZXRFbGVtZW50RGlyKHRoaXMuaG9zdEVsZW1lbnQpIH0sIGgoXCJjYWxjaXRlLWZsb3ctaXRlbVwiLCB7IGhlYWRpbmc6IHN0cmluZ3Muam9pbi5jb25maWd1cmVKb2luLCBjbGFzczoge1xuICAgICAgICBwYW5lbDogdHJ1ZSxcbiAgICAgICAgW0NTU19VVElMSVRZLnJ0bF06IHJ0bFxuICAgICAgfSwgcmVmOiAobm9kZSkgPT4gKHRoaXMuZmxvd0l0ZW1Ob2RlID0gbm9kZSkgfSwgdGhpcy5yZW5kZXJGb290ZXJCdXR0b25zKCksIHRoaXMucmVuZGVyQ29udGVudCgpKSkpKTtcbiAgfVxuICByZW5kZXJGb290ZXJCdXR0b25zKCkge1xuICAgIHZhciBfYSwgX2I7XG4gICAgY29uc3QgeyBwcm9wcyB9ID0gdGhpcztcbiAgICBjb25zdCB7IGF0dHJpYnV0ZVJlbGF0aW9uc2hpcHMsIGpvaW5PcGVyYXRpb24sIHN0cmluZ3MgfSA9IHByb3BzO1xuICAgIGNvbnN0IGlzUnRsID0gZ2V0RWxlbWVudERpcih0aGlzLmhvc3RFbGVtZW50KSA9PT0gXCJydGxcIjtcbiAgICBjb25zdCBuZXh0RW5hYmxlZCA9ICEhYXR0cmlidXRlUmVsYXRpb25zaGlwcy5maW5kKChyZWwpID0+IHJlbC50YXJnZXRGaWVsZE5hbWUgJiYgcmVsLmFkZEZpZWxkTmFtZSkgJiZcbiAgICAgIChqb2luT3BlcmF0aW9uLnR5cGUgPT09IFwib25lLXRvLW1hbnlcIiB8fFxuICAgICAgICAoam9pbk9wZXJhdGlvbi5tYXRjaFR5cGUgPT09IFwiZmlyc3RcIiAmJlxuICAgICAgICAgIGpvaW5PcGVyYXRpb24uc29ydEJ5RmllbGROYW1lICYmXG4gICAgICAgICAgam9pbk9wZXJhdGlvbi5zb3J0T3JkZXIpIHx8XG4gICAgICAgIChqb2luT3BlcmF0aW9uLm1hdGNoVHlwZSA9PT0gXCJzdW1tYXJpemVcIiAmJlxuICAgICAgICAgICgoX2EgPSBqb2luT3BlcmF0aW9uLnN0YXRpc3RpY3NGaWVsZHMpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5sZW5ndGgpICYmXG4gICAgICAgICAgKChfYiA9IGpvaW5PcGVyYXRpb24uc3RhdGlzdGljc0ZpZWxkcykgPT09IG51bGwgfHwgX2IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9iWzBdLmZpZWxkTmFtZSkpKTtcbiAgICByZXR1cm4gKGgoXCJkaXZcIiwgeyBzbG90OiBcImZvb3RlclwiLCBjbGFzczogQ1NTJDUuZm9vdGVyIH0sIGgoXCJjYWxjaXRlLWJ1dHRvblwiLCB7IG9uQ2xpY2s6IHRoaXMuZ29CYWNrLCBhcHBlYXJhbmNlOiBcIm91dGxpbmUtZmlsbFwiLCB3aWR0aDogXCJoYWxmXCIsIFwiaWNvbi1zdGFydFwiOiBpc1J0bCA/IFwiYXJyb3ctcmlnaHRcIiA6IFwiYXJyb3ctbGVmdFwiLCByZWY6IChub2RlKSA9PiAodGhpcy5iYWNrQnV0dG9uTm9kZSA9IG5vZGUpIH0sIHN0cmluZ3MuZ2VuZXJhbC5iYWNrKSwgaChcImNhbGNpdGUtYnV0dG9uXCIsIHsgZGlzYWJsZWQ6ICFuZXh0RW5hYmxlZCwgb25DbGljazogbmV4dEVuYWJsZWQgJiYgdGhpcy5nb05leHQsIGFwcGVhcmFuY2U6IFwic29saWRcIiwgd2lkdGg6IFwiaGFsZlwiLCBpY29uRW5kOiBpc1J0bCA/IFwiYXJyb3ctbGVmdFwiIDogXCJhcnJvdy1yaWdodFwiLCByZWY6IChub2RlKSA9PiAodGhpcy5uZXh0QnV0dG9uTm9kZSA9IG5vZGUpIH0sIHN0cmluZ3MuZ2VuZXJhbC5uZXh0KSkpO1xuICB9XG4gIHJlbmRlckNvbnRlbnQoKSB7XG4gICAgcmV0dXJuIChoKEZyYWdtZW50LCBudWxsLCB0aGlzLnJlbmRlckxheWVycygpLCB0aGlzLnJlbmRlckF0dHJpYnV0ZVJlbGF0aW9uc2hpcHMoKSwgdGhpcy5yZW5kZXJKb2luT3BlcmF0aW9uKCkpKTtcbiAgfVxuICByZW5kZXJMYXllcnMoKSB7XG4gICAgY29uc3QgeyBwcm9wcywgdGFyZ2V0RkwsIGFkZEZMIH0gPSB0aGlzO1xuICAgIGNvbnN0IHsgdGFyZ2V0SXRlbSwgdGFyZ2V0TGF5ZXIsIHRhcmdldExheWVySWQsIGFkZEl0ZW0sIGFkZExheWVyLCBhZGRMYXllcklkLCBzaG93VGFibGVPcHRpb24sIHN0cmluZ3MgfSA9IHByb3BzO1xuICAgIGNvbnN0IHJ0bCA9IGdldEVsZW1lbnREaXIodGhpcy5ob3N0RWxlbWVudCkgPT09IFwicnRsXCI7XG4gICAgY29uc3QgdGFyZ2V0VGl0bGUgPSB0YXJnZXRMYXllci50eXBlID09PSBcImdyb3VwXCJcbiAgICAgID8gcnRsXG4gICAgICAgID8gYCR7dGFyZ2V0RkwudGl0bGV9IC8gJHt0YXJnZXRJdGVtLnRpdGxlfWBcbiAgICAgICAgOiBgJHt0YXJnZXRJdGVtLnRpdGxlfSAvICR7dGFyZ2V0RkwudGl0bGV9YFxuICAgICAgOiB0YXJnZXRMYXllci50aXRsZTtcbiAgICBjb25zdCBhZGRUaXRsZSA9IGFkZExheWVyLnR5cGUgPT09IFwiZ3JvdXBcIlxuICAgICAgPyBydGxcbiAgICAgICAgPyBgJHthZGRGTC50aXRsZX0gLyAke2FkZEl0ZW0udGl0bGV9YFxuICAgICAgICA6IGAke2FkZEl0ZW0udGl0bGV9IC8gJHthZGRGTC50aXRsZX1gXG4gICAgICA6IGFkZExheWVyLnRpdGxlO1xuICAgIHJldHVybiAoaChcImRpdlwiLCB7IGNsYXNzOiBDU1MkNS5sYXllclNlY3Rpb24gfSwgaChcImRpdlwiLCB7IGNsYXNzOiBDU1MkNS50YXJnZXRMYXllciB9LCBoKFwiZGl2XCIsIG51bGwsIGgoXCJkaXZcIiwgeyBjbGFzczogQ1NTJDUubGF5ZXJIZWFkZXIgfSwgc3RyaW5ncy5qb2luLnRhcmdldExheWVyKSwgaChcImRpdlwiLCB7IGNsYXNzOiBDU1MkNS5sYXllclRpdGxlIH0sIHRhcmdldFRpdGxlKSksIHNob3dUYWJsZU9wdGlvbiAmJiAoaChcImNhbGNpdGUtYWN0aW9uXCIsIHsgc2NhbGU6IFwic1wiLCBpY29uOiBcInRhYmxlXCIsIGNsYXNzOiBDU1MkNS5sYXllckljb24sIHRleHQ6IHN0cmluZ3Muam9pbi5zaG93VGFibGUsIHRleHRFbmFibGVkOiBmYWxzZSwgb25DbGljazogKCkgPT4ge1xuICAgICAgICB2YXIgX2EsIF9iO1xuICAgICAgICBpZiAodGFyZ2V0TGF5ZXIudHlwZSA9PT0gXCJncm91cFwiKSB7XG4gICAgICAgICAgKF9hID0gdGFyZ2V0TGF5ZXIudGFibGVzKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EuZm9yRWFjaCgobHlyKSA9PiB7XG4gICAgICAgICAgICBpZiAobHlyLmxheWVySWQgPT09IHRhcmdldExheWVySWQpIHtcbiAgICAgICAgICAgICAgdGhpcy5hcmNnaXNMYXllclZpZXdKb2luQ29uZmlnVGFibGVDbGljay5lbWl0KGx5cik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSk7XG4gICAgICAgICAgKF9iID0gdGFyZ2V0TGF5ZXIubGF5ZXJzKSA9PT0gbnVsbCB8fCBfYiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2IuZm9yRWFjaCgobHlyKSA9PiB7XG4gICAgICAgICAgICBpZiAobHlyLmxheWVySWQgPT09IHRhcmdldExheWVySWQpIHtcbiAgICAgICAgICAgICAgdGhpcy5hcmNnaXNMYXllclZpZXdKb2luQ29uZmlnVGFibGVDbGljay5lbWl0KGx5cik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgdGhpcy5hcmNnaXNMYXllclZpZXdKb2luQ29uZmlnVGFibGVDbGljay5lbWl0KHRhcmdldExheWVyKTtcbiAgICAgICAgfVxuICAgICAgfSB9KSkpLCBoKFwiZGl2XCIsIHsgY2xhc3M6IENTUyQ1LmFkZExheWVyIH0sIGgoXCJkaXZcIiwgbnVsbCwgaChcImRpdlwiLCB7IGNsYXNzOiBDU1MkNS5sYXllckhlYWRlciB9LCBzdHJpbmdzLmpvaW4uam9pbkxheWVyKSwgaChcImRpdlwiLCB7IGNsYXNzOiBDU1MkNS5sYXllclRpdGxlIH0sIGFkZFRpdGxlKSksIHNob3dUYWJsZU9wdGlvbiAmJiAoaChcImNhbGNpdGUtYWN0aW9uXCIsIHsgc2NhbGU6IFwic1wiLCBpY29uOiBcInRhYmxlXCIsIGNsYXNzOiBDU1MkNS5sYXllckljb24sIHRleHQ6IHN0cmluZ3Muam9pbi5zaG93VGFibGUsIHRleHRFbmFibGVkOiBmYWxzZSwgb25DbGljazogKCkgPT4ge1xuICAgICAgICB2YXIgX2EsIF9iO1xuICAgICAgICBpZiAoYWRkTGF5ZXIudHlwZSA9PT0gXCJncm91cFwiKSB7XG4gICAgICAgICAgKF9hID0gYWRkTGF5ZXIudGFibGVzKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EuZm9yRWFjaCgobHlyKSA9PiB7XG4gICAgICAgICAgICBpZiAobHlyLmxheWVySWQgPT09IGFkZExheWVySWQpIHtcbiAgICAgICAgICAgICAgdGhpcy5hcmNnaXNMYXllclZpZXdKb2luQ29uZmlnVGFibGVDbGljay5lbWl0KGx5cik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSk7XG4gICAgICAgICAgKF9iID0gYWRkTGF5ZXIubGF5ZXJzKSA9PT0gbnVsbCB8fCBfYiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2IuZm9yRWFjaCgobHlyKSA9PiB7XG4gICAgICAgICAgICBpZiAobHlyLmxheWVySWQgPT09IGFkZExheWVySWQpIHtcbiAgICAgICAgICAgICAgdGhpcy5hcmNnaXNMYXllclZpZXdKb2luQ29uZmlnVGFibGVDbGljay5lbWl0KGx5cik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgdGhpcy5hcmNnaXNMYXllclZpZXdKb2luQ29uZmlnVGFibGVDbGljay5lbWl0KGFkZExheWVyKTtcbiAgICAgICAgfVxuICAgICAgfSB9KSkpKSk7XG4gIH1cbiAgcmVuZGVyQXR0cmlidXRlUmVsYXRpb25zaGlwcygpIHtcbiAgICBjb25zdCB7IHByb3BzIH0gPSB0aGlzO1xuICAgIGNvbnN0IHsgYXR0cmlidXRlUmVsYXRpb25zaGlwcywgc3RyaW5ncyB9ID0gcHJvcHM7XG4gICAgcmV0dXJuIChoKFwiY2FsY2l0ZS1ibG9ja1wiLCB7IGhlYWRpbmc6IHN0cmluZ3Muam9pbi5hdHRyaWJ1dGVKb2luLCBkZXNjcmlwdGlvbjogc3RyaW5ncy5qb2luLmF0dHJpYnV0ZUpvaW5Nc2csIG9wZW46IHRydWUsIGNvbGxhcHNpYmxlOiB0cnVlLCByZWY6IChub2RlKSA9PiAodGhpcy5hdHRyQmxvY2tOb2RlID0gbm9kZSkgfSwgYXR0cmlidXRlUmVsYXRpb25zaGlwcy5tYXAoKHJlbCwgaWR4KSA9PiB0aGlzLnJlbmRlckF0dHJpYnV0ZVJlbGF0aW9uc2hpcChyZWwsIGlkeCkpLCBoKFwiY2FsY2l0ZS1idXR0b25cIiwgeyBvbkNsaWNrOiAoKSA9PiB7XG4gICAgICAgIGF0dHJpYnV0ZVJlbGF0aW9uc2hpcHMucHVzaCh7fSk7XG4gICAgICAgIGZvcmNlVXBkYXRlKHRoaXMuaG9zdEVsZW1lbnQpO1xuICAgICAgfSwgYXBwZWFyYW5jZTogXCJvdXRsaW5lLWZpbGxcIiwgd2lkdGg6IFwiZnVsbFwiLCByZWY6IChub2RlKSA9PiAodGhpcy5maWVsZEJ1dHRvbk5vZGUgPSBub2RlKSB9LCBzdHJpbmdzLmpvaW4uZmllbGRzKSkpO1xuICB9XG4gIHJlbmRlckF0dHJpYnV0ZVJlbGF0aW9uc2hpcChyZWwsIGlkeCkge1xuICAgIGNvbnN0IHsgdGFyZ2V0RkwsIGFkZEZMLCBwcm9wcyB9ID0gdGhpcztcbiAgICBjb25zdCB7IGF0dHJpYnV0ZVJlbGF0aW9uc2hpcHMsIHN0cmluZ3MgfSA9IHByb3BzO1xuICAgIHJldHVybiAoaChcImRpdlwiLCB7IGNsYXNzOiBDU1MkNS5hdHRyaWJ1dGVSZWxhdGlvbnNoaXAgfSwgYXR0cmlidXRlUmVsYXRpb25zaGlwcy5sZW5ndGggPiAxICYmIChoKFwiZGl2XCIsIHsgY2xhc3M6IENTUyQ1LnJlbW92ZUF0dHJpYnV0ZVJlbGF0aW9uc2hpcCB9LCBoKFwiY2FsY2l0ZS1hY3Rpb25cIiwgeyBzY2FsZTogXCJzXCIsIGljb246IFwidHJhc2hcIiwgdGV4dDogc3RyaW5ncy5nZW5lcmFsLnJlbW92ZSwgb25DbGljazogKCkgPT4ge1xuICAgICAgICBhdHRyaWJ1dGVSZWxhdGlvbnNoaXBzLnNwbGljZShpZHgsIDEpO1xuICAgICAgICBmb3JjZVVwZGF0ZSh0aGlzLmhvc3RFbGVtZW50KTtcbiAgICAgIH0gfSkpKSwgaChcImNhbGNpdGUtbGFiZWxcIiwgbnVsbCwgc3RyaW5ncy5qb2luLnRhcmdldEZpZWxkLCBoKFwiY2FsY2l0ZS1idXR0b25cIiwgeyBhcHBlYXJhbmNlOiBcIm91dGxpbmUtZmlsbFwiLCBraW5kOiBcIm5ldXRyYWxcIiwgd2lkdGg6IFwiZnVsbFwiLCBhbGlnbm1lbnQ6IFwiaWNvbi1lbmQtc3BhY2UtYmV0d2VlblwiLCBpY29uRW5kOiBcImNoZXZyb24tZG93blwiLCBvbkNsaWNrOiAoKSA9PiB0aGlzLm9uVGFyZ2V0RmllbGRTZWxlY3QocmVsKSwgcmVmOiAobm9kZSkgPT4gKHRoaXMudGFyZ2V0RmllbGROb2RlID0gbm9kZSkgfSwgcmVsLnRhcmdldEZpZWxkTmFtZVxuICAgICAgPyBnZXRGaWVsZEFsaWFzKHRhcmdldEZMLCByZWwudGFyZ2V0RmllbGROYW1lKVxuICAgICAgOiBzdHJpbmdzLmpvaW4uc2VsZWN0RmllbGQpKSwgaChcImNhbGNpdGUtbGFiZWxcIiwgbnVsbCwgc3RyaW5ncy5qb2luLmpvaW5GaWVsZCwgaChcImNhbGNpdGUtYnV0dG9uXCIsIHsgYXBwZWFyYW5jZTogXCJvdXRsaW5lLWZpbGxcIiwga2luZDogXCJuZXV0cmFsXCIsIHdpZHRoOiBcImZ1bGxcIiwgYWxpZ25tZW50OiBcImljb24tZW5kLXNwYWNlLWJldHdlZW5cIiwgaWNvbkVuZDogXCJjaGV2cm9uLWRvd25cIiwgb25DbGljazogKCkgPT4gdGhpcy5vbkpvaW5GaWVsZFNlbGVjdChyZWwpLCByZWY6IChub2RlKSA9PiAodGhpcy5hZGRGaWVsZE5vZGUgPSBub2RlKSB9LCByZWwuYWRkRmllbGROYW1lID8gZ2V0RmllbGRBbGlhcyhhZGRGTCwgcmVsLmFkZEZpZWxkTmFtZSkgOiBzdHJpbmdzLmpvaW4uc2VsZWN0RmllbGQpKSkpO1xuICB9XG4gIHJlbmRlckpvaW5PcGVyYXRpb24oKSB7XG4gICAgY29uc3QgeyBwcm9wcyB9ID0gdGhpcztcbiAgICBjb25zdCB7IGpvaW5PcGVyYXRpb24sIHN0cmluZ3MgfSA9IHByb3BzO1xuICAgIHJldHVybiAoaChcImNhbGNpdGUtYmxvY2tcIiwgeyBoZWFkaW5nOiBzdHJpbmdzLmpvaW4uam9pblNldHRpbmdzLCBkZXNjcmlwdGlvbjogc3RyaW5ncy5qb2luLmpvaW5TZXR0aW5nc01zZywgb3BlbjogdHJ1ZSwgY29sbGFwc2libGU6IHRydWUsIHJlZjogKG5vZGUpID0+ICh0aGlzLm9wZXJhdGlvbkJsb2NrTm9kZSA9IG5vZGUpIH0sIHRoaXMucmVuZGVySm9pbk9wZXJhdGlvblR5cGUoKSwgam9pbk9wZXJhdGlvbi50eXBlID09PSBcIm9uZS10by1vbmVcIiAmJiB0aGlzLnJlbmRlck1hdGNoVHlwZSgpLCBqb2luT3BlcmF0aW9uLnR5cGUgPT09IFwib25lLXRvLW9uZVwiICYmXG4gICAgICBqb2luT3BlcmF0aW9uLm1hdGNoVHlwZSA9PT0gXCJmaXJzdFwiICYmXG4gICAgICB0aGlzLnJlbmRlckpvaW5PcGVyYXRpb25Tb3J0QnkoKSwgam9pbk9wZXJhdGlvbi50eXBlID09PSBcIm9uZS10by1vbmVcIiAmJlxuICAgICAgam9pbk9wZXJhdGlvbi5tYXRjaFR5cGUgPT09IFwic3VtbWFyaXplXCIgJiZcbiAgICAgIHRoaXMucmVuZGVySm9pbk9wZXJhdGlvblN0YXRpc3RpY3MoKSwgaChcImRpdlwiLCB7IGNsYXNzOiBDU1MkNS5zZXBhcmF0b3IgfSksIHRoaXMucmVuZGVySm9pblR5cGUoKSkpO1xuICB9XG4gIHJlbmRlckpvaW5PcGVyYXRpb25UeXBlKCkge1xuICAgIGNvbnN0IHsgcHJvcHMgfSA9IHRoaXM7XG4gICAgY29uc3QgeyBqb2luT3BlcmF0aW9uLCBzdHJpbmdzIH0gPSBwcm9wcztcbiAgICByZXR1cm4gKGgoXCJjYWxjaXRlLWxhYmVsXCIsIG51bGwsIGgoXCJkaXZcIiwgeyBjbGFzczogXCJpbmZvXCIgfSwgaChcImRpdlwiLCB7IGNsYXNzOiBcImluZm8tbGFiZWxcIiB9LCBzdHJpbmdzLmpvaW4uam9pbk9wZXJhdGlvbiksIGgoXCJjYWxjaXRlLWFjdGlvblwiLCB7IGNsYXNzOiBcImxpbmstaW5mb1wiLCB0YWJpbmRleDogXCIwXCIsIHNjYWxlOiBcInNcIiwgaWNvbjogXCJpbmZvcm1hdGlvblwiLCBvbkNsaWNrOiAoZXZlbnQpID0+IHRoaXMuaGFuZGxlSW5mb0NsaWNrKGV2ZW50LCBcImpvaW4tb3BlcmF0aW9uXCIpLCB0ZXh0OiBzdHJpbmdzLmpvaW4ubW9yZUluZm8sIHJlZjogKGVsZW1lbnQpID0+IHtcbiAgICAgICAgdGhpcy5qb2luT3BlcmF0aW9uSW5mb0ljb25Ob2RlID0gZWxlbWVudDtcbiAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKFwia2V5dXBcIiwgKGV2ZW50KSA9PiB7XG4gICAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgICAgaWYgKGV2ZW50LmtleSA9PT0gXCIgXCIgfHwgKCF0aGlzLmluZm9Qb3BvdmVyTm9kZSAmJiBldmVudC5rZXkgPT09IFwiRW50ZXJcIikpIHtcbiAgICAgICAgICAgIHRoaXMuaGFuZGxlSW5mb0NsaWNrKGV2ZW50LCBcImpvaW4tb3BlcmF0aW9uXCIpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihcImtleWRvd25cIiwgKGV2ZW50KSA9PiB7XG4gICAgICAgICAgaWYgKGV2ZW50LmtleSA9PT0gXCIgXCIpIHtcbiAgICAgICAgICAgIC8vIHByZXZlbnQgcGFuZWwgZnJvbSBzY3JvbGxpbmdcbiAgICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgfSB9KSksIGgoXCJkaXZcIiwgbnVsbCwgaChcImNhbGNpdGUtY2hpcFwiLCB7IHZhbHVlOiBcIm9uZS10by1vbmVcIiwgYXBwZWFyYW5jZTogam9pbk9wZXJhdGlvbi50eXBlID09PSBcIm9uZS10by1vbmVcIiA/IFwic29saWRcIiA6IFwib3V0bGluZS1maWxsXCIsIGtpbmQ6IFwiYnJhbmRcIiwgY2xhc3M6IGAke0NTUyQ1LmNoaXB9ICR7am9pbk9wZXJhdGlvbi50eXBlID09PSBcIm9uZS10by1tYW55XCIgPyBDU1MkNS5zZWxlY3QgOiBcIlwifWAsIG9uQ2xpY2s6IGpvaW5PcGVyYXRpb24udHlwZSA9PT0gXCJvbmUtdG8tbWFueVwiXG4gICAgICAgID8gKCkgPT4ge1xuICAgICAgICAgIGpvaW5PcGVyYXRpb24udHlwZSA9IFwib25lLXRvLW9uZVwiO1xuICAgICAgICAgIGZvcmNlVXBkYXRlKHRoaXMuaG9zdEVsZW1lbnQpO1xuICAgICAgICB9XG4gICAgICAgIDogdW5kZWZpbmVkIH0sIHN0cmluZ3Muam9pbi5vbmVUb09uZSksIFwiXFx1MDBBMFwiLCBoKFwiY2FsY2l0ZS1jaGlwXCIsIHsgdmFsdWU6IFwib25lLXRvLW1hbnlcIiwgYXBwZWFyYW5jZTogam9pbk9wZXJhdGlvbi50eXBlID09PSBcIm9uZS10by1tYW55XCIgPyBcInNvbGlkXCIgOiBcIm91dGxpbmUtZmlsbFwiLCBraW5kOiBcImJyYW5kXCIsIGNsYXNzOiBgJHtDU1MkNS5jaGlwfSAke2pvaW5PcGVyYXRpb24udHlwZSA9PT0gXCJvbmUtdG8tb25lXCIgPyBDU1MkNS5zZWxlY3QgOiBcIlwifWAsIG9uQ2xpY2s6IGpvaW5PcGVyYXRpb24udHlwZSA9PT0gXCJvbmUtdG8tb25lXCJcbiAgICAgICAgPyAoKSA9PiB7XG4gICAgICAgICAgam9pbk9wZXJhdGlvbi50eXBlID0gXCJvbmUtdG8tbWFueVwiO1xuICAgICAgICAgIGZvcmNlVXBkYXRlKHRoaXMuaG9zdEVsZW1lbnQpO1xuICAgICAgICB9XG4gICAgICAgIDogdW5kZWZpbmVkIH0sIHN0cmluZ3Muam9pbi5vbmVUb01hbnkpKSkpO1xuICB9XG4gIHJlbmRlck1hdGNoVHlwZSgpIHtcbiAgICBjb25zdCB7IHByb3BzIH0gPSB0aGlzO1xuICAgIGNvbnN0IHsgam9pbk9wZXJhdGlvbiwgc3RyaW5ncyB9ID0gcHJvcHM7XG4gICAgcmV0dXJuIChoKFwiY2FsY2l0ZS1yYWRpby1idXR0b24tZ3JvdXBcIiwgeyBuYW1lOiBcIm1hdGNoVHlwZVwiLCBsYXlvdXQ6IFwidmVydGljYWxcIiwgY2xhc3M6IENTUyQ1LmpvaW5NYXRjaFR5cGVTZWN0aW9uIH0sIGgoXCJjYWxjaXRlLWxhYmVsXCIsIHsgbGF5b3V0OiBcImlubGluZVwiLCBjbGFzczogQ1NTJDUuc2VsZWN0LCBvbkNsaWNrOiAoKSA9PiB7XG4gICAgICAgIGpvaW5PcGVyYXRpb24ubWF0Y2hUeXBlID0gXCJmaXJzdFwiO1xuICAgICAgICBmb3JjZVVwZGF0ZSh0aGlzLmhvc3RFbGVtZW50KTtcbiAgICAgIH0gfSwgaChcImNhbGNpdGUtcmFkaW8tYnV0dG9uXCIsIHsgY2hlY2tlZDogam9pbk9wZXJhdGlvbi5tYXRjaFR5cGUgPT09IFwiZmlyc3RcIiwgdmFsdWU6IFwiZmlyc3RcIiwgb25DbGljazogKCkgPT4ge1xuICAgICAgICBqb2luT3BlcmF0aW9uLm1hdGNoVHlwZSA9IFwiZmlyc3RcIjtcbiAgICAgICAgZm9yY2VVcGRhdGUodGhpcy5ob3N0RWxlbWVudCk7XG4gICAgICB9IH0pLCBzdHJpbmdzLmpvaW4ub25seUZpcnN0KSwgaChcImNhbGNpdGUtbGFiZWxcIiwgeyBsYXlvdXQ6IFwiaW5saW5lXCIsIGNsYXNzOiBDU1MkNS5zZWxlY3QsIG9uQ2xpY2s6ICgpID0+IHtcbiAgICAgICAgam9pbk9wZXJhdGlvbi5tYXRjaFR5cGUgPSBcInN1bW1hcml6ZVwiO1xuICAgICAgICBmb3JjZVVwZGF0ZSh0aGlzLmhvc3RFbGVtZW50KTtcbiAgICAgIH0gfSwgaChcImNhbGNpdGUtcmFkaW8tYnV0dG9uXCIsIHsgY2hlY2tlZDogam9pbk9wZXJhdGlvbi5tYXRjaFR5cGUgPT09IFwic3VtbWFyaXplXCIsIHZhbHVlOiBcInN1bW1hcml6ZVwiLCBvbkNsaWNrOiAoKSA9PiB7XG4gICAgICAgIGpvaW5PcGVyYXRpb24ubWF0Y2hUeXBlID0gXCJzdW1tYXJpemVcIjtcbiAgICAgICAgZm9yY2VVcGRhdGUodGhpcy5ob3N0RWxlbWVudCk7XG4gICAgICB9IH0pLCBzdHJpbmdzLmpvaW4uc3VtbWFyaXplTWF0Y2hpbmcpKSk7XG4gIH1cbiAgcmVuZGVySm9pbk9wZXJhdGlvblNvcnRCeSgpIHtcbiAgICBjb25zdCB7IGFkZEZMLCBwcm9wcyB9ID0gdGhpcztcbiAgICBjb25zdCB7IGpvaW5PcGVyYXRpb24sIHN0cmluZ3MgfSA9IHByb3BzO1xuICAgIHJldHVybiAoaChcImRpdlwiLCB7IGNsYXNzOiBDU1MkNS5zb3J0QnlTZWN0aW9uIH0sIGgoXCJjYWxjaXRlLWxhYmVsXCIsIG51bGwsIHN0cmluZ3Muam9pbi5zb3J0QnksIGgoXCJjYWxjaXRlLWJ1dHRvblwiLCB7IGFwcGVhcmFuY2U6IFwib3V0bGluZS1maWxsXCIsIGtpbmQ6IFwibmV1dHJhbFwiLCB3aWR0aDogXCJmdWxsXCIsIGFsaWdubWVudDogXCJpY29uLWVuZC1zcGFjZS1iZXR3ZWVuXCIsIGljb25FbmQ6IFwiY2hldnJvbi1kb3duXCIsIG9uQ2xpY2s6ICgpID0+IHRoaXMub25Tb3J0QnlGaWVsZFNlbGVjdCgpLCByZWY6IChub2RlKSA9PiAodGhpcy5zb3J0QnlGaWVsZE5vZGUgPSBub2RlKSB9LCBnZXRGaWVsZEFsaWFzKGFkZEZMLCBqb2luT3BlcmF0aW9uLnNvcnRCeUZpZWxkTmFtZSkpKSwgaChcImNhbGNpdGUtbGFiZWxcIiwgbnVsbCwgc3RyaW5ncy5qb2luLnNvcnRPcmRlciwgaChcImNhbGNpdGUtc2VsZWN0XCIsIHsgd2lkdGg6IFwiZnVsbFwiLCBvbkNhbGNpdGVTZWxlY3RDaGFuZ2U6IChldmVudCkgPT4ge1xuICAgICAgICBjb25zdCBzZWxlY3ROb2RlID0gZXZlbnQudGFyZ2V0O1xuICAgICAgICBqb2luT3BlcmF0aW9uLnNvcnRPcmRlciA9IHNlbGVjdE5vZGUudmFsdWU7XG4gICAgICAgIGZvcmNlVXBkYXRlKHRoaXMuaG9zdEVsZW1lbnQpO1xuICAgICAgfSwgbGFiZWw6IHN0cmluZ3Muam9pbi5zb3J0T3JkZXIgfSwgaChcImNhbGNpdGUtb3B0aW9uXCIsIHsgbGFiZWw6IHN0cmluZ3Muam9pbi5hc2MsIHNlbGVjdGVkOiBqb2luT3BlcmF0aW9uLnNvcnRPcmRlciA9PT0gXCJBU0NcIiwgdmFsdWU6IFwiQVNDXCIgfSwgc3RyaW5ncy5qb2luLmFzYyksIGgoXCJjYWxjaXRlLW9wdGlvblwiLCB7IGxhYmVsOiBzdHJpbmdzLmpvaW4uZGVzYywgc2VsZWN0ZWQ6IGpvaW5PcGVyYXRpb24uc29ydE9yZGVyID09PSBcIkRFU0NcIiwgdmFsdWU6IFwiREVTQ1wiIH0sIHN0cmluZ3Muam9pbi5kZXNjKSkpKSk7XG4gIH1cbiAgcmVuZGVySm9pbk9wZXJhdGlvblN0YXRpc3RpY3MoKSB7XG4gICAgdmFyIF9hO1xuICAgIGNvbnN0IHsgcHJvcHMsIGFkZEZMIH0gPSB0aGlzO1xuICAgIGNvbnN0IHsgam9pbk9wZXJhdGlvbiwgc3RyaW5ncyB9ID0gcHJvcHM7XG4gICAgY29uc3QgeyBzdGF0aXN0aWNzRmllbGRzIH0gPSBqb2luT3BlcmF0aW9uO1xuICAgIGNvbnN0IGV4Y2x1ZGVkRmllbGRzID0gc3RhdGlzdGljc0ZpZWxkcy5tYXAoKGZpZWxkKSA9PiBmaWVsZC5maWVsZE5hbWUpO1xuICAgIGNvbnN0IGZpZWxkVHlwZXMgPSBbXG4gICAgICBcInNtYWxsLWludGVnZXJcIixcbiAgICAgIFwiYmlnLWludGVnZXJcIixcbiAgICAgIFwiaW50ZWdlclwiLFxuICAgICAgXCJzaW5nbGVcIixcbiAgICAgIFwiZG91YmxlXCIsXG4gICAgICBcImxvbmdcIixcbiAgICAgIFwibnVtYmVyXCIsXG4gICAgICBcImRhdGVcIixcbiAgICAgIFwiZGF0ZS1vbmx5XCIsXG4gICAgICBcInRpbWUtb25seVwiLFxuICAgICAgXCJ0aW1lc3RhbXAtb2Zmc2V0XCJcbiAgICBdO1xuICAgIGNvbnN0IGxheWVyRmllbGRzID0gYWRkRkwuZmllbGRzXG4gICAgICAuZmlsdGVyKChmaWVsZCkgPT4gZXhjbHVkZWRGaWVsZHMuaW5kZXhPZihmaWVsZC5uYW1lKSA9PT0gLTEpXG4gICAgICAuZmlsdGVyKChmaWVsZCkgPT4gZmllbGRUeXBlcy5pbmRleE9mKGZpZWxkLnR5cGUpID4gLTEpO1xuICAgIGNvbnN0IG5vTW9yZUZpZWxkcyA9ICFsYXllckZpZWxkcy5sZW5ndGg7XG4gICAgcmV0dXJuIChoKEZyYWdtZW50LCBudWxsLCBoKFwiY2FsY2l0ZS1sYWJlbFwiLCB7IHNjYWxlOiBcImxcIiB9LCBzdHJpbmdzLmpvaW4uZmllbGRTdGF0cyksIChfYSA9IGpvaW5PcGVyYXRpb24uc3RhdGlzdGljc0ZpZWxkcykgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6XG4gICAgICBfYS5tYXAoKHN0YXRzRmllbGQsIGlkeCkgPT4gdGhpcy5yZW5kZXJKb2luT3BlcmF0aW9uU3RhdGlzdGljKHN0YXRzRmllbGQsIGlkeCkpLCBoKFwiY2FsY2l0ZS1idXR0b25cIiwgeyBvbkNsaWNrOiAhbm9Nb3JlRmllbGRzICYmIHRoaXMub25TdGF0c0ZpZWxkU2VsZWN0LCBhcHBlYXJhbmNlOiBcIm91dGxpbmUtZmlsbFwiLCBcImljb24tc3RhcnRcIjogXCJwbHVzXCIsIHdpZHRoOiBcImZ1bGxcIiwgZGlzYWJsZWQ6IG5vTW9yZUZpZWxkcywgY2xhc3M6IENTUyQ1LnN0YXRzQnV0dG9uLCByZWY6IChub2RlKSA9PiAodGhpcy5zdGF0c0J1dHRvbk5vZGUgPSBub2RlKSB9LCBzdHJpbmdzLmpvaW4uYWRkU3RhdHMpKSk7XG4gIH1cbiAgcmVuZGVySm9pbk9wZXJhdGlvblN0YXRpc3RpYyhzdGF0c0ZpZWxkLCBpZHgpIHtcbiAgICBjb25zdCB7IHByb3BzLCBhZGRGTCB9ID0gdGhpcztcbiAgICBjb25zdCB7IGpvaW5PcGVyYXRpb24sIHN0cmluZ3MgfSA9IHByb3BzO1xuICAgIGNvbnN0IGlzRGF0ZSA9IFtcImRhdGVcIiwgXCJkYXRlLW9ubHlcIiwgXCJ0aW1lLW9ubHlcIiwgXCJ0aW1lc3RhbXAtb2Zmc2V0XCJdLmluZGV4T2YoZ2V0RmllbGRUeXBlKGFkZEZMLCBzdGF0c0ZpZWxkLmZpZWxkTmFtZSkpID4gLTE7XG4gICAgY29uc3QgaGFzQWxsVHlwZXMgPSBpc0RhdGVcbiAgICAgID8gc3RhdHNGaWVsZC50eXBlcy5pbmRleE9mKFwiTUlOXCIpID4gLTEgJiYgc3RhdHNGaWVsZC50eXBlcy5pbmRleE9mKFwiTUFYXCIpID4gLTFcbiAgICAgIDogc3RhdHNGaWVsZC50eXBlcy5pbmRleE9mKFwiU1VNXCIpID4gLTEgJiZcbiAgICAgICAgc3RhdHNGaWVsZC50eXBlcy5pbmRleE9mKFwiTUlOXCIpID4gLTEgJiZcbiAgICAgICAgc3RhdHNGaWVsZC50eXBlcy5pbmRleE9mKFwiTUFYXCIpID4gLTEgJiZcbiAgICAgICAgc3RhdHNGaWVsZC50eXBlcy5pbmRleE9mKFwiTUVBTlwiKSA+IC0xICYmXG4gICAgICAgIHN0YXRzRmllbGQudHlwZXMuaW5kZXhPZihcIlNURERFVlwiKSA+IC0xO1xuICAgIHJldHVybiAoaChcImRpdlwiLCB7IGNsYXNzOiBDU1MkNS5zdGF0c1NlY3Rpb24gfSwgaChcImNhbGNpdGUtbGFiZWxcIiwgeyBjbGFzczogQ1NTJDUuc3RhdHNGaWVsZEhlYWRlciwgbGF5b3V0OiBcImlubGluZS1zcGFjZS1iZXR3ZWVuXCIgfSwgZ2V0RmllbGRBbGlhcyhhZGRGTCwgc3RhdHNGaWVsZC5maWVsZE5hbWUpLCBoKFwiY2FsY2l0ZS1hY3Rpb25cIiwgeyBzY2FsZTogXCJzXCIsIGljb246IFwidHJhc2hcIiwgdGV4dDogc3RyaW5ncy5nZW5lcmFsLnJlbW92ZSwgb25DbGljazogKCkgPT4ge1xuICAgICAgICBqb2luT3BlcmF0aW9uLnN0YXRpc3RpY3NGaWVsZHMuc3BsaWNlKGlkeCwgMSk7XG4gICAgICAgIGZvcmNlVXBkYXRlKHRoaXMuaG9zdEVsZW1lbnQpO1xuICAgICAgfSB9KSksIGgoXCJkaXZcIiwgbnVsbCwgIWlzRGF0ZSAmJiAoaChGcmFnbWVudCwgbnVsbCwgaChcImNhbGNpdGUtY2hpcFwiLCB7IHZhbHVlOiBcIlNVTVwiLCBhcHBlYXJhbmNlOiBzdGF0c0ZpZWxkLnR5cGVzLmluZGV4T2YoXCJTVU1cIikgPiAtMSA/IFwic29saWRcIiA6IFwib3V0bGluZS1maWxsXCIsIGtpbmQ6IFwiYnJhbmRcIiwgY2xhc3M6IGAke0NTUyQ1LmNoaXB9ICR7c3RhdHNGaWVsZC50eXBlcy5sZW5ndGggPiAxIHx8IHN0YXRzRmllbGQudHlwZXMuaW5kZXhPZihcIlNVTVwiKSA9PT0gLTFcbiAgICAgICAgPyBDU1MkNS5zZWxlY3RcbiAgICAgICAgOiBcIlwifWAsIG9uQ2xpY2s6ICgpID0+IHtcbiAgICAgICAgc3RhdHNGaWVsZC50eXBlcy5pbmRleE9mKFwiU1VNXCIpID09PSAtMVxuICAgICAgICAgID8gc3RhdHNGaWVsZC50eXBlcy5wdXNoKFwiU1VNXCIpXG4gICAgICAgICAgOiBzdGF0c0ZpZWxkLnR5cGVzLmxlbmd0aCA+IDFcbiAgICAgICAgICAgID8gc3RhdHNGaWVsZC50eXBlcy5zcGxpY2Uoc3RhdHNGaWVsZC50eXBlcy5pbmRleE9mKFwiU1VNXCIpLCAxKVxuICAgICAgICAgICAgOiB1bmRlZmluZWQ7XG4gICAgICAgIGZvcmNlVXBkYXRlKHRoaXMuaG9zdEVsZW1lbnQpO1xuICAgICAgfSB9LCBzdHJpbmdzLmpvaW4uc3VtKSwgXCJcXHUwMEEwXCIpKSwgaChcImNhbGNpdGUtY2hpcFwiLCB7IHZhbHVlOiBcIk1JTlwiLCBhcHBlYXJhbmNlOiBzdGF0c0ZpZWxkLnR5cGVzLmluZGV4T2YoXCJNSU5cIikgPiAtMSA/IFwic29saWRcIiA6IFwib3V0bGluZS1maWxsXCIsIGtpbmQ6IFwiYnJhbmRcIiwgY2xhc3M6IGAke0NTUyQ1LmNoaXB9ICR7c3RhdHNGaWVsZC50eXBlcy5sZW5ndGggPiAxIHx8IHN0YXRzRmllbGQudHlwZXMuaW5kZXhPZihcIk1JTlwiKSA9PT0gLTFcbiAgICAgICAgPyBDU1MkNS5zZWxlY3RcbiAgICAgICAgOiBcIlwifWAsIG9uQ2xpY2s6ICgpID0+IHtcbiAgICAgICAgc3RhdHNGaWVsZC50eXBlcy5pbmRleE9mKFwiTUlOXCIpID09PSAtMVxuICAgICAgICAgID8gc3RhdHNGaWVsZC50eXBlcy5wdXNoKFwiTUlOXCIpXG4gICAgICAgICAgOiBzdGF0c0ZpZWxkLnR5cGVzLmxlbmd0aCA+IDFcbiAgICAgICAgICAgID8gc3RhdHNGaWVsZC50eXBlcy5zcGxpY2Uoc3RhdHNGaWVsZC50eXBlcy5pbmRleE9mKFwiTUlOXCIpLCAxKVxuICAgICAgICAgICAgOiB1bmRlZmluZWQ7XG4gICAgICAgIGZvcmNlVXBkYXRlKHRoaXMuaG9zdEVsZW1lbnQpO1xuICAgICAgfSB9LCBzdHJpbmdzLmpvaW4ubWluKSwgXCJcXHUwMEEwXCIsIGgoXCJjYWxjaXRlLWNoaXBcIiwgeyB2YWx1ZTogXCJNQVhcIiwgYXBwZWFyYW5jZTogc3RhdHNGaWVsZC50eXBlcy5pbmRleE9mKFwiTUFYXCIpID4gLTEgPyBcInNvbGlkXCIgOiBcIm91dGxpbmUtZmlsbFwiLCBraW5kOiBcImJyYW5kXCIsIGNsYXNzOiBgJHtDU1MkNS5jaGlwfSAke3N0YXRzRmllbGQudHlwZXMubGVuZ3RoID4gMSB8fCBzdGF0c0ZpZWxkLnR5cGVzLmluZGV4T2YoXCJNQVhcIikgPT09IC0xXG4gICAgICAgID8gQ1NTJDUuc2VsZWN0XG4gICAgICAgIDogXCJcIn1gLCBvbkNsaWNrOiAoKSA9PiB7XG4gICAgICAgIHN0YXRzRmllbGQudHlwZXMuaW5kZXhPZihcIk1BWFwiKSA9PT0gLTFcbiAgICAgICAgICA/IHN0YXRzRmllbGQudHlwZXMucHVzaChcIk1BWFwiKVxuICAgICAgICAgIDogc3RhdHNGaWVsZC50eXBlcy5sZW5ndGggPiAxXG4gICAgICAgICAgICA/IHN0YXRzRmllbGQudHlwZXMuc3BsaWNlKHN0YXRzRmllbGQudHlwZXMuaW5kZXhPZihcIk1BWFwiKSwgMSlcbiAgICAgICAgICAgIDogdW5kZWZpbmVkO1xuICAgICAgICBmb3JjZVVwZGF0ZSh0aGlzLmhvc3RFbGVtZW50KTtcbiAgICAgIH0gfSwgc3RyaW5ncy5qb2luLm1heCksICFpc0RhdGUgJiYgKGgoRnJhZ21lbnQsIG51bGwsIFwiXFx1MDBBMFwiLCBoKFwiY2FsY2l0ZS1jaGlwXCIsIHsgdmFsdWU6IFwiTUVBTlwiLCBhcHBlYXJhbmNlOiBzdGF0c0ZpZWxkLnR5cGVzLmluZGV4T2YoXCJNRUFOXCIpID4gLTEgPyBcInNvbGlkXCIgOiBcIm91dGxpbmUtZmlsbFwiLCBraW5kOiBcImJyYW5kXCIsIGNsYXNzOiBgJHtDU1MkNS5jaGlwfSAke3N0YXRzRmllbGQudHlwZXMubGVuZ3RoID4gMSB8fCBzdGF0c0ZpZWxkLnR5cGVzLmluZGV4T2YoXCJNRUFOXCIpID09PSAtMVxuICAgICAgICA/IENTUyQ1LnNlbGVjdFxuICAgICAgICA6IFwiXCJ9YCwgb25DbGljazogKCkgPT4ge1xuICAgICAgICBzdGF0c0ZpZWxkLnR5cGVzLmluZGV4T2YoXCJNRUFOXCIpID09PSAtMVxuICAgICAgICAgID8gc3RhdHNGaWVsZC50eXBlcy5wdXNoKFwiTUVBTlwiKVxuICAgICAgICAgIDogc3RhdHNGaWVsZC50eXBlcy5sZW5ndGggPiAxXG4gICAgICAgICAgICA/IHN0YXRzRmllbGQudHlwZXMuc3BsaWNlKHN0YXRzRmllbGQudHlwZXMuaW5kZXhPZihcIk1FQU5cIiksIDEpXG4gICAgICAgICAgICA6IHVuZGVmaW5lZDtcbiAgICAgICAgZm9yY2VVcGRhdGUodGhpcy5ob3N0RWxlbWVudCk7XG4gICAgICB9IH0sIHN0cmluZ3Muam9pbi5tZWFuKSwgXCJcXHUwMEEwXCIsIGgoXCJjYWxjaXRlLWNoaXBcIiwgeyB2YWx1ZTogXCJTVERERVZcIiwgYXBwZWFyYW5jZTogc3RhdHNGaWVsZC50eXBlcy5pbmRleE9mKFwiU1REREVWXCIpID4gLTEgPyBcInNvbGlkXCIgOiBcIm91dGxpbmUtZmlsbFwiLCBraW5kOiBcImJyYW5kXCIsIGNsYXNzOiBgJHtDU1MkNS5jaGlwfSAke3N0YXRzRmllbGQudHlwZXMubGVuZ3RoID4gMSB8fCBzdGF0c0ZpZWxkLnR5cGVzLmluZGV4T2YoXCJTVERERVZcIikgPT09IC0xXG4gICAgICAgID8gQ1NTJDUuc2VsZWN0XG4gICAgICAgIDogXCJcIn1gLCBvbkNsaWNrOiAoKSA9PiB7XG4gICAgICAgIHN0YXRzRmllbGQudHlwZXMuaW5kZXhPZihcIlNURERFVlwiKSA9PT0gLTFcbiAgICAgICAgICA/IHN0YXRzRmllbGQudHlwZXMucHVzaChcIlNURERFVlwiKVxuICAgICAgICAgIDogc3RhdHNGaWVsZC50eXBlcy5sZW5ndGggPiAxXG4gICAgICAgICAgICA/IHN0YXRzRmllbGQudHlwZXMuc3BsaWNlKHN0YXRzRmllbGQudHlwZXMuaW5kZXhPZihcIlNURERFVlwiKSwgMSlcbiAgICAgICAgICAgIDogdW5kZWZpbmVkO1xuICAgICAgICBmb3JjZVVwZGF0ZSh0aGlzLmhvc3RFbGVtZW50KTtcbiAgICAgIH0gfSwgc3RyaW5ncy5qb2luLnN0ZERldikpKSwgIWhhc0FsbFR5cGVzICYmIChoKEZyYWdtZW50LCBudWxsLCBcIlxcdTAwQTBcIiwgaChcImNhbGNpdGUtYnV0dG9uXCIsIHsgYXBwZWFyYW5jZTogXCJ0cmFuc3BhcmVudFwiLCBsYWJlbDogc3RyaW5ncy5qb2luLnNlbGVjdEFsbCwgb25DbGljazogKCkgPT4ge1xuICAgICAgICAhaXNEYXRlICYmIHN0YXRzRmllbGQudHlwZXMuaW5kZXhPZihcIlNVTVwiKSA9PT0gLTEgJiYgc3RhdHNGaWVsZC50eXBlcy5wdXNoKFwiU1VNXCIpO1xuICAgICAgICBzdGF0c0ZpZWxkLnR5cGVzLmluZGV4T2YoXCJNSU5cIikgPT09IC0xICYmIHN0YXRzRmllbGQudHlwZXMucHVzaChcIk1JTlwiKTtcbiAgICAgICAgc3RhdHNGaWVsZC50eXBlcy5pbmRleE9mKFwiTUFYXCIpID09PSAtMSAmJiBzdGF0c0ZpZWxkLnR5cGVzLnB1c2goXCJNQVhcIik7XG4gICAgICAgICFpc0RhdGUgJiZcbiAgICAgICAgICBzdGF0c0ZpZWxkLnR5cGVzLmluZGV4T2YoXCJNRUFOXCIpID09PSAtMSAmJlxuICAgICAgICAgIHN0YXRzRmllbGQudHlwZXMucHVzaChcIk1FQU5cIik7XG4gICAgICAgICFpc0RhdGUgJiZcbiAgICAgICAgICBzdGF0c0ZpZWxkLnR5cGVzLmluZGV4T2YoXCJTVERERVZcIikgPT09IC0xICYmXG4gICAgICAgICAgc3RhdHNGaWVsZC50eXBlcy5wdXNoKFwiU1REREVWXCIpO1xuICAgICAgICBmb3JjZVVwZGF0ZSh0aGlzLmhvc3RFbGVtZW50KTtcbiAgICAgIH0gfSwgc3RyaW5ncy5qb2luLnNlbGVjdEFsbCkpKSkpKTtcbiAgfVxuICByZW5kZXJKb2luVHlwZSgpIHtcbiAgICBjb25zdCB7IHByb3BzIH0gPSB0aGlzO1xuICAgIGNvbnN0IHsgam9pbk9wZXJhdGlvbiwgc3RyaW5ncyB9ID0gcHJvcHM7XG4gICAgcmV0dXJuIChoKFwiY2FsY2l0ZS1sYWJlbFwiLCBudWxsLCBoKFwiZGl2XCIsIHsgY2xhc3M6IFwiaW5mb1wiIH0sIGgoXCJkaXZcIiwgeyBjbGFzczogXCJpbmZvLWxhYmVsXCIgfSwgc3RyaW5ncy5qb2luLmpvaW5UeXBlKSwgaChcImNhbGNpdGUtYWN0aW9uXCIsIHsgY2xhc3M6IFwibGluay1pbmZvXCIsIHRhYmluZGV4OiBcIjBcIiwgc2NhbGU6IFwic1wiLCBpY29uOiBcImluZm9ybWF0aW9uXCIsIG9uQ2xpY2s6IChldmVudCkgPT4gdGhpcy5oYW5kbGVJbmZvQ2xpY2soZXZlbnQsIFwiam9pbi10eXBlXCIpLCB0ZXh0OiBzdHJpbmdzLmpvaW4ubW9yZUluZm8sIHJlZjogKGVsZW1lbnQpID0+IHtcbiAgICAgICAgdGhpcy5qb2luVHlwZUluZm9JY29uTm9kZSA9IGVsZW1lbnQ7XG4gICAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihcImtleXVwXCIsIChldmVudCkgPT4ge1xuICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICAgIGlmIChldmVudC5rZXkgPT09IFwiIFwiIHx8ICghdGhpcy5pbmZvUG9wb3Zlck5vZGUgJiYgZXZlbnQua2V5ID09PSBcIkVudGVyXCIpKSB7XG4gICAgICAgICAgICB0aGlzLmhhbmRsZUluZm9DbGljayhldmVudCwgXCJqb2luLXR5cGVcIik7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKFwia2V5ZG93blwiLCAoZXZlbnQpID0+IHtcbiAgICAgICAgICBpZiAoZXZlbnQua2V5ID09PSBcIiBcIikge1xuICAgICAgICAgICAgLy8gcHJldmVudCBwYW5lbCBmcm9tIHNjcm9sbGluZ1xuICAgICAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICB9IH0pKSwgaChcImRpdlwiLCBudWxsLCBoKFwiY2FsY2l0ZS1jaGlwXCIsIHsgdmFsdWU6IFwiaW5uZXItam9pblwiLCBhcHBlYXJhbmNlOiBqb2luT3BlcmF0aW9uLmpvaW5UeXBlID09PSBcIklOTkVSXCIgPyBcInNvbGlkXCIgOiBcIm91dGxpbmUtZmlsbFwiLCBraW5kOiBcImJyYW5kXCIsIGNsYXNzOiBgJHtDU1MkNS5jaGlwfSAke2pvaW5PcGVyYXRpb24uam9pblR5cGUgPT09IFwiTEVGVFwiID8gQ1NTJDUuc2VsZWN0IDogXCJcIn1gLCBvbkNsaWNrOiBqb2luT3BlcmF0aW9uLmpvaW5UeXBlID09PSBcIkxFRlRcIlxuICAgICAgICA/ICgpID0+IHtcbiAgICAgICAgICBqb2luT3BlcmF0aW9uLmpvaW5UeXBlID0gXCJJTk5FUlwiO1xuICAgICAgICAgIGZvcmNlVXBkYXRlKHRoaXMuaG9zdEVsZW1lbnQpO1xuICAgICAgICB9XG4gICAgICAgIDogdW5kZWZpbmVkIH0sIHN0cmluZ3Muam9pbi5pbm5lckpvaW4pLCBcIlxcdTAwQTBcIiwgaChcImNhbGNpdGUtY2hpcFwiLCB7IHZhbHVlOiBcImxlZnQtam9pblwiLCBhcHBlYXJhbmNlOiBqb2luT3BlcmF0aW9uLmpvaW5UeXBlID09PSBcIkxFRlRcIiA/IFwic29saWRcIiA6IFwib3V0bGluZS1maWxsXCIsIGtpbmQ6IFwiYnJhbmRcIiwgY2xhc3M6IGAke0NTUyQ1LmNoaXB9ICR7am9pbk9wZXJhdGlvbi5qb2luVHlwZSA9PT0gXCJJTk5FUlwiID8gQ1NTJDUuc2VsZWN0IDogXCJcIn1gLCBvbkNsaWNrOiBqb2luT3BlcmF0aW9uLmpvaW5UeXBlID09PSBcIklOTkVSXCJcbiAgICAgICAgPyAoKSA9PiB7XG4gICAgICAgICAgam9pbk9wZXJhdGlvbi5qb2luVHlwZSA9IFwiTEVGVFwiO1xuICAgICAgICAgIGZvcmNlVXBkYXRlKHRoaXMuaG9zdEVsZW1lbnQpO1xuICAgICAgICB9XG4gICAgICAgIDogdW5kZWZpbmVkIH0sIHN0cmluZ3Muam9pbi5sZWZ0Sm9pbikpKSk7XG4gIH1cbiAgb3BlbkZpZWxkUGlja0xpc3QoeyBsYXllciwgZmllbGROYW1lLCBtdWx0aXBsZSwgaGVhZGluZywgZmllbGRUeXBlcywgZXhjbHVkZWRGaWVsZHMsIGJ1dHRvbk5vZGUsIG9uQ2hhbmdlIH0pIHtcbiAgICBjb25zdCB7IHByb3BzLCBmaWVsZFBpY2tMaXN0U29ydEJ5LCBmbG93SXRlbU5vZGUgfSA9IHRoaXM7XG4gICAgY29uc3QgeyB2aWV3IH0gPSBwcm9wcztcbiAgICBjb25zdCBub2RlV2lkdGggPSBmbG93SXRlbU5vZGUuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkud2lkdGggfHwgMjE1O1xuICAgIHRoaXMuYXJjZ2lzRmllbGRQaWNrTGlzdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJhcmNnaXMtZmllbGQtcGljay1saXN0XCIpO1xuICAgIHRoaXMuYXJjZ2lzRmllbGRQaWNrTGlzdC5wb3BvdmVyUHJvcHMgPSB7XG4gICAgICBwbGFjZW1lbnQ6IFwiYXV0b1wiLFxuICAgICAgb2Zmc2V0RGlzdGFuY2U6IC0xICogKG5vZGVXaWR0aCAtIDIpLFxuICAgICAgb2Zmc2V0U2tpZGRpbmc6IDAsXG4gICAgICBwb2ludGVyRGlzYWJsZWQ6IHRydWUsXG4gICAgICBwb3BvdmVyV2lkdGg6IG5vZGVXaWR0aCArIDcsXG4gICAgICByZWZFbGVtZW50OiBmbG93SXRlbU5vZGVcbiAgICB9O1xuICAgIHRoaXMuYXJjZ2lzRmllbGRQaWNrTGlzdC5maWVsZHMgPSB0aGlzLmNyZWF0ZVBpY2tMaXN0RmllbGRzKGxheWVyLCBmaWVsZFR5cGVzLCBleGNsdWRlZEZpZWxkcyk7XG4gICAgdGhpcy5hcmNnaXNGaWVsZFBpY2tMaXN0LmxheWVyID0gbGF5ZXI7XG4gICAgdGhpcy5hcmNnaXNGaWVsZFBpY2tMaXN0Lm1hcFZpZXcgPSB2aWV3O1xuICAgIHRoaXMuYXJjZ2lzRmllbGRQaWNrTGlzdC5zaG93RmllbGRJbmZvID0gdHJ1ZTtcbiAgICB0aGlzLmFyY2dpc0ZpZWxkUGlja0xpc3Quc2hvd0ZpZWxkTmFtZSA9IGZhbHNlO1xuICAgIHRoaXMuYXJjZ2lzRmllbGRQaWNrTGlzdC5zZWxlY3RlZEZpZWxkcyA9IGZpZWxkTmFtZSA/IFtmaWVsZE5hbWVdIDogW107XG4gICAgdGhpcy5hcmNnaXNGaWVsZFBpY2tMaXN0LnNvcnRCeSA9IGZpZWxkUGlja0xpc3RTb3J0Qnk7XG4gICAgdGhpcy5hcmNnaXNGaWVsZFBpY2tMaXN0Lm11bHRpcGxlID0gbXVsdGlwbGU7XG4gICAgdGhpcy5hcmNnaXNGaWVsZFBpY2tMaXN0LmhlYWRpbmcgPSBoZWFkaW5nO1xuICAgIHRoaXMuYXJjZ2lzRmllbGRQaWNrTGlzdC5hZGRFdmVudExpc3RlbmVyKFwiYXJjZ2lzRmllbGRQaWNrTGlzdERpc21pc3NlZFwiLCAoZXZlbnQpID0+IHtcbiAgICAgIHZhciBfYTtcbiAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgY29uc3Qgc2VsZWN0ZWRGaWVsZHMgPSAoX2EgPSBldmVudC5kZXRhaWwpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5zZWxlY3RlZEZpZWxkcztcbiAgICAgIGZsb3dJdGVtTm9kZS5kaXNhYmxlZCA9IGZhbHNlO1xuICAgICAgaWYgKHRoaXMuYXJjZ2lzRmllbGRQaWNrTGlzdCkge1xuICAgICAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKHRoaXMuYXJjZ2lzRmllbGRQaWNrTGlzdCk7XG4gICAgICAgIHRoaXMuYXJjZ2lzRmllbGRQaWNrTGlzdCA9IG51bGw7XG4gICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgIGJ1dHRvbk5vZGUuc2V0Rm9jdXMoKTtcbiAgICAgICAgfSwgMSk7XG4gICAgICB9XG4gICAgICBpZiAoc2VsZWN0ZWRGaWVsZHMgPT09IG51bGwgfHwgc2VsZWN0ZWRGaWVsZHMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHNlbGVjdGVkRmllbGRzLmxlbmd0aCkge1xuICAgICAgICBvbkNoYW5nZShzZWxlY3RlZEZpZWxkcyk7XG4gICAgICB9IC8vIGVsc2UgdXNlciBoaXQgY2FuY2VsIG9yIGNsb3NlXG4gICAgfSk7XG4gICAgdGhpcy5hcmNnaXNGaWVsZFBpY2tMaXN0LmFkZEV2ZW50TGlzdGVuZXIoXCJhcmNnaXNGaWVsZFBpY2tMaXN0U29ydEJ5Q2hhbmdlXCIsIChldmVudCkgPT4gKHRoaXMuZmllbGRQaWNrTGlzdFNvcnRCeSA9IGV2ZW50LmRldGFpbCkpO1xuICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQodGhpcy5hcmNnaXNGaWVsZFBpY2tMaXN0KTtcbiAgICBmbG93SXRlbU5vZGUuZGlzYWJsZWQgPSB0cnVlO1xuICB9XG4gIGNyZWF0ZVBpY2tMaXN0RmllbGRzKGxheWVyLCBmaWVsZFR5cGVzLCBleGNsdWRlZEZpZWxkcykge1xuICAgIGNvbnN0IHsgZmllbGRzLCBwb3B1cFRlbXBsYXRlIH0gPSBsYXllcjtcbiAgICBjb25zdCBsYXllckZpZWxkcyA9IGZpZWxkc1xuICAgICAgLmZpbHRlcigoZmllbGQpID0+IGV4Y2x1ZGVkRmllbGRzLmluZGV4T2YoZmllbGQubmFtZSkgPT09IC0xKVxuICAgICAgLmZpbHRlcigoZmllbGQpID0+IGZpZWxkVHlwZXMuaW5kZXhPZihmaWVsZC50eXBlKSA+IC0xKTtcbiAgICByZXR1cm4gbGF5ZXJGaWVsZHMubWFwKChmaWVsZCkgPT4ge1xuICAgICAgdmFyIF9hLCBfYjtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIG5hbWU6IGZpZWxkLm5hbWUsXG4gICAgICAgIGFsaWFzOiAoKF9iID0gKF9hID0gcG9wdXBUZW1wbGF0ZSA9PT0gbnVsbCB8fCBwb3B1cFRlbXBsYXRlID09PSB2b2lkIDAgPyB2b2lkIDAgOiBwb3B1cFRlbXBsYXRlLmZpZWxkSW5mb3MpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5maW5kKChmaWVsZEluZm8pID0+IGZpZWxkSW5mby5maWVsZE5hbWUgPT09IGZpZWxkLm5hbWUpKSA9PT0gbnVsbCB8fCBfYiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2IubGFiZWwpIHx8IGZpZWxkLmFsaWFzLFxuICAgICAgICB0eXBlOiBmaWVsZC50eXBlXG4gICAgICB9O1xuICAgIH0pO1xuICB9XG4gIGhhbmRsZUluZm9DbGljayhldmVudCwgdHlwZSkge1xuICAgIC8vIGRvbid0IGV4ZWN1dGUgdGhlIGV2ZW50IG9uIHRoZSBlbnRpcmUgdGlsZVxuICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgIHRoaXMucmVtb3ZlSW5mb1BvcG92ZXIoKTtcbiAgICBjb25zdCB7IHByb3BzIH0gPSB0aGlzO1xuICAgIGNvbnN0IHJlZkVsZW1lbnQgPSB0eXBlID09PSBcImpvaW4tb3BlcmF0aW9uXCIgPyB0aGlzLmpvaW5PcGVyYXRpb25JbmZvSWNvbk5vZGUgOiB0aGlzLmpvaW5UeXBlSW5mb0ljb25Ob2RlO1xuICAgIHRoaXMuaW5mb1BvcG92ZXJOb2RlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImFyY2dpcy1sYXllci12aWV3LWpvaW4taW5mby1wb3BvdmVyXCIpO1xuICAgIHRoaXMuaW5mb1BvcG92ZXJOb2RlLnByb3BzID0gcHJvcHM7XG4gICAgdGhpcy5pbmZvUG9wb3Zlck5vZGUudHlwZSA9IHR5cGU7XG4gICAgdGhpcy5pbmZvUG9wb3Zlck5vZGUucmVmZXJlbmNlRWxlbWVudCA9IHJlZkVsZW1lbnQ7XG4gICAgdGhpcy5pbmZvUG9wb3Zlck5vZGUuYWRkRXZlbnRMaXN0ZW5lcihcImFyY2dpc0xheWVyVmlld0pvaW5JbmZvUG9wb3ZlckNsb3NlXCIsIChldmVudCkgPT4ge1xuICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICB0aGlzLnJlbW92ZUluZm9Qb3BvdmVyKCk7XG4gICAgICBzZXRUaW1lb3V0KCgpID0+IHJlZkVsZW1lbnQuc2V0Rm9jdXMoKSwgMjAwKTtcbiAgICB9KTtcbiAgICB0aGlzLmluZm9Qb3BvdmVyTm9kZS5hZGRFdmVudExpc3RlbmVyKFwiYXJjZ2lzTGF5ZXJWaWV3Sm9pbkluZm9Qb3BvdmVyRGlzY29ubmVjdGVkXCIsIChldmVudCkgPT4ge1xuICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICB0aGlzLnJlbW92ZUluZm9Qb3BvdmVyKCk7XG4gICAgfSk7XG4gICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZCh0aGlzLmluZm9Qb3BvdmVyTm9kZSk7XG4gICAgdGhpcy5pbmZvUG9wb3Zlck5vZGUuc2V0T3Blbih0cnVlKTtcbiAgICAvLyBuZWVkIHRvIHdhaXQgdW50aWwgaXQncyBhbGwgdmlzaWJsZVxuICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5pbmZvUG9wb3Zlck5vZGUuc2V0Rm9jdXMoKSwgMTAwKTtcbiAgfVxuICByZW1vdmVJbmZvUG9wb3ZlcigpIHtcbiAgICB2YXIgX2E7XG4gICAgaWYgKHRoaXMuaW5mb1BvcG92ZXJOb2RlKSB7XG4gICAgICAoX2EgPSB0aGlzLmluZm9Qb3BvdmVyTm9kZS5wYXJlbnROb2RlKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EucmVtb3ZlQ2hpbGQodGhpcy5pbmZvUG9wb3Zlck5vZGUpO1xuICAgICAgdGhpcy5pbmZvUG9wb3Zlck5vZGUgPSBudWxsO1xuICAgIH1cbiAgfVxuICBnZXQgaG9zdEVsZW1lbnQoKSB7IHJldHVybiBnZXRFbGVtZW50KHRoaXMpOyB9XG59O1xuQXJjZ2lzTGF5ZXJWaWV3Sm9pbkNvbmZpZy5zdHlsZSA9IGFyY2dpc0xheWVyVmlld0pvaW5Db25maWdDc3M7XG5cbmNvbnN0IENTUyQ0ID0ge1xuICBwYW5lbDogXCJwYW5lbFwiLFxuICBpbmZvOiBcImluZm9cIixcbiAgZm9vdGVyOiBcImZvb3RlclwiLFxuICBsYXllclNlY3Rpb246IFwibGF5ZXItc2VjdGlvblwiLFxuICB0YXJnZXRMYXllcjogXCJ0YXJnZXQtbGF5ZXJcIixcbiAgYWRkTGF5ZXI6IFwiYWRkLWxheWVyXCIsXG4gIGxheWVySGVhZGVyOiBcImxheWVyLWhlYWRlclwiLFxuICBsYXllclRpdGxlOiBcImxheWVyLXRpdGxlXCJcbn07XG5cbmNvbnN0IGFyY2dpc0xheWVyVmlld0pvaW5DcmVhdGVDc3MgPSBcIi5wYW5lbC5zYy1hcmNnaXMtbGF5ZXItdmlldy1qb2luLWNyZWF0ZXtoZWlnaHQ6MTAwJX0uaW5mby5zYy1hcmNnaXMtbGF5ZXItdmlldy1qb2luLWNyZWF0ZXtkaXNwbGF5OmdyaWQ7Z3JpZC10ZW1wbGF0ZS1jb2x1bW5zOnJlcGVhdCgxLCBtaW5tYXgoMHB4LCAxZnIpKTtnYXA6MC41cmVtO3BhZGRpbmc6MCAwLjc1cmVtfS5mb290ZXIuc2MtYXJjZ2lzLWxheWVyLXZpZXctam9pbi1jcmVhdGV7d2lkdGg6MTAwJX0ubGF5ZXItc2VjdGlvbi5zYy1hcmNnaXMtbGF5ZXItdmlldy1qb2luLWNyZWF0ZXtib3JkZXI6MXB4IHNvbGlkIHZhcigtLWNhbGNpdGUtdWktYm9yZGVyLTMpO2JhY2tncm91bmQtY29sb3I6d2hpdGU7bWFyZ2luOjEwcHh9LnRhcmdldC1sYXllci5zYy1hcmNnaXMtbGF5ZXItdmlldy1qb2luLWNyZWF0ZXtwYWRkaW5nOjEwcHg7Ym9yZGVyLWJvdHRvbToxcHggc29saWQgdmFyKC0tY2FsY2l0ZS11aS1ib3JkZXItMyl9LmFkZC1sYXllci5zYy1hcmNnaXMtbGF5ZXItdmlldy1qb2luLWNyZWF0ZXtwYWRkaW5nOjEwcHh9LmxheWVyLWhlYWRlci5zYy1hcmNnaXMtbGF5ZXItdmlldy1qb2luLWNyZWF0ZXtwYWRkaW5nLWJvdHRvbTozcHh9LmxheWVyLXRpdGxlLnNjLWFyY2dpcy1sYXllci12aWV3LWpvaW4tY3JlYXRle2ZvbnQtd2VpZ2h0OmJvbGR9Lm5vdGljZS5zYy1hcmNnaXMtbGF5ZXItdmlldy1qb2luLWNyZWF0ZXttYXJnaW46OHB4fVwiO1xuXG5jb25zdCBBcmNnaXNMYXllclZpZXdKb2luQ3JlYXRlID0gY2xhc3Mge1xuICBjb25zdHJ1Y3Rvcihob3N0UmVmKSB7XG4gICAgcmVnaXN0ZXJJbnN0YW5jZSh0aGlzLCBob3N0UmVmKTtcbiAgICB0aGlzLmFyY2dpc0xheWVyVmlld0pvaW5TdGF0dXNDaGFuZ2UgPSBjcmVhdGVFdmVudCh0aGlzLCBcImFyY2dpc0xheWVyVmlld0pvaW5TdGF0dXNDaGFuZ2VcIiwgNyk7XG4gICAgdGhpcy5hcmNnaXNMYXllclZpZXdKb2luQ3JlYXRlRG9uZSA9IGNyZWF0ZUV2ZW50KHRoaXMsIFwiYXJjZ2lzTGF5ZXJWaWV3Sm9pbkNyZWF0ZURvbmVcIiwgNyk7XG4gICAgdGhpcy5hcmNnaXNMYXllclZpZXdKb2luQ3JlYXRlQ2FuY2VsID0gY3JlYXRlRXZlbnQodGhpcywgXCJhcmNnaXNMYXllclZpZXdKb2luQ3JlYXRlQ2FuY2VsXCIsIDcpO1xuICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgLy9cbiAgICAvLyAgUHJpdmF0ZSBtZXRob2RzXG4gICAgLy9cbiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAgIHRoaXMuZ29CYWNrID0gKCkgPT4ge1xuICAgICAgLy8gc2F2ZSBsYXN0IHNldHRpbmdzXG4gICAgICBjb25zdCB7IHByb3BzIH0gPSB0aGlzO1xuICAgICAgcHJvcHMuc2F2ZWRJdGVtUHJvcHMgPSB7XG4gICAgICAgIHRpdGxlOiBpdGVtUHJvcGVydGllc1N0YXRlLnRpdGxlLFxuICAgICAgICB0YWdzOiBpdGVtUHJvcGVydGllc1N0YXRlLnRhZ3MsXG4gICAgICAgIHN1bW1hcnk6IGl0ZW1Qcm9wZXJ0aWVzU3RhdGUuc25pcHBldCxcbiAgICAgICAgY2F0ZWdvcmllczogaXRlbVByb3BlcnRpZXNTdGF0ZS5jYXRlZ29yaWVzLFxuICAgICAgICBmb2xkZXI6IGl0ZW1Qcm9wZXJ0aWVzU3RhdGUuZm9sZGVyXG4gICAgICB9O1xuICAgICAgdGhpcy5hcmNnaXNMYXllclZpZXdKb2luU3RhdHVzQ2hhbmdlLmVtaXQoe1xuICAgICAgICBzdGF0dXM6IGpvaW5GbG93U3RhdHVzLkNPTkZJR1xuICAgICAgfSk7XG4gICAgfTtcbiAgICB0aGlzLmdvQ3JlYXRlID0gYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgeyBwcm9wcywgZmxvd0l0ZW1Ob2RlLCBob3N0RWxlbWVudCB9ID0gdGhpcztcbiAgICAgIGNvbnN0IHsgc3RyaW5ncyB9ID0gcHJvcHM7XG4gICAgICAvLyBpbiBjYXNlIHRoZSBjcmVhdGUgY2FsbCBmYWlsc1xuICAgICAgcHJvcHMuc2F2ZWRJdGVtUHJvcHMgPSB7XG4gICAgICAgIHRpdGxlOiBpdGVtUHJvcGVydGllc1N0YXRlLnRpdGxlLFxuICAgICAgICB0YWdzOiBpdGVtUHJvcGVydGllc1N0YXRlLnRhZ3MsXG4gICAgICAgIHN1bW1hcnk6IGl0ZW1Qcm9wZXJ0aWVzU3RhdGUuc25pcHBldCxcbiAgICAgICAgY2F0ZWdvcmllczogaXRlbVByb3BlcnRpZXNTdGF0ZS5jYXRlZ29yaWVzLFxuICAgICAgICBmb2xkZXI6IGl0ZW1Qcm9wZXJ0aWVzU3RhdGUuZm9sZGVyXG4gICAgICB9O1xuICAgICAgY29uc3QgbmV3SXRlbVByb3BzID0ge1xuICAgICAgICB0aXRsZTogaXRlbVByb3BlcnRpZXNTdGF0ZS50aXRsZSxcbiAgICAgICAgdGFnczogaXRlbVByb3BlcnRpZXNTdGF0ZS50YWdzLFxuICAgICAgICBzdW1tYXJ5OiBpdGVtUHJvcGVydGllc1N0YXRlLnNuaXBwZXQsXG4gICAgICAgIGNhdGVnb3JpZXM6IGl0ZW1Qcm9wZXJ0aWVzU3RhdGUuY2F0ZWdvcmllcyxcbiAgICAgICAgZm9sZGVyOiBpdGVtUHJvcGVydGllc1N0YXRlLmZvbGRlclxuICAgICAgfTtcbiAgICAgIHRoaXMubG9hZGluZyA9IHRydWU7XG4gICAgICB0cnkge1xuICAgICAgICB0aGlzLnZpZXdJdGVtSWQgPSBhd2FpdCBjcmVhdGVKb2luVmlldyhwcm9wcywgbmV3SXRlbVByb3BzKTtcbiAgICAgICAgdGhpcy5sb2FkaW5nID0gZmFsc2U7XG4gICAgICAgIHRoaXMubXNnTm9kZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJhcmNnaXMtbGF5ZXItdmlldy1tc2dcIik7XG4gICAgICAgIHRoaXMubXNnTm9kZS5wcm9wcyA9IHByb3BzO1xuICAgICAgICB0aGlzLm1zZ05vZGUuZmxvd0l0ZW1FbGVtZW50ID0gZmxvd0l0ZW1Ob2RlO1xuICAgICAgICB0aGlzLm1zZ05vZGUubWVzc2FnZSA9IHN0cmluZ3MubXNnLmNyZWF0ZWQ7XG4gICAgICAgIGhvc3RFbGVtZW50LmFwcGVuZENoaWxkKHRoaXMubXNnTm9kZSk7XG4gICAgICAgIGNsZWFyVGltZW91dCh0aGlzLnRpbWVvdXRIbmRsKTtcbiAgICAgICAgdGhpcy50aW1lb3V0SG5kbCA9IHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgIHRoaXMudGltZW91dEhuZGwgPSB1bmRlZmluZWQ7XG4gICAgICAgICAgaWYgKHRoaXMubXNnTm9kZSkge1xuICAgICAgICAgICAgaG9zdEVsZW1lbnQucmVtb3ZlQ2hpbGQodGhpcy5tc2dOb2RlKTtcbiAgICAgICAgICAgIHRoaXMubXNnTm9kZSA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgIHRoaXMuYXJjZ2lzTGF5ZXJWaWV3Sm9pbkNyZWF0ZURvbmUuZW1pdCh0aGlzLnZpZXdJdGVtSWQpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSwgNzAwMCk7XG4gICAgICB9XG4gICAgICBjYXRjaCAoZSkge1xuICAgICAgICBjb25zdCB7IHByb3BzLCBmbG93SXRlbU5vZGUgfSA9IHRoaXM7XG4gICAgICAgIGNvbnN0IHsgc3RyaW5ncyB9ID0gcHJvcHM7XG4gICAgICAgIHRoaXMubG9hZGluZyA9IGZhbHNlO1xuICAgICAgICBjb25zb2xlLmVycm9yKFwiY291bGQgbm90IGNyZWF0ZSBqb2luIHZpZXdcIiwgZSk7XG4gICAgICAgIHRoaXMubXNnTm9kZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJhcmNnaXMtbGF5ZXItdmlldy1tc2dcIik7XG4gICAgICAgIHRoaXMubXNnTm9kZS5wcm9wcyA9IHByb3BzO1xuICAgICAgICB0aGlzLm1zZ05vZGUuZmxvd0l0ZW1FbGVtZW50ID0gZmxvd0l0ZW1Ob2RlO1xuICAgICAgICB0aGlzLm1zZ05vZGUuaXNFcnJvciA9IHRydWU7XG4gICAgICAgIHRoaXMubXNnTm9kZS5tZXNzYWdlID0gc3RyaW5ncy5tc2cuY3JlYXRlRmFpbGVkO1xuICAgICAgICBob3N0RWxlbWVudC5hcHBlbmRDaGlsZCh0aGlzLm1zZ05vZGUpO1xuICAgICAgICBjbGVhclRpbWVvdXQodGhpcy50aW1lb3V0SG5kbCk7XG4gICAgICAgIHRoaXMudGltZW91dEhuZGwgPSBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICB0aGlzLnRpbWVvdXRIbmRsID0gdW5kZWZpbmVkO1xuICAgICAgICAgIGlmICh0aGlzLm1zZ05vZGUpIHtcbiAgICAgICAgICAgIGhvc3RFbGVtZW50LnJlbW92ZUNoaWxkKHRoaXMubXNnTm9kZSk7XG4gICAgICAgICAgICB0aGlzLm1zZ05vZGUgPSB1bmRlZmluZWQ7XG4gICAgICAgICAgfVxuICAgICAgICB9LCA3MDAwKTtcbiAgICAgIH1cbiAgICB9O1xuICAgIHRoaXMuZ29DYW5jZWwgPSAoKSA9PiB7XG4gICAgICB0aGlzLmFyY2dpc0xheWVyVmlld0pvaW5DcmVhdGVDYW5jZWwuZW1pdCgpO1xuICAgIH07XG4gICAgdGhpcy5wcm9wcyA9IHVuZGVmaW5lZDtcbiAgICB0aGlzLmxvYWRpbmcgPSBmYWxzZTtcbiAgICB0aGlzLnRpdGxlID0gdW5kZWZpbmVkO1xuICB9XG4gIGFyY2dpc0xheWVyVmlld01zZ0Nsb3NlZEhhbmRsZXIoKSB7XG4gICAgaWYgKHRoaXMubXNnTm9kZSkge1xuICAgICAgdGhpcy5ob3N0RWxlbWVudC5yZW1vdmVDaGlsZCh0aGlzLm1zZ05vZGUpO1xuICAgICAgdGhpcy5tc2dOb2RlID0gdW5kZWZpbmVkO1xuICAgIH1cbiAgICBjbGVhclRpbWVvdXQodGhpcy50aW1lb3V0SG5kbCk7XG4gICAgdGhpcy50aW1lb3V0SG5kbCA9IHVuZGVmaW5lZDtcbiAgICBpZiAodGhpcy52aWV3SXRlbUlkKSB7XG4gICAgICB0aGlzLmFyY2dpc0xheWVyVmlld0pvaW5DcmVhdGVEb25lLmVtaXQodGhpcy52aWV3SXRlbUlkKTtcbiAgICB9XG4gIH1cbiAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAvL1xuICAvLyAgTGlmZWN5Y2xlXG4gIC8vXG4gIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgYXN5bmMgY29tcG9uZW50V2lsbExvYWQoKSB7XG4gICAgY29uc3QgeyBwcm9wcyB9ID0gdGhpcztcbiAgICBjb25zdCB7IHRhcmdldExheWVyLCB0YXJnZXRMYXllcklkLCBhZGRMYXllciwgYWRkTGF5ZXJJZCB9ID0gcHJvcHM7XG4gICAgdGhpcy50YXJnZXRGTCA9ICh0YXJnZXRMYXllci50eXBlID09PSBcImdyb3VwXCJcbiAgICAgID8gZ2V0TGF5ZXJzQW5kVGFibGVzKHRhcmdldExheWVyKS5maW5kKChseXIpID0+IGx5ci5sYXllcklkID09PSB0YXJnZXRMYXllcklkKVxuICAgICAgOiB0YXJnZXRMYXllcik7XG4gICAgdGhpcy5hZGRGTCA9IChhZGRMYXllci50eXBlID09PSBcImdyb3VwXCJcbiAgICAgID8gZ2V0TGF5ZXJzQW5kVGFibGVzKGFkZExheWVyKS5maW5kKChseXIpID0+IGx5ci5sYXllcklkID09PSBhZGRMYXllcklkKVxuICAgICAgOiBhZGRMYXllcik7XG4gICAgdGhpcy50aXRsZSA9IGF3YWl0IGdldFN1Z2dlc3RlZFRpdGxlRm9ySm9pbihwcm9wcyk7XG4gIH1cbiAgYXN5bmMgY29tcG9uZW50RGlkTG9hZCgpIHtcbiAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKCkgPT4geyB2YXIgX2E7IHJldHVybiAoX2EgPSB0aGlzLmJhY2tCdXR0b25Ob2RlKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2Euc2V0Rm9jdXMoKTsgfSk7XG4gIH1cbiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgLy9cbiAgLy8gIFJlbmRlciBNZXRob2RzXG4gIC8vXG4gIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgcmVuZGVyKCkge1xuICAgIGNvbnN0IHsgcHJvcHMsIGxvYWRpbmcgfSA9IHRoaXM7XG4gICAgY29uc3QgeyBzdHJpbmdzIH0gPSBwcm9wcztcbiAgICBjb25zdCBydGwgPSBnZXRFbGVtZW50RGlyKHRoaXMuaG9zdEVsZW1lbnQpID09PSBcInJ0bFwiO1xuICAgIHJldHVybiAoaChIb3N0LCB7IGNsYXNzOiBcImNhbGNpdGUtbWF0Y2gtaGVpZ2h0XCIgfSwgaChcImNhbGNpdGUtZmxvdy1pdGVtXCIsIHsgaGVhZGluZzogc3RyaW5ncy5qb2luLmNyZWF0ZSwgbG9hZGluZzogbG9hZGluZywgY2xhc3M6IHtcbiAgICAgICAgcGFuZWw6IHRydWUsXG4gICAgICAgIFtDU1NfVVRJTElUWS5ydGxdOiBydGxcbiAgICAgIH0sIHJlZjogKG5vZGUpID0+ICh0aGlzLmZsb3dJdGVtTm9kZSA9IG5vZGUpIH0sIHRoaXMucmVuZGVyRm9vdGVyQnV0dG9ucygpLCB0aGlzLnJlbmRlck5vdGljZSgpLCB0aGlzLnJlbmRlckxheWVycygpLCB0aGlzLnJlbmRlckluZm8oKSkpKTtcbiAgfVxuICByZW5kZXJGb290ZXJCdXR0b25zKCkge1xuICAgIHJldHVybiAoaChcImRpdlwiLCB7IHNsb3Q6IFwiZm9vdGVyXCIsIGNsYXNzOiBDU1MkNC5mb290ZXIgfSwgdGhpcy5yZW5kZXJCYWNrKCksIHRoaXMucmVuZGVyQ3JlYXRlKCksIGgoXCJiclwiLCBudWxsKSwgdGhpcy5yZW5kZXJDYW5jZWwoKSkpO1xuICB9XG4gIHJlbmRlckJhY2soKSB7XG4gICAgY29uc3QgeyBwcm9wcyB9ID0gdGhpcztcbiAgICBjb25zdCB7IHN0cmluZ3MgfSA9IHByb3BzO1xuICAgIGNvbnN0IGlzUnRsID0gZ2V0RWxlbWVudERpcih0aGlzLmhvc3RFbGVtZW50KSA9PT0gXCJydGxcIjtcbiAgICByZXR1cm4gKGgoXCJjYWxjaXRlLWJ1dHRvblwiLCB7IG9uQ2xpY2s6IHRoaXMuZ29CYWNrLCBhcHBlYXJhbmNlOiBcIm91dGxpbmUtZmlsbFwiLCB3aWR0aDogXCJoYWxmXCIsIFwiaWNvbi1zdGFydFwiOiBpc1J0bCA/IFwiYXJyb3ctcmlnaHRcIiA6IFwiYXJyb3ctbGVmdFwiLCByZWY6IChub2RlKSA9PiAodGhpcy5iYWNrQnV0dG9uTm9kZSA9IG5vZGUpIH0sIHN0cmluZ3MuZ2VuZXJhbC5iYWNrKSk7XG4gIH1cbiAgcmVuZGVyQ3JlYXRlKCkge1xuICAgIGNvbnN0IHsgcHJvcHMsIHRpdGxlLCB0aXRsZUVycm9yLCBzdW1tYXJ5RXJyb3IgfSA9IHRoaXM7XG4gICAgY29uc3QgeyBzdHJpbmdzIH0gPSBwcm9wcztcbiAgICBjb25zdCBlbmFibGVkID0gdGl0bGUgJiYgIXRpdGxlRXJyb3IgJiYgIXN1bW1hcnlFcnJvcjtcbiAgICByZXR1cm4gKGgoXCJjYWxjaXRlLWJ1dHRvblwiLCB7IGRpc2FibGVkOiAhZW5hYmxlZCwgb25DbGljazogZW5hYmxlZCAmJiB0aGlzLmdvQ3JlYXRlLCBhcHBlYXJhbmNlOiBcInNvbGlkXCIsIHdpZHRoOiBcImhhbGZcIiwgXCJpY29uLXN0YXJ0XCI6IFwicGx1cy1zcXVhcmVcIiwgcmVmOiAobm9kZSkgPT4gKHRoaXMuY3JlYXRlQnV0dG9uTm9kZSA9IG5vZGUpIH0sIHN0cmluZ3MuY3JlYXRlVmlldy5jcmVhdGUpKTtcbiAgfVxuICByZW5kZXJDYW5jZWwoKSB7XG4gICAgY29uc3QgeyBwcm9wcyB9ID0gdGhpcztcbiAgICBjb25zdCB7IHN0cmluZ3MgfSA9IHByb3BzO1xuICAgIHJldHVybiAoaChcImNhbGNpdGUtYnV0dG9uXCIsIHsgb25DbGljazogdGhpcy5nb0NhbmNlbCwgYXBwZWFyYW5jZTogXCJ0cmFuc3BhcmVudFwiLCB3aWR0aDogXCJmdWxsXCIgfSwgc3RyaW5ncy5nZW5lcmFsLmNhbmNlbCkpO1xuICB9XG4gIHJlbmRlck5vdGljZSgpIHtcbiAgICB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICB9XG4gIHJlbmRlckxheWVycygpIHtcbiAgICBjb25zdCB7IHByb3BzLCB0YXJnZXRGTCwgYWRkRkwgfSA9IHRoaXM7XG4gICAgY29uc3QgeyB0YXJnZXRJdGVtLCB0YXJnZXRMYXllciwgYWRkSXRlbSwgYWRkTGF5ZXIsIHN0cmluZ3MgfSA9IHByb3BzO1xuICAgIGNvbnN0IHJ0bCA9IGdldEVsZW1lbnREaXIodGhpcy5ob3N0RWxlbWVudCkgPT09IFwicnRsXCI7XG4gICAgY29uc3QgdGFyZ2V0VGl0bGUgPSB0YXJnZXRMYXllci50eXBlID09PSBcImdyb3VwXCJcbiAgICAgID8gcnRsXG4gICAgICAgID8gYCR7dGFyZ2V0RkwudGl0bGV9IC8gJHt0YXJnZXRJdGVtLnRpdGxlfWBcbiAgICAgICAgOiBgJHt0YXJnZXRJdGVtLnRpdGxlfSAvICR7dGFyZ2V0RkwudGl0bGV9YFxuICAgICAgOiB0YXJnZXRMYXllci50aXRsZTtcbiAgICBjb25zdCBhZGRUaXRsZSA9IGFkZExheWVyLnR5cGUgPT09IFwiZ3JvdXBcIlxuICAgICAgPyBydGxcbiAgICAgICAgPyBgJHthZGRGTC50aXRsZX0gLyAke2FkZEl0ZW0udGl0bGV9YFxuICAgICAgICA6IGAke2FkZEl0ZW0udGl0bGV9IC8gJHthZGRGTC50aXRsZX1gXG4gICAgICA6IGFkZExheWVyLnRpdGxlO1xuICAgIHJldHVybiAoaChcImRpdlwiLCB7IGNsYXNzOiBDU1MkNC5sYXllclNlY3Rpb24gfSwgaChcImRpdlwiLCB7IGNsYXNzOiBDU1MkNC50YXJnZXRMYXllciB9LCBoKFwiZGl2XCIsIHsgY2xhc3M6IENTUyQ0LmxheWVySGVhZGVyIH0sIHN0cmluZ3Muam9pbi50YXJnZXRMYXllciksIGgoXCJkaXZcIiwgeyBjbGFzczogQ1NTJDQubGF5ZXJUaXRsZSB9LCB0YXJnZXRUaXRsZSkpLCBoKFwiZGl2XCIsIHsgY2xhc3M6IENTUyQ0LmFkZExheWVyIH0sIGgoXCJkaXZcIiwgeyBjbGFzczogQ1NTJDQubGF5ZXJIZWFkZXIgfSwgc3RyaW5ncy5qb2luLmpvaW5MYXllciksIGgoXCJkaXZcIiwgeyBjbGFzczogQ1NTJDQubGF5ZXJUaXRsZSB9LCBhZGRUaXRsZSkpKSk7XG4gIH1cbiAgcmVuZGVySW5mbygpIHtcbiAgICBjb25zdCB7IHByb3BzLCB0aXRsZSB9ID0gdGhpcztcbiAgICBjb25zdCB7IHRhcmdldEl0ZW0sIHRhcmdldEl0ZW1Pd25lciwgc2F2ZWRJdGVtUHJvcHMgfSA9IHByb3BzO1xuICAgIGNvbnN0IHsgcG9ydGFsIH0gPSB0YXJnZXRJdGVtO1xuICAgIGNvbnN0IHVzZXIgPSBwb3J0YWwudXNlcjtcbiAgICBjb25zdCBjb25maWcgPSB7IHBvcnRhbCwgdXNlciwgYXBpOiA0IH07XG4gICAgaWYgKHNhdmVkSXRlbVByb3BzKSB7XG4gICAgICBpdGVtUHJvcGVydGllc1N0YXRlLnRpdGxlID0gc2F2ZWRJdGVtUHJvcHMudGl0bGU7XG4gICAgICBpdGVtUHJvcGVydGllc1N0YXRlLmZvbGRlciA9IHNhdmVkSXRlbVByb3BzLmZvbGRlcjtcbiAgICAgIGl0ZW1Qcm9wZXJ0aWVzU3RhdGUuc25pcHBldCA9IHNhdmVkSXRlbVByb3BzLnN1bW1hcnkgfHwgXCJcIjtcbiAgICAgIGl0ZW1Qcm9wZXJ0aWVzU3RhdGUuY2F0ZWdvcmllcyA9IHNhdmVkSXRlbVByb3BzLmNhdGVnb3JpZXM7XG4gICAgICBpdGVtUHJvcGVydGllc1N0YXRlLnRhZ3MgPSBzYXZlZEl0ZW1Qcm9wcy50YWdzO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgIGl0ZW1Qcm9wZXJ0aWVzU3RhdGUudGl0bGUgPSB0aXRsZTtcbiAgICAgIGl0ZW1Qcm9wZXJ0aWVzU3RhdGUuZm9sZGVyID1cbiAgICAgICAgdGFyZ2V0SXRlbS5vd25lckZvbGRlciAmJlxuICAgICAgICAgIHtcbiAgICAgICAgICAgIGlkOiB0YXJnZXRJdGVtLm93bmVyRm9sZGVyLFxuICAgICAgICAgICAgdXNlcm5hbWU6IHRhcmdldEl0ZW0ub3duZXJcbiAgICAgICAgICB9O1xuICAgICAgaXRlbVByb3BlcnRpZXNTdGF0ZS5zbmlwcGV0ID0gdGFyZ2V0SXRlbS5zbmlwcGV0IHx8IFwiXCI7XG4gICAgICBpdGVtUHJvcGVydGllc1N0YXRlLmNhdGVnb3JpZXMgPSB0YXJnZXRJdGVtLmNhdGVnb3JpZXM7XG4gICAgICBpdGVtUHJvcGVydGllc1N0YXRlLnRhZ3MgPSB0YXJnZXRJdGVtLnRhZ3M7XG4gICAgfVxuICAgIHJldHVybiAoaChcImRpdlwiLCB7IGNsYXNzOiBDU1MkNC5pbmZvIH0sIGgoXCJhcmNnaXMtaXRlbS1wcm9wZXJ0aWVzXCIsIHsgcG9ydGFsOiBwb3J0YWwsIHVzZXI6IHVzZXIsIGFwaTogNCwgY29uZmlnOiBjb25maWcsIHR5cGU6IFwiRmVhdHVyZSBTZXJ2aWNlXCIsIHNjYWxlOiBcInNcIiB9LCBoKFwiYXJjZ2lzLXRpdGxlLWlucHV0XCIsIHsgZW5hYmxlUHVibGlzaGluZzogdHJ1ZSwgb25BcmNnaXNUaXRsZUlucHV0Q2hhbmdlOiBhc3luYyAoZXZlbnQpID0+IHtcbiAgICAgICAgY29uc3Qgbm9kZSA9IGV2ZW50LnRhcmdldDtcbiAgICAgICAgY29uc3QgdGl0bGVFcnJvciA9IGF3YWl0IG5vZGUudmFsaWRhdGVUaXRsZSgpO1xuICAgICAgICBpZiAoKCF0aGlzLnRpdGxlRXJyb3IgJiYgdGl0bGVFcnJvcikgfHwgKHRoaXMudGl0bGVFcnJvciAmJiAhdGl0bGVFcnJvcikpIHtcbiAgICAgICAgICBmb3JjZVVwZGF0ZSh0aGlzLmhvc3RFbGVtZW50KTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnRpdGxlRXJyb3IgPSB0aXRsZUVycm9yO1xuICAgICAgfSB9KSwgaChcImFyY2dpcy1mb2xkZXItcGlja2VyXCIsIHsgdXNlcjogdGFyZ2V0SXRlbU93bmVyIH0pLCBoKFwiYXJjZ2lzLWNhdGVnb3JpZXMtcGlja2VyXCIsIG51bGwpLCBoKFwiYXJjZ2lzLXRhZ3MtcGlja2VyXCIsIG51bGwpLCBoKFwiYXJjZ2lzLXN1bW1hcnktaW5wdXRcIiwgeyBvbkFyY2dpc1N1bW1hcnlJbnB1dENoYW5nZTogYXN5bmMgKGV2ZW50KSA9PiB7XG4gICAgICAgIGNvbnN0IG5vZGUgPSBldmVudC50YXJnZXQ7XG4gICAgICAgIGNvbnN0IHN1bW1hcnlFcnJvciA9IChhd2FpdCBub2RlLmdldEVycm9yTWVzc2FnZSgpKTtcbiAgICAgICAgaWYgKCghdGhpcy5zdW1tYXJ5RXJyb3IgJiYgc3VtbWFyeUVycm9yKSB8fCAodGhpcy5zdW1tYXJ5RXJyb3IgJiYgIXN1bW1hcnlFcnJvcikpIHtcbiAgICAgICAgICBmb3JjZVVwZGF0ZSh0aGlzLmhvc3RFbGVtZW50KTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnN1bW1hcnlFcnJvciA9IHN1bW1hcnlFcnJvcjtcbiAgICAgIH0gfSkpKSk7XG4gIH1cbiAgZ2V0IGhvc3RFbGVtZW50KCkgeyByZXR1cm4gZ2V0RWxlbWVudCh0aGlzKTsgfVxufTtcbkFyY2dpc0xheWVyVmlld0pvaW5DcmVhdGUuc3R5bGUgPSBhcmNnaXNMYXllclZpZXdKb2luQ3JlYXRlQ3NzO1xuXG5jb25zdCBDU1MkMyA9IHtcbiAgZmxvdzogXCJmbG93XCIsXG4gIHBhbmVsOiBcInBhbmVsXCIsXG4gIGZvb3RlcjogXCJmb290ZXJcIixcbiAgaW5mbzogXCJpbmZvXCIsXG4gIHRleHQ6IFwidGV4dFwiXG59O1xuXG5jb25zdCBhcmNnaXNMYXllclZpZXdKb2luVGFyZ2V0U2VsZWN0aW9uQ3NzID0gXCIuZmxvd3toZWlnaHQ6MTAwJX0ucGFuZWx7aGVpZ2h0OjEwMCV9LmZvb3Rlcnt3aWR0aDoxMDAlfS5pbmZve3BvaW50ZXItZXZlbnRzOm5vbmU7cGFkZGluZzoxcmVtIDAuNzVyZW19LnRleHR7Zm9udC1zaXplOnZhcigtLWNhbGNpdGUtZm9udC1zaXplLS0yKTtsaW5lLWhlaWdodDoxLjM3NTtjb2xvcjp2YXIoLS1jYWxjaXRlLXVpLXRleHQtMyk7dHJhbnNpdGlvbi1kdXJhdGlvbjoxNTBtczt0cmFuc2l0aW9uLXRpbWluZy1mdW5jdGlvbjpjdWJpYy1iZXppZXIoMC40LCAwLCAwLjIsIDEpO3BvaW50ZXItZXZlbnRzOm5vbmV9Lm5vdGljZXttYXJnaW46OHB4fVwiO1xuXG5jb25zdCBBcmNnaXNMYXllclZpZXdKb2luVGFyZ2V0U2VsZWN0aW9uID0gY2xhc3Mge1xuICBjb25zdHJ1Y3Rvcihob3N0UmVmKSB7XG4gICAgcmVnaXN0ZXJJbnN0YW5jZSh0aGlzLCBob3N0UmVmKTtcbiAgICB0aGlzLmFyY2dpc0xheWVyVmlld0pvaW5TdGF0dXNDaGFuZ2UgPSBjcmVhdGVFdmVudCh0aGlzLCBcImFyY2dpc0xheWVyVmlld0pvaW5TdGF0dXNDaGFuZ2VcIiwgNyk7XG4gICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICAvL1xuICAgIC8vICBQcml2YXRlIG1ldGhvZHNcbiAgICAvL1xuICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgdGhpcy5nb05leHQgPSAoKSA9PiB7XG4gICAgICB0aGlzLmFyY2dpc0xheWVyVmlld0pvaW5TdGF0dXNDaGFuZ2UuZW1pdCh7XG4gICAgICAgIHN0YXR1czogam9pbkZsb3dTdGF0dXMuQUREX1NFTEVDVElPTlxuICAgICAgfSk7XG4gICAgfTtcbiAgICB0aGlzLm9uU2VsZWN0aW9uQ2hhbmdlID0gKCkgPT4ge1xuICAgICAgY29uc3QgeyBwcm9wcyB9ID0gdGhpcztcbiAgICAgIGNvbnN0IHsgdGFyZ2V0TGF5ZXIgfSA9IHByb3BzO1xuICAgICAgdGhpcy5saXN0Tm9kZVxuICAgICAgICAucXVlcnlTZWxlY3RvckFsbChcImNhbGNpdGUtcGljay1saXN0LWl0ZW1cIilcbiAgICAgICAgLmZvckVhY2goKGl0ZW0pID0+IHtcbiAgICAgICAgaWYgKGl0ZW0uc2VsZWN0ZWQpIHtcbiAgICAgICAgICBwcm9wcy50YXJnZXRMYXllcklkID0gaXRlbS52YWx1ZTtcbiAgICAgICAgICBmb3JjZVVwZGF0ZSh0aGlzLmhvc3RFbGVtZW50KTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodGFyZ2V0TGF5ZXIudHlwZSA9PT0gXCJncm91cFwiKSB7XG4gICAgICAgICAgZ2V0TGF5ZXJzQW5kVGFibGVzKHRhcmdldExheWVyKS5maW5kKChzdWJMYXllcikgPT4gc3ViTGF5ZXIubGF5ZXJJZCA9PT0gaXRlbS52YWx1ZSkudmlzaWJsZSA9IGl0ZW0uc2VsZWN0ZWQ7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgdGFyZ2V0TGF5ZXIudmlzaWJsZSA9IGl0ZW0uc2VsZWN0ZWQ7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgICAgcHJvcHMuYXR0cmlidXRlUmVsYXRpb25zaGlwcyA9IHVuZGVmaW5lZDtcbiAgICAgIHByb3BzLmpvaW5PcGVyYXRpb24gPSB1bmRlZmluZWQ7XG4gICAgfTtcbiAgICB0aGlzLnByb3BzID0gdW5kZWZpbmVkO1xuICAgIHRoaXMuc3RhdHVzID0gdW5kZWZpbmVkO1xuICB9XG4gIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgLy9cbiAgLy8gIExpZmVjeWNsZVxuICAvL1xuICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIGFzeW5jIGNvbXBvbmVudFdpbGxMb2FkKCkge1xuICAgIGNvbnN0IHsgcHJvcHMgfSA9IHRoaXM7XG4gICAgY29uc3QgeyB0YXJnZXRMYXllciB9ID0gcHJvcHM7XG4gICAgaWYgKHRhcmdldExheWVyLnR5cGUgIT09IFwiZ3JvdXBcIikge1xuICAgICAgcHJvcHMudGFyZ2V0TGF5ZXJJZCA9IHRhcmdldExheWVyLmxheWVySWQ7XG4gICAgfVxuICB9XG4gIGFzeW5jIGNvbXBvbmVudERpZExvYWQoKSB7XG4gICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKCgpID0+IHsgdmFyIF9hOyByZXR1cm4gKF9hID0gdGhpcy5saXN0Tm9kZSkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLnNldEZvY3VzKCk7IH0pO1xuICB9XG4gIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIC8vXG4gIC8vICBSZW5kZXIgTWV0aG9kc1xuICAvL1xuICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIHJlbmRlcigpIHtcbiAgICAvL2NvbnNvbGUubG9nKFwicmVuZGVyIHRhcmdldC1zZWxlY3Rpb25cIiwgdGhpcy5wcm9wcywgXCJzdGF0dXM6XCIsIHRoaXMuc3RhdHVzKTtcbiAgICBjb25zdCB7IHByb3BzIH0gPSB0aGlzO1xuICAgIGNvbnN0IHsgdGFyZ2V0SXRlbSwgc3RyaW5ncyB9ID0gcHJvcHM7XG4gICAgY29uc3QgcnRsID0gZ2V0RWxlbWVudERpcih0aGlzLmhvc3RFbGVtZW50KSA9PT0gXCJydGxcIjtcbiAgICByZXR1cm4gKGgoSG9zdCwgeyBjbGFzczogXCJjYWxjaXRlLW1hdGNoLWhlaWdodFwiIH0sIGgoXCJjYWxjaXRlLWZsb3dcIiwgeyBjbGFzczogQ1NTJDMuZmxvdywgZGlyOiBnZXRFbGVtZW50RGlyKHRoaXMuaG9zdEVsZW1lbnQpIH0sIGgoXCJjYWxjaXRlLWZsb3ctaXRlbVwiLCB7IGhlYWRpbmc6IHRhcmdldEl0ZW0gPT09IG51bGwgfHwgdGFyZ2V0SXRlbSA9PT0gdm9pZCAwID8gdm9pZCAwIDogdGFyZ2V0SXRlbS50aXRsZSwgZGVzY3JpcHRpb246IHN0cmluZ3Muam9pbi50YXJnZXRMYXllciwgY2xhc3M6IHtcbiAgICAgICAgcGFuZWw6IHRydWUsXG4gICAgICAgIFtDU1NfVVRJTElUWS5ydGxdOiBydGxcbiAgICAgIH0sIHJlZjogKG5vZGUpID0+ICh0aGlzLmZsb3dJdGVtTm9kZSA9IG5vZGUpIH0sIHRoaXMucmVuZGVyRm9vdGVyQnV0dG9ucygpLCB0aGlzLnJlbmRlck9CQUNNc2coKSwgdGhpcy5yZW5kZXJJbmZvKCksIHRoaXMucmVuZGVyU3VibGF5ZXJzKCkpKSkpO1xuICB9XG4gIHJlbmRlckZvb3RlckJ1dHRvbnMoKSB7XG4gICAgY29uc3QgeyBwcm9wcyB9ID0gdGhpcztcbiAgICBjb25zdCB7IHRhcmdldEl0ZW0sIHRhcmdldExheWVyLCB0YXJnZXRMYXllcklkLCBzdHJpbmdzIH0gPSBwcm9wcztcbiAgICBjb25zdCBpc1J0bCA9IGdldEVsZW1lbnREaXIodGhpcy5ob3N0RWxlbWVudCkgPT09IFwicnRsXCI7XG4gICAgbGV0IHRhcmdldEZMO1xuICAgIGlmICh0YXJnZXRMYXllci50eXBlID09PSBcImdyb3VwXCIgJiYgaXNEZWZpbmVkKHRhcmdldExheWVySWQpKSB7XG4gICAgICB0YXJnZXRGTCA9IGdldExheWVyc0FuZFRhYmxlcyh0YXJnZXRMYXllcikuZmluZCgobHlyKSA9PiB0YXJnZXRMYXllcklkID09PSBseXIubGF5ZXJJZCk7XG4gICAgfVxuICAgIGVsc2UgaWYgKHRhcmdldExheWVyLnR5cGUgIT09IFwiZ3JvdXBcIikge1xuICAgICAgdGFyZ2V0RkwgPSB0YXJnZXRMYXllcjtcbiAgICB9XG4gICAgY29uc3QgbmV4dERpc2FibGVkID0gIWlzRGVmaW5lZCh0YXJnZXRMYXllcklkKSB8fCAodGFyZ2V0SXRlbS5wb3J0YWwuaXNQb3J0YWwgJiYgaGFzT0JBQyh0YXJnZXRGTCkpO1xuICAgIHJldHVybiAoaChcImRpdlwiLCB7IHNsb3Q6IFwiZm9vdGVyXCIsIGNsYXNzOiBDU1MkMy5mb290ZXIgfSwgaChcImNhbGNpdGUtYnV0dG9uXCIsIHsgZGlzYWJsZWQ6IG5leHREaXNhYmxlZCwgb25DbGljazogIW5leHREaXNhYmxlZCAmJiB0aGlzLmdvTmV4dCwgYXBwZWFyYW5jZTogXCJzb2xpZFwiLCB3aWR0aDogXCJmdWxsXCIsIGljb25FbmQ6IGlzUnRsID8gXCJhcnJvdy1sZWZ0XCIgOiBcImFycm93LXJpZ2h0XCIsIHJlZjogKG5vZGUpID0+ICh0aGlzLm5leHRCdXR0b25Ob2RlID0gbm9kZSkgfSwgc3RyaW5ncy5nZW5lcmFsLm5leHQpKSk7XG4gIH1cbiAgcmVuZGVyT0JBQ01zZygpIHtcbiAgICBjb25zdCB7IHByb3BzIH0gPSB0aGlzO1xuICAgIGNvbnN0IHsgY29uZmlnLCB0YXJnZXRJdGVtLCB0YXJnZXRMYXllcklkLCB0YXJnZXRMYXllciwgc3RyaW5ncyB9ID0gcHJvcHM7XG4gICAgY29uc3QgeyBoZWxwQmFzZSwgaGVscE1hcCB9ID0gY29uZmlnO1xuICAgIGlmICghdGFyZ2V0SXRlbS5wb3J0YWwuaXNQb3J0YWwpIHtcbiAgICAgIC8vIG1lc3NhZ2Ugb25seSBmb3IgRW50ZXJwcmlzZVxuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBsZXQgdGFyZ2V0Rkw7XG4gICAgaWYgKHRhcmdldExheWVyLnR5cGUgPT09IFwiZ3JvdXBcIiAmJiBpc0RlZmluZWQodGFyZ2V0TGF5ZXJJZCkpIHtcbiAgICAgIHRhcmdldEZMID0gZ2V0TGF5ZXJzQW5kVGFibGVzKHRhcmdldExheWVyKS5maW5kKChseXIpID0+IHRhcmdldExheWVySWQgPT09IGx5ci5sYXllcklkKTtcbiAgICB9XG4gICAgZWxzZSBpZiAodGFyZ2V0TGF5ZXIudHlwZSAhPT0gXCJncm91cFwiKSB7XG4gICAgICB0YXJnZXRGTCA9IHRhcmdldExheWVyO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgIC8vIG5vIGdyb3VwIHN1YmxheWVyIHNlbGVjdGVkIHlldFxuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAoIWhhc09CQUModGFyZ2V0RkwpKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHJldHVybiAoaChcImNhbGNpdGUtbm90aWNlXCIsIHsga2V5OiBgJHtoYXNPQkFDKHRhcmdldEZMKX1gLCBjbGFzczogXCJub3RpY2VcIiwgb3BlbjogdHJ1ZSwgY2xvc2FibGU6IGZhbHNlLCBzY2FsZTogXCJzXCIsIHdpZHRoOiBcImF1dG9cIiwga2luZDogXCJ3YXJuaW5nXCIsIGljb246IFwiZXhjbGFtYXRpb24tbWFyay10cmlhbmdsZVwiIH0sIGgoXCJkaXZcIiwgeyBzbG90OiBcIm1lc3NhZ2VcIiB9LCBzdHJpbmdzLmpvaW4ub2JhY05vdFN1cHBvcnRlZE1zZyksIGgoXCJjYWxjaXRlLWxpbmtcIiwgeyBzbG90OiBcImxpbmtcIiwgdGl0bGU6IHN0cmluZ3Muam9pbi5sZWFybk1vcmUsIHRhcmdldDogXCJfYmxhbmtcIiwgaHJlZjogYCR7aGVscEJhc2V9JHtoZWxwTWFwW1wiMTIwMDA0MTg0XCJdfWAgfSwgc3RyaW5ncy5qb2luLmxlYXJuTW9yZSkpKTtcbiAgfVxuICByZW5kZXJJbmZvKCkge1xuICAgIGNvbnN0IHsgcHJvcHMgfSA9IHRoaXM7XG4gICAgY29uc3QgeyBzdHJpbmdzIH0gPSBwcm9wcztcbiAgICByZXR1cm4gKGgoXCJkaXZcIiwgeyBjbGFzczogQ1NTJDMuaW5mbyB9LCBoKFwiZGl2XCIsIHsgY2xhc3M6IENTUyQzLnRleHQgfSwgc3RyaW5ncy5qb2luLnNlbGVjdFRhcmdldExheWVyUGFuZWxEZXNjcmlwdGlvbikpKTtcbiAgfVxuICByZW5kZXJTdWJsYXllcnMoKSB7XG4gICAgdmFyIF9hLCBfYjtcbiAgICBjb25zdCB7IHByb3BzIH0gPSB0aGlzO1xuICAgIGNvbnN0IHsgdGFyZ2V0TGF5ZXIgfSA9IHByb3BzO1xuICAgIGNvbnN0IGxpc3RJdGVtcyA9IFtdO1xuICAgIGlmICh0YXJnZXRMYXllci50eXBlID09PSBcImdyb3VwXCIpIHtcbiAgICAgIChfYSA9IHRhcmdldExheWVyLnRhYmxlcykgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmZvckVhY2goKGx5cikgPT4ge1xuICAgICAgICBsaXN0SXRlbXMudW5zaGlmdCh0aGlzLnJlbmRlclN1YmxheWVyKGx5cikpO1xuICAgICAgfSk7XG4gICAgICAoX2IgPSB0YXJnZXRMYXllci5sYXllcnMpID09PSBudWxsIHx8IF9iID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYi5mb3JFYWNoKChseXIpID0+IHtcbiAgICAgICAgbGlzdEl0ZW1zLnVuc2hpZnQodGhpcy5yZW5kZXJTdWJsYXllcihseXIpKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgIGxpc3RJdGVtcy5wdXNoKHRoaXMucmVuZGVyU3VibGF5ZXIodGFyZ2V0TGF5ZXIpKTtcbiAgICB9XG4gICAgcmV0dXJuIChoKFwiY2FsY2l0ZS1waWNrLWxpc3RcIiwgeyBtdWx0aXBsZTogZmFsc2UsIG9uQ2FsY2l0ZUxpc3RDaGFuZ2U6IHRoaXMub25TZWxlY3Rpb25DaGFuZ2UsIHJlZjogKG5vZGUpID0+ICh0aGlzLmxpc3ROb2RlID0gbm9kZSkgfSwgbGlzdEl0ZW1zKSk7XG4gIH1cbiAgcmVuZGVyU3VibGF5ZXIobHlyKSB7XG4gICAgY29uc3QgeyBwcm9wcyB9ID0gdGhpcztcbiAgICBjb25zdCB7IHRhcmdldExheWVySWQgfSA9IHByb3BzO1xuICAgIHJldHVybiAoaChcImNhbGNpdGUtcGljay1saXN0LWl0ZW1cIiwgeyBrZXk6IGx5ci5sYXllcklkLCBsYWJlbDogbHlyLnRpdGxlLCB2YWx1ZTogbHlyLmxheWVySWQsIGRlc2NyaXB0aW9uOiBnZXRMYXllclR5cGUobHlyLCBwcm9wcyksIHNlbGVjdGVkOiB0YXJnZXRMYXllcklkID09PSBseXIubGF5ZXJJZCB9KSk7XG4gIH1cbiAgZ2V0IGhvc3RFbGVtZW50KCkgeyByZXR1cm4gZ2V0RWxlbWVudCh0aGlzKTsgfVxufTtcbkFyY2dpc0xheWVyVmlld0pvaW5UYXJnZXRTZWxlY3Rpb24uc3R5bGUgPSBhcmNnaXNMYXllclZpZXdKb2luVGFyZ2V0U2VsZWN0aW9uQ3NzO1xuXG5jb25zdCBBcmNnaXNMYXllclZpZXdDcmVhdGUgPSBjbGFzcyB7XG4gIGNvbnN0cnVjdG9yKGhvc3RSZWYpIHtcbiAgICByZWdpc3Rlckluc3RhbmNlKHRoaXMsIGhvc3RSZWYpO1xuICAgIHRoaXMuYXJjZ2lzTGF5ZXJWaWV3TXNnQ2xvc2VkID0gY3JlYXRlRXZlbnQodGhpcywgXCJhcmNnaXNMYXllclZpZXdNc2dDbG9zZWRcIiwgNyk7XG4gICAgdGhpcy5wcm9wcyA9IHVuZGVmaW5lZDtcbiAgICB0aGlzLmZsb3dJdGVtRWxlbWVudCA9IHVuZGVmaW5lZDtcbiAgICB0aGlzLmlzRXJyb3IgPSBmYWxzZTtcbiAgICB0aGlzLmlzV2FybmluZyA9IGZhbHNlO1xuICAgIHRoaXMubWVzc2FnZSA9IHVuZGVmaW5lZDtcbiAgICB0aGlzLmNsb3NlV2l0aE9LID0gdW5kZWZpbmVkO1xuICB9XG4gIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgLy9cbiAgLy8gIExpZmVjeWNsZVxuICAvL1xuICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIGFzeW5jIGNvbXBvbmVudERpZExvYWQoKSB7XG4gICAgaWYgKHRoaXMuZmxvd0l0ZW1FbGVtZW50KSB7XG4gICAgICB0aGlzLmZsb3dJdGVtRWxlbWVudC5kaXNhYmxlZCA9IHRydWU7XG4gICAgfVxuICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZSgoKSA9PiB7IHZhciBfYTsgcmV0dXJuIChfYSA9IHRoaXMub2tOb2RlKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2Euc2V0Rm9jdXMoKTsgfSk7XG4gIH1cbiAgZGlzY29ubmVjdGVkQ2FsbGJhY2soKSB7XG4gICAgaWYgKHRoaXMuZmxvd0l0ZW1FbGVtZW50KSB7XG4gICAgICB0aGlzLmZsb3dJdGVtRWxlbWVudC5kaXNhYmxlZCA9IGZhbHNlO1xuICAgIH1cbiAgfVxuICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAvL1xuICAvLyAgUmVuZGVyIE1ldGhvZHNcbiAgLy9cbiAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICByZW5kZXIoKSB7XG4gICAgY29uc3QgeyBwcm9wcywgaG9zdEVsZW1lbnQsIGZsb3dJdGVtRWxlbWVudCwgaXNFcnJvciwgaXNXYXJuaW5nLCBtZXNzYWdlLCBjbG9zZVdpdGhPSyB9ID0gdGhpcztcbiAgICBjb25zdCB7IHN0cmluZ3MgfSA9IHByb3BzO1xuICAgIGNvbnN0IGRpciA9IGdldEVsZW1lbnREaXIoaG9zdEVsZW1lbnQpO1xuICAgIGNvbnN0IHBhbmVsV2lkdGggPSBNYXRoLnJvdW5kKGZsb3dJdGVtRWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKS53aWR0aCk7XG4gICAgcmV0dXJuIChoKEhvc3QsIHsgY2xhc3M6IFwianMtYXBwLWZseW91dFwiIH0sIGgoXCJjYWxjaXRlLXBvcG92ZXJcIiwgeyBkaXI6IGRpciwgcGxhY2VtZW50OiBcInRyYWlsaW5nLXN0YXJ0XCIsIG9wZW46IHRydWUsIHBvaW50ZXJEaXNhYmxlZDogdHJ1ZSwgcmVmZXJlbmNlRWxlbWVudDogZmxvd0l0ZW1FbGVtZW50LCBvZmZzZXREaXN0YW5jZTogLTEgKiAocGFuZWxXaWR0aCAtIDEwKSwgb2Zmc2V0U2tpZGRpbmc6IDIwMCwgbGFiZWw6IG1lc3NhZ2UsIHN0eWxlOiB7XG4gICAgICAgIHpJbmRleDogXCIxMDBcIixcbiAgICAgICAgd2lkdGg6IGAke3BhbmVsV2lkdGggLSAyMH1weGBcbiAgICAgIH0gfSwgaChcImNhbGNpdGUtbm90aWNlXCIsIHsgc2NhbGU6IFwic1wiLCB3aWR0aDogXCJmdWxsXCIsIG9wZW46IHRydWUsIGNsb3NhYmxlOiAhY2xvc2VXaXRoT0ssIGljb246IGlzRXJyb3IgfHwgaXNXYXJuaW5nID8gXCJleGNsYW1hdGlvbi1tYXJrLXRyaWFuZ2xlXCIgOiBcImNoZWNrLWNpcmNsZVwiLCBraW5kOiBpc0Vycm9yID8gXCJkYW5nZXJcIiA6IGlzV2FybmluZyA/IFwid2FybmluZ1wiIDogXCJzdWNjZXNzXCIsIG9uQ2FsY2l0ZU5vdGljZUNsb3NlOiAoKSA9PiB7XG4gICAgICAgIHRoaXMuYXJjZ2lzTGF5ZXJWaWV3TXNnQ2xvc2VkLmVtaXQoKTtcbiAgICAgIH0gfSwgaChcImRpdlwiLCB7IHNsb3Q6IFwidGl0bGVcIiB9LCBpc0Vycm9yID8gc3RyaW5ncy5tc2cuZXJyb3IgOiBpc1dhcm5pbmcgPyBzdHJpbmdzLm1zZy53YXJuaW5nIDogc3RyaW5ncy5tc2cuc3VjY2VzcyksIGgoXCJkaXZcIiwgeyBzbG90OiBcIm1lc3NhZ2VcIiwgcmVmOiAobm9kZSkgPT4ge1xuICAgICAgICAvLyBtdXN0IHVzZSBkaXYgYW5kIHJlZiwgb3RoZXJ3aXNlIDxiPiBpbnNpZGUgdGhlIHN0cmluZyBkb2Vzbid0IHdvcmtcbiAgICAgICAgbm9kZS5pbm5lckhUTUwgPSBtZXNzYWdlO1xuICAgICAgfSB9KSwgY2xvc2VXaXRoT0sgJiYgKGgoXCJjYWxjaXRlLWJ1dHRvblwiLCB7IGFwcGVhcmFuY2U6IFwidHJhbnNwYXJlbnRcIiwgc2xvdDogXCJhY3Rpb25zLWVuZFwiLCBvbkNsaWNrOiAoKSA9PiB7XG4gICAgICAgIHRoaXMuYXJjZ2lzTGF5ZXJWaWV3TXNnQ2xvc2VkLmVtaXQoKTtcbiAgICAgIH0sIHJlZjogKG5vZGUpID0+ICh0aGlzLm9rTm9kZSA9IG5vZGUpIH0sIHN0cmluZ3MubXNnLm9rKSkpKSkpO1xuICB9XG4gIGdldCBob3N0RWxlbWVudCgpIHsgcmV0dXJuIGdldEVsZW1lbnQodGhpcyk7IH1cbn07XG5cbmNvbnN0IENTUyQyID0ge1xuICBmbG93OiBcImZsb3dcIixcbiAgcGFuZWw6IFwicGFuZWxcIixcbiAgaW5mbzogXCJpbmZvXCIsXG4gIGluZm9EZXNjcmlwdGlvbjogXCJpbmZvLWRlc2NyaXB0aW9uXCIsXG4gIGhhc0RlZmluaXRpb25JY29uOiBcImhhcy1kZWZpbml0aW9uLWljb25cIixcbiAgZGVmaW5pdGlvbkljb246IFwiZGVmaW5pdGlvbi1pY29uXCIsXG4gIGZvb3RlcjogXCJmb290ZXJcIixcbiAgZm9vdGVyVG9wOiBcImZvb3Rlci10b3BcIlxufTtcblxuY29uc3QgYXJjZ2lzTGF5ZXJWaWV3T3ZlcnZpZXdDc3MgPSBcIi5mbG93LnNjLWFyY2dpcy1sYXllci12aWV3LW92ZXJ2aWV3e2hlaWdodDoxMDAlfS5wYW5lbC5zYy1hcmNnaXMtbGF5ZXItdmlldy1vdmVydmlld3toZWlnaHQ6MTAwJX0uaW5mby5zYy1hcmNnaXMtbGF5ZXItdmlldy1vdmVydmlld3tkaXNwbGF5OmdyaWQ7Z3JpZC10ZW1wbGF0ZS1jb2x1bW5zOnJlcGVhdCgxLCBtaW5tYXgoMHB4LCAxZnIpKTtnYXA6MC41cmVtO3BvaW50ZXItZXZlbnRzOm5vbmU7cGFkZGluZzoxcmVtIDAuNzVyZW19LmluZm8tZGVzY3JpcHRpb24uc2MtYXJjZ2lzLWxheWVyLXZpZXctb3ZlcnZpZXd7Zm9udC1zaXplOnZhcigtLWNhbGNpdGUtZm9udC1zaXplLS0yKTtsaW5lLWhlaWdodDoxLjM3NTtjb2xvcjp2YXIoLS1jYWxjaXRlLXVpLXRleHQtMyk7dHJhbnNpdGlvbi1kdXJhdGlvbjoxNTBtczt0cmFuc2l0aW9uLXRpbWluZy1mdW5jdGlvbjpjdWJpYy1iZXppZXIoMC40LCAwLCAwLjIsIDEpO3BvaW50ZXItZXZlbnRzOm5vbmV9Lmhhcy1kZWZpbml0aW9uLWljb24uc2MtYXJjZ2lzLWxheWVyLXZpZXctb3ZlcnZpZXd7Y29sb3I6dmFyKC0tY2FsY2l0ZS11aS1ib3JkZXItMSk7Y3Vyc29yOnBvaW50ZXJ9LmRlZmluaXRpb24taWNvbi5zYy1hcmNnaXMtbGF5ZXItdmlldy1vdmVydmlld3tjb2xvcjp2YXIoLS1jYWxjaXRlLXVpLXRleHQtMik7Y3Vyc29yOnBvaW50ZXJ9LmZvb3Rlci5zYy1hcmNnaXMtbGF5ZXItdmlldy1vdmVydmlld3t3aWR0aDoxMDAlfS5mb290ZXItdG9wLnNjLWFyY2dpcy1sYXllci12aWV3LW92ZXJ2aWV3e2Rpc3BsYXk6ZmxleH1cIjtcblxuY29uc3QgQXJjZ2lzTGF5ZXJWaWV3T3ZlcnZpZXcgPSBjbGFzcyB7XG4gIGNvbnN0cnVjdG9yKGhvc3RSZWYpIHtcbiAgICByZWdpc3Rlckluc3RhbmNlKHRoaXMsIGhvc3RSZWYpO1xuICAgIHRoaXMuYXJjZ2lzTGF5ZXJWaWV3U3RhdHVzQ2hhbmdlID0gY3JlYXRlRXZlbnQodGhpcywgXCJhcmNnaXNMYXllclZpZXdTdGF0dXNDaGFuZ2VcIiwgNyk7XG4gICAgdGhpcy5hcmNnaXNMYXllclZpZXdPdmVydmlld1VwZGF0ZWQgPSBjcmVhdGVFdmVudCh0aGlzLCBcImFyY2dpc0xheWVyVmlld092ZXJ2aWV3VXBkYXRlZFwiLCA3KTtcbiAgICB0aGlzLmFyY2dpc0xheWVyVmlld092ZXJ2aWV3Q2FuY2VsID0gY3JlYXRlRXZlbnQodGhpcywgXCJhcmNnaXNMYXllclZpZXdPdmVydmlld0NhbmNlbFwiLCA3KTtcbiAgICB0aGlzLmxpc3RJdGVtTm9kZXMgPSBbXTtcbiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAgIC8vXG4gICAgLy8gIFByaXZhdGUgbWV0aG9kc1xuICAgIC8vXG4gICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICB0aGlzLmdvQmFjayA9ICgpID0+IHtcbiAgICAgIHRoaXMuYXJjZ2lzTGF5ZXJWaWV3U3RhdHVzQ2hhbmdlLmVtaXQoeyBzdGF0dXM6IGZsb3dTdGF0dXMuU0VMRUNUSU9OIH0pO1xuICAgIH07XG4gICAgdGhpcy5nb05leHQgPSAoKSA9PiB7XG4gICAgICB0aGlzLmFyY2dpc0xheWVyVmlld1N0YXR1c0NoYW5nZS5lbWl0KHsgc3RhdHVzOiBmbG93U3RhdHVzLkNSRUFURSB9KTtcbiAgICB9O1xuICAgIHRoaXMuZ29VcGRhdGUgPSBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCB7IHByb3BzLCBob3N0RWxlbWVudCB9ID0gdGhpcztcbiAgICAgIGNvbnN0IHsgc3RyaW5ncyB9ID0gcHJvcHM7XG4gICAgICBjb25zdCBzaG93U3VjY2Vzc01zZyA9ICgpID0+IHtcbiAgICAgICAgdGhpcy5tc2dOb2RlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImFyY2dpcy1sYXllci12aWV3LW1zZ1wiKTtcbiAgICAgICAgdGhpcy5tc2dOb2RlLnByb3BzID0gcHJvcHM7XG4gICAgICAgIHRoaXMubXNnTm9kZS5mbG93SXRlbUVsZW1lbnQgPSB0aGlzLmZsb3dJdGVtTm9kZTtcbiAgICAgICAgdGhpcy5tc2dOb2RlLm1lc3NhZ2UgPSBzdHJpbmdzLm1zZy51cGRhdGVkO1xuICAgICAgICBob3N0RWxlbWVudC5hcHBlbmRDaGlsZCh0aGlzLm1zZ05vZGUpO1xuICAgICAgICBjbGVhclRpbWVvdXQodGhpcy50aW1lb3V0SG5kbCk7XG4gICAgICAgIHRoaXMudGltZW91dEhuZGwgPSBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICB0aGlzLnRpbWVvdXRIbmRsID0gdW5kZWZpbmVkO1xuICAgICAgICAgIGlmICh0aGlzLm1zZ05vZGUpIHtcbiAgICAgICAgICAgIGhvc3RFbGVtZW50LnJlbW92ZUNoaWxkKHRoaXMubXNnTm9kZSk7XG4gICAgICAgICAgICB0aGlzLm1zZ05vZGUgPSB1bmRlZmluZWQ7XG4gICAgICAgICAgICB0aGlzLmFyY2dpc0xheWVyVmlld092ZXJ2aWV3VXBkYXRlZC5lbWl0KCk7XG4gICAgICAgICAgfVxuICAgICAgICB9LCA3MDAwKTtcbiAgICAgIH07XG4gICAgICBjb25zdCBoYXNBbnlDaGFuZ2VzID0gaGFzQ2hhbmdlcyhwcm9wcyk7XG4gICAgICBpZiAoIWhhc0FueUNoYW5nZXMpIHtcbiAgICAgICAgc2hvd1N1Y2Nlc3NNc2coKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgdGhpcy5sb2FkaW5nID0gdHJ1ZTtcbiAgICAgIHRyeSB7XG4gICAgICAgIC8vIHVwZGF0ZSB2aWV3XG4gICAgICAgIGF3YWl0IHVwZGF0ZVZpZXcodGhpcy5wcm9wcyk7XG4gICAgICAgIC8vIG1heC1hZ2UgY2FjaGUgaXMgMzAgc2VjOyBtaWdodCBub3QgZ2V0IHRoZSBsYXRlc3RcbiAgICAgICAgYXdhaXQgdGhpcy5nZXRMYXRlc3RBZG1pblNlcnZpY2VJbmZvKCk7XG4gICAgICAgIGlmIChoYXNDaGFuZ2VzKHRoaXMucHJvcHMpKSB7XG4gICAgICAgICAgLy8gd2FpdCB1cCB0byAzMCBzZWMgd2l0aCBpbmNyZWFzaW5nIGludGVydmFsXG4gICAgICAgICAgLy8gYW5kIG1ha2Ugb3RoZXIgYWRtaW5TZXJ2aWNlSW5mbyByZXF1ZXN0c1xuICAgICAgICAgIC8vIHVudGlsIHdlIHJlYWxseSBoYXZlIHRoZSBsYXRlc3RcbiAgICAgICAgICBsZXQgd2FpdFRpbWUgPSAxMDAwO1xuICAgICAgICAgIGNvbnN0IHRyeUFnYWluID0gYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgdmFyIF9hLCBfYjtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuZ2V0TGF0ZXN0QWRtaW5TZXJ2aWNlSW5mbygpO1xuICAgICAgICAgICAgaWYgKCFoYXNDaGFuZ2VzKHRoaXMucHJvcHMpIHx8IHdhaXRUaW1lID4gMzAwMDApIHtcbiAgICAgICAgICAgICAgLy8gbmVlZCB0byBnZXQgbGF0ZXN0IHNhdmVkIEFPSSBiZWNhdXNlIGl0IHJvdW5kcyBjb29yZGluYXRlcyB3aGVuIHNhdmluZ1xuICAgICAgICAgICAgICAoX2IgPSAoX2EgPSB0aGlzLnByb3BzLmFkbWluU2VydmljZUluZm8pID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5sYXllcnMpID09PSBudWxsIHx8IF9iID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYi5mb3JFYWNoKGFzeW5jIChsYXllckluZm8pID0+IHtcbiAgICAgICAgICAgICAgICB2YXIgX2EsIF9iLCBfYywgX2Q7XG4gICAgICAgICAgICAgICAgY29uc3QgYW9pVmFsdWUgPSAoX2QgPSAoX2MgPSAoX2IgPSAoX2EgPSBsYXllckluZm8uYWRtaW5MYXllckluZm8pID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS52aWV3TGF5ZXJEZWZpbml0aW9uKSA9PT0gbnVsbCB8fCBfYiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2IudGFibGUpID09PSBudWxsIHx8IF9jID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYy5maWx0ZXIpID09PSBudWxsIHx8IF9kID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfZC52YWx1ZTtcbiAgICAgICAgICAgICAgICBpZiAoYW9pVmFsdWUpIHtcbiAgICAgICAgICAgICAgICAgIGFkZFZpZXdMYXllclByb3BzKGxheWVySW5mby5pZCwge1xuICAgICAgICAgICAgICAgICAgICBhb2k6IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkoYW9pVmFsdWUuZ2VvbWV0cnkpKVxuICAgICAgICAgICAgICAgICAgfSwgdGhpcy5wcm9wcyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICB3YWl0VGltZSAqPSAyO1xuICAgICAgICAgICAgICBzZXRUaW1lb3V0KHRyeUFnYWluLCB3YWl0VGltZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfTtcbiAgICAgICAgICBzZXRUaW1lb3V0KHRyeUFnYWluLCB3YWl0VGltZSk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5sb2FkaW5nID0gZmFsc2U7XG4gICAgICAgIHNob3dTdWNjZXNzTXNnKCk7XG4gICAgICB9XG4gICAgICBjYXRjaCAoZSkge1xuICAgICAgICBjb25zdCB7IHN0cmluZ3MgfSA9IHByb3BzO1xuICAgICAgICB0aGlzLmxvYWRpbmcgPSBmYWxzZTtcbiAgICAgICAgY29uc29sZS5lcnJvcihcImNvdWxkIG5vdCBjcmVhdGUgdmlld1wiLCBlKTtcbiAgICAgICAgdGhpcy5tc2dOb2RlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImFyY2dpcy1sYXllci12aWV3LW1zZ1wiKTtcbiAgICAgICAgdGhpcy5tc2dOb2RlLnByb3BzID0gcHJvcHM7XG4gICAgICAgIHRoaXMubXNnTm9kZS5mbG93SXRlbUVsZW1lbnQgPSB0aGlzLmZsb3dJdGVtTm9kZTtcbiAgICAgICAgdGhpcy5tc2dOb2RlLmlzRXJyb3IgPSB0cnVlO1xuICAgICAgICB0aGlzLm1zZ05vZGUubWVzc2FnZSA9IHN0cmluZ3MubXNnLnVwZGF0ZUZhaWxlZDtcbiAgICAgICAgaG9zdEVsZW1lbnQuYXBwZW5kQ2hpbGQodGhpcy5tc2dOb2RlKTtcbiAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMudGltZW91dEhuZGwpO1xuICAgICAgICB0aGlzLnRpbWVvdXRIbmRsID0gc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgdGhpcy50aW1lb3V0SG5kbCA9IHVuZGVmaW5lZDtcbiAgICAgICAgICBpZiAodGhpcy5tc2dOb2RlKSB7XG4gICAgICAgICAgICBob3N0RWxlbWVudC5yZW1vdmVDaGlsZCh0aGlzLm1zZ05vZGUpO1xuICAgICAgICAgICAgdGhpcy5tc2dOb2RlID0gdW5kZWZpbmVkO1xuICAgICAgICAgIH1cbiAgICAgICAgfSwgNzAwMCk7XG4gICAgICB9XG4gICAgfTtcbiAgICB0aGlzLmdvQ2FuY2VsID0gKCkgPT4ge1xuICAgICAgdGhpcy5hcmNnaXNMYXllclZpZXdPdmVydmlld0NhbmNlbC5lbWl0KCk7XG4gICAgfTtcbiAgICB0aGlzLnByb3BzID0gdW5kZWZpbmVkO1xuICAgIHRoaXMuc3RhdHVzID0gdW5kZWZpbmVkO1xuICAgIHRoaXMucmVSZW5kZXIgPSBmYWxzZTtcbiAgICB0aGlzLmxvYWRpbmcgPSBmYWxzZTtcbiAgfVxuICBhcmNnaXNMYXllclZpZXdPdmVydmlld1JlZnJlc2hIYW5kbGVyKCkge1xuICAgIHRoaXMuc3RhdHVzID0gZmxvd1N0YXR1cy5PVkVSVklFVztcbiAgICB0aGlzLnJlUmVuZGVyID0gIXRoaXMucmVSZW5kZXI7XG4gIH1cbiAgYXJjZ2lzTGF5ZXJWaWV3TXNnQ2xvc2VkSGFuZGxlcigpIHtcbiAgICBjb25zdCB7IHByb3BzIH0gPSB0aGlzO1xuICAgIGNvbnN0IHsgc3RyaW5ncyB9ID0gcHJvcHM7XG4gICAgaWYgKHRoaXMubXNnTm9kZSkge1xuICAgICAgaWYgKHRoaXMubXNnTm9kZS5tZXNzYWdlID09PSBzdHJpbmdzLm1zZy51cGRhdGVkKSB7XG4gICAgICAgIHRoaXMuYXJjZ2lzTGF5ZXJWaWV3T3ZlcnZpZXdVcGRhdGVkLmVtaXQoKTtcbiAgICAgIH1cbiAgICAgIHRoaXMuaG9zdEVsZW1lbnQucmVtb3ZlQ2hpbGQodGhpcy5tc2dOb2RlKTtcbiAgICAgIHRoaXMubXNnTm9kZSA9IHVuZGVmaW5lZDtcbiAgICB9XG4gICAgY2xlYXJUaW1lb3V0KHRoaXMudGltZW91dEhuZGwpO1xuICAgIHRoaXMudGltZW91dEhuZGwgPSB1bmRlZmluZWQ7XG4gIH1cbiAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAvL1xuICAvLyAgTGlmZWN5Y2xlXG4gIC8vXG4gIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgYXN5bmMgY29tcG9uZW50V2lsbExvYWQoKSB7IH1cbiAgYXN5bmMgY29tcG9uZW50RGlkTG9hZCgpIHtcbiAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKCkgPT4geyB2YXIgX2E7IHJldHVybiAoX2EgPSB0aGlzLmJhY2tCdXR0b25Ob2RlKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2Euc2V0Rm9jdXMoKTsgfSk7XG4gIH1cbiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgLy9cbiAgLy8gIFJlbmRlciBNZXRob2RzXG4gIC8vXG4gIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgcmVuZGVyKCkge1xuICAgIC8vY29uc29sZS5sb2coXCJyZW5kZXIgdmlldy1vdmVydmlld1wiLCBwcm9wc1RvU3RyaW5nKHRoaXMucHJvcHMpKTtcbiAgICBjb25zdCB7IHByb3BzLCBzdGF0dXMsIGxvYWRpbmcgfSA9IHRoaXM7XG4gICAgY29uc3QgeyB2aWV3SXRlbSwgbGF5ZXJJdGVtLCBzdHJpbmdzIH0gPSBwcm9wcztcbiAgICBjb25zdCBydGwgPSBnZXRFbGVtZW50RGlyKHRoaXMuaG9zdEVsZW1lbnQpID09PSBcInJ0bFwiO1xuICAgIHJldHVybiAoaChIb3N0LCB7IGNsYXNzOiBcImNhbGNpdGUtbWF0Y2gtaGVpZ2h0XCIgfSwgaChcImNhbGNpdGUtZmxvd1wiLCB7IGNsYXNzOiBDU1MkMi5mbG93LCBkaXI6IGdldEVsZW1lbnREaXIodGhpcy5ob3N0RWxlbWVudCkgfSwgaChcImNhbGNpdGUtZmxvdy1pdGVtXCIsIHsga2V5OiBzdGF0dXMsIGhlYWRpbmc6IHN0cmluZ3MuZ2VuZXJhbC5pbmNsdWRlZExheWVyUGFuZWxUaXRsZSwgZGVzY3JpcHRpb246ICh2aWV3SXRlbSA9PT0gbnVsbCB8fCB2aWV3SXRlbSA9PT0gdm9pZCAwID8gdm9pZCAwIDogdmlld0l0ZW0udGl0bGUpIHx8IChsYXllckl0ZW0gPT09IG51bGwgfHwgbGF5ZXJJdGVtID09PSB2b2lkIDAgPyB2b2lkIDAgOiBsYXllckl0ZW0udGl0bGUpLCBsb2FkaW5nOiBsb2FkaW5nLCBjbGFzczoge1xuICAgICAgICBwYW5lbDogdHJ1ZSxcbiAgICAgICAgW0NTU19VVElMSVRZLnJ0bF06IHJ0bFxuICAgICAgfSwgcmVmOiAobm9kZSkgPT4gKHRoaXMuZmxvd0l0ZW1Ob2RlID0gbm9kZSkgfSwgdGhpcy5yZW5kZXJGb290ZXJCdXR0b25zKCksIHRoaXMucmVuZGVySW5mbygpLCB0aGlzLnJlbmRlclN1YmxheWVycygpKSwgW2Zsb3dTdGF0dXMuREVGSU5JVElPTiwgZmxvd1N0YXR1cy5GSUxURVJdLmluY2x1ZGVzKHN0YXR1cylcbiAgICAgID8gdGhpcy5yZW5kZXJMYXllckRlZmluaXRpb24oKVxuICAgICAgOiBudWxsKSkpO1xuICB9XG4gIHJlbmRlckZvb3RlckJ1dHRvbnMoKSB7XG4gICAgY29uc3QgeyBwcm9wcyB9ID0gdGhpcztcbiAgICBjb25zdCB7IHZpZXdJdGVtIH0gPSBwcm9wcztcbiAgICByZXR1cm4gKGgoXCJkaXZcIiwgeyBzbG90OiBcImZvb3RlclwiLCBjbGFzczogQ1NTJDIuZm9vdGVyIH0sIGgoXCJkaXZcIiwgeyBjbGFzczogQ1NTJDIuZm9vdGVyVG9wIH0sIHRoaXMucmVuZGVyQmFjaygpLCB2aWV3SXRlbSA/IHRoaXMucmVuZGVyVXBkYXRlKCkgOiB0aGlzLnJlbmRlck5leHQoKSksIHZpZXdJdGVtID8gdGhpcy5yZW5kZXJDYW5jZWwoKSA6IG51bGwpKTtcbiAgfVxuICByZW5kZXJCYWNrKCkge1xuICAgIGNvbnN0IHsgcHJvcHMgfSA9IHRoaXM7XG4gICAgY29uc3QgeyBzdHJpbmdzIH0gPSBwcm9wcztcbiAgICBjb25zdCBpc1J0bCA9IGdldEVsZW1lbnREaXIodGhpcy5ob3N0RWxlbWVudCkgPT09IFwicnRsXCI7XG4gICAgcmV0dXJuIChoKFwiY2FsY2l0ZS1idXR0b25cIiwgeyBzbG90OiBcImZvb3RlclwiLCBvbkNsaWNrOiB0aGlzLmdvQmFjaywgYXBwZWFyYW5jZTogXCJvdXRsaW5lLWZpbGxcIiwgd2lkdGg6IFwiaGFsZlwiLCBcImljb24tc3RhcnRcIjogaXNSdGwgPyBcImFycm93LXJpZ2h0XCIgOiBcImFycm93LWxlZnRcIiwgcmVmOiAobm9kZSkgPT4gKHRoaXMuYmFja0J1dHRvbk5vZGUgPSBub2RlKSB9LCBzdHJpbmdzLmdlbmVyYWwuYmFjaykpO1xuICB9XG4gIHJlbmRlck5leHQoKSB7XG4gICAgY29uc3QgeyBwcm9wcyB9ID0gdGhpcztcbiAgICBjb25zdCB7IHN0cmluZ3MgfSA9IHByb3BzO1xuICAgIGNvbnN0IGlzUnRsID0gZ2V0RWxlbWVudERpcih0aGlzLmhvc3RFbGVtZW50KSA9PT0gXCJydGxcIjtcbiAgICByZXR1cm4gKGgoXCJjYWxjaXRlLWJ1dHRvblwiLCB7IHNsb3Q6IFwiZm9vdGVyXCIsIG9uQ2xpY2s6IHRoaXMuZ29OZXh0LCBhcHBlYXJhbmNlOiBcInNvbGlkXCIsIHdpZHRoOiBcImhhbGZcIiwgaWNvbkVuZDogaXNSdGwgPyBcImFycm93LWxlZnRcIiA6IFwiYXJyb3ctcmlnaHRcIiwgcmVmOiAobm9kZSkgPT4gKHRoaXMubmV4dEJ1dHRvbk5vZGUgPSBub2RlKSB9LCBzdHJpbmdzLmdlbmVyYWwubmV4dCkpO1xuICB9XG4gIHJlbmRlclVwZGF0ZSgpIHtcbiAgICBjb25zdCB7IHByb3BzIH0gPSB0aGlzO1xuICAgIGNvbnN0IHsgc3RyaW5ncyB9ID0gcHJvcHM7XG4gICAgcmV0dXJuIChoKFwiY2FsY2l0ZS1idXR0b25cIiwgeyBzbG90OiBcImZvb3RlclwiLCBvbkNsaWNrOiB0aGlzLmdvVXBkYXRlLCBhcHBlYXJhbmNlOiBcInNvbGlkXCIsIHdpZHRoOiBcImhhbGZcIiwgXCJpY29uLXN0YXJ0XCI6IFwicGx1cy1zcXVhcmVcIiwgcmVmOiAobm9kZSkgPT4gKHRoaXMubmV4dEJ1dHRvbk5vZGUgPSBub2RlKSB9LCBzdHJpbmdzLmdlbmVyYWwudXBkYXRlKSk7XG4gIH1cbiAgcmVuZGVyQ2FuY2VsKCkge1xuICAgIGNvbnN0IHsgcHJvcHMgfSA9IHRoaXM7XG4gICAgY29uc3QgeyBsYXllciwgbGF5ZXJJZHMsIHN0cmluZ3MgfSA9IHByb3BzO1xuICAgIGNvbnN0IGVuYWJsZWQgPSAobGF5ZXIgPT09IG51bGwgfHwgbGF5ZXIgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGxheWVyLmxvYWRlZCkgJiYgbGF5ZXJJZHMubGVuZ3RoO1xuICAgIHJldHVybiAoaChcImNhbGNpdGUtYnV0dG9uXCIsIHsgZGlzYWJsZWQ6ICFlbmFibGVkLCBvbkNsaWNrOiBlbmFibGVkICYmIHRoaXMuZ29DYW5jZWwsIGFwcGVhcmFuY2U6IFwidHJhbnNwYXJlbnRcIiwgd2lkdGg6IFwiZnVsbFwiIH0sIHN0cmluZ3MuZ2VuZXJhbC5jbG9zZSkpO1xuICB9XG4gIHJlbmRlckluZm8oKSB7XG4gICAgY29uc3QgeyBwcm9wcyB9ID0gdGhpcztcbiAgICBjb25zdCB7IHN0cmluZ3MgfSA9IHByb3BzO1xuICAgIHJldHVybiAoaChcImRpdlwiLCB7IGNsYXNzOiBcImluZm9cIiB9LCBoKFwiZGl2XCIsIHsgY2xhc3M6IENTUyQyLmluZm9EZXNjcmlwdGlvbiB9LCBzdHJpbmdzLmdlbmVyYWwuaW5jbHVkZWRMYXllclBhbmVsRGVzY3JpcHRpb24pKSk7XG4gIH1cbiAgcmVuZGVyU3VibGF5ZXJzKCkge1xuICAgIHZhciBfYSwgX2I7XG4gICAgY29uc3QgeyBwcm9wcyB9ID0gdGhpcztcbiAgICBjb25zdCB7IGxheWVyLCBsYXllcklkcyB9ID0gcHJvcHM7XG4gICAgY29uc3QgbGlzdEl0ZW1zID0gW107XG4gICAgaWYgKGxheWVyLnR5cGUgPT09IFwiZ3JvdXBcIikge1xuICAgICAgKF9hID0gbGF5ZXIudGFibGVzKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EuZm9yRWFjaCgobHlyKSA9PiB7XG4gICAgICAgIGlmIChsYXllcklkcy5pbmNsdWRlcyhseXIubGF5ZXJJZCkpIHtcbiAgICAgICAgICBsaXN0SXRlbXMudW5zaGlmdCh0aGlzLnJlbmRlclN1YmxheWVyKGx5cikpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICAgIChfYiA9IGxheWVyLmxheWVycykgPT09IG51bGwgfHwgX2IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9iLmZvckVhY2goKGx5cikgPT4ge1xuICAgICAgICBpZiAobGF5ZXJJZHMuaW5jbHVkZXMobHlyLmxheWVySWQpKSB7XG4gICAgICAgICAgbGlzdEl0ZW1zLnVuc2hpZnQodGhpcy5yZW5kZXJTdWJsYXllcihseXIpKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgbGlzdEl0ZW1zLnB1c2godGhpcy5yZW5kZXJTdWJsYXllcihsYXllcikpO1xuICAgIH1cbiAgICByZXR1cm4gKGgoXCJjYWxjaXRlLWxpc3RcIiwgeyByZWY6IChub2RlKSA9PiAodGhpcy5saXN0Tm9kZSA9IG5vZGUpIH0sIGxpc3RJdGVtcykpO1xuICB9XG4gIHJlbmRlclN1YmxheWVyKGZsKSB7XG4gICAgY29uc3QgeyBwcm9wcyB9ID0gdGhpcztcbiAgICBjb25zdCB7IHN0cmluZ3MgfSA9IHByb3BzO1xuICAgIGNvbnN0IGlzUnRsID0gZ2V0RWxlbWVudERpcih0aGlzLmhvc3RFbGVtZW50KSA9PT0gXCJydGxcIjtcbiAgICBjb25zdCB2aWV3TGF5ZXJQcm9wcyA9IGdldFZpZXdMYXllclByb3BzKGZsLmxheWVySWQsIHByb3BzKTtcbiAgICByZXR1cm4gKGgoXCJjYWxjaXRlLWxpc3QtaXRlbVwiLCB7IGtleTogZmwubGF5ZXJJZCwgbGFiZWw6IGZsLnRpdGxlLCBkZXNjcmlwdGlvbjogZmwuaXNUYWJsZSA/IHN0cmluZ3MuZ2VuZXJhbC50YWJsZSA6IHN0cmluZ3MuZ2VuZXJhbC5sYXllciwgb25DbGljazogdGhpcy5nb0RlZmluaXRpb24uYmluZCh0aGlzLCBmbC5sYXllcklkKSwgcmVmOiAobm9kZSkgPT4ge1xuICAgICAgICBpZiAobm9kZSkge1xuICAgICAgICAgIHRoaXMubGlzdEl0ZW1Ob2Rlc1tmbC5sYXllcklkXSA9IG5vZGU7XG4gICAgICAgIH0gLy8gbm90IHN1cmUgd2h5IGl0J3MgbnVsbCBzb21ldGltZXNcbiAgICAgIH0gfSwgISF2aWV3TGF5ZXJQcm9wcyA/IChoKFwiY2FsY2l0ZS1pY29uXCIsIHsgY2xhc3M6IENTUyQyLmhhc0RlZmluaXRpb25JY29uLCBzbG90OiBcImNvbnRlbnQtZW5kXCIsIGljb246IFwic2xpZGVyc1wiLCBzY2FsZTogXCJzXCIgfSkpIDogbnVsbCwgaChcImNhbGNpdGUtaWNvblwiLCB7IGNsYXNzOiBDU1MkMi5kZWZpbml0aW9uSWNvbiwgc2xvdDogXCJjb250ZW50LWVuZFwiLCBpY29uOiBpc1J0bCA/IFwiY2hldnJvbi1sZWZ0XCIgOiBcImNoZXZyb24tcmlnaHRcIiwgc2NhbGU6IFwic1wiIH0pKSk7XG4gIH1cbiAgcmVuZGVyTGF5ZXJEZWZpbml0aW9uKCkge1xuICAgIGNvbnN0IHsgcHJvcHMsIHN0YXR1cyB9ID0gdGhpcztcbiAgICBjb25zdCB7IGRlZmluaXRpb25MYXllcklkIH0gPSBwcm9wcztcbiAgICByZXR1cm4gKGgoXCJhcmNnaXMtbGF5ZXItdmlldy1kZWZpbml0aW9uXCIsIHsga2V5OiBgZGVmaW5pdGlvbi0ke2RlZmluaXRpb25MYXllcklkfWAsIHByb3BzOiBwcm9wcywgc3RhdHVzOiBzdGF0dXMsIGNsYXNzOiBcImNhbGNpdGUtbWF0Y2gtaGVpZ2h0XCIsIG9uQXJjZ2lzTGF5ZXJWaWV3T3ZlclZpZXdSZWZyZXNoOiAoKSA9PiBzZXRUaW1lb3V0KCgpID0+IHsgdmFyIF9hOyByZXR1cm4gKF9hID0gdGhpcy5saXN0SXRlbU5vZGVzW2RlZmluaXRpb25MYXllcklkXSkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLnNldEZvY3VzKCk7IH0sIDIwMCkgfSkpO1xuICB9XG4gIGdvRGVmaW5pdGlvbihsYXllcklkKSB7XG4gICAgY29uc3QgeyBwcm9wcyB9ID0gdGhpcztcbiAgICB0aGlzLnN0YXR1cyA9IGZsb3dTdGF0dXMuREVGSU5JVElPTjtcbiAgICBwcm9wcy5kZWZpbml0aW9uTGF5ZXJJZCA9IGxheWVySWQ7XG4gICAgdGhpcy5yZVJlbmRlciA9ICF0aGlzLnJlUmVuZGVyO1xuICB9XG4gIGFzeW5jIGdldExhdGVzdEFkbWluU2VydmljZUluZm8oKSB7XG4gICAgdGhpcy5wcm9wcy5hZG1pblNlcnZpY2VJbmZvID0gdW5kZWZpbmVkO1xuICAgIGF3YWl0IGdldEFkbWluU2VydmljZUluZm8kMSh0aGlzLnByb3BzLCB0cnVlKTtcbiAgICAvKiBjb25zb2xlLmxvZyhcbiAgICAgIFwidXBkYXRlZCB2aWV3IGFkbWluU2VydmljZUluZm9cIixcbiAgICAgIHRoaXMucHJvcHMuYWRtaW5TZXJ2aWNlSW5mbz8ubGF5ZXJzPy5tYXAoKGx5cjogYW55KSA9PiB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgaWQ6IGx5ci5pZCxcbiAgICAgICAgICBuYW1lOiBseXIubmFtZSxcbiAgICAgICAgICBhZG1pbkxheWVySW5mb19maWx0ZXI6IGx5ci5hZG1pbkxheWVySW5mbz8udmlld0xheWVyRGVmaW5pdGlvbj8udGFibGU/LmZpbHRlcj8udmFsdWUsXG4gICAgICAgICAgdmlld0RlZmluaXRpb25RdWVyeTogbHlyLnZpZXdEZWZpbml0aW9uUXVlcnksXG4gICAgICAgICAgZmllbGRzOiBseXIuZmllbGRzLm1hcCgoZmllbGQ6IGFueSkgPT4gYCR7ZmllbGQubmFtZX0gKCR7ZmllbGQudmlzaWJsZX0pYClcbiAgICAgICAgfTtcbiAgICAgIH0pLFxuICAgICAgdGhpcy5wcm9wcy5hZG1pblNlcnZpY2VJbmZvPy50YWJsZXM/Lm1hcCgobHlyOiBhbnkpID0+IHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBpZDogbHlyLmlkLFxuICAgICAgICAgIG5hbWU6IGx5ci5uYW1lLFxuICAgICAgICAgIHZpZXdEZWZpbml0aW9uUXVlcnk6IGx5ci52aWV3RGVmaW5pdGlvblF1ZXJ5LFxuICAgICAgICAgIGZpZWxkczogbHlyLmZpZWxkcy5tYXAoKGZpZWxkOiBhbnkpID0+IGAke2ZpZWxkLm5hbWV9ICgke2ZpZWxkLnZpc2libGV9KWApXG4gICAgICAgIH07XG4gICAgICB9KVxuICAgICk7ICovXG4gICAgdGhpcy5yZVJlbmRlciA9ICF0aGlzLnJlUmVuZGVyO1xuICB9XG4gIGdldCBob3N0RWxlbWVudCgpIHsgcmV0dXJuIGdldEVsZW1lbnQodGhpcyk7IH1cbn07XG5BcmNnaXNMYXllclZpZXdPdmVydmlldy5zdHlsZSA9IGFyY2dpc0xheWVyVmlld092ZXJ2aWV3Q3NzO1xuXG5jb25zdCBDU1MkMSA9IHtcbiAgZmxvdzogXCJmbG93XCIsXG4gIHBhbmVsOiBcInBhbmVsXCIsXG4gIGZvb3RlcjogXCJmb290ZXJcIixcbiAgaW5mbzogXCJpbmZvXCIsXG4gIGluZm9IZWFkaW5nOiBcImluZm8taGVhZGluZ1wiLFxuICBpbmZvRGVzY3JpcHRpb246IFwiaW5mby1kZXNjcmlwdGlvblwiLFxuICBmaXhlZExpc3RJdGVtOiBcImZpeGVkLWxpc3QtaXRlbVwiXG59O1xuXG5jb25zdCBhcmNnaXNMYXllclZpZXdTZWxlY3Rpb25Dc3MgPSBcIi5mbG93LnNjLWFyY2dpcy1sYXllci12aWV3LXNlbGVjdGlvbntoZWlnaHQ6MTAwJX0ucGFuZWwuc2MtYXJjZ2lzLWxheWVyLXZpZXctc2VsZWN0aW9ue2hlaWdodDoxMDAlfS5mb290ZXIuc2MtYXJjZ2lzLWxheWVyLXZpZXctc2VsZWN0aW9ue3dpZHRoOjEwMCV9LmluZm8uc2MtYXJjZ2lzLWxheWVyLXZpZXctc2VsZWN0aW9ue2Rpc3BsYXk6Z3JpZDtncmlkLXRlbXBsYXRlLWNvbHVtbnM6cmVwZWF0KDEsIG1pbm1heCgwcHgsIDFmcikpO2dhcDowLjVyZW07cG9pbnRlci1ldmVudHM6bm9uZTtwYWRkaW5nOjFyZW0gMC43NXJlbX0uaW5mby1oZWFkaW5nLnNjLWFyY2dpcy1sYXllci12aWV3LXNlbGVjdGlvbntmb250LXNpemU6dmFyKC0tY2FsY2l0ZS1mb250LXNpemUtLTEpO2xpbmUtaGVpZ2h0OjEuMzc1O2NvbG9yOnZhcigtLWNhbGNpdGUtdWktdGV4dC0yKTt0cmFuc2l0aW9uLWR1cmF0aW9uOjE1MG1zO3RyYW5zaXRpb24tdGltaW5nLWZ1bmN0aW9uOmN1YmljLWJlemllcigwLjQsIDAsIDAuMiwgMSk7Zm9udC13ZWlnaHQ6dmFyKC0tY2FsY2l0ZS1mb250LXdlaWdodC1tZWRpdW0pO3BvaW50ZXItZXZlbnRzOm5vbmV9LmluZm8tZGVzY3JpcHRpb24uc2MtYXJjZ2lzLWxheWVyLXZpZXctc2VsZWN0aW9ue2ZvbnQtc2l6ZTp2YXIoLS1jYWxjaXRlLWZvbnQtc2l6ZS0tMik7bGluZS1oZWlnaHQ6MS4zNzU7Y29sb3I6dmFyKC0tY2FsY2l0ZS11aS10ZXh0LTMpO3RyYW5zaXRpb24tZHVyYXRpb246MTUwbXM7dHJhbnNpdGlvbi10aW1pbmctZnVuY3Rpb246Y3ViaWMtYmV6aWVyKDAuNCwgMCwgMC4yLCAxKTtwb2ludGVyLWV2ZW50czpub25lfS5maXhlZC1saXN0LWl0ZW0uc2MtYXJjZ2lzLWxheWVyLXZpZXctc2VsZWN0aW9ue21hcmdpbi1ib3R0b206MTBweH1cIjtcblxuY29uc3QgQXJjZ2lzTGF5ZXJWaWV3U2VsZWN0aW9uID0gY2xhc3Mge1xuICBjb25zdHJ1Y3Rvcihob3N0UmVmKSB7XG4gICAgcmVnaXN0ZXJJbnN0YW5jZSh0aGlzLCBob3N0UmVmKTtcbiAgICB0aGlzLmFyY2dpc0xheWVyVmlld1N0YXR1c0NoYW5nZSA9IGNyZWF0ZUV2ZW50KHRoaXMsIFwiYXJjZ2lzTGF5ZXJWaWV3U3RhdHVzQ2hhbmdlXCIsIDcpO1xuICAgIHRoaXMuYXJjZ2lzTGF5ZXJWaWV3U2VsZWN0aW9uQ2FuY2VsID0gY3JlYXRlRXZlbnQodGhpcywgXCJhcmNnaXNMYXllclZpZXdTZWxlY3Rpb25DYW5jZWxcIiwgNyk7XG4gICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICAvL1xuICAgIC8vICBQcml2YXRlIG1ldGhvZHNcbiAgICAvL1xuICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgdGhpcy5nb05leHQgPSAoKSA9PiB7XG4gICAgICBjb25zdCB7IHByb3BzIH0gPSB0aGlzO1xuICAgICAgY29uc3QgeyBsYXllcklkcyB9ID0gcHJvcHM7XG4gICAgICB0aGlzLmFyY2dpc0xheWVyVmlld1N0YXR1c0NoYW5nZS5lbWl0KHtcbiAgICAgICAgc3RhdHVzOiBmbG93U3RhdHVzLk9WRVJWSUVXLFxuICAgICAgICBsYXllcklkc1xuICAgICAgfSk7XG4gICAgfTtcbiAgICB0aGlzLmdvU3dhcFNvdXJjZSA9ICgpID0+IHtcbiAgICAgIGNvbnN0IHsgcHJvcHMgfSA9IHRoaXM7XG4gICAgICBjb25zdCB7IGxheWVySWRzIH0gPSBwcm9wcztcbiAgICAgIHRoaXMuYXJjZ2lzTGF5ZXJWaWV3U3RhdHVzQ2hhbmdlLmVtaXQoe1xuICAgICAgICBzdGF0dXM6IGZsb3dTdGF0dXMuU1dBUF9TT1VSQ0UsXG4gICAgICAgIGxheWVySWRzXG4gICAgICB9KTtcbiAgICB9O1xuICAgIHRoaXMub25TZWxlY3Rpb25DaGFuZ2UgPSAoKSA9PiB7XG4gICAgICBjb25zdCB7IHByb3BzLCBob3N0RWxlbWVudCB9ID0gdGhpcztcbiAgICAgIGNvbnN0IHsgbGF5ZXIsIHN0cmluZ3MgfSA9IHByb3BzO1xuICAgICAgY29uc3QgbGF5ZXJJZHMgPSBbXTtcbiAgICAgIHRoaXMubGlzdE5vZGVcbiAgICAgICAgLnF1ZXJ5U2VsZWN0b3JBbGwoXCJjYWxjaXRlLXBpY2stbGlzdC1pdGVtXCIpXG4gICAgICAgIC5mb3JFYWNoKChpdGVtKSA9PiB7XG4gICAgICAgIGlmIChpdGVtLnNlbGVjdGVkKSB7XG4gICAgICAgICAgbGF5ZXJJZHMucHVzaChpdGVtLnZhbHVlKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAobGF5ZXIudHlwZSA9PT0gXCJncm91cFwiKSB7XG4gICAgICAgICAgZ2V0TGF5ZXJzQW5kVGFibGVzKGxheWVyKS5maW5kKChzdWJMYXllcikgPT4gc3ViTGF5ZXIubGF5ZXJJZCA9PT0gaXRlbS52YWx1ZSkudmlzaWJsZSA9IGl0ZW0uc2VsZWN0ZWQ7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgbGF5ZXIudmlzaWJsZSA9IGl0ZW0uc2VsZWN0ZWQ7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgICAgaWYgKGxheWVySWRzLmxlbmd0aCkge1xuICAgICAgICB0aGlzLnByb3BzLmxheWVySWRzID0gbGF5ZXJJZHM7XG4gICAgICB9XG4gICAgICBlbHNlIHtcbiAgICAgICAgLy8gbXVzdCBoYXZlIGF0IGxlYXN0IG9uZSBsYXllciBzZWxlY3RlZFxuICAgICAgICB0aGlzLm1zZ05vZGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiYXJjZ2lzLWxheWVyLXZpZXctbXNnXCIpO1xuICAgICAgICB0aGlzLm1zZ05vZGUucHJvcHMgPSBwcm9wcztcbiAgICAgICAgdGhpcy5tc2dOb2RlLmZsb3dJdGVtRWxlbWVudCA9IHRoaXMuZmxvd0l0ZW1Ob2RlO1xuICAgICAgICB0aGlzLm1zZ05vZGUubWVzc2FnZSA9IHN0cmluZ3MubXNnLmF0TGVhc3RPbmU7XG4gICAgICAgIHRoaXMubXNnTm9kZS5pc1dhcm5pbmcgPSB0cnVlO1xuICAgICAgICBob3N0RWxlbWVudC5hcHBlbmRDaGlsZCh0aGlzLm1zZ05vZGUpO1xuICAgICAgICBjbGVhclRpbWVvdXQodGhpcy50aW1lb3V0SG5kbCk7XG4gICAgICAgIHRoaXMudGltZW91dEhuZGwgPSBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICB0aGlzLnRpbWVvdXRIbmRsID0gdW5kZWZpbmVkO1xuICAgICAgICAgIGlmICh0aGlzLm1zZ05vZGUpIHtcbiAgICAgICAgICAgIGhvc3RFbGVtZW50LnJlbW92ZUNoaWxkKHRoaXMubXNnTm9kZSk7XG4gICAgICAgICAgICB0aGlzLm1zZ05vZGUgPSB1bmRlZmluZWQ7XG4gICAgICAgICAgICB0aGlzLnJlUmVuZGVyID0gIXRoaXMucmVSZW5kZXI7XG4gICAgICAgICAgfVxuICAgICAgICB9LCA3MDAwKTtcbiAgICAgICAgLy8gY2hlY2sgdGhhdCBsYXN0IGxpc3QgaXRlbSBhZ2FpblxuICAgICAgICB0aGlzLmxpc3ROb2RlXG4gICAgICAgICAgLnF1ZXJ5U2VsZWN0b3JBbGwoXCJjYWxjaXRlLXBpY2stbGlzdC1pdGVtXCIpXG4gICAgICAgICAgLmZvckVhY2goKGl0ZW0pID0+IHtcbiAgICAgICAgICBpZiAocHJvcHMubGF5ZXJJZHMuaW5kZXhPZihpdGVtLnZhbHVlKSA+IC0xKSB7XG4gICAgICAgICAgICBpdGVtLnNlbGVjdGVkID0gdHJ1ZTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgICAgdGhpcy5yZVJlbmRlciA9ICF0aGlzLnJlUmVuZGVyO1xuICAgIH07XG4gICAgdGhpcy5wcm9wcyA9IHVuZGVmaW5lZDtcbiAgICB0aGlzLnN0YXR1cyA9IHVuZGVmaW5lZDtcbiAgICB0aGlzLnJlUmVuZGVyID0gZmFsc2U7XG4gIH1cbiAgYXJjZ2lzTGF5ZXJWaWV3TXNnQ2xvc2VkSGFuZGxlcigpIHtcbiAgICBpZiAodGhpcy5tc2dOb2RlKSB7XG4gICAgICB0aGlzLmhvc3RFbGVtZW50LnJlbW92ZUNoaWxkKHRoaXMubXNnTm9kZSk7XG4gICAgICB0aGlzLm1zZ05vZGUgPSB1bmRlZmluZWQ7XG4gICAgfVxuICAgIGNsZWFyVGltZW91dCh0aGlzLnRpbWVvdXRIbmRsKTtcbiAgICB0aGlzLnRpbWVvdXRIbmRsID0gdW5kZWZpbmVkO1xuICAgIHRoaXMucmVSZW5kZXIgPSAhdGhpcy5yZVJlbmRlcjtcbiAgfVxuICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIC8vXG4gIC8vICBMaWZlY3ljbGVcbiAgLy9cbiAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICBhc3luYyBjb21wb25lbnRXaWxsTG9hZCgpIHsgfVxuICBhc3luYyBjb21wb25lbnREaWRMb2FkKCkge1xuICAgIGNvbnN0IHsgcHJvcHMgfSA9IHRoaXM7XG4gICAgY29uc3QgeyBkZXJpdmF0aXZlTGF5ZXJzIH0gPSBwcm9wcztcbiAgICBpZiAoZGVyaXZhdGl2ZUxheWVycy5oYXNBbnkpIHtcbiAgICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZSgoKSA9PiB7IHZhciBfYTsgcmV0dXJuIChfYSA9IHRoaXMuc3dhcEJ1dHRvbk5vZGUpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5zZXRGb2N1cygpOyB9KTtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKCkgPT4geyB2YXIgX2E7IHJldHVybiAoX2EgPSB0aGlzLmxpc3ROb2RlKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2Euc2V0Rm9jdXMoKTsgfSk7XG4gICAgfVxuICB9XG4gIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIC8vXG4gIC8vICBSZW5kZXIgTWV0aG9kc1xuICAvL1xuICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIHJlbmRlcigpIHtcbiAgICAvL2NvbnNvbGUubG9nKFwicmVuZGVyIHZpZXctc2VsZWN0aW9uXCIsIHByb3BzVG9TdHJpbmcodGhpcy5wcm9wcyksIFwic3RhdHVzOlwiLCB0aGlzLnN0YXR1cyk7XG4gICAgY29uc3QgeyBwcm9wcywgc3RhdHVzIH0gPSB0aGlzO1xuICAgIGNvbnN0IHsgdmlld0l0ZW0sIGxheWVySXRlbSwgc3RyaW5ncyB9ID0gcHJvcHM7XG4gICAgY29uc3QgcnRsID0gZ2V0RWxlbWVudERpcih0aGlzLmhvc3RFbGVtZW50KSA9PT0gXCJydGxcIjtcbiAgICByZXR1cm4gKGgoSG9zdCwgeyBjbGFzczogXCJjYWxjaXRlLW1hdGNoLWhlaWdodFwiIH0sIGgoXCJjYWxjaXRlLWZsb3dcIiwgeyBjbGFzczogQ1NTJDEuZmxvdywgZGlyOiBnZXRFbGVtZW50RGlyKHRoaXMuaG9zdEVsZW1lbnQpIH0sIGgoXCJjYWxjaXRlLWZsb3ctaXRlbVwiLCB7IGhlYWRpbmc6ICh2aWV3SXRlbSA9PT0gbnVsbCB8fCB2aWV3SXRlbSA9PT0gdm9pZCAwID8gdm9pZCAwIDogdmlld0l0ZW0udGl0bGUpIHx8IChsYXllckl0ZW0gPT09IG51bGwgfHwgbGF5ZXJJdGVtID09PSB2b2lkIDAgPyB2b2lkIDAgOiBsYXllckl0ZW0udGl0bGUpLCBkZXNjcmlwdGlvbjogc3RyaW5ncy5nZW5lcmFsLnNvdXJjZUxheWVyLCBjbGFzczoge1xuICAgICAgICBwYW5lbDogdHJ1ZSxcbiAgICAgICAgW0NTU19VVElMSVRZLnJ0bF06IHJ0bFxuICAgICAgfSwgcmVmOiAobm9kZSkgPT4gKHRoaXMuZmxvd0l0ZW1Ob2RlID0gbm9kZSkgfSwgdGhpcy5yZW5kZXJGb290ZXJCdXR0b25zKCksIHRoaXMucmVuZGVySW5mbygpLCB0aGlzLnJlbmRlclN1YmxheWVycygpKSwgW2Zsb3dTdGF0dXMuU1dBUF9TT1VSQ0UsIGZsb3dTdGF0dXMuQlJPV1NFX0xBWUVSXS5pbmNsdWRlcyhzdGF0dXMpXG4gICAgICA/IHRoaXMucmVuZGVyU3dhcFNvdXJjZSgpXG4gICAgICA6IG51bGwpKSk7XG4gIH1cbiAgcmVuZGVyRm9vdGVyQnV0dG9ucygpIHtcbiAgICBjb25zdCB7IHByb3BzIH0gPSB0aGlzO1xuICAgIGNvbnN0IHsgbGF5ZXIsIGxheWVySWRzLCB2aWV3SXRlbSwgZGVyaXZhdGl2ZUxheWVycywgaGFzUmVwbGljYXMsIHN0cmluZ3MgfSA9IHByb3BzO1xuICAgIGNvbnN0IGlzUnRsID0gZ2V0RWxlbWVudERpcih0aGlzLmhvc3RFbGVtZW50KSA9PT0gXCJydGxcIjtcbiAgICBjb25zdCBpc1ZlbG9jaXR5VmlldyA9ICh2aWV3SXRlbSA9PT0gbnVsbCB8fCB2aWV3SXRlbSA9PT0gdm9pZCAwID8gdm9pZCAwIDogdmlld0l0ZW0udHlwZUtleXdvcmRzLmluZGV4T2YoXCJJb1RGZWF0dXJlTGF5ZXJcIikpID4gLTE7XG4gICAgY29uc3QgaGFzU3dhcFJpZ2h0cyA9ICFpc1ZlbG9jaXR5VmlldyAmJiBbXCJhZG1pblwiLCBcInVwZGF0ZVwiXS5pbmRleE9mKHZpZXdJdGVtID09PSBudWxsIHx8IHZpZXdJdGVtID09PSB2b2lkIDAgPyB2b2lkIDAgOiB2aWV3SXRlbS5pdGVtQ29udHJvbCkgPiAtMTtcbiAgICBjb25zdCBuZXh0RW5hYmxlZCA9IChsYXllciA9PT0gbnVsbCB8fCBsYXllciA9PT0gdm9pZCAwID8gdm9pZCAwIDogbGF5ZXIubG9hZGVkKSAmJiBsYXllcklkcy5sZW5ndGggJiYgIWRlcml2YXRpdmVMYXllcnMuaGFzQW55O1xuICAgIGlmIChoYXNTd2FwUmlnaHRzICYmIGRlcml2YXRpdmVMYXllcnMuaGFzQW55KSB7XG4gICAgICByZXR1cm4gKGgoXCJkaXZcIiwgeyBzbG90OiBcImZvb3RlclwiLCBjbGFzczogXCJmb290ZXJcIiB9LCBoKFwiY2FsY2l0ZS1idXR0b25cIiwgeyBvbkNsaWNrOiAhaGFzUmVwbGljYXMgJiYgdGhpcy5nb1N3YXBTb3VyY2UsIGRpc2FibGVkOiBoYXNSZXBsaWNhcywgYXBwZWFyYW5jZTogXCJzb2xpZFwiLCB3aWR0aDogXCJmdWxsXCIsIGljb25TdGFydDogXCJhcnJvdy1yaWdodC1sZWZ0XCIsIHJlZjogKG5vZGUpID0+ICh0aGlzLnN3YXBCdXR0b25Ob2RlID0gbm9kZSkgfSwgc3RyaW5ncy5nZW5lcmFsLnN3YXBTb3VyY2UpLCBoKFwiY2FsY2l0ZS1idXR0b25cIiwgeyBvbkNsaWNrOiAoKSA9PiB0aGlzLmFyY2dpc0xheWVyVmlld1NlbGVjdGlvbkNhbmNlbC5lbWl0KCksIGFwcGVhcmFuY2U6IFwidHJhbnNwYXJlbnRcIiwgd2lkdGg6IFwiZnVsbFwiIH0sIHN0cmluZ3MuZ2VuZXJhbC5jbG9zZSkpKTtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICByZXR1cm4gKGgoXCJkaXZcIiwgeyBzbG90OiBcImZvb3RlclwiLCBjbGFzczogXCJmb290ZXJcIiB9LCBoKFwiY2FsY2l0ZS1idXR0b25cIiwgeyBkaXNhYmxlZDogIW5leHRFbmFibGVkLCBvbkNsaWNrOiBuZXh0RW5hYmxlZCAmJiB0aGlzLmdvTmV4dCwgYXBwZWFyYW5jZTogXCJzb2xpZFwiLCB3aWR0aDogXCJmdWxsXCIsIGljb25FbmQ6IGlzUnRsID8gXCJhcnJvdy1sZWZ0XCIgOiBcImFycm93LXJpZ2h0XCIsIHJlZjogKG5vZGUpID0+ICh0aGlzLm5leHRCdXR0b25Ob2RlID0gbm9kZSkgfSwgc3RyaW5ncy5nZW5lcmFsLm5leHQpLCBoYXNTd2FwUmlnaHRzICYmIChoKFwiZGl2XCIsIG51bGwsIGgoXCJjYWxjaXRlLWJ1dHRvblwiLCB7IGRpc2FibGVkOiAhbmV4dEVuYWJsZWQgfHwgaGFzUmVwbGljYXMsIG9uQ2xpY2s6IG5leHRFbmFibGVkICYmICFoYXNSZXBsaWNhcyAmJiB0aGlzLmdvU3dhcFNvdXJjZSwgYXBwZWFyYW5jZTogXCJ0cmFuc3BhcmVudFwiLCB3aWR0aDogXCJmdWxsXCIsIGljb25TdGFydDogXCJhcnJvdy1yaWdodC1sZWZ0XCIsIHJlZjogKG5vZGUpID0+ICh0aGlzLnN3YXBCdXR0b25Ob2RlID0gbm9kZSkgfSwgc3RyaW5ncy5nZW5lcmFsLnN3YXBTb3VyY2UpKSkpKTtcbiAgICB9XG4gIH1cbiAgcmVuZGVySW5mbygpIHtcbiAgICBjb25zdCB7IHByb3BzIH0gPSB0aGlzO1xuICAgIGNvbnN0IHsgdmlld0l0ZW0sIGRlcml2YXRpdmVMYXllcnMsIGhhc1JlcGxpY2FzLCBzdHJpbmdzIH0gPSBwcm9wcztcbiAgICBjb25zdCBoYXNTd2FwUmlnaHRzID0gW1wiYWRtaW5cIiwgXCJ1cGRhdGVcIl0uaW5kZXhPZih2aWV3SXRlbSA9PT0gbnVsbCB8fCB2aWV3SXRlbSA9PT0gdm9pZCAwID8gdm9pZCAwIDogdmlld0l0ZW0uaXRlbUNvbnRyb2wpID4gLTE7XG4gICAgcmV0dXJuIChoKFwiZGl2XCIsIHsgY2xhc3M6IFwiaW5mb1wiIH0sIGRlcml2YXRpdmVMYXllcnMuaGFzQW55ID8gKGgoXCJjYWxjaXRlLW5vdGljZVwiLCB7IHNjYWxlOiBcInNcIiwgd2lkdGg6IFwiZnVsbFwiLCBvcGVuOiB0cnVlLCBpY29uOiBcImluZm9ybWF0aW9uXCIgfSwgaChcImRpdlwiLCB7IHNsb3Q6IFwibWVzc2FnZVwiIH0sIHN0cmluZ3MuZ2VuZXJhbC5kZXJpdmF0aXZlTGF5ZXJOb3RpY2UpKSkgOiBudWxsLCBoYXNSZXBsaWNhcyAmJiBoYXNTd2FwUmlnaHRzID8gKGgoXCJjYWxjaXRlLW5vdGljZVwiLCB7IHNjYWxlOiBcInNcIiwgd2lkdGg6IFwiZnVsbFwiLCBvcGVuOiB0cnVlLCBpY29uOiBcImluZm9ybWF0aW9uXCIgfSwgaChcImRpdlwiLCB7IHNsb3Q6IFwibWVzc2FnZVwiIH0sIHN0cmluZ3MuZ2VuZXJhbC5zZWxlY3RMYXllclBhbmVsUmVwbGljYU5vdGljZSkpKSA6IG51bGwsICFkZXJpdmF0aXZlTGF5ZXJzLmhhc0FueSA/IChoKFwiZGl2XCIsIG51bGwsIGgoXCJkaXZcIiwgeyBjbGFzczogQ1NTJDEuaW5mb0hlYWRpbmcgfSwgc3RyaW5ncy5nZW5lcmFsLnNlbGVjdExheWVyUGFuZWxUaXRsZSksIGgoXCJkaXZcIiwgeyBjbGFzczogQ1NTJDEuaW5mb0Rlc2NyaXB0aW9uIH0sIHN0cmluZ3MuZ2VuZXJhbC5zZWxlY3RMYXllclBhbmVsRGVzY3JpcHRpb24pKSkgOiBudWxsKSk7XG4gIH1cbiAgcmVuZGVyU3VibGF5ZXJzKCkge1xuICAgIGNvbnN0IHsgcHJvcHMgfSA9IHRoaXM7XG4gICAgY29uc3QgeyBkZXJpdmF0aXZlTGF5ZXJzIH0gPSBwcm9wcztcbiAgICBpZiAoZGVyaXZhdGl2ZUxheWVycy5oYXNBbnkpIHtcbiAgICAgIHJldHVybiB0aGlzLnJlbmRlck5vbkVkaXRhYmxlU3VibGF5ZXJzKCk7XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgcmV0dXJuIHRoaXMucmVuZGVyRWRpdGFibGVTdWJsYXllcnMoKTtcbiAgICB9XG4gIH1cbiAgcmVuZGVyTm9uRWRpdGFibGVTdWJsYXllcnMoKSB7XG4gICAgdmFyIF9hLCBfYjtcbiAgICBjb25zdCB7IHByb3BzIH0gPSB0aGlzO1xuICAgIGNvbnN0IHsgbGF5ZXIsIGxheWVySWRzLCBzdHJpbmdzIH0gPSBwcm9wcztcbiAgICBjb25zdCBsYXllckxpc3RJdGVtcyA9IFtdO1xuICAgIGNvbnN0IHRhYmxlTGlzdEl0ZW1zID0gW107XG4gICAgaWYgKGxheWVyLnR5cGUgPT09IFwiZ3JvdXBcIikge1xuICAgICAgKF9hID0gbGF5ZXIudGFibGVzKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EuZm9yRWFjaCgobHlyKSA9PiB7XG4gICAgICAgIGlmIChsYXllcklkcy5pbmRleE9mKGx5ci5sYXllcklkKSA+IC0xKSB7XG4gICAgICAgICAgdGFibGVMaXN0SXRlbXMudW5zaGlmdCh0aGlzLnJlbmRlck5vbkVkaXRhYmxlU3VibGF5ZXIobHlyKSk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgICAgKF9iID0gbGF5ZXIubGF5ZXJzKSA9PT0gbnVsbCB8fCBfYiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2IuZm9yRWFjaCgobHlyKSA9PiB7XG4gICAgICAgIGlmIChsYXllcklkcy5pbmRleE9mKGx5ci5sYXllcklkKSA+IC0xKSB7XG4gICAgICAgICAgbGF5ZXJMaXN0SXRlbXMudW5zaGlmdCh0aGlzLnJlbmRlck5vbkVkaXRhYmxlU3VibGF5ZXIobHlyKSk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgIChsYXllci5pc1RhYmxlID8gdGFibGVMaXN0SXRlbXMgOiBsYXllckxpc3RJdGVtcykucHVzaCh0aGlzLnJlbmRlck5vbkVkaXRhYmxlU3VibGF5ZXIobGF5ZXIpKTtcbiAgICB9XG4gICAgcmV0dXJuIChoKFwiZGl2XCIsIHsgY2xhc3M6IENTUyQxLmluZm8gfSwgbGF5ZXJMaXN0SXRlbXMubGVuZ3RoID4gMCA/IChoKFwiZGl2XCIsIHsgY2xhc3M6IENTUyQxLmluZm9IZWFkaW5nIH0sIHN0cmluZ3MuZ2VuZXJhbC5sYXllcnMpKSA6IG51bGwsIGxheWVyTGlzdEl0ZW1zLmxlbmd0aCA+IDAgPyBoKFwidWxcIiwgbnVsbCwgbGF5ZXJMaXN0SXRlbXMpIDogbnVsbCwgdGFibGVMaXN0SXRlbXMubGVuZ3RoID4gMCA/IChoKFwiZGl2XCIsIHsgY2xhc3M6IENTUyQxLmluZm9IZWFkaW5nIH0sIHN0cmluZ3MuZ2VuZXJhbC50YWJsZXMpKSA6IG51bGwsIHRhYmxlTGlzdEl0ZW1zLmxlbmd0aCA+IDAgPyBoKFwidWxcIiwgbnVsbCwgdGFibGVMaXN0SXRlbXMpIDogbnVsbCkpO1xuICB9XG4gIHJlbmRlck5vbkVkaXRhYmxlU3VibGF5ZXIobHlyKSB7XG4gICAgcmV0dXJuIGgoXCJsaVwiLCB7IGNsYXNzOiBDU1MkMS5maXhlZExpc3RJdGVtIH0sIGx5ci50aXRsZSk7XG4gIH1cbiAgcmVuZGVyRWRpdGFibGVTdWJsYXllcnMoKSB7XG4gICAgdmFyIF9hLCBfYjtcbiAgICBjb25zdCB7IHByb3BzIH0gPSB0aGlzO1xuICAgIGNvbnN0IHsgbGF5ZXIgfSA9IHByb3BzO1xuICAgIGNvbnN0IGxpc3RJdGVtcyA9IFtdO1xuICAgIGlmIChsYXllci50eXBlID09PSBcImdyb3VwXCIpIHtcbiAgICAgIChfYSA9IGxheWVyLnRhYmxlcykgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmZvckVhY2goKGx5cikgPT4ge1xuICAgICAgICBsaXN0SXRlbXMudW5zaGlmdCh0aGlzLnJlbmRlckVkaXRhYmxlU3VibGF5ZXIobHlyKSk7XG4gICAgICB9KTtcbiAgICAgIChfYiA9IGxheWVyLmxheWVycykgPT09IG51bGwgfHwgX2IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9iLmZvckVhY2goKGx5cikgPT4ge1xuICAgICAgICBsaXN0SXRlbXMudW5zaGlmdCh0aGlzLnJlbmRlckVkaXRhYmxlU3VibGF5ZXIobHlyKSk7XG4gICAgICB9KTtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICBsaXN0SXRlbXMucHVzaCh0aGlzLnJlbmRlckVkaXRhYmxlU3VibGF5ZXIobGF5ZXIpKTtcbiAgICB9XG4gICAgcmV0dXJuIChoKFwiY2FsY2l0ZS1waWNrLWxpc3RcIiwgeyBtdWx0aXBsZTogdHJ1ZSwgb25DYWxjaXRlTGlzdENoYW5nZTogdGhpcy5vblNlbGVjdGlvbkNoYW5nZSwgcmVmOiAobm9kZSkgPT4gKHRoaXMubGlzdE5vZGUgPSBub2RlKSB9LCBsaXN0SXRlbXMpKTtcbiAgfVxuICByZW5kZXJFZGl0YWJsZVN1YmxheWVyKGx5cikge1xuICAgIGNvbnN0IHsgcHJvcHMgfSA9IHRoaXM7XG4gICAgY29uc3QgeyBsYXllcklkcywgc3RyaW5ncyB9ID0gcHJvcHM7XG4gICAgcmV0dXJuIChoKFwiY2FsY2l0ZS1waWNrLWxpc3QtaXRlbVwiLCB7IGtleTogbHlyLmxheWVySWQsIGxhYmVsOiBseXIudGl0bGUsIHZhbHVlOiBseXIubGF5ZXJJZCwgZGVzY3JpcHRpb246IGx5ci5pc1RhYmxlID8gc3RyaW5ncy5nZW5lcmFsLnRhYmxlIDogc3RyaW5ncy5nZW5lcmFsLmxheWVyLCBzZWxlY3RlZDogbGF5ZXJJZHMuaW5kZXhPZihseXIubGF5ZXJJZCkgPiAtMSB9KSk7XG4gIH1cbiAgcmVuZGVyU3dhcFNvdXJjZSgpIHtcbiAgICBjb25zdCB7IHByb3BzLCBzdGF0dXMgfSA9IHRoaXM7XG4gICAgcmV0dXJuIChoKFwiYXJjZ2lzLWxheWVyLXZpZXctc3dhcC1zb3VyY2VcIiwge1xuICAgICAgLy9rZXk9e2BzZWxlY3Rpb24tJHtzdGF0dXN9YH1cbiAgICAgIHByb3BzOiBwcm9wcywgc3RhdHVzOiBzdGF0dXMsIG9uQXJjZ2lzTGF5ZXJWaWV3U3RhdHVzQ2hhbmdlOiAoKSA9PiBzZXRUaW1lb3V0KCgpID0+IHsgdmFyIF9hOyByZXR1cm4gKF9hID0gdGhpcy5mbG93SXRlbU5vZGUpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5zZXRGb2N1cygpOyB9LCAyMDApXG4gICAgfSkpO1xuICB9XG4gIGdldCBob3N0RWxlbWVudCgpIHsgcmV0dXJuIGdldEVsZW1lbnQodGhpcyk7IH1cbn07XG5BcmNnaXNMYXllclZpZXdTZWxlY3Rpb24uc3R5bGUgPSBhcmNnaXNMYXllclZpZXdTZWxlY3Rpb25Dc3M7XG5cbmNvbnN0IENTUyA9IHtcbiAgcGFuZWw6IFwicGFuZWxcIixcbiAgYnJvd3NlOiBcImJyb3dzZVwiLFxuICBpbmZvOiBcImluZm9cIixcbiAgdGV4dDogXCJ0ZXh0XCIsXG4gIGNoZWNrOiBcImNoZWNrXCIsXG4gIGNoZWNrVGV4dDogXCJjaGVjay10ZXh0XCIsXG4gIGZvb3RlckJ1dHRvbjogXCJmb290ZXItYnV0dG9uXCJcbn07XG5cbmNvbnN0IGFyY2dpc0xheWVyVmlld1N3YXBTb3VyY2VDc3MgPSBcIi5wYW5lbC5zYy1hcmNnaXMtbGF5ZXItdmlldy1zd2FwLXNvdXJjZXtoZWlnaHQ6MTAwJX0uYnJvd3NlLnNjLWFyY2dpcy1sYXllci12aWV3LXN3YXAtc291cmNle3dpZHRoOjEwMCV9LmluZm8uc2MtYXJjZ2lzLWxheWVyLXZpZXctc3dhcC1zb3VyY2V7bWFyZ2luOjEwcHh9LnRleHQuc2MtYXJjZ2lzLWxheWVyLXZpZXctc3dhcC1zb3VyY2V7bWFyZ2luLWJvdHRvbTo4cHh9LmNoZWNrLnNjLWFyY2dpcy1sYXllci12aWV3LXN3YXAtc291cmNle2NvbG9yOmdyZWVufS5jaGVjay10ZXh0LnNjLWFyY2dpcy1sYXllci12aWV3LXN3YXAtc291cmNle2ZvbnQtd2VpZ2h0OmJvbGR9LmZvb3Rlci1idXR0b24uc2MtYXJjZ2lzLWxheWVyLXZpZXctc3dhcC1zb3VyY2V7bWFyZ2luOjAgMTBweCA1cHggMTBweH1cIjtcblxuY29uc3QgQXJjZ2lzTGF5ZXJWaWV3U3dhcFNvdXJjZSA9IGNsYXNzIHtcbiAgY29uc3RydWN0b3IoaG9zdFJlZikge1xuICAgIHJlZ2lzdGVySW5zdGFuY2UodGhpcywgaG9zdFJlZik7XG4gICAgdGhpcy5hcmNnaXNMYXllclZpZXdTdGF0dXNDaGFuZ2UgPSBjcmVhdGVFdmVudCh0aGlzLCBcImFyY2dpc0xheWVyVmlld1N0YXR1c0NoYW5nZVwiLCA3KTtcbiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAgIC8vXG4gICAgLy8gIFByaXZhdGUgbWV0aG9kc1xuICAgIC8vXG4gICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICB0aGlzLm9uQmFjayA9ICgpID0+IHtcbiAgICAgIHRoaXMuYXJjZ2lzTGF5ZXJWaWV3U3RhdHVzQ2hhbmdlLmVtaXQoeyBzdGF0dXM6IGZsb3dTdGF0dXMuU0VMRUNUSU9OIH0pO1xuICAgIH07XG4gICAgdGhpcy5nb0Jyb3dzZSA9ICgpID0+IHtcbiAgICAgIHRoaXMuYXJjZ2lzTGF5ZXJWaWV3U3RhdHVzQ2hhbmdlLmVtaXQoeyBzdGF0dXM6IGZsb3dTdGF0dXMuQlJPV1NFX0xBWUVSIH0pO1xuICAgIH07XG4gICAgdGhpcy5wcm9wcyA9IHVuZGVmaW5lZDtcbiAgICB0aGlzLnN0YXR1cyA9IHVuZGVmaW5lZDtcbiAgICB0aGlzLnJlUmVuZGVyID0gZmFsc2U7XG4gICAgdGhpcy5sb2FkaW5nID0gZmFsc2U7XG4gIH1cbiAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAvL1xuICAvLyAgTGlmZWN5Y2xlXG4gIC8vXG4gIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgYXN5bmMgY29tcG9uZW50RGlkTG9hZCgpIHtcbiAgICAvLyByZXF1ZXN0QW5pbWF0aW9uRnJhbWUgbm9yIHdvcmtpbmcgdGhlIHNlY29uZCB0aW1lLi4uXG4gICAgc2V0VGltZW91dCgoKSA9PiByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKCkgPT4geyB2YXIgX2E7IHJldHVybiAoX2EgPSB0aGlzLmZsb3dJdGVtTm9kZSkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLnNldEZvY3VzKCk7IH0pLCAyMDApO1xuICB9XG4gIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIC8vXG4gIC8vICBSZW5kZXIgTWV0aG9kc1xuICAvL1xuICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIHJlbmRlcigpIHtcbiAgICAvL2NvbnNvbGUubG9nKFwicmVuZGVyIHN3YXAtc291cmNlXCIsIHByb3BzVG9TdHJpbmcodGhpcy5wcm9wcyksIFwic3RhdHVzXCIsIHRoaXMuc3RhdHVzKTtcbiAgICBjb25zdCB7IHByb3BzLCBzdGF0dXMsIGxvYWRpbmcgfSA9IHRoaXM7XG4gICAgY29uc3QgeyBzdHJpbmdzIH0gPSBwcm9wcztcbiAgICBjb25zdCBydGwgPSBnZXRFbGVtZW50RGlyKHRoaXMuaG9zdEVsZW1lbnQpID09PSBcInJ0bFwiO1xuICAgIHJldHVybiAoaChIb3N0LCB7IGNsYXNzOiBcImNhbGNpdGUtbWF0Y2gtaGVpZ2h0XCIgfSwgaChcImNhbGNpdGUtZmxvdy1pdGVtXCIsIHsga2V5OiBzdGF0dXMsIGhlYWRpbmc6IHN0cmluZ3Muc3dhcFNvdXJjZS50aXRsZSwgZGVzY3JpcHRpb246IHN0cmluZ3Muc3dhcFNvdXJjZS5zdWJUaXRsZSwgbG9hZGluZzogbG9hZGluZywgY2xhc3M6IHtcbiAgICAgICAgcGFuZWw6IHRydWUsXG4gICAgICAgIFtDU1NfVVRJTElUWS5ydGxdOiBydGxcbiAgICAgIH0sIG9uQ2FsY2l0ZUZsb3dJdGVtQmFjazogdGhpcy5vbkJhY2ssIHJlZjogKG5vZGUpID0+ICh0aGlzLmZsb3dJdGVtTm9kZSA9IG5vZGUpIH0sIHRoaXMucmVuZGVySW5mbygpLCB0aGlzLnJlbmRlckRlcml2YXRpdmVJbmZvKCksIHRoaXMucmVuZGVyQnJvd3NlKCkpLCBzdGF0dXMgPT09IGZsb3dTdGF0dXMuQlJPV1NFX0xBWUVSICYmIHRoaXMucmVuZGVyQnJvd3NlTGF5ZXIoKSkpO1xuICB9XG4gIHJlbmRlckluZm8oKSB7XG4gICAgY29uc3QgeyBwcm9wcyB9ID0gdGhpcztcbiAgICBjb25zdCB7IHN0cmluZ3MgfSA9IHByb3BzO1xuICAgIHJldHVybiAoaChcImRpdlwiLCB7IGNsYXNzOiBDU1MuaW5mbyB9LCBoKFwiZGl2XCIsIHsgY2xhc3M6IENTUy50ZXh0IH0sIHN0cmluZ3Muc3dhcFNvdXJjZS5tc2cxKSwgaChcImRpdlwiLCB7IGNsYXNzOiBDU1MudGV4dCB9LCBzdHJpbmdzLnN3YXBTb3VyY2UubXNnMiksIGgoXCJjYWxjaXRlLWxhYmVsXCIsIHsgbGF5b3V0OiBcImlubGluZVwiIH0sIGgoXCJjYWxjaXRlLWljb25cIiwgeyBpY29uOiBcImNoZWNrXCIsIGNsYXNzOiBDU1MuY2hlY2sgfSksIGgoXCJzcGFuXCIsIHsgY2xhc3M6IENTUy5jaGVja1RleHQgfSwgc3RyaW5ncy5zd2FwU291cmNlLnJlcXVpcmVtZW50MSkpLCBoKFwiY2FsY2l0ZS1sYWJlbFwiLCB7IGxheW91dDogXCJpbmxpbmVcIiB9LCBoKFwiY2FsY2l0ZS1pY29uXCIsIHsgaWNvbjogXCJjaGVja1wiLCBjbGFzczogQ1NTLmNoZWNrIH0pLCBoKFwic3BhblwiLCB7IGNsYXNzOiBDU1MuY2hlY2tUZXh0IH0sIHN0cmluZ3Muc3dhcFNvdXJjZS5yZXF1aXJlbWVudDIpKSwgaChcImNhbGNpdGUtbGFiZWxcIiwgeyBsYXlvdXQ6IFwiaW5saW5lXCIgfSwgaChcImNhbGNpdGUtaWNvblwiLCB7IGljb246IFwiY2hlY2tcIiwgY2xhc3M6IENTUy5jaGVjayB9KSwgaChcInNwYW5cIiwgeyBjbGFzczogQ1NTLmNoZWNrVGV4dCB9LCBzdHJpbmdzLnN3YXBTb3VyY2UucmVxdWlyZW1lbnQzKSksIGgoXCJkaXZcIiwgeyBjbGFzczogQ1NTLnRleHQgfSwgc3RyaW5ncy5zd2FwU291cmNlLm1zZzMpKSk7XG4gIH1cbiAgcmVuZGVyRGVyaXZhdGl2ZUluZm8oKSB7XG4gICAgY29uc3QgeyBwcm9wcyB9ID0gdGhpcztcbiAgICBjb25zdCB7IGRlcml2YXRpdmVMYXllcnMsIHN0cmluZ3MgfSA9IHByb3BzO1xuICAgIGlmICghZGVyaXZhdGl2ZUxheWVycy5oYXNNUyAmJiAhZGVyaXZhdGl2ZUxheWVycy5oYXNWVEwgJiYgIWRlcml2YXRpdmVMYXllcnMuaGFzU2NlbmUpIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgICByZXR1cm4gKGgoXCJkaXZcIiwgeyBjbGFzczogQ1NTLmluZm8gfSwgaChcImRpdlwiLCB7IGNsYXNzOiBDU1MudGV4dCB9LCBzdHJpbmdzLnN3YXBTb3VyY2UuZGVyaXZhdGl2ZU1zZykpKTtcbiAgfVxuICByZW5kZXJCcm93c2UoKSB7XG4gICAgY29uc3QgeyBwcm9wcyB9ID0gdGhpcztcbiAgICBjb25zdCB7IHN0cmluZ3MgfSA9IHByb3BzO1xuICAgIHJldHVybiAoaChcImRpdlwiLCB7IGNsYXNzOiBDU1MuZm9vdGVyQnV0dG9uIH0sIGgoXCJjYWxjaXRlLWJ1dHRvblwiLCB7IGlkOiBcImFyY2dpcy1sYXllci12aWV3LXN3YXAtc291cmNlLWJyb3dzZVwiLCBvbkNsaWNrOiB0aGlzLmdvQnJvd3NlLCBhcHBlYXJhbmNlOiBcIm91dGxpbmUtZmlsbFwiLCB3aWR0aDogXCJmdWxsXCIsIHJlZjogKG5vZGUpID0+ICh0aGlzLmJyb3dzZUJ1dHRvbk5vZGUgPSBub2RlKSB9LCBzdHJpbmdzLnN3YXBTb3VyY2UuYnJvd3NlRm9yTGF5ZXIpKSk7XG4gIH1cbiAgcmVuZGVyQnJvd3NlTGF5ZXIoKSB7XG4gICAgY29uc3QgeyBwcm9wcyB9ID0gdGhpcztcbiAgICByZXR1cm4gKGgoXCJhcmNnaXMtbGF5ZXItdmlldy1icm93c2UtbGF5ZXJcIiwgeyBwcm9wczogcHJvcHMsIGNsYXNzOiBDU1MuYnJvd3NlLCBvbkFyY2dpc0xheWVyVmlld1N0YXR1c0NoYW5nZTogKGV2ZW50KSA9PiB7XG4gICAgICAgIGlmIChldmVudC5kZXRhaWwuc3RhdHVzID09PSBmbG93U3RhdHVzLlNXQVBfU09VUkNFKSB7XG4gICAgICAgICAgLy8gY2FuJ3QgbWFrZSBpdCB3b3JrIHdpdGhvdXQgdXNpbmcgYW4gaWRcbiAgICAgICAgICAvLyBpdCBzZWVtcyB0aGUgd2hvbGUgY29tcG9uZW50IHJlbG9hZHMgZnJvbSBzY3JhdGNoIGFmdGVyIHRoaXMgc3RlcCBoZXJlXG4gICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICB2YXIgX2E7XG4gICAgICAgICAgICByZXR1cm4gKF9hID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJhcmNnaXMtbGF5ZXItdmlldy1zd2FwLXNvdXJjZS1icm93c2VcIikpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5zZXRGb2N1cygpO1xuICAgICAgICAgIH0sIDQwMCk7XG4gICAgICAgIH1cbiAgICAgIH0gfSkpO1xuICB9XG4gIGdldCBob3N0RWxlbWVudCgpIHsgcmV0dXJuIGdldEVsZW1lbnQodGhpcyk7IH1cbn07XG5BcmNnaXNMYXllclZpZXdTd2FwU291cmNlLnN0eWxlID0gYXJjZ2lzTGF5ZXJWaWV3U3dhcFNvdXJjZUNzcztcblxuZXhwb3J0IHsgQXJjZ2lzTGF5ZXJWaWV3JDEgYXMgYXJjZ2lzX2xheWVyX3ZpZXcsIEFyY2dpc0xheWVyVmlld0Jyb3dzZUxheWVyIGFzIGFyY2dpc19sYXllcl92aWV3X2Jyb3dzZV9sYXllciwgQXJjZ2lzTGF5ZXJWaWV3Q3JlYXRlJDEgYXMgYXJjZ2lzX2xheWVyX3ZpZXdfY3JlYXRlLCBBcmNnaXNMYXllclZpZXdEZWZpbml0aW9uIGFzIGFyY2dpc19sYXllcl92aWV3X2RlZmluaXRpb24sIEFyY2dpc0xheWVyVmlldyBhcyBhcmNnaXNfbGF5ZXJfdmlld19qb2luLCBBcmNnaXNMYXllclZpZXdKb2luQWRkU2VsZWN0aW9uIGFzIGFyY2dpc19sYXllcl92aWV3X2pvaW5fYWRkX3NlbGVjdGlvbiwgQXJjZ2lzTGF5ZXJWaWV3Sm9pbkJyb3dzZUxheWVyIGFzIGFyY2dpc19sYXllcl92aWV3X2pvaW5fYnJvd3NlX2xheWVyLCBBcmNnaXNMYXllclZpZXdKb2luQ29uZmlnIGFzIGFyY2dpc19sYXllcl92aWV3X2pvaW5fY29uZmlnLCBBcmNnaXNMYXllclZpZXdKb2luQ3JlYXRlIGFzIGFyY2dpc19sYXllcl92aWV3X2pvaW5fY3JlYXRlLCBBcmNnaXNMYXllclZpZXdKb2luVGFyZ2V0U2VsZWN0aW9uIGFzIGFyY2dpc19sYXllcl92aWV3X2pvaW5fdGFyZ2V0X3NlbGVjdGlvbiwgQXJjZ2lzTGF5ZXJWaWV3Q3JlYXRlIGFzIGFyY2dpc19sYXllcl92aWV3X21zZywgQXJjZ2lzTGF5ZXJWaWV3T3ZlcnZpZXcgYXMgYXJjZ2lzX2xheWVyX3ZpZXdfb3ZlcnZpZXcsIEFyY2dpc0xheWVyVmlld1NlbGVjdGlvbiBhcyBhcmNnaXNfbGF5ZXJfdmlld19zZWxlY3Rpb24sIEFyY2dpc0xheWVyVmlld1N3YXBTb3VyY2UgYXMgYXJjZ2lzX2xheWVyX3ZpZXdfc3dhcF9zb3VyY2UgfTtcbiIsIi8qIVxuICogQWxsIG1hdGVyaWFsIGNvcHlyaWdodCBFU1JJLCBBbGwgUmlnaHRzIFJlc2VydmVkLCB1bmxlc3Mgb3RoZXJ3aXNlIHNwZWNpZmllZC5cbiAqIHYzLjAuOTlcbiAqL1xuLyoqXG4gKiBDYWxsIGEgZnVuY3Rpb24gb25seSBhZnRlciBpdCBoYXMgbm90IGJlZW4gY2FsbGVkIGZvciBuIG1pbGxpc2Vjb25kc1xuICogQHBhcmFtIGZuICAgIC0gZnVuY3Rpb24gdG8gY2FsbFxuICogQHBhcmFtIGRlbGF5IC0gZGVsYXkgaW4gbWlsbGlzZWNvbmRzXG4gKi9cbmNvbnN0IGRlYm91bmNlID0gKGZuLCBkZWxheSkgPT4ge1xuICBsZXQgdGltZW91dDtcbiAgbGV0IHN0YXR1cyA9IFwiaWRsZVwiO1xuICBmdW5jdGlvbiBmbHVzaCguLi5hcmdzKSB7XG4gICAgc3RhdHVzID0gXCJmbHVzaGVkXCI7XG4gICAgcmV0dXJuIGRlYm91bmNlZCguLi5hcmdzKTtcbiAgfVxuICBmdW5jdGlvbiBpbnZva2UoLi4uYXJncykge1xuICAgIHN0YXR1cyA9IFwiaW52b2tlZFwiO1xuICAgIHJldHVybiBkZWJvdW5jZWQoLi4uYXJncyk7XG4gIH1cbiAgZnVuY3Rpb24gY2FuY2VsKC4uLmFyZ3MpIHtcbiAgICBzdGF0dXMgPSBcImNhbmNlbGxlZFwiO1xuICAgIHJldHVybiBkZWJvdW5jZWQoLi4uYXJncyk7XG4gIH1cbiAgZnVuY3Rpb24gZ2V0U3RhdHVzKCkge1xuICAgIHJldHVybiBzdGF0dXM7XG4gIH1cbiAgY29uc3QgZGVib3VuY2VkID0gKC4uLmFyZ3MpID0+IG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7XG4gICAgc3dpdGNoIChzdGF0dXMpIHtcbiAgICAgIGNhc2UgXCJmbHVzaGVkXCI6XG4gICAgICAgIHN0YXR1cyA9IFwiaWRsZVwiO1xuICAgICAgICBpZiAodGltZW91dCkge1xuICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0KTtcbiAgICAgICAgICByZXNvbHZlKGZuKC4uLmFyZ3MpKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICByZXNvbHZlKG51bGwpO1xuICAgICAgICB9XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBcImludm9rZWRcIjpcbiAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXQpO1xuICAgICAgICBzdGF0dXMgPSBcImlkbGVcIjtcbiAgICAgICAgcmVzb2x2ZShmbiguLi5hcmdzKSk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBcImNhbmNlbGxlZFwiOlxuICAgICAgICBjbGVhclRpbWVvdXQodGltZW91dCk7XG4gICAgICAgIHN0YXR1cyA9IFwiaWRsZVwiO1xuICAgICAgICByZXNvbHZlKG51bGwpO1xuICAgICAgICBicmVhaztcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIGlmICh0aW1lb3V0KSB7XG4gICAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXQpO1xuICAgICAgICB9XG4gICAgICAgIHN0YXR1cyA9IFwicGVuZGluZ1wiO1xuICAgICAgICB0aW1lb3V0ID0gc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgc3RhdHVzID0gXCJpZGxlXCI7XG4gICAgICAgICAgcmV0dXJuIHJlc29sdmUoZm4oLi4uYXJncykpO1xuICAgICAgICB9LCBkZWxheSk7XG4gICAgICAgIGJyZWFrO1xuICAgIH1cbiAgfSk7XG4gIGRlYm91bmNlZC5mbHVzaCA9IGZsdXNoO1xuICBkZWJvdW5jZWQuaW52b2tlID0gaW52b2tlO1xuICBkZWJvdW5jZWQuY2FuY2VsID0gY2FuY2VsO1xuICBkZWJvdW5jZWQuZ2V0U3RhdHVzID0gZ2V0U3RhdHVzO1xuICByZXR1cm4gZGVib3VuY2VkO1xufTtcbi8qKlxuICogQ2FsbCBhIGZ1bmN0aW9uIG9ubHkgYWZ0ZXIgbiBtaWxsaXNlY29uZHMgaGF2ZSBlbGFwc2VkXG4gKiBAcGFyYW0gZm4gICAgLSBmdW5jdGlvbiB0byBjYWxsXG4gKiBAcGFyYW0gZGVsYXkgLSBkZWxheSBpbiBtaWxsaXNlY29uZHNcbiAqL1xuY29uc3QgdGhyb3R0bGUgPSAoZm4sIGRlbGF5KSA9PiB7XG4gIGxldCB0aW1lb3V0O1xuICByZXR1cm4gKC4uLmFyZ3MpID0+IG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7XG4gICAgaWYgKHRpbWVvdXQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGltZW91dCA9IHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXQpO1xuICAgICAgdGltZW91dCA9IHVuZGVmaW5lZDtcbiAgICAgIHJlc29sdmUoZm4oLi4uYXJncykpO1xuICAgIH0sIGRlbGF5KTtcbiAgfSk7XG59O1xuZnVuY3Rpb24gZXNjYXBlUmVnRXhwKHN0cikge1xuICByZXR1cm4gc3RyLnJlcGxhY2UoL1suKis/XiR7fSgpfFtcXF1cXFxcXS9nLCBcIlxcXFwkJlwiKTsgLy8gJCYgbWVhbnMgdGhlIHdob2xlIG1hdGNoZWQgc3RyaW5nXG59XG5mdW5jdGlvbiBpc0RlZmluZWQodmFsdWUpIHtcbiAgcmV0dXJuIHZhbHVlICE9PSB1bmRlZmluZWQgJiYgdmFsdWUgIT09IG51bGw7XG59XG4vKipcbiAqIFNldCBhIG1pbmltdW0gdGltZSBmb3IgYSBwcm9taXNlIHRvIHJlc29sdmUgKHVzZWZ1bCBmb3IgcHJldmVudGluZyBmbGFzaCBvZiBsb2FkZXJzKVxuICovXG5hc3luYyBmdW5jdGlvbiBtaW5EZWxheShwcm9taXNlLCBtaW5EZWxheSkge1xuICBhd2FpdCBQcm9taXNlLmFsbChbcHJvbWlzZSwgdGltZW91dChtaW5EZWxheSldKTtcbiAgcmV0dXJuIHByb21pc2U7XG59XG4vKipcbiAqIEhlbHBlciBtZXRob2QgdG8gaW5saW5lIHNldFRpbWVvdXQgYXMgYW4gYXdhaXQgaW4gYXN5bmMgZnVuY3Rpb25zXG4gKi9cbmZ1bmN0aW9uIHRpbWVvdXQobXMpIHtcbiAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIG1zKSk7XG59XG5jb25zdCBhcnJheVRvTG9va3VwTWFwID0gKGRhdGFBcnIsIGdldEtleUFuZEl0ZW0pID0+IE9iamVjdC5mcm9tRW50cmllcygoZGF0YUFyciB8fCBbXSkubWFwKChpdGVtKSA9PiB7XG4gIGNvbnN0IHsga2V5LCBkYXRhIH0gPSBnZXRLZXlBbmRJdGVtKGl0ZW0pO1xuICByZXR1cm4gW2tleSwgZGF0YV07XG59KSk7XG4vKipcbiAqIENoZWNrIHdoZXRoZXIgdHdvIGFycmF5cyBoYXZlIHRoZSBzYW1lIG51bWJlciBvZiBlbGVtZW50c1xuICogYW5kIHdoZXRoZXIgdGhleSBjb250YWluIHRoZSBzYW1lIGVsZW1lbnRzXG4gKiByZWdhcmRsZXNzIG9mIG9yZGVyXG4gKi9cbmNvbnN0IGFycmF5c0FyZUVxdWl2YWxlbnQgPSAoYXJyMSwgYXJyMikgPT4gYXJyMS5sZW5ndGggPT09IGFycjIubGVuZ3RoICYmIGFycjEucmVkdWNlKChtZW1vLCBzdHIpID0+IG1lbW8gJiYgYXJyMi5pbmRleE9mKHN0cikgPiAtMSwgdHJ1ZSk7XG5mdW5jdGlvbiB1bmlxdWVCeShteUFyciwgZ2V0SXRlbUlkKSB7XG4gIGNvbnN0IHJlc3VsdEFyciA9IFtdO1xuICBjb25zdCBsb29rdXBNYXAgPSB7fTtcbiAgbXlBcnIuZm9yRWFjaCgoaXRlbSkgPT4ge1xuICAgIGNvbnN0IGlkID0gZ2V0SXRlbUlkKGl0ZW0pO1xuICAgIGlmIChsb29rdXBNYXBbaWRdID09IG51bGwpIHtcbiAgICAgIGxvb2t1cE1hcFtpZF0gPSBpdGVtO1xuICAgICAgcmVzdWx0QXJyLnB1c2goaXRlbSk7XG4gICAgfVxuICB9KTtcbiAgcmV0dXJuIHJlc3VsdEFycjtcbn1cbmZ1bmN0aW9uIHVuaXF1ZShteUFycikge1xuICBjb25zdCBwcmltaXRpdmVzID0geyBib29sZWFuOiB7fSwgbnVtYmVyOiB7fSwgc3RyaW5nOiB7fSB9O1xuICBjb25zdCBvYmpzID0gW107XG4gIHJldHVybiBteUFyci5maWx0ZXIoKGl0ZW0pID0+IHtcbiAgICBsZXQgdHlwZSA9IHR5cGVvZiBpdGVtO1xuICAgIGlmICh0eXBlIGluIHByaW1pdGl2ZXMpIHtcbiAgICAgIHJldHVybiBwcmltaXRpdmVzW3R5cGVdLmhhc093blByb3BlcnR5KGl0ZW0pID8gZmFsc2UgOiAocHJpbWl0aXZlc1t0eXBlXVtpdGVtXSA9IHRydWUpO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgIHJldHVybiBvYmpzLmluZGV4T2YoaXRlbSkgPj0gMCA/IGZhbHNlIDogb2Jqcy5wdXNoKGl0ZW0pO1xuICAgIH1cbiAgfSk7XG59XG5jb25zdCBjaHVuayA9IChhcnIsIHNpemUpID0+IFsuLi5BcnJheShNYXRoLmNlaWwoYXJyLmxlbmd0aCAvIHNpemUpKV0ubWFwKChfLCBpKSA9PiBhcnIuc2xpY2Uoc2l6ZSAqIGksIHNpemUgKyBzaXplICogaSkpO1xuXG5leHBvcnQgeyBhcnJheVRvTG9va3VwTWFwIGFzIGEsIHVuaXF1ZSBhcyBiLCB0aHJvdHRsZSBhcyBjLCBkZWJvdW5jZSBhcyBkLCBlc2NhcGVSZWdFeHAgYXMgZSwgYXJyYXlzQXJlRXF1aXZhbGVudCBhcyBmLCBjaHVuayBhcyBnLCBpc0RlZmluZWQgYXMgaSwgbWluRGVsYXkgYXMgbSwgdGltZW91dCBhcyB0LCB1bmlxdWVCeSBhcyB1IH07XG4iLCIvKiFcbiAqIEFsbCBtYXRlcmlhbCBjb3B5cmlnaHQgRVNSSSwgQWxsIFJpZ2h0cyBSZXNlcnZlZCwgdW5sZXNzIG90aGVyd2lzZSBzcGVjaWZpZWQuXG4gKiB2My4wLjk5XG4gKi9cbmltcG9ydCB7IGcgYXMgZ2V0UmVuZGVyaW5nUmVmLCBmIGFzIGZvcmNlVXBkYXRlIH0gZnJvbSAnLi9pbmRleC05MmViYjM5Ni5qcyc7XG5cbmNvbnN0IGFwcGVuZFRvTWFwID0gKG1hcCwgcHJvcE5hbWUsIHZhbHVlKSA9PiB7XG4gICAgY29uc3QgaXRlbXMgPSBtYXAuZ2V0KHByb3BOYW1lKTtcbiAgICBpZiAoIWl0ZW1zKSB7XG4gICAgICAgIG1hcC5zZXQocHJvcE5hbWUsIFt2YWx1ZV0pO1xuICAgIH1cbiAgICBlbHNlIGlmICghaXRlbXMuaW5jbHVkZXModmFsdWUpKSB7XG4gICAgICAgIGl0ZW1zLnB1c2godmFsdWUpO1xuICAgIH1cbn07XG5jb25zdCBkZWJvdW5jZSA9IChmbiwgbXMpID0+IHtcbiAgICBsZXQgdGltZW91dElkO1xuICAgIHJldHVybiAoLi4uYXJncykgPT4ge1xuICAgICAgICBpZiAodGltZW91dElkKSB7XG4gICAgICAgICAgICBjbGVhclRpbWVvdXQodGltZW91dElkKTtcbiAgICAgICAgfVxuICAgICAgICB0aW1lb3V0SWQgPSBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgIHRpbWVvdXRJZCA9IDA7XG4gICAgICAgICAgICBmbiguLi5hcmdzKTtcbiAgICAgICAgfSwgbXMpO1xuICAgIH07XG59O1xuXG4vKipcbiAqIENoZWNrIGlmIGEgcG9zc2libGUgZWxlbWVudCBpc0Nvbm5lY3RlZC5cbiAqIFRoZSBwcm9wZXJ0eSBtaWdodCBub3QgYmUgdGhlcmUsIHNvIHdlIGNoZWNrIGZvciBpdC5cbiAqXG4gKiBXZSB3YW50IGl0IHRvIHJldHVybiB0cnVlIGlmIGlzQ29ubmVjdGVkIGlzIG5vdCBhIHByb3BlcnR5LFxuICogb3RoZXJ3aXNlIHdlIHdvdWxkIHJlbW92ZSB0aGVzZSBlbGVtZW50cyBhbmQgd291bGQgbm90IHVwZGF0ZS5cbiAqXG4gKiBCZXR0ZXIgbGVhayBpbiBFZGdlIHRoYW4gdG8gYmUgdXNlbGVzcy5cbiAqL1xuY29uc3QgaXNDb25uZWN0ZWQgPSAobWF5YmVFbGVtZW50KSA9PiAhKCdpc0Nvbm5lY3RlZCcgaW4gbWF5YmVFbGVtZW50KSB8fCBtYXliZUVsZW1lbnQuaXNDb25uZWN0ZWQ7XG5jb25zdCBjbGVhbnVwRWxlbWVudHMgPSBkZWJvdW5jZSgobWFwKSA9PiB7XG4gICAgZm9yIChsZXQga2V5IG9mIG1hcC5rZXlzKCkpIHtcbiAgICAgICAgbWFwLnNldChrZXksIG1hcC5nZXQoa2V5KS5maWx0ZXIoaXNDb25uZWN0ZWQpKTtcbiAgICB9XG59LCAyMDAwKTtcbmNvbnN0IHN0ZW5jaWxTdWJzY3JpcHRpb24gPSAoKSA9PiB7XG4gICAgaWYgKHR5cGVvZiBnZXRSZW5kZXJpbmdSZWYgIT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgLy8gSWYgd2UgYXJlIG5vdCBpbiBhIHN0ZW5jaWwgcHJvamVjdCwgd2UgZG8gbm90aGluZy5cbiAgICAgICAgLy8gVGhpcyBmdW5jdGlvbiBpcyBub3QgcmVhbGx5IGV4cG9ydGVkIGJ5IEBzdGVuY2lsL2NvcmUuXG4gICAgICAgIHJldHVybiB7fTtcbiAgICB9XG4gICAgY29uc3QgZWxtc1RvVXBkYXRlID0gbmV3IE1hcCgpO1xuICAgIHJldHVybiB7XG4gICAgICAgIGRpc3Bvc2U6ICgpID0+IGVsbXNUb1VwZGF0ZS5jbGVhcigpLFxuICAgICAgICBnZXQ6IChwcm9wTmFtZSkgPT4ge1xuICAgICAgICAgICAgY29uc3QgZWxtID0gZ2V0UmVuZGVyaW5nUmVmKCk7XG4gICAgICAgICAgICBpZiAoZWxtKSB7XG4gICAgICAgICAgICAgICAgYXBwZW5kVG9NYXAoZWxtc1RvVXBkYXRlLCBwcm9wTmFtZSwgZWxtKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgICAgc2V0OiAocHJvcE5hbWUpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGVsZW1lbnRzID0gZWxtc1RvVXBkYXRlLmdldChwcm9wTmFtZSk7XG4gICAgICAgICAgICBpZiAoZWxlbWVudHMpIHtcbiAgICAgICAgICAgICAgICBlbG1zVG9VcGRhdGUuc2V0KHByb3BOYW1lLCBlbGVtZW50cy5maWx0ZXIoZm9yY2VVcGRhdGUpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNsZWFudXBFbGVtZW50cyhlbG1zVG9VcGRhdGUpO1xuICAgICAgICB9LFxuICAgICAgICByZXNldDogKCkgPT4ge1xuICAgICAgICAgICAgZWxtc1RvVXBkYXRlLmZvckVhY2goKGVsbXMpID0+IGVsbXMuZm9yRWFjaChmb3JjZVVwZGF0ZSkpO1xuICAgICAgICAgICAgY2xlYW51cEVsZW1lbnRzKGVsbXNUb1VwZGF0ZSk7XG4gICAgICAgIH0sXG4gICAgfTtcbn07XG5cbmNvbnN0IHVud3JhcCA9ICh2YWwpID0+ICh0eXBlb2YgdmFsID09PSAnZnVuY3Rpb24nID8gdmFsKCkgOiB2YWwpO1xuY29uc3QgY3JlYXRlT2JzZXJ2YWJsZU1hcCA9IChkZWZhdWx0U3RhdGUsIHNob3VsZFVwZGF0ZSA9IChhLCBiKSA9PiBhICE9PSBiKSA9PiB7XG4gICAgY29uc3QgdW53cmFwcGVkU3RhdGUgPSB1bndyYXAoZGVmYXVsdFN0YXRlKTtcbiAgICBsZXQgc3RhdGVzID0gbmV3IE1hcChPYmplY3QuZW50cmllcyh1bndyYXBwZWRTdGF0ZSAhPT0gbnVsbCAmJiB1bndyYXBwZWRTdGF0ZSAhPT0gdm9pZCAwID8gdW53cmFwcGVkU3RhdGUgOiB7fSkpO1xuICAgIGNvbnN0IGhhbmRsZXJzID0ge1xuICAgICAgICBkaXNwb3NlOiBbXSxcbiAgICAgICAgZ2V0OiBbXSxcbiAgICAgICAgc2V0OiBbXSxcbiAgICAgICAgcmVzZXQ6IFtdLFxuICAgIH07XG4gICAgY29uc3QgcmVzZXQgPSAoKSA9PiB7XG4gICAgICAgIHZhciBfYTtcbiAgICAgICAgLy8gV2hlbiByZXNldHRpbmcgdGhlIHN0YXRlLCB0aGUgZGVmYXVsdCBzdGF0ZSBtYXkgYmUgYSBmdW5jdGlvbiAtIHVud3JhcCBpdCB0byBpbnZva2UgaXQuXG4gICAgICAgIC8vIG90aGVyd2lzZSwgdGhlIHN0YXRlIHdvbid0IGJlIHByb3Blcmx5IHJlc2V0XG4gICAgICAgIHN0YXRlcyA9IG5ldyBNYXAoT2JqZWN0LmVudHJpZXMoKF9hID0gdW53cmFwKGRlZmF1bHRTdGF0ZSkpICE9PSBudWxsICYmIF9hICE9PSB2b2lkIDAgPyBfYSA6IHt9KSk7XG4gICAgICAgIGhhbmRsZXJzLnJlc2V0LmZvckVhY2goKGNiKSA9PiBjYigpKTtcbiAgICB9O1xuICAgIGNvbnN0IGRpc3Bvc2UgPSAoKSA9PiB7XG4gICAgICAgIC8vIENhbGwgZmlyc3QgZGlzcG9zZSBhcyByZXNldHRpbmcgdGhlIHN0YXRlIHdvdWxkXG4gICAgICAgIC8vIGNhdXNlIGxlc3MgdXBkYXRlcyA7KVxuICAgICAgICBoYW5kbGVycy5kaXNwb3NlLmZvckVhY2goKGNiKSA9PiBjYigpKTtcbiAgICAgICAgcmVzZXQoKTtcbiAgICB9O1xuICAgIGNvbnN0IGdldCA9IChwcm9wTmFtZSkgPT4ge1xuICAgICAgICBoYW5kbGVycy5nZXQuZm9yRWFjaCgoY2IpID0+IGNiKHByb3BOYW1lKSk7XG4gICAgICAgIHJldHVybiBzdGF0ZXMuZ2V0KHByb3BOYW1lKTtcbiAgICB9O1xuICAgIGNvbnN0IHNldCA9IChwcm9wTmFtZSwgdmFsdWUpID0+IHtcbiAgICAgICAgY29uc3Qgb2xkVmFsdWUgPSBzdGF0ZXMuZ2V0KHByb3BOYW1lKTtcbiAgICAgICAgaWYgKHNob3VsZFVwZGF0ZSh2YWx1ZSwgb2xkVmFsdWUsIHByb3BOYW1lKSkge1xuICAgICAgICAgICAgc3RhdGVzLnNldChwcm9wTmFtZSwgdmFsdWUpO1xuICAgICAgICAgICAgaGFuZGxlcnMuc2V0LmZvckVhY2goKGNiKSA9PiBjYihwcm9wTmFtZSwgdmFsdWUsIG9sZFZhbHVlKSk7XG4gICAgICAgIH1cbiAgICB9O1xuICAgIGNvbnN0IHN0YXRlID0gKHR5cGVvZiBQcm94eSA9PT0gJ3VuZGVmaW5lZCdcbiAgICAgICAgPyB7fVxuICAgICAgICA6IG5ldyBQcm94eSh1bndyYXBwZWRTdGF0ZSwge1xuICAgICAgICAgICAgZ2V0KF8sIHByb3BOYW1lKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGdldChwcm9wTmFtZSk7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgb3duS2V5cyhfKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIEFycmF5LmZyb20oc3RhdGVzLmtleXMoKSk7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKCkge1xuICAgICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgICAgIGVudW1lcmFibGU6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGhhcyhfLCBwcm9wTmFtZSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBzdGF0ZXMuaGFzKHByb3BOYW1lKTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBzZXQoXywgcHJvcE5hbWUsIHZhbHVlKSB7XG4gICAgICAgICAgICAgICAgc2V0KHByb3BOYW1lLCB2YWx1ZSk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICB9LFxuICAgICAgICB9KSk7XG4gICAgY29uc3Qgb24gPSAoZXZlbnROYW1lLCBjYWxsYmFjaykgPT4ge1xuICAgICAgICBoYW5kbGVyc1tldmVudE5hbWVdLnB1c2goY2FsbGJhY2spO1xuICAgICAgICByZXR1cm4gKCkgPT4ge1xuICAgICAgICAgICAgcmVtb3ZlRnJvbUFycmF5KGhhbmRsZXJzW2V2ZW50TmFtZV0sIGNhbGxiYWNrKTtcbiAgICAgICAgfTtcbiAgICB9O1xuICAgIGNvbnN0IG9uQ2hhbmdlID0gKHByb3BOYW1lLCBjYikgPT4ge1xuICAgICAgICBjb25zdCB1blNldCA9IG9uKCdzZXQnLCAoa2V5LCBuZXdWYWx1ZSkgPT4ge1xuICAgICAgICAgICAgaWYgKGtleSA9PT0gcHJvcE5hbWUpIHtcbiAgICAgICAgICAgICAgICBjYihuZXdWYWx1ZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICAvLyBXZSBuZWVkIHRvIHVud3JhcCB0aGUgZGVmYXVsdFN0YXRlIGJlY2F1c2UgaXQgbWlnaHQgYmUgYSBmdW5jdGlvbi5cbiAgICAgICAgLy8gT3RoZXJ3aXNlIHdlIG1pZ2h0IG5vdCBiZSBzZW5kaW5nIHRoZSByaWdodCByZXNldCB2YWx1ZS5cbiAgICAgICAgY29uc3QgdW5SZXNldCA9IG9uKCdyZXNldCcsICgpID0+IGNiKHVud3JhcChkZWZhdWx0U3RhdGUpW3Byb3BOYW1lXSkpO1xuICAgICAgICByZXR1cm4gKCkgPT4ge1xuICAgICAgICAgICAgdW5TZXQoKTtcbiAgICAgICAgICAgIHVuUmVzZXQoKTtcbiAgICAgICAgfTtcbiAgICB9O1xuICAgIGNvbnN0IHVzZSA9ICguLi5zdWJzY3JpcHRpb25zKSA9PiB7XG4gICAgICAgIGNvbnN0IHVuc3VicyA9IHN1YnNjcmlwdGlvbnMucmVkdWNlKCh1bnN1YnMsIHN1YnNjcmlwdGlvbikgPT4ge1xuICAgICAgICAgICAgaWYgKHN1YnNjcmlwdGlvbi5zZXQpIHtcbiAgICAgICAgICAgICAgICB1bnN1YnMucHVzaChvbignc2V0Jywgc3Vic2NyaXB0aW9uLnNldCkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHN1YnNjcmlwdGlvbi5nZXQpIHtcbiAgICAgICAgICAgICAgICB1bnN1YnMucHVzaChvbignZ2V0Jywgc3Vic2NyaXB0aW9uLmdldCkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHN1YnNjcmlwdGlvbi5yZXNldCkge1xuICAgICAgICAgICAgICAgIHVuc3Vicy5wdXNoKG9uKCdyZXNldCcsIHN1YnNjcmlwdGlvbi5yZXNldCkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHN1YnNjcmlwdGlvbi5kaXNwb3NlKSB7XG4gICAgICAgICAgICAgICAgdW5zdWJzLnB1c2gob24oJ2Rpc3Bvc2UnLCBzdWJzY3JpcHRpb24uZGlzcG9zZSkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHVuc3VicztcbiAgICAgICAgfSwgW10pO1xuICAgICAgICByZXR1cm4gKCkgPT4gdW5zdWJzLmZvckVhY2goKHVuc3ViKSA9PiB1bnN1YigpKTtcbiAgICB9O1xuICAgIGNvbnN0IGZvcmNlVXBkYXRlID0gKGtleSkgPT4ge1xuICAgICAgICBjb25zdCBvbGRWYWx1ZSA9IHN0YXRlcy5nZXQoa2V5KTtcbiAgICAgICAgaGFuZGxlcnMuc2V0LmZvckVhY2goKGNiKSA9PiBjYihrZXksIG9sZFZhbHVlLCBvbGRWYWx1ZSkpO1xuICAgIH07XG4gICAgcmV0dXJuIHtcbiAgICAgICAgc3RhdGUsXG4gICAgICAgIGdldCxcbiAgICAgICAgc2V0LFxuICAgICAgICBvbixcbiAgICAgICAgb25DaGFuZ2UsXG4gICAgICAgIHVzZSxcbiAgICAgICAgZGlzcG9zZSxcbiAgICAgICAgcmVzZXQsXG4gICAgICAgIGZvcmNlVXBkYXRlLFxuICAgIH07XG59O1xuY29uc3QgcmVtb3ZlRnJvbUFycmF5ID0gKGFycmF5LCBpdGVtKSA9PiB7XG4gICAgY29uc3QgaW5kZXggPSBhcnJheS5pbmRleE9mKGl0ZW0pO1xuICAgIGlmIChpbmRleCA+PSAwKSB7XG4gICAgICAgIGFycmF5W2luZGV4XSA9IGFycmF5W2FycmF5Lmxlbmd0aCAtIDFdO1xuICAgICAgICBhcnJheS5sZW5ndGgtLTtcbiAgICB9XG59O1xuXG5jb25zdCBjcmVhdGVTdG9yZSA9IChkZWZhdWx0U3RhdGUsIHNob3VsZFVwZGF0ZSkgPT4ge1xuICAgIGNvbnN0IG1hcCA9IGNyZWF0ZU9ic2VydmFibGVNYXAoZGVmYXVsdFN0YXRlLCBzaG91bGRVcGRhdGUpO1xuICAgIG1hcC51c2Uoc3RlbmNpbFN1YnNjcmlwdGlvbigpKTtcbiAgICByZXR1cm4gbWFwO1xufTtcblxuZXhwb3J0IHsgY3JlYXRlU3RvcmUgYXMgYyB9O1xuIiwiLyohXG4gKiBBbGwgbWF0ZXJpYWwgY29weXJpZ2h0IEVTUkksIEFsbCBSaWdodHMgUmVzZXJ2ZWQsIHVubGVzcyBvdGhlcndpc2Ugc3BlY2lmaWVkLlxuICogdjMuMC45OVxuICovXG5pbXBvcnQgeyBjIGFzIGNyZWF0ZVN0b3JlIH0gZnJvbSAnLi9pbmRleC04MWQ1NDhiNy5qcyc7XG5cbmNvbnN0IGl0ZW1Qcm9wZXJ0aWVzU3RvcmUgPSBjcmVhdGVTdG9yZSh7XG4gIHRpdGxlOiBcIlwiLFxuICBzbmlwcGV0OiBcIlwiLFxuICB0YWdzOiBbXSxcbiAgY2F0ZWdvcmllczogW11cbn0pO1xuY29uc3QgaXRlbVByb3BlcnRpZXNTdGF0ZSA9IGl0ZW1Qcm9wZXJ0aWVzU3RvcmUuc3RhdGU7XG5cbmV4cG9ydCB7IGl0ZW1Qcm9wZXJ0aWVzU3RvcmUgYXMgYSwgaXRlbVByb3BlcnRpZXNTdGF0ZSBhcyBpIH07XG4iLCIvKiFcbiAqIEFsbCBtYXRlcmlhbCBjb3B5cmlnaHQgRVNSSSwgQWxsIFJpZ2h0cyBSZXNlcnZlZCwgdW5sZXNzIG90aGVyd2lzZSBzcGVjaWZpZWQuXG4gKiB2My4wLjk5XG4gKi9cbnZhciBsb2NhbFN0b3JhZ2VLZXlzO1xuKGZ1bmN0aW9uIChsb2NhbFN0b3JhZ2VLZXlzKSB7XG4gIGxvY2FsU3RvcmFnZUtleXNbXCJBUkNHSVNfQ09NUE9ORU5UX05PVElGSUNBVElPTlNcIl0gPSBcImFyY2dpc0NvbXBvbmVudF9ub3RpZmljYXRpb25zXCI7XG59KShsb2NhbFN0b3JhZ2VLZXlzIHx8IChsb2NhbFN0b3JhZ2VLZXlzID0ge30pKTtcbnZhciBhcmNnaXNDb21wb25lbnROb3RpZmljYXRpb25zS2V5cztcbihmdW5jdGlvbiAoYXJjZ2lzQ29tcG9uZW50Tm90aWZpY2F0aW9uc0tleXMpIHtcbiAgYXJjZ2lzQ29tcG9uZW50Tm90aWZpY2F0aW9uc0tleXNbXCJGRUFUVVJFX1JFRFVDVElPTl9XQVJOSU5HX0RJU01JU1NFRFwiXSA9IFwiYXJjZ2lzX2ZlYXR1cmVfcmVkdWN0aW9uX3dhcm5pbmdfZGlzbWlzc2VkXCI7XG4gIGFyY2dpc0NvbXBvbmVudE5vdGlmaWNhdGlvbnNLZXlzW1wiUE9QVVBfV0FSTklOR19ESVNNSVNTRURcIl0gPSBcImFyY2dpc19wb3B1cF93YXJuaW5nX2Rpc21pc3NlZFwiO1xuICBhcmNnaXNDb21wb25lbnROb3RpZmljYXRpb25zS2V5c1tcIklOQ09NUEFUSUJMRV9WRUNUT1JfU1lNQk9MU19ESVNNSVNTRURcIl0gPSBcImFyY2dpc19zeW1ib2xfc3R5bGVyX2luY29tcGF0aWJsZV92ZWN0b3Jfc3ltYm9sc19kaXNtaXNzZWRcIjtcbiAgYXJjZ2lzQ29tcG9uZW50Tm90aWZpY2F0aW9uc0tleXNbXCJFRkZFQ1RTX1RJUF9ESVNNSVNTRURcIl0gPSBcImFyY2dpc19lZmZlY3RzX3RpcF9kaXNtaXNzZWRcIjtcbiAgYXJjZ2lzQ29tcG9uZW50Tm90aWZpY2F0aW9uc0tleXNbXCJMQVlFUl9WSUVXX0RFRklOSVRJT05fRElTTUlTU0VEXCJdID0gXCJhcmNnaXNfbGF5ZXJfdmlld19kZWZpbml0aW9uX2Rpc21pc3NlZFwiO1xuICBhcmNnaXNDb21wb25lbnROb3RpZmljYXRpb25zS2V5c1tcIkxBWUVSX09WRVJSSURFX1NUQVRVU19USVBfRElTTUlTU0VEXCJdID0gXCJhcmNnaXNfbGF5ZXJfb3ZlcnJpZGVfc3RhdHVzX3RpcF9kaXNtaXNzZWRcIjtcbiAgYXJjZ2lzQ29tcG9uZW50Tm90aWZpY2F0aW9uc0tleXNbXCJMQVlFUl9WSUVXX0pPSU5fVElQX0RJU01JU1NFRFwiXSA9IFwiYXJjZ2lzX2xheWVyX3ZpZXdfam9pbl90aXBfZGlzbWlzc2VkXCI7XG4gIGFyY2dpc0NvbXBvbmVudE5vdGlmaWNhdGlvbnNLZXlzW1wiTVVMVElESU1FTlNJT05BTF9JTkZPX1RJUF9ESVNNSVNTRURcIl0gPSBcImFyY2dpc19tdWx0aWRpbWVuc2lvbmFsX2luZm9fdGlwX2Rpc21pc3NlZFwiO1xufSkoYXJjZ2lzQ29tcG9uZW50Tm90aWZpY2F0aW9uc0tleXMgfHwgKGFyY2dpc0NvbXBvbmVudE5vdGlmaWNhdGlvbnNLZXlzID0ge30pKTtcbmNvbnN0IGdldExvY2FsU3RvcmFnZSA9IChsb2NhbFN0b3JhZ2VLZXkpID0+IHtcbiAgcmV0dXJuIGxvY2FsU3RvcmFnZS5nZXRJdGVtKGxvY2FsU3RvcmFnZUtleSk7XG59O1xuY29uc3Qgc2V0TG9jYWxTdG9yYWdlID0gKGxvY2FsU3RvcmFnZUtleSwgdmFsdWUpID0+IHtcbiAgbG9jYWxTdG9yYWdlLnNldEl0ZW0obG9jYWxTdG9yYWdlS2V5LCB2YWx1ZSk7XG59O1xuY29uc3QgZ2V0T2JqZWN0TG9jYWxTdG9yYWdlID0gKGxvY2FsU3RvcmFnZUtleSkgPT4ge1xuICByZXR1cm4gSlNPTi5wYXJzZShnZXRMb2NhbFN0b3JhZ2UobG9jYWxTdG9yYWdlS2V5KSkgfHwge307XG59O1xuY29uc3Qgc2V0U2luZ2xlT2JqZWN0TG9jYWxTdG9yYWdlID0gKGxvY2FsU3RvcmFnZUtleSwga2V5VmFsdWVPYmplY3QpID0+IHtcbiAgY29uc3Qgc2V0TG9jYWxTdG9yYWdlVmFsID0gZ2V0T2JqZWN0TG9jYWxTdG9yYWdlKGxvY2FsU3RvcmFnZUtleSk7XG4gIHNldExvY2FsU3RvcmFnZVZhbFtrZXlWYWx1ZU9iamVjdC5rZXldID0ga2V5VmFsdWVPYmplY3QudmFsdWU7XG4gIHNldExvY2FsU3RvcmFnZShsb2NhbFN0b3JhZ2VLZXksIEpTT04uc3RyaW5naWZ5KHNldExvY2FsU3RvcmFnZVZhbCkpO1xufTtcbmNvbnN0IGdldFNpbmdsZU9iamVjdExvY2FsU3RvcmFnZSA9IChsb2NhbFN0b3JhZ2VLZXksIG9iamVjdEtleSkgPT4ge1xuICBjb25zdCBnZXRMb2NhbFN0b3JhZ2VWYWwgPSBnZXRPYmplY3RMb2NhbFN0b3JhZ2UobG9jYWxTdG9yYWdlS2V5KTtcbiAgaWYgKGdldExvY2FsU3RvcmFnZVZhbCA9PT0gbnVsbCB8fCBnZXRMb2NhbFN0b3JhZ2VWYWwgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGdldExvY2FsU3RvcmFnZVZhbC5oYXNPd25Qcm9wZXJ0eShvYmplY3RLZXkpKSB7XG4gICAgcmV0dXJuIGdldExvY2FsU3RvcmFnZVZhbFtvYmplY3RLZXldO1xuICB9XG4gIGVsc2Uge1xuICAgIHJldHVybiBudWxsO1xuICB9XG59O1xuXG5leHBvcnQgeyBhcmNnaXNDb21wb25lbnROb3RpZmljYXRpb25zS2V5cyBhcyBhLCBnZXRTaW5nbGVPYmplY3RMb2NhbFN0b3JhZ2UgYXMgZywgbG9jYWxTdG9yYWdlS2V5cyBhcyBsLCBzZXRTaW5nbGVPYmplY3RMb2NhbFN0b3JhZ2UgYXMgcyB9O1xuIiwiLyohXG4gKiBBbGwgbWF0ZXJpYWwgY29weXJpZ2h0IEVTUkksIEFsbCBSaWdodHMgUmVzZXJ2ZWQsIHVubGVzcyBvdGhlcndpc2Ugc3BlY2lmaWVkLlxuICogdjMuMC45OVxuICovXG5pbXBvcnQgeyBjIGFzIGNsb3Nlc3RFbGVtZW50Q3Jvc3NTaGFkb3dCb3VuZGFyeSB9IGZyb20gJy4vZG9tLTEzZjViMDBjLmpzJztcbmltcG9ydCB7IGwgYXMgbGFuZ3VhZ2VNYXAgfSBmcm9tICcuL2xhbmd1YWdlVXRpbC0yMjI1OGM5MC5qcyc7XG5pbXBvcnQgeyBhIGFzIGdldEFzc2V0UGF0aCB9IGZyb20gJy4vaW5kZXgtOTJlYmIzOTYuanMnO1xuXG4vLyBodHRwczovL21lZGl1bS5jb20vc3RlbmNpbC10cmlja3MvaW1wbGVtZW50aW5nLWludGVybmF0aW9uYWxpc2F0aW9uLWkxOG4td2l0aC1zdGVuY2lsLTVlNjU1OTU1NDExN1xuZnVuY3Rpb24gZ2V0Q29tcG9uZW50Q2xvc2VzdExhbmd1YWdlKGVsZW1lbnQpIHtcbiAgdmFyIF9hLCBfYiwgX2M7XG4gIGNvbnN0IGNsb3Nlc3RFbGVtZW50ID0gKF9hID0gY2xvc2VzdEVsZW1lbnRDcm9zc1NoYWRvd0JvdW5kYXJ5KGVsZW1lbnQsIFwiW2xhbmddXCIpKSAhPT0gbnVsbCAmJiBfYSAhPT0gdm9pZCAwID8gX2EgOiAoX2MgPSAoX2IgPSBlbGVtZW50LnNoYWRvd1Jvb3QpID09PSBudWxsIHx8IF9iID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYi5vd25lckRvY3VtZW50KSA9PT0gbnVsbCB8fCBfYyA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2MuZG9jdW1lbnRFbGVtZW50O1xuICAvLyBsYW5ndWFnZSBzZXQgYnkgdGhlIGNhbGxpbmcgYXBwbGljYXRpb24gb3IgYnJvd3Nlci4gZGVmYXVsdHMgdG8gZW5nbGlzaC5cbiAgY29uc3QgbGFuZyA9ICgoY2xvc2VzdEVsZW1lbnQgPT09IG51bGwgfHwgY2xvc2VzdEVsZW1lbnQgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGNsb3Nlc3RFbGVtZW50LmxhbmcpIHx8IChuYXZpZ2F0b3IgPT09IG51bGwgfHwgbmF2aWdhdG9yID09PSB2b2lkIDAgPyB2b2lkIDAgOiBuYXZpZ2F0b3IubGFuZ3VhZ2UpIHx8IFwiZW5cIikudG9Mb3dlckNhc2UoKTtcbiAgaWYgKGxhbmd1YWdlTWFwLmhhcyhsYW5nKSkge1xuICAgIHJldHVybiBsYW5ndWFnZU1hcC5nZXQobGFuZyk7XG4gIH1cbiAgZWxzZSB7XG4gICAgLy8gXCJydS1SVVwiIG1hcHMgdG8gXCJydVwiIHVzZSBjYXNlXG4gICAgaWYgKGxhbmd1YWdlTWFwLmhhcyhsYW5nLnNsaWNlKDAsIDIpKSkge1xuICAgICAgcmV0dXJuIGxhbmd1YWdlTWFwLmdldChsYW5nLnNsaWNlKDAsIDIpKTtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICByZXR1cm4gXCJlblwiO1xuICAgIH1cbiAgfVxufVxuZnVuY3Rpb24gZ2V0Q29tcG9uZW50Q2xvc2VzdExhbmd1YWdlSW50bChlbGVtZW50KSB7XG4gIHZhciBfYSwgX2IsIF9jO1xuICAvLyBpdCdzIE9LIGlmIHdlIGRvbid0IGhhdmUgdGhlIDQgbGV0dGVyIGxhbmd1YWdlIGZpbGUgZm9yIGl0XG4gIC8vIDQgbGV0dGVyIGxhbmd1YWdlIGNvZGUgbmVlZGVkIGZvciBmb3JtYXR0aW5nIG51bWJlcnNcbiAgY29uc3QgY2xvc2VzdEVsZW1lbnQgPSAoX2EgPSBjbG9zZXN0RWxlbWVudENyb3NzU2hhZG93Qm91bmRhcnkoZWxlbWVudCwgXCJbbGFuZ11cIikpICE9PSBudWxsICYmIF9hICE9PSB2b2lkIDAgPyBfYSA6IChfYyA9IChfYiA9IGVsZW1lbnQuc2hhZG93Um9vdCkgPT09IG51bGwgfHwgX2IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9iLm93bmVyRG9jdW1lbnQpID09PSBudWxsIHx8IF9jID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYy5kb2N1bWVudEVsZW1lbnQ7XG4gIC8vIGxhbmd1YWdlIHNldCBieSB0aGUgY2FsbGluZyBhcHBsaWNhdGlvbiBvciBicm93c2VyLiBkZWZhdWx0cyB0byBlbmdsaXNoLlxuICBjb25zdCBsYW5nID0gKChjbG9zZXN0RWxlbWVudCA9PT0gbnVsbCB8fCBjbG9zZXN0RWxlbWVudCA9PT0gdm9pZCAwID8gdm9pZCAwIDogY2xvc2VzdEVsZW1lbnQubGFuZykgfHwgKG5hdmlnYXRvciA9PT0gbnVsbCB8fCBuYXZpZ2F0b3IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG5hdmlnYXRvci5sYW5ndWFnZSkgfHwgXCJlblwiKS50b0xvd2VyQ2FzZSgpO1xuICBpZiAobGFuZ3VhZ2VNYXAuaGFzKGxhbmcpKSB7XG4gICAgcmV0dXJuIGxhbmd1YWdlTWFwLmdldChsYW5nKTtcbiAgfVxuICBlbHNlIHtcbiAgICBpZiAobGFuZ3VhZ2VNYXAuaGFzKGxhbmcuc2xpY2UoMCwgMikpKSB7XG4gICAgICAvLyB3ZSBzdXBwb3J0IHRoZSAyIGxldHRlciBjb2RlZCBsYW5ndWFnZVxuICAgICAgLy8gZS5nLiBpdC1DSCB2cyBpdFxuICAgICAgcmV0dXJuIGxhbmc7XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgcmV0dXJuIFwiZW5cIjtcbiAgICB9XG4gIH1cbn1cbmZ1bmN0aW9uIGZldGNoTG9jYWxlU3RyaW5nc0ZvckNvbXBvbmVudChjb21wb25lbnROYW1lLCBsb2NhbGUpIHtcbiAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICBmZXRjaChnZXRBc3NldFBhdGgoYC4uL2FyY2dpcy1hcHAtYXNzZXRzL2kxOG4vJHtjb21wb25lbnROYW1lfS5pMThuLiR7bG9jYWxlfS5qc29uYCkpLnRoZW4oKHJlc3VsdCkgPT4ge1xuICAgICAgaWYgKHJlc3VsdC5vaylcbiAgICAgICAgcmVzb2x2ZShyZXN1bHQuanNvbigpKTtcbiAgICAgIGVsc2VcbiAgICAgICAgcmVqZWN0KCk7XG4gICAgfSwgKCkgPT4gcmVqZWN0KCkpO1xuICB9KTtcbn1cbmNvbnN0IHN0cmluZ0NhY2hlID0ge307XG5mdW5jdGlvbiBmZXRjaExvY2FsZVN0cmluZ3NGcm9tQ2FjaGUoY29tcG9uZW50TmFtZSwgbG9jYWxlKSB7XG4gIGNvbnN0IGlkID0gYCR7Y29tcG9uZW50TmFtZX0ke2xvY2FsZX1gO1xuICBpZiAoIXN0cmluZ0NhY2hlW2lkXSkge1xuICAgIHN0cmluZ0NhY2hlW2lkXSA9IGZldGNoTG9jYWxlU3RyaW5nc0ZvckNvbXBvbmVudChjb21wb25lbnROYW1lLCBsb2NhbGUpO1xuICB9XG4gIHJldHVybiBzdHJpbmdDYWNoZVtpZF07XG59XG4vKipcbiAqIEdldCBzdHJpbmdzIGFuZCBsYW5ndWFnZSBjb2Rlcy5cbiAqIFRoaXMgbWV0aG9kIHJldHVybnMgMiBsYW5ndWFnZSBjb2Rlcy5cbiAqIFRoZSBmaXJzdCBvbmUgcmV0dXJucyBhIGNvZGUgdGhhdCdzIGFsc28gc3VwcG9ydGVkIGFzIGEgbGFuZ3VhZ2UgZmlsZS5cbiAqIFRoZSBzZWNvbmQgb25lIHJldHVybnMgYSBjb2RlIHdoZXJlIHRoZXJlIGlzIHN1cHBvcnQgZm9yIHRoZSBmaXJzdCAyIGxldHRlcnMgb2YgdGhlIGNvZGUgYXMgcGFydCBvZiBhIGxhbmd1YWdlIGZpbGUsXG4gKiBidXQgd2lsbCByZXR1cm4gdGhlIG9yaWdpbmFsIDQgbGV0dGVyIGNvZGUgZnJvbSB0aGUgcGFnZS5cbiAqIEUuZy4gRm9yIFwiaXQtY2hcIiBpdCB3aWxsIHJldHVybiBcIml0XCIgYXMgdGhlIGZpcnN0IGxhbmd1YWdlIGNvZGUgYW5kIFwiaXQtY2hcIiBhcyB0aGUgc2Vjb25kLlxuICogVGhlIHNlY29uZCBvbmUgaXMgcmVxdWlyZWQgZm9yIGVzcmkuaW50bC5zZXRMb2NhbGUoKSB0byBnZXQgdGhlIGNvcnJlY3QgZm9ybWF0dGluZy5cbiAqXG4gKiBJZiBhIHRhZ05hbWUgaXMgcHJvdmlkZWQgaXQgd2lsbCBvdmVyd2l0ZSB0aGUgZWxlbWVudCdzIHRhZ05hbWVcbiAqXG4gKiAgQHJldHVybiBbIHN0cmluZ3MsIGZpcnN0IGxhbmd1YWdlIGNvZGUsIHNlY29uZCBsYW5ndWFnZSBjb2RlXVxuICovXG5hc3luYyBmdW5jdGlvbiBnZXRMb2NhbGVDb21wb25lbnRTdHJpbmdzKGVsZW1lbnQsIHRhZ05hbWUpIHtcbiAgY29uc3QgY29tcG9uZW50TmFtZSA9IHRhZ05hbWUgfHwgZWxlbWVudC50YWdOYW1lLnRvTG93ZXJDYXNlKCk7XG4gIGNvbnN0IGNvbXBvbmVudExhbmd1YWdlID0gZ2V0Q29tcG9uZW50Q2xvc2VzdExhbmd1YWdlKGVsZW1lbnQpO1xuICBjb25zdCBjb21wb25lbnRMYW5ndWFnZUludGwgPSBnZXRDb21wb25lbnRDbG9zZXN0TGFuZ3VhZ2VJbnRsKGVsZW1lbnQpO1xuICBsZXQgc3RyaW5ncztcbiAgdHJ5IHtcbiAgICBzdHJpbmdzID0gYXdhaXQgZmV0Y2hMb2NhbGVTdHJpbmdzRnJvbUNhY2hlKGNvbXBvbmVudE5hbWUsIGNvbXBvbmVudExhbmd1YWdlKTtcbiAgfVxuICBjYXRjaCAoZSkge1xuICAgIGNvbnNvbGUud2Fybihgbm8gbG9jYWxlIGZvciAke2NvbXBvbmVudE5hbWV9ICgke2NvbXBvbmVudExhbmd1YWdlfSkgbG9hZGluZyBkZWZhdWx0IGxvY2FsZSBlbi5gKTtcbiAgICBzdHJpbmdzID0gYXdhaXQgZmV0Y2hMb2NhbGVTdHJpbmdzRnJvbUNhY2hlKGNvbXBvbmVudE5hbWUsIFwiZW5cIik7XG4gIH1cbiAgcmV0dXJuIFtzdHJpbmdzLCBjb21wb25lbnRMYW5ndWFnZSwgY29tcG9uZW50TGFuZ3VhZ2VJbnRsXTtcbn1cblxuZXhwb3J0IHsgZ2V0Q29tcG9uZW50Q2xvc2VzdExhbmd1YWdlIGFzIGEsIGdldExvY2FsZUNvbXBvbmVudFN0cmluZ3MgYXMgZyB9O1xuIiwiLyohXG4gKiBBbGwgbWF0ZXJpYWwgY29weXJpZ2h0IEVTUkksIEFsbCBSaWdodHMgUmVzZXJ2ZWQsIHVubGVzcyBvdGhlcndpc2Ugc3BlY2lmaWVkLlxuICogdjMuMC45OVxuICovXG5mdW5jdGlvbiBnZXRQb3J0YWxCYXNlVXJsKHBvcnRhbCkge1xuICBjb25zdCB7IGN1c3RvbUJhc2VVcmwsIHBvcnRhbEhvc3RuYW1lLCB1cmxLZXkgfSA9IHBvcnRhbDtcbiAgY29uc3QgeyBwcm90b2NvbCB9ID0gd2luZG93LmxvY2F0aW9uO1xuICBjb25zdCB1cmwgPSB1cmxLZXkgPyBgJHt1cmxLZXl9LiR7Y3VzdG9tQmFzZVVybH1gIDogcG9ydGFsSG9zdG5hbWU7XG4gIHJldHVybiBgJHtwcm90b2NvbH0vLyR7dXJsfWA7XG59XG5cbmV4cG9ydCB7IGdldFBvcnRhbEJhc2VVcmwgYXMgZyB9O1xuIl0sIm5hbWVzIjpbXSwic291cmNlUm9vdCI6IiJ9
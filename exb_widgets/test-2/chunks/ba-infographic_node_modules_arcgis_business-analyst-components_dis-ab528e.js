"use strict";
(self["webpackChunkexb_client"] = self["webpackChunkexb_client"] || []).push([["vendors-extensions_widgets_ba-infographic_node_modules_arcgis_business-analyst-components_dis-ab528e"],{

/***/ "./extensions/widgets/ba-infographic/node_modules/@arcgis/business-analyst-components/dist/stencil-components/dist/esm/GEClient-f71049f8.js":
/*!**************************************************************************************************************************************************!*\
  !*** ./extensions/widgets/ba-infographic/node_modules/@arcgis/business-analyst-components/dist/stencil-components/dist/esm/GEClient-f71049f8.js ***!
  \**************************************************************************************************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   E: () => (/* binding */ Environments),
/* harmony export */   G: () => (/* binding */ GEClient),
/* harmony export */   S: () => (/* binding */ SettingsHelper),
/* harmony export */   T: () => (/* binding */ TokenProvider)
/* harmony export */ });
/* harmony import */ var _ElementIds_a2c40592_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./ElementIds-a2c40592.js */ "./extensions/widgets/ba-infographic/node_modules/@arcgis/business-analyst-components/dist/stencil-components/dist/esm/ElementIds-a2c40592.js");


class TokenProvider {
  /**
   * todo: implement real method
   *
   * @return {Promise<unknown>}
   */
  static getToken() {
    return new Promise((resolve) => {
      resolve(TokenProvider.token.access_token);
    });
  }
  static setToken(username, token) {
    if (username && username.length > 0 && token && token.length > 0) {
      this.token.access_token = token;
      this.token.username = username;
    }
  }
}
TokenProvider.token = {
  access_token: '',
  expires_in: null,
  persist: 'true',
  ssl: 'true',
  username: 'mark_ba'
};

/** Environments
 *
 *  This class provides support for environments and subdomains
 *  PortalUrl - can be overriden for enterprise environments
 *  GeocoderUrl - can be overriden
 *  GeoenrichmentUrl - can be overriden
 */
class Environments {
  static setEnvironment(env) {
    let e = (env === 'prod' || env === 'localhost') ? 'www' : env;
    Environments._env = e;
    // Logz.show('%g', 'BA Environment: ' + e)
  }
  static getEnvironment() {
    return Environments._env;
  }
  static setPortalUrl(portalUrl) {
    Environments.portalUrl = portalUrl;
  }
  static setGeoenrichmentUrl(geUrl) {
    Environments.geoenrichmentUrl = geUrl;
  }
  static setGeocodeUrl(geocodeUrl) {
    Environments.geocodeUrl = geocodeUrl;
  }
  static getPortalBase() {
    // Optional, if PortalUrl has been explicitly set/overriden use it
    if (Environments.portalUrl) {
      return Environments.portalUrl;
    }
    const e = Environments._env;
    if (!e)
      return '';
    const subdomain = e === 'dev' ? 'devext' : e === 'qa' ? 'qaext' : 'www';
    let url = 'https://' + subdomain + '.arcgis.com';
    // Logz.show('%g','BA Environments base=' + url)
    return url;
  }
  /**
   * Returns appropriate request URL for the subdomain
   *
   * @param subDomain - one of 'geocode', 'arcgis', or 'geoenrich'
   */
  static getUrl(subDomain) {
    if (!Environments._env) {
      _ElementIds_a2c40592_js__WEBPACK_IMPORTED_MODULE_0__.L.show('%e', 'Environments error: env not set');
      return '';
    }
    if (!subDomain || !_ElementIds_a2c40592_js__WEBPACK_IMPORTED_MODULE_0__.U.hasText(subDomain)) {
      _ElementIds_a2c40592_js__WEBPACK_IMPORTED_MODULE_0__.L.show('%e', 'Environments error: invalid subdomain');
      return '';
    }
    const portal = Environments.getPortalBase();
    if (portal === '')
      return '';
    try {
      let url = '';
      switch (subDomain) {
        case ('geocode'): {
          // Optional, if GeocodeUrl has been explicitly set/overriden use it
          if (Environments.geocodeUrl) {
            url = Environments.geocodeUrl;
            break;
          }
          else {
            url =
              (Environments._env === 'qa') ? 'https://geocodeqa.arcgis.com/arcgis/rest/services/World/GeocodeServer' :
                (Environments._env === 'dev') ? 'https://geocodedev.arcgis.com/arcgis/rest/services/World/GeocodeServer' :
                  'https://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer';
            break;
          }
        }
        case ('arcgis'): {
          url = portal;
          break;
        }
        case ('infographics'): {
          url =
            (Environments._env === 'qa') ? 'https://baoqa.arcgis.com/InfographicsPlayer/BAMobile/23.R03/reportPlayer/ReportPlayerMobile.html' :
              (Environments._env === 'dev') ? 'https://baodev.arcgis.com/InfographicsPlayer/BAMobile/23.R03/reportPlayer/ReportPlayerMobile.html' :
                'https://bao.arcgis.com/InfographicsPlayer/BAMobile/23.R03/reportPlayer/ReportPlayerMobile.html';
          break;
        }
        case ('geoenrich'): {
          // Optional, if GeoenrichmentUrl has been explicitly set/overriden use it
          if (Environments.geoenrichmentUrl) {
            url = Environments.geoenrichmentUrl;
            break;
          }
          else {
            url =
              (Environments._env === 'qa') ? 'https://geoenrichqa.arcgis.com/arcgis/rest/services/World/geoenrichmentserver' :
                (Environments._env === 'dev') ? 'https://geoenrichdev.arcgis.com/arcgis/rest/services/World/geoenrichmentserver' :
                  'https://geoenrich.arcgis.com/arcgis/rest/services/World/geoenrichmentserver';
          }
          break;
        }
      }
      return url;
    }
    catch (ex) {
      _ElementIds_a2c40592_js__WEBPACK_IMPORTED_MODULE_0__.L.show('%e', 'Environments.getUrl() error ', ex);
    }
    return '';
  }
  // Returns true if the geocodeUrl string passed in is the online Geocoder Service (dev, qa, prod), false otherwise
  static isOnlineGeocoder(geocodeUrl) {
    if (geocodeUrl.toLowerCase().startsWith('https://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer'.toLowerCase()) ||
      geocodeUrl.toLowerCase().startsWith('https://geocodeqa.arcgis.com/arcgis/rest/services/World/GeocodeServer'.toLowerCase()) ||
      geocodeUrl.toLowerCase().startsWith('https://geocodedev.arcgis.com/arcgis/rest/services/World/GeocodeServer'.toLowerCase())) {
      return true;
    }
    return false;
  }
  // Returns true if the portalUrl string passed in is the online Portal (dev, qa, prod), false otherwise
  static isAGOPortal(portalUrl) {
    if (portalUrl.toLowerCase().startsWith('https://www.arcgis.com'.toLowerCase()) ||
      portalUrl.toLowerCase().startsWith('https://qaext.arcgis.com'.toLowerCase()) ||
      portalUrl.toLowerCase().startsWith('https://devext.arcgis.com'.toLowerCase())) {
      return true;
    }
    return false;
  }
}
Environments._env = 'www';
// Optional, ability to override portalUrl
Environments.portalUrl = '';
// Optional, ability to override geoenrichment URL
Environments.geoenrichmentUrl = '';
// Optional, ability to override geocode URL
Environments.geocodeUrl = '';

class ArcGISClient {
  static executeSelf() {
    return new Promise((resolve, reject) => {
      TokenProvider.getToken().then((accessToken) => {
        if (accessToken === ArcGISClient._lastSelfToken) {
          resolve(ArcGISClient._selfResult);
        }
        else {
          let settings = {
            taskPath: '/portals/self',
            data: {
              culture: 'en-us' // todo: get actual locale
            }
          };
          ArcGISClient.executeRequest(settings).then(response => {
            //caching response from "/self" with token as key
            ArcGISClient._lastSelfToken = accessToken;
            ArcGISClient._selfResult = response;
            resolve(response);
          })
            .catch(err => {
            ArcGISClient._lastSelfToken = '';
            ArcGISClient._selfResult = '';
            reject(err);
          });
        }
      })
        .catch(err => reject(err));
    });
  }
  static getGeoenrichmentUrl() {
    return Environments.getUrl('geoenrich');
  }
  static getHelperServiceUrl(serviceName) {
    return new Promise((resolve, reject) => {
      ArcGISClient.executeSelf().then(function (selfResult) {
        let helperServices = selfResult.helperServices;
        if (helperServices) {
          let helperService = helperServices[serviceName];
          if (helperService) {
            let urlString = Array.isArray(helperService) ? helperService[0].url : helperService.url;
            urlString ? resolve(urlString) : reject(serviceName + ' helper service is not configured.');
          }
          else
            reject(serviceName + ' helper service is not configured.');
        }
        else
          reject('Helper services are not configured.');
      }).catch(err => reject(err));
    });
  }
  static getPortalResource(resourceName) {
    return ArcGISClient.executeRequest({
      taskPath: '/portals/self/resources/' + resourceName
    });
  }
  static getItemData(itemId) {
    return ArcGISClient.executeRequest({
      taskPath: '/content/items/' + itemId + '/data'
    });
  }
  /**
   * Searches for items by provided search query and params and extracts all search results
   * bypassing ArcGIS server limit of 100 items
   *
   * @param query
   * @param params
   * @returns {Promise<unknown>}
   */
  static searchAllItems(query, params) {
    return new Promise((resolve, reject) => {
      let searchResults = [];
      let self = this;
      let _doSearch = function (query, params, context) {
        self.searchItems(query, params, context).then(function (result) {
          if (result.items.length)
            searchResults = searchResults.concat(result.items);
          let newContext = result.context;
          if (newContext.nextStart > 0)
            _doSearch(query, params, newContext);
          else
            resolve(searchResults);
        }, function (err) {
          if (searchResults && searchResults.length)
            resolve(searchResults);
          else
            reject(err);
        });
      };
      _doSearch(query, params, null);
    });
  }
  static searchItems(query, params, context) {
    return new Promise((resolve, reject) => {
      // do deep copy, instead of $j.extend({}, params)
      let searchParams = params ? JSON.parse(JSON.stringify(params)) : {};
      if (context) {
        searchParams.q = params.q;
        let total = context.total;
        let nextStart = context.nextStart;
        if (total && nextStart) {
          if (nextStart > 0 && total >= nextStart)
            searchParams.start = nextStart;
          else
            resolve({ items: [], context: context });
        }
        if (context.sortField && context.sortOrder) {
          searchParams.sortOrder = context.sortOrder;
          searchParams.sortField = context.sortField;
        }
        // $j.ajaxSetup({
        //     global: false
        // });
      }
      else {
        let queryParts = [];
        Object.getOwnPropertyNames(query).forEach(function (key) {
          queryParts.push(key + ':"' + query[key] + '"');
        });
        if (queryParts.length)
          searchParams.q = queryParts.join(' AND ');
      }
      ArcGISClient.portalSearch(searchParams).then((searchResponse) => {
        // $j.ajaxSetup({
        //     global: true
        // });
        let resultItems = searchResponse.results;
        let ctx = {
          query: searchResponse.query,
          total: searchResponse.total,
          nextStart: searchResponse.nextStart,
          sortOrder: null,
          sortField: null
        };
        if (searchParams.sortOrder && searchParams.sortField) {
          ctx.sortOrder = searchParams.sortOrder;
          ctx.sortField = searchParams.sortField;
        }
        resolve({ items: resultItems, context: ctx });
      }).catch(reject);
    });
  }
  /// methods from BA.arcGISRequests
  static portalSearch(params) {
    return ArcGISClient.executeRequest({
      taskPath: '/search',
      data: params
    });
  }
  static async getPortalUrl() {
    return Environments.getUrl('arcgis') + '/sharing/rest';
  }
  static executeRequest(settings) {
    //settings:
    // {
    //     "data": {
    //     "num": 1000,
    //         "q": "type:\"Report Template\" typekeywords:esriWebStandardInfographicReport owner:esri_reports",
    //         "sortField": "title",
    //         "sortOrder": "asc",
    //         "start": 1
    //     },
    //     "taskPath": "/search"
    // }
    return new Promise((resolve, reject) => {
      TokenProvider.getToken().then(async (access_token) => {
        if (!settings.data)
          settings.data = {};
        // todo: use default params with ability to override them
        if (!settings.data.f)
          settings.data.f = 'json';
        settings.data.token = access_token ? access_token : settings.data.token;
        if (!settings.data.token) {
          delete settings.data.token;
        }
        settings.data.langCode = settings.data?.langCode ? settings.data.langCode : 'en-us'; // todo: update
        //todo: timeout: 30000 ms - need to implement via timer and AbortController
        const formData = new FormData();
        for (let key in settings.data)
          formData.append(key, settings.data[key]);
        let url;
        if (Object.prototype.hasOwnProperty.call(settings, 'url')) {
          url = settings.url;
        }
        else {
          url = await ArcGISClient.getPortalUrl();
        }
        //let url = settings.url || ArcGISClient.getPortalUrl();
        if (settings.taskPath)
          url = url + settings.taskPath;
        let params = {};
        // Standard Geography query is handled differently
        // Need to add charset=UTF-8 to Content-Type request header
        if (settings.isStandardGeoQuery) {
          const requestHeaders = new Headers();
          requestHeaders.append('Content-Type', 'application/x-www-form-urlencoded; charset=UTF-8');
          let bodyData = '';
          let booleanFirst = true;
          for (const key in settings.data) {
            bodyData += booleanFirst ? '' : '&';
            bodyData += key + '=' + encodeURI(settings.data[key]);
            booleanFirst = false;
          }
          params = {
            method: 'POST',
            body: bodyData,
            headers: requestHeaders
          };
        }
        else {
          params = {
            method: 'POST',
            body: formData
          };
        }
        fetch(url, params).then(response => {
          if (!response.ok)
            throw new Error('Network response ended with error.');
          // todo: check if response is string?
          return settings.data.f === 'bin' ? response.blob() : response.json();
        }).then(result => {
          // ArcGIS returns error with HTTP 2xx code, so handle it here
          result.error ? reject(result.error) : resolve(result);
        }).catch(error => {
          console.error('Error:', error);
          reject(error);
        });
      }).catch(err => reject(err));
    });
  }
}

class WebAppSettings {
  static getBusinessAnalystOrganizationalSettings() {
    return ArcGISClient.getPortalResource('BusinessAnalyst_Organizational_Settings.json');
  }
  static getDisabledReports() {
    return new Promise((resolve) => {
      let emptyResolveOnErr = (err) => {
        resolve({});
        _ElementIds_a2c40592_js__WEBPACK_IMPORTED_MODULE_0__.L.show('%e', 'WebAppSettings error', err);
      };
      ArcGISClient.executeSelf().then((selfResponse) => {
        let roleId = selfResponse.user.roleId || selfResponse.user.role;
        WebAppSettings.getBusinessAnalystOrganizationalSettings().then((settings) => {
          let disabledReports = settings['userRoles.disabledAreas.reports'];
          if (disabledReports && disabledReports[roleId])
            resolve(disabledReports[roleId]);
          else
            resolve({});
        }).catch(emptyResolveOnErr);
      }).catch(emptyResolveOnErr);
    });
  }
  /**
   * Gets ids of infographic templates that user added to "My Templates" from "Gallery"
   * (uses new version of user settings)
   *
   * @returns {*}
   */
  static getUserGalleryInfographicReportIds() {
    return new Promise((resolve, reject) => {
      WebAppSettings._searchGalleryInfographicPreferencesItem().then((galleryPrefItem) => {
        if (!galleryPrefItem) {
          reject(null);
          return;
        }
        // assuming "properties": {"inData": "true"},
        let itemId = galleryPrefItem.id;
        ArcGISClient.getItemData(itemId).then((itemData) => {
          resolve(itemData &&
            itemData.data &&
            itemData.data.myGalleryInfographicReportIds);
        }).catch(err => reject(err));
      }).catch(err => reject(err));
    });
  }
  static _searchGalleryInfographicPreferencesItem() {
    return WebAppSettings._searchUserItem('esriFavoriteReportTemplates');
  }
  static _searchUserItem(typekeywords) {
    return new Promise((resolve, reject) => {
      ArcGISClient.executeSelf().then((selfResponse) => {
        let username = selfResponse.user.username;
        let query = {
          type: 'Web Mapping Application',
          typekeywords: typekeywords,
          owner: username
        };
        let params = { num: 1 };
        ArcGISClient.searchItems(query, params, undefined).then((items) => {
          resolve(items && items.length && items[0]);
        }).catch(err => reject(err));
      }).catch(err => reject(err));
    });
  }
}

class SettingsHelper {
  static getEnvironment() {
    return new Promise((resolve) => {
      resolve(Environments.getEnvironment());
    });
  }
  static setEnvironment(environment) {
    if (environment && environment.length > 0) {
      Environments.setEnvironment(environment);
    }
    else {
      _ElementIds_a2c40592_js__WEBPACK_IMPORTED_MODULE_0__.L.show('%e', 'ba-reports error: setEnvironment() invalid arg');
    }
  }
  static async getPortalBaseUrl() {
    return Environments.getUrl('arcgis');
  }
  static isTrueString(value) {
    return String(value).toLowerCase() === 'true';
  }
}

class ReportTemplatesManager {
  static _condenseResultsArray(data) {
    // simplify
    const arr = data.map((obj) => {
      return { id: obj.id, title: obj.title, date: obj.modified };
    });
    // remove duplicates by title
    const names = arr.map((a) => a.title);
    const result = arr.filter((obj, index) => {
      return names.indexOf(obj.title) == index;
    });
    return result;
  }
  static _condenseResultsArrayGEInfographics(data) {
    // simplify
    let date, t1, t2;
    const arr = data.map((obj) => {
      try {
        if (obj.metadata.lastRevisionDate) {
          t2 = obj.metadata.lastRevisionDate;
        }
        if (obj.metadata.creationDate) {
          t1 = obj.metadata.creationDate;
        }
        if (t1) {
          if (!t2) {
            date = t1;
          }
          else {
            date = (t2 > t1) ? t2 : t1;
          }
        }
      }
      catch (ex) {
        console.log('ReportTemplatesManager error', ex);
      }
      return { id: obj.itemID, title: obj.metadata.title, date: date };
    });
    // remove duplicates by title
    const names = arr.map((a) => a.title);
    const result = arr.filter((obj, index) => {
      return names.indexOf(obj.title) == index;
    });
    return result;
  }
  /**
   * Gets report templates for country identified by country code. Final report
   * templates set consists of templates from GeoEnrichment and from AGOL
   *
   * @param countryCode Only 2-letter countryCode! todo: consume 3-letter also
   * @param full        Flag True=return all data, False=return Id + Title only
   * @return {Promise<unknown>}
   */
  static getReportTemplates(countryCode, full = false) {
    return new Promise((resolve, reject) => {
      let reportTemplates = {
        ge: undefined,
        shared: undefined,
        user: undefined,
        favoriteIds: undefined
      };
      ArcGISClient.executeSelf()
        .then((selfResponse) => {
        let username = selfResponse.user.username;
        Promise.allSettled([
          // ReportTemplatesManager._getGEReportTemplates(countryCode),
          ReportTemplatesManager._getSharedCustomReportTemplateItems(username),
          ReportTemplatesManager._getMyCustomReportTemplateItems(username),
          ReportTemplatesManager._getFavoriteReportsIds(username, countryCode)
        ]).then((res) => {
          reportTemplates.ge = res[0].value ? res[0].value : [];
          reportTemplates.shared = ReportTemplatesManager._createReportTemplateInfos(res[1] && res[1].value ? res[1].value : [], countryCode);
          reportTemplates.user = ReportTemplatesManager._createReportTemplateInfos(res[2] && res[2].value ? res[2].value : [], countryCode);
          reportTemplates.favoriteIds =
            res[3] && res[3].value ? res[3].value : [];
          WebAppSettings.getDisabledReports()
            .then((disabledReports) => {
            let ge = reportTemplates.ge;
            let shared = reportTemplates.shared;
            if (ge != null) {
              reportTemplates.ge = ge.filter((template) => {
                return !disabledReports[template.reportID];
              });
              if (shared != null) {
                reportTemplates.shared = shared.filter((template) => {
                  return !disabledReports[template.reportID.itemid];
                });
              }
            }
            if (!full) {
              reportTemplates.ge = ReportTemplatesManager._condenseResultsArray(reportTemplates.ge);
              reportTemplates.shared = ReportTemplatesManager._condenseResultsArray(reportTemplates.shared);
              reportTemplates.user = ReportTemplatesManager._condenseResultsArray(reportTemplates.user);
              reportTemplates.favoriteIds = ReportTemplatesManager._condenseResultsArray(reportTemplates.favoriteIds);
              resolve(reportTemplates);
            }
            else {
              resolve(reportTemplates);
            }
          })
            .catch((err) => reject(err));
        });
      })
        .catch((err) => reject(err));
    });
  }
  static _getGEReportTemplates(countryCode) {
    return new Promise((resolve, reject) => {
      // todo: store templates in country instance: country.reportTemplates;
      let reportTemplates = ReportTemplatesManager._geReportTemplatesCache[countryCode];
      if (reportTemplates) {
        resolve(reportTemplates);
        return;
      }
      GEClient.execute({ taskPath: '/GeoEnrichment/Reports/' + countryCode })
        .then((reportTemplatesResponse) => {
        let reportTemplates = reportTemplatesResponse.reports;
        ReportTemplatesManager._geReportTemplatesCache[countryCode] = reportTemplates;
        resolve(reportTemplates);
      })
        .catch(reject);
    });
  }
  static _getSharedCustomReportTemplateItems(username) {
    let query = 'type:"Report Template" (access:shared OR access:org) typekeywords:(esriWebReport NOT esriWebInfographicReport) NOT owner:' +
      username;
    return ReportTemplatesManager._searchItems(query, ReportTemplatesManager._removeInfographicTemplates);
  }
  static _getMyCustomReportTemplateItems(username) {
    let query = 'type:"Report Template" typekeywords:(esriWebReport NOT esriWebInfographicReport) owner:' +
      username;
    return ReportTemplatesManager._searchItems(query, ReportTemplatesManager._removeInfographicTemplates);
  }
  static _removeInfographicTemplates(reportTemplateItem) {
    return !SettingsHelper.isTrueString(reportTemplateItem.properties.isGraphicReport);
  }
  /**
   *
   * @param countryCode Only 2-letter countryCode! todo: consume 3-letter also
   * @return {Promise<unknown>}
   */
  static getInfographicReportTemplateItems(countryCode, full = false, token) {
    return new Promise(async (resolve, reject) => {
      let infographicItems = {
        public: undefined,
        shared: undefined,
        user: undefined,
        favoriteIds: undefined,
        gallery: undefined
      };
      const defaultHierarchy = await GEClient.getGEDefaultHierarchy(countryCode, token);
      ArcGISClient.executeSelf()
        .then((selfResponse) => {
        let username = selfResponse.user.username;
        let orgId = selfResponse.user.orgId;
        // let countryCode = country.id;
        Promise.allSettled([
          ReportTemplatesManager._getEsriInfographicReportTemplateItems(countryCode),
          ReportTemplatesManager._getSharedInfographicReportTemplateItems(username, orgId),
          ReportTemplatesManager._getUserInfographicReportTemplateItems(username),
          ReportTemplatesManager._getFavoriteReportsIds(username, countryCode),
          ReportTemplatesManager._getGalleryInfographicReportTemplateItems()
          //
        ]).then((res) => {
          let byCountryAndDefaultHiearchy = ReportTemplatesManager._byCountryAndDefaultHiearchy(countryCode, defaultHierarchy);
          infographicItems.public = res[0].value
            ? res[0].value.filter(byCountryAndDefaultHiearchy)
            : [];
          infographicItems.shared = res[1].value
            ? res[1].value.filter(byCountryAndDefaultHiearchy)
            : [];
          infographicItems.user = res[2].value
            ? res[2].value.filter(byCountryAndDefaultHiearchy)
            : [];
          // infographicItems.public = infographicItems.public
          //   ? res[0].value.filter (byDefaultHierarchy)
          //   : []
          // infographicItems.shared = res[1].value
          //   ? res[1].value.filter (byDefaultHierarchy)
          //   : []
          // infographicItems.user = res[2].value
          //   ? res[2].value.filter (byDefaultHierarchy)
          //   : []
          infographicItems.favoriteIds = res[3].value ? res[3].value : [];
          infographicItems.gallery = res[4].value
            ? res[4].value.filter(byCountryAndDefaultHiearchy)
            : [];
          let user = infographicItems.user;
          if (user != null) {
            // sort alphabetically by title
            user.sort(function (item1, item2) {
              return item1.title.localeCompare(item2.title);
            });
          }
          WebAppSettings.getDisabledReports()
            .then((disabledReports) => {
            let filterDisabled = function (igItem) {
              return !disabledReports[igItem.id];
            };
            let pub = infographicItems.public;
            if (pub != null) {
              infographicItems.public = pub.filter(filterDisabled);
            }
            let shared = infographicItems.shared;
            if (shared != null) {
              infographicItems.shared = shared.filter(filterDisabled);
            }
            let gallery = infographicItems.gallery;
            if (gallery != null) {
              infographicItems.gallery = gallery.filter(filterDisabled);
            }
            if (!full) {
              infographicItems.public = ReportTemplatesManager._condenseResultsArrayGEInfographics(infographicItems.public);
              infographicItems.shared = ReportTemplatesManager._condenseResultsArray(infographicItems.shared);
              infographicItems.user = ReportTemplatesManager._condenseResultsArray(infographicItems.user);
              infographicItems.favoriteIds = ReportTemplatesManager._condenseResultsArray(infographicItems.favoriteIds);
              infographicItems.gallery = ReportTemplatesManager._condenseResultsArray(infographicItems.gallery);
              resolve(infographicItems);
            }
            else {
              resolve(infographicItems);
            }
          })
            .catch((err) => reject(err));
        });
      })
        .catch((err) => reject(err));
    });
  }
  /**
   * Gets function to filter portal items arrays by country code in its properties
   *
   * @param countryCode country code that item's 'countries' array should contain
   * @returns {function(*): boolean}
   */
  static _byCountryAndDefaultHiearchy(countryCode, defaultHierarchy) {
    return function (item) {
      let countries = (item && item.properties && item.properties.countries.toLowerCase()) || (item && item.metadata && item.metadata.countries.toLowerCase());
      let hierarchies = (item && item.properties && item.properties.hierarchy) || (item && item.metadata && item.metadata.hierarchy);
      return countries && countries.indexOf(countryCode.toLowerCase()) >= 0 && hierarchies && hierarchies.indexOf(defaultHierarchy) >= 0;
    };
  }
  // static _byDefaultHierarchy (defaultHierarchy: string) {
  //   return function (item: any) {
  //     let hierarchies = item && item.properties && item.properties.hierarchy
  //     if (hierarchies && hierarchies.indexOf(defaultHierarchy) >= 0)
  //       return true
  //     else
  //       return false
  //   }
  // }
  static _getEsriInfographicReportTemplateItems(countryCode) {
    return GEClient.execute({ taskPath: '/GeoEnrichment/Infographics/Standard/' + countryCode })
      .then((reportTemplatesResponse) => {
      let reportTemplates = reportTemplatesResponse.reports;
      return reportTemplates;
    });
  }
  static _getSharedInfographicReportTemplateItems(username, orgId) {
    let query = 'type:"Report Template" ' +
      '(access:shared OR access:org OR (access:public AND orgid:' +
      orgId +
      ')) ' +
      ' typekeywords:esriWebInfographicReport ' +
      ' NOT owner:' +
      username;
    return ReportTemplatesManager._searchItems(query, ReportTemplatesManager._infographicFilter);
  }
  static _getGalleryInfographicReportTemplateItems() {
    let query = 'type:"Report Template" ' +
      ' typekeywords:esriWebGalleryInfographicReport ' +
      ' owner:(esri_reports OR esri_reports_test)';
    return ReportTemplatesManager._searchItems(query, ReportTemplatesManager._infographicFilter, {
      start: 1,
      num: 1000,
      sortField: 'modified',
      sortOrder: 'desc',
      q: query
    });
  }
  static _getUserInfographicReportTemplateItems(username) {
    return new Promise((resolve, reject) => {
      let query = 'type:"Report Template"' +
        ' typekeywords:esriWebInfographicReport ' +
        ' owner:' +
        username;
      let userIgDeferred = ReportTemplatesManager._searchItems(query, ReportTemplatesManager._infographicFilter);
      let userGalleryIgDeferred = ReportTemplatesManager._getUserGalleryInfographicReportTemplateItems();
      Promise.allSettled([userIgDeferred, userGalleryIgDeferred]).then((res) => {
        let userIgItems = res[0].value ? res[0].value : [];
        let userGalleryIgItems = res[1].value ? res[1].value : [];
        resolve(userIgItems.concat(userGalleryIgItems));
      }, (rejected) => {
        reject(rejected);
      });
    });
  }
  static _getFavoriteReportsIds(username, countryId) {
    return new Promise((resolve, reject) => {
      let query = 'type:"Web Mapping Application" typekeywords:"BAUserData.FavoriteReports" owner:' +
        username;
      ReportTemplatesManager._searchItems(query, null)
        .then((favoriteReportsItems) => {
        let favReportsItem = favoriteReportsItems && favoriteReportsItems[0];
        if (!favReportsItem) {
          resolve([]); //no favorite reports
          return;
        }
        ArcGISClient.getItemData(favReportsItem.id)
          .then((itemData) => {
          if (!itemData) {
            resolve([]); //no favorite reports
            return;
          }
          let favReportsInfos = itemData.data && itemData.data['favorites' + countryId];
          if (!favReportsInfos) {
            resolve([]); //no favorite reports
            return;
          }
          let ret = favReportsInfos.map(function (info) {
            return info.reportID;
          });
          resolve(ret);
        })
          .catch((err) => reject(err));
      })
        .catch((err) => reject(err));
    });
  }
  /**
   * Gets infographic templates that user added to "My Templates" from "Gallery"
   *
   * @returns {*}
   * @private
   */
  static _getUserGalleryInfographicReportTemplateItems() {
    return new Promise((resolve, reject) => {
      WebAppSettings.getUserGalleryInfographicReportIds()
        .then((reportIds) => {
        if (!reportIds || !reportIds.length) {
          resolve([]);
          return;
        }
        let query = reportIds.map((id) => 'id:' + id).join(' OR ');
        ReportTemplatesManager._searchItems(query, ReportTemplatesManager._infographicFilter)
          .then((items) => {
          resolve(items);
        })
          .catch((err) => reject(err));
      })
        .catch((err) => reject(err));
    });
  }
  static _searchItems(query, resultsFilter, options) {
    return new Promise((resolve, reject) => {
      let params = options || {
        start: 1,
        num: 1000,
        sortField: 'title',
        sortOrder: 'asc',
        q: query
      };
      ArcGISClient.searchAllItems({}, params)
        .then((resultItems) => {
        let res = resultsFilter
          ? resultItems.filter(resultsFilter)
          : resultItems;
        resolve(res);
      })
        .catch((err) => reject(err));
    });
  }
  static _createReportTemplateInfos(portalItems, countryCode) {
    let templates = [];
    portalItems.forEach(function (item) {
      let properties = item.properties;
      if (properties) {
        let countries = properties.countries;
        if (SettingsHelper.isTrueString(properties.isComparisonReport)) {
          return;
        }
        if (countries && countries.indexOf(countryCode) !== -1) {
          let rti = {
            reportID: { itemid: item.id },
            formats: properties.formats && properties.formats.split(','),
            headers: [],
            metadata: {
              author: properties.author,
              categories: [],
              countries: countries,
              coverage: properties.coverage,
              hierarchy: GEClient.getGEDefaultHierarchy(countryCode),
              keywords: properties.keywords,
              owner: item.owner,
              title: item.title,
              type: properties.type
            }
          };
          templates.push(rti);
        }
      }
    });
    return templates;
  }
  /**
   * Function for Array.filter that removes non-infographic template items
   *
   * Left here to support filtering out some legacy infographic reports that
   * were not updated on portal for some reasons.
   * @param reportTemplateItem
   * @return {*|boolean}
   * @private
   */
  static _infographicFilter(reportTemplateItem) {
    let p = reportTemplateItem.properties;
    //leave ordinary infographic, but remove single infographics, hidden and blank reports if any
    //boolean properties may be stored as strings
    return (SettingsHelper.isTrueString(p.isGraphicReport) &&
      !SettingsHelper.isTrueString(p.isSingleInfographic) &&
      !SettingsHelper.isTrueString(p.isHidden) &&
      !SettingsHelper.isTrueString(p.isBlank));
  }
}
ReportTemplatesManager._geReportTemplatesCache = {};

class GEClient {
  static async getInfographicTemplatesList(countryCode, full = false, token) {
    return await ReportTemplatesManager.getInfographicReportTemplateItems(countryCode || 'US', full, token);
  }
  static async getClassicReportsTemplatesList(countryCode, full = false) {
    return await ReportTemplatesManager.getReportTemplates(countryCode || 'US', full);
  }
  static execute(geParameters) {
    return new Promise((resolve, reject) => {
      const geoenrichmentUrl = ArcGISClient.getGeoenrichmentUrl();
      // do deep copy, instead of $j.extend({}, params)
      var _geParams = geParameters ? JSON.parse(JSON.stringify(geParameters)) : {};
      if (!_geParams.data)
        _geParams.data = {};
      _geParams.data.forStorage = false;
      // todo: implement queue for this requests, key is _geParams.taskPath or hex_sha1(geParameters)
      ArcGISClient.executeRequest({
        url: geoenrichmentUrl + _geParams.taskPath,
        data: _geParams.data,
        isStandardGeoQuery: _geParams.isStandardGeoQuery
      }).then(resolve).catch(reject);
    });
  }
  static createReport(createReportParams) {
    return new Promise((resolve, reject) => {
      const geUrl = ArcGISClient.getGeoenrichmentUrl();
      let createReportUrl = geUrl.toString() + '/Geoenrichment/CreateReport';
      ArcGISClient.executeRequest({
        url: createReportUrl,
        data: createReportParams
      }).then(resolve).catch(reject);
    });
  }
  /**
   * Performs standard geography search by textual geography query.
   *
   * Note: be patient while setting request options. `sourceCountry`, `geographyLayers`, `optionalCountryHierarchy`
   * params are coupled and country-specific, so update it simultaneously
   *
   * @param geographyQuery String to search for
   * @param options Options to refine search:
   *    featureLimit
   *    geographyLayers
   *    useFuzzySearch
   *    sourceCountry
   *    optionalCountryHierarchy
   * @see https://developers.arcgis.com/rest/geoenrichment/api-reference/standard-geography-query.htm
   */
  static searchStdGeography(geographyQuery, options) {
    return new Promise(async (resolve, reject) => {
      if (!geographyQuery || !geographyQuery.length) {
        resolve([]);
        return;
      }
      let defaultHierarchy = await this.getGEDefaultHierarchy(options?.sourceCountry || 'US', options?.token);
      let geParams = {
        geographyQuery: geographyQuery,
        featureLimit: options?.featureLimit || 10,
        geographyLayers: options?.geographyLayers || ['US.States', 'US.Counties', 'US.Places'],
        useFuzzySearch: options?.useFuzzySearch,
        sourceCountry: options?.sourceCountry || 'US',
        langCode: options?.langCode || "en-us",
        optionalCountryHierarchy: options?.optionalCountryHierarchy || defaultHierarchy
      };
      this.standardGeographyQuery(geParams)
        .then(features => resolve(features))
        .catch(error => reject(error));
    });
  }
  /**
   * Gets standard geography by layer id, feature id and some optional parameters.
   *
   * @param layerId Id of layer to look up in
   * @param featureId Id of feature to request
   * @param options Options to refine query:
   *    featureLimit
   *    returnGeometry
   *    generalizationLevel
   *    sourceCountry
   *    langCode
   *    optionalCountryHierarchy
   * @see https://developers.arcgis.com/rest/geoenrichment/api-reference/standard-geography-query.htm
   */
  static requestStdGeography(layerId, featureId, options) {
    return new Promise(async (resolve, reject) => {
      let defaultHierarchy = await this.getGEDefaultHierarchy(options?.sourceCountry || 'US', options?.token);
      let geParams = {
        geographyLayers: [layerId],
        featureLimit: options?.featureLimit || 1,
        returnGeometry: options?.returnGeometry,
        // outSR: JSON.stringify({wkid: 102100, latestWkid: 3857}),
        generalizationLevel: options?.generalizationLevel || 0,
        geographyIDs: [featureId],
        sourceCountry: options?.sourceCountry || 'US',
        langCode: options?.langCode || "en-us",
        optionalCountryHierarchy: options?.optionalCountryHierarchy || defaultHierarchy
      };
      this.standardGeographyQuery(geParams)
        .then(features => resolve(features))
        .catch(error => reject(error));
    });
  }
  static standardGeographyQuery(params) {
    return new Promise((resolve, reject) => {
      let geParams = {
        data: params,
        isStandardGeoQuery: true,
        taskPath: '/StandardGeographyQuery/execute'
      };
      GEClient.execute(geParams).then((queryResponse) => {
        let result = queryResponse &&
          queryResponse.results &&
          queryResponse.results.length &&
          queryResponse.results[0];
        let features = result &&
          result.value &&
          result.value.features;
        if (features)
          resolve(features);
        else {
          let errorMessages = queryResponse &&
            queryResponse.messages &&
            queryResponse.messages.length;
          reject(errorMessages);
        }
      }).catch(error => {
        reject(error);
      });
    });
  }
  static getStoredDefaultHierarchy(country) {
    let result;
    if (window.localStorage) {
      let d = localStorage.getItem(GEClient._defaultHierarchyStorageName);
      if (d && _ElementIds_a2c40592_js__WEBPACK_IMPORTED_MODULE_0__.U.hasText(d)) {
        let obj = JSON.parse(d);
        result = obj[country];
        // save current defaults in static instance
        GEClient._defaultHierarchies = obj;
      }
    }
    return result;
  }
  /**  setStoredDefaultHierarchy
   *       Stores a default hierarchy name for a given country
   *
   * Stored object is in this format:
   *  {
   *    "US" : "census2020",
   *    "FR" : "FRA_EsriFrance"
   *  }
   * @param country - identifier (ex: 'US')
   * @param name    - default hierarchy name for the country
   */
  static setStoredDefaultHierarchy(country, name) {
    try {
      GEClient.getStoredDefaultHierarchy(country);
      if (!GEClient._defaultHierarchies)
        GEClient._defaultHierarchies = {};
      GEClient._defaultHierarchies[country] = name;
      if (window.localStorage) {
        localStorage.setItem(GEClient._defaultHierarchyStorageName, JSON.stringify(GEClient._defaultHierarchies));
      }
    }
    catch (ex) {
      _ElementIds_a2c40592_js__WEBPACK_IMPORTED_MODULE_0__.L.show('%e', 'GEClient error', ex);
    }
  }
  //   /**
  //      * Gets hierarchy for specified country: either set by id in app settings or default one
  //      *
  //      * @param countryCode 2-letter or 3-letter country code
  //      * @returns {*} Hierarchy for specified country (not null)
  //      */
  //   getPreferredHierarchy: function (countryCode) {
  //     var countryData = BA.CountryDataManager._countryData;
  //     BA.log.info("countryData: ", countryData);
  //     var country = countryData[countryCode];
  //     BA.log.info("countryCode: ", countryCode);
  //     if (country.hierarchies){
  //         for(var i=0; i < country.hierarchies.length; i++){
  //             var h = country.hierarchies[i];
  //             BA.log.info("hierarchy[i]: ", h);
  //             if(h.default){
  //                 BA.log.info("default hierarchy: ",  h);
  //                 // return if default hierarchy is true
  //                 return h;
  //             }
  //         }
  //         BA.log.info("default hierarchy not found using: ", h);
  //         return country.hierarchies[0];
  //         // return first result if no default is found
  //     }
  //     return false;
  // },
  /**  getGEDefaultHierarchy
   *      Returns the default hierarchy name for the given country.
   *      The default may be returned from a localStorage value
   *      saved previously using GEClient.setStoredDefaultHierarchy() or
   *      requested from GE.
   *
   *      In the case the default is fetched from GE, that default
   *      will be cached in local storage
   *
   * @param country - identifier (ex: 'US')
   * @param token - auth token (optional)
   */
  static getGEDefaultHierarchy(country, token) {
    return new Promise((resolve, reject) => {
      let c = 'US'; // default
      if (country && _ElementIds_a2c40592_js__WEBPACK_IMPORTED_MODULE_0__.U.hasText(country))
        c = country;
      // pull default hierarchy from localStorage if available
      let defaultHierarchy = GEClient.getStoredDefaultHierarchy(c);
      if (defaultHierarchy && _ElementIds_a2c40592_js__WEBPACK_IMPORTED_MODULE_0__.U.hasText(defaultHierarchy))
        resolve(defaultHierarchy);
      // Must request default from GE server
      // request= https://geoenrich.arcgis.com/arcgis/rest/services/World/geoenrichmentserver/Geoenrichment/Countries/US?f=pjson
      const geUrl = ArcGISClient.getGeoenrichmentUrl();
      let url = geUrl.toString() + '/Geoenrichment/Countries/' + country + '?f=pjson';
      const data = token ? {
        appID: GEClient.appID,
        token: token
      } :
        {
          appID: GEClient.appID
        };
      ArcGISClient.executeRequest({
        url: url,
        data
      }).then((e) => {
        let def = 'US';
        let arr = e.countries[0].hierarchies;
        if (arr && arr.length > 0) {
          for (let ii = 0; ii < arr.length; ii++) {
            let h = arr[ii];
            if (h.default) {
              def = h.ID;
              // save default to local storage
              GEClient.setStoredDefaultHierarchy(c, h.ID);
              break;
            }
          }
        }
        resolve(def);
      }).catch(reject);
    });
  }
  // async request for std geog levels
  static getStandardGeographyLevels(country, langCode) {
    return new Promise((resolve, reject) => {
      if (!country || !_ElementIds_a2c40592_js__WEBPACK_IMPORTED_MODULE_0__.U.hasText(country))
        country = 'US'; // default
      // default hierarchy
      GEClient.getGEDefaultHierarchy(country).then((defHierarchyName) => {
        // Request geography levels
        // request= https://geoenrich.arcgis.com/arcgis/rest/services/World/geoenrichmentserver/Geoenrichment/StandardGeographyLevels/US?f=json
        const geUrl = ArcGISClient.getGeoenrichmentUrl();
        // let url: string = geUrl.toString() + '/Countries/' + country + '?f=pjson';
        let url = geUrl.toString() + '/Geoenrichment/StandardGeographyLevels/' + country + '?f=pjson';
        ArcGISClient.executeRequest({
          url: url,
          data: {
            langCode: langCode ? langCode : "en-us"
          }
        }).then((e) => {
          let hier;
          if (e && e.geographyLevels && e.geographyLevels[0] && e.geographyLevels[0].hierarchies) {
            let arr = e.geographyLevels[0].hierarchies;
            for (let ii = 0; ii < arr.length; ii++) {
              if (arr[ii].ID == defHierarchyName) {
                hier = arr[ii];
                break;
              }
            }
            if (!hier)
              hier = arr[0];
          }
          resolve(hier);
        }).catch(reject);
      }).catch(reject);
    }).catch(error => {
      _ElementIds_a2c40592_js__WEBPACK_IMPORTED_MODULE_0__.L.show('%e', 'GEClient error', error);
    });
  }
}
GEClient._defaultHierarchyStorageName = 'GEClient-default-hierarchy';
// NOTE!!: Hardcoded for Experience Builder, we need to modify to be passed in by consuming application to allow for multi app use
GEClient.appID = "esriexperiencebuilder";
GEClient.enrich = function (enrichRequestParams) {
  return new Promise(async (resolve, reject) => {
    var enrichUrl = Environments.getUrl('geoenrich') + '/Geoenrichment/Enrich';
    enrichRequestParams.forStorage = false;
    ArcGISClient.executeRequest({
      url: enrichUrl,
      data: enrichRequestParams
    }).then(function (enrichResponse) {
      var result = enrichResponse && enrichResponse.results && enrichResponse.results.length && enrichResponse.results[0];
      var featureSet = result && result.value && result.value.FeatureSet && result.value.FeatureSet.length && result.value.FeatureSet[0];
      if (featureSet.features && featureSet.features.length) {
        resolve(enrichResponse);
      }
      else {
        var errorDescription = enrichResponse && enrichResponse.messages && enrichResponse.messages.length && enrichResponse.messages[0].description;
        if (!errorDescription)
          errorDescription = 'getfacts-no-data';
        reject(errorDescription);
      }
    }, function (err) {
      reject(err);
    });
  });
};



//# sourceMappingURL=GEClient-f71049f8.js.map

/***/ })

}]);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2lkZ2V0cy9jaHVua3MvYmEtaW5mb2dyYXBoaWNfbm9kZV9tb2R1bGVzX2FyY2dpc19idXNpbmVzcy1hbmFseXN0LWNvbXBvbmVudHNfZGlzLWFiNTI4ZS5qcyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7OztBQUFpRTs7QUFFakU7QUFDQTtBQUNBO0FBQ0E7QUFDQSxjQUFjO0FBQ2Q7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLE1BQU0sc0RBQUk7QUFDVjtBQUNBO0FBQ0EsdUJBQXVCLHNEQUFLO0FBQzVCLE1BQU0sc0RBQUk7QUFDVjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxNQUFNLHNEQUFJO0FBQ1Y7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtB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O0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGNBQWM7QUFDZDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGFBQWE7QUFDYjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsV0FBVztBQUNYO0FBQ0EsU0FBUztBQUNULE9BQU87QUFDUDtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsZUFBZTtBQUNmO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLDhCQUE4QixpRUFBaUU7QUFDL0Y7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLE9BQU87QUFDUDtBQUNB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Q0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLE1BQU07QUFDTjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0Esb0JBQW9CO0FBQ3BCLHFCQUFxQixzREFBSztBQUMxQjtBQUNBO0FBQ0E7QUFDQSw4QkFBOEIsc0RBQUs7QUFDbkM7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFFBQVE7QUFDUjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxPQUFPO0FBQ1A7QUFDQTtBQUNBO0FBQ0EsMkJBQTJCLGlCQUFpQjtBQUM1QztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLE9BQU87QUFDUCxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQSx1QkFBdUIsc0RBQUs7QUFDNUIsd0JBQXdCO0FBQ3hCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFNBQVM7QUFDVDtBQUNBO0FBQ0E7QUFDQSw2QkFBNkIsaUJBQWlCO0FBQzlDO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFNBQVM7QUFDVCxPQUFPO0FBQ1AsS0FBSztBQUNMLE1BQU0sc0RBQUk7QUFDVixLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQSxLQUFLO0FBQ0wsR0FBRztBQUNIOztBQUVxRjs7QUFFckYiLCJzb3VyY2VzIjpbIndlYnBhY2s6Ly9leGItY2xpZW50Ly4vZXh0ZW5zaW9ucy93aWRnZXRzL2JhLWluZm9ncmFwaGljL25vZGVfbW9kdWxlcy9AYXJjZ2lzL2J1c2luZXNzLWFuYWx5c3QtY29tcG9uZW50cy9kaXN0L3N0ZW5jaWwtY29tcG9uZW50cy9kaXN0L2VzbS9HRUNsaWVudC1mNzEwNDlmOC5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBMIGFzIExvZ3osIFUgYXMgVXRpbHMgfSBmcm9tICcuL0VsZW1lbnRJZHMtYTJjNDA1OTIuanMnO1xuXG5jbGFzcyBUb2tlblByb3ZpZGVyIHtcclxuICAvKipcclxuICAgKiB0b2RvOiBpbXBsZW1lbnQgcmVhbCBtZXRob2RcclxuICAgKlxyXG4gICAqIEByZXR1cm4ge1Byb21pc2U8dW5rbm93bj59XHJcbiAgICovXHJcbiAgc3RhdGljIGdldFRva2VuKCkge1xyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7XHJcbiAgICAgIHJlc29sdmUoVG9rZW5Qcm92aWRlci50b2tlbi5hY2Nlc3NfdG9rZW4pO1xyXG4gICAgfSk7XHJcbiAgfVxyXG4gIHN0YXRpYyBzZXRUb2tlbih1c2VybmFtZSwgdG9rZW4pIHtcclxuICAgIGlmICh1c2VybmFtZSAmJiB1c2VybmFtZS5sZW5ndGggPiAwICYmIHRva2VuICYmIHRva2VuLmxlbmd0aCA+IDApIHtcclxuICAgICAgdGhpcy50b2tlbi5hY2Nlc3NfdG9rZW4gPSB0b2tlbjtcclxuICAgICAgdGhpcy50b2tlbi51c2VybmFtZSA9IHVzZXJuYW1lO1xyXG4gICAgfVxyXG4gIH1cclxufVxyXG5Ub2tlblByb3ZpZGVyLnRva2VuID0ge1xyXG4gIGFjY2Vzc190b2tlbjogJycsXHJcbiAgZXhwaXJlc19pbjogbnVsbCxcclxuICBwZXJzaXN0OiAndHJ1ZScsXHJcbiAgc3NsOiAndHJ1ZScsXHJcbiAgdXNlcm5hbWU6ICdtYXJrX2JhJ1xyXG59O1xuXG4vKiogRW52aXJvbm1lbnRzXHJcbiAqXHJcbiAqICBUaGlzIGNsYXNzIHByb3ZpZGVzIHN1cHBvcnQgZm9yIGVudmlyb25tZW50cyBhbmQgc3ViZG9tYWluc1xyXG4gKiAgUG9ydGFsVXJsIC0gY2FuIGJlIG92ZXJyaWRlbiBmb3IgZW50ZXJwcmlzZSBlbnZpcm9ubWVudHNcclxuICogIEdlb2NvZGVyVXJsIC0gY2FuIGJlIG92ZXJyaWRlblxyXG4gKiAgR2VvZW5yaWNobWVudFVybCAtIGNhbiBiZSBvdmVycmlkZW5cclxuICovXHJcbmNsYXNzIEVudmlyb25tZW50cyB7XHJcbiAgc3RhdGljIHNldEVudmlyb25tZW50KGVudikge1xyXG4gICAgbGV0IGUgPSAoZW52ID09PSAncHJvZCcgfHwgZW52ID09PSAnbG9jYWxob3N0JykgPyAnd3d3JyA6IGVudjtcclxuICAgIEVudmlyb25tZW50cy5fZW52ID0gZTtcclxuICAgIC8vIExvZ3ouc2hvdygnJWcnLCAnQkEgRW52aXJvbm1lbnQ6ICcgKyBlKVxyXG4gIH1cclxuICBzdGF0aWMgZ2V0RW52aXJvbm1lbnQoKSB7XHJcbiAgICByZXR1cm4gRW52aXJvbm1lbnRzLl9lbnY7XHJcbiAgfVxyXG4gIHN0YXRpYyBzZXRQb3J0YWxVcmwocG9ydGFsVXJsKSB7XHJcbiAgICBFbnZpcm9ubWVudHMucG9ydGFsVXJsID0gcG9ydGFsVXJsO1xyXG4gIH1cclxuICBzdGF0aWMgc2V0R2VvZW5yaWNobWVudFVybChnZVVybCkge1xyXG4gICAgRW52aXJvbm1lbnRzLmdlb2VucmljaG1lbnRVcmwgPSBnZVVybDtcclxuICB9XHJcbiAgc3RhdGljIHNldEdlb2NvZGVVcmwoZ2VvY29kZVVybCkge1xyXG4gICAgRW52aXJvbm1lbnRzLmdlb2NvZGVVcmwgPSBnZW9jb2RlVXJsO1xyXG4gIH1cclxuICBzdGF0aWMgZ2V0UG9ydGFsQmFzZSgpIHtcclxuICAgIC8vIE9wdGlvbmFsLCBpZiBQb3J0YWxVcmwgaGFzIGJlZW4gZXhwbGljaXRseSBzZXQvb3ZlcnJpZGVuIHVzZSBpdFxyXG4gICAgaWYgKEVudmlyb25tZW50cy5wb3J0YWxVcmwpIHtcclxuICAgICAgcmV0dXJuIEVudmlyb25tZW50cy5wb3J0YWxVcmw7XHJcbiAgICB9XHJcbiAgICBjb25zdCBlID0gRW52aXJvbm1lbnRzLl9lbnY7XHJcbiAgICBpZiAoIWUpXHJcbiAgICAgIHJldHVybiAnJztcclxuICAgIGNvbnN0IHN1YmRvbWFpbiA9IGUgPT09ICdkZXYnID8gJ2RldmV4dCcgOiBlID09PSAncWEnID8gJ3FhZXh0JyA6ICd3d3cnO1xyXG4gICAgbGV0IHVybCA9ICdodHRwczovLycgKyBzdWJkb21haW4gKyAnLmFyY2dpcy5jb20nO1xyXG4gICAgLy8gTG9nei5zaG93KCclZycsJ0JBIEVudmlyb25tZW50cyBiYXNlPScgKyB1cmwpXHJcbiAgICByZXR1cm4gdXJsO1xyXG4gIH1cclxuICAvKipcclxuICAgKiBSZXR1cm5zIGFwcHJvcHJpYXRlIHJlcXVlc3QgVVJMIGZvciB0aGUgc3ViZG9tYWluXHJcbiAgICpcclxuICAgKiBAcGFyYW0gc3ViRG9tYWluIC0gb25lIG9mICdnZW9jb2RlJywgJ2FyY2dpcycsIG9yICdnZW9lbnJpY2gnXHJcbiAgICovXHJcbiAgc3RhdGljIGdldFVybChzdWJEb21haW4pIHtcclxuICAgIGlmICghRW52aXJvbm1lbnRzLl9lbnYpIHtcclxuICAgICAgTG9nei5zaG93KCclZScsICdFbnZpcm9ubWVudHMgZXJyb3I6IGVudiBub3Qgc2V0Jyk7XHJcbiAgICAgIHJldHVybiAnJztcclxuICAgIH1cclxuICAgIGlmICghc3ViRG9tYWluIHx8ICFVdGlscy5oYXNUZXh0KHN1YkRvbWFpbikpIHtcclxuICAgICAgTG9nei5zaG93KCclZScsICdFbnZpcm9ubWVudHMgZXJyb3I6IGludmFsaWQgc3ViZG9tYWluJyk7XHJcbiAgICAgIHJldHVybiAnJztcclxuICAgIH1cclxuICAgIGNvbnN0IHBvcnRhbCA9IEVudmlyb25tZW50cy5nZXRQb3J0YWxCYXNlKCk7XHJcbiAgICBpZiAocG9ydGFsID09PSAnJylcclxuICAgICAgcmV0dXJuICcnO1xyXG4gICAgdHJ5IHtcclxuICAgICAgbGV0IHVybCA9ICcnO1xyXG4gICAgICBzd2l0Y2ggKHN1YkRvbWFpbikge1xyXG4gICAgICAgIGNhc2UgKCdnZW9jb2RlJyk6IHtcclxuICAgICAgICAgIC8vIE9wdGlvbmFsLCBpZiBHZW9jb2RlVXJsIGhhcyBiZWVuIGV4cGxpY2l0bHkgc2V0L292ZXJyaWRlbiB1c2UgaXRcclxuICAgICAgICAgIGlmIChFbnZpcm9ubWVudHMuZ2VvY29kZVVybCkge1xyXG4gICAgICAgICAgICB1cmwgPSBFbnZpcm9ubWVudHMuZ2VvY29kZVVybDtcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgdXJsID1cclxuICAgICAgICAgICAgICAoRW52aXJvbm1lbnRzLl9lbnYgPT09ICdxYScpID8gJ2h0dHBzOi8vZ2VvY29kZXFhLmFyY2dpcy5jb20vYXJjZ2lzL3Jlc3Qvc2VydmljZXMvV29ybGQvR2VvY29kZVNlcnZlcicgOlxyXG4gICAgICAgICAgICAgICAgKEVudmlyb25tZW50cy5fZW52ID09PSAnZGV2JykgPyAnaHR0cHM6Ly9nZW9jb2RlZGV2LmFyY2dpcy5jb20vYXJjZ2lzL3Jlc3Qvc2VydmljZXMvV29ybGQvR2VvY29kZVNlcnZlcicgOlxyXG4gICAgICAgICAgICAgICAgICAnaHR0cHM6Ly9nZW9jb2RlLmFyY2dpcy5jb20vYXJjZ2lzL3Jlc3Qvc2VydmljZXMvV29ybGQvR2VvY29kZVNlcnZlcic7XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBjYXNlICgnYXJjZ2lzJyk6IHtcclxuICAgICAgICAgIHVybCA9IHBvcnRhbDtcclxuICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjYXNlICgnaW5mb2dyYXBoaWNzJyk6IHtcclxuICAgICAgICAgIHVybCA9XHJcbiAgICAgICAgICAgIChFbnZpcm9ubWVudHMuX2VudiA9PT0gJ3FhJykgPyAnaHR0cHM6Ly9iYW9xYS5hcmNnaXMuY29tL0luZm9ncmFwaGljc1BsYXllci9CQU1vYmlsZS8yMy5SMDMvcmVwb3J0UGxheWVyL1JlcG9ydFBsYXllck1vYmlsZS5odG1sJyA6XHJcbiAgICAgICAgICAgICAgKEVudmlyb25tZW50cy5fZW52ID09PSAnZGV2JykgPyAnaHR0cHM6Ly9iYW9kZXYuYXJjZ2lzLmNvbS9JbmZvZ3JhcGhpY3NQbGF5ZXIvQkFNb2JpbGUvMjMuUjAzL3JlcG9ydFBsYXllci9SZXBvcnRQbGF5ZXJNb2JpbGUuaHRtbCcgOlxyXG4gICAgICAgICAgICAgICAgJ2h0dHBzOi8vYmFvLmFyY2dpcy5jb20vSW5mb2dyYXBoaWNzUGxheWVyL0JBTW9iaWxlLzIzLlIwMy9yZXBvcnRQbGF5ZXIvUmVwb3J0UGxheWVyTW9iaWxlLmh0bWwnO1xyXG4gICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNhc2UgKCdnZW9lbnJpY2gnKToge1xyXG4gICAgICAgICAgLy8gT3B0aW9uYWwsIGlmIEdlb2VucmljaG1lbnRVcmwgaGFzIGJlZW4gZXhwbGljaXRseSBzZXQvb3ZlcnJpZGVuIHVzZSBpdFxyXG4gICAgICAgICAgaWYgKEVudmlyb25tZW50cy5nZW9lbnJpY2htZW50VXJsKSB7XHJcbiAgICAgICAgICAgIHVybCA9IEVudmlyb25tZW50cy5nZW9lbnJpY2htZW50VXJsO1xyXG4gICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICB1cmwgPVxyXG4gICAgICAgICAgICAgIChFbnZpcm9ubWVudHMuX2VudiA9PT0gJ3FhJykgPyAnaHR0cHM6Ly9nZW9lbnJpY2hxYS5hcmNnaXMuY29tL2FyY2dpcy9yZXN0L3NlcnZpY2VzL1dvcmxkL2dlb2VucmljaG1lbnRzZXJ2ZXInIDpcclxuICAgICAgICAgICAgICAgIChFbnZpcm9ubWVudHMuX2VudiA9PT0gJ2RldicpID8gJ2h0dHBzOi8vZ2VvZW5yaWNoZGV2LmFyY2dpcy5jb20vYXJjZ2lzL3Jlc3Qvc2VydmljZXMvV29ybGQvZ2VvZW5yaWNobWVudHNlcnZlcicgOlxyXG4gICAgICAgICAgICAgICAgICAnaHR0cHM6Ly9nZW9lbnJpY2guYXJjZ2lzLmNvbS9hcmNnaXMvcmVzdC9zZXJ2aWNlcy9Xb3JsZC9nZW9lbnJpY2htZW50c2VydmVyJztcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgICByZXR1cm4gdXJsO1xyXG4gICAgfVxyXG4gICAgY2F0Y2ggKGV4KSB7XHJcbiAgICAgIExvZ3ouc2hvdygnJWUnLCAnRW52aXJvbm1lbnRzLmdldFVybCgpIGVycm9yICcsIGV4KTtcclxuICAgIH1cclxuICAgIHJldHVybiAnJztcclxuICB9XHJcbiAgLy8gUmV0dXJucyB0cnVlIGlmIHRoZSBnZW9jb2RlVXJsIHN0cmluZyBwYXNzZWQgaW4gaXMgdGhlIG9ubGluZSBHZW9jb2RlciBTZXJ2aWNlIChkZXYsIHFhLCBwcm9kKSwgZmFsc2Ugb3RoZXJ3aXNlXHJcbiAgc3RhdGljIGlzT25saW5lR2VvY29kZXIoZ2VvY29kZVVybCkge1xyXG4gICAgaWYgKGdlb2NvZGVVcmwudG9Mb3dlckNhc2UoKS5zdGFydHNXaXRoKCdodHRwczovL2dlb2NvZGUuYXJjZ2lzLmNvbS9hcmNnaXMvcmVzdC9zZXJ2aWNlcy9Xb3JsZC9HZW9jb2RlU2VydmVyJy50b0xvd2VyQ2FzZSgpKSB8fFxyXG4gICAgICBnZW9jb2RlVXJsLnRvTG93ZXJDYXNlKCkuc3RhcnRzV2l0aCgnaHR0cHM6Ly9nZW9jb2RlcWEuYXJjZ2lzLmNvbS9hcmNnaXMvcmVzdC9zZXJ2aWNlcy9Xb3JsZC9HZW9jb2RlU2VydmVyJy50b0xvd2VyQ2FzZSgpKSB8fFxyXG4gICAgICBnZW9jb2RlVXJsLnRvTG93ZXJDYXNlKCkuc3RhcnRzV2l0aCgnaHR0cHM6Ly9nZW9jb2RlZGV2LmFyY2dpcy5jb20vYXJjZ2lzL3Jlc3Qvc2VydmljZXMvV29ybGQvR2VvY29kZVNlcnZlcicudG9Mb3dlckNhc2UoKSkpIHtcclxuICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gZmFsc2U7XHJcbiAgfVxyXG4gIC8vIFJldHVybnMgdHJ1ZSBpZiB0aGUgcG9ydGFsVXJsIHN0cmluZyBwYXNzZWQgaW4gaXMgdGhlIG9ubGluZSBQb3J0YWwgKGRldiwgcWEsIHByb2QpLCBmYWxzZSBvdGhlcndpc2VcclxuICBzdGF0aWMgaXNBR09Qb3J0YWwocG9ydGFsVXJsKSB7XHJcbiAgICBpZiAocG9ydGFsVXJsLnRvTG93ZXJDYXNlKCkuc3RhcnRzV2l0aCgnaHR0cHM6Ly93d3cuYXJjZ2lzLmNvbScudG9Mb3dlckNhc2UoKSkgfHxcclxuICAgICAgcG9ydGFsVXJsLnRvTG93ZXJDYXNlKCkuc3RhcnRzV2l0aCgnaHR0cHM6Ly9xYWV4dC5hcmNnaXMuY29tJy50b0xvd2VyQ2FzZSgpKSB8fFxyXG4gICAgICBwb3J0YWxVcmwudG9Mb3dlckNhc2UoKS5zdGFydHNXaXRoKCdodHRwczovL2RldmV4dC5hcmNnaXMuY29tJy50b0xvd2VyQ2FzZSgpKSkge1xyXG4gICAgICByZXR1cm4gdHJ1ZTtcclxuICAgIH1cclxuICAgIHJldHVybiBmYWxzZTtcclxuICB9XHJcbn1cclxuRW52aXJvbm1lbnRzLl9lbnYgPSAnd3d3JztcclxuLy8gT3B0aW9uYWwsIGFiaWxpdHkgdG8gb3ZlcnJpZGUgcG9ydGFsVXJsXHJcbkVudmlyb25tZW50cy5wb3J0YWxVcmwgPSAnJztcclxuLy8gT3B0aW9uYWwsIGFiaWxpdHkgdG8gb3ZlcnJpZGUgZ2VvZW5yaWNobWVudCBVUkxcclxuRW52aXJvbm1lbnRzLmdlb2VucmljaG1lbnRVcmwgPSAnJztcclxuLy8gT3B0aW9uYWwsIGFiaWxpdHkgdG8gb3ZlcnJpZGUgZ2VvY29kZSBVUkxcclxuRW52aXJvbm1lbnRzLmdlb2NvZGVVcmwgPSAnJztcblxuY2xhc3MgQXJjR0lTQ2xpZW50IHtcclxuICBzdGF0aWMgZXhlY3V0ZVNlbGYoKSB7XHJcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICBUb2tlblByb3ZpZGVyLmdldFRva2VuKCkudGhlbigoYWNjZXNzVG9rZW4pID0+IHtcclxuICAgICAgICBpZiAoYWNjZXNzVG9rZW4gPT09IEFyY0dJU0NsaWVudC5fbGFzdFNlbGZUb2tlbikge1xyXG4gICAgICAgICAgcmVzb2x2ZShBcmNHSVNDbGllbnQuX3NlbGZSZXN1bHQpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIHtcclxuICAgICAgICAgIGxldCBzZXR0aW5ncyA9IHtcclxuICAgICAgICAgICAgdGFza1BhdGg6ICcvcG9ydGFscy9zZWxmJyxcclxuICAgICAgICAgICAgZGF0YToge1xyXG4gICAgICAgICAgICAgIGN1bHR1cmU6ICdlbi11cycgLy8gdG9kbzogZ2V0IGFjdHVhbCBsb2NhbGVcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfTtcclxuICAgICAgICAgIEFyY0dJU0NsaWVudC5leGVjdXRlUmVxdWVzdChzZXR0aW5ncykudGhlbihyZXNwb25zZSA9PiB7XHJcbiAgICAgICAgICAgIC8vY2FjaGluZyByZXNwb25zZSBmcm9tIFwiL3NlbGZcIiB3aXRoIHRva2VuIGFzIGtleVxyXG4gICAgICAgICAgICBBcmNHSVNDbGllbnQuX2xhc3RTZWxmVG9rZW4gPSBhY2Nlc3NUb2tlbjtcclxuICAgICAgICAgICAgQXJjR0lTQ2xpZW50Ll9zZWxmUmVzdWx0ID0gcmVzcG9uc2U7XHJcbiAgICAgICAgICAgIHJlc29sdmUocmVzcG9uc2UpO1xyXG4gICAgICAgICAgfSlcclxuICAgICAgICAgICAgLmNhdGNoKGVyciA9PiB7XHJcbiAgICAgICAgICAgIEFyY0dJU0NsaWVudC5fbGFzdFNlbGZUb2tlbiA9ICcnO1xyXG4gICAgICAgICAgICBBcmNHSVNDbGllbnQuX3NlbGZSZXN1bHQgPSAnJztcclxuICAgICAgICAgICAgcmVqZWN0KGVycik7XHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pXHJcbiAgICAgICAgLmNhdGNoKGVyciA9PiByZWplY3QoZXJyKSk7XHJcbiAgICB9KTtcclxuICB9XHJcbiAgc3RhdGljIGdldEdlb2VucmljaG1lbnRVcmwoKSB7XHJcbiAgICByZXR1cm4gRW52aXJvbm1lbnRzLmdldFVybCgnZ2VvZW5yaWNoJyk7XHJcbiAgfVxyXG4gIHN0YXRpYyBnZXRIZWxwZXJTZXJ2aWNlVXJsKHNlcnZpY2VOYW1lKSB7XHJcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICBBcmNHSVNDbGllbnQuZXhlY3V0ZVNlbGYoKS50aGVuKGZ1bmN0aW9uIChzZWxmUmVzdWx0KSB7XHJcbiAgICAgICAgbGV0IGhlbHBlclNlcnZpY2VzID0gc2VsZlJlc3VsdC5oZWxwZXJTZXJ2aWNlcztcclxuICAgICAgICBpZiAoaGVscGVyU2VydmljZXMpIHtcclxuICAgICAgICAgIGxldCBoZWxwZXJTZXJ2aWNlID0gaGVscGVyU2VydmljZXNbc2VydmljZU5hbWVdO1xyXG4gICAgICAgICAgaWYgKGhlbHBlclNlcnZpY2UpIHtcclxuICAgICAgICAgICAgbGV0IHVybFN0cmluZyA9IEFycmF5LmlzQXJyYXkoaGVscGVyU2VydmljZSkgPyBoZWxwZXJTZXJ2aWNlWzBdLnVybCA6IGhlbHBlclNlcnZpY2UudXJsO1xyXG4gICAgICAgICAgICB1cmxTdHJpbmcgPyByZXNvbHZlKHVybFN0cmluZykgOiByZWplY3Qoc2VydmljZU5hbWUgKyAnIGhlbHBlciBzZXJ2aWNlIGlzIG5vdCBjb25maWd1cmVkLicpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgZWxzZVxyXG4gICAgICAgICAgICByZWplY3Qoc2VydmljZU5hbWUgKyAnIGhlbHBlciBzZXJ2aWNlIGlzIG5vdCBjb25maWd1cmVkLicpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlXHJcbiAgICAgICAgICByZWplY3QoJ0hlbHBlciBzZXJ2aWNlcyBhcmUgbm90IGNvbmZpZ3VyZWQuJyk7XHJcbiAgICAgIH0pLmNhdGNoKGVyciA9PiByZWplY3QoZXJyKSk7XHJcbiAgICB9KTtcclxuICB9XHJcbiAgc3RhdGljIGdldFBvcnRhbFJlc291cmNlKHJlc291cmNlTmFtZSkge1xyXG4gICAgcmV0dXJuIEFyY0dJU0NsaWVudC5leGVjdXRlUmVxdWVzdCh7XHJcbiAgICAgIHRhc2tQYXRoOiAnL3BvcnRhbHMvc2VsZi9yZXNvdXJjZXMvJyArIHJlc291cmNlTmFtZVxyXG4gICAgfSk7XHJcbiAgfVxyXG4gIHN0YXRpYyBnZXRJdGVtRGF0YShpdGVtSWQpIHtcclxuICAgIHJldHVybiBBcmNHSVNDbGllbnQuZXhlY3V0ZVJlcXVlc3Qoe1xyXG4gICAgICB0YXNrUGF0aDogJy9jb250ZW50L2l0ZW1zLycgKyBpdGVtSWQgKyAnL2RhdGEnXHJcbiAgICB9KTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICogU2VhcmNoZXMgZm9yIGl0ZW1zIGJ5IHByb3ZpZGVkIHNlYXJjaCBxdWVyeSBhbmQgcGFyYW1zIGFuZCBleHRyYWN0cyBhbGwgc2VhcmNoIHJlc3VsdHNcclxuICAgKiBieXBhc3NpbmcgQXJjR0lTIHNlcnZlciBsaW1pdCBvZiAxMDAgaXRlbXNcclxuICAgKlxyXG4gICAqIEBwYXJhbSBxdWVyeVxyXG4gICAqIEBwYXJhbSBwYXJhbXNcclxuICAgKiBAcmV0dXJucyB7UHJvbWlzZTx1bmtub3duPn1cclxuICAgKi9cclxuICBzdGF0aWMgc2VhcmNoQWxsSXRlbXMocXVlcnksIHBhcmFtcykge1xyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgbGV0IHNlYXJjaFJlc3VsdHMgPSBbXTtcclxuICAgICAgbGV0IHNlbGYgPSB0aGlzO1xyXG4gICAgICBsZXQgX2RvU2VhcmNoID0gZnVuY3Rpb24gKHF1ZXJ5LCBwYXJhbXMsIGNvbnRleHQpIHtcclxuICAgICAgICBzZWxmLnNlYXJjaEl0ZW1zKHF1ZXJ5LCBwYXJhbXMsIGNvbnRleHQpLnRoZW4oZnVuY3Rpb24gKHJlc3VsdCkge1xyXG4gICAgICAgICAgaWYgKHJlc3VsdC5pdGVtcy5sZW5ndGgpXHJcbiAgICAgICAgICAgIHNlYXJjaFJlc3VsdHMgPSBzZWFyY2hSZXN1bHRzLmNvbmNhdChyZXN1bHQuaXRlbXMpO1xyXG4gICAgICAgICAgbGV0IG5ld0NvbnRleHQgPSByZXN1bHQuY29udGV4dDtcclxuICAgICAgICAgIGlmIChuZXdDb250ZXh0Lm5leHRTdGFydCA+IDApXHJcbiAgICAgICAgICAgIF9kb1NlYXJjaChxdWVyeSwgcGFyYW1zLCBuZXdDb250ZXh0KTtcclxuICAgICAgICAgIGVsc2VcclxuICAgICAgICAgICAgcmVzb2x2ZShzZWFyY2hSZXN1bHRzKTtcclxuICAgICAgICB9LCBmdW5jdGlvbiAoZXJyKSB7XHJcbiAgICAgICAgICBpZiAoc2VhcmNoUmVzdWx0cyAmJiBzZWFyY2hSZXN1bHRzLmxlbmd0aClcclxuICAgICAgICAgICAgcmVzb2x2ZShzZWFyY2hSZXN1bHRzKTtcclxuICAgICAgICAgIGVsc2VcclxuICAgICAgICAgICAgcmVqZWN0KGVycik7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH07XHJcbiAgICAgIF9kb1NlYXJjaChxdWVyeSwgcGFyYW1zLCBudWxsKTtcclxuICAgIH0pO1xyXG4gIH1cclxuICBzdGF0aWMgc2VhcmNoSXRlbXMocXVlcnksIHBhcmFtcywgY29udGV4dCkge1xyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgLy8gZG8gZGVlcCBjb3B5LCBpbnN0ZWFkIG9mICRqLmV4dGVuZCh7fSwgcGFyYW1zKVxyXG4gICAgICBsZXQgc2VhcmNoUGFyYW1zID0gcGFyYW1zID8gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShwYXJhbXMpKSA6IHt9O1xyXG4gICAgICBpZiAoY29udGV4dCkge1xyXG4gICAgICAgIHNlYXJjaFBhcmFtcy5xID0gcGFyYW1zLnE7XHJcbiAgICAgICAgbGV0IHRvdGFsID0gY29udGV4dC50b3RhbDtcclxuICAgICAgICBsZXQgbmV4dFN0YXJ0ID0gY29udGV4dC5uZXh0U3RhcnQ7XHJcbiAgICAgICAgaWYgKHRvdGFsICYmIG5leHRTdGFydCkge1xyXG4gICAgICAgICAgaWYgKG5leHRTdGFydCA+IDAgJiYgdG90YWwgPj0gbmV4dFN0YXJ0KVxyXG4gICAgICAgICAgICBzZWFyY2hQYXJhbXMuc3RhcnQgPSBuZXh0U3RhcnQ7XHJcbiAgICAgICAgICBlbHNlXHJcbiAgICAgICAgICAgIHJlc29sdmUoeyBpdGVtczogW10sIGNvbnRleHQ6IGNvbnRleHQgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChjb250ZXh0LnNvcnRGaWVsZCAmJiBjb250ZXh0LnNvcnRPcmRlcikge1xyXG4gICAgICAgICAgc2VhcmNoUGFyYW1zLnNvcnRPcmRlciA9IGNvbnRleHQuc29ydE9yZGVyO1xyXG4gICAgICAgICAgc2VhcmNoUGFyYW1zLnNvcnRGaWVsZCA9IGNvbnRleHQuc29ydEZpZWxkO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyAkai5hamF4U2V0dXAoe1xyXG4gICAgICAgIC8vICAgICBnbG9iYWw6IGZhbHNlXHJcbiAgICAgICAgLy8gfSk7XHJcbiAgICAgIH1cclxuICAgICAgZWxzZSB7XHJcbiAgICAgICAgbGV0IHF1ZXJ5UGFydHMgPSBbXTtcclxuICAgICAgICBPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyhxdWVyeSkuZm9yRWFjaChmdW5jdGlvbiAoa2V5KSB7XHJcbiAgICAgICAgICBxdWVyeVBhcnRzLnB1c2goa2V5ICsgJzpcIicgKyBxdWVyeVtrZXldICsgJ1wiJyk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgaWYgKHF1ZXJ5UGFydHMubGVuZ3RoKVxyXG4gICAgICAgICAgc2VhcmNoUGFyYW1zLnEgPSBxdWVyeVBhcnRzLmpvaW4oJyBBTkQgJyk7XHJcbiAgICAgIH1cclxuICAgICAgQXJjR0lTQ2xpZW50LnBvcnRhbFNlYXJjaChzZWFyY2hQYXJhbXMpLnRoZW4oKHNlYXJjaFJlc3BvbnNlKSA9PiB7XHJcbiAgICAgICAgLy8gJGouYWpheFNldHVwKHtcclxuICAgICAgICAvLyAgICAgZ2xvYmFsOiB0cnVlXHJcbiAgICAgICAgLy8gfSk7XHJcbiAgICAgICAgbGV0IHJlc3VsdEl0ZW1zID0gc2VhcmNoUmVzcG9uc2UucmVzdWx0cztcclxuICAgICAgICBsZXQgY3R4ID0ge1xyXG4gICAgICAgICAgcXVlcnk6IHNlYXJjaFJlc3BvbnNlLnF1ZXJ5LFxyXG4gICAgICAgICAgdG90YWw6IHNlYXJjaFJlc3BvbnNlLnRvdGFsLFxyXG4gICAgICAgICAgbmV4dFN0YXJ0OiBzZWFyY2hSZXNwb25zZS5uZXh0U3RhcnQsXHJcbiAgICAgICAgICBzb3J0T3JkZXI6IG51bGwsXHJcbiAgICAgICAgICBzb3J0RmllbGQ6IG51bGxcclxuICAgICAgICB9O1xyXG4gICAgICAgIGlmIChzZWFyY2hQYXJhbXMuc29ydE9yZGVyICYmIHNlYXJjaFBhcmFtcy5zb3J0RmllbGQpIHtcclxuICAgICAgICAgIGN0eC5zb3J0T3JkZXIgPSBzZWFyY2hQYXJhbXMuc29ydE9yZGVyO1xyXG4gICAgICAgICAgY3R4LnNvcnRGaWVsZCA9IHNlYXJjaFBhcmFtcy5zb3J0RmllbGQ7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJlc29sdmUoeyBpdGVtczogcmVzdWx0SXRlbXMsIGNvbnRleHQ6IGN0eCB9KTtcclxuICAgICAgfSkuY2F0Y2gocmVqZWN0KTtcclxuICAgIH0pO1xyXG4gIH1cclxuICAvLy8gbWV0aG9kcyBmcm9tIEJBLmFyY0dJU1JlcXVlc3RzXHJcbiAgc3RhdGljIHBvcnRhbFNlYXJjaChwYXJhbXMpIHtcclxuICAgIHJldHVybiBBcmNHSVNDbGllbnQuZXhlY3V0ZVJlcXVlc3Qoe1xyXG4gICAgICB0YXNrUGF0aDogJy9zZWFyY2gnLFxyXG4gICAgICBkYXRhOiBwYXJhbXNcclxuICAgIH0pO1xyXG4gIH1cclxuICBzdGF0aWMgYXN5bmMgZ2V0UG9ydGFsVXJsKCkge1xyXG4gICAgcmV0dXJuIEVudmlyb25tZW50cy5nZXRVcmwoJ2FyY2dpcycpICsgJy9zaGFyaW5nL3Jlc3QnO1xyXG4gIH1cclxuICBzdGF0aWMgZXhlY3V0ZVJlcXVlc3Qoc2V0dGluZ3MpIHtcclxuICAgIC8vc2V0dGluZ3M6XHJcbiAgICAvLyB7XHJcbiAgICAvLyAgICAgXCJkYXRhXCI6IHtcclxuICAgIC8vICAgICBcIm51bVwiOiAxMDAwLFxyXG4gICAgLy8gICAgICAgICBcInFcIjogXCJ0eXBlOlxcXCJSZXBvcnQgVGVtcGxhdGVcXFwiIHR5cGVrZXl3b3Jkczplc3JpV2ViU3RhbmRhcmRJbmZvZ3JhcGhpY1JlcG9ydCBvd25lcjplc3JpX3JlcG9ydHNcIixcclxuICAgIC8vICAgICAgICAgXCJzb3J0RmllbGRcIjogXCJ0aXRsZVwiLFxyXG4gICAgLy8gICAgICAgICBcInNvcnRPcmRlclwiOiBcImFzY1wiLFxyXG4gICAgLy8gICAgICAgICBcInN0YXJ0XCI6IDFcclxuICAgIC8vICAgICB9LFxyXG4gICAgLy8gICAgIFwidGFza1BhdGhcIjogXCIvc2VhcmNoXCJcclxuICAgIC8vIH1cclxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgIFRva2VuUHJvdmlkZXIuZ2V0VG9rZW4oKS50aGVuKGFzeW5jIChhY2Nlc3NfdG9rZW4pID0+IHtcclxuICAgICAgICBpZiAoIXNldHRpbmdzLmRhdGEpXHJcbiAgICAgICAgICBzZXR0aW5ncy5kYXRhID0ge307XHJcbiAgICAgICAgLy8gdG9kbzogdXNlIGRlZmF1bHQgcGFyYW1zIHdpdGggYWJpbGl0eSB0byBvdmVycmlkZSB0aGVtXHJcbiAgICAgICAgaWYgKCFzZXR0aW5ncy5kYXRhLmYpXHJcbiAgICAgICAgICBzZXR0aW5ncy5kYXRhLmYgPSAnanNvbic7XHJcbiAgICAgICAgc2V0dGluZ3MuZGF0YS50b2tlbiA9IGFjY2Vzc190b2tlbiA/IGFjY2Vzc190b2tlbiA6IHNldHRpbmdzLmRhdGEudG9rZW47XHJcbiAgICAgICAgaWYgKCFzZXR0aW5ncy5kYXRhLnRva2VuKSB7XHJcbiAgICAgICAgICBkZWxldGUgc2V0dGluZ3MuZGF0YS50b2tlbjtcclxuICAgICAgICB9XHJcbiAgICAgICAgc2V0dGluZ3MuZGF0YS5sYW5nQ29kZSA9IHNldHRpbmdzLmRhdGE/LmxhbmdDb2RlID8gc2V0dGluZ3MuZGF0YS5sYW5nQ29kZSA6ICdlbi11cyc7IC8vIHRvZG86IHVwZGF0ZVxyXG4gICAgICAgIC8vdG9kbzogdGltZW91dDogMzAwMDAgbXMgLSBuZWVkIHRvIGltcGxlbWVudCB2aWEgdGltZXIgYW5kIEFib3J0Q29udHJvbGxlclxyXG4gICAgICAgIGNvbnN0IGZvcm1EYXRhID0gbmV3IEZvcm1EYXRhKCk7XHJcbiAgICAgICAgZm9yIChsZXQga2V5IGluIHNldHRpbmdzLmRhdGEpXHJcbiAgICAgICAgICBmb3JtRGF0YS5hcHBlbmQoa2V5LCBzZXR0aW5ncy5kYXRhW2tleV0pO1xyXG4gICAgICAgIGxldCB1cmw7XHJcbiAgICAgICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChzZXR0aW5ncywgJ3VybCcpKSB7XHJcbiAgICAgICAgICB1cmwgPSBzZXR0aW5ncy51cmw7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgdXJsID0gYXdhaXQgQXJjR0lTQ2xpZW50LmdldFBvcnRhbFVybCgpO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvL2xldCB1cmwgPSBzZXR0aW5ncy51cmwgfHwgQXJjR0lTQ2xpZW50LmdldFBvcnRhbFVybCgpO1xyXG4gICAgICAgIGlmIChzZXR0aW5ncy50YXNrUGF0aClcclxuICAgICAgICAgIHVybCA9IHVybCArIHNldHRpbmdzLnRhc2tQYXRoO1xyXG4gICAgICAgIGxldCBwYXJhbXMgPSB7fTtcclxuICAgICAgICAvLyBTdGFuZGFyZCBHZW9ncmFwaHkgcXVlcnkgaXMgaGFuZGxlZCBkaWZmZXJlbnRseVxyXG4gICAgICAgIC8vIE5lZWQgdG8gYWRkIGNoYXJzZXQ9VVRGLTggdG8gQ29udGVudC1UeXBlIHJlcXVlc3QgaGVhZGVyXHJcbiAgICAgICAgaWYgKHNldHRpbmdzLmlzU3RhbmRhcmRHZW9RdWVyeSkge1xyXG4gICAgICAgICAgY29uc3QgcmVxdWVzdEhlYWRlcnMgPSBuZXcgSGVhZGVycygpO1xyXG4gICAgICAgICAgcmVxdWVzdEhlYWRlcnMuYXBwZW5kKCdDb250ZW50LVR5cGUnLCAnYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkOyBjaGFyc2V0PVVURi04Jyk7XHJcbiAgICAgICAgICBsZXQgYm9keURhdGEgPSAnJztcclxuICAgICAgICAgIGxldCBib29sZWFuRmlyc3QgPSB0cnVlO1xyXG4gICAgICAgICAgZm9yIChjb25zdCBrZXkgaW4gc2V0dGluZ3MuZGF0YSkge1xyXG4gICAgICAgICAgICBib2R5RGF0YSArPSBib29sZWFuRmlyc3QgPyAnJyA6ICcmJztcclxuICAgICAgICAgICAgYm9keURhdGEgKz0ga2V5ICsgJz0nICsgZW5jb2RlVVJJKHNldHRpbmdzLmRhdGFba2V5XSk7XHJcbiAgICAgICAgICAgIGJvb2xlYW5GaXJzdCA9IGZhbHNlO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgcGFyYW1zID0ge1xyXG4gICAgICAgICAgICBtZXRob2Q6ICdQT1NUJyxcclxuICAgICAgICAgICAgYm9keTogYm9keURhdGEsXHJcbiAgICAgICAgICAgIGhlYWRlcnM6IHJlcXVlc3RIZWFkZXJzXHJcbiAgICAgICAgICB9O1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIHtcclxuICAgICAgICAgIHBhcmFtcyA9IHtcclxuICAgICAgICAgICAgbWV0aG9kOiAnUE9TVCcsXHJcbiAgICAgICAgICAgIGJvZHk6IGZvcm1EYXRhXHJcbiAgICAgICAgICB9O1xyXG4gICAgICAgIH1cclxuICAgICAgICBmZXRjaCh1cmwsIHBhcmFtcykudGhlbihyZXNwb25zZSA9PiB7XHJcbiAgICAgICAgICBpZiAoIXJlc3BvbnNlLm9rKVxyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ05ldHdvcmsgcmVzcG9uc2UgZW5kZWQgd2l0aCBlcnJvci4nKTtcclxuICAgICAgICAgIC8vIHRvZG86IGNoZWNrIGlmIHJlc3BvbnNlIGlzIHN0cmluZz9cclxuICAgICAgICAgIHJldHVybiBzZXR0aW5ncy5kYXRhLmYgPT09ICdiaW4nID8gcmVzcG9uc2UuYmxvYigpIDogcmVzcG9uc2UuanNvbigpO1xyXG4gICAgICAgIH0pLnRoZW4ocmVzdWx0ID0+IHtcclxuICAgICAgICAgIC8vIEFyY0dJUyByZXR1cm5zIGVycm9yIHdpdGggSFRUUCAyeHggY29kZSwgc28gaGFuZGxlIGl0IGhlcmVcclxuICAgICAgICAgIHJlc3VsdC5lcnJvciA/IHJlamVjdChyZXN1bHQuZXJyb3IpIDogcmVzb2x2ZShyZXN1bHQpO1xyXG4gICAgICAgIH0pLmNhdGNoKGVycm9yID0+IHtcclxuICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yOicsIGVycm9yKTtcclxuICAgICAgICAgIHJlamVjdChlcnJvcik7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH0pLmNhdGNoKGVyciA9PiByZWplY3QoZXJyKSk7XHJcbiAgICB9KTtcclxuICB9XHJcbn1cblxuY2xhc3MgV2ViQXBwU2V0dGluZ3Mge1xyXG4gIHN0YXRpYyBnZXRCdXNpbmVzc0FuYWx5c3RPcmdhbml6YXRpb25hbFNldHRpbmdzKCkge1xyXG4gICAgcmV0dXJuIEFyY0dJU0NsaWVudC5nZXRQb3J0YWxSZXNvdXJjZSgnQnVzaW5lc3NBbmFseXN0X09yZ2FuaXphdGlvbmFsX1NldHRpbmdzLmpzb24nKTtcclxuICB9XHJcbiAgc3RhdGljIGdldERpc2FibGVkUmVwb3J0cygpIHtcclxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4ge1xyXG4gICAgICBsZXQgZW1wdHlSZXNvbHZlT25FcnIgPSAoZXJyKSA9PiB7XHJcbiAgICAgICAgcmVzb2x2ZSh7fSk7XHJcbiAgICAgICAgTG9nei5zaG93KCclZScsICdXZWJBcHBTZXR0aW5ncyBlcnJvcicsIGVycik7XHJcbiAgICAgIH07XHJcbiAgICAgIEFyY0dJU0NsaWVudC5leGVjdXRlU2VsZigpLnRoZW4oKHNlbGZSZXNwb25zZSkgPT4ge1xyXG4gICAgICAgIGxldCByb2xlSWQgPSBzZWxmUmVzcG9uc2UudXNlci5yb2xlSWQgfHwgc2VsZlJlc3BvbnNlLnVzZXIucm9sZTtcclxuICAgICAgICBXZWJBcHBTZXR0aW5ncy5nZXRCdXNpbmVzc0FuYWx5c3RPcmdhbml6YXRpb25hbFNldHRpbmdzKCkudGhlbigoc2V0dGluZ3MpID0+IHtcclxuICAgICAgICAgIGxldCBkaXNhYmxlZFJlcG9ydHMgPSBzZXR0aW5nc1sndXNlclJvbGVzLmRpc2FibGVkQXJlYXMucmVwb3J0cyddO1xyXG4gICAgICAgICAgaWYgKGRpc2FibGVkUmVwb3J0cyAmJiBkaXNhYmxlZFJlcG9ydHNbcm9sZUlkXSlcclxuICAgICAgICAgICAgcmVzb2x2ZShkaXNhYmxlZFJlcG9ydHNbcm9sZUlkXSk7XHJcbiAgICAgICAgICBlbHNlXHJcbiAgICAgICAgICAgIHJlc29sdmUoe30pO1xyXG4gICAgICAgIH0pLmNhdGNoKGVtcHR5UmVzb2x2ZU9uRXJyKTtcclxuICAgICAgfSkuY2F0Y2goZW1wdHlSZXNvbHZlT25FcnIpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIEdldHMgaWRzIG9mIGluZm9ncmFwaGljIHRlbXBsYXRlcyB0aGF0IHVzZXIgYWRkZWQgdG8gXCJNeSBUZW1wbGF0ZXNcIiBmcm9tIFwiR2FsbGVyeVwiXHJcbiAgICogKHVzZXMgbmV3IHZlcnNpb24gb2YgdXNlciBzZXR0aW5ncylcclxuICAgKlxyXG4gICAqIEByZXR1cm5zIHsqfVxyXG4gICAqL1xyXG4gIHN0YXRpYyBnZXRVc2VyR2FsbGVyeUluZm9ncmFwaGljUmVwb3J0SWRzKCkge1xyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgV2ViQXBwU2V0dGluZ3MuX3NlYXJjaEdhbGxlcnlJbmZvZ3JhcGhpY1ByZWZlcmVuY2VzSXRlbSgpLnRoZW4oKGdhbGxlcnlQcmVmSXRlbSkgPT4ge1xyXG4gICAgICAgIGlmICghZ2FsbGVyeVByZWZJdGVtKSB7XHJcbiAgICAgICAgICByZWplY3QobnVsbCk7XHJcbiAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIGFzc3VtaW5nIFwicHJvcGVydGllc1wiOiB7XCJpbkRhdGFcIjogXCJ0cnVlXCJ9LFxyXG4gICAgICAgIGxldCBpdGVtSWQgPSBnYWxsZXJ5UHJlZkl0ZW0uaWQ7XHJcbiAgICAgICAgQXJjR0lTQ2xpZW50LmdldEl0ZW1EYXRhKGl0ZW1JZCkudGhlbigoaXRlbURhdGEpID0+IHtcclxuICAgICAgICAgIHJlc29sdmUoaXRlbURhdGEgJiZcclxuICAgICAgICAgICAgaXRlbURhdGEuZGF0YSAmJlxyXG4gICAgICAgICAgICBpdGVtRGF0YS5kYXRhLm15R2FsbGVyeUluZm9ncmFwaGljUmVwb3J0SWRzKTtcclxuICAgICAgICB9KS5jYXRjaChlcnIgPT4gcmVqZWN0KGVycikpO1xyXG4gICAgICB9KS5jYXRjaChlcnIgPT4gcmVqZWN0KGVycikpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG4gIHN0YXRpYyBfc2VhcmNoR2FsbGVyeUluZm9ncmFwaGljUHJlZmVyZW5jZXNJdGVtKCkge1xyXG4gICAgcmV0dXJuIFdlYkFwcFNldHRpbmdzLl9zZWFyY2hVc2VySXRlbSgnZXNyaUZhdm9yaXRlUmVwb3J0VGVtcGxhdGVzJyk7XHJcbiAgfVxyXG4gIHN0YXRpYyBfc2VhcmNoVXNlckl0ZW0odHlwZWtleXdvcmRzKSB7XHJcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICBBcmNHSVNDbGllbnQuZXhlY3V0ZVNlbGYoKS50aGVuKChzZWxmUmVzcG9uc2UpID0+IHtcclxuICAgICAgICBsZXQgdXNlcm5hbWUgPSBzZWxmUmVzcG9uc2UudXNlci51c2VybmFtZTtcclxuICAgICAgICBsZXQgcXVlcnkgPSB7XHJcbiAgICAgICAgICB0eXBlOiAnV2ViIE1hcHBpbmcgQXBwbGljYXRpb24nLFxyXG4gICAgICAgICAgdHlwZWtleXdvcmRzOiB0eXBla2V5d29yZHMsXHJcbiAgICAgICAgICBvd25lcjogdXNlcm5hbWVcclxuICAgICAgICB9O1xyXG4gICAgICAgIGxldCBwYXJhbXMgPSB7IG51bTogMSB9O1xyXG4gICAgICAgIEFyY0dJU0NsaWVudC5zZWFyY2hJdGVtcyhxdWVyeSwgcGFyYW1zLCB1bmRlZmluZWQpLnRoZW4oKGl0ZW1zKSA9PiB7XHJcbiAgICAgICAgICByZXNvbHZlKGl0ZW1zICYmIGl0ZW1zLmxlbmd0aCAmJiBpdGVtc1swXSk7XHJcbiAgICAgICAgfSkuY2F0Y2goZXJyID0+IHJlamVjdChlcnIpKTtcclxuICAgICAgfSkuY2F0Y2goZXJyID0+IHJlamVjdChlcnIpKTtcclxuICAgIH0pO1xyXG4gIH1cclxufVxuXG5jbGFzcyBTZXR0aW5nc0hlbHBlciB7XHJcbiAgc3RhdGljIGdldEVudmlyb25tZW50KCkge1xyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7XHJcbiAgICAgIHJlc29sdmUoRW52aXJvbm1lbnRzLmdldEVudmlyb25tZW50KCkpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG4gIHN0YXRpYyBzZXRFbnZpcm9ubWVudChlbnZpcm9ubWVudCkge1xyXG4gICAgaWYgKGVudmlyb25tZW50ICYmIGVudmlyb25tZW50Lmxlbmd0aCA+IDApIHtcclxuICAgICAgRW52aXJvbm1lbnRzLnNldEVudmlyb25tZW50KGVudmlyb25tZW50KTtcclxuICAgIH1cclxuICAgIGVsc2Uge1xyXG4gICAgICBMb2d6LnNob3coJyVlJywgJ2JhLXJlcG9ydHMgZXJyb3I6IHNldEVudmlyb25tZW50KCkgaW52YWxpZCBhcmcnKTtcclxuICAgIH1cclxuICB9XHJcbiAgc3RhdGljIGFzeW5jIGdldFBvcnRhbEJhc2VVcmwoKSB7XHJcbiAgICByZXR1cm4gRW52aXJvbm1lbnRzLmdldFVybCgnYXJjZ2lzJyk7XHJcbiAgfVxyXG4gIHN0YXRpYyBpc1RydWVTdHJpbmcodmFsdWUpIHtcclxuICAgIHJldHVybiBTdHJpbmcodmFsdWUpLnRvTG93ZXJDYXNlKCkgPT09ICd0cnVlJztcclxuICB9XHJcbn1cblxuY2xhc3MgUmVwb3J0VGVtcGxhdGVzTWFuYWdlciB7XHJcbiAgc3RhdGljIF9jb25kZW5zZVJlc3VsdHNBcnJheShkYXRhKSB7XHJcbiAgICAvLyBzaW1wbGlmeVxyXG4gICAgY29uc3QgYXJyID0gZGF0YS5tYXAoKG9iaikgPT4ge1xyXG4gICAgICByZXR1cm4geyBpZDogb2JqLmlkLCB0aXRsZTogb2JqLnRpdGxlLCBkYXRlOiBvYmoubW9kaWZpZWQgfTtcclxuICAgIH0pO1xyXG4gICAgLy8gcmVtb3ZlIGR1cGxpY2F0ZXMgYnkgdGl0bGVcclxuICAgIGNvbnN0IG5hbWVzID0gYXJyLm1hcCgoYSkgPT4gYS50aXRsZSk7XHJcbiAgICBjb25zdCByZXN1bHQgPSBhcnIuZmlsdGVyKChvYmosIGluZGV4KSA9PiB7XHJcbiAgICAgIHJldHVybiBuYW1lcy5pbmRleE9mKG9iai50aXRsZSkgPT0gaW5kZXg7XHJcbiAgICB9KTtcclxuICAgIHJldHVybiByZXN1bHQ7XHJcbiAgfVxyXG4gIHN0YXRpYyBfY29uZGVuc2VSZXN1bHRzQXJyYXlHRUluZm9ncmFwaGljcyhkYXRhKSB7XHJcbiAgICAvLyBzaW1wbGlmeVxyXG4gICAgbGV0IGRhdGUsIHQxLCB0MjtcclxuICAgIGNvbnN0IGFyciA9IGRhdGEubWFwKChvYmopID0+IHtcclxuICAgICAgdHJ5IHtcclxuICAgICAgICBpZiAob2JqLm1ldGFkYXRhLmxhc3RSZXZpc2lvbkRhdGUpIHtcclxuICAgICAgICAgIHQyID0gb2JqLm1ldGFkYXRhLmxhc3RSZXZpc2lvbkRhdGU7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChvYmoubWV0YWRhdGEuY3JlYXRpb25EYXRlKSB7XHJcbiAgICAgICAgICB0MSA9IG9iai5tZXRhZGF0YS5jcmVhdGlvbkRhdGU7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICh0MSkge1xyXG4gICAgICAgICAgaWYgKCF0Mikge1xyXG4gICAgICAgICAgICBkYXRlID0gdDE7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgZGF0ZSA9ICh0MiA+IHQxKSA/IHQyIDogdDE7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICAgIGNhdGNoIChleCkge1xyXG4gICAgICAgIGNvbnNvbGUubG9nKCdSZXBvcnRUZW1wbGF0ZXNNYW5hZ2VyIGVycm9yJywgZXgpO1xyXG4gICAgICB9XHJcbiAgICAgIHJldHVybiB7IGlkOiBvYmouaXRlbUlELCB0aXRsZTogb2JqLm1ldGFkYXRhLnRpdGxlLCBkYXRlOiBkYXRlIH07XHJcbiAgICB9KTtcclxuICAgIC8vIHJlbW92ZSBkdXBsaWNhdGVzIGJ5IHRpdGxlXHJcbiAgICBjb25zdCBuYW1lcyA9IGFyci5tYXAoKGEpID0+IGEudGl0bGUpO1xyXG4gICAgY29uc3QgcmVzdWx0ID0gYXJyLmZpbHRlcigob2JqLCBpbmRleCkgPT4ge1xyXG4gICAgICByZXR1cm4gbmFtZXMuaW5kZXhPZihvYmoudGl0bGUpID09IGluZGV4O1xyXG4gICAgfSk7XHJcbiAgICByZXR1cm4gcmVzdWx0O1xyXG4gIH1cclxuICAvKipcclxuICAgKiBHZXRzIHJlcG9ydCB0ZW1wbGF0ZXMgZm9yIGNvdW50cnkgaWRlbnRpZmllZCBieSBjb3VudHJ5IGNvZGUuIEZpbmFsIHJlcG9ydFxyXG4gICAqIHRlbXBsYXRlcyBzZXQgY29uc2lzdHMgb2YgdGVtcGxhdGVzIGZyb20gR2VvRW5yaWNobWVudCBhbmQgZnJvbSBBR09MXHJcbiAgICpcclxuICAgKiBAcGFyYW0gY291bnRyeUNvZGUgT25seSAyLWxldHRlciBjb3VudHJ5Q29kZSEgdG9kbzogY29uc3VtZSAzLWxldHRlciBhbHNvXHJcbiAgICogQHBhcmFtIGZ1bGwgICAgICAgIEZsYWcgVHJ1ZT1yZXR1cm4gYWxsIGRhdGEsIEZhbHNlPXJldHVybiBJZCArIFRpdGxlIG9ubHlcclxuICAgKiBAcmV0dXJuIHtQcm9taXNlPHVua25vd24+fVxyXG4gICAqL1xyXG4gIHN0YXRpYyBnZXRSZXBvcnRUZW1wbGF0ZXMoY291bnRyeUNvZGUsIGZ1bGwgPSBmYWxzZSkge1xyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgbGV0IHJlcG9ydFRlbXBsYXRlcyA9IHtcclxuICAgICAgICBnZTogdW5kZWZpbmVkLFxyXG4gICAgICAgIHNoYXJlZDogdW5kZWZpbmVkLFxyXG4gICAgICAgIHVzZXI6IHVuZGVmaW5lZCxcclxuICAgICAgICBmYXZvcml0ZUlkczogdW5kZWZpbmVkXHJcbiAgICAgIH07XHJcbiAgICAgIEFyY0dJU0NsaWVudC5leGVjdXRlU2VsZigpXHJcbiAgICAgICAgLnRoZW4oKHNlbGZSZXNwb25zZSkgPT4ge1xyXG4gICAgICAgIGxldCB1c2VybmFtZSA9IHNlbGZSZXNwb25zZS51c2VyLnVzZXJuYW1lO1xyXG4gICAgICAgIFByb21pc2UuYWxsU2V0dGxlZChbXHJcbiAgICAgICAgICAvLyBSZXBvcnRUZW1wbGF0ZXNNYW5hZ2VyLl9nZXRHRVJlcG9ydFRlbXBsYXRlcyhjb3VudHJ5Q29kZSksXHJcbiAgICAgICAgICBSZXBvcnRUZW1wbGF0ZXNNYW5hZ2VyLl9nZXRTaGFyZWRDdXN0b21SZXBvcnRUZW1wbGF0ZUl0ZW1zKHVzZXJuYW1lKSxcclxuICAgICAgICAgIFJlcG9ydFRlbXBsYXRlc01hbmFnZXIuX2dldE15Q3VzdG9tUmVwb3J0VGVtcGxhdGVJdGVtcyh1c2VybmFtZSksXHJcbiAgICAgICAgICBSZXBvcnRUZW1wbGF0ZXNNYW5hZ2VyLl9nZXRGYXZvcml0ZVJlcG9ydHNJZHModXNlcm5hbWUsIGNvdW50cnlDb2RlKVxyXG4gICAgICAgIF0pLnRoZW4oKHJlcykgPT4ge1xyXG4gICAgICAgICAgcmVwb3J0VGVtcGxhdGVzLmdlID0gcmVzWzBdLnZhbHVlID8gcmVzWzBdLnZhbHVlIDogW107XHJcbiAgICAgICAgICByZXBvcnRUZW1wbGF0ZXMuc2hhcmVkID0gUmVwb3J0VGVtcGxhdGVzTWFuYWdlci5fY3JlYXRlUmVwb3J0VGVtcGxhdGVJbmZvcyhyZXNbMV0gJiYgcmVzWzFdLnZhbHVlID8gcmVzWzFdLnZhbHVlIDogW10sIGNvdW50cnlDb2RlKTtcclxuICAgICAgICAgIHJlcG9ydFRlbXBsYXRlcy51c2VyID0gUmVwb3J0VGVtcGxhdGVzTWFuYWdlci5fY3JlYXRlUmVwb3J0VGVtcGxhdGVJbmZvcyhyZXNbMl0gJiYgcmVzWzJdLnZhbHVlID8gcmVzWzJdLnZhbHVlIDogW10sIGNvdW50cnlDb2RlKTtcclxuICAgICAgICAgIHJlcG9ydFRlbXBsYXRlcy5mYXZvcml0ZUlkcyA9XHJcbiAgICAgICAgICAgIHJlc1szXSAmJiByZXNbM10udmFsdWUgPyByZXNbM10udmFsdWUgOiBbXTtcclxuICAgICAgICAgIFdlYkFwcFNldHRpbmdzLmdldERpc2FibGVkUmVwb3J0cygpXHJcbiAgICAgICAgICAgIC50aGVuKChkaXNhYmxlZFJlcG9ydHMpID0+IHtcclxuICAgICAgICAgICAgbGV0IGdlID0gcmVwb3J0VGVtcGxhdGVzLmdlO1xyXG4gICAgICAgICAgICBsZXQgc2hhcmVkID0gcmVwb3J0VGVtcGxhdGVzLnNoYXJlZDtcclxuICAgICAgICAgICAgaWYgKGdlICE9IG51bGwpIHtcclxuICAgICAgICAgICAgICByZXBvcnRUZW1wbGF0ZXMuZ2UgPSBnZS5maWx0ZXIoKHRlbXBsYXRlKSA9PiB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gIWRpc2FibGVkUmVwb3J0c1t0ZW1wbGF0ZS5yZXBvcnRJRF07XHJcbiAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgaWYgKHNoYXJlZCAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICByZXBvcnRUZW1wbGF0ZXMuc2hhcmVkID0gc2hhcmVkLmZpbHRlcigodGVtcGxhdGUpID0+IHtcclxuICAgICAgICAgICAgICAgICAgcmV0dXJuICFkaXNhYmxlZFJlcG9ydHNbdGVtcGxhdGUucmVwb3J0SUQuaXRlbWlkXTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAoIWZ1bGwpIHtcclxuICAgICAgICAgICAgICByZXBvcnRUZW1wbGF0ZXMuZ2UgPSBSZXBvcnRUZW1wbGF0ZXNNYW5hZ2VyLl9jb25kZW5zZVJlc3VsdHNBcnJheShyZXBvcnRUZW1wbGF0ZXMuZ2UpO1xyXG4gICAgICAgICAgICAgIHJlcG9ydFRlbXBsYXRlcy5zaGFyZWQgPSBSZXBvcnRUZW1wbGF0ZXNNYW5hZ2VyLl9jb25kZW5zZVJlc3VsdHNBcnJheShyZXBvcnRUZW1wbGF0ZXMuc2hhcmVkKTtcclxuICAgICAgICAgICAgICByZXBvcnRUZW1wbGF0ZXMudXNlciA9IFJlcG9ydFRlbXBsYXRlc01hbmFnZXIuX2NvbmRlbnNlUmVzdWx0c0FycmF5KHJlcG9ydFRlbXBsYXRlcy51c2VyKTtcclxuICAgICAgICAgICAgICByZXBvcnRUZW1wbGF0ZXMuZmF2b3JpdGVJZHMgPSBSZXBvcnRUZW1wbGF0ZXNNYW5hZ2VyLl9jb25kZW5zZVJlc3VsdHNBcnJheShyZXBvcnRUZW1wbGF0ZXMuZmF2b3JpdGVJZHMpO1xyXG4gICAgICAgICAgICAgIHJlc29sdmUocmVwb3J0VGVtcGxhdGVzKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICByZXNvbHZlKHJlcG9ydFRlbXBsYXRlcyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIC5jYXRjaCgoZXJyKSA9PiByZWplY3QoZXJyKSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH0pXHJcbiAgICAgICAgLmNhdGNoKChlcnIpID0+IHJlamVjdChlcnIpKTtcclxuICAgIH0pO1xyXG4gIH1cclxuICBzdGF0aWMgX2dldEdFUmVwb3J0VGVtcGxhdGVzKGNvdW50cnlDb2RlKSB7XHJcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICAvLyB0b2RvOiBzdG9yZSB0ZW1wbGF0ZXMgaW4gY291bnRyeSBpbnN0YW5jZTogY291bnRyeS5yZXBvcnRUZW1wbGF0ZXM7XHJcbiAgICAgIGxldCByZXBvcnRUZW1wbGF0ZXMgPSBSZXBvcnRUZW1wbGF0ZXNNYW5hZ2VyLl9nZVJlcG9ydFRlbXBsYXRlc0NhY2hlW2NvdW50cnlDb2RlXTtcclxuICAgICAgaWYgKHJlcG9ydFRlbXBsYXRlcykge1xyXG4gICAgICAgIHJlc29sdmUocmVwb3J0VGVtcGxhdGVzKTtcclxuICAgICAgICByZXR1cm47XHJcbiAgICAgIH1cclxuICAgICAgR0VDbGllbnQuZXhlY3V0ZSh7IHRhc2tQYXRoOiAnL0dlb0VucmljaG1lbnQvUmVwb3J0cy8nICsgY291bnRyeUNvZGUgfSlcclxuICAgICAgICAudGhlbigocmVwb3J0VGVtcGxhdGVzUmVzcG9uc2UpID0+IHtcclxuICAgICAgICBsZXQgcmVwb3J0VGVtcGxhdGVzID0gcmVwb3J0VGVtcGxhdGVzUmVzcG9uc2UucmVwb3J0cztcclxuICAgICAgICBSZXBvcnRUZW1wbGF0ZXNNYW5hZ2VyLl9nZVJlcG9ydFRlbXBsYXRlc0NhY2hlW2NvdW50cnlDb2RlXSA9IHJlcG9ydFRlbXBsYXRlcztcclxuICAgICAgICByZXNvbHZlKHJlcG9ydFRlbXBsYXRlcyk7XHJcbiAgICAgIH0pXHJcbiAgICAgICAgLmNhdGNoKHJlamVjdCk7XHJcbiAgICB9KTtcclxuICB9XHJcbiAgc3RhdGljIF9nZXRTaGFyZWRDdXN0b21SZXBvcnRUZW1wbGF0ZUl0ZW1zKHVzZXJuYW1lKSB7XHJcbiAgICBsZXQgcXVlcnkgPSAndHlwZTpcIlJlcG9ydCBUZW1wbGF0ZVwiIChhY2Nlc3M6c2hhcmVkIE9SIGFjY2VzczpvcmcpIHR5cGVrZXl3b3JkczooZXNyaVdlYlJlcG9ydCBOT1QgZXNyaVdlYkluZm9ncmFwaGljUmVwb3J0KSBOT1Qgb3duZXI6JyArXHJcbiAgICAgIHVzZXJuYW1lO1xyXG4gICAgcmV0dXJuIFJlcG9ydFRlbXBsYXRlc01hbmFnZXIuX3NlYXJjaEl0ZW1zKHF1ZXJ5LCBSZXBvcnRUZW1wbGF0ZXNNYW5hZ2VyLl9yZW1vdmVJbmZvZ3JhcGhpY1RlbXBsYXRlcyk7XHJcbiAgfVxyXG4gIHN0YXRpYyBfZ2V0TXlDdXN0b21SZXBvcnRUZW1wbGF0ZUl0ZW1zKHVzZXJuYW1lKSB7XHJcbiAgICBsZXQgcXVlcnkgPSAndHlwZTpcIlJlcG9ydCBUZW1wbGF0ZVwiIHR5cGVrZXl3b3JkczooZXNyaVdlYlJlcG9ydCBOT1QgZXNyaVdlYkluZm9ncmFwaGljUmVwb3J0KSBvd25lcjonICtcclxuICAgICAgdXNlcm5hbWU7XHJcbiAgICByZXR1cm4gUmVwb3J0VGVtcGxhdGVzTWFuYWdlci5fc2VhcmNoSXRlbXMocXVlcnksIFJlcG9ydFRlbXBsYXRlc01hbmFnZXIuX3JlbW92ZUluZm9ncmFwaGljVGVtcGxhdGVzKTtcclxuICB9XHJcbiAgc3RhdGljIF9yZW1vdmVJbmZvZ3JhcGhpY1RlbXBsYXRlcyhyZXBvcnRUZW1wbGF0ZUl0ZW0pIHtcclxuICAgIHJldHVybiAhU2V0dGluZ3NIZWxwZXIuaXNUcnVlU3RyaW5nKHJlcG9ydFRlbXBsYXRlSXRlbS5wcm9wZXJ0aWVzLmlzR3JhcGhpY1JlcG9ydCk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqXHJcbiAgICogQHBhcmFtIGNvdW50cnlDb2RlIE9ubHkgMi1sZXR0ZXIgY291bnRyeUNvZGUhIHRvZG86IGNvbnN1bWUgMy1sZXR0ZXIgYWxzb1xyXG4gICAqIEByZXR1cm4ge1Byb21pc2U8dW5rbm93bj59XHJcbiAgICovXHJcbiAgc3RhdGljIGdldEluZm9ncmFwaGljUmVwb3J0VGVtcGxhdGVJdGVtcyhjb3VudHJ5Q29kZSwgZnVsbCA9IGZhbHNlLCB0b2tlbikge1xyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKGFzeW5jIChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgbGV0IGluZm9ncmFwaGljSXRlbXMgPSB7XHJcbiAgICAgICAgcHVibGljOiB1bmRlZmluZWQsXHJcbiAgICAgICAgc2hhcmVkOiB1bmRlZmluZWQsXHJcbiAgICAgICAgdXNlcjogdW5kZWZpbmVkLFxyXG4gICAgICAgIGZhdm9yaXRlSWRzOiB1bmRlZmluZWQsXHJcbiAgICAgICAgZ2FsbGVyeTogdW5kZWZpbmVkXHJcbiAgICAgIH07XHJcbiAgICAgIGNvbnN0IGRlZmF1bHRIaWVyYXJjaHkgPSBhd2FpdCBHRUNsaWVudC5nZXRHRURlZmF1bHRIaWVyYXJjaHkoY291bnRyeUNvZGUsIHRva2VuKTtcclxuICAgICAgQXJjR0lTQ2xpZW50LmV4ZWN1dGVTZWxmKClcclxuICAgICAgICAudGhlbigoc2VsZlJlc3BvbnNlKSA9PiB7XHJcbiAgICAgICAgbGV0IHVzZXJuYW1lID0gc2VsZlJlc3BvbnNlLnVzZXIudXNlcm5hbWU7XHJcbiAgICAgICAgbGV0IG9yZ0lkID0gc2VsZlJlc3BvbnNlLnVzZXIub3JnSWQ7XHJcbiAgICAgICAgLy8gbGV0IGNvdW50cnlDb2RlID0gY291bnRyeS5pZDtcclxuICAgICAgICBQcm9taXNlLmFsbFNldHRsZWQoW1xyXG4gICAgICAgICAgUmVwb3J0VGVtcGxhdGVzTWFuYWdlci5fZ2V0RXNyaUluZm9ncmFwaGljUmVwb3J0VGVtcGxhdGVJdGVtcyhjb3VudHJ5Q29kZSksXHJcbiAgICAgICAgICBSZXBvcnRUZW1wbGF0ZXNNYW5hZ2VyLl9nZXRTaGFyZWRJbmZvZ3JhcGhpY1JlcG9ydFRlbXBsYXRlSXRlbXModXNlcm5hbWUsIG9yZ0lkKSxcclxuICAgICAgICAgIFJlcG9ydFRlbXBsYXRlc01hbmFnZXIuX2dldFVzZXJJbmZvZ3JhcGhpY1JlcG9ydFRlbXBsYXRlSXRlbXModXNlcm5hbWUpLFxyXG4gICAgICAgICAgUmVwb3J0VGVtcGxhdGVzTWFuYWdlci5fZ2V0RmF2b3JpdGVSZXBvcnRzSWRzKHVzZXJuYW1lLCBjb3VudHJ5Q29kZSksXHJcbiAgICAgICAgICBSZXBvcnRUZW1wbGF0ZXNNYW5hZ2VyLl9nZXRHYWxsZXJ5SW5mb2dyYXBoaWNSZXBvcnRUZW1wbGF0ZUl0ZW1zKClcclxuICAgICAgICAgIC8vXHJcbiAgICAgICAgXSkudGhlbigocmVzKSA9PiB7XHJcbiAgICAgICAgICBsZXQgYnlDb3VudHJ5QW5kRGVmYXVsdEhpZWFyY2h5ID0gUmVwb3J0VGVtcGxhdGVzTWFuYWdlci5fYnlDb3VudHJ5QW5kRGVmYXVsdEhpZWFyY2h5KGNvdW50cnlDb2RlLCBkZWZhdWx0SGllcmFyY2h5KTtcclxuICAgICAgICAgIGluZm9ncmFwaGljSXRlbXMucHVibGljID0gcmVzWzBdLnZhbHVlXHJcbiAgICAgICAgICAgID8gcmVzWzBdLnZhbHVlLmZpbHRlcihieUNvdW50cnlBbmREZWZhdWx0SGllYXJjaHkpXHJcbiAgICAgICAgICAgIDogW107XHJcbiAgICAgICAgICBpbmZvZ3JhcGhpY0l0ZW1zLnNoYXJlZCA9IHJlc1sxXS52YWx1ZVxyXG4gICAgICAgICAgICA/IHJlc1sxXS52YWx1ZS5maWx0ZXIoYnlDb3VudHJ5QW5kRGVmYXVsdEhpZWFyY2h5KVxyXG4gICAgICAgICAgICA6IFtdO1xyXG4gICAgICAgICAgaW5mb2dyYXBoaWNJdGVtcy51c2VyID0gcmVzWzJdLnZhbHVlXHJcbiAgICAgICAgICAgID8gcmVzWzJdLnZhbHVlLmZpbHRlcihieUNvdW50cnlBbmREZWZhdWx0SGllYXJjaHkpXHJcbiAgICAgICAgICAgIDogW107XHJcbiAgICAgICAgICAvLyBpbmZvZ3JhcGhpY0l0ZW1zLnB1YmxpYyA9IGluZm9ncmFwaGljSXRlbXMucHVibGljXHJcbiAgICAgICAgICAvLyAgID8gcmVzWzBdLnZhbHVlLmZpbHRlciAoYnlEZWZhdWx0SGllcmFyY2h5KVxyXG4gICAgICAgICAgLy8gICA6IFtdXHJcbiAgICAgICAgICAvLyBpbmZvZ3JhcGhpY0l0ZW1zLnNoYXJlZCA9IHJlc1sxXS52YWx1ZVxyXG4gICAgICAgICAgLy8gICA/IHJlc1sxXS52YWx1ZS5maWx0ZXIgKGJ5RGVmYXVsdEhpZXJhcmNoeSlcclxuICAgICAgICAgIC8vICAgOiBbXVxyXG4gICAgICAgICAgLy8gaW5mb2dyYXBoaWNJdGVtcy51c2VyID0gcmVzWzJdLnZhbHVlXHJcbiAgICAgICAgICAvLyAgID8gcmVzWzJdLnZhbHVlLmZpbHRlciAoYnlEZWZhdWx0SGllcmFyY2h5KVxyXG4gICAgICAgICAgLy8gICA6IFtdXHJcbiAgICAgICAgICBpbmZvZ3JhcGhpY0l0ZW1zLmZhdm9yaXRlSWRzID0gcmVzWzNdLnZhbHVlID8gcmVzWzNdLnZhbHVlIDogW107XHJcbiAgICAgICAgICBpbmZvZ3JhcGhpY0l0ZW1zLmdhbGxlcnkgPSByZXNbNF0udmFsdWVcclxuICAgICAgICAgICAgPyByZXNbNF0udmFsdWUuZmlsdGVyKGJ5Q291bnRyeUFuZERlZmF1bHRIaWVhcmNoeSlcclxuICAgICAgICAgICAgOiBbXTtcclxuICAgICAgICAgIGxldCB1c2VyID0gaW5mb2dyYXBoaWNJdGVtcy51c2VyO1xyXG4gICAgICAgICAgaWYgKHVzZXIgIT0gbnVsbCkge1xyXG4gICAgICAgICAgICAvLyBzb3J0IGFscGhhYmV0aWNhbGx5IGJ5IHRpdGxlXHJcbiAgICAgICAgICAgIHVzZXIuc29ydChmdW5jdGlvbiAoaXRlbTEsIGl0ZW0yKSB7XHJcbiAgICAgICAgICAgICAgcmV0dXJuIGl0ZW0xLnRpdGxlLmxvY2FsZUNvbXBhcmUoaXRlbTIudGl0bGUpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIFdlYkFwcFNldHRpbmdzLmdldERpc2FibGVkUmVwb3J0cygpXHJcbiAgICAgICAgICAgIC50aGVuKChkaXNhYmxlZFJlcG9ydHMpID0+IHtcclxuICAgICAgICAgICAgbGV0IGZpbHRlckRpc2FibGVkID0gZnVuY3Rpb24gKGlnSXRlbSkge1xyXG4gICAgICAgICAgICAgIHJldHVybiAhZGlzYWJsZWRSZXBvcnRzW2lnSXRlbS5pZF07XHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIGxldCBwdWIgPSBpbmZvZ3JhcGhpY0l0ZW1zLnB1YmxpYztcclxuICAgICAgICAgICAgaWYgKHB1YiAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgaW5mb2dyYXBoaWNJdGVtcy5wdWJsaWMgPSBwdWIuZmlsdGVyKGZpbHRlckRpc2FibGVkKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBsZXQgc2hhcmVkID0gaW5mb2dyYXBoaWNJdGVtcy5zaGFyZWQ7XHJcbiAgICAgICAgICAgIGlmIChzaGFyZWQgIT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgIGluZm9ncmFwaGljSXRlbXMuc2hhcmVkID0gc2hhcmVkLmZpbHRlcihmaWx0ZXJEaXNhYmxlZCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgbGV0IGdhbGxlcnkgPSBpbmZvZ3JhcGhpY0l0ZW1zLmdhbGxlcnk7XHJcbiAgICAgICAgICAgIGlmIChnYWxsZXJ5ICE9IG51bGwpIHtcclxuICAgICAgICAgICAgICBpbmZvZ3JhcGhpY0l0ZW1zLmdhbGxlcnkgPSBnYWxsZXJ5LmZpbHRlcihmaWx0ZXJEaXNhYmxlZCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKCFmdWxsKSB7XHJcbiAgICAgICAgICAgICAgaW5mb2dyYXBoaWNJdGVtcy5wdWJsaWMgPSBSZXBvcnRUZW1wbGF0ZXNNYW5hZ2VyLl9jb25kZW5zZVJlc3VsdHNBcnJheUdFSW5mb2dyYXBoaWNzKGluZm9ncmFwaGljSXRlbXMucHVibGljKTtcclxuICAgICAgICAgICAgICBpbmZvZ3JhcGhpY0l0ZW1zLnNoYXJlZCA9IFJlcG9ydFRlbXBsYXRlc01hbmFnZXIuX2NvbmRlbnNlUmVzdWx0c0FycmF5KGluZm9ncmFwaGljSXRlbXMuc2hhcmVkKTtcclxuICAgICAgICAgICAgICBpbmZvZ3JhcGhpY0l0ZW1zLnVzZXIgPSBSZXBvcnRUZW1wbGF0ZXNNYW5hZ2VyLl9jb25kZW5zZVJlc3VsdHNBcnJheShpbmZvZ3JhcGhpY0l0ZW1zLnVzZXIpO1xyXG4gICAgICAgICAgICAgIGluZm9ncmFwaGljSXRlbXMuZmF2b3JpdGVJZHMgPSBSZXBvcnRUZW1wbGF0ZXNNYW5hZ2VyLl9jb25kZW5zZVJlc3VsdHNBcnJheShpbmZvZ3JhcGhpY0l0ZW1zLmZhdm9yaXRlSWRzKTtcclxuICAgICAgICAgICAgICBpbmZvZ3JhcGhpY0l0ZW1zLmdhbGxlcnkgPSBSZXBvcnRUZW1wbGF0ZXNNYW5hZ2VyLl9jb25kZW5zZVJlc3VsdHNBcnJheShpbmZvZ3JhcGhpY0l0ZW1zLmdhbGxlcnkpO1xyXG4gICAgICAgICAgICAgIHJlc29sdmUoaW5mb2dyYXBoaWNJdGVtcyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgcmVzb2x2ZShpbmZvZ3JhcGhpY0l0ZW1zKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfSlcclxuICAgICAgICAgICAgLmNhdGNoKChlcnIpID0+IHJlamVjdChlcnIpKTtcclxuICAgICAgICB9KTtcclxuICAgICAgfSlcclxuICAgICAgICAuY2F0Y2goKGVycikgPT4gcmVqZWN0KGVycikpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIEdldHMgZnVuY3Rpb24gdG8gZmlsdGVyIHBvcnRhbCBpdGVtcyBhcnJheXMgYnkgY291bnRyeSBjb2RlIGluIGl0cyBwcm9wZXJ0aWVzXHJcbiAgICpcclxuICAgKiBAcGFyYW0gY291bnRyeUNvZGUgY291bnRyeSBjb2RlIHRoYXQgaXRlbSdzICdjb3VudHJpZXMnIGFycmF5IHNob3VsZCBjb250YWluXHJcbiAgICogQHJldHVybnMge2Z1bmN0aW9uKCopOiBib29sZWFufVxyXG4gICAqL1xyXG4gIHN0YXRpYyBfYnlDb3VudHJ5QW5kRGVmYXVsdEhpZWFyY2h5KGNvdW50cnlDb2RlLCBkZWZhdWx0SGllcmFyY2h5KSB7XHJcbiAgICByZXR1cm4gZnVuY3Rpb24gKGl0ZW0pIHtcclxuICAgICAgbGV0IGNvdW50cmllcyA9IChpdGVtICYmIGl0ZW0ucHJvcGVydGllcyAmJiBpdGVtLnByb3BlcnRpZXMuY291bnRyaWVzLnRvTG93ZXJDYXNlKCkpIHx8IChpdGVtICYmIGl0ZW0ubWV0YWRhdGEgJiYgaXRlbS5tZXRhZGF0YS5jb3VudHJpZXMudG9Mb3dlckNhc2UoKSk7XHJcbiAgICAgIGxldCBoaWVyYXJjaGllcyA9IChpdGVtICYmIGl0ZW0ucHJvcGVydGllcyAmJiBpdGVtLnByb3BlcnRpZXMuaGllcmFyY2h5KSB8fCAoaXRlbSAmJiBpdGVtLm1ldGFkYXRhICYmIGl0ZW0ubWV0YWRhdGEuaGllcmFyY2h5KTtcclxuICAgICAgcmV0dXJuIGNvdW50cmllcyAmJiBjb3VudHJpZXMuaW5kZXhPZihjb3VudHJ5Q29kZS50b0xvd2VyQ2FzZSgpKSA+PSAwICYmIGhpZXJhcmNoaWVzICYmIGhpZXJhcmNoaWVzLmluZGV4T2YoZGVmYXVsdEhpZXJhcmNoeSkgPj0gMDtcclxuICAgIH07XHJcbiAgfVxyXG4gIC8vIHN0YXRpYyBfYnlEZWZhdWx0SGllcmFyY2h5IChkZWZhdWx0SGllcmFyY2h5OiBzdHJpbmcpIHtcclxuICAvLyAgIHJldHVybiBmdW5jdGlvbiAoaXRlbTogYW55KSB7XHJcbiAgLy8gICAgIGxldCBoaWVyYXJjaGllcyA9IGl0ZW0gJiYgaXRlbS5wcm9wZXJ0aWVzICYmIGl0ZW0ucHJvcGVydGllcy5oaWVyYXJjaHlcclxuICAvLyAgICAgaWYgKGhpZXJhcmNoaWVzICYmIGhpZXJhcmNoaWVzLmluZGV4T2YoZGVmYXVsdEhpZXJhcmNoeSkgPj0gMClcclxuICAvLyAgICAgICByZXR1cm4gdHJ1ZVxyXG4gIC8vICAgICBlbHNlXHJcbiAgLy8gICAgICAgcmV0dXJuIGZhbHNlXHJcbiAgLy8gICB9XHJcbiAgLy8gfVxyXG4gIHN0YXRpYyBfZ2V0RXNyaUluZm9ncmFwaGljUmVwb3J0VGVtcGxhdGVJdGVtcyhjb3VudHJ5Q29kZSkge1xyXG4gICAgcmV0dXJuIEdFQ2xpZW50LmV4ZWN1dGUoeyB0YXNrUGF0aDogJy9HZW9FbnJpY2htZW50L0luZm9ncmFwaGljcy9TdGFuZGFyZC8nICsgY291bnRyeUNvZGUgfSlcclxuICAgICAgLnRoZW4oKHJlcG9ydFRlbXBsYXRlc1Jlc3BvbnNlKSA9PiB7XHJcbiAgICAgIGxldCByZXBvcnRUZW1wbGF0ZXMgPSByZXBvcnRUZW1wbGF0ZXNSZXNwb25zZS5yZXBvcnRzO1xyXG4gICAgICByZXR1cm4gcmVwb3J0VGVtcGxhdGVzO1xyXG4gICAgfSk7XHJcbiAgfVxyXG4gIHN0YXRpYyBfZ2V0U2hhcmVkSW5mb2dyYXBoaWNSZXBvcnRUZW1wbGF0ZUl0ZW1zKHVzZXJuYW1lLCBvcmdJZCkge1xyXG4gICAgbGV0IHF1ZXJ5ID0gJ3R5cGU6XCJSZXBvcnQgVGVtcGxhdGVcIiAnICtcclxuICAgICAgJyhhY2Nlc3M6c2hhcmVkIE9SIGFjY2VzczpvcmcgT1IgKGFjY2VzczpwdWJsaWMgQU5EIG9yZ2lkOicgK1xyXG4gICAgICBvcmdJZCArXHJcbiAgICAgICcpKSAnICtcclxuICAgICAgJyB0eXBla2V5d29yZHM6ZXNyaVdlYkluZm9ncmFwaGljUmVwb3J0ICcgK1xyXG4gICAgICAnIE5PVCBvd25lcjonICtcclxuICAgICAgdXNlcm5hbWU7XHJcbiAgICByZXR1cm4gUmVwb3J0VGVtcGxhdGVzTWFuYWdlci5fc2VhcmNoSXRlbXMocXVlcnksIFJlcG9ydFRlbXBsYXRlc01hbmFnZXIuX2luZm9ncmFwaGljRmlsdGVyKTtcclxuICB9XHJcbiAgc3RhdGljIF9nZXRHYWxsZXJ5SW5mb2dyYXBoaWNSZXBvcnRUZW1wbGF0ZUl0ZW1zKCkge1xyXG4gICAgbGV0IHF1ZXJ5ID0gJ3R5cGU6XCJSZXBvcnQgVGVtcGxhdGVcIiAnICtcclxuICAgICAgJyB0eXBla2V5d29yZHM6ZXNyaVdlYkdhbGxlcnlJbmZvZ3JhcGhpY1JlcG9ydCAnICtcclxuICAgICAgJyBvd25lcjooZXNyaV9yZXBvcnRzIE9SIGVzcmlfcmVwb3J0c190ZXN0KSc7XHJcbiAgICByZXR1cm4gUmVwb3J0VGVtcGxhdGVzTWFuYWdlci5fc2VhcmNoSXRlbXMocXVlcnksIFJlcG9ydFRlbXBsYXRlc01hbmFnZXIuX2luZm9ncmFwaGljRmlsdGVyLCB7XHJcbiAgICAgIHN0YXJ0OiAxLFxyXG4gICAgICBudW06IDEwMDAsXHJcbiAgICAgIHNvcnRGaWVsZDogJ21vZGlmaWVkJyxcclxuICAgICAgc29ydE9yZGVyOiAnZGVzYycsXHJcbiAgICAgIHE6IHF1ZXJ5XHJcbiAgICB9KTtcclxuICB9XHJcbiAgc3RhdGljIF9nZXRVc2VySW5mb2dyYXBoaWNSZXBvcnRUZW1wbGF0ZUl0ZW1zKHVzZXJuYW1lKSB7XHJcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICBsZXQgcXVlcnkgPSAndHlwZTpcIlJlcG9ydCBUZW1wbGF0ZVwiJyArXHJcbiAgICAgICAgJyB0eXBla2V5d29yZHM6ZXNyaVdlYkluZm9ncmFwaGljUmVwb3J0ICcgK1xyXG4gICAgICAgICcgb3duZXI6JyArXHJcbiAgICAgICAgdXNlcm5hbWU7XHJcbiAgICAgIGxldCB1c2VySWdEZWZlcnJlZCA9IFJlcG9ydFRlbXBsYXRlc01hbmFnZXIuX3NlYXJjaEl0ZW1zKHF1ZXJ5LCBSZXBvcnRUZW1wbGF0ZXNNYW5hZ2VyLl9pbmZvZ3JhcGhpY0ZpbHRlcik7XHJcbiAgICAgIGxldCB1c2VyR2FsbGVyeUlnRGVmZXJyZWQgPSBSZXBvcnRUZW1wbGF0ZXNNYW5hZ2VyLl9nZXRVc2VyR2FsbGVyeUluZm9ncmFwaGljUmVwb3J0VGVtcGxhdGVJdGVtcygpO1xyXG4gICAgICBQcm9taXNlLmFsbFNldHRsZWQoW3VzZXJJZ0RlZmVycmVkLCB1c2VyR2FsbGVyeUlnRGVmZXJyZWRdKS50aGVuKChyZXMpID0+IHtcclxuICAgICAgICBsZXQgdXNlcklnSXRlbXMgPSByZXNbMF0udmFsdWUgPyByZXNbMF0udmFsdWUgOiBbXTtcclxuICAgICAgICBsZXQgdXNlckdhbGxlcnlJZ0l0ZW1zID0gcmVzWzFdLnZhbHVlID8gcmVzWzFdLnZhbHVlIDogW107XHJcbiAgICAgICAgcmVzb2x2ZSh1c2VySWdJdGVtcy5jb25jYXQodXNlckdhbGxlcnlJZ0l0ZW1zKSk7XHJcbiAgICAgIH0sIChyZWplY3RlZCkgPT4ge1xyXG4gICAgICAgIHJlamVjdChyZWplY3RlZCk7XHJcbiAgICAgIH0pO1xyXG4gICAgfSk7XHJcbiAgfVxyXG4gIHN0YXRpYyBfZ2V0RmF2b3JpdGVSZXBvcnRzSWRzKHVzZXJuYW1lLCBjb3VudHJ5SWQpIHtcclxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgIGxldCBxdWVyeSA9ICd0eXBlOlwiV2ViIE1hcHBpbmcgQXBwbGljYXRpb25cIiB0eXBla2V5d29yZHM6XCJCQVVzZXJEYXRhLkZhdm9yaXRlUmVwb3J0c1wiIG93bmVyOicgK1xyXG4gICAgICAgIHVzZXJuYW1lO1xyXG4gICAgICBSZXBvcnRUZW1wbGF0ZXNNYW5hZ2VyLl9zZWFyY2hJdGVtcyhxdWVyeSwgbnVsbClcclxuICAgICAgICAudGhlbigoZmF2b3JpdGVSZXBvcnRzSXRlbXMpID0+IHtcclxuICAgICAgICBsZXQgZmF2UmVwb3J0c0l0ZW0gPSBmYXZvcml0ZVJlcG9ydHNJdGVtcyAmJiBmYXZvcml0ZVJlcG9ydHNJdGVtc1swXTtcclxuICAgICAgICBpZiAoIWZhdlJlcG9ydHNJdGVtKSB7XHJcbiAgICAgICAgICByZXNvbHZlKFtdKTsgLy9ubyBmYXZvcml0ZSByZXBvcnRzXHJcbiAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIEFyY0dJU0NsaWVudC5nZXRJdGVtRGF0YShmYXZSZXBvcnRzSXRlbS5pZClcclxuICAgICAgICAgIC50aGVuKChpdGVtRGF0YSkgPT4ge1xyXG4gICAgICAgICAgaWYgKCFpdGVtRGF0YSkge1xyXG4gICAgICAgICAgICByZXNvbHZlKFtdKTsgLy9ubyBmYXZvcml0ZSByZXBvcnRzXHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIGxldCBmYXZSZXBvcnRzSW5mb3MgPSBpdGVtRGF0YS5kYXRhICYmIGl0ZW1EYXRhLmRhdGFbJ2Zhdm9yaXRlcycgKyBjb3VudHJ5SWRdO1xyXG4gICAgICAgICAgaWYgKCFmYXZSZXBvcnRzSW5mb3MpIHtcclxuICAgICAgICAgICAgcmVzb2x2ZShbXSk7IC8vbm8gZmF2b3JpdGUgcmVwb3J0c1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICBsZXQgcmV0ID0gZmF2UmVwb3J0c0luZm9zLm1hcChmdW5jdGlvbiAoaW5mbykge1xyXG4gICAgICAgICAgICByZXR1cm4gaW5mby5yZXBvcnRJRDtcclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgcmVzb2x2ZShyZXQpO1xyXG4gICAgICAgIH0pXHJcbiAgICAgICAgICAuY2F0Y2goKGVycikgPT4gcmVqZWN0KGVycikpO1xyXG4gICAgICB9KVxyXG4gICAgICAgIC5jYXRjaCgoZXJyKSA9PiByZWplY3QoZXJyKSk7XHJcbiAgICB9KTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICogR2V0cyBpbmZvZ3JhcGhpYyB0ZW1wbGF0ZXMgdGhhdCB1c2VyIGFkZGVkIHRvIFwiTXkgVGVtcGxhdGVzXCIgZnJvbSBcIkdhbGxlcnlcIlxyXG4gICAqXHJcbiAgICogQHJldHVybnMgeyp9XHJcbiAgICogQHByaXZhdGVcclxuICAgKi9cclxuICBzdGF0aWMgX2dldFVzZXJHYWxsZXJ5SW5mb2dyYXBoaWNSZXBvcnRUZW1wbGF0ZUl0ZW1zKCkge1xyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgV2ViQXBwU2V0dGluZ3MuZ2V0VXNlckdhbGxlcnlJbmZvZ3JhcGhpY1JlcG9ydElkcygpXHJcbiAgICAgICAgLnRoZW4oKHJlcG9ydElkcykgPT4ge1xyXG4gICAgICAgIGlmICghcmVwb3J0SWRzIHx8ICFyZXBvcnRJZHMubGVuZ3RoKSB7XHJcbiAgICAgICAgICByZXNvbHZlKFtdKTtcclxuICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgbGV0IHF1ZXJ5ID0gcmVwb3J0SWRzLm1hcCgoaWQpID0+ICdpZDonICsgaWQpLmpvaW4oJyBPUiAnKTtcclxuICAgICAgICBSZXBvcnRUZW1wbGF0ZXNNYW5hZ2VyLl9zZWFyY2hJdGVtcyhxdWVyeSwgUmVwb3J0VGVtcGxhdGVzTWFuYWdlci5faW5mb2dyYXBoaWNGaWx0ZXIpXHJcbiAgICAgICAgICAudGhlbigoaXRlbXMpID0+IHtcclxuICAgICAgICAgIHJlc29sdmUoaXRlbXMpO1xyXG4gICAgICAgIH0pXHJcbiAgICAgICAgICAuY2F0Y2goKGVycikgPT4gcmVqZWN0KGVycikpO1xyXG4gICAgICB9KVxyXG4gICAgICAgIC5jYXRjaCgoZXJyKSA9PiByZWplY3QoZXJyKSk7XHJcbiAgICB9KTtcclxuICB9XHJcbiAgc3RhdGljIF9zZWFyY2hJdGVtcyhxdWVyeSwgcmVzdWx0c0ZpbHRlciwgb3B0aW9ucykge1xyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgbGV0IHBhcmFtcyA9IG9wdGlvbnMgfHwge1xyXG4gICAgICAgIHN0YXJ0OiAxLFxyXG4gICAgICAgIG51bTogMTAwMCxcclxuICAgICAgICBzb3J0RmllbGQ6ICd0aXRsZScsXHJcbiAgICAgICAgc29ydE9yZGVyOiAnYXNjJyxcclxuICAgICAgICBxOiBxdWVyeVxyXG4gICAgICB9O1xyXG4gICAgICBBcmNHSVNDbGllbnQuc2VhcmNoQWxsSXRlbXMoe30sIHBhcmFtcylcclxuICAgICAgICAudGhlbigocmVzdWx0SXRlbXMpID0+IHtcclxuICAgICAgICBsZXQgcmVzID0gcmVzdWx0c0ZpbHRlclxyXG4gICAgICAgICAgPyByZXN1bHRJdGVtcy5maWx0ZXIocmVzdWx0c0ZpbHRlcilcclxuICAgICAgICAgIDogcmVzdWx0SXRlbXM7XHJcbiAgICAgICAgcmVzb2x2ZShyZXMpO1xyXG4gICAgICB9KVxyXG4gICAgICAgIC5jYXRjaCgoZXJyKSA9PiByZWplY3QoZXJyKSk7XHJcbiAgICB9KTtcclxuICB9XHJcbiAgc3RhdGljIF9jcmVhdGVSZXBvcnRUZW1wbGF0ZUluZm9zKHBvcnRhbEl0ZW1zLCBjb3VudHJ5Q29kZSkge1xyXG4gICAgbGV0IHRlbXBsYXRlcyA9IFtdO1xyXG4gICAgcG9ydGFsSXRlbXMuZm9yRWFjaChmdW5jdGlvbiAoaXRlbSkge1xyXG4gICAgICBsZXQgcHJvcGVydGllcyA9IGl0ZW0ucHJvcGVydGllcztcclxuICAgICAgaWYgKHByb3BlcnRpZXMpIHtcclxuICAgICAgICBsZXQgY291bnRyaWVzID0gcHJvcGVydGllcy5jb3VudHJpZXM7XHJcbiAgICAgICAgaWYgKFNldHRpbmdzSGVscGVyLmlzVHJ1ZVN0cmluZyhwcm9wZXJ0aWVzLmlzQ29tcGFyaXNvblJlcG9ydCkpIHtcclxuICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKGNvdW50cmllcyAmJiBjb3VudHJpZXMuaW5kZXhPZihjb3VudHJ5Q29kZSkgIT09IC0xKSB7XHJcbiAgICAgICAgICBsZXQgcnRpID0ge1xyXG4gICAgICAgICAgICByZXBvcnRJRDogeyBpdGVtaWQ6IGl0ZW0uaWQgfSxcclxuICAgICAgICAgICAgZm9ybWF0czogcHJvcGVydGllcy5mb3JtYXRzICYmIHByb3BlcnRpZXMuZm9ybWF0cy5zcGxpdCgnLCcpLFxyXG4gICAgICAgICAgICBoZWFkZXJzOiBbXSxcclxuICAgICAgICAgICAgbWV0YWRhdGE6IHtcclxuICAgICAgICAgICAgICBhdXRob3I6IHByb3BlcnRpZXMuYXV0aG9yLFxyXG4gICAgICAgICAgICAgIGNhdGVnb3JpZXM6IFtdLFxyXG4gICAgICAgICAgICAgIGNvdW50cmllczogY291bnRyaWVzLFxyXG4gICAgICAgICAgICAgIGNvdmVyYWdlOiBwcm9wZXJ0aWVzLmNvdmVyYWdlLFxyXG4gICAgICAgICAgICAgIGhpZXJhcmNoeTogR0VDbGllbnQuZ2V0R0VEZWZhdWx0SGllcmFyY2h5KGNvdW50cnlDb2RlKSxcclxuICAgICAgICAgICAgICBrZXl3b3JkczogcHJvcGVydGllcy5rZXl3b3JkcyxcclxuICAgICAgICAgICAgICBvd25lcjogaXRlbS5vd25lcixcclxuICAgICAgICAgICAgICB0aXRsZTogaXRlbS50aXRsZSxcclxuICAgICAgICAgICAgICB0eXBlOiBwcm9wZXJ0aWVzLnR5cGVcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfTtcclxuICAgICAgICAgIHRlbXBsYXRlcy5wdXNoKHJ0aSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICAgIHJldHVybiB0ZW1wbGF0ZXM7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIEZ1bmN0aW9uIGZvciBBcnJheS5maWx0ZXIgdGhhdCByZW1vdmVzIG5vbi1pbmZvZ3JhcGhpYyB0ZW1wbGF0ZSBpdGVtc1xyXG4gICAqXHJcbiAgICogTGVmdCBoZXJlIHRvIHN1cHBvcnQgZmlsdGVyaW5nIG91dCBzb21lIGxlZ2FjeSBpbmZvZ3JhcGhpYyByZXBvcnRzIHRoYXRcclxuICAgKiB3ZXJlIG5vdCB1cGRhdGVkIG9uIHBvcnRhbCBmb3Igc29tZSByZWFzb25zLlxyXG4gICAqIEBwYXJhbSByZXBvcnRUZW1wbGF0ZUl0ZW1cclxuICAgKiBAcmV0dXJuIHsqfGJvb2xlYW59XHJcbiAgICogQHByaXZhdGVcclxuICAgKi9cclxuICBzdGF0aWMgX2luZm9ncmFwaGljRmlsdGVyKHJlcG9ydFRlbXBsYXRlSXRlbSkge1xyXG4gICAgbGV0IHAgPSByZXBvcnRUZW1wbGF0ZUl0ZW0ucHJvcGVydGllcztcclxuICAgIC8vbGVhdmUgb3JkaW5hcnkgaW5mb2dyYXBoaWMsIGJ1dCByZW1vdmUgc2luZ2xlIGluZm9ncmFwaGljcywgaGlkZGVuIGFuZCBibGFuayByZXBvcnRzIGlmIGFueVxyXG4gICAgLy9ib29sZWFuIHByb3BlcnRpZXMgbWF5IGJlIHN0b3JlZCBhcyBzdHJpbmdzXHJcbiAgICByZXR1cm4gKFNldHRpbmdzSGVscGVyLmlzVHJ1ZVN0cmluZyhwLmlzR3JhcGhpY1JlcG9ydCkgJiZcclxuICAgICAgIVNldHRpbmdzSGVscGVyLmlzVHJ1ZVN0cmluZyhwLmlzU2luZ2xlSW5mb2dyYXBoaWMpICYmXHJcbiAgICAgICFTZXR0aW5nc0hlbHBlci5pc1RydWVTdHJpbmcocC5pc0hpZGRlbikgJiZcclxuICAgICAgIVNldHRpbmdzSGVscGVyLmlzVHJ1ZVN0cmluZyhwLmlzQmxhbmspKTtcclxuICB9XHJcbn1cclxuUmVwb3J0VGVtcGxhdGVzTWFuYWdlci5fZ2VSZXBvcnRUZW1wbGF0ZXNDYWNoZSA9IHt9O1xuXG5jbGFzcyBHRUNsaWVudCB7XHJcbiAgc3RhdGljIGFzeW5jIGdldEluZm9ncmFwaGljVGVtcGxhdGVzTGlzdChjb3VudHJ5Q29kZSwgZnVsbCA9IGZhbHNlLCB0b2tlbikge1xyXG4gICAgcmV0dXJuIGF3YWl0IFJlcG9ydFRlbXBsYXRlc01hbmFnZXIuZ2V0SW5mb2dyYXBoaWNSZXBvcnRUZW1wbGF0ZUl0ZW1zKGNvdW50cnlDb2RlIHx8ICdVUycsIGZ1bGwsIHRva2VuKTtcclxuICB9XHJcbiAgc3RhdGljIGFzeW5jIGdldENsYXNzaWNSZXBvcnRzVGVtcGxhdGVzTGlzdChjb3VudHJ5Q29kZSwgZnVsbCA9IGZhbHNlKSB7XHJcbiAgICByZXR1cm4gYXdhaXQgUmVwb3J0VGVtcGxhdGVzTWFuYWdlci5nZXRSZXBvcnRUZW1wbGF0ZXMoY291bnRyeUNvZGUgfHwgJ1VTJywgZnVsbCk7XHJcbiAgfVxyXG4gIHN0YXRpYyBleGVjdXRlKGdlUGFyYW1ldGVycykge1xyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgY29uc3QgZ2VvZW5yaWNobWVudFVybCA9IEFyY0dJU0NsaWVudC5nZXRHZW9lbnJpY2htZW50VXJsKCk7XHJcbiAgICAgIC8vIGRvIGRlZXAgY29weSwgaW5zdGVhZCBvZiAkai5leHRlbmQoe30sIHBhcmFtcylcclxuICAgICAgdmFyIF9nZVBhcmFtcyA9IGdlUGFyYW1ldGVycyA/IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkoZ2VQYXJhbWV0ZXJzKSkgOiB7fTtcclxuICAgICAgaWYgKCFfZ2VQYXJhbXMuZGF0YSlcclxuICAgICAgICBfZ2VQYXJhbXMuZGF0YSA9IHt9O1xyXG4gICAgICBfZ2VQYXJhbXMuZGF0YS5mb3JTdG9yYWdlID0gZmFsc2U7XHJcbiAgICAgIC8vIHRvZG86IGltcGxlbWVudCBxdWV1ZSBmb3IgdGhpcyByZXF1ZXN0cywga2V5IGlzIF9nZVBhcmFtcy50YXNrUGF0aCBvciBoZXhfc2hhMShnZVBhcmFtZXRlcnMpXHJcbiAgICAgIEFyY0dJU0NsaWVudC5leGVjdXRlUmVxdWVzdCh7XHJcbiAgICAgICAgdXJsOiBnZW9lbnJpY2htZW50VXJsICsgX2dlUGFyYW1zLnRhc2tQYXRoLFxyXG4gICAgICAgIGRhdGE6IF9nZVBhcmFtcy5kYXRhLFxyXG4gICAgICAgIGlzU3RhbmRhcmRHZW9RdWVyeTogX2dlUGFyYW1zLmlzU3RhbmRhcmRHZW9RdWVyeVxyXG4gICAgICB9KS50aGVuKHJlc29sdmUpLmNhdGNoKHJlamVjdCk7XHJcbiAgICB9KTtcclxuICB9XHJcbiAgc3RhdGljIGNyZWF0ZVJlcG9ydChjcmVhdGVSZXBvcnRQYXJhbXMpIHtcclxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgIGNvbnN0IGdlVXJsID0gQXJjR0lTQ2xpZW50LmdldEdlb2VucmljaG1lbnRVcmwoKTtcclxuICAgICAgbGV0IGNyZWF0ZVJlcG9ydFVybCA9IGdlVXJsLnRvU3RyaW5nKCkgKyAnL0dlb2VucmljaG1lbnQvQ3JlYXRlUmVwb3J0JztcclxuICAgICAgQXJjR0lTQ2xpZW50LmV4ZWN1dGVSZXF1ZXN0KHtcclxuICAgICAgICB1cmw6IGNyZWF0ZVJlcG9ydFVybCxcclxuICAgICAgICBkYXRhOiBjcmVhdGVSZXBvcnRQYXJhbXNcclxuICAgICAgfSkudGhlbihyZXNvbHZlKS5jYXRjaChyZWplY3QpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIFBlcmZvcm1zIHN0YW5kYXJkIGdlb2dyYXBoeSBzZWFyY2ggYnkgdGV4dHVhbCBnZW9ncmFwaHkgcXVlcnkuXHJcbiAgICpcclxuICAgKiBOb3RlOiBiZSBwYXRpZW50IHdoaWxlIHNldHRpbmcgcmVxdWVzdCBvcHRpb25zLiBgc291cmNlQ291bnRyeWAsIGBnZW9ncmFwaHlMYXllcnNgLCBgb3B0aW9uYWxDb3VudHJ5SGllcmFyY2h5YFxyXG4gICAqIHBhcmFtcyBhcmUgY291cGxlZCBhbmQgY291bnRyeS1zcGVjaWZpYywgc28gdXBkYXRlIGl0IHNpbXVsdGFuZW91c2x5XHJcbiAgICpcclxuICAgKiBAcGFyYW0gZ2VvZ3JhcGh5UXVlcnkgU3RyaW5nIHRvIHNlYXJjaCBmb3JcclxuICAgKiBAcGFyYW0gb3B0aW9ucyBPcHRpb25zIHRvIHJlZmluZSBzZWFyY2g6XHJcbiAgICogICAgZmVhdHVyZUxpbWl0XHJcbiAgICogICAgZ2VvZ3JhcGh5TGF5ZXJzXHJcbiAgICogICAgdXNlRnV6enlTZWFyY2hcclxuICAgKiAgICBzb3VyY2VDb3VudHJ5XHJcbiAgICogICAgb3B0aW9uYWxDb3VudHJ5SGllcmFyY2h5XHJcbiAgICogQHNlZSBodHRwczovL2RldmVsb3BlcnMuYXJjZ2lzLmNvbS9yZXN0L2dlb2VucmljaG1lbnQvYXBpLXJlZmVyZW5jZS9zdGFuZGFyZC1nZW9ncmFwaHktcXVlcnkuaHRtXHJcbiAgICovXHJcbiAgc3RhdGljIHNlYXJjaFN0ZEdlb2dyYXBoeShnZW9ncmFwaHlRdWVyeSwgb3B0aW9ucykge1xyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKGFzeW5jIChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgaWYgKCFnZW9ncmFwaHlRdWVyeSB8fCAhZ2VvZ3JhcGh5UXVlcnkubGVuZ3RoKSB7XHJcbiAgICAgICAgcmVzb2x2ZShbXSk7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgICB9XHJcbiAgICAgIGxldCBkZWZhdWx0SGllcmFyY2h5ID0gYXdhaXQgdGhpcy5nZXRHRURlZmF1bHRIaWVyYXJjaHkob3B0aW9ucz8uc291cmNlQ291bnRyeSB8fCAnVVMnLCBvcHRpb25zPy50b2tlbik7XHJcbiAgICAgIGxldCBnZVBhcmFtcyA9IHtcclxuICAgICAgICBnZW9ncmFwaHlRdWVyeTogZ2VvZ3JhcGh5UXVlcnksXHJcbiAgICAgICAgZmVhdHVyZUxpbWl0OiBvcHRpb25zPy5mZWF0dXJlTGltaXQgfHwgMTAsXHJcbiAgICAgICAgZ2VvZ3JhcGh5TGF5ZXJzOiBvcHRpb25zPy5nZW9ncmFwaHlMYXllcnMgfHwgWydVUy5TdGF0ZXMnLCAnVVMuQ291bnRpZXMnLCAnVVMuUGxhY2VzJ10sXHJcbiAgICAgICAgdXNlRnV6enlTZWFyY2g6IG9wdGlvbnM/LnVzZUZ1enp5U2VhcmNoLFxyXG4gICAgICAgIHNvdXJjZUNvdW50cnk6IG9wdGlvbnM/LnNvdXJjZUNvdW50cnkgfHwgJ1VTJyxcclxuICAgICAgICBsYW5nQ29kZTogb3B0aW9ucz8ubGFuZ0NvZGUgfHwgXCJlbi11c1wiLFxyXG4gICAgICAgIG9wdGlvbmFsQ291bnRyeUhpZXJhcmNoeTogb3B0aW9ucz8ub3B0aW9uYWxDb3VudHJ5SGllcmFyY2h5IHx8IGRlZmF1bHRIaWVyYXJjaHlcclxuICAgICAgfTtcclxuICAgICAgdGhpcy5zdGFuZGFyZEdlb2dyYXBoeVF1ZXJ5KGdlUGFyYW1zKVxyXG4gICAgICAgIC50aGVuKGZlYXR1cmVzID0+IHJlc29sdmUoZmVhdHVyZXMpKVxyXG4gICAgICAgIC5jYXRjaChlcnJvciA9PiByZWplY3QoZXJyb3IpKTtcclxuICAgIH0pO1xyXG4gIH1cclxuICAvKipcclxuICAgKiBHZXRzIHN0YW5kYXJkIGdlb2dyYXBoeSBieSBsYXllciBpZCwgZmVhdHVyZSBpZCBhbmQgc29tZSBvcHRpb25hbCBwYXJhbWV0ZXJzLlxyXG4gICAqXHJcbiAgICogQHBhcmFtIGxheWVySWQgSWQgb2YgbGF5ZXIgdG8gbG9vayB1cCBpblxyXG4gICAqIEBwYXJhbSBmZWF0dXJlSWQgSWQgb2YgZmVhdHVyZSB0byByZXF1ZXN0XHJcbiAgICogQHBhcmFtIG9wdGlvbnMgT3B0aW9ucyB0byByZWZpbmUgcXVlcnk6XHJcbiAgICogICAgZmVhdHVyZUxpbWl0XHJcbiAgICogICAgcmV0dXJuR2VvbWV0cnlcclxuICAgKiAgICBnZW5lcmFsaXphdGlvbkxldmVsXHJcbiAgICogICAgc291cmNlQ291bnRyeVxyXG4gICAqICAgIGxhbmdDb2RlXHJcbiAgICogICAgb3B0aW9uYWxDb3VudHJ5SGllcmFyY2h5XHJcbiAgICogQHNlZSBodHRwczovL2RldmVsb3BlcnMuYXJjZ2lzLmNvbS9yZXN0L2dlb2VucmljaG1lbnQvYXBpLXJlZmVyZW5jZS9zdGFuZGFyZC1nZW9ncmFwaHktcXVlcnkuaHRtXHJcbiAgICovXHJcbiAgc3RhdGljIHJlcXVlc3RTdGRHZW9ncmFwaHkobGF5ZXJJZCwgZmVhdHVyZUlkLCBvcHRpb25zKSB7XHJcbiAgICByZXR1cm4gbmV3IFByb21pc2UoYXN5bmMgKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICBsZXQgZGVmYXVsdEhpZXJhcmNoeSA9IGF3YWl0IHRoaXMuZ2V0R0VEZWZhdWx0SGllcmFyY2h5KG9wdGlvbnM/LnNvdXJjZUNvdW50cnkgfHwgJ1VTJywgb3B0aW9ucz8udG9rZW4pO1xyXG4gICAgICBsZXQgZ2VQYXJhbXMgPSB7XHJcbiAgICAgICAgZ2VvZ3JhcGh5TGF5ZXJzOiBbbGF5ZXJJZF0sXHJcbiAgICAgICAgZmVhdHVyZUxpbWl0OiBvcHRpb25zPy5mZWF0dXJlTGltaXQgfHwgMSxcclxuICAgICAgICByZXR1cm5HZW9tZXRyeTogb3B0aW9ucz8ucmV0dXJuR2VvbWV0cnksXHJcbiAgICAgICAgLy8gb3V0U1I6IEpTT04uc3RyaW5naWZ5KHt3a2lkOiAxMDIxMDAsIGxhdGVzdFdraWQ6IDM4NTd9KSxcclxuICAgICAgICBnZW5lcmFsaXphdGlvbkxldmVsOiBvcHRpb25zPy5nZW5lcmFsaXphdGlvbkxldmVsIHx8IDAsXHJcbiAgICAgICAgZ2VvZ3JhcGh5SURzOiBbZmVhdHVyZUlkXSxcclxuICAgICAgICBzb3VyY2VDb3VudHJ5OiBvcHRpb25zPy5zb3VyY2VDb3VudHJ5IHx8ICdVUycsXHJcbiAgICAgICAgbGFuZ0NvZGU6IG9wdGlvbnM/LmxhbmdDb2RlIHx8IFwiZW4tdXNcIixcclxuICAgICAgICBvcHRpb25hbENvdW50cnlIaWVyYXJjaHk6IG9wdGlvbnM/Lm9wdGlvbmFsQ291bnRyeUhpZXJhcmNoeSB8fCBkZWZhdWx0SGllcmFyY2h5XHJcbiAgICAgIH07XHJcbiAgICAgIHRoaXMuc3RhbmRhcmRHZW9ncmFwaHlRdWVyeShnZVBhcmFtcylcclxuICAgICAgICAudGhlbihmZWF0dXJlcyA9PiByZXNvbHZlKGZlYXR1cmVzKSlcclxuICAgICAgICAuY2F0Y2goZXJyb3IgPT4gcmVqZWN0KGVycm9yKSk7XHJcbiAgICB9KTtcclxuICB9XHJcbiAgc3RhdGljIHN0YW5kYXJkR2VvZ3JhcGh5UXVlcnkocGFyYW1zKSB7XHJcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICBsZXQgZ2VQYXJhbXMgPSB7XHJcbiAgICAgICAgZGF0YTogcGFyYW1zLFxyXG4gICAgICAgIGlzU3RhbmRhcmRHZW9RdWVyeTogdHJ1ZSxcclxuICAgICAgICB0YXNrUGF0aDogJy9TdGFuZGFyZEdlb2dyYXBoeVF1ZXJ5L2V4ZWN1dGUnXHJcbiAgICAgIH07XHJcbiAgICAgIEdFQ2xpZW50LmV4ZWN1dGUoZ2VQYXJhbXMpLnRoZW4oKHF1ZXJ5UmVzcG9uc2UpID0+IHtcclxuICAgICAgICBsZXQgcmVzdWx0ID0gcXVlcnlSZXNwb25zZSAmJlxyXG4gICAgICAgICAgcXVlcnlSZXNwb25zZS5yZXN1bHRzICYmXHJcbiAgICAgICAgICBxdWVyeVJlc3BvbnNlLnJlc3VsdHMubGVuZ3RoICYmXHJcbiAgICAgICAgICBxdWVyeVJlc3BvbnNlLnJlc3VsdHNbMF07XHJcbiAgICAgICAgbGV0IGZlYXR1cmVzID0gcmVzdWx0ICYmXHJcbiAgICAgICAgICByZXN1bHQudmFsdWUgJiZcclxuICAgICAgICAgIHJlc3VsdC52YWx1ZS5mZWF0dXJlcztcclxuICAgICAgICBpZiAoZmVhdHVyZXMpXHJcbiAgICAgICAgICByZXNvbHZlKGZlYXR1cmVzKTtcclxuICAgICAgICBlbHNlIHtcclxuICAgICAgICAgIGxldCBlcnJvck1lc3NhZ2VzID0gcXVlcnlSZXNwb25zZSAmJlxyXG4gICAgICAgICAgICBxdWVyeVJlc3BvbnNlLm1lc3NhZ2VzICYmXHJcbiAgICAgICAgICAgIHF1ZXJ5UmVzcG9uc2UubWVzc2FnZXMubGVuZ3RoO1xyXG4gICAgICAgICAgcmVqZWN0KGVycm9yTWVzc2FnZXMpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSkuY2F0Y2goZXJyb3IgPT4ge1xyXG4gICAgICAgIHJlamVjdChlcnJvcik7XHJcbiAgICAgIH0pO1xyXG4gICAgfSk7XHJcbiAgfVxyXG4gIHN0YXRpYyBnZXRTdG9yZWREZWZhdWx0SGllcmFyY2h5KGNvdW50cnkpIHtcclxuICAgIGxldCByZXN1bHQ7XHJcbiAgICBpZiAod2luZG93LmxvY2FsU3RvcmFnZSkge1xyXG4gICAgICBsZXQgZCA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKEdFQ2xpZW50Ll9kZWZhdWx0SGllcmFyY2h5U3RvcmFnZU5hbWUpO1xyXG4gICAgICBpZiAoZCAmJiBVdGlscy5oYXNUZXh0KGQpKSB7XHJcbiAgICAgICAgbGV0IG9iaiA9IEpTT04ucGFyc2UoZCk7XHJcbiAgICAgICAgcmVzdWx0ID0gb2JqW2NvdW50cnldO1xyXG4gICAgICAgIC8vIHNhdmUgY3VycmVudCBkZWZhdWx0cyBpbiBzdGF0aWMgaW5zdGFuY2VcclxuICAgICAgICBHRUNsaWVudC5fZGVmYXVsdEhpZXJhcmNoaWVzID0gb2JqO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gcmVzdWx0O1xyXG4gIH1cclxuICAvKiogIHNldFN0b3JlZERlZmF1bHRIaWVyYXJjaHlcclxuICAgKiAgICAgICBTdG9yZXMgYSBkZWZhdWx0IGhpZXJhcmNoeSBuYW1lIGZvciBhIGdpdmVuIGNvdW50cnlcclxuICAgKlxyXG4gICAqIFN0b3JlZCBvYmplY3QgaXMgaW4gdGhpcyBmb3JtYXQ6XHJcbiAgICogIHtcclxuICAgKiAgICBcIlVTXCIgOiBcImNlbnN1czIwMjBcIixcclxuICAgKiAgICBcIkZSXCIgOiBcIkZSQV9Fc3JpRnJhbmNlXCJcclxuICAgKiAgfVxyXG4gICAqIEBwYXJhbSBjb3VudHJ5IC0gaWRlbnRpZmllciAoZXg6ICdVUycpXHJcbiAgICogQHBhcmFtIG5hbWUgICAgLSBkZWZhdWx0IGhpZXJhcmNoeSBuYW1lIGZvciB0aGUgY291bnRyeVxyXG4gICAqL1xyXG4gIHN0YXRpYyBzZXRTdG9yZWREZWZhdWx0SGllcmFyY2h5KGNvdW50cnksIG5hbWUpIHtcclxuICAgIHRyeSB7XHJcbiAgICAgIEdFQ2xpZW50LmdldFN0b3JlZERlZmF1bHRIaWVyYXJjaHkoY291bnRyeSk7XHJcbiAgICAgIGlmICghR0VDbGllbnQuX2RlZmF1bHRIaWVyYXJjaGllcylcclxuICAgICAgICBHRUNsaWVudC5fZGVmYXVsdEhpZXJhcmNoaWVzID0ge307XHJcbiAgICAgIEdFQ2xpZW50Ll9kZWZhdWx0SGllcmFyY2hpZXNbY291bnRyeV0gPSBuYW1lO1xyXG4gICAgICBpZiAod2luZG93LmxvY2FsU3RvcmFnZSkge1xyXG4gICAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKEdFQ2xpZW50Ll9kZWZhdWx0SGllcmFyY2h5U3RvcmFnZU5hbWUsIEpTT04uc3RyaW5naWZ5KEdFQ2xpZW50Ll9kZWZhdWx0SGllcmFyY2hpZXMpKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgY2F0Y2ggKGV4KSB7XHJcbiAgICAgIExvZ3ouc2hvdygnJWUnLCAnR0VDbGllbnQgZXJyb3InLCBleCk7XHJcbiAgICB9XHJcbiAgfVxyXG4gIC8vICAgLyoqXHJcbiAgLy8gICAgICAqIEdldHMgaGllcmFyY2h5IGZvciBzcGVjaWZpZWQgY291bnRyeTogZWl0aGVyIHNldCBieSBpZCBpbiBhcHAgc2V0dGluZ3Mgb3IgZGVmYXVsdCBvbmVcclxuICAvLyAgICAgICpcclxuICAvLyAgICAgICogQHBhcmFtIGNvdW50cnlDb2RlIDItbGV0dGVyIG9yIDMtbGV0dGVyIGNvdW50cnkgY29kZVxyXG4gIC8vICAgICAgKiBAcmV0dXJucyB7Kn0gSGllcmFyY2h5IGZvciBzcGVjaWZpZWQgY291bnRyeSAobm90IG51bGwpXHJcbiAgLy8gICAgICAqL1xyXG4gIC8vICAgZ2V0UHJlZmVycmVkSGllcmFyY2h5OiBmdW5jdGlvbiAoY291bnRyeUNvZGUpIHtcclxuICAvLyAgICAgdmFyIGNvdW50cnlEYXRhID0gQkEuQ291bnRyeURhdGFNYW5hZ2VyLl9jb3VudHJ5RGF0YTtcclxuICAvLyAgICAgQkEubG9nLmluZm8oXCJjb3VudHJ5RGF0YTogXCIsIGNvdW50cnlEYXRhKTtcclxuICAvLyAgICAgdmFyIGNvdW50cnkgPSBjb3VudHJ5RGF0YVtjb3VudHJ5Q29kZV07XHJcbiAgLy8gICAgIEJBLmxvZy5pbmZvKFwiY291bnRyeUNvZGU6IFwiLCBjb3VudHJ5Q29kZSk7XHJcbiAgLy8gICAgIGlmIChjb3VudHJ5LmhpZXJhcmNoaWVzKXtcclxuICAvLyAgICAgICAgIGZvcih2YXIgaT0wOyBpIDwgY291bnRyeS5oaWVyYXJjaGllcy5sZW5ndGg7IGkrKyl7XHJcbiAgLy8gICAgICAgICAgICAgdmFyIGggPSBjb3VudHJ5LmhpZXJhcmNoaWVzW2ldO1xyXG4gIC8vICAgICAgICAgICAgIEJBLmxvZy5pbmZvKFwiaGllcmFyY2h5W2ldOiBcIiwgaCk7XHJcbiAgLy8gICAgICAgICAgICAgaWYoaC5kZWZhdWx0KXtcclxuICAvLyAgICAgICAgICAgICAgICAgQkEubG9nLmluZm8oXCJkZWZhdWx0IGhpZXJhcmNoeTogXCIsICBoKTtcclxuICAvLyAgICAgICAgICAgICAgICAgLy8gcmV0dXJuIGlmIGRlZmF1bHQgaGllcmFyY2h5IGlzIHRydWVcclxuICAvLyAgICAgICAgICAgICAgICAgcmV0dXJuIGg7XHJcbiAgLy8gICAgICAgICAgICAgfVxyXG4gIC8vICAgICAgICAgfVxyXG4gIC8vICAgICAgICAgQkEubG9nLmluZm8oXCJkZWZhdWx0IGhpZXJhcmNoeSBub3QgZm91bmQgdXNpbmc6IFwiLCBoKTtcclxuICAvLyAgICAgICAgIHJldHVybiBjb3VudHJ5LmhpZXJhcmNoaWVzWzBdO1xyXG4gIC8vICAgICAgICAgLy8gcmV0dXJuIGZpcnN0IHJlc3VsdCBpZiBubyBkZWZhdWx0IGlzIGZvdW5kXHJcbiAgLy8gICAgIH1cclxuICAvLyAgICAgcmV0dXJuIGZhbHNlO1xyXG4gIC8vIH0sXHJcbiAgLyoqICBnZXRHRURlZmF1bHRIaWVyYXJjaHlcclxuICAgKiAgICAgIFJldHVybnMgdGhlIGRlZmF1bHQgaGllcmFyY2h5IG5hbWUgZm9yIHRoZSBnaXZlbiBjb3VudHJ5LlxyXG4gICAqICAgICAgVGhlIGRlZmF1bHQgbWF5IGJlIHJldHVybmVkIGZyb20gYSBsb2NhbFN0b3JhZ2UgdmFsdWVcclxuICAgKiAgICAgIHNhdmVkIHByZXZpb3VzbHkgdXNpbmcgR0VDbGllbnQuc2V0U3RvcmVkRGVmYXVsdEhpZXJhcmNoeSgpIG9yXHJcbiAgICogICAgICByZXF1ZXN0ZWQgZnJvbSBHRS5cclxuICAgKlxyXG4gICAqICAgICAgSW4gdGhlIGNhc2UgdGhlIGRlZmF1bHQgaXMgZmV0Y2hlZCBmcm9tIEdFLCB0aGF0IGRlZmF1bHRcclxuICAgKiAgICAgIHdpbGwgYmUgY2FjaGVkIGluIGxvY2FsIHN0b3JhZ2VcclxuICAgKlxyXG4gICAqIEBwYXJhbSBjb3VudHJ5IC0gaWRlbnRpZmllciAoZXg6ICdVUycpXHJcbiAgICogQHBhcmFtIHRva2VuIC0gYXV0aCB0b2tlbiAob3B0aW9uYWwpXHJcbiAgICovXHJcbiAgc3RhdGljIGdldEdFRGVmYXVsdEhpZXJhcmNoeShjb3VudHJ5LCB0b2tlbikge1xyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgbGV0IGMgPSAnVVMnOyAvLyBkZWZhdWx0XHJcbiAgICAgIGlmIChjb3VudHJ5ICYmIFV0aWxzLmhhc1RleHQoY291bnRyeSkpXHJcbiAgICAgICAgYyA9IGNvdW50cnk7XHJcbiAgICAgIC8vIHB1bGwgZGVmYXVsdCBoaWVyYXJjaHkgZnJvbSBsb2NhbFN0b3JhZ2UgaWYgYXZhaWxhYmxlXHJcbiAgICAgIGxldCBkZWZhdWx0SGllcmFyY2h5ID0gR0VDbGllbnQuZ2V0U3RvcmVkRGVmYXVsdEhpZXJhcmNoeShjKTtcclxuICAgICAgaWYgKGRlZmF1bHRIaWVyYXJjaHkgJiYgVXRpbHMuaGFzVGV4dChkZWZhdWx0SGllcmFyY2h5KSlcclxuICAgICAgICByZXNvbHZlKGRlZmF1bHRIaWVyYXJjaHkpO1xyXG4gICAgICAvLyBNdXN0IHJlcXVlc3QgZGVmYXVsdCBmcm9tIEdFIHNlcnZlclxyXG4gICAgICAvLyByZXF1ZXN0PSBodHRwczovL2dlb2VucmljaC5hcmNnaXMuY29tL2FyY2dpcy9yZXN0L3NlcnZpY2VzL1dvcmxkL2dlb2VucmljaG1lbnRzZXJ2ZXIvR2VvZW5yaWNobWVudC9Db3VudHJpZXMvVVM/Zj1wanNvblxyXG4gICAgICBjb25zdCBnZVVybCA9IEFyY0dJU0NsaWVudC5nZXRHZW9lbnJpY2htZW50VXJsKCk7XHJcbiAgICAgIGxldCB1cmwgPSBnZVVybC50b1N0cmluZygpICsgJy9HZW9lbnJpY2htZW50L0NvdW50cmllcy8nICsgY291bnRyeSArICc/Zj1wanNvbic7XHJcbiAgICAgIGNvbnN0IGRhdGEgPSB0b2tlbiA/IHtcclxuICAgICAgICBhcHBJRDogR0VDbGllbnQuYXBwSUQsXHJcbiAgICAgICAgdG9rZW46IHRva2VuXHJcbiAgICAgIH0gOlxyXG4gICAgICAgIHtcclxuICAgICAgICAgIGFwcElEOiBHRUNsaWVudC5hcHBJRFxyXG4gICAgICAgIH07XHJcbiAgICAgIEFyY0dJU0NsaWVudC5leGVjdXRlUmVxdWVzdCh7XHJcbiAgICAgICAgdXJsOiB1cmwsXHJcbiAgICAgICAgZGF0YVxyXG4gICAgICB9KS50aGVuKChlKSA9PiB7XHJcbiAgICAgICAgbGV0IGRlZiA9ICdVUyc7XHJcbiAgICAgICAgbGV0IGFyciA9IGUuY291bnRyaWVzWzBdLmhpZXJhcmNoaWVzO1xyXG4gICAgICAgIGlmIChhcnIgJiYgYXJyLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgIGZvciAobGV0IGlpID0gMDsgaWkgPCBhcnIubGVuZ3RoOyBpaSsrKSB7XHJcbiAgICAgICAgICAgIGxldCBoID0gYXJyW2lpXTtcclxuICAgICAgICAgICAgaWYgKGguZGVmYXVsdCkge1xyXG4gICAgICAgICAgICAgIGRlZiA9IGguSUQ7XHJcbiAgICAgICAgICAgICAgLy8gc2F2ZSBkZWZhdWx0IHRvIGxvY2FsIHN0b3JhZ2VcclxuICAgICAgICAgICAgICBHRUNsaWVudC5zZXRTdG9yZWREZWZhdWx0SGllcmFyY2h5KGMsIGguSUQpO1xyXG4gICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJlc29sdmUoZGVmKTtcclxuICAgICAgfSkuY2F0Y2gocmVqZWN0KTtcclxuICAgIH0pO1xyXG4gIH1cclxuICAvLyBhc3luYyByZXF1ZXN0IGZvciBzdGQgZ2VvZyBsZXZlbHNcclxuICBzdGF0aWMgZ2V0U3RhbmRhcmRHZW9ncmFwaHlMZXZlbHMoY291bnRyeSwgbGFuZ0NvZGUpIHtcclxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgIGlmICghY291bnRyeSB8fCAhVXRpbHMuaGFzVGV4dChjb3VudHJ5KSlcclxuICAgICAgICBjb3VudHJ5ID0gJ1VTJzsgLy8gZGVmYXVsdFxyXG4gICAgICAvLyBkZWZhdWx0IGhpZXJhcmNoeVxyXG4gICAgICBHRUNsaWVudC5nZXRHRURlZmF1bHRIaWVyYXJjaHkoY291bnRyeSkudGhlbigoZGVmSGllcmFyY2h5TmFtZSkgPT4ge1xyXG4gICAgICAgIC8vIFJlcXVlc3QgZ2VvZ3JhcGh5IGxldmVsc1xyXG4gICAgICAgIC8vIHJlcXVlc3Q9IGh0dHBzOi8vZ2VvZW5yaWNoLmFyY2dpcy5jb20vYXJjZ2lzL3Jlc3Qvc2VydmljZXMvV29ybGQvZ2VvZW5yaWNobWVudHNlcnZlci9HZW9lbnJpY2htZW50L1N0YW5kYXJkR2VvZ3JhcGh5TGV2ZWxzL1VTP2Y9anNvblxyXG4gICAgICAgIGNvbnN0IGdlVXJsID0gQXJjR0lTQ2xpZW50LmdldEdlb2VucmljaG1lbnRVcmwoKTtcclxuICAgICAgICAvLyBsZXQgdXJsOiBzdHJpbmcgPSBnZVVybC50b1N0cmluZygpICsgJy9Db3VudHJpZXMvJyArIGNvdW50cnkgKyAnP2Y9cGpzb24nO1xyXG4gICAgICAgIGxldCB1cmwgPSBnZVVybC50b1N0cmluZygpICsgJy9HZW9lbnJpY2htZW50L1N0YW5kYXJkR2VvZ3JhcGh5TGV2ZWxzLycgKyBjb3VudHJ5ICsgJz9mPXBqc29uJztcclxuICAgICAgICBBcmNHSVNDbGllbnQuZXhlY3V0ZVJlcXVlc3Qoe1xyXG4gICAgICAgICAgdXJsOiB1cmwsXHJcbiAgICAgICAgICBkYXRhOiB7XHJcbiAgICAgICAgICAgIGxhbmdDb2RlOiBsYW5nQ29kZSA/IGxhbmdDb2RlIDogXCJlbi11c1wiXHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSkudGhlbigoZSkgPT4ge1xyXG4gICAgICAgICAgbGV0IGhpZXI7XHJcbiAgICAgICAgICBpZiAoZSAmJiBlLmdlb2dyYXBoeUxldmVscyAmJiBlLmdlb2dyYXBoeUxldmVsc1swXSAmJiBlLmdlb2dyYXBoeUxldmVsc1swXS5oaWVyYXJjaGllcykge1xyXG4gICAgICAgICAgICBsZXQgYXJyID0gZS5nZW9ncmFwaHlMZXZlbHNbMF0uaGllcmFyY2hpZXM7XHJcbiAgICAgICAgICAgIGZvciAobGV0IGlpID0gMDsgaWkgPCBhcnIubGVuZ3RoOyBpaSsrKSB7XHJcbiAgICAgICAgICAgICAgaWYgKGFycltpaV0uSUQgPT0gZGVmSGllcmFyY2h5TmFtZSkge1xyXG4gICAgICAgICAgICAgICAgaGllciA9IGFycltpaV07XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKCFoaWVyKVxyXG4gICAgICAgICAgICAgIGhpZXIgPSBhcnJbMF07XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICByZXNvbHZlKGhpZXIpO1xyXG4gICAgICAgIH0pLmNhdGNoKHJlamVjdCk7XHJcbiAgICAgIH0pLmNhdGNoKHJlamVjdCk7XHJcbiAgICB9KS5jYXRjaChlcnJvciA9PiB7XHJcbiAgICAgIExvZ3ouc2hvdygnJWUnLCAnR0VDbGllbnQgZXJyb3InLCBlcnJvcik7XHJcbiAgICB9KTtcclxuICB9XHJcbn1cclxuR0VDbGllbnQuX2RlZmF1bHRIaWVyYXJjaHlTdG9yYWdlTmFtZSA9ICdHRUNsaWVudC1kZWZhdWx0LWhpZXJhcmNoeSc7XHJcbi8vIE5PVEUhITogSGFyZGNvZGVkIGZvciBFeHBlcmllbmNlIEJ1aWxkZXIsIHdlIG5lZWQgdG8gbW9kaWZ5IHRvIGJlIHBhc3NlZCBpbiBieSBjb25zdW1pbmcgYXBwbGljYXRpb24gdG8gYWxsb3cgZm9yIG11bHRpIGFwcCB1c2VcclxuR0VDbGllbnQuYXBwSUQgPSBcImVzcmlleHBlcmllbmNlYnVpbGRlclwiO1xyXG5HRUNsaWVudC5lbnJpY2ggPSBmdW5jdGlvbiAoZW5yaWNoUmVxdWVzdFBhcmFtcykge1xyXG4gIHJldHVybiBuZXcgUHJvbWlzZShhc3luYyAocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICB2YXIgZW5yaWNoVXJsID0gRW52aXJvbm1lbnRzLmdldFVybCgnZ2VvZW5yaWNoJykgKyAnL0dlb2VucmljaG1lbnQvRW5yaWNoJztcclxuICAgIGVucmljaFJlcXVlc3RQYXJhbXMuZm9yU3RvcmFnZSA9IGZhbHNlO1xyXG4gICAgQXJjR0lTQ2xpZW50LmV4ZWN1dGVSZXF1ZXN0KHtcclxuICAgICAgdXJsOiBlbnJpY2hVcmwsXHJcbiAgICAgIGRhdGE6IGVucmljaFJlcXVlc3RQYXJhbXNcclxuICAgIH0pLnRoZW4oZnVuY3Rpb24gKGVucmljaFJlc3BvbnNlKSB7XHJcbiAgICAgIHZhciByZXN1bHQgPSBlbnJpY2hSZXNwb25zZSAmJiBlbnJpY2hSZXNwb25zZS5yZXN1bHRzICYmIGVucmljaFJlc3BvbnNlLnJlc3VsdHMubGVuZ3RoICYmIGVucmljaFJlc3BvbnNlLnJlc3VsdHNbMF07XHJcbiAgICAgIHZhciBmZWF0dXJlU2V0ID0gcmVzdWx0ICYmIHJlc3VsdC52YWx1ZSAmJiByZXN1bHQudmFsdWUuRmVhdHVyZVNldCAmJiByZXN1bHQudmFsdWUuRmVhdHVyZVNldC5sZW5ndGggJiYgcmVzdWx0LnZhbHVlLkZlYXR1cmVTZXRbMF07XHJcbiAgICAgIGlmIChmZWF0dXJlU2V0LmZlYXR1cmVzICYmIGZlYXR1cmVTZXQuZmVhdHVyZXMubGVuZ3RoKSB7XHJcbiAgICAgICAgcmVzb2x2ZShlbnJpY2hSZXNwb25zZSk7XHJcbiAgICAgIH1cclxuICAgICAgZWxzZSB7XHJcbiAgICAgICAgdmFyIGVycm9yRGVzY3JpcHRpb24gPSBlbnJpY2hSZXNwb25zZSAmJiBlbnJpY2hSZXNwb25zZS5tZXNzYWdlcyAmJiBlbnJpY2hSZXNwb25zZS5tZXNzYWdlcy5sZW5ndGggJiYgZW5yaWNoUmVzcG9uc2UubWVzc2FnZXNbMF0uZGVzY3JpcHRpb247XHJcbiAgICAgICAgaWYgKCFlcnJvckRlc2NyaXB0aW9uKVxyXG4gICAgICAgICAgZXJyb3JEZXNjcmlwdGlvbiA9ICdnZXRmYWN0cy1uby1kYXRhJztcclxuICAgICAgICByZWplY3QoZXJyb3JEZXNjcmlwdGlvbik7XHJcbiAgICAgIH1cclxuICAgIH0sIGZ1bmN0aW9uIChlcnIpIHtcclxuICAgICAgcmVqZWN0KGVycik7XHJcbiAgICB9KTtcclxuICB9KTtcclxufTtcblxuZXhwb3J0IHsgRW52aXJvbm1lbnRzIGFzIEUsIEdFQ2xpZW50IGFzIEcsIFNldHRpbmdzSGVscGVyIGFzIFMsIFRva2VuUHJvdmlkZXIgYXMgVCB9O1xuXG4vLyMgc291cmNlTWFwcGluZ1VSTD1HRUNsaWVudC1mNzEwNDlmOC5qcy5tYXAiXSwibmFtZXMiOltdLCJzb3VyY2VSb290IjoiIn0=
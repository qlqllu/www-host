"use strict";
(self["webpackChunkexb_client"] = self["webpackChunkexb_client"] || []).push([["vendors-extensions_widgets_arcgis_analysis_node_modules_arcgis_app-components_dist_esm_query--4a050d"],{

/***/ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/api-f7934cd7.js":
/*!*********************************************************************************************************!*\
  !*** ./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/api-f7934cd7.js ***!
  \*********************************************************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   a: () => (/* binding */ getAppSwitcherConfig),
/* harmony export */   b: () => (/* binding */ getMarketPlaceProvisionedListings),
/* harmony export */   c: () => (/* binding */ getUserProperties),
/* harmony export */   d: () => (/* binding */ getApprovedApps),
/* harmony export */   e: () => (/* binding */ getOrgCapabilities),
/* harmony export */   f: () => (/* binding */ getSigninSettings),
/* harmony export */   g: () => (/* binding */ getShowInAppLauncher),
/* harmony export */   h: () => (/* binding */ getBlockableApps),
/* harmony export */   i: () => (/* binding */ getServers),
/* harmony export */   j: () => (/* binding */ getPortalSettings),
/* harmony export */   k: () => (/* binding */ fetchAllResources),
/* harmony export */   q: () => (/* binding */ queryAppItemsForChanges),
/* harmony export */   u: () => (/* binding */ updateUserProperties)
/* harmony export */ });
/* harmony import */ var _portal_79caaeff_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./portal-79caaeff.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/portal-79caaeff.js");
/* harmony import */ var _config_eb5f7dc2_js__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./config-eb5f7dc2.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/config-eb5f7dc2.js");
/*!
 * All material copyright ESRI, All Rights Reserved, unless otherwise specified.
 * v3.0.99
 */



const appSwitcherConfigItemQuery = `owner:"esri" AND title:"AppSwitcher Config" AND type: "Application Configuration"`;
async function getPortalSettings(portal) {
  const portalUrl = (0,_portal_79caaeff_js__WEBPACK_IMPORTED_MODULE_0__.g)(portal);
  if (!portalUrl) {
    return;
  }
  const url = `${portalUrl}portals/self/settings`;
  return (0,_portal_79caaeff_js__WEBPACK_IMPORTED_MODULE_0__.f)(() => request(url), "portalSettings", portalUrl);
}
async function getShowInAppLauncher() {
  var _a;
  const settings = await getPortalSettings();
  return ((_a = settings === null || settings === void 0 ? void 0 : settings.portalConfigProperties) === null || _a === void 0 ? void 0 : _a.showInAppLauncher) || [];
}
async function getAppSwitcherConfigItem() {
  const portalUrl = (0,_portal_79caaeff_js__WEBPACK_IMPORTED_MODULE_0__.g)();
  if (!portalUrl) {
    return;
  }
  const url = `${portalUrl}search`;
  return request(url, {
    num: 1,
    start: 0,
    sortField: "title",
    sortOrder: "asc",
    q: appSwitcherConfigItemQuery
  });
}
async function getConfigData(itemId) {
  const portalUrl = (0,_portal_79caaeff_js__WEBPACK_IMPORTED_MODULE_0__.g)();
  if (!portalUrl || !itemId) {
    return;
  }
  const url = `${portalUrl}content/items/${itemId}/data`;
  return request(url);
}
async function getAppSwitcherConfig() {
  var _a;
  const { portal, user } = _config_eb5f7dc2_js__WEBPACK_IMPORTED_MODULE_1__.c;
  if (!(portal === null || portal === void 0 ? void 0 : portal.id) || !user) {
    return;
  }
  const result = await getAppSwitcherConfigItem();
  const item = (_a = result === null || result === void 0 ? void 0 : result.results) === null || _a === void 0 ? void 0 : _a[0];
  if (!item) {
    return;
  }
  const itemId = item.id;
  const data = await getConfigData(itemId);
  return data;
}
async function getUserProperties() {
  const { user } = _config_eb5f7dc2_js__WEBPACK_IMPORTED_MODULE_1__.c;
  const url = `${(0,_portal_79caaeff_js__WEBPACK_IMPORTED_MODULE_0__.g)()}community/users/${user.username}/properties`;
  return request(url);
}
async function getApprovedApps() {
  const { portal } = _config_eb5f7dc2_js__WEBPACK_IMPORTED_MODULE_1__.c;
  const url = `${(0,_portal_79caaeff_js__WEBPACK_IMPORTED_MODULE_0__.g)()}portals/${portal.id}/approvedApps`;
  return request(url, { returnAllApps: false });
}
async function fetchAllResources(url, content, resourceKey = "results") {
  const max = 100;
  let start = 1;
  let resources = [];
  let totalLeft;
  let numRequests;
  let promises;
  let i;
  content.start = start;
  if (!content.num) {
    content.num = max;
  }
  try {
    const result = await request(url, content);
    if (!(result === null || result === void 0 ? void 0 : result[resourceKey])) {
      return resources;
    }
    resources = [...resources, ...result[resourceKey]];
    // calculate whether further batches are needed
    start = result.nextStart;
    totalLeft = result.total - resources.length;
    numRequests = Math.ceil(totalLeft / max);
    promises = [];
    // request each necessary batch
    for (i = 0; i < numRequests; i++) {
      content.start = start + i * max;
      promises.push(request(url, content));
    }
    try {
      const results = await Promise.all(promises);
      results.forEach((r) => {
        resources = [...resources, ...r[resourceKey]];
      });
      return resources;
    }
    catch (_a) {
      return resources;
    }
  }
  catch (_b) {
    return resources;
  }
}
async function getMarketPlaceProvisionedListings() {
  const { user } = _config_eb5f7dc2_js__WEBPACK_IMPORTED_MODULE_1__.c;
  const url = `${(0,_portal_79caaeff_js__WEBPACK_IMPORTED_MODULE_0__.g)()}community/users/${user.username}/provisionedListings`;
  return fetchAllResources(url, { returnAppClientIds: true, returnAllProvisions: true }, "provisionedListings");
}
async function getOrgCapabilities() {
  const url = `${(0,_portal_79caaeff_js__WEBPACK_IMPORTED_MODULE_0__.g)()}portals/self/subscriptionInfo`;
  try {
    const response = await request(url);
    return (response === null || response === void 0 ? void 0 : response.orgCapabilities) || [];
  }
  catch (_a) {
    return [];
  }
}
async function queryAppItemsForChanges(approvedApps, runQuery) {
  if (!runQuery || !(approvedApps === null || approvedApps === void 0 ? void 0 : approvedApps.length)) {
    return;
  }
  const url = `${(0,_portal_79caaeff_js__WEBPACK_IMPORTED_MODULE_0__.g)()}search`;
  return request(url, {
    num: 100,
    q: `id:(${approvedApps.map((a) => `"${a.itemId}"`).join(" OR ")})`
  });
}
const blockedAppsConfigItemQuery = `owner:"esri" AND title:"BlockedApps Config" AND type: "Application Configuration"`;
async function getBlockableApps() {
  var _a, _b;
  const url = `${(0,_portal_79caaeff_js__WEBPACK_IMPORTED_MODULE_0__.g)()}search`;
  try {
    const response = await request(url, {
      num: 10,
      start: 0,
      sortField: "title",
      sortOrder: "asc",
      q: blockedAppsConfigItemQuery
    });
    if (!response) {
      return [];
    }
    const itemId = ((_b = (_a = response.results) === null || _a === void 0 ? void 0 : _a[0]) === null || _b === void 0 ? void 0 : _b.id) || "";
    const data = await getConfigData(itemId);
    return (data === null || data === void 0 ? void 0 : data.blockedApps) || [];
  }
  catch (_c) {
    return [];
  }
}
async function getServers() {
  const url = `${(0,_portal_79caaeff_js__WEBPACK_IMPORTED_MODULE_0__.g)()}portals/self/servers`;
  const response = await request(url);
  return (response === null || response === void 0 ? void 0 : response.servers) || [];
}
async function getSigninSettings() {
  const url = `${(0,_portal_79caaeff_js__WEBPACK_IMPORTED_MODULE_0__.g)()}portals/self/signinSettings`;
  const response = await request(url);
  return response;
}
function getUrl(path) {
  let portalUrl = (0,_portal_79caaeff_js__WEBPACK_IMPORTED_MODULE_0__.g)();
  if (portalUrl.slice(-1) !== "/") {
    portalUrl += "/";
  }
  return `${portalUrl}${path}`;
}
async function request(url, params) {
  if (!params) {
    params = {};
  }
  params.f = "json";
  const token = (0,_portal_79caaeff_js__WEBPACK_IMPORTED_MODULE_0__.h)();
  if (token) {
    params.token = token;
  }
  const urlObj = new URL(url);
  Object.keys(params).forEach((key) => urlObj.searchParams.append(key, params[key]));
  const response = await fetch(urlObj);
  const responseData = await response.json();
  return responseData;
}
async function postRequest(url, data) {
  data.append("f", "json");
  const token = (0,_portal_79caaeff_js__WEBPACK_IMPORTED_MODULE_0__.h)();
  if (token) {
    data.append("token", token);
  }
  fetch(url, { method: "POST", body: data });
}
async function updateUserProperties(properties) {
  const { user } = _config_eb5f7dc2_js__WEBPACK_IMPORTED_MODULE_1__.c;
  const url = getUrl(`community/users/${user.username}/setProperties`);
  const data = new FormData();
  data.append("properties", JSON.stringify(properties));
  return postRequest(url, data);
}




/***/ }),

/***/ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/item-d9d70416.js":
/*!**********************************************************************************************************!*\
  !*** ./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/item-d9d70416.js ***!
  \**********************************************************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   a: () => (/* binding */ getHydratedItem),
/* harmony export */   b: () => (/* binding */ getItemDataUrl),
/* harmony export */   c: () => (/* binding */ getItemGroups),
/* harmony export */   d: () => (/* binding */ getItem),
/* harmony export */   e: () => (/* binding */ isEditableItem),
/* harmony export */   g: () => (/* binding */ getItemData),
/* harmony export */   i: () => (/* binding */ isHostedService),
/* harmony export */   r: () => (/* binding */ requestFetch)
/* harmony export */ });
/* harmony import */ var _portal_79caaeff_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./portal-79caaeff.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/portal-79caaeff.js");
/* harmony import */ var _config_eb5f7dc2_js__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./config-eb5f7dc2.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/config-eb5f7dc2.js");
/* harmony import */ var _privileges_ccd5f37d_js__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./privileges-ccd5f37d.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/privileges-ccd5f37d.js");
/*!
 * All material copyright ESRI, All Rights Reserved, unless otherwise specified.
 * v3.0.99
 */




/** Work-around since using `request` directly will trigger unwanted toast on the Home App if the layer is unavailable */
const requestFetch = async (url, portal, options = {}) => {
  const { body, usePost, addTokenManually, api = _config_eb5f7dc2_js__WEBPACK_IMPORTED_MODULE_1__.c === null || _config_eb5f7dc2_js__WEBPACK_IMPORTED_MODULE_1__.c === void 0 ? void 0 : _config_eb5f7dc2_js__WEBPACK_IMPORTED_MODULE_1__.c.api } = options;
  const data = new URLSearchParams();
  if (body) {
    Object.entries(body).forEach(([key, value]) => {
      if (value !== undefined) {
        data.append(key, value);
      }
    });
  }
  const urlToSend = new URL(url);
  urlToSend.searchParams.append("f", "json");
  const token = addTokenManually === false ? null : await (0,_portal_79caaeff_js__WEBPACK_IMPORTED_MODULE_0__.d)(portal, api);
  if (token) {
    urlToSend.searchParams.append("token", token);
  }
  const response = await fetch(urlToSend.toString(), {
    body: usePost ? data : undefined,
    method: usePost ? "POST" : "GET"
  });
  const result = await response.json();
  const error = result.error;
  if (error) {
    throw typeof error === "string" ? new Error(error) : error;
  }
  return result;
};

const isHostedService = (typeKeywords, type) => type === "Feature Service" && typeKeywords.includes("Hosted Service");

const getHydratedItem = async (itemId, portal) => {
  try {
    const item = await requestFetch(getItemUrl(itemId, portal), portal);
    // TODO: check if we still need to do this
    // if (isHostedService(item.typeKeywords, item.type)) {
    //   const itemData = getItemData(item.id, portal);
    //   return { result: { ...item, ...itemInfo, ...itemData } };
    // }
    return { result: item };
  }
  catch (error) {
    console.error(error);
    return { error: { code: "unhandledError" } };
  }
};
const getItemDataUrl = (itemId, portal) => `${getItemUrl(itemId, portal)}/data`;
const getItemData = async (itemId, portal) => {
  return requestFetch(getItemDataUrl(itemId, portal), portal);
};
// TODO: remove these once we figure out how to efficiently disable the toast on the Home App
const getItemUrl = (itemId, portal) => `${(0,_portal_79caaeff_js__WEBPACK_IMPORTED_MODULE_0__.g)(portal)}content/items/${itemId}`;
const getItem = async (itemId, portal, requestOptions) => {
  try {
    const url = getItemUrl(itemId, portal);
    return await requestFetch(url, portal, requestOptions);
  }
  catch (error) {
    console.warn(error);
  }
};
const getItemGroups = async (itemId, portal) => {
  try {
    const url = `${getItemUrl(itemId, portal)}/groups`;
    return { result: await requestFetch(url, portal) };
  }
  catch (error) {
    // TODO: handle error
    console.error(error);
    return { error: { code: "unhandledError" } };
  }
};
const isEditableItem = async (item, portal) => {
  let isEditable = false;
  if (isHostedService(item.typeKeywords, item.type)) {
    isEditable = await hasEditingCapability(item.url, portal);
  }
  return isEditable;
};
const hasEditingCapability = async (layerUrl, portal, requiredNoToken = false) => {
  var _a, _b, _c;
  if (layerUrl) {
    try {
      const result = await requestFetch(`${(_a = (0,_privileges_ccd5f37d_js__WEBPACK_IMPORTED_MODULE_2__.p)(layerUrl)) === null || _a === void 0 ? void 0 : _a.baseServerUrl}/layers`, portal, { addTokenManually: !requiredNoToken });
      return (_b = result === null || result === void 0 ? void 0 : result.layers) === null || _b === void 0 ? void 0 : _b.reduce((memo, layer) => memo || (layer === null || layer === void 0 ? void 0 : layer.capabilities.includes("Editing")), false);
    }
    catch (error) {
      if ((_c = error === null || error === void 0 ? void 0 : error.message) === null || _c === void 0 ? void 0 : _c.toLowerCase().includes("token required")) {
        return hasEditingCapability(layerUrl, portal, true);
      }
    }
  }
  return false;
};




/***/ }),

/***/ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/query-4f7b7e4d.js":
/*!***********************************************************************************************************!*\
  !*** ./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/query-4f7b7e4d.js ***!
  \***********************************************************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   H: () => (/* binding */ HIDDEN_ITEMS_QUERY),
/* harmony export */   a: () => (/* binding */ getHighlights),
/* harmony export */   b: () => (/* binding */ getProvisionedListings),
/* harmony export */   c: () => (/* binding */ cleanSearchTerm),
/* harmony export */   d: () => (/* binding */ defaultGeometries),
/* harmony export */   f: () => (/* binding */ fetchPreviewItem),
/* harmony export */   g: () => (/* binding */ getTags),
/* harmony export */   i: () => (/* binding */ isPortalViewingArcGISOnline),
/* harmony export */   q: () => (/* binding */ queryItems)
/* harmony export */ });
/* harmony import */ var _portal_79caaeff_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./portal-79caaeff.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/portal-79caaeff.js");
/* harmony import */ var _user_e3dedc4a_js__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./user-e3dedc4a.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/user-e3dedc4a.js");
/* harmony import */ var _functional_c82f5ab9_js__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./functional-c82f5ab9.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/functional-c82f5ab9.js");
/* harmony import */ var _api_f7934cd7_js__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ./api-f7934cd7.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/api-f7934cd7.js");
/* harmony import */ var _server_item_f12153e6_js__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ./server-item-f12153e6.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/server-item-f12153e6.js");
/* harmony import */ var _item_d9d70416_js__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! ./item-d9d70416.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/item-d9d70416.js");
/* harmony import */ var _dom_13f5b00c_js__WEBPACK_IMPORTED_MODULE_6__ = __webpack_require__(/*! ./dom-13f5b00c.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/dom-13f5b00c.js");
/*!
 * All material copyright ESRI, All Rights Reserved, unless otherwise specified.
 * v3.0.99
 */








function cleanSearchTerm(term = "") {
  // sanitize input if it contains html
  const sanitizedSearchTerm = (0,_dom_13f5b00c_js__WEBPACK_IMPORTED_MODULE_6__.s)(term);
  // escape question marks, angle brackets, square brackets, etc
  const escapedTerm = sanitizedSearchTerm.replace(/[<>\/\\[\]\?]/g, "\\$&");
  return escapedTerm.trim();
}

const defaultGeometries = ["nonspatial", "point", "polygon", "multipoint", "polyline"];
function getTags(response, knownTags, activeTags) {
  var _a;
  const tagCounts = {};
  (_a = response.results) === null || _a === void 0 ? void 0 : _a.forEach((item) => {
    item.tags.forEach((tag) => {
      if (tag) {
        tagCounts[tag] = (tagCounts[tag] || 0) + 1;
      }
    });
  });
  const newTags = Object.entries(tagCounts)
    .sort((a, b) => b[1] - a[1])
    .map(([tag]) => tag);
  return (0,_functional_c82f5ab9_js__WEBPACK_IMPORTED_MODULE_2__.b)([...(knownTags || []), ...(newTags || []), ...(activeTags || [])]);
}
const HIDDEN_ITEMS_QUERY = `-type:"Code Attachment" -type:"Featured Items" -type:"Symbol Set" -type:"Color Set" -type:"Windows Viewer Add In" -type:"Windows Viewer Configuration" -type:"Map Area" -typekeywords:"MapAreaPackage" -type:"Indoors Map Configuration" -typekeywords:"SMX"`;
async function queryItems({ portal, query, user, store, config, allowedSubscriptionContentTypes, groupId }) {
  var _a, _b, _c;
  let restBase = (0,_portal_79caaeff_js__WEBPACK_IMPORTED_MODULE_0__.g)(portal);
  let options = {};
  const { num, start, sortOrder, sortField, filters, baseQuery, baseFilter, searchTerm, bucket, allowedGeometries } = query;
  // TODO: set the groupId(s) in the store outside of the following called functions
  // https://devtopia.esri.com/WebGIS/arcgis-app-components/pull/4731#discussion_r1039570
  const group = groupId ||
    (bucket === "living atlas" && ((_a = store === null || store === void 0 ? void 0 : store.state.livingAtlasGroupId) !== null && _a !== void 0 ? _a : (await getLivingAtlasGroupId(portal, store)))) ||
    (bucket === "living atlas analysis" &&
      ((_b = store === null || store === void 0 ? void 0 : store.state.livingAtlasAnalysisGroupId) !== null && _b !== void 0 ? _b : (await getLivingAtlasAnalysisGroupId(portal, store))));
  if (bucket === "subscription content") {
    return getSubscriptionContent(portal, user, allowedSubscriptionContentTypes);
  }
  // if the portal allows it, and we're looking at the "online" bucket, use the online search endpoint
  if (await isPortalViewingArcGISOnline(portal, bucket)) {
    restBase = "https://www.arcgis.com/sharing/rest/";
    options.addTokenManually = false;
  }
  const groupPath = group ? `content/groups/${group}/` : "";
  const url = `${restBase}${groupPath}search`;
  const geometryType = getGeometryQuery(allowedGeometries, portal);
  const filterIds = Object.keys(filters || {});
  const contentArea = bucket ? await getBucketQuery({ bucket, user, portal, store, filters }) : "";
  const term = searchTerm ? `(${cleanSearchTerm(searchTerm)}) ` : "";
  const enriched = !!((config === null || config === void 0 ? void 0 : config.semanticSearchEnabled) && ((_c = portal === null || portal === void 0 ? void 0 : portal.portalProperties) === null || _c === void 0 ? void 0 : _c.semanticSearchEnabled)) || (user && !user.orgId);
  const baseParams = Object.assign(Object.assign(Object.assign({}, (baseFilter ? { filter: `${baseFilter}` } : {})), (enriched ? { enriched: true } : {})), { q: `${baseQuery || ""} ${geometryType} ${contentArea} ${term} ${HIDDEN_ITEMS_QUERY}`, displaySublayers: true, displayHighlights: true });
  const categories = [];
  const queryParams = filterIds.reduce((params, key) => {
    const { param, value, additionalParams } = filters[key];
    // discard filters from hidden buckets
    if ((bucket && key === "group" && bucket !== "group") ||
      (key === "folder" && bucket !== "my") ||
      (key === "region" && (bucket !== "living atlas" || "living atlas analysis"))) {
      return params;
    }
    if (key === "categories" && value) {
      categories.push(filters[key].category);
    }
    if (key === "region" && value) {
      categories.push(filters[key].categoryValue);
    }
    const filterParam = param === "categories" ? {} : { [param]: `${params[param] || ""} ${value}` };
    return Object.assign(Object.assign(Object.assign({}, params), filterParam), (additionalParams !== null && additionalParams !== void 0 ? additionalParams : {}));
  }, baseParams);
  const params = Object.assign({ num,
    start,
    sortField,
    sortOrder }, (queryParams || {}));
  const categoryParam = categories.length
    ? categories.map((category) => `categories=${JSON.stringify([category])}`).join("&")
    : "";
  const divider = categories.length ? "?" : "";
  const response = await (0,_portal_79caaeff_js__WEBPACK_IMPORTED_MODULE_0__.r)(`${url}${divider}${categoryParam}`, params, options);
  return Object.assign(Object.assign({}, response), { queryParams: params });
}
function getGeometryQuery(geometries, portal) {
  // if undeclared or we're using all of them, no need to query,
  // additionally, enterprise does not support sublayer indexing
  if (!geometries || geometries.length === (defaultGeometries === null || defaultGeometries === void 0 ? void 0 : defaultGeometries.length) || (portal === null || portal === void 0 ? void 0 : portal.isPortal)) {
    return "";
  }
  const types = geometries.map((geometry) => `"${geometry}"`).join(" OR ");
  return `((-typekeywords:"Hosted Service") OR (typekeywords:"Hosted Service" AND geometrytype:(${types})))`;
}
function getHighlights(response, config) {
  if (!config.deepLayerSearchEnabled) {
    return {};
  }
  const highlights = {};
  (response.highlights || []).forEach((highlight) => {
    var _a;
    const item = (_a = response.results) === null || _a === void 0 ? void 0 : _a.find((item) => item.id === highlight.id);
    if (!(item === null || item === void 0 ? void 0 : item.sublayers)) {
      return;
    }
    const highlightedFields = Object.keys(highlight)
      .filter((key) => key !== "id" && key.includes("sublayers."))
      .reduce((acc, key) => {
      acc[key.replace("sublayers.", "")] = highlight[key].map((value) => value.replaceAll("<em>", "").replaceAll("</em>", ""));
      return acc;
    }, {});
    const sublayers = item.sublayers
      .filter((sublayer) => {
      return Object.keys(sublayer).some((key) => {
        var _a;
        return (_a = highlightedFields[key]) === null || _a === void 0 ? void 0 : _a.some((value) => sublayer[key].includes(value));
      });
    })
      .map((sublayer) => sublayer.id);
    highlights[highlight.id] = Object.assign(Object.assign({}, highlight), { sublayers });
  });
  return highlights;
}
async function getLivingAtlasGroupId(portal, store) {
  var _a, _b;
  const response = await (0,_portal_79caaeff_js__WEBPACK_IMPORTED_MODULE_0__.q)(
  // We must set sort here to make sure the correct living atlas group comes first in case of multiple
  { q: portal.livingAtlasGroupQuery, num: 1, sortField: "title", sortOrder: "asc" }, portal);
  const id = ((_b = (_a = response.results) === null || _a === void 0 ? void 0 : _a[0]) === null || _b === void 0 ? void 0 : _b.id) || "";
  // TODO: Move to set outside function to avoid side-effects / argument mutation & combine functions
  if (store) {
    store.state.livingAtlasGroupId = id;
  }
  return id;
}
async function getLivingAtlasAnalysisGroupId(portal, store) {
  var _a, _b;
  const response = await (0,_portal_79caaeff_js__WEBPACK_IMPORTED_MODULE_0__.q)({
    q: getLivingAtlasAnalysisGroupQuery(portal),
    num: 1,
    sortField: "title",
    sortOrder: "asc"
  }, portal);
  const id = ((_b = (_a = response.results) === null || _a === void 0 ? void 0 : _a[0]) === null || _b === void 0 ? void 0 : _b.id) || "";
  // TODO: Move to set outside function to avoid side-effects / argument mutation & combine functions
  if (store) {
    store.state.livingAtlasAnalysisGroupId = id;
  }
  return id;
}
/**
 * Formats the correct analysis living atlas query based on portal configuration
 * @param {Portal} portal
 * @returns {string}
 */
function getLivingAtlasAnalysisGroupQuery(portal) {
  // Use `esri_livingatlas` in enterprise and `esri` in online
  const groupOwner = portal.isPortal === true ? "esri_livingatlas" : "esri";
  return `title:"Living Atlas Analysis Layers" AND owner:${groupOwner}`;
}
async function getBucketQuery({ bucket, user, portal, filters }) {
  switch (bucket) {
    case "my":
      return `owner: ${user.username}`;
    case "org":
      return `orgid:${portal.id}`;
    case "favorites":
      const favoritesGroupId = await (0,_user_e3dedc4a_js__WEBPACK_IMPORTED_MODULE_1__.b)();
      return `group: ${favoritesGroupId}`;
    case "group":
      if (!(filters === null || filters === void 0 ? void 0 : filters.group) || (filters === null || filters === void 0 ? void 0 : filters.group.group) === "all") {
        const groups = await (0,_user_e3dedc4a_js__WEBPACK_IMPORTED_MODULE_1__.a)();
        return `group:(${groups === null || groups === void 0 ? void 0 : groups.map(({ id }) => id).join(" OR ")})`;
      }
    default:
      return "";
  }
}
async function isPortalViewingArcGISOnline(portal, bucket) {
  var _a;
  if ((portal === null || portal === void 0 ? void 0 : portal.isPortal) && bucket === "all") {
    const settings = await (0,_api_f7934cd7_js__WEBPACK_IMPORTED_MODULE_3__.j)(portal);
    if ((_a = settings === null || settings === void 0 ? void 0 : settings.portalConfigProperties) === null || _a === void 0 ? void 0 : _a.searchArcGISOnlineEnabled) {
      return true;
    }
  }
  return false;
}
async function getProvisionedListings(user, portal) {
  if (!user || !portal) {
    return [];
  }
  return (0,_portal_79caaeff_js__WEBPACK_IMPORTED_MODULE_0__.f)(async () => {
    const url = `${(0,_portal_79caaeff_js__WEBPACK_IMPORTED_MODULE_0__.g)(portal)}community/users/${user.username}/provisionedListings`;
    return (0,_api_f7934cd7_js__WEBPACK_IMPORTED_MODULE_3__.k)(url, {}, "provisionedListings");
  }, "provisionedListings", `${portal.id}-${user.username}`);
}
async function unwrapRelatedItems(id) {
  var _a;
  const response = await (0,_server_item_f12153e6_js__WEBPACK_IMPORTED_MODULE_4__.b)(id, "Listed2ImplicitlyListed", "forward");
  return (_a = response.relatedItems) !== null && _a !== void 0 ? _a : [];
}
function filterSubscriptionContent(item, allowedSubscriptionContentTypes) {
  // by default, user will see just layers (the set used in the map viewer)
  allowedSubscriptionContentTypes !== null && allowedSubscriptionContentTypes !== void 0 ? allowedSubscriptionContentTypes : (allowedSubscriptionContentTypes = [
    "Map Service",
    "Image Service",
    "Feature Service",
    "Stream Service",
    "Vector Tile Service",
    "WMS",
    "WFS",
    "WMTS",
    "KML",
    "Feature Collection",
    "Feed"
  ]);
  return allowedSubscriptionContentTypes.includes(item.type);
}
async function getSubscriptionContent(portal, user, allowedItemTypes) {
  return (0,_portal_79caaeff_js__WEBPACK_IMPORTED_MODULE_0__.f)(async () => {
    const listings = await getProvisionedListings(user, portal);
    if (!(listings === null || listings === void 0 ? void 0 : listings.length)) {
      return { total: 0, results: [], start: -1, num: 100, nextStart: 0 };
    }
    const ids = listings === null || listings === void 0 ? void 0 : listings.map((listing) => listing.itemId);
    const items = await Promise.all(ids.map((id) => (0,_item_d9d70416_js__WEBPACK_IMPORTED_MODULE_5__.d)(id, portal)));
    const relatedItemsArrays = await Promise.all(ids === null || ids === void 0 ? void 0 : ids.map(unwrapRelatedItems));
    const allItems = relatedItemsArrays
      .reduce((all, relatedItems) => {
      return all.concat(relatedItems);
    }, items)
      .filter((item) => filterSubscriptionContent(item, allowedItemTypes));
    return {
      total: allItems.length,
      results: allItems,
      start: allItems.length ? 1 : 0,
      num: 100,
      nextStart: 0
    };
  }, "subscriptionContent", `${portal.id}-${user.username}`);
}
async function fetchPreviewItem(item, portal, user, store) {
  var _a;
  const portalToOnline = await isPortalViewingArcGISOnline(portal, store.state.bucket);
  const url = portalToOnline
    ? `https://www.arcgis.com/sharing/rest/content/items/${item.id}`
    : (0,_server_item_f12153e6_js__WEBPACK_IMPORTED_MODULE_4__.g)(item.id, portal);
  const options = portalToOnline || !user ? { disableIdentityLookup: true, addTokenManually: false } : {};
  try {
    return { result: await (0,_portal_79caaeff_js__WEBPACK_IMPORTED_MODULE_0__.r)(url, {}, options) };
  }
  catch (error) {
    if (((_a = error === null || error === void 0 ? void 0 : error.details) === null || _a === void 0 ? void 0 : _a.messageCode) === "SB_0005") {
      return { error: { code: "disabledSubscription" } };
    }
  }
  return { error: { code: "unhandledError" } };
}




/***/ }),

/***/ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/user-e3dedc4a.js":
/*!**********************************************************************************************************!*\
  !*** ./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/user-e3dedc4a.js ***!
  \**********************************************************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   a: () => (/* binding */ getSignedInUsersGroups),
/* harmony export */   b: () => (/* binding */ getSignedInUsersFavoritesGroup),
/* harmony export */   c: () => (/* binding */ createFolder),
/* harmony export */   d: () => (/* binding */ getFolderFromId),
/* harmony export */   e: () => (/* binding */ getHomeFolderForUser),
/* harmony export */   f: () => (/* binding */ fetchUser),
/* harmony export */   g: () => (/* binding */ getFolders)
/* harmony export */ });
/* harmony import */ var _portal_79caaeff_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./portal-79caaeff.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/portal-79caaeff.js");
/* harmony import */ var _config_eb5f7dc2_js__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./config-eb5f7dc2.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/config-eb5f7dc2.js");
/*!
 * All material copyright ESRI, All Rights Reserved, unless otherwise specified.
 * v3.0.99
 */



async function fetchUser(username, portal) {
  return (0,_portal_79caaeff_js__WEBPACK_IMPORTED_MODULE_0__.r)(`${(0,_portal_79caaeff_js__WEBPACK_IMPORTED_MODULE_0__.g)(portal)}/community/users/${username}`);
}
async function fetchSelf() {
  return (0,_portal_79caaeff_js__WEBPACK_IMPORTED_MODULE_0__.r)(`${(0,_portal_79caaeff_js__WEBPACK_IMPORTED_MODULE_0__.g)()}/community/self`);
}
async function getSignedInUsersGroups() {
  var _a;
  const user = _config_eb5f7dc2_js__WEBPACK_IMPORTED_MODULE_1__.c === null || _config_eb5f7dc2_js__WEBPACK_IMPORTED_MODULE_1__.c === void 0 ? void 0 : _config_eb5f7dc2_js__WEBPACK_IMPORTED_MODULE_1__.c.user;
  if (!user) {
    return [];
  }
  const self = await (0,_portal_79caaeff_js__WEBPACK_IMPORTED_MODULE_0__.f)(() => fetchSelf(), "communitySelf", user.username);
  return (_a = self === null || self === void 0 ? void 0 : self.groups) !== null && _a !== void 0 ? _a : [];
}
async function getSignedInUsersFavoritesGroup() {
  const user = _config_eb5f7dc2_js__WEBPACK_IMPORTED_MODULE_1__.c === null || _config_eb5f7dc2_js__WEBPACK_IMPORTED_MODULE_1__.c === void 0 ? void 0 : _config_eb5f7dc2_js__WEBPACK_IMPORTED_MODULE_1__.c.user;
  if (!user) {
    return null;
  }
  const self = await (0,_portal_79caaeff_js__WEBPACK_IMPORTED_MODULE_0__.f)(() => fetchSelf(), "communitySelf", user.username);
  return self.favGroupId;
}
async function getUserContent(portalUser) {
  var _a, _b;
  const user = (_a = portalUser !== null && portalUser !== void 0 ? portalUser : _config_eb5f7dc2_js__WEBPACK_IMPORTED_MODULE_1__.c.user) !== null && _a !== void 0 ? _a : _config_eb5f7dc2_js__WEBPACK_IMPORTED_MODULE_1__.c.portal.user;
  const portal = _config_eb5f7dc2_js__WEBPACK_IMPORTED_MODULE_1__.c.portal;
  (_b = user.userContentUrl) !== null && _b !== void 0 ? _b : (user.userContentUrl = (portal === null || portal === void 0 ? void 0 : portal.restUrl) + "/content/users/" + portalUser.username);
  const response = await (0,_portal_79caaeff_js__WEBPACK_IMPORTED_MODULE_0__.r)(user.userContentUrl, { num: 1 });
  return Promise.resolve(response);
}
async function getFolders(portalUser) {
  var _a;
  const user = (_a = portalUser !== null && portalUser !== void 0 ? portalUser : _config_eb5f7dc2_js__WEBPACK_IMPORTED_MODULE_1__.c.user) !== null && _a !== void 0 ? _a : _config_eb5f7dc2_js__WEBPACK_IMPORTED_MODULE_1__.c.portal.user;
  const { folders } = await getUserContent(user);
  const { username } = user;
  // add the home folder as if it's in the list
  return [{ username, id: username, title: username, created: "now" }, ...folders];
}
async function getFolderFromId(folderId, portalUser) {
  var _a;
  const user = (_a = portalUser !== null && portalUser !== void 0 ? portalUser : _config_eb5f7dc2_js__WEBPACK_IMPORTED_MODULE_1__.c.user) !== null && _a !== void 0 ? _a : _config_eb5f7dc2_js__WEBPACK_IMPORTED_MODULE_1__.c.portal.user;
  const folders = await getFolders(user);
  return folders.find((folder) => folder.id === folderId);
}
function getHomeFolderForUser(username) {
  return { username, id: username, title: username, created: "now" };
}
async function createFolder(folderName, portalUser) {
  var _a;
  const user = (_a = portalUser !== null && portalUser !== void 0 ? portalUser : _config_eb5f7dc2_js__WEBPACK_IMPORTED_MODULE_1__.c.user) !== null && _a !== void 0 ? _a : _config_eb5f7dc2_js__WEBPACK_IMPORTED_MODULE_1__.c.portal.user;
  const url = `${user.userContentUrl}/createFolder`;
  const folderResponse = await (0,_portal_79caaeff_js__WEBPACK_IMPORTED_MODULE_0__.r)(url, { title: folderName }, {}, "post");
  return folderResponse;
}




/***/ })

}]);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2lkZ2V0cy9jaHVua3MvYXJjZ2lzX2FuYWx5c2lzX25vZGVfbW9kdWxlc19hcmNnaXNfYXBwLWNvbXBvbmVudHNfZGlzdF9lc21fcXVlcnktLTRhMDUwZC5qcyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUMwRjtBQUNsQzs7QUFFeEQ7QUFDQTtBQUNBLG9CQUFvQixzREFBYztBQUNsQztBQUNBO0FBQ0E7QUFDQSxpQkFBaUIsVUFBVTtBQUMzQixTQUFTLHNEQUFTO0FBQ2xCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0Esb0JBQW9CLHNEQUFjO0FBQ2xDO0FBQ0E7QUFDQTtBQUNBLGlCQUFpQixVQUFVO0FBQzNCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0Esb0JBQW9CLHNEQUFjO0FBQ2xDO0FBQ0E7QUFDQTtBQUNBLGlCQUFpQixVQUFVLGdCQUFnQixPQUFPO0FBQ2xEO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsVUFBVSxlQUFlLEVBQUUsa0RBQVc7QUFDdEM7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxVQUFVLE9BQU8sRUFBRSxrREFBVztBQUM5QixpQkFBaUIsc0RBQWMsR0FBRyxrQkFBa0IsY0FBYztBQUNsRTtBQUNBO0FBQ0E7QUFDQSxVQUFVLFNBQVMsRUFBRSxrREFBVztBQUNoQyxpQkFBaUIsc0RBQWMsR0FBRyxVQUFVLFVBQVU7QUFDdEQsd0JBQXdCLHNCQUFzQjtBQUM5QztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGdCQUFnQixpQkFBaUI7QUFDakM7QUFDQTtBQUNBO0FB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LHlEQUF5RDtBQUNyRTtBQUNBO0FBQ0E7QUFDQSxpRkFBaUYsa0RBQVcsd0NBQXdDLGtEQUFXO0FBQy9JO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsV0FBVztBQUNYO0FBQ0E7QUFDQTtBQUNBLGlGQUFpRixrREFBVyx3Q0FBd0Msa0RBQVc7QUFDL0ksaUJBQWlCLG9CQUFvQjtBQUNyQywrQkFBK0Isc0RBQU8sUUFBUSxtQkFBbUIsSUFBSTtBQUNyRTtBQUNBOztBQUVpTCIsInNvdXJjZXMiOlsid2VicGFjazovL2V4Yi1jbGllbnQvLi9leHRlbnNpb25zL3dpZGdldHMvYXJjZ2lzL2FuYWx5c2lzL25vZGVfbW9kdWxlcy9AYXJjZ2lzL2FwcC1jb21wb25lbnRzL2Rpc3QvZXNtL2FwaS1mNzkzNGNkNy5qcyIsIndlYnBhY2s6Ly9leGItY2xpZW50Ly4vZXh0ZW5zaW9ucy93aWRnZXRzL2FyY2dpcy9hbmFseXNpcy9ub2RlX21vZHVsZXMvQGFyY2dpcy9hcHAtY29tcG9uZW50cy9kaXN0L2VzbS9pdGVtLWQ5ZDcwNDE2LmpzIiwid2VicGFjazovL2V4Yi1jbGllbnQvLi9leHRlbnNpb25zL3dpZGdldHMvYXJjZ2lzL2FuYWx5c2lzL25vZGVfbW9kdWxlcy9AYXJjZ2lzL2FwcC1jb21wb25lbnRzL2Rpc3QvZXNtL3F1ZXJ5LTRmN2I3ZTRkLmpzIiwid2VicGFjazovL2V4Yi1jbGllbnQvLi9leHRlbnNpb25zL3dpZGdldHMvYXJjZ2lzL2FuYWx5c2lzL25vZGVfbW9kdWxlcy9AYXJjZ2lzL2FwcC1jb21wb25lbnRzL2Rpc3QvZXNtL3VzZXItZTNkZWRjNGEuanMiXSwic291cmNlc0NvbnRlbnQiOlsiLyohXG4gKiBBbGwgbWF0ZXJpYWwgY29weXJpZ2h0IEVTUkksIEFsbCBSaWdodHMgUmVzZXJ2ZWQsIHVubGVzcyBvdGhlcndpc2Ugc3BlY2lmaWVkLlxuICogdjMuMC45OVxuICovXG5pbXBvcnQgeyBnIGFzIGdldFJlc3RCYXNlVXJsLCBoIGFzIGdldFRva2VuLCBmIGFzIGZyb21DYWNoZSB9IGZyb20gJy4vcG9ydGFsLTc5Y2FhZWZmLmpzJztcbmltcG9ydCB7IGMgYXMgY29uZmlnU3RhdGUgfSBmcm9tICcuL2NvbmZpZy1lYjVmN2RjMi5qcyc7XG5cbmNvbnN0IGFwcFN3aXRjaGVyQ29uZmlnSXRlbVF1ZXJ5ID0gYG93bmVyOlwiZXNyaVwiIEFORCB0aXRsZTpcIkFwcFN3aXRjaGVyIENvbmZpZ1wiIEFORCB0eXBlOiBcIkFwcGxpY2F0aW9uIENvbmZpZ3VyYXRpb25cImA7XG5hc3luYyBmdW5jdGlvbiBnZXRQb3J0YWxTZXR0aW5ncyhwb3J0YWwpIHtcbiAgY29uc3QgcG9ydGFsVXJsID0gZ2V0UmVzdEJhc2VVcmwocG9ydGFsKTtcbiAgaWYgKCFwb3J0YWxVcmwpIHtcbiAgICByZXR1cm47XG4gIH1cbiAgY29uc3QgdXJsID0gYCR7cG9ydGFsVXJsfXBvcnRhbHMvc2VsZi9zZXR0aW5nc2A7XG4gIHJldHVybiBmcm9tQ2FjaGUoKCkgPT4gcmVxdWVzdCh1cmwpLCBcInBvcnRhbFNldHRpbmdzXCIsIHBvcnRhbFVybCk7XG59XG5hc3luYyBmdW5jdGlvbiBnZXRTaG93SW5BcHBMYXVuY2hlcigpIHtcbiAgdmFyIF9hO1xuICBjb25zdCBzZXR0aW5ncyA9IGF3YWl0IGdldFBvcnRhbFNldHRpbmdzKCk7XG4gIHJldHVybiAoKF9hID0gc2V0dGluZ3MgPT09IG51bGwgfHwgc2V0dGluZ3MgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHNldHRpbmdzLnBvcnRhbENvbmZpZ1Byb3BlcnRpZXMpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5zaG93SW5BcHBMYXVuY2hlcikgfHwgW107XG59XG5hc3luYyBmdW5jdGlvbiBnZXRBcHBTd2l0Y2hlckNvbmZpZ0l0ZW0oKSB7XG4gIGNvbnN0IHBvcnRhbFVybCA9IGdldFJlc3RCYXNlVXJsKCk7XG4gIGlmICghcG9ydGFsVXJsKSB7XG4gICAgcmV0dXJuO1xuICB9XG4gIGNvbnN0IHVybCA9IGAke3BvcnRhbFVybH1zZWFyY2hgO1xuICByZXR1cm4gcmVxdWVzdCh1cmwsIHtcbiAgICBudW06IDEsXG4gICAgc3RhcnQ6IDAsXG4gICAgc29ydEZpZWxkOiBcInRpdGxlXCIsXG4gICAgc29ydE9yZGVyOiBcImFzY1wiLFxuICAgIHE6IGFwcFN3aXRjaGVyQ29uZmlnSXRlbVF1ZXJ5XG4gIH0pO1xufVxuYXN5bmMgZnVuY3Rpb24gZ2V0Q29uZmlnRGF0YShpdGVtSWQpIHtcbiAgY29uc3QgcG9ydGFsVXJsID0gZ2V0UmVzdEJhc2VVcmwoKTtcbiAgaWYgKCFwb3J0YWxVcmwgfHwgIWl0ZW1JZCkge1xuICAgIHJldHVybjtcbiAgfVxuICBjb25zdCB1cmwgPSBgJHtwb3J0YWxVcmx9Y29udGVudC9pdGVtcy8ke2l0ZW1JZH0vZGF0YWA7XG4gIHJldHVybiByZXF1ZXN0KHVybCk7XG59XG5hc3luYyBmdW5jdGlvbiBnZXRBcHBTd2l0Y2hlckNvbmZpZygpIHtcbiAgdmFyIF9hO1xuICBjb25zdCB7IHBvcnRhbCwgdXNlciB9ID0gY29uZmlnU3RhdGU7XG4gIGlmICghKHBvcnRhbCA9PT0gbnVsbCB8fCBwb3J0YWwgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHBvcnRhbC5pZCkgfHwgIXVzZXIpIHtcbiAgICByZXR1cm47XG4gIH1cbiAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZ2V0QXBwU3dpdGNoZXJDb25maWdJdGVtKCk7XG4gIGNvbnN0IGl0ZW0gPSAoX2EgPSByZXN1bHQgPT09IG51bGwgfHwgcmVzdWx0ID09PSB2b2lkIDAgPyB2b2lkIDAgOiByZXN1bHQucmVzdWx0cykgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hWzBdO1xuICBpZiAoIWl0ZW0pIHtcbiAgICByZXR1cm47XG4gIH1cbiAgY29uc3QgaXRlbUlkID0gaXRlbS5pZDtcbiAgY29uc3QgZGF0YSA9IGF3YWl0IGdldENvbmZpZ0RhdGEoaXRlbUlkKTtcbiAgcmV0dXJuIGRhdGE7XG59XG5hc3luYyBmdW5jdGlvbiBnZXRVc2VyUHJvcGVydGllcygpIHtcbiAgY29uc3QgeyB1c2VyIH0gPSBjb25maWdTdGF0ZTtcbiAgY29uc3QgdXJsID0gYCR7Z2V0UmVzdEJhc2VVcmwoKX1jb21tdW5pdHkvdXNlcnMvJHt1c2VyLnVzZXJuYW1lfS9wcm9wZXJ0aWVzYDtcbiAgcmV0dXJuIHJlcXVlc3QodXJsKTtcbn1cbmFzeW5jIGZ1bmN0aW9uIGdldEFwcHJvdmVkQXBwcygpIHtcbiAgY29uc3QgeyBwb3J0YWwgfSA9IGNvbmZpZ1N0YXRlO1xuICBjb25zdCB1cmwgPSBgJHtnZXRSZXN0QmFzZVVybCgpfXBvcnRhbHMvJHtwb3J0YWwuaWR9L2FwcHJvdmVkQXBwc2A7XG4gIHJldHVybiByZXF1ZXN0KHVybCwgeyByZXR1cm5BbGxBcHBzOiBmYWxzZSB9KTtcbn1cbmFzeW5jIGZ1bmN0aW9uIGZldGNoQWxsUmVzb3VyY2VzKHVybCwgY29udGVudCwgcmVzb3VyY2VLZXkgPSBcInJlc3VsdHNcIikge1xuICBjb25zdCBtYXggPSAxMDA7XG4gIGxldCBzdGFydCA9IDE7XG4gIGxldCByZXNvdXJjZXMgPSBbXTtcbiAgbGV0IHRvdGFsTGVmdDtcbiAgbGV0IG51bVJlcXVlc3RzO1xuICBsZXQgcHJvbWlzZXM7XG4gIGxldCBpO1xuICBjb250ZW50LnN0YXJ0ID0gc3RhcnQ7XG4gIGlmICghY29udGVudC5udW0pIHtcbiAgICBjb250ZW50Lm51bSA9IG1heDtcbiAgfVxuICB0cnkge1xuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHJlcXVlc3QodXJsLCBjb250ZW50KTtcbiAgICBpZiAoIShyZXN1bHQgPT09IG51bGwgfHwgcmVzdWx0ID09PSB2b2lkIDAgPyB2b2lkIDAgOiByZXN1bHRbcmVzb3VyY2VLZXldKSkge1xuICAgICAgcmV0dXJuIHJlc291cmNlcztcbiAgICB9XG4gICAgcmVzb3VyY2VzID0gWy4uLnJlc291cmNlcywgLi4ucmVzdWx0W3Jlc291cmNlS2V5XV07XG4gICAgLy8gY2FsY3VsYXRlIHdoZXRoZXIgZnVydGhlciBiYXRjaGVzIGFyZSBuZWVkZWRcbiAgICBzdGFydCA9IHJlc3VsdC5uZXh0U3RhcnQ7XG4gICAgdG90YWxMZWZ0ID0gcmVzdWx0LnRvdGFsIC0gcmVzb3VyY2VzLmxlbmd0aDtcbiAgICBudW1SZXF1ZXN0cyA9IE1hdGguY2VpbCh0b3RhbExlZnQgLyBtYXgpO1xuICAgIHByb21pc2VzID0gW107XG4gICAgLy8gcmVxdWVzdCBlYWNoIG5lY2Vzc2FyeSBiYXRjaFxuICAgIGZvciAoaSA9IDA7IGkgPCBudW1SZXF1ZXN0czsgaSsrKSB7XG4gICAgICBjb250ZW50LnN0YXJ0ID0gc3RhcnQgKyBpICogbWF4O1xuICAgICAgcHJvbWlzZXMucHVzaChyZXF1ZXN0KHVybCwgY29udGVudCkpO1xuICAgIH1cbiAgICB0cnkge1xuICAgICAgY29uc3QgcmVzdWx0cyA9IGF3YWl0IFByb21pc2UuYWxsKHByb21pc2VzKTtcbiAgICAgIHJlc3VsdHMuZm9yRWFjaCgocikgPT4ge1xuICAgICAgICByZXNvdXJjZXMgPSBbLi4ucmVzb3VyY2VzLCAuLi5yW3Jlc291cmNlS2V5XV07XG4gICAgICB9KTtcbiAgICAgIHJldHVybiByZXNvdXJjZXM7XG4gICAgfVxuICAgIGNhdGNoIChfYSkge1xuICAgICAgcmV0dXJuIHJlc291cmNlcztcbiAgICB9XG4gIH1cbiAgY2F0Y2ggKF9iKSB7XG4gICAgcmV0dXJuIHJlc291cmNlcztcbiAgfVxufVxuYXN5bmMgZnVuY3Rpb24gZ2V0TWFya2V0UGxhY2VQcm92aXNpb25lZExpc3RpbmdzKCkge1xuICBjb25zdCB7IHVzZXIgfSA9IGNvbmZpZ1N0YXRlO1xuICBjb25zdCB1cmwgPSBgJHtnZXRSZXN0QmFzZVVybCgpfWNvbW11bml0eS91c2Vycy8ke3VzZXIudXNlcm5hbWV9L3Byb3Zpc2lvbmVkTGlzdGluZ3NgO1xuICByZXR1cm4gZmV0Y2hBbGxSZXNvdXJjZXModXJsLCB7IHJldHVybkFwcENsaWVudElkczogdHJ1ZSwgcmV0dXJuQWxsUHJvdmlzaW9uczogdHJ1ZSB9LCBcInByb3Zpc2lvbmVkTGlzdGluZ3NcIik7XG59XG5hc3luYyBmdW5jdGlvbiBnZXRPcmdDYXBhYmlsaXRpZXMoKSB7XG4gIGNvbnN0IHVybCA9IGAke2dldFJlc3RCYXNlVXJsKCl9cG9ydGFscy9zZWxmL3N1YnNjcmlwdGlvbkluZm9gO1xuICB0cnkge1xuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgcmVxdWVzdCh1cmwpO1xuICAgIHJldHVybiAocmVzcG9uc2UgPT09IG51bGwgfHwgcmVzcG9uc2UgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHJlc3BvbnNlLm9yZ0NhcGFiaWxpdGllcykgfHwgW107XG4gIH1cbiAgY2F0Y2ggKF9hKSB7XG4gICAgcmV0dXJuIFtdO1xuICB9XG59XG5hc3luYyBmdW5jdGlvbiBxdWVyeUFwcEl0ZW1zRm9yQ2hhbmdlcyhhcHByb3ZlZEFwcHMsIHJ1blF1ZXJ5KSB7XG4gIGlmICghcnVuUXVlcnkgfHwgIShhcHByb3ZlZEFwcHMgPT09IG51bGwgfHwgYXBwcm92ZWRBcHBzID09PSB2b2lkIDAgPyB2b2lkIDAgOiBhcHByb3ZlZEFwcHMubGVuZ3RoKSkge1xuICAgIHJldHVybjtcbiAgfVxuICBjb25zdCB1cmwgPSBgJHtnZXRSZXN0QmFzZVVybCgpfXNlYXJjaGA7XG4gIHJldHVybiByZXF1ZXN0KHVybCwge1xuICAgIG51bTogMTAwLFxuICAgIHE6IGBpZDooJHthcHByb3ZlZEFwcHMubWFwKChhKSA9PiBgXCIke2EuaXRlbUlkfVwiYCkuam9pbihcIiBPUiBcIil9KWBcbiAgfSk7XG59XG5jb25zdCBibG9ja2VkQXBwc0NvbmZpZ0l0ZW1RdWVyeSA9IGBvd25lcjpcImVzcmlcIiBBTkQgdGl0bGU6XCJCbG9ja2VkQXBwcyBDb25maWdcIiBBTkQgdHlwZTogXCJBcHBsaWNhdGlvbiBDb25maWd1cmF0aW9uXCJgO1xuYXN5bmMgZnVuY3Rpb24gZ2V0QmxvY2thYmxlQXBwcygpIHtcbiAgdmFyIF9hLCBfYjtcbiAgY29uc3QgdXJsID0gYCR7Z2V0UmVzdEJhc2VVcmwoKX1zZWFyY2hgO1xuICB0cnkge1xuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgcmVxdWVzdCh1cmwsIHtcbiAgICAgIG51bTogMTAsXG4gICAgICBzdGFydDogMCxcbiAgICAgIHNvcnRGaWVsZDogXCJ0aXRsZVwiLFxuICAgICAgc29ydE9yZGVyOiBcImFzY1wiLFxuICAgICAgcTogYmxvY2tlZEFwcHNDb25maWdJdGVtUXVlcnlcbiAgICB9KTtcbiAgICBpZiAoIXJlc3BvbnNlKSB7XG4gICAgICByZXR1cm4gW107XG4gICAgfVxuICAgIGNvbnN0IGl0ZW1JZCA9ICgoX2IgPSAoX2EgPSByZXNwb25zZS5yZXN1bHRzKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2FbMF0pID09PSBudWxsIHx8IF9iID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYi5pZCkgfHwgXCJcIjtcbiAgICBjb25zdCBkYXRhID0gYXdhaXQgZ2V0Q29uZmlnRGF0YShpdGVtSWQpO1xuICAgIHJldHVybiAoZGF0YSA9PT0gbnVsbCB8fCBkYXRhID09PSB2b2lkIDAgPyB2b2lkIDAgOiBkYXRhLmJsb2NrZWRBcHBzKSB8fCBbXTtcbiAgfVxuICBjYXRjaCAoX2MpIHtcbiAgICByZXR1cm4gW107XG4gIH1cbn1cbmFzeW5jIGZ1bmN0aW9uIGdldFNlcnZlcnMoKSB7XG4gIGNvbnN0IHVybCA9IGAke2dldFJlc3RCYXNlVXJsKCl9cG9ydGFscy9zZWxmL3NlcnZlcnNgO1xuICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHJlcXVlc3QodXJsKTtcbiAgcmV0dXJuIChyZXNwb25zZSA9PT0gbnVsbCB8fCByZXNwb25zZSA9PT0gdm9pZCAwID8gdm9pZCAwIDogcmVzcG9uc2Uuc2VydmVycykgfHwgW107XG59XG5hc3luYyBmdW5jdGlvbiBnZXRTaWduaW5TZXR0aW5ncygpIHtcbiAgY29uc3QgdXJsID0gYCR7Z2V0UmVzdEJhc2VVcmwoKX1wb3J0YWxzL3NlbGYvc2lnbmluU2V0dGluZ3NgO1xuICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHJlcXVlc3QodXJsKTtcbiAgcmV0dXJuIHJlc3BvbnNlO1xufVxuZnVuY3Rpb24gZ2V0VXJsKHBhdGgpIHtcbiAgbGV0IHBvcnRhbFVybCA9IGdldFJlc3RCYXNlVXJsKCk7XG4gIGlmIChwb3J0YWxVcmwuc2xpY2UoLTEpICE9PSBcIi9cIikge1xuICAgIHBvcnRhbFVybCArPSBcIi9cIjtcbiAgfVxuICByZXR1cm4gYCR7cG9ydGFsVXJsfSR7cGF0aH1gO1xufVxuYXN5bmMgZnVuY3Rpb24gcmVxdWVzdCh1cmwsIHBhcmFtcykge1xuICBpZiAoIXBhcmFtcykge1xuICAgIHBhcmFtcyA9IHt9O1xuICB9XG4gIHBhcmFtcy5mID0gXCJqc29uXCI7XG4gIGNvbnN0IHRva2VuID0gZ2V0VG9rZW4oKTtcbiAgaWYgKHRva2VuKSB7XG4gICAgcGFyYW1zLnRva2VuID0gdG9rZW47XG4gIH1cbiAgY29uc3QgdXJsT2JqID0gbmV3IFVSTCh1cmwpO1xuICBPYmplY3Qua2V5cyhwYXJhbXMpLmZvckVhY2goKGtleSkgPT4gdXJsT2JqLnNlYXJjaFBhcmFtcy5hcHBlbmQoa2V5LCBwYXJhbXNba2V5XSkpO1xuICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGZldGNoKHVybE9iaik7XG4gIGNvbnN0IHJlc3BvbnNlRGF0YSA9IGF3YWl0IHJlc3BvbnNlLmpzb24oKTtcbiAgcmV0dXJuIHJlc3BvbnNlRGF0YTtcbn1cbmFzeW5jIGZ1bmN0aW9uIHBvc3RSZXF1ZXN0KHVybCwgZGF0YSkge1xuICBkYXRhLmFwcGVuZChcImZcIiwgXCJqc29uXCIpO1xuICBjb25zdCB0b2tlbiA9IGdldFRva2VuKCk7XG4gIGlmICh0b2tlbikge1xuICAgIGRhdGEuYXBwZW5kKFwidG9rZW5cIiwgdG9rZW4pO1xuICB9XG4gIGZldGNoKHVybCwgeyBtZXRob2Q6IFwiUE9TVFwiLCBib2R5OiBkYXRhIH0pO1xufVxuYXN5bmMgZnVuY3Rpb24gdXBkYXRlVXNlclByb3BlcnRpZXMocHJvcGVydGllcykge1xuICBjb25zdCB7IHVzZXIgfSA9IGNvbmZpZ1N0YXRlO1xuICBjb25zdCB1cmwgPSBnZXRVcmwoYGNvbW11bml0eS91c2Vycy8ke3VzZXIudXNlcm5hbWV9L3NldFByb3BlcnRpZXNgKTtcbiAgY29uc3QgZGF0YSA9IG5ldyBGb3JtRGF0YSgpO1xuICBkYXRhLmFwcGVuZChcInByb3BlcnRpZXNcIiwgSlNPTi5zdHJpbmdpZnkocHJvcGVydGllcykpO1xuICByZXR1cm4gcG9zdFJlcXVlc3QodXJsLCBkYXRhKTtcbn1cblxuZXhwb3J0IHsgZ2V0QXBwU3dpdGNoZXJDb25maWcgYXMgYSwgZ2V0TWFya2V0UGxhY2VQcm92aXNpb25lZExpc3RpbmdzIGFzIGIsIGdldFVzZXJQcm9wZXJ0aWVzIGFzIGMsIGdldEFwcHJvdmVkQXBwcyBhcyBkLCBnZXRPcmdDYXBhYmlsaXRpZXMgYXMgZSwgZ2V0U2lnbmluU2V0dGluZ3MgYXMgZiwgZ2V0U2hvd0luQXBwTGF1bmNoZXIgYXMgZywgZ2V0QmxvY2thYmxlQXBwcyBhcyBoLCBnZXRTZXJ2ZXJzIGFzIGksIGdldFBvcnRhbFNldHRpbmdzIGFzIGosIGZldGNoQWxsUmVzb3VyY2VzIGFzIGssIHF1ZXJ5QXBwSXRlbXNGb3JDaGFuZ2VzIGFzIHEsIHVwZGF0ZVVzZXJQcm9wZXJ0aWVzIGFzIHUgfTtcbiIsIi8qIVxuICogQWxsIG1hdGVyaWFsIGNvcHlyaWdodCBFU1JJLCBBbGwgUmlnaHRzIFJlc2VydmVkLCB1bmxlc3Mgb3RoZXJ3aXNlIHNwZWNpZmllZC5cbiAqIHYzLjAuOTlcbiAqL1xuaW1wb3J0IHsgZCBhcyBnZXRQb3J0YWxUb2tlbiwgZyBhcyBnZXRSZXN0QmFzZVVybCB9IGZyb20gJy4vcG9ydGFsLTc5Y2FhZWZmLmpzJztcbmltcG9ydCB7IGMgYXMgY29uZmlnU3RhdGUgfSBmcm9tICcuL2NvbmZpZy1lYjVmN2RjMi5qcyc7XG5pbXBvcnQgeyBwIGFzIHBhcnNlQUdTU2VydmVySW5mbyB9IGZyb20gJy4vcHJpdmlsZWdlcy1jY2Q1ZjM3ZC5qcyc7XG5cbi8qKiBXb3JrLWFyb3VuZCBzaW5jZSB1c2luZyBgcmVxdWVzdGAgZGlyZWN0bHkgd2lsbCB0cmlnZ2VyIHVud2FudGVkIHRvYXN0IG9uIHRoZSBIb21lIEFwcCBpZiB0aGUgbGF5ZXIgaXMgdW5hdmFpbGFibGUgKi9cbmNvbnN0IHJlcXVlc3RGZXRjaCA9IGFzeW5jICh1cmwsIHBvcnRhbCwgb3B0aW9ucyA9IHt9KSA9PiB7XG4gIGNvbnN0IHsgYm9keSwgdXNlUG9zdCwgYWRkVG9rZW5NYW51YWxseSwgYXBpID0gY29uZmlnU3RhdGUgPT09IG51bGwgfHwgY29uZmlnU3RhdGUgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGNvbmZpZ1N0YXRlLmFwaSB9ID0gb3B0aW9ucztcbiAgY29uc3QgZGF0YSA9IG5ldyBVUkxTZWFyY2hQYXJhbXMoKTtcbiAgaWYgKGJvZHkpIHtcbiAgICBPYmplY3QuZW50cmllcyhib2R5KS5mb3JFYWNoKChba2V5LCB2YWx1ZV0pID0+IHtcbiAgICAgIGlmICh2YWx1ZSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIGRhdGEuYXBwZW5kKGtleSwgdmFsdWUpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG4gIGNvbnN0IHVybFRvU2VuZCA9IG5ldyBVUkwodXJsKTtcbiAgdXJsVG9TZW5kLnNlYXJjaFBhcmFtcy5hcHBlbmQoXCJmXCIsIFwianNvblwiKTtcbiAgY29uc3QgdG9rZW4gPSBhZGRUb2tlbk1hbnVhbGx5ID09PSBmYWxzZSA/IG51bGwgOiBhd2FpdCBnZXRQb3J0YWxUb2tlbihwb3J0YWwsIGFwaSk7XG4gIGlmICh0b2tlbikge1xuICAgIHVybFRvU2VuZC5zZWFyY2hQYXJhbXMuYXBwZW5kKFwidG9rZW5cIiwgdG9rZW4pO1xuICB9XG4gIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZmV0Y2godXJsVG9TZW5kLnRvU3RyaW5nKCksIHtcbiAgICBib2R5OiB1c2VQb3N0ID8gZGF0YSA6IHVuZGVmaW5lZCxcbiAgICBtZXRob2Q6IHVzZVBvc3QgPyBcIlBPU1RcIiA6IFwiR0VUXCJcbiAgfSk7XG4gIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHJlc3BvbnNlLmpzb24oKTtcbiAgY29uc3QgZXJyb3IgPSByZXN1bHQuZXJyb3I7XG4gIGlmIChlcnJvcikge1xuICAgIHRocm93IHR5cGVvZiBlcnJvciA9PT0gXCJzdHJpbmdcIiA/IG5ldyBFcnJvcihlcnJvcikgOiBlcnJvcjtcbiAgfVxuICByZXR1cm4gcmVzdWx0O1xufTtcblxuY29uc3QgaXNIb3N0ZWRTZXJ2aWNlID0gKHR5cGVLZXl3b3JkcywgdHlwZSkgPT4gdHlwZSA9PT0gXCJGZWF0dXJlIFNlcnZpY2VcIiAmJiB0eXBlS2V5d29yZHMuaW5jbHVkZXMoXCJIb3N0ZWQgU2VydmljZVwiKTtcblxuY29uc3QgZ2V0SHlkcmF0ZWRJdGVtID0gYXN5bmMgKGl0ZW1JZCwgcG9ydGFsKSA9PiB7XG4gIHRyeSB7XG4gICAgY29uc3QgaXRlbSA9IGF3YWl0IHJlcXVlc3RGZXRjaChnZXRJdGVtVXJsKGl0ZW1JZCwgcG9ydGFsKSwgcG9ydGFsKTtcbiAgICAvLyBUT0RPOiBjaGVjayBpZiB3ZSBzdGlsbCBuZWVkIHRvIGRvIHRoaXNcbiAgICAvLyBpZiAoaXNIb3N0ZWRTZXJ2aWNlKGl0ZW0udHlwZUtleXdvcmRzLCBpdGVtLnR5cGUpKSB7XG4gICAgLy8gICBjb25zdCBpdGVtRGF0YSA9IGdldEl0ZW1EYXRhKGl0ZW0uaWQsIHBvcnRhbCk7XG4gICAgLy8gICByZXR1cm4geyByZXN1bHQ6IHsgLi4uaXRlbSwgLi4uaXRlbUluZm8sIC4uLml0ZW1EYXRhIH0gfTtcbiAgICAvLyB9XG4gICAgcmV0dXJuIHsgcmVzdWx0OiBpdGVtIH07XG4gIH1cbiAgY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcihlcnJvcik7XG4gICAgcmV0dXJuIHsgZXJyb3I6IHsgY29kZTogXCJ1bmhhbmRsZWRFcnJvclwiIH0gfTtcbiAgfVxufTtcbmNvbnN0IGdldEl0ZW1EYXRhVXJsID0gKGl0ZW1JZCwgcG9ydGFsKSA9PiBgJHtnZXRJdGVtVXJsKGl0ZW1JZCwgcG9ydGFsKX0vZGF0YWA7XG5jb25zdCBnZXRJdGVtRGF0YSA9IGFzeW5jIChpdGVtSWQsIHBvcnRhbCkgPT4ge1xuICByZXR1cm4gcmVxdWVzdEZldGNoKGdldEl0ZW1EYXRhVXJsKGl0ZW1JZCwgcG9ydGFsKSwgcG9ydGFsKTtcbn07XG4vLyBUT0RPOiByZW1vdmUgdGhlc2Ugb25jZSB3ZSBmaWd1cmUgb3V0IGhvdyB0byBlZmZpY2llbnRseSBkaXNhYmxlIHRoZSB0b2FzdCBvbiB0aGUgSG9tZSBBcHBcbmNvbnN0IGdldEl0ZW1VcmwgPSAoaXRlbUlkLCBwb3J0YWwpID0+IGAke2dldFJlc3RCYXNlVXJsKHBvcnRhbCl9Y29udGVudC9pdGVtcy8ke2l0ZW1JZH1gO1xuY29uc3QgZ2V0SXRlbSA9IGFzeW5jIChpdGVtSWQsIHBvcnRhbCwgcmVxdWVzdE9wdGlvbnMpID0+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCB1cmwgPSBnZXRJdGVtVXJsKGl0ZW1JZCwgcG9ydGFsKTtcbiAgICByZXR1cm4gYXdhaXQgcmVxdWVzdEZldGNoKHVybCwgcG9ydGFsLCByZXF1ZXN0T3B0aW9ucyk7XG4gIH1cbiAgY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS53YXJuKGVycm9yKTtcbiAgfVxufTtcbmNvbnN0IGdldEl0ZW1Hcm91cHMgPSBhc3luYyAoaXRlbUlkLCBwb3J0YWwpID0+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCB1cmwgPSBgJHtnZXRJdGVtVXJsKGl0ZW1JZCwgcG9ydGFsKX0vZ3JvdXBzYDtcbiAgICByZXR1cm4geyByZXN1bHQ6IGF3YWl0IHJlcXVlc3RGZXRjaCh1cmwsIHBvcnRhbCkgfTtcbiAgfVxuICBjYXRjaCAoZXJyb3IpIHtcbiAgICAvLyBUT0RPOiBoYW5kbGUgZXJyb3JcbiAgICBjb25zb2xlLmVycm9yKGVycm9yKTtcbiAgICByZXR1cm4geyBlcnJvcjogeyBjb2RlOiBcInVuaGFuZGxlZEVycm9yXCIgfSB9O1xuICB9XG59O1xuY29uc3QgaXNFZGl0YWJsZUl0ZW0gPSBhc3luYyAoaXRlbSwgcG9ydGFsKSA9PiB7XG4gIGxldCBpc0VkaXRhYmxlID0gZmFsc2U7XG4gIGlmIChpc0hvc3RlZFNlcnZpY2UoaXRlbS50eXBlS2V5d29yZHMsIGl0ZW0udHlwZSkpIHtcbiAgICBpc0VkaXRhYmxlID0gYXdhaXQgaGFzRWRpdGluZ0NhcGFiaWxpdHkoaXRlbS51cmwsIHBvcnRhbCk7XG4gIH1cbiAgcmV0dXJuIGlzRWRpdGFibGU7XG59O1xuY29uc3QgaGFzRWRpdGluZ0NhcGFiaWxpdHkgPSBhc3luYyAobGF5ZXJVcmwsIHBvcnRhbCwgcmVxdWlyZWROb1Rva2VuID0gZmFsc2UpID0+IHtcbiAgdmFyIF9hLCBfYiwgX2M7XG4gIGlmIChsYXllclVybCkge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCByZXF1ZXN0RmV0Y2goYCR7KF9hID0gcGFyc2VBR1NTZXJ2ZXJJbmZvKGxheWVyVXJsKSkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmJhc2VTZXJ2ZXJVcmx9L2xheWVyc2AsIHBvcnRhbCwgeyBhZGRUb2tlbk1hbnVhbGx5OiAhcmVxdWlyZWROb1Rva2VuIH0pO1xuICAgICAgcmV0dXJuIChfYiA9IHJlc3VsdCA9PT0gbnVsbCB8fCByZXN1bHQgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHJlc3VsdC5sYXllcnMpID09PSBudWxsIHx8IF9iID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYi5yZWR1Y2UoKG1lbW8sIGxheWVyKSA9PiBtZW1vIHx8IChsYXllciA9PT0gbnVsbCB8fCBsYXllciA9PT0gdm9pZCAwID8gdm9pZCAwIDogbGF5ZXIuY2FwYWJpbGl0aWVzLmluY2x1ZGVzKFwiRWRpdGluZ1wiKSksIGZhbHNlKTtcbiAgICB9XG4gICAgY2F0Y2ggKGVycm9yKSB7XG4gICAgICBpZiAoKF9jID0gZXJyb3IgPT09IG51bGwgfHwgZXJyb3IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGVycm9yLm1lc3NhZ2UpID09PSBudWxsIHx8IF9jID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYy50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKFwidG9rZW4gcmVxdWlyZWRcIikpIHtcbiAgICAgICAgcmV0dXJuIGhhc0VkaXRpbmdDYXBhYmlsaXR5KGxheWVyVXJsLCBwb3J0YWwsIHRydWUpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuICByZXR1cm4gZmFsc2U7XG59O1xuXG5leHBvcnQgeyBnZXRIeWRyYXRlZEl0ZW0gYXMgYSwgZ2V0SXRlbURhdGFVcmwgYXMgYiwgZ2V0SXRlbUdyb3VwcyBhcyBjLCBnZXRJdGVtIGFzIGQsIGlzRWRpdGFibGVJdGVtIGFzIGUsIGdldEl0ZW1EYXRhIGFzIGcsIGlzSG9zdGVkU2VydmljZSBhcyBpLCByZXF1ZXN0RmV0Y2ggYXMgciB9O1xuIiwiLyohXG4gKiBBbGwgbWF0ZXJpYWwgY29weXJpZ2h0IEVTUkksIEFsbCBSaWdodHMgUmVzZXJ2ZWQsIHVubGVzcyBvdGhlcndpc2Ugc3BlY2lmaWVkLlxuICogdjMuMC45OVxuICovXG5pbXBvcnQgeyBnIGFzIGdldFJlc3RCYXNlVXJsLCBmIGFzIGZyb21DYWNoZSwgciBhcyByZXF1ZXN0LCBxIGFzIHF1ZXJ5R3JvdXBzIH0gZnJvbSAnLi9wb3J0YWwtNzljYWFlZmYuanMnO1xuaW1wb3J0IHsgYSBhcyBnZXRTaWduZWRJblVzZXJzR3JvdXBzLCBiIGFzIGdldFNpZ25lZEluVXNlcnNGYXZvcml0ZXNHcm91cCB9IGZyb20gJy4vdXNlci1lM2RlZGM0YS5qcyc7XG5pbXBvcnQgeyBiIGFzIHVuaXF1ZSB9IGZyb20gJy4vZnVuY3Rpb25hbC1jODJmNWFiOS5qcyc7XG5pbXBvcnQgeyBqIGFzIGdldFBvcnRhbFNldHRpbmdzLCBrIGFzIGZldGNoQWxsUmVzb3VyY2VzIH0gZnJvbSAnLi9hcGktZjc5MzRjZDcuanMnO1xuaW1wb3J0IHsgYiBhcyBnZXRSZWxhdGVkSXRlbXMsIGcgYXMgZ2V0SXRlbVVybCB9IGZyb20gJy4vc2VydmVyLWl0ZW0tZjEyMTUzZTYuanMnO1xuaW1wb3J0IHsgZCBhcyBnZXRJdGVtIH0gZnJvbSAnLi9pdGVtLWQ5ZDcwNDE2LmpzJztcbmltcG9ydCB7IHMgYXMgc2FuaXRpemVIVE1MIH0gZnJvbSAnLi9kb20tMTNmNWIwMGMuanMnO1xuXG5mdW5jdGlvbiBjbGVhblNlYXJjaFRlcm0odGVybSA9IFwiXCIpIHtcbiAgLy8gc2FuaXRpemUgaW5wdXQgaWYgaXQgY29udGFpbnMgaHRtbFxuICBjb25zdCBzYW5pdGl6ZWRTZWFyY2hUZXJtID0gc2FuaXRpemVIVE1MKHRlcm0pO1xuICAvLyBlc2NhcGUgcXVlc3Rpb24gbWFya3MsIGFuZ2xlIGJyYWNrZXRzLCBzcXVhcmUgYnJhY2tldHMsIGV0Y1xuICBjb25zdCBlc2NhcGVkVGVybSA9IHNhbml0aXplZFNlYXJjaFRlcm0ucmVwbGFjZSgvWzw+XFwvXFxcXFtcXF1cXD9dL2csIFwiXFxcXCQmXCIpO1xuICByZXR1cm4gZXNjYXBlZFRlcm0udHJpbSgpO1xufVxuXG5jb25zdCBkZWZhdWx0R2VvbWV0cmllcyA9IFtcIm5vbnNwYXRpYWxcIiwgXCJwb2ludFwiLCBcInBvbHlnb25cIiwgXCJtdWx0aXBvaW50XCIsIFwicG9seWxpbmVcIl07XG5mdW5jdGlvbiBnZXRUYWdzKHJlc3BvbnNlLCBrbm93blRhZ3MsIGFjdGl2ZVRhZ3MpIHtcbiAgdmFyIF9hO1xuICBjb25zdCB0YWdDb3VudHMgPSB7fTtcbiAgKF9hID0gcmVzcG9uc2UucmVzdWx0cykgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmZvckVhY2goKGl0ZW0pID0+IHtcbiAgICBpdGVtLnRhZ3MuZm9yRWFjaCgodGFnKSA9PiB7XG4gICAgICBpZiAodGFnKSB7XG4gICAgICAgIHRhZ0NvdW50c1t0YWddID0gKHRhZ0NvdW50c1t0YWddIHx8IDApICsgMTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfSk7XG4gIGNvbnN0IG5ld1RhZ3MgPSBPYmplY3QuZW50cmllcyh0YWdDb3VudHMpXG4gICAgLnNvcnQoKGEsIGIpID0+IGJbMV0gLSBhWzFdKVxuICAgIC5tYXAoKFt0YWddKSA9PiB0YWcpO1xuICByZXR1cm4gdW5pcXVlKFsuLi4oa25vd25UYWdzIHx8IFtdKSwgLi4uKG5ld1RhZ3MgfHwgW10pLCAuLi4oYWN0aXZlVGFncyB8fCBbXSldKTtcbn1cbmNvbnN0IEhJRERFTl9JVEVNU19RVUVSWSA9IGAtdHlwZTpcIkNvZGUgQXR0YWNobWVudFwiIC10eXBlOlwiRmVhdHVyZWQgSXRlbXNcIiAtdHlwZTpcIlN5bWJvbCBTZXRcIiAtdHlwZTpcIkNvbG9yIFNldFwiIC10eXBlOlwiV2luZG93cyBWaWV3ZXIgQWRkIEluXCIgLXR5cGU6XCJXaW5kb3dzIFZpZXdlciBDb25maWd1cmF0aW9uXCIgLXR5cGU6XCJNYXAgQXJlYVwiIC10eXBla2V5d29yZHM6XCJNYXBBcmVhUGFja2FnZVwiIC10eXBlOlwiSW5kb29ycyBNYXAgQ29uZmlndXJhdGlvblwiIC10eXBla2V5d29yZHM6XCJTTVhcImA7XG5hc3luYyBmdW5jdGlvbiBxdWVyeUl0ZW1zKHsgcG9ydGFsLCBxdWVyeSwgdXNlciwgc3RvcmUsIGNvbmZpZywgYWxsb3dlZFN1YnNjcmlwdGlvbkNvbnRlbnRUeXBlcywgZ3JvdXBJZCB9KSB7XG4gIHZhciBfYSwgX2IsIF9jO1xuICBsZXQgcmVzdEJhc2UgPSBnZXRSZXN0QmFzZVVybChwb3J0YWwpO1xuICBsZXQgb3B0aW9ucyA9IHt9O1xuICBjb25zdCB7IG51bSwgc3RhcnQsIHNvcnRPcmRlciwgc29ydEZpZWxkLCBmaWx0ZXJzLCBiYXNlUXVlcnksIGJhc2VGaWx0ZXIsIHNlYXJjaFRlcm0sIGJ1Y2tldCwgYWxsb3dlZEdlb21ldHJpZXMgfSA9IHF1ZXJ5O1xuICAvLyBUT0RPOiBzZXQgdGhlIGdyb3VwSWQocykgaW4gdGhlIHN0b3JlIG91dHNpZGUgb2YgdGhlIGZvbGxvd2luZyBjYWxsZWQgZnVuY3Rpb25zXG4gIC8vIGh0dHBzOi8vZGV2dG9waWEuZXNyaS5jb20vV2ViR0lTL2FyY2dpcy1hcHAtY29tcG9uZW50cy9wdWxsLzQ3MzEjZGlzY3Vzc2lvbl9yMTAzOTU3MFxuICBjb25zdCBncm91cCA9IGdyb3VwSWQgfHxcbiAgICAoYnVja2V0ID09PSBcImxpdmluZyBhdGxhc1wiICYmICgoX2EgPSBzdG9yZSA9PT0gbnVsbCB8fCBzdG9yZSA9PT0gdm9pZCAwID8gdm9pZCAwIDogc3RvcmUuc3RhdGUubGl2aW5nQXRsYXNHcm91cElkKSAhPT0gbnVsbCAmJiBfYSAhPT0gdm9pZCAwID8gX2EgOiAoYXdhaXQgZ2V0TGl2aW5nQXRsYXNHcm91cElkKHBvcnRhbCwgc3RvcmUpKSkpIHx8XG4gICAgKGJ1Y2tldCA9PT0gXCJsaXZpbmcgYXRsYXMgYW5hbHlzaXNcIiAmJlxuICAgICAgKChfYiA9IHN0b3JlID09PSBudWxsIHx8IHN0b3JlID09PSB2b2lkIDAgPyB2b2lkIDAgOiBzdG9yZS5zdGF0ZS5saXZpbmdBdGxhc0FuYWx5c2lzR3JvdXBJZCkgIT09IG51bGwgJiYgX2IgIT09IHZvaWQgMCA/IF9iIDogKGF3YWl0IGdldExpdmluZ0F0bGFzQW5hbHlzaXNHcm91cElkKHBvcnRhbCwgc3RvcmUpKSkpO1xuICBpZiAoYnVja2V0ID09PSBcInN1YnNjcmlwdGlvbiBjb250ZW50XCIpIHtcbiAgICByZXR1cm4gZ2V0U3Vic2NyaXB0aW9uQ29udGVudChwb3J0YWwsIHVzZXIsIGFsbG93ZWRTdWJzY3JpcHRpb25Db250ZW50VHlwZXMpO1xuICB9XG4gIC8vIGlmIHRoZSBwb3J0YWwgYWxsb3dzIGl0LCBhbmQgd2UncmUgbG9va2luZyBhdCB0aGUgXCJvbmxpbmVcIiBidWNrZXQsIHVzZSB0aGUgb25saW5lIHNlYXJjaCBlbmRwb2ludFxuICBpZiAoYXdhaXQgaXNQb3J0YWxWaWV3aW5nQXJjR0lTT25saW5lKHBvcnRhbCwgYnVja2V0KSkge1xuICAgIHJlc3RCYXNlID0gXCJodHRwczovL3d3dy5hcmNnaXMuY29tL3NoYXJpbmcvcmVzdC9cIjtcbiAgICBvcHRpb25zLmFkZFRva2VuTWFudWFsbHkgPSBmYWxzZTtcbiAgfVxuICBjb25zdCBncm91cFBhdGggPSBncm91cCA/IGBjb250ZW50L2dyb3Vwcy8ke2dyb3VwfS9gIDogXCJcIjtcbiAgY29uc3QgdXJsID0gYCR7cmVzdEJhc2V9JHtncm91cFBhdGh9c2VhcmNoYDtcbiAgY29uc3QgZ2VvbWV0cnlUeXBlID0gZ2V0R2VvbWV0cnlRdWVyeShhbGxvd2VkR2VvbWV0cmllcywgcG9ydGFsKTtcbiAgY29uc3QgZmlsdGVySWRzID0gT2JqZWN0LmtleXMoZmlsdGVycyB8fCB7fSk7XG4gIGNvbnN0IGNvbnRlbnRBcmVhID0gYnVja2V0ID8gYXdhaXQgZ2V0QnVja2V0UXVlcnkoeyBidWNrZXQsIHVzZXIsIHBvcnRhbCwgc3RvcmUsIGZpbHRlcnMgfSkgOiBcIlwiO1xuICBjb25zdCB0ZXJtID0gc2VhcmNoVGVybSA/IGAoJHtjbGVhblNlYXJjaFRlcm0oc2VhcmNoVGVybSl9KSBgIDogXCJcIjtcbiAgY29uc3QgZW5yaWNoZWQgPSAhISgoY29uZmlnID09PSBudWxsIHx8IGNvbmZpZyA9PT0gdm9pZCAwID8gdm9pZCAwIDogY29uZmlnLnNlbWFudGljU2VhcmNoRW5hYmxlZCkgJiYgKChfYyA9IHBvcnRhbCA9PT0gbnVsbCB8fCBwb3J0YWwgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHBvcnRhbC5wb3J0YWxQcm9wZXJ0aWVzKSA9PT0gbnVsbCB8fCBfYyA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2Muc2VtYW50aWNTZWFyY2hFbmFibGVkKSkgfHwgKHVzZXIgJiYgIXVzZXIub3JnSWQpO1xuICBjb25zdCBiYXNlUGFyYW1zID0gT2JqZWN0LmFzc2lnbihPYmplY3QuYXNzaWduKE9iamVjdC5hc3NpZ24oe30sIChiYXNlRmlsdGVyID8geyBmaWx0ZXI6IGAke2Jhc2VGaWx0ZXJ9YCB9IDoge30pKSwgKGVucmljaGVkID8geyBlbnJpY2hlZDogdHJ1ZSB9IDoge30pKSwgeyBxOiBgJHtiYXNlUXVlcnkgfHwgXCJcIn0gJHtnZW9tZXRyeVR5cGV9ICR7Y29udGVudEFyZWF9ICR7dGVybX0gJHtISURERU5fSVRFTVNfUVVFUll9YCwgZGlzcGxheVN1YmxheWVyczogdHJ1ZSwgZGlzcGxheUhpZ2hsaWdodHM6IHRydWUgfSk7XG4gIGNvbnN0IGNhdGVnb3JpZXMgPSBbXTtcbiAgY29uc3QgcXVlcnlQYXJhbXMgPSBmaWx0ZXJJZHMucmVkdWNlKChwYXJhbXMsIGtleSkgPT4ge1xuICAgIGNvbnN0IHsgcGFyYW0sIHZhbHVlLCBhZGRpdGlvbmFsUGFyYW1zIH0gPSBmaWx0ZXJzW2tleV07XG4gICAgLy8gZGlzY2FyZCBmaWx0ZXJzIGZyb20gaGlkZGVuIGJ1Y2tldHNcbiAgICBpZiAoKGJ1Y2tldCAmJiBrZXkgPT09IFwiZ3JvdXBcIiAmJiBidWNrZXQgIT09IFwiZ3JvdXBcIikgfHxcbiAgICAgIChrZXkgPT09IFwiZm9sZGVyXCIgJiYgYnVja2V0ICE9PSBcIm15XCIpIHx8XG4gICAgICAoa2V5ID09PSBcInJlZ2lvblwiICYmIChidWNrZXQgIT09IFwibGl2aW5nIGF0bGFzXCIgfHwgXCJsaXZpbmcgYXRsYXMgYW5hbHlzaXNcIikpKSB7XG4gICAgICByZXR1cm4gcGFyYW1zO1xuICAgIH1cbiAgICBpZiAoa2V5ID09PSBcImNhdGVnb3JpZXNcIiAmJiB2YWx1ZSkge1xuICAgICAgY2F0ZWdvcmllcy5wdXNoKGZpbHRlcnNba2V5XS5jYXRlZ29yeSk7XG4gICAgfVxuICAgIGlmIChrZXkgPT09IFwicmVnaW9uXCIgJiYgdmFsdWUpIHtcbiAgICAgIGNhdGVnb3JpZXMucHVzaChmaWx0ZXJzW2tleV0uY2F0ZWdvcnlWYWx1ZSk7XG4gICAgfVxuICAgIGNvbnN0IGZpbHRlclBhcmFtID0gcGFyYW0gPT09IFwiY2F0ZWdvcmllc1wiID8ge30gOiB7IFtwYXJhbV06IGAke3BhcmFtc1twYXJhbV0gfHwgXCJcIn0gJHt2YWx1ZX1gIH07XG4gICAgcmV0dXJuIE9iamVjdC5hc3NpZ24oT2JqZWN0LmFzc2lnbihPYmplY3QuYXNzaWduKHt9LCBwYXJhbXMpLCBmaWx0ZXJQYXJhbSksIChhZGRpdGlvbmFsUGFyYW1zICE9PSBudWxsICYmIGFkZGl0aW9uYWxQYXJhbXMgIT09IHZvaWQgMCA/IGFkZGl0aW9uYWxQYXJhbXMgOiB7fSkpO1xuICB9LCBiYXNlUGFyYW1zKTtcbiAgY29uc3QgcGFyYW1zID0gT2JqZWN0LmFzc2lnbih7IG51bSxcbiAgICBzdGFydCxcbiAgICBzb3J0RmllbGQsXG4gICAgc29ydE9yZGVyIH0sIChxdWVyeVBhcmFtcyB8fCB7fSkpO1xuICBjb25zdCBjYXRlZ29yeVBhcmFtID0gY2F0ZWdvcmllcy5sZW5ndGhcbiAgICA/IGNhdGVnb3JpZXMubWFwKChjYXRlZ29yeSkgPT4gYGNhdGVnb3JpZXM9JHtKU09OLnN0cmluZ2lmeShbY2F0ZWdvcnldKX1gKS5qb2luKFwiJlwiKVxuICAgIDogXCJcIjtcbiAgY29uc3QgZGl2aWRlciA9IGNhdGVnb3JpZXMubGVuZ3RoID8gXCI/XCIgOiBcIlwiO1xuICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHJlcXVlc3QoYCR7dXJsfSR7ZGl2aWRlcn0ke2NhdGVnb3J5UGFyYW19YCwgcGFyYW1zLCBvcHRpb25zKTtcbiAgcmV0dXJuIE9iamVjdC5hc3NpZ24oT2JqZWN0LmFzc2lnbih7fSwgcmVzcG9uc2UpLCB7IHF1ZXJ5UGFyYW1zOiBwYXJhbXMgfSk7XG59XG5mdW5jdGlvbiBnZXRHZW9tZXRyeVF1ZXJ5KGdlb21ldHJpZXMsIHBvcnRhbCkge1xuICAvLyBpZiB1bmRlY2xhcmVkIG9yIHdlJ3JlIHVzaW5nIGFsbCBvZiB0aGVtLCBubyBuZWVkIHRvIHF1ZXJ5LFxuICAvLyBhZGRpdGlvbmFsbHksIGVudGVycHJpc2UgZG9lcyBub3Qgc3VwcG9ydCBzdWJsYXllciBpbmRleGluZ1xuICBpZiAoIWdlb21ldHJpZXMgfHwgZ2VvbWV0cmllcy5sZW5ndGggPT09IChkZWZhdWx0R2VvbWV0cmllcyA9PT0gbnVsbCB8fCBkZWZhdWx0R2VvbWV0cmllcyA9PT0gdm9pZCAwID8gdm9pZCAwIDogZGVmYXVsdEdlb21ldHJpZXMubGVuZ3RoKSB8fCAocG9ydGFsID09PSBudWxsIHx8IHBvcnRhbCA9PT0gdm9pZCAwID8gdm9pZCAwIDogcG9ydGFsLmlzUG9ydGFsKSkge1xuICAgIHJldHVybiBcIlwiO1xuICB9XG4gIGNvbnN0IHR5cGVzID0gZ2VvbWV0cmllcy5tYXAoKGdlb21ldHJ5KSA9PiBgXCIke2dlb21ldHJ5fVwiYCkuam9pbihcIiBPUiBcIik7XG4gIHJldHVybiBgKCgtdHlwZWtleXdvcmRzOlwiSG9zdGVkIFNlcnZpY2VcIikgT1IgKHR5cGVrZXl3b3JkczpcIkhvc3RlZCBTZXJ2aWNlXCIgQU5EIGdlb21ldHJ5dHlwZTooJHt0eXBlc30pKSlgO1xufVxuZnVuY3Rpb24gZ2V0SGlnaGxpZ2h0cyhyZXNwb25zZSwgY29uZmlnKSB7XG4gIGlmICghY29uZmlnLmRlZXBMYXllclNlYXJjaEVuYWJsZWQpIHtcbiAgICByZXR1cm4ge307XG4gIH1cbiAgY29uc3QgaGlnaGxpZ2h0cyA9IHt9O1xuICAocmVzcG9uc2UuaGlnaGxpZ2h0cyB8fCBbXSkuZm9yRWFjaCgoaGlnaGxpZ2h0KSA9PiB7XG4gICAgdmFyIF9hO1xuICAgIGNvbnN0IGl0ZW0gPSAoX2EgPSByZXNwb25zZS5yZXN1bHRzKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EuZmluZCgoaXRlbSkgPT4gaXRlbS5pZCA9PT0gaGlnaGxpZ2h0LmlkKTtcbiAgICBpZiAoIShpdGVtID09PSBudWxsIHx8IGl0ZW0gPT09IHZvaWQgMCA/IHZvaWQgMCA6IGl0ZW0uc3VibGF5ZXJzKSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb25zdCBoaWdobGlnaHRlZEZpZWxkcyA9IE9iamVjdC5rZXlzKGhpZ2hsaWdodClcbiAgICAgIC5maWx0ZXIoKGtleSkgPT4ga2V5ICE9PSBcImlkXCIgJiYga2V5LmluY2x1ZGVzKFwic3VibGF5ZXJzLlwiKSlcbiAgICAgIC5yZWR1Y2UoKGFjYywga2V5KSA9PiB7XG4gICAgICBhY2Nba2V5LnJlcGxhY2UoXCJzdWJsYXllcnMuXCIsIFwiXCIpXSA9IGhpZ2hsaWdodFtrZXldLm1hcCgodmFsdWUpID0+IHZhbHVlLnJlcGxhY2VBbGwoXCI8ZW0+XCIsIFwiXCIpLnJlcGxhY2VBbGwoXCI8L2VtPlwiLCBcIlwiKSk7XG4gICAgICByZXR1cm4gYWNjO1xuICAgIH0sIHt9KTtcbiAgICBjb25zdCBzdWJsYXllcnMgPSBpdGVtLnN1YmxheWVyc1xuICAgICAgLmZpbHRlcigoc3VibGF5ZXIpID0+IHtcbiAgICAgIHJldHVybiBPYmplY3Qua2V5cyhzdWJsYXllcikuc29tZSgoa2V5KSA9PiB7XG4gICAgICAgIHZhciBfYTtcbiAgICAgICAgcmV0dXJuIChfYSA9IGhpZ2hsaWdodGVkRmllbGRzW2tleV0pID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5zb21lKCh2YWx1ZSkgPT4gc3VibGF5ZXJba2V5XS5pbmNsdWRlcyh2YWx1ZSkpO1xuICAgICAgfSk7XG4gICAgfSlcbiAgICAgIC5tYXAoKHN1YmxheWVyKSA9PiBzdWJsYXllci5pZCk7XG4gICAgaGlnaGxpZ2h0c1toaWdobGlnaHQuaWRdID0gT2JqZWN0LmFzc2lnbihPYmplY3QuYXNzaWduKHt9LCBoaWdobGlnaHQpLCB7IHN1YmxheWVycyB9KTtcbiAgfSk7XG4gIHJldHVybiBoaWdobGlnaHRzO1xufVxuYXN5bmMgZnVuY3Rpb24gZ2V0TGl2aW5nQXRsYXNHcm91cElkKHBvcnRhbCwgc3RvcmUpIHtcbiAgdmFyIF9hLCBfYjtcbiAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBxdWVyeUdyb3VwcyhcbiAgLy8gV2UgbXVzdCBzZXQgc29ydCBoZXJlIHRvIG1ha2Ugc3VyZSB0aGUgY29ycmVjdCBsaXZpbmcgYXRsYXMgZ3JvdXAgY29tZXMgZmlyc3QgaW4gY2FzZSBvZiBtdWx0aXBsZVxuICB7IHE6IHBvcnRhbC5saXZpbmdBdGxhc0dyb3VwUXVlcnksIG51bTogMSwgc29ydEZpZWxkOiBcInRpdGxlXCIsIHNvcnRPcmRlcjogXCJhc2NcIiB9LCBwb3J0YWwpO1xuICBjb25zdCBpZCA9ICgoX2IgPSAoX2EgPSByZXNwb25zZS5yZXN1bHRzKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2FbMF0pID09PSBudWxsIHx8IF9iID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYi5pZCkgfHwgXCJcIjtcbiAgLy8gVE9ETzogTW92ZSB0byBzZXQgb3V0c2lkZSBmdW5jdGlvbiB0byBhdm9pZCBzaWRlLWVmZmVjdHMgLyBhcmd1bWVudCBtdXRhdGlvbiAmIGNvbWJpbmUgZnVuY3Rpb25zXG4gIGlmIChzdG9yZSkge1xuICAgIHN0b3JlLnN0YXRlLmxpdmluZ0F0bGFzR3JvdXBJZCA9IGlkO1xuICB9XG4gIHJldHVybiBpZDtcbn1cbmFzeW5jIGZ1bmN0aW9uIGdldExpdmluZ0F0bGFzQW5hbHlzaXNHcm91cElkKHBvcnRhbCwgc3RvcmUpIHtcbiAgdmFyIF9hLCBfYjtcbiAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBxdWVyeUdyb3Vwcyh7XG4gICAgcTogZ2V0TGl2aW5nQXRsYXNBbmFseXNpc0dyb3VwUXVlcnkocG9ydGFsKSxcbiAgICBudW06IDEsXG4gICAgc29ydEZpZWxkOiBcInRpdGxlXCIsXG4gICAgc29ydE9yZGVyOiBcImFzY1wiXG4gIH0sIHBvcnRhbCk7XG4gIGNvbnN0IGlkID0gKChfYiA9IChfYSA9IHJlc3BvbnNlLnJlc3VsdHMpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYVswXSkgPT09IG51bGwgfHwgX2IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9iLmlkKSB8fCBcIlwiO1xuICAvLyBUT0RPOiBNb3ZlIHRvIHNldCBvdXRzaWRlIGZ1bmN0aW9uIHRvIGF2b2lkIHNpZGUtZWZmZWN0cyAvIGFyZ3VtZW50IG11dGF0aW9uICYgY29tYmluZSBmdW5jdGlvbnNcbiAgaWYgKHN0b3JlKSB7XG4gICAgc3RvcmUuc3RhdGUubGl2aW5nQXRsYXNBbmFseXNpc0dyb3VwSWQgPSBpZDtcbiAgfVxuICByZXR1cm4gaWQ7XG59XG4vKipcbiAqIEZvcm1hdHMgdGhlIGNvcnJlY3QgYW5hbHlzaXMgbGl2aW5nIGF0bGFzIHF1ZXJ5IGJhc2VkIG9uIHBvcnRhbCBjb25maWd1cmF0aW9uXG4gKiBAcGFyYW0ge1BvcnRhbH0gcG9ydGFsXG4gKiBAcmV0dXJucyB7c3RyaW5nfVxuICovXG5mdW5jdGlvbiBnZXRMaXZpbmdBdGxhc0FuYWx5c2lzR3JvdXBRdWVyeShwb3J0YWwpIHtcbiAgLy8gVXNlIGBlc3JpX2xpdmluZ2F0bGFzYCBpbiBlbnRlcnByaXNlIGFuZCBgZXNyaWAgaW4gb25saW5lXG4gIGNvbnN0IGdyb3VwT3duZXIgPSBwb3J0YWwuaXNQb3J0YWwgPT09IHRydWUgPyBcImVzcmlfbGl2aW5nYXRsYXNcIiA6IFwiZXNyaVwiO1xuICByZXR1cm4gYHRpdGxlOlwiTGl2aW5nIEF0bGFzIEFuYWx5c2lzIExheWVyc1wiIEFORCBvd25lcjoke2dyb3VwT3duZXJ9YDtcbn1cbmFzeW5jIGZ1bmN0aW9uIGdldEJ1Y2tldFF1ZXJ5KHsgYnVja2V0LCB1c2VyLCBwb3J0YWwsIGZpbHRlcnMgfSkge1xuICBzd2l0Y2ggKGJ1Y2tldCkge1xuICAgIGNhc2UgXCJteVwiOlxuICAgICAgcmV0dXJuIGBvd25lcjogJHt1c2VyLnVzZXJuYW1lfWA7XG4gICAgY2FzZSBcIm9yZ1wiOlxuICAgICAgcmV0dXJuIGBvcmdpZDoke3BvcnRhbC5pZH1gO1xuICAgIGNhc2UgXCJmYXZvcml0ZXNcIjpcbiAgICAgIGNvbnN0IGZhdm9yaXRlc0dyb3VwSWQgPSBhd2FpdCBnZXRTaWduZWRJblVzZXJzRmF2b3JpdGVzR3JvdXAoKTtcbiAgICAgIHJldHVybiBgZ3JvdXA6ICR7ZmF2b3JpdGVzR3JvdXBJZH1gO1xuICAgIGNhc2UgXCJncm91cFwiOlxuICAgICAgaWYgKCEoZmlsdGVycyA9PT0gbnVsbCB8fCBmaWx0ZXJzID09PSB2b2lkIDAgPyB2b2lkIDAgOiBmaWx0ZXJzLmdyb3VwKSB8fCAoZmlsdGVycyA9PT0gbnVsbCB8fCBmaWx0ZXJzID09PSB2b2lkIDAgPyB2b2lkIDAgOiBmaWx0ZXJzLmdyb3VwLmdyb3VwKSA9PT0gXCJhbGxcIikge1xuICAgICAgICBjb25zdCBncm91cHMgPSBhd2FpdCBnZXRTaWduZWRJblVzZXJzR3JvdXBzKCk7XG4gICAgICAgIHJldHVybiBgZ3JvdXA6KCR7Z3JvdXBzID09PSBudWxsIHx8IGdyb3VwcyA9PT0gdm9pZCAwID8gdm9pZCAwIDogZ3JvdXBzLm1hcCgoeyBpZCB9KSA9PiBpZCkuam9pbihcIiBPUiBcIil9KWA7XG4gICAgICB9XG4gICAgZGVmYXVsdDpcbiAgICAgIHJldHVybiBcIlwiO1xuICB9XG59XG5hc3luYyBmdW5jdGlvbiBpc1BvcnRhbFZpZXdpbmdBcmNHSVNPbmxpbmUocG9ydGFsLCBidWNrZXQpIHtcbiAgdmFyIF9hO1xuICBpZiAoKHBvcnRhbCA9PT0gbnVsbCB8fCBwb3J0YWwgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHBvcnRhbC5pc1BvcnRhbCkgJiYgYnVja2V0ID09PSBcImFsbFwiKSB7XG4gICAgY29uc3Qgc2V0dGluZ3MgPSBhd2FpdCBnZXRQb3J0YWxTZXR0aW5ncyhwb3J0YWwpO1xuICAgIGlmICgoX2EgPSBzZXR0aW5ncyA9PT0gbnVsbCB8fCBzZXR0aW5ncyA9PT0gdm9pZCAwID8gdm9pZCAwIDogc2V0dGluZ3MucG9ydGFsQ29uZmlnUHJvcGVydGllcykgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLnNlYXJjaEFyY0dJU09ubGluZUVuYWJsZWQpIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgfVxuICByZXR1cm4gZmFsc2U7XG59XG5hc3luYyBmdW5jdGlvbiBnZXRQcm92aXNpb25lZExpc3RpbmdzKHVzZXIsIHBvcnRhbCkge1xuICBpZiAoIXVzZXIgfHwgIXBvcnRhbCkge1xuICAgIHJldHVybiBbXTtcbiAgfVxuICByZXR1cm4gZnJvbUNhY2hlKGFzeW5jICgpID0+IHtcbiAgICBjb25zdCB1cmwgPSBgJHtnZXRSZXN0QmFzZVVybChwb3J0YWwpfWNvbW11bml0eS91c2Vycy8ke3VzZXIudXNlcm5hbWV9L3Byb3Zpc2lvbmVkTGlzdGluZ3NgO1xuICAgIHJldHVybiBmZXRjaEFsbFJlc291cmNlcyh1cmwsIHt9LCBcInByb3Zpc2lvbmVkTGlzdGluZ3NcIik7XG4gIH0sIFwicHJvdmlzaW9uZWRMaXN0aW5nc1wiLCBgJHtwb3J0YWwuaWR9LSR7dXNlci51c2VybmFtZX1gKTtcbn1cbmFzeW5jIGZ1bmN0aW9uIHVud3JhcFJlbGF0ZWRJdGVtcyhpZCkge1xuICB2YXIgX2E7XG4gIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZ2V0UmVsYXRlZEl0ZW1zKGlkLCBcIkxpc3RlZDJJbXBsaWNpdGx5TGlzdGVkXCIsIFwiZm9yd2FyZFwiKTtcbiAgcmV0dXJuIChfYSA9IHJlc3BvbnNlLnJlbGF0ZWRJdGVtcykgIT09IG51bGwgJiYgX2EgIT09IHZvaWQgMCA/IF9hIDogW107XG59XG5mdW5jdGlvbiBmaWx0ZXJTdWJzY3JpcHRpb25Db250ZW50KGl0ZW0sIGFsbG93ZWRTdWJzY3JpcHRpb25Db250ZW50VHlwZXMpIHtcbiAgLy8gYnkgZGVmYXVsdCwgdXNlciB3aWxsIHNlZSBqdXN0IGxheWVycyAodGhlIHNldCB1c2VkIGluIHRoZSBtYXAgdmlld2VyKVxuICBhbGxvd2VkU3Vic2NyaXB0aW9uQ29udGVudFR5cGVzICE9PSBudWxsICYmIGFsbG93ZWRTdWJzY3JpcHRpb25Db250ZW50VHlwZXMgIT09IHZvaWQgMCA/IGFsbG93ZWRTdWJzY3JpcHRpb25Db250ZW50VHlwZXMgOiAoYWxsb3dlZFN1YnNjcmlwdGlvbkNvbnRlbnRUeXBlcyA9IFtcbiAgICBcIk1hcCBTZXJ2aWNlXCIsXG4gICAgXCJJbWFnZSBTZXJ2aWNlXCIsXG4gICAgXCJGZWF0dXJlIFNlcnZpY2VcIixcbiAgICBcIlN0cmVhbSBTZXJ2aWNlXCIsXG4gICAgXCJWZWN0b3IgVGlsZSBTZXJ2aWNlXCIsXG4gICAgXCJXTVNcIixcbiAgICBcIldGU1wiLFxuICAgIFwiV01UU1wiLFxuICAgIFwiS01MXCIsXG4gICAgXCJGZWF0dXJlIENvbGxlY3Rpb25cIixcbiAgICBcIkZlZWRcIlxuICBdKTtcbiAgcmV0dXJuIGFsbG93ZWRTdWJzY3JpcHRpb25Db250ZW50VHlwZXMuaW5jbHVkZXMoaXRlbS50eXBlKTtcbn1cbmFzeW5jIGZ1bmN0aW9uIGdldFN1YnNjcmlwdGlvbkNvbnRlbnQocG9ydGFsLCB1c2VyLCBhbGxvd2VkSXRlbVR5cGVzKSB7XG4gIHJldHVybiBmcm9tQ2FjaGUoYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IGxpc3RpbmdzID0gYXdhaXQgZ2V0UHJvdmlzaW9uZWRMaXN0aW5ncyh1c2VyLCBwb3J0YWwpO1xuICAgIGlmICghKGxpc3RpbmdzID09PSBudWxsIHx8IGxpc3RpbmdzID09PSB2b2lkIDAgPyB2b2lkIDAgOiBsaXN0aW5ncy5sZW5ndGgpKSB7XG4gICAgICByZXR1cm4geyB0b3RhbDogMCwgcmVzdWx0czogW10sIHN0YXJ0OiAtMSwgbnVtOiAxMDAsIG5leHRTdGFydDogMCB9O1xuICAgIH1cbiAgICBjb25zdCBpZHMgPSBsaXN0aW5ncyA9PT0gbnVsbCB8fCBsaXN0aW5ncyA9PT0gdm9pZCAwID8gdm9pZCAwIDogbGlzdGluZ3MubWFwKChsaXN0aW5nKSA9PiBsaXN0aW5nLml0ZW1JZCk7XG4gICAgY29uc3QgaXRlbXMgPSBhd2FpdCBQcm9taXNlLmFsbChpZHMubWFwKChpZCkgPT4gZ2V0SXRlbShpZCwgcG9ydGFsKSkpO1xuICAgIGNvbnN0IHJlbGF0ZWRJdGVtc0FycmF5cyA9IGF3YWl0IFByb21pc2UuYWxsKGlkcyA9PT0gbnVsbCB8fCBpZHMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGlkcy5tYXAodW53cmFwUmVsYXRlZEl0ZW1zKSk7XG4gICAgY29uc3QgYWxsSXRlbXMgPSByZWxhdGVkSXRlbXNBcnJheXNcbiAgICAgIC5yZWR1Y2UoKGFsbCwgcmVsYXRlZEl0ZW1zKSA9PiB7XG4gICAgICByZXR1cm4gYWxsLmNvbmNhdChyZWxhdGVkSXRlbXMpO1xuICAgIH0sIGl0ZW1zKVxuICAgICAgLmZpbHRlcigoaXRlbSkgPT4gZmlsdGVyU3Vic2NyaXB0aW9uQ29udGVudChpdGVtLCBhbGxvd2VkSXRlbVR5cGVzKSk7XG4gICAgcmV0dXJuIHtcbiAgICAgIHRvdGFsOiBhbGxJdGVtcy5sZW5ndGgsXG4gICAgICByZXN1bHRzOiBhbGxJdGVtcyxcbiAgICAgIHN0YXJ0OiBhbGxJdGVtcy5sZW5ndGggPyAxIDogMCxcbiAgICAgIG51bTogMTAwLFxuICAgICAgbmV4dFN0YXJ0OiAwXG4gICAgfTtcbiAgfSwgXCJzdWJzY3JpcHRpb25Db250ZW50XCIsIGAke3BvcnRhbC5pZH0tJHt1c2VyLnVzZXJuYW1lfWApO1xufVxuYXN5bmMgZnVuY3Rpb24gZmV0Y2hQcmV2aWV3SXRlbShpdGVtLCBwb3J0YWwsIHVzZXIsIHN0b3JlKSB7XG4gIHZhciBfYTtcbiAgY29uc3QgcG9ydGFsVG9PbmxpbmUgPSBhd2FpdCBpc1BvcnRhbFZpZXdpbmdBcmNHSVNPbmxpbmUocG9ydGFsLCBzdG9yZS5zdGF0ZS5idWNrZXQpO1xuICBjb25zdCB1cmwgPSBwb3J0YWxUb09ubGluZVxuICAgID8gYGh0dHBzOi8vd3d3LmFyY2dpcy5jb20vc2hhcmluZy9yZXN0L2NvbnRlbnQvaXRlbXMvJHtpdGVtLmlkfWBcbiAgICA6IGdldEl0ZW1VcmwoaXRlbS5pZCwgcG9ydGFsKTtcbiAgY29uc3Qgb3B0aW9ucyA9IHBvcnRhbFRvT25saW5lIHx8ICF1c2VyID8geyBkaXNhYmxlSWRlbnRpdHlMb29rdXA6IHRydWUsIGFkZFRva2VuTWFudWFsbHk6IGZhbHNlIH0gOiB7fTtcbiAgdHJ5IHtcbiAgICByZXR1cm4geyByZXN1bHQ6IGF3YWl0IHJlcXVlc3QodXJsLCB7fSwgb3B0aW9ucykgfTtcbiAgfVxuICBjYXRjaCAoZXJyb3IpIHtcbiAgICBpZiAoKChfYSA9IGVycm9yID09PSBudWxsIHx8IGVycm9yID09PSB2b2lkIDAgPyB2b2lkIDAgOiBlcnJvci5kZXRhaWxzKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EubWVzc2FnZUNvZGUpID09PSBcIlNCXzAwMDVcIikge1xuICAgICAgcmV0dXJuIHsgZXJyb3I6IHsgY29kZTogXCJkaXNhYmxlZFN1YnNjcmlwdGlvblwiIH0gfTtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIHsgZXJyb3I6IHsgY29kZTogXCJ1bmhhbmRsZWRFcnJvclwiIH0gfTtcbn1cblxuZXhwb3J0IHsgSElEREVOX0lURU1TX1FVRVJZIGFzIEgsIGdldEhpZ2hsaWdodHMgYXMgYSwgZ2V0UHJvdmlzaW9uZWRMaXN0aW5ncyBhcyBiLCBjbGVhblNlYXJjaFRlcm0gYXMgYywgZGVmYXVsdEdlb21ldHJpZXMgYXMgZCwgZmV0Y2hQcmV2aWV3SXRlbSBhcyBmLCBnZXRUYWdzIGFzIGcsIGlzUG9ydGFsVmlld2luZ0FyY0dJU09ubGluZSBhcyBpLCBxdWVyeUl0ZW1zIGFzIHEgfTtcbiIsIi8qIVxuICogQWxsIG1hdGVyaWFsIGNvcHlyaWdodCBFU1JJLCBBbGwgUmlnaHRzIFJlc2VydmVkLCB1bmxlc3Mgb3RoZXJ3aXNlIHNwZWNpZmllZC5cbiAqIHYzLjAuOTlcbiAqL1xuaW1wb3J0IHsgZiBhcyBmcm9tQ2FjaGUsIHIgYXMgcmVxdWVzdCwgZyBhcyBnZXRSZXN0QmFzZVVybCB9IGZyb20gJy4vcG9ydGFsLTc5Y2FhZWZmLmpzJztcbmltcG9ydCB7IGMgYXMgY29uZmlnU3RhdGUgfSBmcm9tICcuL2NvbmZpZy1lYjVmN2RjMi5qcyc7XG5cbmFzeW5jIGZ1bmN0aW9uIGZldGNoVXNlcih1c2VybmFtZSwgcG9ydGFsKSB7XG4gIHJldHVybiByZXF1ZXN0KGAke2dldFJlc3RCYXNlVXJsKHBvcnRhbCl9L2NvbW11bml0eS91c2Vycy8ke3VzZXJuYW1lfWApO1xufVxuYXN5bmMgZnVuY3Rpb24gZmV0Y2hTZWxmKCkge1xuICByZXR1cm4gcmVxdWVzdChgJHtnZXRSZXN0QmFzZVVybCgpfS9jb21tdW5pdHkvc2VsZmApO1xufVxuYXN5bmMgZnVuY3Rpb24gZ2V0U2lnbmVkSW5Vc2Vyc0dyb3VwcygpIHtcbiAgdmFyIF9hO1xuICBjb25zdCB1c2VyID0gY29uZmlnU3RhdGUgPT09IG51bGwgfHwgY29uZmlnU3RhdGUgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGNvbmZpZ1N0YXRlLnVzZXI7XG4gIGlmICghdXNlcikge1xuICAgIHJldHVybiBbXTtcbiAgfVxuICBjb25zdCBzZWxmID0gYXdhaXQgZnJvbUNhY2hlKCgpID0+IGZldGNoU2VsZigpLCBcImNvbW11bml0eVNlbGZcIiwgdXNlci51c2VybmFtZSk7XG4gIHJldHVybiAoX2EgPSBzZWxmID09PSBudWxsIHx8IHNlbGYgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHNlbGYuZ3JvdXBzKSAhPT0gbnVsbCAmJiBfYSAhPT0gdm9pZCAwID8gX2EgOiBbXTtcbn1cbmFzeW5jIGZ1bmN0aW9uIGdldFNpZ25lZEluVXNlcnNGYXZvcml0ZXNHcm91cCgpIHtcbiAgY29uc3QgdXNlciA9IGNvbmZpZ1N0YXRlID09PSBudWxsIHx8IGNvbmZpZ1N0YXRlID09PSB2b2lkIDAgPyB2b2lkIDAgOiBjb25maWdTdGF0ZS51c2VyO1xuICBpZiAoIXVzZXIpIHtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuICBjb25zdCBzZWxmID0gYXdhaXQgZnJvbUNhY2hlKCgpID0+IGZldGNoU2VsZigpLCBcImNvbW11bml0eVNlbGZcIiwgdXNlci51c2VybmFtZSk7XG4gIHJldHVybiBzZWxmLmZhdkdyb3VwSWQ7XG59XG5hc3luYyBmdW5jdGlvbiBnZXRVc2VyQ29udGVudChwb3J0YWxVc2VyKSB7XG4gIHZhciBfYSwgX2I7XG4gIGNvbnN0IHVzZXIgPSAoX2EgPSBwb3J0YWxVc2VyICE9PSBudWxsICYmIHBvcnRhbFVzZXIgIT09IHZvaWQgMCA/IHBvcnRhbFVzZXIgOiBjb25maWdTdGF0ZS51c2VyKSAhPT0gbnVsbCAmJiBfYSAhPT0gdm9pZCAwID8gX2EgOiBjb25maWdTdGF0ZS5wb3J0YWwudXNlcjtcbiAgY29uc3QgcG9ydGFsID0gY29uZmlnU3RhdGUucG9ydGFsO1xuICAoX2IgPSB1c2VyLnVzZXJDb250ZW50VXJsKSAhPT0gbnVsbCAmJiBfYiAhPT0gdm9pZCAwID8gX2IgOiAodXNlci51c2VyQ29udGVudFVybCA9IChwb3J0YWwgPT09IG51bGwgfHwgcG9ydGFsID09PSB2b2lkIDAgPyB2b2lkIDAgOiBwb3J0YWwucmVzdFVybCkgKyBcIi9jb250ZW50L3VzZXJzL1wiICsgcG9ydGFsVXNlci51c2VybmFtZSk7XG4gIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgcmVxdWVzdCh1c2VyLnVzZXJDb250ZW50VXJsLCB7IG51bTogMSB9KTtcbiAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShyZXNwb25zZSk7XG59XG5hc3luYyBmdW5jdGlvbiBnZXRGb2xkZXJzKHBvcnRhbFVzZXIpIHtcbiAgdmFyIF9hO1xuICBjb25zdCB1c2VyID0gKF9hID0gcG9ydGFsVXNlciAhPT0gbnVsbCAmJiBwb3J0YWxVc2VyICE9PSB2b2lkIDAgPyBwb3J0YWxVc2VyIDogY29uZmlnU3RhdGUudXNlcikgIT09IG51bGwgJiYgX2EgIT09IHZvaWQgMCA/IF9hIDogY29uZmlnU3RhdGUucG9ydGFsLnVzZXI7XG4gIGNvbnN0IHsgZm9sZGVycyB9ID0gYXdhaXQgZ2V0VXNlckNvbnRlbnQodXNlcik7XG4gIGNvbnN0IHsgdXNlcm5hbWUgfSA9IHVzZXI7XG4gIC8vIGFkZCB0aGUgaG9tZSBmb2xkZXIgYXMgaWYgaXQncyBpbiB0aGUgbGlzdFxuICByZXR1cm4gW3sgdXNlcm5hbWUsIGlkOiB1c2VybmFtZSwgdGl0bGU6IHVzZXJuYW1lLCBjcmVhdGVkOiBcIm5vd1wiIH0sIC4uLmZvbGRlcnNdO1xufVxuYXN5bmMgZnVuY3Rpb24gZ2V0Rm9sZGVyRnJvbUlkKGZvbGRlcklkLCBwb3J0YWxVc2VyKSB7XG4gIHZhciBfYTtcbiAgY29uc3QgdXNlciA9IChfYSA9IHBvcnRhbFVzZXIgIT09IG51bGwgJiYgcG9ydGFsVXNlciAhPT0gdm9pZCAwID8gcG9ydGFsVXNlciA6IGNvbmZpZ1N0YXRlLnVzZXIpICE9PSBudWxsICYmIF9hICE9PSB2b2lkIDAgPyBfYSA6IGNvbmZpZ1N0YXRlLnBvcnRhbC51c2VyO1xuICBjb25zdCBmb2xkZXJzID0gYXdhaXQgZ2V0Rm9sZGVycyh1c2VyKTtcbiAgcmV0dXJuIGZvbGRlcnMuZmluZCgoZm9sZGVyKSA9PiBmb2xkZXIuaWQgPT09IGZvbGRlcklkKTtcbn1cbmZ1bmN0aW9uIGdldEhvbWVGb2xkZXJGb3JVc2VyKHVzZXJuYW1lKSB7XG4gIHJldHVybiB7IHVzZXJuYW1lLCBpZDogdXNlcm5hbWUsIHRpdGxlOiB1c2VybmFtZSwgY3JlYXRlZDogXCJub3dcIiB9O1xufVxuYXN5bmMgZnVuY3Rpb24gY3JlYXRlRm9sZGVyKGZvbGRlck5hbWUsIHBvcnRhbFVzZXIpIHtcbiAgdmFyIF9hO1xuICBjb25zdCB1c2VyID0gKF9hID0gcG9ydGFsVXNlciAhPT0gbnVsbCAmJiBwb3J0YWxVc2VyICE9PSB2b2lkIDAgPyBwb3J0YWxVc2VyIDogY29uZmlnU3RhdGUudXNlcikgIT09IG51bGwgJiYgX2EgIT09IHZvaWQgMCA/IF9hIDogY29uZmlnU3RhdGUucG9ydGFsLnVzZXI7XG4gIGNvbnN0IHVybCA9IGAke3VzZXIudXNlckNvbnRlbnRVcmx9L2NyZWF0ZUZvbGRlcmA7XG4gIGNvbnN0IGZvbGRlclJlc3BvbnNlID0gYXdhaXQgcmVxdWVzdCh1cmwsIHsgdGl0bGU6IGZvbGRlck5hbWUgfSwge30sIFwicG9zdFwiKTtcbiAgcmV0dXJuIGZvbGRlclJlc3BvbnNlO1xufVxuXG5leHBvcnQgeyBnZXRTaWduZWRJblVzZXJzR3JvdXBzIGFzIGEsIGdldFNpZ25lZEluVXNlcnNGYXZvcml0ZXNHcm91cCBhcyBiLCBjcmVhdGVGb2xkZXIgYXMgYywgZ2V0Rm9sZGVyRnJvbUlkIGFzIGQsIGdldEhvbWVGb2xkZXJGb3JVc2VyIGFzIGUsIGZldGNoVXNlciBhcyBmLCBnZXRGb2xkZXJzIGFzIGcgfTtcbiJdLCJuYW1lcyI6W10sInNvdXJjZVJvb3QiOiIifQ==
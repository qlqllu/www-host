"use strict";
(self["webpackChunkexb_client"] = self["webpackChunkexb_client"] || []).push([["vendors-extensions_widgets_arcgis_analysis_node_modules_arcgis_app-components_dist_esm_arcgis-ad0b4c"],{

/***/ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/arcgis-popup_13.entry.js":
/*!******************************************************************************************************************!*\
  !*** ./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/arcgis-popup_13.entry.js ***!
  \******************************************************************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   arcgis_popup: () => (/* binding */ ArcgisPopup),
/* harmony export */   arcgis_popup_arcade: () => (/* binding */ ArcgisPopupArcade),
/* harmony export */   arcgis_popup_attachments: () => (/* binding */ ArcgisPopupAttachments),
/* harmony export */   arcgis_popup_attributes: () => (/* binding */ ArcgisPopupAttributes),
/* harmony export */   arcgis_popup_chart: () => (/* binding */ ArcgisPopupChart),
/* harmony export */   arcgis_popup_expressions: () => (/* binding */ ArcgisPopupExpressions),
/* harmony export */   arcgis_popup_field_pick_list: () => (/* binding */ ArcgisPopupFieldPickList),
/* harmony export */   arcgis_popup_image: () => (/* binding */ ArcgisPopupImage),
/* harmony export */   arcgis_popup_main_contentpopover: () => (/* binding */ ArcgisPopupMainContentpopover),
/* harmony export */   arcgis_popup_multimedia: () => (/* binding */ ArcgisPopupMultimedia),
/* harmony export */   arcgis_popup_relationship: () => (/* binding */ ArcgisPopupRelationship),
/* harmony export */   arcgis_popup_richtext: () => (/* binding */ ArcgisPopupRichtext),
/* harmony export */   arcgis_popup_title: () => (/* binding */ ArcgisPopupTitle)
/* harmony export */ });
/* harmony import */ var _index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./index-92ebb396.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/index-92ebb396.js");
/* harmony import */ var _locale_13e00a75_js__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./locale-13e00a75.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/locale-13e00a75.js");
/* harmony import */ var _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./commonEnums-f98a323c.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/commonEnums-f98a323c.js");
/* harmony import */ var _commonFunctions_5262b094_js__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ./commonFunctions-5262b094.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/commonFunctions-5262b094.js");
/* harmony import */ var _loadModules_aaf30bd6_js__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ./loadModules-aaf30bd6.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/loadModules-aaf30bd6.js");
/* harmony import */ var _guid_4f4176ba_js__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! ./guid-4f4176ba.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/guid-4f4176ba.js");
/* harmony import */ var _previewPopup_05f5d196_js__WEBPACK_IMPORTED_MODULE_6__ = __webpack_require__(/*! ./previewPopup-05f5d196.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/previewPopup-05f5d196.js");
/* harmony import */ var _languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_7__ = __webpack_require__(/*! ./languageUtil-22258c90.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/languageUtil-22258c90.js");
/* harmony import */ var _functional_c82f5ab9_js__WEBPACK_IMPORTED_MODULE_8__ = __webpack_require__(/*! ./functional-c82f5ab9.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/functional-c82f5ab9.js");
/* harmony import */ var _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__ = __webpack_require__(/*! ./popupStore-a5d93b58.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/popupStore-a5d93b58.js");
/* harmony import */ var _dom_13f5b00c_js__WEBPACK_IMPORTED_MODULE_10__ = __webpack_require__(/*! ./dom-13f5b00c.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/dom-13f5b00c.js");
/* harmony import */ var _index_81d548b7_js__WEBPACK_IMPORTED_MODULE_11__ = __webpack_require__(/*! ./index-81d548b7.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/index-81d548b7.js");
/*!
 * All material copyright ESRI, All Rights Reserved, unless otherwise specified.
 * v3.0.99
 */













const CSS$6 = {
  enablePopup: "enable-popup",
  componentDiv: "component-ul",
  summaryET: "summary-et",
  summaryETLabel: "summary-et-label",
  summaryETAction: "summary-et-action",
  imageryOptions: "imagery-options",
  notice: "notice"
};

// add field at cursor if position is available
const addSelectedFieldAtCursor = (inputElement, selectedFieldName) => {
  var _a, _b;
  const position = (_b = (_a = inputElement === null || inputElement === void 0 ? void 0 : inputElement.shadowRoot) === null || _a === void 0 ? void 0 : _a.querySelector("input")) === null || _b === void 0 ? void 0 : _b.selectionStart;
  if (isDefined(position)) {
    return [inputElement.value.slice(0, position), `{${selectedFieldName}}`, inputElement.value.slice(position)].join("");
  }
  else {
    return `${inputElement.value}{${selectedFieldName}}`;
  }
};
const isDefined = (value) => {
  return value !== undefined && value !== null;
};
const layerHasRelatedRecords = async (layer, view, serviceType) => {
  var _a, _b, _c, _d, _e;
  const supportsCount = (_b = (_a = layer.capabilities) === null || _a === void 0 ? void 0 : _a.queryRelated) === null || _b === void 0 ? void 0 : _b.supportsCount;
  const supportsPagination = (_d = (_c = layer.capabilities) === null || _c === void 0 ? void 0 : _c.queryRelated) === null || _d === void 0 ? void 0 : _d.supportsPagination;
  if ([_commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.s.feature, _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.s.scene].indexOf(serviceType) > -1 &&
    ((_e = layer === null || layer === void 0 ? void 0 : layer.relationships) === null || _e === void 0 ? void 0 : _e.length) &&
    supportsCount &&
    supportsPagination) {
    for (const relationship of layer.relationships) {
      // check table and layers, including group layers in map view
      // return true if any related layer/table is found in the map
      for (const currLayerOrTable of [...view.map.allLayers, ...view.map.allTables]) {
        const curr = currLayerOrTable;
        if (await relationshipExists(layer, curr, relationship)) {
          await curr.load();
          return Promise.resolve(true);
        }
      }
    }
  }
  return Promise.resolve(false);
};
const getDefaultRelationshipAndLayer = async (layer, view, serviceType) => {
  var _a;
  if ([_commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.s.feature, _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.s.scene].indexOf(serviceType) > -1 && ((_a = layer === null || layer === void 0 ? void 0 : layer.relationships) === null || _a === void 0 ? void 0 : _a.length)) {
    for (const relationship of layer.relationships) {
      // check table and layers, including group layers in map view
      for (const currLayerOrTable of [...view.map.allLayers, ...view.map.allTables]) {
        const curr = currLayerOrTable;
        // by default setup relationships based on the 1st layer/table found
        if (await relationshipExists(layer, curr, relationship)) {
          await curr.load();
          return { relationship: relationship, currLayer: curr };
        }
      }
    }
  }
};
function trimServerFromUrl(layer) {
  if (layer.type === "feature" && layer.url.toLocaleLowerCase().endsWith("/featureserver")) {
    return layer.url.substring(0, layer.url.length - 14);
  }
  else if (layer.type === "scene" && layer.url.toLocaleLowerCase().endsWith("/sceneserver")) {
    return layer.url.substring(0, layer.url.length - 12);
  }
  return layer.url;
}
async function relationshipExists(layer, relatedLayer, relationship) {
  var _a, _b, _c;
  const sameParent = relatedLayer.url
    ? relatedLayer.url === layer.url || trimServerFromUrl(relatedLayer) === trimServerFromUrl(layer)
    : "type" in relatedLayer.parent &&
      relatedLayer.parent.type === "group" &&
      ((_b = (_a = relatedLayer.parent) === null || _a === void 0 ? void 0 : _a.portalItem) === null || _b === void 0 ? void 0 : _b.id) === ((_c = layer.portalItem) === null || _c === void 0 ? void 0 : _c.id);
  if (["feature", "scene"].indexOf(relatedLayer.type) > -1 && sameParent && !isDefined(relatedLayer.layerId)) {
    // happens in SV
    await relatedLayer.load();
  }
  return Promise.resolve(["feature", "scene"].indexOf(relatedLayer.type) > -1 &&
    sameParent &&
    relatedLayer.layerId === relationship.relatedTableId);
}
function relationshipExistsCheckWithoutLoad(layer, relatedLayer, relationship) {
  var _a, _b, _c;
  const sameParent = relatedLayer.url
    ? relatedLayer.url === layer.url || trimServerFromUrl(relatedLayer) === trimServerFromUrl(layer)
    : "type" in relatedLayer.parent &&
      relatedLayer.parent.type === "group" &&
      ((_b = (_a = relatedLayer.parent) === null || _a === void 0 ? void 0 : _a.portalItem) === null || _b === void 0 ? void 0 : _b.id) === ((_c = layer.portalItem) === null || _c === void 0 ? void 0 : _c.id);
  return (["feature", "scene"].indexOf(relatedLayer.type) > -1 &&
    sameParent &&
    relatedLayer.layerId === relationship.relatedTableId);
}

var ContentSelection;
(function (ContentSelection) {
  ContentSelection["attributes"] = "attributes";
  ContentSelection["attachments"] = "attachments";
  ContentSelection["charts"] = "charts";
  ContentSelection["images"] = "images";
  ContentSelection["richText"] = "richText";
  ContentSelection["summaryET"] = "summaryET";
  ContentSelection["arcade"] = "arcade";
  ContentSelection["relationship"] = "relationship";
})(ContentSelection || (ContentSelection = {}));
var PopupMultiMediaType;
(function (PopupMultiMediaType) {
  PopupMultiMediaType["image"] = "image";
  PopupMultiMediaType["barChart"] = "bar-chart";
  PopupMultiMediaType["columnChart"] = "column-chart";
  PopupMultiMediaType["lineChart"] = "line-chart";
  PopupMultiMediaType["pieChart"] = "pie-chart";
})(PopupMultiMediaType || (PopupMultiMediaType = {}));
var AttachmentDisplayType;
(function (AttachmentDisplayType) {
  AttachmentDisplayType["preview"] = "preview";
  AttachmentDisplayType["list"] = "list";
  AttachmentDisplayType["auto"] = "auto";
})(AttachmentDisplayType || (AttachmentDisplayType = {}));

const getArcadeScript = (expression, layerDisplayType, strings) => {
  if (expression) {
    return expression;
  }
  if (layerDisplayType === _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.l.cluster) {
    return defaultClusterPopupScript(strings);
  }
  return defaultPopupScript(strings);
};
const getArcadeProfile = async (layer, mapView, serviceType, popupTemplate, layerDisplayType) => {
  if (layerDisplayType === _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.l.cluster) {
    return {
      id: "popup-feature-reduction",
      definitions: {
        $feature: { fields: (0,_commonFunctions_5262b094_js__WEBPACK_IMPORTED_MODULE_3__.k)(popupTemplate, false) },
        $aggregatedFeatures: await getAggregatedFeatureSet(mapView, layer, popupTemplate)
      }
    };
  }
  return Object.assign(Object.assign({ id: "popup" }, ((serviceType === _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.s.csv ||
    serviceType === _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.s.geojson ||
    serviceType === _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.s.mapImage ||
    serviceType === _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.s.tile) && {
    disabledVariables: ["$layer", "$map", "$datastore"]
  })), { definitions: {
      $feature: layer,
      $layer: layer,
      $map: mapView.map,
      $datastore: layer
    } });
};
const getTestData = async (layer, mapView, layerDisplayType, popupTemplate) => {
  try {
    if (layerDisplayType === _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.l.cluster) {
      return {
        profileVariableInstances: {
          $feature: await (0,_commonFunctions_5262b094_js__WEBPACK_IMPORTED_MODULE_3__.l)(mapView, layer, popupTemplate),
          $aggregatedFeatures: await getAggregatedFeatureSet(mapView, layer, popupTemplate)
        },
        spatialReference: mapView.spatialReference,
        timeZone: mapView.timeZone
      };
    }
    return {
      profileVariableInstances: {
        $feature: (await (0,_commonFunctions_5262b094_js__WEBPACK_IMPORTED_MODULE_3__.m)(layer, mapView)).features[0],
        $layer: layer,
        $map: mapView.map,
        $datastore: layer.url
      },
      spatialReference: mapView.spatialReference,
      timeZone: mapView.timeZone
    };
  }
  catch (error) {
    console.log(error);
  }
};
const getTemplates = (strings) => {
  return [
    {
      label: strings.templates,
      suggestions: [
        {
          label: strings.chartTemplate,
          code: chartTemplate()
        },
        {
          label: strings.fieldsListTemplate,
          code: fieldTemplate()
        },
        {
          label: strings.richText,
          code: richTextTemplate()
        }
      ]
    }
  ];
};
const getAggregatedFeatureSet = async (mapView, layer, popupTemplate) => {
  const layerView = await mapView.whenLayerView(layer);
  const q = layerView.createQuery();
  q.aggregateIds = [(await (0,_commonFunctions_5262b094_js__WEBPACK_IMPORTED_MODULE_3__.l)(mapView, layer, popupTemplate)).getObjectId()];
  return layerView.queryFeatures(q);
};
const defaultPopupScript = (strings) => {
  return `// ${strings.arcadeScriptLine1} \n// ${strings.arcadeScriptLine2}\n// Average($feature.SalesQ1, $feature.SalesQ2, $feature.SalesQ3, $feature.SalesQ4)\n`;
};
const defaultClusterPopupScript = (strings) => {
  return `// ${strings.clusterArcadeScriptLine3} \nExpects($aggregatedFeatures, "field1", "field2")\n\n// ${strings.clusterArcadeScriptLine1} \n// ${strings.clusterArcadeScriptLine2}\n// Count(Filter($aggregatedFeatures, "field1 = 'value'"))\n`;
};
const defaultContentMessage = (layerDisplayType, strings) => {
  const clusterMessage = `// ${strings.arcadeContentClusterScriptLine} \nExpects($aggregatedFeatures, "field1", "field2")\n\n`;
  const defaultMessage = `/* \n${strings.arcadeContentScriptLine1} \n${strings.arcadeContentScriptLine2} \nhttps://developers.arcgis.com/arcade/guide/profiles/#popup-element \n*/\n\n${richTextTemplate()}`;
  return layerDisplayType === _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.l.cluster ? clusterMessage + defaultMessage : defaultMessage;
};
const richTextTemplate = () => {
  return `return { \n\ttype : 'text', \n\ttext : 'place your text or html here' //this property supports html tags \n}`;
};
const fieldTemplate = () => {
  return `return {
    type: 'fields',
    //title: '',
    //description : '',
    fieldInfos:  [{
          fieldName: "att1"  // fieldName should match the key in the attributes dictionary
        },
        {
          fieldName: "att2"  // fieldName should match the key in the attributes dictionary
        },
        {
          fieldName: "att3"  // fieldName should match the key in the attributes dictionary
        }],
    attributes : {att1 : 2, att2 : 3, att3 : 4}  // replace this dictionary with your own key-value pairs
  }`;
};
const chartTemplate = () => {
  return `return {
    type: 'media',
    // title : 'The title for all media in the element',
    // description : '',
    attributes : {att1 : 2, att2 : 3, att3 : 4},  // replace this dictionary with your own key-value pairs,
    mediaInfos: [{
        type : 'piechart', //linechart | barchart | piechart | columnchart
        title : 'give your chart a title',
        // caption : '',
        altText : '', //altText will be read by screen readers
        value : {
          fields: ["att1", "att2", "att3"],  // choose what attributes to use in the chart
          /* colors: [  // values must be an array of [r, g, b, a] values (0-255)
            [122, 190, 229, 255],
            [179, 155, 213, 255],
            [248, 174, 131, 255]
          ], */
          //normalizeField : '',  // the name of the attribute to normalize by or value
        }
      }]
  }`;
};
const getClusterFieldInfos = (popupTemplate, FieldInfo) => {
  var _a;
  const clusterFieldInfos = [];
  // remove expressions
  popupTemplate.fieldInfos.forEach((fieldInfo) => {
    if (!fieldInfo.fieldName.includes(_commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.f.expression)) {
      clusterFieldInfos.push(fieldInfo);
    }
  });
  // add potential new and existing expressions
  (_a = popupTemplate.expressionInfos) === null || _a === void 0 ? void 0 : _a.forEach(async (expressionInfo) => {
    const tempFieldInfo = new FieldInfo();
    tempFieldInfo.fieldName = `${_commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.f.expression}${expressionInfo.name}`;
    tempFieldInfo.visible = false;
    clusterFieldInfos.push(tempFieldInfo);
  });
  return clusterFieldInfos;
};
const getExpressioName = (popupTemplate, arcadeFieldName) => {
  var _a;
  if (arcadeFieldName) {
    return arcadeFieldName;
  }
  else {
    if ((_a = popupTemplate.expressionInfos) === null || _a === void 0 ? void 0 : _a.length) {
      const tempExp = popupTemplate.expressionInfos[popupTemplate.expressionInfos.length - 1];
      const matches = tempExp.name.match(/\d+$/);
      if (matches === null || matches === void 0 ? void 0 : matches[0]) {
        return `expr${Number(matches[0]) + 1}`;
      }
      else {
        return `expr${popupTemplate.expressionInfos.length}`;
      }
    }
    else {
      return "expr0";
    }
  }
};
const setExpressionInfoInPopupTemplate = (objectArcadeEditor, currentArcadeFieldName, PopupExpressionInfo, popupTemplate) => {
  const tempCurrentArcadeFieldName = currentArcadeFieldName;
  const tempExp = new PopupExpressionInfo();
  tempExp.expression = objectArcadeEditor.script;
  tempExp.title = objectArcadeEditor.title;
  tempExp.name = getExpressioName(popupTemplate, tempCurrentArcadeFieldName);
  tempExp.returnType = objectArcadeEditor.predictOutputType === "number" ? "number" : "string";
  if (popupTemplate.expressionInfos) {
    if (tempCurrentArcadeFieldName) {
      popupTemplate.expressionInfos.find((exp, index) => {
        if (exp.name === tempCurrentArcadeFieldName) {
          popupTemplate.expressionInfos[index] = tempExp;
        }
      });
    }
    else {
      popupTemplate.expressionInfos.push(tempExp);
    }
  }
  else {
    popupTemplate.expressionInfos = [tempExp];
  }
  return tempExp;
};
const setLayerExpressionAndFieldInfo = async (popupTemplate, layerDisplayType, layer, FieldInfo) => {
  if (layerDisplayType === _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.l.cluster) {
    layer.featureReduction.popupTemplate.expressionInfos =
      [...popupTemplate.expressionInfos];
    popupTemplate.fieldInfos = getClusterFieldInfos(popupTemplate, FieldInfo);
  }
  else {
    layer.popupTemplate.expressionInfos = [...popupTemplate.expressionInfos];
    popupTemplate.fieldInfos = [...(await (0,_previewPopup_05f5d196_js__WEBPACK_IMPORTED_MODULE_6__.g)(layer, popupTemplate))];
  }
};

const arcgisPopupCss = ".enable-popup{background-color:var(--arcgis-app-background);display:flex;padding:var(--arcgis-app-cap-spacing) var(--arcgis-app-cap-spacing-half) var(--arcgis-app-cap-spacing-quarter);border-bottom:solid 1px var(--arcgis-app-border)}.component-ul{margin:0 0 var(--arcgis-app-cap-spacing);padding:0}.summary-et{display:flex;align-items:center;padding:0% var(--arcgis-app-cap-spacing-three-quarters)}.summary-et-label{display:flex;flex-flow:column nowrap;flex:1 0 0%;overflow:hidden;padding:0% var(--arcgis-app-cap-spacing-half);font-size:medium}.summary-et-action{margin:0;flex:0 0 0%;justify-self:flex-end}.notice{margin:0.5rem}.imagery-options{padding:0 var(--arcgis-app-cap-spacing-three-quarters)}";

const ArcgisPopup = class {
  constructor(hostRef) {
    (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.r)(this, hostRef);
    this.popupUpdated = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "popupUpdated", 7);
    this.arcgisPopupDismissedChange = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "arcgisPopupDismissedChange", 7);
    this.internalPopupUpdated = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "internalPopupUpdated", 7);
    this.closePopupPopovers = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "closePopupPopovers", 7);
    this.resetMultiMediaIndex = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "resetMultiMediaIndex", 7);
    this.mainPopupReRender = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "mainPopupReRender", 7);
    this.disablePopupPanel = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "disablePopupPanel", 7);
    this.closeAttributePopovers = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "closeAttributePopovers", 7);
    this.attributesChangeNotification = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "attributesChangeNotification", 7);
    this.arcadeChangeNotification = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "arcadeChangeNotification", 7);
    this.attributeData = [];
    this.fieldData = [];
    this.richTextElements = [];
    this.popupHasAttachment = false;
    this.layerHasAttributes = true;
    this.layerHasCharts = true;
    this.layerHasImages = true;
    this.layerHasText = true;
    this.isPopupOpenForCurrentLayer = false;
    this.relatedRecordsDefaultCount = 1;
    this.guidList = [];
    this.debouncedPopupUpdates = (0,_functional_c82f5ab9_js__WEBPACK_IMPORTED_MODULE_8__.d)((detail) => {
      var _a;
      if (this.serviceType !== _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.s.wms) {
        // if event.detail is true, only update external
        if (!detail || !((_a = this.layer) === null || _a === void 0 ? void 0 : _a.popupTemplate)) {
          if (this.layerDisplayType === _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.l.feature) {
            this.layer.popupTemplate = this.popupTemplate.clone();
          }
          else if (this.layerDisplayType === _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.l.cluster) {
            this.layer.featureReduction.popupTemplate = this.popupTemplate.clone();
          }
        }
      }
      this.popupUpdated.emit(this.layerDisplayType === _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.l.mapNotes && {
        mapNotesPopuptemplate: this.mapNotesPopupEnabled ? this.popupTemplate.clone() : null
      });
    }, 1000);
    this.manageExpressionBtnClick = (event) => {
      event.stopPropagation();
      this.closePopupPopovers.emit();
      const expressionComponent = document.createElement("arcgis-popup-expressions");
      if (this.calciteFlowProps) {
        this.calciteFlowProps.flow.appendChild(expressionComponent);
      }
      else {
        this.hostElement.shadowRoot.getElementById("popupFlow_Id").appendChild(expressionComponent);
      }
      setTimeout(() => requestAnimationFrame(() => expressionComponent.setFocus()), 200);
    };
    // rendor methods
    this.popupTitleComponent = () => ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-popup-title", { popupFlowItem: this.popupPanel }));
    this.fieldComponent = (uniqueGuid, content, blockOpen) => ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { key: uniqueGuid, id: uniqueGuid }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-popup-attributes", { guid: uniqueGuid, popupContent: content, popupFlowItem: this.popupPanel, blockOpen: blockOpen })));
    this.attachmentComponent = (uniqueGuid, content, blockOpen) => {
      var _a, _b, _c;
      return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { key: uniqueGuid, id: uniqueGuid }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-popup-attachments", { guid: uniqueGuid, attachmentContent: content, layerSupportsResizeAttachments: ((_c = (_b = (_a = this.layer) === null || _a === void 0 ? void 0 : _a.capabilities) === null || _b === void 0 ? void 0 : _b.operations) === null || _c === void 0 ? void 0 : _c.supportsResizeAttachments)
          ? true
          : false, popupFlowItem: this.popupPanel, blockOpen: blockOpen })));
    };
    this.richtextComponent = (uniqueGuid, content, blockOpen) => {
      // sketch/mapNotes layers have no fieldInfos
      var _a, _b;
      const popupData = this.popupTemplate.toJSON();
      const fieldData = (_a = popupData.fieldInfos) === null || _a === void 0 ? void 0 : _a.map(({ fieldName, label }) => {
        return {
          name: fieldName,
          alias: label || fieldName
        };
      });
      this.fieldData = fieldData || [];
      // the only way to see the current arcade expressions in the color picker plugin is if it is first
      // added in before the richtext editor component is mounted on initially
      const expressionInfos = (_b = this.popupTemplate) === null || _b === void 0 ? void 0 : _b.toJSON().expressionInfos;
      const newExpressionData = expressionInfos === null || expressionInfos === void 0 ? void 0 : expressionInfos.map(({ expression, name, returnType, title }) => {
        return {
          name: `expression/${name}`,
          alias: title === "New expression" ? " " : title,
          type: returnType,
          description: expression
        };
      });
      if (newExpressionData === null || newExpressionData === void 0 ? void 0 : newExpressionData.length) {
        this.fieldData = this.fieldData.filter((field) => !newExpressionData.some((expression) => expression.name === field.name));
      }
      this.attributeData = newExpressionData
        ? [...newExpressionData, ...this.fieldData]
        : this.fieldData;
      return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { key: uniqueGuid, id: uniqueGuid, ref: (el) => {
          if (el) {
            this.richTextElements = [...this.richTextElements, el];
          }
        } }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-popup-richtext", { fieldExpressionData: {
          data: this.attributeData,
          placeholderText: this.strings.searchFields,
          heading: this.strings.selectField,
          label: this.strings.fieldsListPluginName,
          mapView: this.mapView,
          layer: this.layer
        }, arcgisColorPickerData: {
          data: this.attributeData,
          filterPlaceholder: this.strings.searchAttributes,
          label: this.strings.colorPicker,
          doneText: this.strings.done,
          customText: this.strings.customText,
          attributeText: this.strings.attributeText
        }, guid: uniqueGuid, richtextContent: content, popupFlowItem: this.popupPanel, blockOpen: blockOpen })));
    };
    this.multimediaComponent = (uniqueGuid, content, blockOpen) => ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { key: uniqueGuid, id: uniqueGuid }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-popup-multimedia", { guid: uniqueGuid, multimediaContent: content, popupFlowItem: this.popupPanel, blockOpen: blockOpen })));
    this.arcadeComponent = (uniqueGuid, content, blockOpen) => ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { key: uniqueGuid, id: uniqueGuid }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-popup-arcade", { guid: uniqueGuid, arcadeContent: content, blockOpen: blockOpen })));
    this.relationshipComponent = (uniqueGuid, content, blockOpen) => ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { key: uniqueGuid, id: uniqueGuid }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-popup-relationship", { guid: uniqueGuid, relatedRecordsContent: content, popupFlowItem: this.popupPanel, blockOpen: blockOpen })));
    this.mapView = undefined;
    this.layer = undefined;
    this.portal = undefined;
    this.displayPopup = true;
    this.config = undefined;
    this.layerDisplayType = _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.l.feature;
    this.dismissible = false;
    this.backButton = false;
    this.hideLayerTitle = false;
    this.showConfigureFields = false;
    this.showManageExpressions = true;
    this.calciteFlowProps = null;
    this.mapNotesPopupTemplate = undefined;
    this.mapNotesGraphic = undefined;
    this.reRender = undefined;
    this.popupComponents = [];
    this.hasError = false;
  }
  // lifecycle methods
  async componentWillLoad() {
    var _a, _b, _c;
    // popupState here has the settings from the last
    // session of this component instead of a clean new one
    // because createStore gets called just once in a app session
    // so instead call a clear method, as a workaround
    (0,_popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.c)(_popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p);
    [this.strings, this.currentLanguage, this.currentLanguageIntl] =
      await (0,_locale_13e00a75_js__WEBPACK_IMPORTED_MODULE_1__.g)(this.hostElement);
    this.serviceType = (0,_commonFunctions_5262b094_js__WEBPACK_IMPORTED_MODULE_3__.c)(this.layer);
    await this.loadAllModules();
    // determine if to show manage expressions and also arcade content
    this.supportsArcade =
      this.showManageExpressions &&
        (this.layerDisplayType === _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.l.feature ||
          this.layerDisplayType === _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.l.cluster) &&
        this.serviceType !== _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.s.ogcFeature &&
        this.serviceType !== _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.s.wfs &&
        this.serviceType !== _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.s.imagery &&
        this.serviceType !== _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.s.imageryTile &&
        this.serviceType !== _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.s.subtype;
    if (this.serviceType === _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.s.tile &&
      "url" in this.layer &&
      !("type" in this.layer) &&
      this.layer.url.indexOf(this.layer.layer.url) > -1) {
      // JS-API does the check if a related FL exists
      this.hasError = true;
      console.error("popups not supported, no related feature service");
    }
    else if (this.serviceType !== _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.s.wms) {
      if (this.layerDisplayType === _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.l.feature) {
        const layerType = "type" in this.layer ? this.layer.type : "sublayer";
        const sourceLayer = this.mapView.popup.visible
          ? (_a = this.mapView.popup.selectedFeature) === null || _a === void 0 ? void 0 : _a.sourceLayer
          : undefined;
        this.isPopupOpenForCurrentLayer =
          layerType === "subtype-sublayer"
            ? (sourceLayer === null || sourceLayer === void 0 ? void 0 : sourceLayer.subtypeCode) === this.layer.subtypeCode &&
              (sourceLayer === null || sourceLayer === void 0 ? void 0 : sourceLayer.parent.id) === this.layer.parent.id // TODO any + parent
            : layerType === "sublayer"
              ? (sourceLayer === null || sourceLayer === void 0 ? void 0 : sourceLayer.id) === this.layer.id &&
                (sourceLayer === null || sourceLayer === void 0 ? void 0 : sourceLayer.layer.id) === this.layer.layer.id
              : "id" in this.layer && (sourceLayer === null || sourceLayer === void 0 ? void 0 : sourceLayer.id) === this.layer.id;
        // does layer have attachment
        if (isDefined((_c = (_b = this.layer.capabilities) === null || _b === void 0 ? void 0 : _b.data) === null || _c === void 0 ? void 0 : _c.supportsAttachment)) {
          this.layerHasAttachment = this.layer.capabilities.data.supportsAttachment;
        }
        this.layerHasET = this.layer.editFieldsInfo ? true : false;
        _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.layerHasRelatedRecords = await layerHasRelatedRecords(this.layer, this.mapView, this.serviceType);
        // temp, turn off popupEnabled for MIL
        if (this.serviceType === _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.s.mapImage &&
          !this.layer.popupTemplate) {
          this.layer.popupEnabled = false;
        }
        // generate default if template is empty
        this.popupTemplate = this.layer.popupTemplate
          ? this.layer.popupTemplate.clone()
          : this.layer.createPopupTemplate();
        // generate master field info
        this.popupTemplate.fieldInfos = [
          ...(await (0,_previewPopup_05f5d196_js__WEBPACK_IMPORTED_MODULE_6__.g)(this.layer, this.popupTemplate))
        ];
      }
      else if (this.layerDisplayType === _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.l.cluster) {
        this.layerHasAttachment = false;
        this.layerHasET = false;
        this.popupTemplate = this.layer.featureReduction.popupTemplate.clone();
      }
      else if (this.layerDisplayType === _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.l.mapNotes) {
        if (this.mapNotesPopupTemplate) {
          this.mapNotesPopupEnabled = true;
          this.popupTemplate = this.mapNotesPopupTemplate.clone();
        }
        else {
          this.mapNotesPopupEnabled = false;
          const [PopupTemplate] = await (0,_loadModules_aaf30bd6_js__WEBPACK_IMPORTED_MODULE_4__.l)([
            "esri/PopupTemplate"
          ]);
          this.popupTemplate = new PopupTemplate();
        }
        this.layerHasAttachment = false;
        this.layerHasET = false;
        this.layerHasAttributes = false;
        this.layerHasCharts = false;
      }
    }
    _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.layer = this.layer;
    _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.mapView = this.mapView;
    _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.portal = this.portal;
    _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.config = this.config;
    _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.strings = this.strings;
    _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.currentLanguage = this.currentLanguage;
    _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.currentLanguageIntl = this.currentLanguageIntl;
    _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.serviceType = this.serviceType;
    _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.popupTemplate = this.popupTemplate;
    _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.layerHasAttachment = this.layerHasAttachment;
    _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.layerHasET = this.layerHasET;
    _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.layerHasAttributes = this.layerHasAttributes;
    _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.layerHasCharts = this.layerHasCharts;
    _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.layerHasImages = this.layerHasImages;
    _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.layerHasText = this.layerHasText;
    _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.layerDisplayType = this.layerDisplayType;
    _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.supportsArcade = this.supportsArcade;
  }
  async componentDidLoad() {
    var _a;
    // load content only once popupFlowItem exists
    // popupTemplate.content can be [], string, function and promise
    // if string, convert to text content
    if (this.popupTemplate) {
      if (typeof this.popupTemplate.content === "string") {
        const textContent = await (0,_loadModules_aaf30bd6_js__WEBPACK_IMPORTED_MODULE_4__.l)(["esri/popup/content/TextContent"]).then(([TextContent]) => {
          return new TextContent({
            text: this.popupTemplate.content
          });
        });
        this.popupTemplate.content = [textContent];
      }
      if (Array.isArray(this.popupTemplate.content)) {
        this.popupTemplate.content.forEach((content, index) => {
          // if layer has no attachment, remove it
          if (content.type === "attachments" && !this.layerHasAttachment) {
            this.popupTemplate.content.splice(index, 1);
          }
          else {
            this.addToPopupComponents(content);
          }
        });
      }
      else {
        console.error("content not supported");
      }
      this.reRender = !this.reRender;
    } // else WMS
    if (this.serviceType !== _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.s.wms) {
      // watch for changes to layers/tables to show/hide relationship
      if (this.layerDisplayType === _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.l.feature) {
        this.watchForChangesToLayersList();
      }
      this.sortableComponents = this.hostElement.shadowRoot.getElementById("SortableComponents_Id");
      this.calciteFab =
        ((_a = this.calciteFlowProps) === null || _a === void 0 ? void 0 : _a.calciteFab) ||
          this.hostElement.shadowRoot.getElementById("addComponentBtn_Id");
      const tempPopupProp = this.getPopupEnabledProp();
      this.enableDisablePopup(tempPopupProp);
      //this.showPreviewPopup(tempPopupProp); - setupResizeObserver opens the popup already
      // MV workflow
      this.setupResizeObserver();
      // fab for content popover
      this.calciteFab.onclick = (event) => {
        event.stopPropagation();
        this.closePopupPopovers.emit();
        if (!this.contentPopover) {
          this.contentPopover = document.createElement("arcgis-popup-main-contentpopover");
          this.contentPopover.contentPopoverRefElement = this.calciteFab;
          this.contentPopover.popupHasAttachment = this.popupHasAttachment;
          this.contentPopover.popoverPanelWidth = this.hostElement.getBoundingClientRect().width;
          document.body.appendChild(this.contentPopover);
          this.calciteFab.disabled = true;
          this.disablePopupPanel.emit(true);
        }
      };
    }
    requestAnimationFrame(() => this.popupPanel.setFocus());
  }
  componentDidUpdate() {
    this.internalPopupUpdated.emit();
  }
  disconnectedCallback() {
    var _a, _b;
    (_a = this.parentShellObserver) === null || _a === void 0 ? void 0 : _a.disconnect();
    (_b = this.watchLayersAndTables) === null || _b === void 0 ? void 0 : _b.remove();
    if (this.contentPopover) {
      document.body.removeChild(this.contentPopover);
    }
  }
  // Public Methods
  async done() {
    var _a;
    this.resetMultiMediaIndex.emit();
    this.closePopupPopovers.emit();
    (_a = this.attributesComponent) === null || _a === void 0 ? void 0 : _a.done();
    this.showPreviewPopup(false);
  }
  /**
   * @deprecated with 3.0.x
   * @param focusId
   **/
  async setFocus(focusId) {
    var _a;
    (_a = this.calciteFab) === null || _a === void 0 ? void 0 : _a.setFocus();
  }
  // Events
  calciteFlowItemBackHandler(event) {
    event.stopPropagation();
    this.closePopupPopovers.emit();
  }
  mainPopupReRenderHandler(event) {
    event.stopPropagation();
    this.reRender = this.reRender ? false : true;
  }
  // update popup
  internalPopupUpdatedHandler(event) {
    var _a, _b;
    event.stopPropagation();
    // refresh popup in case it's in a drill-in state
    if (this.singleFeature && ((_b = (_a = this.mapView.popup) === null || _a === void 0 ? void 0 : _a._flowItems) === null || _b === void 0 ? void 0 : _b.length)) {
      this.mapView.popup.features = undefined;
      // waiting here makes sure it doesn't refresh twice
      // a timeout of at least 0 is needed to reset the features list
      setTimeout(() => (this.mapView.popup.features = [this.singleFeature]), 1000);
    }
    this.debouncedPopupUpdates(event.detail);
  }
  deleteComponentHandler(event) {
    event.stopPropagation();
    this.closePopupPopovers.emit();
    // each div has id. Find id, and splice by index
    const allComponents = this.sortableComponents.getElementsByTagName("div");
    for (let x = 0; x < allComponents.length; x++) {
      if (allComponents[x].id === event.detail) {
        this.popupTemplate.content.splice(x, 1);
        this.popupComponents.splice(x, 1);
        this.guidList.splice(x, 1);
        break;
      }
    }
    // only allow 1 attachment
    this.popupHasAttachment = this.popupTemplate.content.some((content) => {
      if (content.type === "attachments") {
        return true;
      }
    });
    if (this.richTextElements) {
      // Remove the reference to the rich text editor if the rich text editor is being destroyed
      const newElements = this.richTextElements.filter((ref) => ref.id !== event.detail);
      this.richTextElements = newElements;
    }
    this.mainPopupReRender.emit();
    this.calciteFab.setFocus();
  }
  duplicateComponentHandler(event) {
    event.stopPropagation();
    this.closePopupPopovers.emit();
    // each div has id. Find id, and clone
    const allComponents = this.sortableComponents.getElementsByTagName("div");
    for (let x = 0; x < allComponents.length; x++) {
      if (allComponents[x].id === event.detail) {
        const tempContent = this.popupTemplate.content[x].clone();
        this.popupTemplate.content.push(tempContent);
        this.addToPopupComponents(tempContent, true);
        break;
      }
    }
  }
  closePopupPopoversHandler() {
    if (this.contentPopover) {
      document.body.removeChild(this.contentPopover);
      this.contentPopover = null;
      this.calciteFab.disabled = false;
      requestAnimationFrame(() => this.calciteFab.setFocus());
      this.disablePopupPanel.emit(false);
    }
  }
  notifyAddContentSelectionHandler(event) {
    event.stopPropagation();
    this.closePopupPopovers.emit();
    // editor tracking
    if (event.detail === ContentSelection.summaryET) {
      this.popupTemplate.lastEditInfoEnabled = true;
      this.mainPopupReRender.emit();
      this.summaryETDiv.scrollIntoView({ behavior: "smooth", block: "nearest", inline: "start" });
      this.calciteFab.setFocus();
    }
    else {
      this.addPopupContents(event.detail);
    }
  }
  disablePopupPanelHandler(event) {
    var _a;
    event.stopPropagation();
    const panel = ((_a = this.calciteFlowProps) === null || _a === void 0 ? void 0 : _a.calciteFlowItem) || this.popupPanel;
    panel.disabled = event.detail;
  }
  //updates to attributes
  async attributesUpdatedHandler(event) {
    event.stopPropagation();
    this.popupTemplate.fieldInfos = [
      ...(await (0,_previewPopup_05f5d196_js__WEBPACK_IMPORTED_MODULE_6__.g)(this.layer, this.layer.popupTemplate || this.popupTemplate))
    ];
    if (this.layer.popupTemplate.expressionInfos) {
      this.popupTemplate.expressionInfos = [
        ...this.layer.popupTemplate.expressionInfos
      ];
      this.arcadeChangeNotification.emit();
    }
    this.attributesChangeNotification.emit();
    this.mainPopupReRender.emit();
  }
  // for arcade changes
  arcadeChangeNotificationHandler() {
    var _a;
    // if an arcade expression is added/removed, update the selection of expressions in the rich
    // text editor's color picker plugin
    if (this.richTextElements) {
      const newExpressionData = (_a = this.popupTemplate) === null || _a === void 0 ? void 0 : _a.toJSON().expressionInfos.map(({ expression, name, returnType, title }) => {
        return {
          name: `expression/${name}`,
          alias: title === "New expression" ? " " : title,
          type: returnType,
          description: expression
        };
      });
      this.attributeData = newExpressionData
        ? [...newExpressionData, ...this.fieldData]
        : this.fieldData;
      // updating the state here manually here since the rich text editor will not listen for changes in state
      // in initialization - we do not need to keep list of expressions in a state decorator either
      this.richTextElements.forEach((el) => {
        const richTextElement = el.firstChild;
        richTextElement.arcgisColorPickerData.data = this.attributeData;
        richTextElement.fieldExpressionData.data = this.attributeData;
      });
    }
    this.mainPopupReRender.emit();
  }
  // private methods and properties
  async loadAllModules() {
    [this.LayerOptions, this.reactiveUtils] = await (0,_loadModules_aaf30bd6_js__WEBPACK_IMPORTED_MODULE_4__.l)([
      "esri/popup/LayerOptions",
      "esri/core/reactiveUtils"
    ]);
  }
  watchForChangesToLayersList() {
    var _a, _b;
    if (this.layerDisplayType === _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.l.feature &&
      this.serviceType === _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.s.feature &&
      ((_b = (_a = this.layer) === null || _a === void 0 ? void 0 : _a.relationships) === null || _b === void 0 ? void 0 : _b.length)) {
      this.watchLayersAndTables = this.reactiveUtils.watch(() => [this.mapView.map.allLayers.length, this.mapView.map.allTables.length], async () => {
        _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.layerHasRelatedRecords = await layerHasRelatedRecords(this.layer, this.mapView, this.serviceType);
      });
    }
  }
  enableDisablePopup(popupBool) {
    // hide rest of the component.
    if (this.serviceType !== _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.s.wms) {
      const popupDiv = this.hostElement.shadowRoot.getElementById("popupDiv_Id");
      popupDiv.style.display = popupBool ? "block" : "none";
      this.calciteFab.style.display = popupBool ? "block" : "none";
    }
    this.closePopupPopovers.emit();
  }
  getPopupEnabledProp() {
    switch (this.layerDisplayType) {
      case _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.l.feature: {
        if (this.serviceType === _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.s.wms) {
          return this.layer.popupEnabled;
        }
        else {
          return this.layer.popupTemplate
            ? this.layer.popupEnabled
            : false;
        }
      }
      case _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.l.cluster: {
        return this.layer.featureReduction.popupEnabled;
      }
      case _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.l.mapNotes: {
        return this.mapNotesPopupEnabled;
      }
      default: {
        return this.layer.popupEnabled;
      }
    }
  }
  reorder(arr, oldIdxs, newIdxs) {
    const oldArr = [...arr];
    arr.length = 0;
    oldArr.forEach((item, idx) => {
      let newIdx;
      newIdxs.forEach((guid, idx2) => {
        if (oldIdxs[idx] === guid) {
          newIdx = idx2;
        }
      });
      arr[newIdx] = item;
    });
  }
  addToPopupComponents(content, blockOpen = false) {
    const newGuid = (0,_guid_4f4176ba_js__WEBPACK_IMPORTED_MODULE_5__.g)();
    if (content.type === "fields") {
      this.popupComponents = [
        ...this.popupComponents,
        this.fieldComponent(newGuid, content, blockOpen)
      ];
      this.guidList = [...this.guidList, newGuid];
    }
    else if (content.type === "attachments") {
      this.popupComponents = [
        ...this.popupComponents,
        this.attachmentComponent(newGuid, content, blockOpen)
      ];
      this.popupHasAttachment = true;
      this.guidList = [...this.guidList, newGuid];
    }
    else if (content.type === "media") {
      this.popupComponents = [
        ...this.popupComponents,
        this.multimediaComponent(newGuid, content, blockOpen)
      ];
      this.guidList = [...this.guidList, newGuid];
    }
    else if (content.type === "text") {
      this.popupComponents = [
        ...this.popupComponents,
        this.richtextComponent(newGuid, content, blockOpen)
      ];
      this.guidList = [...this.guidList, newGuid];
    }
    else if (content.type === "expression") {
      this.popupComponents = [
        ...this.popupComponents,
        this.arcadeComponent(newGuid, content, blockOpen)
      ];
      this.guidList = [...this.guidList, newGuid];
    }
    else if (content.type === "relationship") {
      this.popupComponents = [
        ...this.popupComponents,
        this.relationshipComponent(newGuid, content, blockOpen)
      ];
      this.guidList = [...this.guidList, newGuid];
    }
  }
  async addPopupContents(popupContentType) {
    const [FieldsContent, AttachmentsContent, TextContent, MediaContent, ImageMediaInfo, ColumnChartMediaInfo, ImageMediaInfoValue, ChartMediaInfoValue, ExpressionContent, RelationshipContent] = await (0,_loadModules_aaf30bd6_js__WEBPACK_IMPORTED_MODULE_4__.l)([
      "esri/popup/content/FieldsContent",
      "esri/popup/content/AttachmentsContent",
      "esri/popup/content/TextContent",
      "esri/popup/content/MediaContent",
      "esri/popup/content/ImageMediaInfo",
      "esri/popup/content/ColumnChartMediaInfo",
      "esri/popup/content/support/ImageMediaInfoValue",
      "esri/popup/content/support/ChartMediaInfoValue",
      "esri/popup/content/ExpressionContent",
      "esri/popup/content/RelationshipContent"
    ]);
    let content = null;
    if (popupContentType === ContentSelection.attributes) {
      content = new FieldsContent({
        fieldInfos: null
      });
    }
    else if (popupContentType === ContentSelection.attachments) {
      content = new AttachmentsContent({
        displayType: null
      });
    }
    else if (popupContentType === ContentSelection.richText) {
      content = new TextContent({
        text: null
      });
    }
    else if (popupContentType === ContentSelection.images) {
      const imageElement = new ImageMediaInfo({
        title: "",
        caption: "",
        altText: "",
        value: new ImageMediaInfoValue({
          sourceURL: "",
          linkURL: ""
        })
      });
      content = new MediaContent({
        mediaInfos: [imageElement]
      });
    }
    else if (popupContentType === ContentSelection.charts) {
      const chartElement = new ColumnChartMediaInfo({
        title: "",
        caption: "",
        altText: "",
        value: new ChartMediaInfoValue({
          fields: []
        })
      });
      content = new MediaContent({
        mediaInfos: [chartElement]
      });
    }
    else if (popupContentType === ContentSelection.arcade) {
      content = new ExpressionContent({
        expressionInfo: {
          expression: defaultContentMessage(this.layerDisplayType, this.strings)
        }
      });
    }
    else if (popupContentType === ContentSelection.relationship) {
      const relationshipAndLayer = await getDefaultRelationshipAndLayer(this.layer, this.mapView, this.serviceType);
      let defaultField = relationshipAndLayer.currLayer.fields.find((field) => field.visible && field.type === "date");
      if (!defaultField) {
        defaultField = relationshipAndLayer.currLayer.fields.find((field) => field.visible);
      }
      content = new RelationshipContent({
        displayCount: this.relatedRecordsDefaultCount,
        relationshipId: relationshipAndLayer.relationship.id,
        orderByFields: [{ field: defaultField.name, order: "asc" }]
      });
    }
    this.popupTemplate.content.push(content);
    this.addToPopupComponents(content, true);
  }
  async showPreviewPopup(show) {
    var _a, _b, _c;
    if (this.displayPopup &&
      this.layerDisplayType === _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.l.feature &&
      !this.isPopupOpenForCurrentLayer) {
      if (show &&
        this.layer.popupEnabled &&
        this.layer.popupTemplate) {
        if ((_b = (_a = this.mapView.popup) === null || _a === void 0 ? void 0 : _a.features) === null || _b === void 0 ? void 0 : _b.length) {
          // if we have a popup, maybe from another layer
          // make sure we don't stay in a drill-in state
          // popup might not be visible at this moment
          this.mapView.closePopup();
          this.mapView.popup.features = undefined;
        }
        this.previewPopupController = new AbortController();
        this.singleFeature = await (0,_previewPopup_05f5d196_js__WEBPACK_IMPORTED_MODULE_6__.p)(this.mapView, this.layer, this.previewPopupController);
      }
      else {
        (_c = this.previewPopupController) === null || _c === void 0 ? void 0 : _c.abort();
        this.mapView.closePopup();
      }
    }
    else if (this.layerDisplayType === _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.l.mapNotes) {
      if (show) {
        this.mapView.openPopup({
          features: [this.mapNotesGraphic],
          location: (0,_commonFunctions_5262b094_js__WEBPACK_IMPORTED_MODULE_3__.o)(this.mapNotesGraphic.geometry)
        });
      }
      else {
        this.mapView.closePopup();
      }
    }
  }
  // if parent is shell panel. MV workflow.
  setupResizeObserver() {
    var _a;
    const parentNode = (_a = this.hostElement) === null || _a === void 0 ? void 0 : _a.parentElement;
    if ((parentNode === null || parentNode === void 0 ? void 0 : parentNode.tagName) === "CALCITE-SHELL-PANEL") {
      const shellPanelNode = parentNode;
      if (isDefined(shellPanelNode.collapsed)) {
        this.parentShellObserver = new ResizeObserver(() => {
          if (shellPanelNode.collapsed) {
            this.done();
          }
          else {
            this.showPreviewPopup(true);
          }
        });
        this.parentShellObserver.observe(shellPanelNode);
      }
    }
    else {
      this.showPreviewPopup(true);
    }
  }
  createLayerOptions() {
    var _a, _b;
    const layerOptions = this.popupTemplate.layerOptions || new this.LayerOptions();
    // showNoDataRecords and returnTopmostRaster can be null when not set
    layerOptions.showNoDataRecords = (_a = layerOptions.showNoDataRecords) !== null && _a !== void 0 ? _a : false;
    layerOptions.returnTopmostRaster = (_b = layerOptions.returnTopmostRaster) !== null && _b !== void 0 ? _b : true;
    this.popupTemplate.layerOptions = layerOptions;
  }
  render() {
    var _a, _b, _c, _d, _e, _f;
    if (this.hasError) {
      return this.renderPopupError();
    }
    const enablePopup = ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-label", { class: CSS$6.enablePopup, alignment: "start", layout: "inline-space-between" }, this.strings.enablePopup, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-switch", { scale: "s", checked: this.getPopupEnabledProp(), onCalciteSwitchChange: (event) => {
        const checked = event.target.checked;
        switch (this.layerDisplayType) {
          case _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.l.feature: {
            this.layer.popupEnabled = checked;
            break;
          }
          case _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.l.cluster: {
            this.layer
              .featureReduction.popupEnabled = checked;
            break;
          }
          case _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.l.mapNotes: {
            this.mapNotesPopupEnabled = checked;
            break;
          }
          default: {
            this.layer.popupEnabled = checked;
          }
        }
        this.enableDisablePopup(checked);
        this.internalPopupUpdated.emit(true);
        // layer.popupTemplate can be null, due to debouncedPopupUpdates, causing popup preview to not work
        if (this.layerDisplayType !== _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.l.mapNotes &&
          checked &&
          !this.layer.popupTemplate) {
          this.layer.popupTemplate = this.popupTemplate;
        }
        this.showPreviewPopup(checked);
      } })));
    const manageExpressionBtn = ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { alignment: "icon-end-space-between", appearance: "transparent", kind: "neutral", iconEnd: (0,_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_7__.g)(this.hostElement) === "rtl" ? "chevron-left" : "chevron-right", label: this.strings.manageExpressions, width: "full", onClick: this.manageExpressionBtnClick }, this.strings.manageExpressions));
    const ignoreNodata = ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-label", { alignment: "start", layout: "inline-space-between" }, this.strings.ignoreNoData, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-switch", { scale: "s", checked: !((_c = (_b = (_a = this.popupTemplate) === null || _a === void 0 ? void 0 : _a.layerOptions) === null || _b === void 0 ? void 0 : _b.showNoDataRecords) !== null && _c !== void 0 ? _c : false), onCalciteSwitchChange: (event) => {
        var _a;
        const checked = event.target.checked;
        if (!((_a = this.popupTemplate) === null || _a === void 0 ? void 0 : _a.layerOptions)) {
          this.createLayerOptions();
        }
        this.popupTemplate.layerOptions.showNoDataRecords = !checked;
        this.internalPopupUpdated.emit();
      } })));
    const displayTopmost = ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-label", { alignment: "start", layout: "inline-space-between" }, this.strings.displayTopmost, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-switch", { scale: "s", checked: (_f = (_e = (_d = this.popupTemplate) === null || _d === void 0 ? void 0 : _d.layerOptions) === null || _e === void 0 ? void 0 : _e.returnTopmostRaster) !== null && _f !== void 0 ? _f : true, onCalciteSwitchChange: (event) => {
        var _a;
        const checked = event.target.checked;
        if (!((_a = this.popupTemplate) === null || _a === void 0 ? void 0 : _a.layerOptions)) {
          this.createLayerOptions();
        }
        this.popupTemplate.layerOptions.returnTopmostRaster = checked;
        this.internalPopupUpdated.emit();
      } })));
    const summaryET = ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("section", { class: CSS$6.summaryET }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-icon", { scale: "m", icon: "user" }), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("label", { class: CSS$6.summaryETLabel }, this.strings.summaryETHeading), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { text: this.strings.remove, appearance: "transparent", icon: "x", class: CSS$6.summaryETAction, onClick: (event) => {
        event.stopPropagation();
        this.closePopupPopovers.emit();
        this.popupTemplate.lastEditInfoEnabled = false;
        this.mainPopupReRender.emit();
        this.calciteFab.setFocus();
      } })));
    const calciteFab = ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-fab", { id: "addComponentBtn_Id", icon: "plus", slot: "fab", scale: "s", appearance: "outline-fill", kind: "neutral", label: this.strings.addContent, text: this.strings.addContent, "text-enabled": true }));
    const manageFieldsBtn = ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { alignment: "icon-end-space-between", appearance: "transparent", kind: "neutral", iconEnd: (0,_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_7__.g)(this.hostElement) === "rtl" ? "chevron-left" : "chevron-right", label: this.strings.configureFields, width: "full", onClick: (event) => {
        event.stopPropagation();
        this.closePopupPopovers.emit();
        const attributesFlowItem = document.createElement("calcite-flow-item");
        attributesFlowItem.heading = this.strings.attributes;
        attributesFlowItem.description = !this.hideLayerTitle ? this.layer.title : undefined;
        this.attributesComponent = document.createElement("arcgis-attributes");
        this.attributesComponent.lang = this.currentLanguage;
        this.attributesComponent.layer = this.layer;
        this.attributesComponent.mapView = this.mapView;
        this.attributesComponent.portal = this.portal;
        this.attributesComponent.layerDisplayType = this.layerDisplayType;
        this.attributesComponent.config = this.config;
        this.attributesComponent.calciteFlowProps = true;
        this.attributesComponent.displayPopup = false;
        attributesFlowItem.appendChild(this.attributesComponent);
        attributesFlowItem.beforeBack = async () => {
          this.closeAttributePopovers.emit();
        };
        if (this.calciteFlowProps) {
          this.calciteFlowProps.flow.appendChild(attributesFlowItem);
        }
        else {
          this.hostElement.shadowRoot
            .getElementById("popupFlow_Id")
            .appendChild(attributesFlowItem);
        }
        setTimeout(() => requestAnimationFrame(() => attributesFlowItem.setFocus()), 200);
      } }, this.strings.configureFields));
    const popupOptions = () => {
      // show popup options if any of the following is true
      const configureFields = this.showConfigureFields;
      const isImagery = this.serviceType === _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.s.imagery;
      if (configureFields || this.supportsArcade || isImagery) {
        return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-block", { heading: this.strings.options, open: true, collapsible: true }, isImagery && imageryOptions(), this.supportsArcade && manageExpressionBtn, configureFields && manageFieldsBtn));
      }
    };
    const imageryOptions = () => {
      var _a, _b, _c;
      //enable display topmost if service version is greater than 10.8 and if its mosaic dataset
      //or single raster dataset which is multidimensional
      const layer = this.layer;
      const isMosaicDatasetService = !!((_b = (_a = layer.capabilities) === null || _a === void 0 ? void 0 : _a.operations) === null || _b === void 0 ? void 0 : _b.supportsQuery) && ((_c = layer.fields) === null || _c === void 0 ? void 0 : _c.length);
      const isMultidimensional = layer.hasMultidimensions;
      return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS$6.imageryOptions }, ignoreNodata, (0,_commonFunctions_5262b094_js__WEBPACK_IMPORTED_MODULE_3__.p)(layer) >= 10.8 &&
        (isMosaicDatasetService || isMultidimensional) &&
        displayTopmost));
    };
    const popupMain = ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", null, enablePopup, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { id: "popupDiv_Id" }, popupOptions(), this.popupTitleComponent(), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS$6.componentDiv }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-sortable-list", { id: "SortableComponents_Id", style: { position: "relative" }, onCalciteListOrderChange: (event) => {
        event.stopPropagation();
        this.sortableComponents =
          this.hostElement.shadowRoot.getElementById("SortableComponents_Id");
        const newGuidList = [];
        const allComponents = this.sortableComponents.getElementsByTagName("div");
        for (let x = 0; x < allComponents.length; x++) {
          newGuidList.push(allComponents[x].id);
        }
        this.reorder(this.popupTemplate.content, this.guidList, newGuidList);
        this.reorder(this.popupComponents, this.guidList, newGuidList);
        this.guidList = newGuidList;
        this.internalPopupUpdated.emit();
      } }, this.popupComponents)), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { ref: (el) => (this.summaryETDiv = el) }, this.layerHasET && this.popupTemplate.lastEditInfoEnabled && summaryET))));
    const backButton = ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { text: this.strings.back, scale: "s", slot: "header-actions-start", ref: (backButtonEl) => (this.backButtonEl = backButtonEl), onClick: (event) => {
        event.stopPropagation();
        this.done();
        this.arcgisPopupDismissedChange.emit();
      } }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-icon", { icon: (0,_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_7__.g)(this.hostElement) === "rtl" ? "chevron-right" : "chevron-left" })));
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)(_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.H, { style: this.calciteFlowProps ? {} : { display: "flex", flex: "1 1 auto", overflow: "hidden" } }, this.calciteFlowProps ? ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { dir: (0,_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_7__.g)(this.hostElement), ref: () => (this.popupPanel = this.calciteFlowProps.calciteFlowItem) }, this.serviceType === _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.s.wms ? enablePopup : popupMain)) : ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-flow", { id: "popupFlow_Id", dir: (0,_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_7__.g)(this.hostElement) }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-flow-item", { ref: (el) => (this.popupPanel = el), heading: this.strings.popupHeading, description: !this.hideLayerTitle ? this.layer.title : undefined, closable: this.dismissible, onCalciteFlowItemClose: (event) => {
        event.stopPropagation();
        this.done();
        this.arcgisPopupDismissedChange.emit();
      } }, this.serviceType === _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.s.wms ? enablePopup : popupMain, this.serviceType !== _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.s.wms && calciteFab, this.backButton && backButton)))));
  }
  renderPopupError() {
    const popupMain = ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS$6.notice }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-notice", { open: true, closable: false, icon: "exclamation-mark-triangle", scale: "s" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { slot: "message" }, " ", this.strings.popupTileError))));
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)(_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.H, { style: this.calciteFlowProps ? {} : { display: "flex", flex: "1 1 auto", overflow: "hidden" } }, this.calciteFlowProps ? ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { dir: (0,_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_7__.g)(this.hostElement), ref: () => (this.popupPanel = this.calciteFlowProps.calciteFlowItem) }, popupMain)) : ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-flow", { id: "popupFlow_Id", dir: (0,_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_7__.g)(this.hostElement) }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-flow-item", { ref: (el) => (this.popupPanel = el), heading: this.strings.popupHeading, description: !this.hideLayerTitle ? this.layer.title : undefined, closable: this.dismissible, onCalciteFlowItemClose: (event) => {
        event.stopPropagation();
        this.done();
        this.arcgisPopupDismissedChange.emit();
      } }, popupMain)))));
  }
  get hostElement() { return (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.d)(this); }
};
ArcgisPopup.style = arcgisPopupCss;

const ArcgisPopupArcade = class {
  constructor(hostRef) {
    (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.r)(this, hostRef);
    this.closePopupPopovers = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "closePopupPopovers", 7);
    this.internalPopupUpdated = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "internalPopupUpdated", 7);
    this.disablePopupPanel = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "disablePopupPanel", 7);
    this.guid = undefined;
    this.arcadeContent = undefined;
    this.blockOpen = false;
    this.reRender = undefined;
  }
  // lifecycle methods
  async componentWillLoad() {
    this.layer = _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.layer;
    this.mapView = _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.mapView;
    this.portal = _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.portal;
    this.config = _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.config;
    this.strings = _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.strings;
    this.currentLanguage = _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.currentLanguage;
    this.serviceType = _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.serviceType;
    this.popupTemplate = _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.popupTemplate;
    this.layerDisplayType = _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.layerDisplayType;
  }
  async componentDidLoad() {
    if (this.blockOpen) {
      this.blockOptions.scrollIntoView({ behavior: "smooth", block: "nearest", inline: "start" });
      await this.launchArcade();
    }
  }
  // private methods and properties
  async launchArcade() {
    var _a, _b, _c;
    if (!this.arcadeEditor) {
      this.disablePopupPanel.emit(true);
      this.arcadeEditor = document.createElement("arcgis-modal-arcade");
      this.arcadeEditor.arcadeScript = getArcadeScript((_a = this.arcadeContent.expressionInfo) === null || _a === void 0 ? void 0 : _a.expression, this.layerDisplayType, this.strings);
      this.arcadeEditor.arcadeProfile = await getArcadeProfile(this.layer, this.mapView, this.serviceType, this.popupTemplate, this.layerDisplayType);
      this.arcadeEditor.testData = await getTestData(this.layer, this.mapView, this.layerDisplayType, this.popupTemplate);
      this.arcadeEditor.suggestions = getTemplates(this.strings);
      this.arcadeEditor.addExistingExpressions = true;
      this.arcadeEditor.layer = this.layer;
      this.arcadeEditor.arcadeTitle =
        ((_b = this.arcadeContent.expressionInfo) === null || _b === void 0 ? void 0 : _b.title) || this.strings.arcadeDefaultTitle;
      this.arcadeEditor.arcadeTitleEditable = true;
      this.arcadeEditor.returnPredictOutputType = false;
      this.arcadeEditor.arcadeTitleEditingEnabled = !((_c = this.arcadeContent.expressionInfo) === null || _c === void 0 ? void 0 : _c.title);
      document.body.appendChild(this.arcadeEditor);
      this.arcadeEditor.addEventListener("arcgisModalArcadeClose", (event) => this.arcadeSetup(event.detail));
    }
  }
  async arcadeSetup(arcadeObject) {
    if (arcadeObject) {
      this.arcadeContent.expressionInfo.expression = arcadeObject.script;
      this.arcadeContent.expressionInfo.title = arcadeObject.title;
      this.reRender = !this.reRender;
      this.internalPopupUpdated.emit();
    }
    this.disablePopupPanel.emit(false);
    document.body.removeChild(this.arcadeEditor);
    this.arcadeEditor = null;
  }
  render() {
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)(_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.H, null, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-block", { dir: (0,_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_7__.g)(this.hostElement), heading: this.strings.arcade, description: this.arcadeContent.expressionInfo.title, collapsible: true, open: this.blockOpen, dragHandle: true }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "ignore-elements-sortable", slot: "control" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-calcite-block-options", { ref: (el) => (this.blockOptions = el), guid: this.guid, intlOptions: this.strings.options, intlDelete: this.strings.delete, intlDuplicate: this.strings.duplicate, calciteBlockOptions: { hasDelete: true, hasDuplicate: true } })), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { slot: "icon" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-icon", { scale: "m", icon: "code" })), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "ignore-elements-sortable" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { appearance: "transparent", width: "full", onClick: async () => await this.launchArcade() }, this.strings.editExpression)))));
  }
  get hostElement() { return (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.d)(this); }
};

const CSS$5 = {
  listWarningDiv: "list-warning-div",
  listWarningIcon: "list-warning-icon",
  listWarningLabel: "list-warning-label",
  listWarningText: "list-warning-text",
  formInputButton: "form-input-button"
};

const arcgisPopupAttachmentsCss = ".list-warning-div{background-color:var(--arcgis-app-background)}.list-warning-label{align-items:stretch;background-color:var(--arcgis-app-background);border-radius:var(--arcgis-app-border-radius);border:1px solid var(--arcgis-app-border);display:flex;font-size:var(--arcgis-app-font-size--2)}.list-warning-icon{align-items:center;background-color:var(--arcgis-app-background-content);display:flex;padding:0 var(--arcgis-app-side-spacing-half)}.list-warning-text{padding:var(--arcgis-app-cap-spacing-quarter) var(--arcgis-app-side-spacing-half)}.form-input-button{display:flex}.form-input-button calcite-input[type=text]{display:flex;flex-flow:column nowrap;flex:1 0 0%;overflow:hidden}.form-input-button calcite-action{margin:0;flex:0 0 0%;justify-self:flex-end}";

const ArcgisPopupAttachments = class {
  constructor(hostRef) {
    (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.r)(this, hostRef);
    this.closePopupPopovers = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "closePopupPopovers", 7);
    this.internalPopupUpdated = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "internalPopupUpdated", 7);
    this.disablePopupPanel = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "disablePopupPanel", 7);
    this.formInput = (formType, formString, formInputElement, formValue, formPlaceholder
    // promptMessage: string
    ) => {
      var _a;
      return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-label", { scale: "s" }, formString, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS$5.formInputButton }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-input", { type: "text", autofocus: true, ref: formInputElement, value: formValue, placeholder: formPlaceholder, onCalciteInputInput: (event) => {
          event.stopPropagation();
          const inputVal = event.target.value;
          if (formType === "title") {
            this.attachmentContent.title = inputVal;
          }
          else {
            this.attachmentContent.description = inputVal;
          }
          this.reRender = !this.reRender;
        }, onClick: () => this.closePopupPopovers.emit() }), ((_a = this.popupTemplate.fieldInfos) === null || _a === void 0 ? void 0 : _a.length) > 0 && ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { text: this.strings.attributes, onClick: () => {
          this.closePopupPopovers.emit();
          if (!this.popupFieldSelectionPickList) {
            this.popupFieldSelectionPickList = document.createElement("arcgis-popup-field-pick-list");
            this.popupFieldSelectionPickList.popoverProps = {
              refElement: this.popupFlowItem
            };
            this.popupFieldSelectionPickList.multiple = false;
            this.popupFieldSelectionPickList.heading = this.strings.addField;
            this.popupFieldSelectionPickList.addEventListener("arcgisPopupPickListDismissed", () => {
              this.closePopupPopovers.emit();
            });
            this.popupFieldSelectionPickList.addEventListener("arcgisPopupPickListChange", (event) => this.popupFieldSelectionPickListChanges(event, formType));
            document.body.appendChild(this.popupFieldSelectionPickList);
            this.disablePopupPanel.emit(true);
          }
        }, scale: "s", icon: "brackets-curly" })))));
    };
    this.guid = undefined;
    this.attachmentContent = undefined;
    this.layerSupportsResizeAttachments = undefined;
    this.blockOpen = false;
    this.popupFlowItem = undefined;
    this.reRender = undefined;
  }
  // lifecycle methods
  componentWillLoad() {
    this.strings = _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.strings;
    this.popupTemplate = _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.popupTemplate;
    if (this.layerSupportsResizeAttachments) {
      if (!this.attachmentContent.displayType) {
        this.attachmentContent.displayType = AttachmentDisplayType.auto;
        // temp
        this.internalPopupUpdated.emit();
      }
    }
    else {
      this.attachmentContent.displayType = AttachmentDisplayType.list;
    }
    if (!this.attachmentContent.title) {
      this.attachmentContent.title = "";
    }
    if (!this.attachmentContent.description) {
      this.attachmentContent.description = "";
    }
  }
  componentDidLoad() {
    if (this.blockOpen) {
      this.blockOptions.scrollIntoView({ behavior: "smooth", block: "nearest", inline: "start" });
      this.blockOptions.setFocus();
    }
  }
  componentDidUpdate() {
    this.internalPopupUpdated.emit();
  }
  disconnectedCallback() {
    if (this.popupFieldSelectionPickList) {
      document.body.removeChild(this.popupFieldSelectionPickList);
    }
  }
  // Events
  calciteBlockToggleHandler() {
    this.closePopupPopovers.emit();
  }
  closePopupPopoversHandler() {
    if (this.popupFieldSelectionPickList) {
      document.body.removeChild(this.popupFieldSelectionPickList);
      this.popupFieldSelectionPickList = null;
      this.disablePopupPanel.emit(false);
    }
  }
  // field selection for title and caption
  popupFieldSelectionPickListChanges(event, formType) {
    const selectedFieldName = event.detail.selectedFields[0];
    if (formType === "title") {
      this.contentTitle.value = addSelectedFieldAtCursor(this.contentTitle, selectedFieldName);
      this.contentTitle.setFocus();
      this.attachmentContent.title = this.contentTitle.value;
    }
    else if (formType === "description") {
      this.contentDescription.value = addSelectedFieldAtCursor(this.contentDescription, selectedFieldName);
      this.contentDescription.setFocus();
      this.attachmentContent.description = this.contentDescription.value;
    }
    this.closePopupPopovers.emit();
    this.reRender = !this.reRender;
  }
  // rendor methods
  render() {
    const attachmentDisplayType = ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-label", null, this.strings.displayAttachmentsAs, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-segmented-control", { width: "full", scale: "s", disabled: !this.layerSupportsResizeAttachments, onCalciteSegmentedControlChange: (event) => {
        const node = event.target;
        const selectedItem = node.selectedItem;
        this.attachmentContent.displayType = selectedItem.value;
        this.reRender = !this.reRender;
      } }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-segmented-control-item", { value: AttachmentDisplayType.auto, iconStart: "check", checked: this.attachmentContent.displayType === AttachmentDisplayType.auto }, this.strings.auto), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-segmented-control-item", { value: AttachmentDisplayType.list, iconStart: "list", checked: this.attachmentContent.displayType === AttachmentDisplayType.list }, this.strings.list), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-segmented-control-item", { value: AttachmentDisplayType.preview, iconStart: "image", checked: this.attachmentContent.displayType === AttachmentDisplayType.preview }, this.strings.gallery)), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-label", { scale: "s" }, (() => {
      switch (this.attachmentContent.displayType) {
        case AttachmentDisplayType.auto:
          return this.strings.autoDisplayMessage;
        case AttachmentDisplayType.list:
          return this.strings.listDisplayMessage;
        case AttachmentDisplayType.preview:
          return this.strings.previewDisplayMessage;
        default:
          return this.strings.listDisplayMessage;
      }
    })())));
    const listWarningMessage = ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS$5.listWarningDiv }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("label", { class: CSS$5.listWarningLabel }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("span", { class: CSS$5.listWarningIcon }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-icon", { scale: "s", icon: "exclamation-mark-triangle" })), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("span", { class: CSS$5.listWarningText }, this.strings.layerOnlySupportsListView))));
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)(_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.H, null, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-block", { dir: (0,_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_7__.g)(this.hostElement), heading: this.strings.attachments, description: (this.attachmentContent.title &&
        `${this.attachmentContent.title.substring(0, 25)}${this.attachmentContent.title.length > 25 ? "..." : ""}`) ||
        (() => {
          switch (this.attachmentContent.displayType) {
            case AttachmentDisplayType.auto:
              return this.strings.auto;
            case AttachmentDisplayType.list:
              return this.strings.list;
            case AttachmentDisplayType.preview:
              return this.strings.gallery;
            default:
              return this.strings.list;
          }
        })(), collapsible: true, open: this.blockOpen, dragHandle: true }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "ignore-elements-sortable", slot: "control" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-calcite-block-options", { ref: (el) => (this.blockOptions = el), guid: this.guid, intlOptions: this.strings.options, intlDelete: this.strings.delete, calciteBlockOptions: { hasDelete: true } })), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { slot: "icon" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-icon", { scale: "m", icon: "attachment" })), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "ignore-elements-sortable" }, this.formInput("title", this.strings.title, (element) => {
      return (this.contentTitle = element);
    }, this.attachmentContent.title, this.strings.enterTitle
    // this.strings.titleContext.replace("${titleContext}", this.strings.attachments_L)
    ), this.formInput("description", this.strings.desc, (element) => {
      return (this.contentDescription = element);
    }, this.attachmentContent.description, this.strings.enterDescription
    // this.strings.descriptionContext.replace(
    //   "${descriptionContext}",
    //   this.strings.attachments_L
    // )
    ), attachmentDisplayType, this.layerSupportsResizeAttachments ? null : listWarningMessage))));
  }
  get hostElement() { return (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.d)(this); }
};
ArcgisPopupAttachments.style = arcgisPopupAttachmentsCss;

const CSS$4 = {
  manageBtn: "manage-btn",
  formInputButton: "form-input-button"
};

const arcgisPopupAttributesCss = ".manage-btn{justify-content:flex-end;margin:4px 0}.form-input-button{display:flex}.form-input-button calcite-input[type=text]{display:flex;flex-flow:column nowrap;flex:1 0 0%;overflow:hidden}.form-input-button calcite-action{margin:0;flex:0 0 0%;justify-self:flex-end}";

const ArcgisPopupAttributes = class {
  constructor(hostRef) {
    (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.r)(this, hostRef);
    this.closePopupPopovers = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "closePopupPopovers", 7);
    this.internalPopupUpdated = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "internalPopupUpdated", 7);
    this.disablePopupPanel = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "disablePopupPanel", 7);
    this.pickList = [];
    this.arcadeExpMap = new Map();
    // open popover
    this.manageBtnClick = (event) => {
      event.stopPropagation();
      // close first since we can have multiple attributes open
      this.closePopupPopovers.emit();
      // lazy load attribute manager component
      if (!this.popupFieldManagePickList) {
        this.popupFieldManagePickList = document.createElement("arcgis-popup-field-pick-list");
        this.popupFieldManagePickList.popoverProps = {
          refElement: this.popupFlowItem
        };
        this.popupFieldManagePickList.selectedFields = this.getSelectedFields();
        this.popupFieldManagePickList.showCancel = false;
        this.popupFieldManagePickList.multiple = true;
        this.popupFieldManagePickList.heading = this.strings.selectFields;
        this.popupFieldManagePickList.okBtnText = this.strings.done;
        this.popupFieldManagePickList.addEventListener("arcgisPopupPickListDismissed", () => {
          this.closePopupPopovers.emit();
        });
        this.popupFieldManagePickList.addEventListener("arcgisPopupPickListChange", this.popupFieldManagePickListChanges);
        document.body.appendChild(this.popupFieldManagePickList);
        this.disablePopupPanel.emit(true);
      }
    };
    this.popupFieldManagePickListChanges = (event) => {
      var _a;
      event.stopPropagation();
      const selectedField = (_a = event.detail) === null || _a === void 0 ? void 0 : _a.selectedFields;
      const fieldInfos = [];
      this.setupFieldMapInfo();
      selectedField.forEach((fieldName) => {
        var _a;
        if (this.fieldInfoMap.has(fieldName)) {
          const tempField = (_a = this.fieldInfoMap.get(fieldName)) === null || _a === void 0 ? void 0 : _a.clone();
          tempField.visible = true;
          fieldInfos.push(tempField);
        }
      });
      this.popupContent.fieldInfos = [...fieldInfos];
      this.reRender = !this.reRender;
    };
    this.calcitePickList = (field) => (
    // field.fieldName is always unique
    (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-value-list-item", { key: field.fieldName, label: (0,_commonFunctions_5262b094_js__WEBPACK_IMPORTED_MODULE_3__.b)(field, this.arcadeExpMap), value: field.fieldName }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { slot: "actions-end", appearance: "transparent", text: this.strings.remove, onClick: () => this.removeBtnClick(field.fieldName) }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-icon", { scale: "s", icon: "x" }))));
    this.formInput = (formType, formString, formInputElement, formValue, formPlaceholder
    // promptMessage: string
    ) => {
      var _a;
      return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-label", { scale: "s" }, formString, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS$4.formInputButton }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-input", { type: "text", autofocus: true, ref: formInputElement, value: formValue, placeholder: formPlaceholder, onCalciteInputInput: (event) => {
          event.stopPropagation();
          const inputVal = event.target.value;
          if (formType === "title") {
            this.popupContent.title = inputVal;
          }
          else {
            this.popupContent.description = inputVal;
          }
          this.reRender = !this.reRender;
        }, onClick: () => this.closePopupPopovers.emit() }), ((_a = this.popupTemplate.fieldInfos) === null || _a === void 0 ? void 0 : _a.length) > 0 && ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { text: this.strings.attributes, onClick: () => {
          this.closePopupPopovers.emit();
          if (!this.popupFieldSelectionPickList) {
            this.popupFieldSelectionPickList = document.createElement("arcgis-popup-field-pick-list");
            this.popupFieldSelectionPickList.popoverProps = {
              refElement: this.popupFlowItem,
              offsetSkidding: 50
            };
            this.popupFieldSelectionPickList.multiple = false;
            this.popupFieldSelectionPickList.heading = this.strings.addField;
            this.popupFieldSelectionPickList.addEventListener("arcgisPopupPickListDismissed", () => {
              this.closePopupPopovers.emit();
            });
            this.popupFieldSelectionPickList.addEventListener("arcgisPopupPickListChange", (event) => this.popupFieldSelectionPickListChanges(event, formType));
            document.body.appendChild(this.popupFieldSelectionPickList);
            this.disablePopupPanel.emit(true);
          }
        }, scale: "s", icon: "brackets-curly" })))));
    };
    this.guid = undefined;
    this.popupContent = undefined;
    this.blockOpen = false;
    this.popupFlowItem = undefined;
    this.reRender = undefined;
  }
  // lifecycle methods
  async componentWillLoad() {
    this.layer = _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.layer;
    this.strings = _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.strings;
    this.popupTemplate = _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.popupTemplate;
    this.layerDisplayType = _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.layerDisplayType;
    if (!this.popupContent.fieldInfos) {
      this.popupContent.fieldInfos = await this.getFieldsContent();
    }
    if (!this.popupContent.title) {
      this.popupContent.title = "";
    }
    if (!this.popupContent.description) {
      this.popupContent.description = "";
    }
  }
  componentDidLoad() {
    if (this.blockOpen) {
      this.blockOptions.scrollIntoView({ behavior: "smooth", block: "nearest", inline: "start" });
      this.blockOptions.setFocus();
      this.internalPopupUpdated.emit();
    }
  }
  componentWillRender() {
    this.arcadeExpMap = (0,_commonFunctions_5262b094_js__WEBPACK_IMPORTED_MODULE_3__.e)(this.popupTemplate);
    this.setupFieldMapInfo();
    this.pickList = [];
    this.popupContent.fieldInfos.forEach((field) => {
      this.pickList.push(this.calcitePickList(field));
    });
  }
  componentDidUpdate() {
    this.internalPopupUpdated.emit();
  }
  disconnectedCallback() {
    if (this.popupFieldManagePickList) {
      document.body.removeChild(this.popupFieldManagePickList);
    }
    if (this.popupFieldSelectionPickList) {
      document.body.removeChild(this.popupFieldSelectionPickList);
    }
  }
  // Events
  // for arcade changes
  arcadeChangeNotificationHandler() {
    this.reRender = this.reRender ? false : true;
  }
  // for attribute changes
  async attributesChangeNotificationHandler() {
    // update field infos
    this.popupContent.fieldInfos.forEach((field, index) => {
      if (this.fieldInfoMap.has(field.fieldName)) {
        this.popupContent.fieldInfos[index] = this.fieldInfoMap.get(field.fieldName).clone();
        this.popupContent.fieldInfos[index].visible = true;
      }
    });
    this.reRender = !this.reRender;
  }
  closePopupPopoversHandler() {
    if (this.popupFieldManagePickList) {
      document.body.removeChild(this.popupFieldManagePickList);
      this.popupFieldManagePickList = null;
      this.blockOptions.setFocus();
      this.disablePopupPanel.emit(false);
    }
    if (this.popupFieldSelectionPickList) {
      document.body.removeChild(this.popupFieldSelectionPickList);
      this.popupFieldSelectionPickList = null;
      this.disablePopupPanel.emit(false);
    }
  }
  calciteBlockToggleHandler() {
    this.closePopupPopovers.emit();
  }
  calciteListOrderChangeHandler(event) {
    const tempFields = event.detail;
    const tempFieldInfos = [];
    tempFields.forEach((fieldName) => {
      this.popupContent.fieldInfos.find((field) => {
        if (field.fieldName === fieldName) {
          return tempFieldInfos.push(field);
        }
      });
    });
    this.popupContent.fieldInfos = tempFieldInfos;
    this.internalPopupUpdated.emit();
  }
  // private methods and properties
  async getFieldsContent() {
    var _a, _b;
    let fieldInfos = [];
    if (this.checkForCreateFieldsContent()) {
      const [popupUtils] = await (0,_loadModules_aaf30bd6_js__WEBPACK_IMPORTED_MODULE_4__.l)(["esri/support/popupUtils"]);
      // get default from createFieldsContent
      const popupUtilsFieldInfo = (_b = popupUtils.createFieldsContent({
        fields: await (0,_commonFunctions_5262b094_js__WEBPACK_IMPORTED_MODULE_3__.j)(this.layer),
        objectIdField: this.layer.objectIdField,
        editFieldsInfo: ((_a = this.layer) === null || _a === void 0 ? void 0 : _a.editFieldsInfo) || null
      })) === null || _b === void 0 ? void 0 : _b.fieldInfos;
      // popupUtilsFieldInfo should have a subset of fieldInfoMap
      // but with differences in format and visibility
      !this.fieldInfoMap && this.setupFieldMapInfo();
      popupUtilsFieldInfo.forEach((fieldInfo) => {
        if (this.fieldInfoMap.has(fieldInfo.fieldName)) {
          const tempFieldInfo = this.fieldInfoMap.get(fieldInfo.fieldName);
          fieldInfos.push(tempFieldInfo.clone());
          fieldInfos[fieldInfos.length - 1].visible = true;
        }
      });
      // add expressions and relationship fields is visible = true
      this.popupTemplate.fieldInfos.forEach((fieldInfo) => {
        if ((fieldInfo.fieldName.includes(_commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.f.expression) ||
          fieldInfo.fieldName.includes(_commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.f.relationship)) &&
          fieldInfo.visible) {
          fieldInfos.push(fieldInfo.clone());
        }
      });
    }
    else {
      // feature reduction, 3x and default case
      this.popupTemplate.fieldInfos.forEach((fieldInfo) => {
        fieldInfo.visible && fieldInfos.push(fieldInfo.clone());
      });
    }
    return fieldInfos;
  }
  checkForCreateFieldsContent() {
    var _a, _b, _c;
    // regular feature or feature reduction
    if (this.layerDisplayType === _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.l.feature) {
      // check 1st content for 3x and default use case
      if (((_b = (_a = this.popupTemplate) === null || _a === void 0 ? void 0 : _a.content[0]) === null || _b === void 0 ? void 0 : _b.type) === "fields") {
        if ((_c = this.popupTemplate.content[0]) === null || _c === void 0 ? void 0 : _c.fieldInfos) {
          // use createFieldsContent
          return true;
        }
        else {
          // Default or coming from 3x.
          // Dont use createFieldsContent, but depend on fieldInfos
          return false;
        }
      }
      else {
        // 1st element is not field, use createFieldsContent
        return true;
      }
    }
    else {
      // feature reduction
      return false;
    }
  }
  removeBtnClick(fieldName) {
    this.closePopupPopovers.emit();
    this.popupContent.fieldInfos.find((fieldInContent, index) => {
      if (fieldInContent.fieldName === fieldName) {
        return this.popupContent.fieldInfos.splice(index, 1);
      }
    });
    this.reRender = !this.reRender;
  }
  getSelectedFields() {
    const selectedFields = [];
    this.popupContent.fieldInfos.forEach((field) => {
      selectedFields.push(field.fieldName);
    });
    return selectedFields;
  }
  // field selection for title and caption
  popupFieldSelectionPickListChanges(event, formType) {
    const selectedFieldName = event.detail.selectedFields[0];
    if (formType === "title") {
      this.contentTitle.value = addSelectedFieldAtCursor(this.contentTitle, selectedFieldName);
      this.contentTitle.setFocus();
      this.popupContent.title = this.contentTitle.value;
    }
    else if (formType === "description") {
      this.contentDescription.value = addSelectedFieldAtCursor(this.contentDescription, selectedFieldName);
      this.contentDescription.setFocus();
      this.popupContent.description = this.contentDescription.value;
    }
    this.closePopupPopovers.emit();
    this.reRender = !this.reRender;
  }
  setupFieldMapInfo() {
    this.fieldInfoMap = new Map(this.popupTemplate.fieldInfos.map((fieldInfo) => [
      fieldInfo.fieldName,
      fieldInfo
    ]));
  }
  // rendor methods
  render() {
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)(_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.H, null, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-block", { dir: (0,_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_7__.g)(this.hostElement), heading: this.strings.fieldsList, description: (this.popupContent.title &&
        `${this.popupContent.title.substring(0, 25)}${this.popupContent.title.length > 25 ? "..." : ""}`) ||
        `${this.popupContent.fieldInfos.length}/${this.popupTemplate.fieldInfos.length} ${this.strings.attributes_L}`, collapsible: true, open: this.blockOpen, dragHandle: true }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "ignore-elements-sortable", slot: "control" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-calcite-block-options", { ref: (el) => (this.blockOptions = el), guid: this.guid, intlOptions: this.strings.options, intlDelete: this.strings.delete, intlDuplicate: this.strings.duplicate, calciteBlockOptions: { hasDelete: true, hasDuplicate: true } })), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { slot: "icon" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-icon", { scale: "m", icon: "feature-details" })), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "ignore-elements-sortable" }, this.formInput("title", this.strings.title, (element) => {
      return (this.contentTitle = element);
    }, this.popupContent.title, this.strings.enterTitle
    // this.strings.titleContext.replace("${titleContext}", this.strings.attributes_L)
    ), this.formInput("description", this.strings.desc, (element) => {
      return (this.contentDescription = element);
    }, this.popupContent.description, this.strings.enterDescription
    // this.strings.descriptionContext.replace(
    //   "${descriptionContext}",
    //   this.strings.attributes_L
    // )
    ), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { class: CSS$4.manageBtn, appearance: "transparent", scale: "m", width: "full", id: "openManageAttributes_Id", onClick: this.manageBtnClick }, this.strings.selectAttributes), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-value-list", { "drag-enabled": true }, this.pickList)))));
  }
  get hostElement() { return (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.d)(this); }
};
ArcgisPopupAttributes.style = arcgisPopupAttributesCss;

const CSS$3 = {
  manageBtn: "manage-btn",
  enableColumn: "enable-column",
  enableColumnLabel: "enable-column-label",
  ColumnSwitch: "column-switch",
  normalizeBlock: "normalize-block",
  normalizeContentButtonSection: "normalize-content-btn-section",
  normalizeContentButton: "normalize-content-btn",
  normalizeContentButtonText: "normalize-content-btn-text",
  normalizeContentButtonIcon: "normalize-content-btn-icon",
  popoverChartDiv: "popover-chart-div",
  formInputButton: "form-input-button",
  chartGroup: "chart-group"
};

const arcgisPopupChartCss = ".manage-btn{justify-content:flex-end}.enable-column{background-color:var(--arcgis-app-background);display:flex;padding:var(--arcgis-app-cap-spacing-half) var(--arcgis-app-side-spacing-quarter)}.enable-column-label{display:flex;flex-flow:column nowrap;flex:1 0 0%;overflow:hidden}.column-switch{margin:0;flex:0 0 0%;justify-self:flex-end}.normalize-block{padding:0 var(--arcgis-app-side-spacing-quarter)}.normalize-content-btn-section{background-color:var(--arcgis-app-background);min-width:100%}.normalize-content-btn{background:var(--arcgis-app-background-clear);border:1px solid var(--arcgis-app-border);border-radius:var(--arcgis-app-border-radius);display:flex;align-items:center;justify-content:space-between;padding:var(--arcgis-app-cap-spacing-half) var(--arcgis-app-side-spacing-quarter);cursor:pointer;width:100%;text-align:unset;transition:background-color var(--arcgis-app-animation-time-fast) var(--arcgis-app-easing-function), border-color var(--arcgis-app-animation-time-fast) var(--arcgis-app-easing-function)}.normalize-content-btn:hover{background-color:var(--arcgis-app-background-hover);border-color:var(--arcgis-app-border-hover)}.normalize-content-btn-text{font-family:var(--arcgis-app-font-family);font-size:var(--arcgis-app-font-size-0);flex:0 1 auto;overflow:hidden;padding:0 var(--arcgis-app-side-spacing-eighth);text-overflow:ellipsis;white-space:nowrap}.normalize-content-btn-icon{flex:0 0 0%;padding:0 var(--arcgis-app-side-spacing-half)}.popover-chart-div{background-color:var(--arcgis-app-background);padding:var(--arcgis-app-cap-spacing) var(--arcgis-app-side-spacing-half);max-height:60vh}.form-input-button{display:flex}.form-input-button calcite-input[type=text]{display:flex;flex-flow:column nowrap;flex:1 0 0%;overflow:hidden}.form-input-button calcite-action{margin:0;flex:0 0 0%;justify-self:flex-end}.chart-group{margin-bottom:var(--arcgis-app-cap-spacing-half)}.color-icon{width:18px;height:18px;border-radius:90%}";

const MAX_RAMP_COLORS = 10;
const ArcgisPopupChart = class {
  constructor(hostRef) {
    (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.r)(this, hostRef);
    this.closePopupPopovers = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "closePopupPopovers", 7);
    this.chartChangedReRender = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "chartChangedReRender", 7);
    this.notifyMultiMediaChange = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "notifyMultiMediaChange", 7);
    this.lastColors = {};
    this.pickList = [];
    this.arcadeExpMap = new Map();
    this.colorNodes = [];
    this.popupFieldManagePickListChanges = (event) => {
      var _a, _b, _c, _d, _e, _f, _g, _h, _j, _k;
      const { esriLang, esriColor, rendererColors } = this;
      event.stopPropagation();
      const oldFields = this.chartMediaInfo.value.fields;
      const newFields = event.detail.selectedFields;
      this.chartMediaInfo.value.fields = newFields;
      if (this.chartMediaInfo.type === PopupMultiMediaType.lineChart) {
        if (((_a = this.chartMediaInfo.value.fields) === null || _a === void 0 ? void 0 : _a.length) && !((_b = this.chartMediaInfo.value.colors) === null || _b === void 0 ? void 0 : _b.length)) {
          const defaultScheme = this.getDefaultColorScheme();
          this.colors = [defaultScheme.colors[0]];
          this.chartMediaInfo.value.colors = esriLang.clone(this.colors);
          (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.hostElement);
        }
        else if (!((_c = this.chartMediaInfo.value.fields) === null || _c === void 0 ? void 0 : _c.length) &&
          ((_d = this.chartMediaInfo.value.colors) === null || _d === void 0 ? void 0 : _d.length)) {
          this.colors = undefined;
          this.chartMediaInfo.value.colors = undefined;
          (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.hostElement);
        }
        if ((_e = this.lastColors.rampColors) === null || _e === void 0 ? void 0 : _e.length) {
          const defaultScheme = this.getDefaultColorScheme();
          this.lastColors.rampColors = (_f = this.chartMediaInfo) === null || _f === void 0 ? void 0 : _f.value.fields.map((field, idx) => {
            var _a;
            const oldIdx = oldFields.indexOf(field);
            return ((oldIdx > -1 && ((_a = this.lastColors.rampColors) === null || _a === void 0 ? void 0 : _a[oldIdx])) ||
              new esriColor(defaultScheme.colors[idx % MAX_RAMP_COLORS]) ||
              new esriColor([0, 0, 0, 1]));
          });
        }
      }
      else {
        if ((_g = this.chartMediaInfo.value.fields) === null || _g === void 0 ? void 0 : _g.length) {
          const defaultScheme = this.getDefaultColorScheme();
          this.colors = (_h = this.chartMediaInfo) === null || _h === void 0 ? void 0 : _h.value.fields.map((fieldName, idx) => {
            var _a;
            const oldIdx = oldFields.indexOf(fieldName);
            return ((oldIdx > -1 && ((_a = this.colors) === null || _a === void 0 ? void 0 : _a[oldIdx])) ||
              (rendererColors.get(fieldName)
                ? esriLang.clone(rendererColors.get(fieldName)[0])
                : new esriColor(defaultScheme.colors[idx % MAX_RAMP_COLORS]) ||
                  new esriColor([0, 0, 0, 1])));
          });
          if ((_j = this.chartMediaInfo.value.colors) === null || _j === void 0 ? void 0 : _j.length) {
            this.chartMediaInfo.value.colors = esriLang.clone(this.colors);
          }
          else {
            // don't auto save colors on remove; update to make sure default colors still match
            this.colors = [];
            this.setColors();
            (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.hostElement);
          }
          if (oldFields === null || oldFields === void 0 ? void 0 : oldFields.length) {
            this.colorButtonNode && (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.colorButtonNode);
          }
          else {
            (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.hostElement);
          }
        }
        else {
          this.colors = undefined;
          this.chartMediaInfo.value.colors = undefined;
          (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.hostElement);
        }
      }
      this.chartChangedReRender.emit();
      if (!(oldFields === null || oldFields === void 0 ? void 0 : oldFields.length) || !((_k = this.chartMediaInfo.value.fields) === null || _k === void 0 ? void 0 : _k.length)) {
        (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.hostElement);
      }
    };
    this.fieldPickListChanges = (event) => {
      var _a, _b;
      event.stopPropagation();
      const selectedField = (_b = (_a = event.detail) === null || _a === void 0 ? void 0 : _a.selectedFields) === null || _b === void 0 ? void 0 : _b[0];
      if (selectedField) {
        this.chartMediaInfo.value.normalizeField = selectedField;
        this.chartChangedReRender.emit();
      }
      this.closePopupPopovers.emit(this.guid);
      this.normalizeBtn.focus();
    };
    // field selection for title and caption
    this.popupFieldSelectionPickListChanges = (event, formType) => {
      const selectedFieldName = event.detail.selectedFields[0];
      if (formType === "title") {
        this.editChartTitle.value = addSelectedFieldAtCursor(this.editChartTitle, selectedFieldName);
        this.chartMediaInfo.title = this.editChartTitle.value;
        this.editChartTitle.setFocus();
      }
      else if (formType === "caption") {
        this.editChartCaption.value = addSelectedFieldAtCursor(this.editChartCaption, selectedFieldName);
        this.chartMediaInfo.caption = this.editChartCaption.value;
        this.editChartCaption.setFocus();
      }
      else if (formType === "altText") {
        this.editAltText.value = addSelectedFieldAtCursor(this.editAltText, selectedFieldName);
        this.chartMediaInfo.altText = this.editAltText.value;
        this.editAltText.setFocus();
      }
      this.closePopupPopovers.emit(this.guid);
      this.chartChangedReRender.emit();
    };
    this.chartFormInput = (chartFormInputType) => {
      var _a;
      return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-label", { scale: "s" }, (() => {
        if (chartFormInputType === "title") {
          return this.strings.title;
        }
        else if (chartFormInputType === "caption") {
          return this.strings.caption;
        }
        else if (chartFormInputType === "altText") {
          return this.strings.description;
        }
      })(), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS$3.formInputButton }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-input", { type: "text", autofocus: true, ref: (element) => {
          element.addEventListener("calciteInputChange", (event) => {
            event.stopPropagation();
            const inputVal = event.target.value;
            if (chartFormInputType === "title") {
              this.chartMediaInfo.title = inputVal;
            }
            else if (chartFormInputType === "caption") {
              this.chartMediaInfo.caption = inputVal;
            }
            else if (chartFormInputType === "altText") {
              this.chartMediaInfo.altText = inputVal;
            }
            this.chartChangedReRender.emit();
          });
          if (chartFormInputType === "title") {
            return (this.editChartTitle = element);
          }
          else if (chartFormInputType === "caption") {
            return (this.editChartCaption = element);
          }
          else if (chartFormInputType === "altText") {
            return (this.editAltText = element);
          }
        }, value: (() => {
          if (chartFormInputType === "title") {
            return this.chartMediaInfo.title;
          }
          else if (chartFormInputType === "caption") {
            return this.chartMediaInfo.caption;
          }
          else if (chartFormInputType === "altText") {
            return this.chartMediaInfo.altText;
          }
        })(), placeholder: (() => {
          if (chartFormInputType === "title") {
            return this.strings.imageTitlePlaceHolder;
          }
          else if (chartFormInputType === "caption") {
            return this.strings.imageCaptionPlaceHolder;
          }
          else if (chartFormInputType === "altText") {
            return this.strings.describeChart;
          }
        })(), onClick: () => this.closePopupPopovers.emit(this.guid) }), ((_a = this.popupTemplate.fieldInfos) === null || _a === void 0 ? void 0 : _a.length) > 0 && ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { text: this.strings.attributes, "text-display": "hidden", onClick: () => {
          var _a;
          this.closePopupPopovers.emit(this.guid);
          (_a = this.colorButtonNode) === null || _a === void 0 ? void 0 : _a.closePopover();
          this.closeColorPopover();
          if (!this.popupFieldSelectionPickList) {
            this.popupFieldSelectionPickList = document.createElement("arcgis-popup-field-pick-list");
            this.popupFieldSelectionPickList.popoverProps = {
              refElement: this.panelElement
            };
            this.popupFieldSelectionPickList.multiple = false;
            this.popupFieldSelectionPickList.heading = this.strings.addField;
            this.popupFieldSelectionPickList.addEventListener("arcgisPopupPickListDismissed", () => {
              this.closePopupPopovers.emit(this.guid);
            });
            this.popupFieldSelectionPickList.addEventListener("arcgisPopupPickListChange", (event) => this.popupFieldSelectionPickListChanges(event, chartFormInputType));
            document.body.appendChild(this.popupFieldSelectionPickList);
            this.panelElement.disabled = true;
          }
        }, scale: "s", icon: "brackets-curly" })))));
    };
    this.calcitePickList = (field, idx) => ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-list-item", { key: field.fieldName, label: (0,_commonFunctions_5262b094_js__WEBPACK_IMPORTED_MODULE_3__.b)(field, this.arcadeExpMap), value: field.fieldName }, this.renderColorIcon(idx), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { slot: "actions-end", appearance: "transparent", text: this.strings.remove, onClick: () => {
        var _a, _b, _c;
        this.closePopupPopovers.emit(this.guid);
        (_a = this.colorButtonNode) === null || _a === void 0 ? void 0 : _a.closePopover();
        this.closeColorPopover();
        if ((_b = this.chartMediaInfo.value.colors) === null || _b === void 0 ? void 0 : _b.length) {
          this.chartMediaInfo.value.fields.forEach((fieldName, idx) => {
            var _a;
            if (fieldName === field.fieldName) {
              this.chartMediaInfo.value.fields.splice(idx, 1);
              if (this.chartMediaInfo.type !== PopupMultiMediaType.lineChart) {
                this.chartMediaInfo.value.colors.splice(idx, 1);
                this.colors.splice(idx, 1);
                this.colorButtonNode && (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.colorButtonNode);
              }
              if ((_a = this.lastColors.rampColors) === null || _a === void 0 ? void 0 : _a.length) {
                this.lastColors.rampColors.splice(idx, 1);
              }
            }
          });
        }
        else {
          this.chartMediaInfo.value.fields.forEach((fieldName, idx) => {
            if (fieldName === field.fieldName) {
              this.chartMediaInfo.value.fields.splice(idx, 1);
            }
          });
          // don't auto save colors on remove/add; update to make sure default colors still match
          this.colors = [];
          this.setColors();
          (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.hostElement);
        }
        this.chartChangedReRender.emit();
        if (!((_c = this.chartMediaInfo.value.fields) === null || _c === void 0 ? void 0 : _c.length)) {
          (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.hostElement);
        }
      } }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-icon", { scale: "s", icon: "x" }))));
    this.guid = undefined;
    this.chartMediaInfo = undefined;
    this.mediaContent = undefined;
    this.mediaIndexPosition = undefined;
    this.refElement = undefined;
    this.isOpen = false;
    this.reRender = undefined;
  }
  // lifecycle methods
  async componentWillLoad() {
    var _a;
    this.layer = _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.layer;
    this.mapView = _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.mapView;
    this.strings = _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.strings;
    this.popupTemplate = _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.popupTemplate;
    this.layerDisplayType = _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.layerDisplayType;
    this.chartMediaInfo.title = this.chartMediaInfo.title || "";
    this.chartMediaInfo.altText = this.chartMediaInfo.altText || "";
    this.chartMediaInfo.caption = this.chartMediaInfo.caption || "";
    const [esriLang, esriColor, pieChartSchemes, rendererUtils] = await (0,_loadModules_aaf30bd6_js__WEBPACK_IMPORTED_MODULE_4__.l)([
      "esri/core/lang",
      "esri/Color",
      "esri/smartMapping/symbology/pieChart",
      "esri/renderers/support/utils"
    ]);
    this.esriLang = esriLang;
    this.esriColor = esriColor;
    this.pieChartSchemes = pieChartSchemes;
    this.rendererUtils = rendererUtils;
    if ("renderer" in this.layer) {
      let renderer;
      if (this.layerDisplayType === _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.l.cluster) {
        renderer = this.layer.featureReduction.renderer;
      }
      else {
        renderer = this.layer.renderer;
      }
      if (["class-breaks", "dot-density", "heatmap", "pie-chart", "simple", "unique-value"].indexOf(renderer.type) > -1) {
        this.rendererColors = await this.rendererUtils.getColorsFromRenderer(renderer);
      }
    }
    this.colors = esriLang.clone((_a = this.chartMediaInfo) === null || _a === void 0 ? void 0 : _a.value.colors) || [];
    this.setColors();
  }
  componentDidLoad() {
    this.isOpen = true;
    // need timeout because of re-render
    setTimeout(() => requestAnimationFrame(() => this.panelElement.setFocus()), 300);
  }
  async componentWillRender() {
    this.fieldInfoMap = new Map(this.popupTemplate.fieldInfos.map((fieldInfo) => [
      fieldInfo.fieldName,
      fieldInfo
    ]));
    this.layerFieldsMap = await (0,_commonFunctions_5262b094_js__WEBPACK_IMPORTED_MODULE_3__.d)(this.layer);
    this.arcadeExpMap = (0,_commonFunctions_5262b094_js__WEBPACK_IMPORTED_MODULE_3__.e)(this.popupTemplate);
    this.pickList = [];
    this.chartMediaInfo.value.fields.forEach((field, idx) => {
      var _a, _b;
      if (this.fieldInfoMap.has(field)) {
        const currentFieldInfo = this.fieldInfoMap.get(field);
        this.pickList.push(this.calcitePickList(currentFieldInfo, idx));
      }
      else {
        // field does not exist anymore, remove
        this.chartMediaInfo.value.fields.splice(idx, 1);
        if (this.chartMediaInfo.type !== PopupMultiMediaType.lineChart) {
          if ((_a = this.chartMediaInfo.value.colors) === null || _a === void 0 ? void 0 : _a.length) {
            this.chartMediaInfo.value.colors.splice(idx, 1);
            this.colors.splice(idx, 1);
          }
          else {
            const defaultScheme = this.getDefaultColorScheme();
            this.colors = (_b = this.chartMediaInfo) === null || _b === void 0 ? void 0 : _b.value.fields.map((fieldName, idx) => {
              var _a;
              return this.rendererColors.get(fieldName)
                ? this.esriLang.clone(this.rendererColors.get(fieldName)[0])
                : ((_a = this.colors) === null || _a === void 0 ? void 0 : _a[idx]) ||
                  new this.esriColor(defaultScheme.colors[idx % MAX_RAMP_COLORS]) ||
                  new this.esriColor([0, 0, 0, 1]);
            });
          }
        }
      }
    });
  }
  componentDidUpdate() {
    this.notifyMultiMediaChange.emit({
      guid: this.guid,
      mediaIndexPosition: this.mediaIndexPosition
    });
    this.chartPopover.reposition();
  }
  disconnectedCallback() {
    var _a;
    if (this.popupFieldSelectionPickList) {
      document.body.removeChild(this.popupFieldSelectionPickList);
    }
    if (this.popupFieldManagePickList) {
      document.body.removeChild(this.popupFieldManagePickList);
    }
    if (this.arcgisFieldPickList) {
      document.body.removeChild(this.arcgisFieldPickList);
    }
    (_a = this.colorButtonNode) === null || _a === void 0 ? void 0 : _a.closePopover();
  }
  // Public Methods
  async reposition() {
    this.chartPopover.reposition();
  }
  // Events
  chartChangedReRenderHandler(event) {
    event.stopPropagation();
    this.reRender = this.reRender ? false : true;
  }
  closePopupPopoversHandler() {
    this.removeAttributesSelectionPopover();
  }
  closeMultiMediaPopoverHandler() {
    this.removeAttributesSelectionPopover();
  }
  // arcade changes
  arcadeChangeNotificationHandler() {
    this.chartChangedReRender.emit();
  }
  // private methods and properties
  removeAttributesSelectionPopover() {
    if (this.popupFieldSelectionPickList) {
      document.body.removeChild(this.popupFieldSelectionPickList);
      this.popupFieldSelectionPickList = null;
    }
    if (this.popupFieldManagePickList) {
      document.body.removeChild(this.popupFieldManagePickList);
      this.popupFieldManagePickList = null;
    }
    if (this.arcgisFieldPickList) {
      document.body.removeChild(this.arcgisFieldPickList);
      this.arcgisFieldPickList = null;
    }
    if (this.colorPopoverNode) {
      document.body.removeChild(this.colorPopoverNode);
      this.colorPopoverNode = null;
    }
    this.panelElement.disabled = false;
  }
  async chartSelection(chartType) {
    const [BarChartMediaInfo, ColumnChartMediaInfo, LineChartMediaInfo, PieChartMediaInfo] = await (0,_loadModules_aaf30bd6_js__WEBPACK_IMPORTED_MODULE_4__.l)([
      "esri/popup/content/BarChartMediaInfo",
      "esri/popup/content/ColumnChartMediaInfo",
      "esri/popup/content/LineChartMediaInfo",
      "esri/popup/content/PieChartMediaInfo"
    ]);
    let chartElement = null;
    if (chartType === PopupMultiMediaType.barChart) {
      chartElement = new BarChartMediaInfo({
        title: this.chartMediaInfo.title,
        caption: this.chartMediaInfo.caption,
        value: this.chartMediaInfo.value,
        altText: this.chartMediaInfo.altText
      });
    }
    if (chartType === PopupMultiMediaType.columnChart) {
      chartElement = new ColumnChartMediaInfo({
        title: this.chartMediaInfo.title,
        caption: this.chartMediaInfo.caption,
        value: this.chartMediaInfo.value,
        altText: this.chartMediaInfo.altText
      });
    }
    if (chartType === PopupMultiMediaType.lineChart) {
      chartElement = new LineChartMediaInfo({
        title: this.chartMediaInfo.title,
        caption: this.chartMediaInfo.caption,
        value: this.chartMediaInfo.value,
        altText: this.chartMediaInfo.altText
      });
    }
    if (chartType === PopupMultiMediaType.pieChart) {
      chartElement = new PieChartMediaInfo({
        title: this.chartMediaInfo.title,
        caption: this.chartMediaInfo.caption,
        value: this.chartMediaInfo.value,
        altText: this.chartMediaInfo.altText
      });
    }
    this.chartMediaInfo = chartElement.clone();
    this.mediaContent.mediaInfos[this.mediaIndexPosition] = this.chartMediaInfo;
    this.chartChangedReRender.emit();
  }
  getSummaryString() {
    if (this.chartMediaInfo.type === PopupMultiMediaType.barChart) {
      return this.strings.bar;
    }
    if (this.chartMediaInfo.type === PopupMultiMediaType.columnChart) {
      return this.strings.column;
    }
    if (this.chartMediaInfo.type === PopupMultiMediaType.lineChart) {
      return this.strings.line;
    }
    if (this.chartMediaInfo.type === PopupMultiMediaType.pieChart) {
      return this.strings.pie;
    }
  }
  // rendor methods
  render() {
    var _a, _b;
    const hasFields = !!((_a = this.chartMediaInfo.value.fields) === null || _a === void 0 ? void 0 : _a.length);
    const chartGroup = ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-segmented-control", { width: "full", scale: "s", class: CSS$3.chartGroup, onCalciteSegmentedControlChange: async (event) => {
        var _a;
        (_a = this.colorButtonNode) === null || _a === void 0 ? void 0 : _a.closePopover();
        this.closeColorPopover();
        const node = event.target;
        const selectedItem = node.selectedItem;
        if ((this.chartMediaInfo.type === PopupMultiMediaType.lineChart &&
          selectedItem.value !== PopupMultiMediaType.lineChart) ||
          (this.chartMediaInfo.type !== PopupMultiMediaType.lineChart &&
            selectedItem.value === PopupMultiMediaType.lineChart)) {
          const savedColors = this.chartMediaInfo.value.colors;
          if (this.chartMediaInfo.type === PopupMultiMediaType.lineChart) {
            this.lastColors.lineColors = savedColors && this.esriLang.clone(savedColors);
            this.colors = undefined;
            this.chartMediaInfo.value.colors = undefined;
          }
          else {
            this.lastColors.rampColors = savedColors && this.esriLang.clone(savedColors);
            if (selectedItem.value === PopupMultiMediaType.lineChart) {
              this.colors = undefined;
              this.chartMediaInfo.value.colors = undefined;
            }
          }
        }
        if (selectedItem.value !== this.chartMediaInfo.type) {
          // bar and column are in same radio group
          !(selectedItem.value === PopupMultiMediaType.columnChart &&
            this.chartMediaInfo.type === PopupMultiMediaType.barChart) && (await this.chartSelection(selectedItem.value));
        }
        this.setColors();
      } }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-segmented-control-item", { value: PopupMultiMediaType.columnChart, iconStart: "graph-bar", checked: this.chartMediaInfo.type === PopupMultiMediaType.columnChart ||
        this.chartMediaInfo.type === PopupMultiMediaType.barChart }, this.strings.bar), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-segmented-control-item", { value: PopupMultiMediaType.lineChart, iconStart: "graph-time-series", checked: this.chartMediaInfo.type === PopupMultiMediaType.lineChart }, this.strings.line), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-segmented-control-item", { value: PopupMultiMediaType.pieChart, iconStart: "pie-chart", checked: this.chartMediaInfo.type === PopupMultiMediaType.pieChart }, this.strings.pie)));
    const colorButton = ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-popup-color-button", { chartMediaInfo: this.chartMediaInfo, colors: this.colors, popoverReferenceElement: this.panelElement, onArcgisPopupColorButtonChange: ({ detail: colors }) => {
        this.colors = colors;
        // once the user makes a change we save all colors
        this.chartMediaInfo.value.colors = this.esriLang.clone(colors);
        this.chartChangedReRender.emit();
      }, onArcgisPopupColorButtonBeforeOpen: () => this.closeColorPopover(), ref: (node) => (this.colorButtonNode = node) }));
    const resetButton = ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-label", { layout: "inline-space-between" }, this.strings.resetColors, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { appearance: "transparent", text: this.strings.resetColors, disabled: !((_b = this.chartMediaInfo.value.colors) === null || _b === void 0 ? void 0 : _b.length), onClick: () => {
        var _a;
        (_a = this.colorButtonNode) === null || _a === void 0 ? void 0 : _a.closePopover();
        this.closeColorPopover();
        this.chartMediaInfo.value.colors = null;
        this.colors = [];
        if (this.chartMediaInfo.type === PopupMultiMediaType.lineChart) {
          this.lastColors.lineColors = undefined;
        }
        else {
          this.lastColors.rampColors = undefined;
        }
        this.setColors();
        (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.hostElement);
      } }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-icon", { scale: "s", icon: "reset" }))));
    // manage button and list of selected fields
    const fieldList = ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", null, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { class: CSS$3.manageBtn, appearance: "transparent", scale: "m", width: "full", onClick: async (event) => {
        var _a, _b, _c;
        event.stopPropagation();
        this.closePopupPopovers.emit(this.guid);
        (_a = this.colorButtonNode) === null || _a === void 0 ? void 0 : _a.closePopover();
        this.closeColorPopover();
        if (!this.popupFieldManagePickList) {
          this.popupFieldManagePickList = document.createElement("arcgis-popup-field-pick-list");
          this.popupFieldManagePickList.popoverProps = {
            refElement: this.panelElement
          };
          this.popupFieldManagePickList.selectedFields =
            ((_c = (_b = this.chartMediaInfo) === null || _b === void 0 ? void 0 : _b.value) === null || _c === void 0 ? void 0 : _c.fields) || [];
          this.popupFieldManagePickList.showCancel = false;
          this.popupFieldManagePickList.multiple = true;
          this.popupFieldManagePickList.heading = this.strings.selectFields;
          this.popupFieldManagePickList.okBtnText = this.strings.done;
          this.popupFieldManagePickList.numbersOnly = true;
          this.popupFieldManagePickList.addEventListener("arcgisPopupPickListDismissed", () => {
            this.closePopupPopovers.emit(this.guid);
          });
          this.popupFieldManagePickList.addEventListener("arcgisPopupPickListChange", this.popupFieldManagePickListChanges);
          document.body.appendChild(this.popupFieldManagePickList);
          this.panelElement.disabled = true;
        }
      } }, this.strings.selectAttributes), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-list", { "drag-enabled": true, onCalciteListOrderChange: async (event) => {
        var _a, _b;
        event.stopPropagation();
        const allItems = event.target.querySelectorAll("calcite-list-item");
        const newIndexOrder = [];
        allItems.forEach((item) => {
          this.chartMediaInfo.value.fields.forEach((field, idx) => {
            if (item.value === field) {
              newIndexOrder.push(idx);
            }
          });
        });
        if (this.chartMediaInfo.type === PopupMultiMediaType.lineChart) {
          this.chartMediaInfo.value.fields = Array.from(allItems).map((item) => item.value);
        }
        else {
          if (!((_a = this.chartMediaInfo.value.colors) === null || _a === void 0 ? void 0 : _a.length)) {
            // once the user makes a re-order change we save all colors
            this.chartMediaInfo.value.colors = this.esriLang.clone(this.colors);
          }
          const newFields = [];
          const newColors = [];
          newIndexOrder.forEach((idx) => {
            newFields.push(this.chartMediaInfo.value.fields[idx]);
            newColors.push(this.esriLang.clone(this.chartMediaInfo.value.colors[idx]));
          });
          this.chartMediaInfo.value.fields = newFields;
          this.colors = newColors;
          // we save colors on re-order
          this.chartMediaInfo.value.colors = this.esriLang.clone(newColors);
        }
        if ((_b = this.lastColors.rampColors) === null || _b === void 0 ? void 0 : _b.length) {
          const rampColors = [];
          newIndexOrder.forEach((idx) => {
            rampColors.push(this.lastColors.rampColors[idx]);
          });
          this.lastColors.rampColors = rampColors;
        }
        this.chartChangedReRender.emit();
      } }, this.pickList)));
    // bar chart checkbox only under default column-chart
    const barChart = (this.chartMediaInfo.type === PopupMultiMediaType.barChart ||
      this.chartMediaInfo.type === PopupMultiMediaType.columnChart) && ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("section", { class: CSS$3.enableColumn }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("label", { class: CSS$3.enableColumnLabel }, this.strings.horizontalOrientation), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-switch", { scale: "s", class: CSS$3.ColumnSwitch, checked: this.chartMediaInfo.type === PopupMultiMediaType.barChart ? true : false, onCalciteSwitchChange: async (event) => {
        var _a;
        await this.chartSelection(((_a = event.target) === null || _a === void 0 ? void 0 : _a.checked)
          ? PopupMultiMediaType.barChart
          : PopupMultiMediaType.columnChart);
      } })));
    const normalizeField = ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-block-section", { class: CSS$3.normalizeBlock, text: this.strings.normalize, toggleDisplay: "switch", open: this.chartMediaInfo.value.normalizeField ? true : false, onCalciteBlockSectionToggle: (event) => {
        if (event.target.open) {
          this.chartMediaInfo.value.normalizeField = this.tempNormalizedField;
        }
        else {
          this.tempNormalizedField = this.chartMediaInfo.value.normalizeField;
          this.chartMediaInfo.value.normalizeField = "";
        }
        this.chartChangedReRender.emit();
      } }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS$3.normalizeContentButtonSection }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("button", { ref: (el) => (this.normalizeBtn = el), class: CSS$3.normalizeContentButton, title: this.strings.normalizeBy, onClick: (event) => {
        var _a;
        event.stopPropagation();
        this.closePopupPopovers.emit(this.guid);
        (_a = this.colorButtonNode) === null || _a === void 0 ? void 0 : _a.closePopover();
        this.closeColorPopover();
        // lazy load attribute selection component
        if (!this.arcgisFieldPickList) {
          this.arcgisFieldPickList = document.createElement("arcgis-popup-field-pick-list");
          this.arcgisFieldPickList.popoverProps = {
            refElement: this.panelElement
          };
          this.arcgisFieldPickList.selectedFields = [
            this.chartMediaInfo.value.normalizeField
          ];
          this.arcgisFieldPickList.numbersOnly = true;
          this.arcgisFieldPickList.addEventListener("arcgisPopupPickListDismissed", this.fieldPickListChanges);
          document.body.appendChild(this.arcgisFieldPickList);
          this.panelElement.disabled = true;
        }
      } }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("span", { class: CSS$3.normalizeContentButtonText }, this.fieldInfoMap.has(this.chartMediaInfo.value.normalizeField)
      ? (0,_commonFunctions_5262b094_js__WEBPACK_IMPORTED_MODULE_3__.b)(this.fieldInfoMap.get(this.chartMediaInfo.value.normalizeField), this.arcadeExpMap)
      : this.strings.normalizeBy), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("span", { class: CSS$3.normalizeContentButtonIcon }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-icon", { scale: "s", icon: "pencil" }))))));
    const doneBtn = ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { appearance: "outline-fill", scale: "m", slot: "footer", width: "full", onClick: () => this.closePopupPopovers.emit() }, this.strings.done));
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)(_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.H, { class: "js-app-flyout" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-popover", { dir: (0,_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_7__.g)(this.hostElement), ref: (element) => (this.chartPopover = element), placement: "leading-start", open: this.isOpen, pointerDisabled: true, referenceElement: this.refElement, offsetDistance: -Math.round(this.refElement.getBoundingClientRect().width), offsetSkidding: 50, label: "", style: {
        zIndex: "100"
      }, triggerDisabled: true }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-panel", { ref: (element) => (this.panelElement = element), closable: true, style: {
        width: `${this.refElement.getBoundingClientRect().width}px`
      }, onCalcitePanelClose: () => this.closePopupPopovers.emit() }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { slot: "header-content" }, this.strings.configureChart), doneBtn, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS$3.popoverChartDiv }, chartGroup, this.chartFormInput("title"), this.chartFormInput("caption"), this.chartFormInput("altText"), hasFields && colorButton, hasFields && resetButton, fieldList, barChart, normalizeField)))));
  }
  renderColorIcon(index) {
    const { strings, selectedFieldIdx, colors } = this;
    if (this.chartMediaInfo.type === PopupMultiMediaType.lineChart) {
      return;
    }
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "color-icon", style: { backgroundColor: colors[index].toHex() }, slot: "content-start", onClick: () => this.openColorPicker(index), role: "button", tabIndex: 0, "aria-label": strings.changeColor, "aria-haspopup": "true", "aria-expanded": selectedFieldIdx === index, onKeyUp: (event) => {
        if (event.key === " " || event.key === "Enter") {
          this.openColorPicker(index);
        }
      }, ref: (node) => {
        this.colorNodes[index] = node;
      } }));
  }
  openColorPicker(index) {
    var _a;
    const { colors, strings, esriColor } = this;
    (_a = this.colorButtonNode) === null || _a === void 0 ? void 0 : _a.closePopover();
    this.closeColorPopover();
    this.selectedFieldIdx = index;
    const popover = document.createElement("arcgis-popup-color-popover");
    popover.heading = strings.selectColor;
    popover.intlDone = strings.done;
    popover.label = strings.selectColor;
    popover.hexColor = colors[index].toHex();
    popover.popoverProps = {
      placement: "leading-start",
      offsetDistance: 1,
      offsetSkidding: 52,
      pointerDisabled: "true",
      popoverWidth: 315,
      //overlayPositioning: "fixed", -- buggy, offset issue
      refElement: this.chartPopover
    };
    popover.addEventListener("arcgisPopupColorPopoverClose", () => {
      this.selectedFieldIdx = undefined;
      this.colorPopoverNode = null;
    });
    popover.addEventListener("arcgisPopupColorPopoverChange", ({ detail: hexColor }) => {
      colors[index] = new esriColor(hexColor);
      // once the user makes a change we save all colors
      this.chartMediaInfo.value.colors = this.esriLang.clone(colors);
      this.chartChangedReRender.emit();
      (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.colorButtonNode);
    });
    document.body.appendChild(popover);
    popover.setOpen(true);
    this.colorPopoverNode = popover;
    //popover.addEventListener("arcgisPopupColorPopoverOpen", () => {});
  }
  setColors() {
    var _a, _b, _c, _d, _e, _f;
    const { esriColor, lastColors, rendererColors } = this;
    if (this.chartMediaInfo.type === PopupMultiMediaType.lineChart) {
      if (!((_a = this.colors) === null || _a === void 0 ? void 0 : _a.length) && lastColors.lineColors) {
        this.colors = lastColors.lineColors;
        this.chartMediaInfo.value.colors = this.esriLang.clone(this.colors);
      }
      if (!((_b = this.colors) === null || _b === void 0 ? void 0 : _b.length)) {
        const defaultScheme = this.getDefaultColorScheme();
        this.colors = [defaultScheme.colors[0]];
      }
      else if (this.colors.length > 1) {
        this.colors = [this.colors[0]];
      }
    }
    else {
      if (!((_c = this.colors) === null || _c === void 0 ? void 0 : _c.length) && lastColors.rampColors) {
        this.colors = this.esriLang.clone(lastColors.rampColors);
        this.chartMediaInfo.value.colors = this.esriLang.clone(this.colors);
      }
      if (!((_d = this.colors) === null || _d === void 0 ? void 0 : _d.length) || this.colors.length !== ((_e = this.chartMediaInfo) === null || _e === void 0 ? void 0 : _e.value.fields.length)) {
        const defaultScheme = this.getDefaultColorScheme();
        this.colors = (_f = this.chartMediaInfo) === null || _f === void 0 ? void 0 : _f.value.fields.map((fieldName, idx) => {
          var _a;
          return rendererColors.get(fieldName)
            ? this.esriLang.clone(rendererColors.get(fieldName)[0])
            : ((_a = this.colors) === null || _a === void 0 ? void 0 : _a[idx]) ||
              new esriColor(defaultScheme.colors[idx % MAX_RAMP_COLORS]) ||
              new esriColor([0, 0, 0, 1]);
        });
      }
    }
  }
  getDefaultColorScheme() {
    const schemes = this.pieChartSchemes.getSchemes({
      basemap: this.mapView.map.basemap,
      geometryType: "polygon",
      numColors: Math.min(MAX_RAMP_COLORS, this.chartMediaInfo.value.fields.length)
    });
    return ([schemes.primaryScheme]
      .concat(schemes.secondarySchemes)
      .find((scheme) => scheme.name === "Olympic Sunset") ||
      schemes.primaryScheme);
  }
  closeColorPopover() {
    if (this.colorPopoverNode) {
      document.body.removeChild(this.colorPopoverNode);
      this.colorPopoverNode = null;
    }
  }
  get hostElement() { return (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.d)(this); }
};
ArcgisPopupChart.style = arcgisPopupChartCss;

const ArcgisPopupExpressions = class {
  constructor(hostRef) {
    (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.r)(this, hostRef);
    this.arcadeChangeNotification = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "arcadeChangeNotification", 7);
    this.internalPopupUpdated = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "internalPopupUpdated", 7);
    this.valueList = [];
    this.filterLength = 5;
    // rendor methods
    this.calciteValueList = (arcadeField) => ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-value-list-item", { label: arcadeField.title, description: `{${_commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.f.expression}${arcadeField.name}}`, value: arcadeField.name, metadata: {
        title: arcadeField.title,
        name: `{${_commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.f.expression}${arcadeField.name}}`
      }, onClick: (event) => this.launchArcade(event, arcadeField) }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { slot: "actions-end", appearance: "transparent", text: this.strings.remove, onClick: (event) => this.removeBtnClick(event, arcadeField.name) }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-icon", { scale: "s", icon: "x" }))));
    this.reRender = undefined;
  }
  componentWillLoad() {
    this.layer = _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.layer;
    this.mapView = _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.mapView;
    this.portal = _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.portal;
    this.config = _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.config;
    this.strings = _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.strings;
    this.currentLanguage = _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.currentLanguage;
    this.serviceType = _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.serviceType;
    this.popupTemplate = _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.popupTemplate;
    this.layerDisplayType = _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.layerDisplayType;
  }
  // lifecycle methods
  async componentDidLoad() {
    await this.loadAllModules();
  }
  componentWillRender() {
    var _a;
    this.valueList = [];
    if ((_a = this.popupTemplate.expressionInfos) === null || _a === void 0 ? void 0 : _a.length) {
      this.popupTemplate.expressionInfos.forEach((arcadeField) => {
        this.valueList.push(this.calciteValueList(arcadeField));
      });
    }
  }
  // Public Methods
  async setFocus() {
    this.expressionFlowItem.setFocus();
  }
  // private methods and properties
  async loadAllModules() {
    [this.FieldInfo, this.PopupExpressionInfo] = await (0,_loadModules_aaf30bd6_js__WEBPACK_IMPORTED_MODULE_4__.l)([
      "esri/popup/FieldInfo",
      "esri/popup/ExpressionInfo"
    ]);
  }
  async launchArcade(event, currentExpression) {
    event.stopPropagation();
    if (!this.arcadeEditor) {
      this.expressionFlowItem.disabled = true;
      this.arcadeEditor = document.createElement("arcgis-modal-arcade");
      this.arcadeEditor.arcadeScript = getArcadeScript(currentExpression === null || currentExpression === void 0 ? void 0 : currentExpression.expression, this.layerDisplayType, this.strings);
      this.arcadeEditor.arcadeProfile = await getArcadeProfile(this.layer, this.mapView, this.serviceType, this.popupTemplate, this.layerDisplayType);
      this.arcadeEditor.testData = await getTestData(this.layer, this.mapView, this.layerDisplayType, this.popupTemplate);
      this.arcadeEditor.addExistingExpressions = true;
      this.arcadeEditor.layer = this.layer;
      this.arcadeEditor.arcadeTitle = (currentExpression === null || currentExpression === void 0 ? void 0 : currentExpression.title) || this.strings.arcadeDefaultTitle;
      this.arcadeEditor.arcadeTitleEditable = true;
      this.arcadeEditor.arcadeTitleEditingEnabled = !(currentExpression === null || currentExpression === void 0 ? void 0 : currentExpression.title);
      document.body.appendChild(this.arcadeEditor);
      this.arcadeEditor.addEventListener("arcgisModalArcadeClose", (event) => {
        this.arcadeSetup(event.detail, currentExpression);
        setTimeout(() => this.fabButtonNode.setFocus(), 300);
      });
    }
  }
  async arcadeSetup(arcadeObject, currentExpression) {
    if (arcadeObject) {
      setExpressionInfoInPopupTemplate(arcadeObject, currentExpression === null || currentExpression === void 0 ? void 0 : currentExpression.name, this.PopupExpressionInfo, this.popupTemplate);
      await this.popupExpressionSetup();
    }
    this.expressionFlowItem.disabled = false;
    document.body.removeChild(this.arcadeEditor);
    this.arcadeEditor = null;
  }
  // update master field info and emit for attributes re-render, self re-render and update popup
  async popupExpressionSetup() {
    await setLayerExpressionAndFieldInfo(this.popupTemplate, this.layerDisplayType, this.layer, this.FieldInfo);
    this.arcadeChangeNotification.emit();
    this.internalPopupUpdated.emit();
    this.reRender = !this.reRender;
  }
  removeBtnClick(event, fieldName) {
    event.stopPropagation();
    this.popupTemplate.expressionInfos.find((exp, index) => {
      if (exp.name === fieldName) {
        return this.popupTemplate.expressionInfos.splice(index, 1);
      }
    });
    this.popupExpressionSetup();
  }
  render() {
    var _a;
    const addExpressionBtn = ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-fab", { slot: "fab", class: "fab", icon: "plus", scale: "s", appearance: "outline-fill", kind: "neutral", label: this.strings.addExpression, text: this.strings.addExpression, "text-enabled": true, onClick: (event) => this.launchArcade(event), ref: (node) => (this.fabButtonNode = node) }));
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)(_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.H, { class: "calcite-match-height" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-flow-item", { dir: (0,_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_7__.g)(this.hostElement), heading: this.strings.manageExpressions, ref: (node) => (this.expressionFlowItem = node) }, ((_a = this.popupTemplate.expressionInfos) === null || _a === void 0 ? void 0 : _a.length) > 0 && ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-value-list", { filterEnabled: this.valueList.length >= this.filterLength ? true : false }, this.valueList)), addExpressionBtn)));
  }
  get hostElement() { return (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.d)(this); }
};

const arcgisPopupFieldPickListCss = ".popover{z-index:100}.panel{min-height:300px}.content{max-height:calc(60vh - 142px);}.selection-button-div{padding:4px 10px}.footer{width:100%}.expression-actions{display:flex}.add-expression-button{margin:4px 0 8px}";

const ArcgisPopupFieldPickList = class {
  constructor(hostRef) {
    (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.r)(this, hostRef);
    this.arcgisPopupPickListDismissed = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "arcgisPopupPickListDismissed", 7);
    this.arcgisPopupPickListChange = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "arcgisPopupPickListChange", 7);
    this.arcadeChangeNotification = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "arcadeChangeNotification", 7);
    this.arcadeExpMap = new Map();
    this.calciteFieldOnlyValueList = (field) => ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-pick-list-item", { key: field.name, label: field.alias || field.name, value: field.name, description: `{${field.name}}`, selected: (!this.multiple && field.name === this.selectedFields[0]) ||
        (this.multiple && this.selectedFields.indexOf(field.name) > -1), metadata: {
        label: field.alias,
        fieldName: field.name
      } }, this.layerDisplayType === _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.l.feature &&
      !field.name.includes(_commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.f.relationship) && ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { slot: "actions-end", text: this.strings.info, title: this.strings.info, scale: "s", icon: "information", onClick: (event) => {
        var _a;
        event.stopPropagation();
        const action = event.target;
        const fieldInfoFlowItem = document.createElement("calcite-flow-item");
        fieldInfoFlowItem.heading = (_a = field.alias) !== null && _a !== void 0 ? _a : field.name;
        fieldInfoFlowItem.description = field.name;
        const fieldInfo = document.createElement("arcgis-field-info");
        fieldInfo.lang = this.currentLanguageIntl;
        fieldInfo.fieldName = field.name;
        fieldInfo.layer = this.layer;
        fieldInfo.view = this.mapView;
        fieldInfo.classList.add("content");
        fieldInfoFlowItem.addEventListener("calciteFlowItemBack", () => requestAnimationFrame(() => action.setFocus()));
        fieldInfoFlowItem.appendChild(fieldInfo);
        this.flowElement.appendChild(fieldInfoFlowItem);
        setTimeout(() => fieldInfoFlowItem.setFocus(), 200);
      } }))));
    this.calciteExpressionsOnlyValueList = (field) => ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-pick-list-item", { key: field.name, label: field.alias || field.name, value: field.name, description: `{${field.name}}`, selected: (!this.multiple && field.name === this.selectedFields[0]) ||
        (this.multiple && this.selectedFields.indexOf(field.name) > -1), metadata: {
        label: field.alias,
        fieldName: field.name
      } }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "expression-actions", slot: "actions-end" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { text: this.strings.edit, title: this.strings.edit, scale: "s", icon: this.numbersOnly && field.type.toLowerCase() !== _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.a.number
        ? "exclamation-mark-triangle"
        : "pencil", onClick: () => {
        if (this.arcadeExpMap.has(field.name)) {
          this.launchArcade(this.arcadeExpMap.get(field.name));
        }
      } }), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { text: this.strings.remove, title: this.strings.remove, scale: "s", icon: "trash", onClick: async () => {
        this.popupTemplate.expressionInfos.find((exp, index) => {
          if (field.name.includes(`/${exp.name}`)) {
            return this.popupTemplate.expressionInfos.splice(index, 1);
          }
        });
        await setLayerExpressionAndFieldInfo(this.popupTemplate, this.layerDisplayType, this.layer, this.FieldInfo);
        this.fields = this.fields.filter((currField) => {
          return currField.name !== field.name;
        });
        this.selectedFields = [...this.selectedFields].filter((fieldName) => {
          return fieldName !== field.name;
        });
        this.multiple &&
          this.arcgisPopupPickListChange.emit({
            selectedFields: [...new Set(this.selectedFields)]
          });
        this.arcadeChangeNotification.emit();
      } }))));
    this.selectedFields = [];
    this.popoverProps = undefined;
    this.showCancel = true;
    this.multiple = false;
    this.heading = undefined;
    this.okBtnText = undefined;
    this.showFilterLength = 5;
    this.numbersOnly = false;
    this.lastSortyBy = _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.L.default;
    this.filterFields = null;
    this.arcadeEditor = undefined;
  }
  // --------------------------------------------------------------------------
  //
  //  Lifecycle
  //
  // --------------------------------------------------------------------------
  async componentWillLoad() {
    this.layer = _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.layer;
    this.mapView = _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.mapView;
    this.portal = _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.portal;
    this.config = _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.config;
    this.strings = _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.strings;
    this.currentLanguage = _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.currentLanguage;
    this.currentLanguageIntl = _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.currentLanguageIntl;
    this.serviceType = _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.serviceType;
    this.popupTemplate = _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.popupTemplate;
    this.layerDisplayType = _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.layerDisplayType;
    this.supportsArcade = _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.supportsArcade;
    this.layerFieldsMap = await (0,_commonFunctions_5262b094_js__WEBPACK_IMPORTED_MODULE_3__.d)(this.layer);
    this.arcadeExpMap = (0,_commonFunctions_5262b094_js__WEBPACK_IMPORTED_MODULE_3__.e)(this.popupTemplate);
    this.fields = await this.getFields();
    // in case more than 1 selected field and multiple is set to false
    if (!this.multiple && this.selectedFields.length > 1) {
      this.selectedFields = [this.selectedFields[0]];
    }
  }
  async componentDidLoad() {
    await this.loadAllModules();
    this.popoverNode.open = true;
    // need timeout because of re-render
    setTimeout(() => requestAnimationFrame(() => this.flowItemElement.setFocus()), 200);
  }
  componentWillRender() {
    this.arcadeExpMap = (0,_commonFunctions_5262b094_js__WEBPACK_IMPORTED_MODULE_3__.e)(this.popupTemplate);
    this.fieldsOnly = [...this.getSortedList()].filter((field) => {
      return !field.name.includes(_commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.f.expression);
    });
    this.expressionsOnly = [...this.getSortedList()].filter((field) => {
      return field.name.includes(_commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.f.expression);
    });
  }
  // Public Methods
  async reposition() {
    var _a;
    (_a = this.popoverNode) === null || _a === void 0 ? void 0 : _a.reposition();
  }
  // temp: https://github.com/Esri/calcite-components/issues/4333
  calciteFilterChangeHandler(event) {
    var _a, _b;
    event.stopPropagation();
    const filterNode = (_a = event === null || event === void 0 ? void 0 : event.path) === null || _a === void 0 ? void 0 : _a.find((item) => item.nodeName === "CALCITE-FILTER");
    this.filterFields = (_b = filterNode === null || filterNode === void 0 ? void 0 : filterNode.filteredItems) === null || _b === void 0 ? void 0 : _b.map((item) => {
      return item.value;
    });
  }
  // --------------------------------------------------------------------------
  //
  // Private Methods
  //
  // --------------------------------------------------------------------------
  getSortedList() {
    const tempSorted = [...this.fields];
    if (this.lastSortyBy === _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.L.display) {
      tempSorted.sort((a, b) => a.alias.localeCompare(b.alias));
    }
    else if (this.lastSortyBy === _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.L.field) {
      tempSorted.sort((a, b) => a.name.localeCompare(b.name));
    }
    else if (this.lastSortyBy === _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.L.type) {
      tempSorted.sort((a, b) => a.type.localeCompare(b.type));
    }
    return tempSorted;
  }
  // return true for deselect all, false for select all
  selectDeselect() {
    var _a;
    return ((_a = this.filterFields) === null || _a === void 0 ? void 0 : _a.length)
      ? this.filterContainsAll()
      : this.selectedFields.length === this.fields.length;
  }
  // check if filter has all current field info
  filterContainsAll() {
    return this.filterFields.every((filter) => {
      return this.selectedFields.some((curr) => {
        return curr === filter;
      });
    });
  }
  async loadAllModules() {
    [this.PopupExpressionInfo, this.FieldInfo] = await (0,_loadModules_aaf30bd6_js__WEBPACK_IMPORTED_MODULE_4__.l)([
      "esri/popup/ExpressionInfo",
      "esri/popup/FieldInfo"
    ]);
  }
  async launchArcade(currentExpression) {
    if (!this.arcadeEditor) {
      this.flowItemElement.disabled = true;
      this.arcadeEditor = document.createElement("arcgis-modal-arcade");
      this.arcadeEditor.arcadeScript = getArcadeScript(currentExpression === null || currentExpression === void 0 ? void 0 : currentExpression.expression, this.layerDisplayType, this.strings);
      this.arcadeEditor.arcadeProfile = await getArcadeProfile(this.layer, this.mapView, this.serviceType, this.popupTemplate, this.layerDisplayType);
      this.arcadeEditor.testData = await getTestData(this.layer, this.mapView, this.layerDisplayType, this.popupTemplate);
      this.arcadeEditor.addExistingExpressions = true;
      this.arcadeEditor.layer = this.layer;
      this.arcadeEditor.arcadeTitle = (currentExpression === null || currentExpression === void 0 ? void 0 : currentExpression.title) || this.strings.arcadeDefaultTitle;
      this.arcadeEditor.arcadeTitleEditable = true;
      this.arcadeEditor.arcadeTitleEditingEnabled = !(currentExpression === null || currentExpression === void 0 ? void 0 : currentExpression.title);
      document.body.appendChild(this.arcadeEditor);
      this.arcadeEditor.addEventListener("arcgisModalArcadeClose", (event) => this.arcadeSetup(event.detail, currentExpression));
    }
  }
  async arcadeSetup(arcadeObject, currentExpression) {
    if (arcadeObject) {
      const popupExpression = setExpressionInfoInPopupTemplate(arcadeObject, currentExpression === null || currentExpression === void 0 ? void 0 : currentExpression.name, this.PopupExpressionInfo, this.popupTemplate);
      await setLayerExpressionAndFieldInfo(this.popupTemplate, this.layerDisplayType, this.layer, this.FieldInfo);
      const expName = `${_commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.f.expression}${popupExpression.name}`;
      this.fields.push({
        name: expName,
        alias: popupExpression.title,
        type: popupExpression.returnType
      });
      // remove duplicates
      this.fields = [
        ...new Map(this.fields.map((item) => [item.name, item])).values()
      ];
      if (this.multiple) {
        this.selectedFields.push(expName);
      }
      else {
        this.selectedFields = [expName];
      }
      this.arcgisPopupPickListChange.emit({ selectedFields: [...new Set(this.selectedFields)] });
      this.arcadeChangeNotification.emit();
    }
    this.flowItemElement.disabled = false;
    document.body.removeChild(this.arcadeEditor);
    this.arcadeEditor = null;
  }
  async getFields() {
    const tempFieldAndFieldInfo = [];
    let fieldsOrderInService = await (0,_commonFunctions_5262b094_js__WEBPACK_IMPORTED_MODULE_3__.j)(this.layer);
    fieldsOrderInService = fieldsOrderInService.filter((field) => field.visible);
    // map fieldInfos for faster access
    const fieldInfoMap = new Map(this.popupTemplate.fieldInfos.map((fieldInfo) => [
      fieldInfo.fieldName,
      fieldInfo
    ]));
    // order based on order of fields in the service
    fieldsOrderInService.forEach((layerField) => {
      if (fieldInfoMap.has(layerField.name)) {
        const fieldInfo = fieldInfoMap.get(layerField.name);
        tempFieldAndFieldInfo.push({
          name: fieldInfo.fieldName,
          alias: (0,_commonFunctions_5262b094_js__WEBPACK_IMPORTED_MODULE_3__.b)(fieldInfo, this.arcadeExpMap),
          type: (0,_commonFunctions_5262b094_js__WEBPACK_IMPORTED_MODULE_3__.a)(fieldInfo.fieldName, this.layerFieldsMap, this.arcadeExpMap)
        });
        // delete from map
        fieldInfoMap.delete(layerField.name);
      }
    });
    // add remaining fields in popuptemplate. e.g. arcade, related
    fieldInfoMap.forEach((fieldInfo) => {
      tempFieldAndFieldInfo.push({
        name: fieldInfo.fieldName,
        alias: (0,_commonFunctions_5262b094_js__WEBPACK_IMPORTED_MODULE_3__.b)(fieldInfo, this.arcadeExpMap),
        type: (0,_commonFunctions_5262b094_js__WEBPACK_IMPORTED_MODULE_3__.a)(fieldInfo.fieldName, this.layerFieldsMap, this.arcadeExpMap)
      });
    });
    if (this.numbersOnly) {
      // set for faster lookup
      const selectedFieldsSet = new Set(this.selectedFields);
      return tempFieldAndFieldInfo.filter((currFieldAndFieldInfo) => {
        const fieldType = currFieldAndFieldInfo.type.toLowerCase();
        if ((selectedFieldsSet.has(currFieldAndFieldInfo.name) ||
          fieldType === _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.a.integer ||
          fieldType === _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.a.smallInteger ||
          fieldType === _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.a.bigInteger ||
          fieldType === _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.a.single ||
          fieldType === _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.a.double ||
          fieldType === _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.a.long ||
          fieldType === _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.a.number ||
          fieldType === _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.a.oid) &&
          !currFieldAndFieldInfo.name.includes(_commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.f.relationship)) {
          return currFieldAndFieldInfo;
        }
      });
    }
    return tempFieldAndFieldInfo;
  }
  // --------------------------------------------------------------------------
  //
  // Rendor  Methods
  //
  // --------------------------------------------------------------------------
  render() {
    const addBtn = ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { appearance: this.showCancel ? "solid" : "outline-fill", width: this.showCancel ? "half" : "full", scale: "m", onClick: () => {
        this.arcgisPopupPickListDismissed.emit({
          selectedFields: [...new Set(this.selectedFields)]
        });
      } }, this.okBtnText || (this.multiple ? this.strings.done : this.strings.ok)));
    const cancelBtn = ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { appearance: "outline-fill", width: this.multiple ? "half" : "full", scale: "m", onClick: () => this.arcgisPopupPickListDismissed.emit() }, this.strings.cancel));
    const sort = ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-dropdown", { slot: "menu-actions", placement: "bottom-end", overlayPositioning: "fixed" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { slot: "trigger", text: this.strings.sort, title: this.strings.sort }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-icon", { scale: "s", icon: "sortDescending" })), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-dropdown-group", null, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-dropdown-item", { selected: this.lastSortyBy === _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.L.default, onClick: () => (this.lastSortyBy = _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.L.default) }, this.strings.default), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-dropdown-item", { selected: this.lastSortyBy === _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.L.display, onClick: () => (this.lastSortyBy = _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.L.display) }, this.strings.displayName), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-dropdown-item", { selected: this.lastSortyBy === _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.L.type, onClick: () => (this.lastSortyBy = _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.L.type) }, this.strings.type), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-dropdown-item", { selected: this.lastSortyBy === _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.L.field, onClick: () => (this.lastSortyBy = _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.L.field) }, this.strings.fieldName))));
    const selectionBtn = ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "selection-button-div" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { appearance: "transparent", scale: "m", width: "full", class: "selection-button", onClick: () => {
        var _a, _b;
        if (this.selectDeselect()) {
          //deselect all
          this.selectedFields = ((_a = this.filterFields) === null || _a === void 0 ? void 0 : _a.length)
            ? this.selectedFields.filter((item) => !this.filterFields.includes(item))
            : [];
        }
        else {
          //select all
          this.selectedFields = ((_b = this.filterFields) === null || _b === void 0 ? void 0 : _b.length)
            ? [...new Set([...this.selectedFields, ...this.filterFields])]
            : this.fields.map((field) => {
              return field.name;
            });
        }
      } }, this.selectDeselect() ? this.strings.deselectAll : this.strings.selectAll)));
    const addExpressionsBtn = ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { appearance: "transparent", scale: "m", width: "full", iconStart: "plus", class: "add-expression-button", onClick: () => {
        this.launchArcade();
      } }, this.strings.addExpression));
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)(_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.H, { class: "js-app-flyout" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-popover", { dir: (0,_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_7__.g)(this.hostElement), class: "popover", placement: this.popoverProps.placement || "leading-start", open: false, pointerDisabled: true, referenceElement: this.popoverProps.refElement, offsetDistance: this.popoverProps.offsetDistance ||
        -Math.round(this.popoverProps.refElement.getBoundingClientRect().width), offsetSkidding: this.popoverProps.offsetSkidding || 50, label: this.heading, triggerDisabled: true, ref: (node) => (this.popoverNode = node) }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-flow", { ref: (node) => {
        this.flowElement = node;
      }, style: {
        width: `${this.popoverProps.popoverWidth ||
          this.popoverProps.refElement.getBoundingClientRect().width}px`
      } }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-flow-item", { ref: (el) => (this.flowItemElement = el), class: "panel", heading: this.heading, closable: true, onCalciteFlowItemClose: () => this.arcgisPopupPickListDismissed.emit() }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "footer", slot: "footer" }, this.supportsArcade && addExpressionsBtn, this.multiple && addBtn, this.showCancel && cancelBtn), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-pick-list", { class: "content", multiple: this.multiple, ref: (node) => {
        this.pickListNode = node;
      }, filterEnabled: this.fields.length >= this.showFilterLength ? true : false, filterPlaceholder: this.strings.searchFields, onCalciteListChange: async () => {
        // keep original order. Add addional values at the end
        const tempSelectedFields = await this.pickListNode.getSelectedItems();
        this.selectedFields = [
          ...new Set([
            ...this.selectedFields.filter((item) => {
              return tempSelectedFields.has(item);
            }),
            ...tempSelectedFields.keys()
          ])
        ];
        this.arcgisPopupPickListChange.emit({
          selectedFields: this.selectedFields
        });
        if (!this.multiple) {
          this.arcgisPopupPickListDismissed.emit({ selectedFields: this.selectedFields });
        }
      } }, this.fields.length >= this.showFilterLength && sort, this.multiple && selectionBtn, this.supportsArcade && ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-pick-list-group", { "group-title": this.strings.expressions }, this.expressionsOnly.length ? (this.expressionsOnly.map((field) => {
      return this.calciteExpressionsOnlyValueList(field);
    })) : ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-label", { alignment: "center" }, this.strings.noExpressions)))), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-pick-list-group", { groupTitle: this.supportsArcade ? this.strings.attributes : null }, this.fieldsOnly.map((field) => {
      return this.calciteFieldOnlyValueList(field);
    }))))))));
  }
  get hostElement() { return (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.d)(this); }
};
ArcgisPopupFieldPickList.style = arcgisPopupFieldPickListCss;

const CSS$2 = {
  popoverImageDiv: "popover-image-div",
  formInputButton: "form-input-button",
  refreshImageInput: "refresh-image-input"
};

const arcgisPopupImageCss = ".popover-image-div{background-color:var(--arcgis-app-background);padding:var(--arcgis-app-cap-spacing) var(--arcgis-app-side-spacing-half);max-height:calc(60vh - 102px);}.refresh-label{margin-top:6px}.form-input-button{display:flex}.form-input-button calcite-input[type=text]{display:flex;flex-flow:column nowrap;flex:1 0 0%;overflow:hidden}.form-input-button calcite-action{margin:0;flex:0 0 0%;justify-self:flex-end}.refresh-image-input{width:5rem}";

const ArcgisPopupImage = class {
  constructor(hostRef) {
    (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.r)(this, hostRef);
    this.closePopupPopovers = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "closePopupPopovers", 7);
    this.imageChangedReRender = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "imageChangedReRender", 7);
    this.notifyMultiMediaChange = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "notifyMultiMediaChange", 7);
    this.changeImageProperties = (event) => {
      event === null || event === void 0 ? void 0 : event.stopPropagation();
      event === null || event === void 0 ? void 0 : event.preventDefault();
      // hide rest of the component.
      this.imageMediaInfo.value.sourceURL = this.editImageUrl.value;
      this.imageMediaInfo.title = this.editImageTitle.value;
      this.imageMediaInfo.refreshInterval = this.editRefreshImage.value || 0;
      this.imageMediaInfo.caption = this.editImageCaption.value;
      this.imageMediaInfo.altText = this.editAltText.value;
      this.imageMediaInfo.value.linkURL = this.editImageLinkUrl.value;
      this.imageChangedReRender.emit();
    };
    // open popover
    this.openAttributesList = (imageComponentInputType) => {
      // close first since we can have multiple attributes open
      this.closePopupPopovers.emit(this.guid);
      // lazy load attribute selection component
      if (!this.popupFieldSelectionPickList) {
        this.popupFieldSelectionPickList = document.createElement("arcgis-popup-field-pick-list");
        this.popupFieldSelectionPickList.popoverProps = {
          refElement: this.panelElement
        };
        this.popupFieldSelectionPickList.multiple = false;
        this.popupFieldSelectionPickList.heading = this.strings.addField;
        this.popupFieldSelectionPickList.addEventListener("arcgisPopupPickListDismissed", () => {
          this.closePopupPopovers.emit(this.guid);
        });
        this.popupFieldSelectionPickList.addEventListener("arcgisPopupPickListChange", (event) => this.popupFieldSelectionPickListChanges(event, imageComponentInputType));
        document.body.appendChild(this.popupFieldSelectionPickList);
        this.panelElement.disabled = true;
      }
    };
    this.imageFormInput = (imageInputType) => {
      var _a;
      const imageInputObject = this.getImageInputObject(imageInputType);
      return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-label", { scale: "s" }, imageInputObject.inputLabel, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { id: imageInputObject.popoverId, class: CSS$2.formInputButton }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-input", { type: "text", autofocus: true, ref: imageInputObject.referenceElement, value: imageInputObject.inputValue, placeholder: imageInputObject.placeHolder, onClick: () => this.closePopupPopovers.emit(this.guid) }), ((_a = this.popupTemplate.fieldInfos) === null || _a === void 0 ? void 0 : _a.length) > 0 && ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { text: this.strings.attributes, "text-display": "hidden", onClick: () => this.openAttributesList(imageInputObject.imageInput), scale: "s", icon: "brackets-curly" })))));
    };
    this.getImageInputObject = (imageInputType) => {
      class ImageInputClass {
      }
      const imageInputObject = new ImageInputClass();
      imageInputObject.imageInput = imageInputType;
      imageInputObject.popoverId = `popoverId_${imageInputObject.imageInput}`;
      if (imageInputType === _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.i.sourceUrl) {
        imageInputObject.inputLabel = this.strings.url;
        imageInputObject.referenceElement = (element) => {
          element.addEventListener("calciteInputChange", this.changeImageProperties);
          this.editImageUrl = element;
        };
        imageInputObject.inputValue = this.imageMediaInfo.value.sourceURL;
        imageInputObject.placeHolder = this.strings.imageUrlPlaceHolder;
      }
      else if (imageInputType === _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.i.title) {
        imageInputObject.inputLabel = this.strings.title;
        imageInputObject.referenceElement = (element) => {
          element.addEventListener("calciteInputChange", this.changeImageProperties);
          this.editImageTitle = element;
        };
        imageInputObject.inputValue = this.imageMediaInfo.title;
        imageInputObject.placeHolder = this.strings.imageTitlePlaceHolder;
      }
      else if (imageInputType === _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.i.caption) {
        imageInputObject.inputLabel = this.strings.caption;
        imageInputObject.referenceElement = (element) => {
          element.addEventListener("calciteInputChange", this.changeImageProperties);
          this.editImageCaption = element;
        };
        imageInputObject.inputValue = this.imageMediaInfo.caption;
        imageInputObject.placeHolder = this.strings.imageCaptionPlaceHolder;
      }
      else if (imageInputType === _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.i.altText) {
        imageInputObject.inputLabel = this.strings.description;
        imageInputObject.referenceElement = (element) => {
          element.addEventListener("calciteInputChange", this.changeImageProperties);
          this.editAltText = element;
        };
        imageInputObject.inputValue = this.imageMediaInfo.altText;
        imageInputObject.placeHolder = this.strings.describeImage;
      }
      else if (imageInputType === _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.i.linkUrl) {
        imageInputObject.inputLabel = this.strings.link;
        imageInputObject.referenceElement = (element) => {
          element.addEventListener("calciteInputChange", this.changeImageProperties);
          this.editImageLinkUrl = element;
        };
        imageInputObject.inputValue = this.imageMediaInfo.value.linkURL;
        imageInputObject.placeHolder = this.strings.imageLinkUrlPlaceHolder;
      }
      return imageInputObject;
    };
    this.guid = undefined;
    this.imageMediaInfo = undefined;
    this.refElement = undefined;
    this.mediaIndexPosition = undefined;
    this.isOpen = false;
    this.reRender = undefined;
  }
  // lifecycle methods
  componentWillLoad() {
    this.strings = _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.strings;
    this.popupTemplate = _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.popupTemplate;
    this.imageMediaInfo.title = this.imageMediaInfo.title || "";
    this.imageMediaInfo.altText = this.imageMediaInfo.altText || "";
    this.imageMediaInfo.caption = this.imageMediaInfo.caption || "";
    this.imageMediaInfo.value.sourceURL = this.imageMediaInfo.value.sourceURL || "";
    this.imageMediaInfo.value.linkURL = this.imageMediaInfo.value.linkURL || "";
  }
  componentDidLoad() {
    this.editImageUrl.value = this.imageMediaInfo.value.sourceURL;
    this.editImageTitle.value = this.imageMediaInfo.title;
    this.editRefreshImage.value = this.imageMediaInfo.refreshInterval || 0;
    this.editImageCaption.value = this.imageMediaInfo.caption;
    this.editImageLinkUrl.value = this.imageMediaInfo.value.linkURL;
    this.editAltText.value = this.imageMediaInfo.altText;
    this.isOpen = true;
    // need timeout because of re-render
    setTimeout(() => requestAnimationFrame(() => this.panelElement.setFocus()), 300);
  }
  componentDidUpdate() {
    this.notifyMultiMediaChange.emit({
      guid: this.guid,
      mediaIndexPosition: this.mediaIndexPosition
    });
  }
  disconnectedCallback() {
    if (this.popupFieldSelectionPickList) {
      document.body.removeChild(this.popupFieldSelectionPickList);
    }
  }
  // Public Methods
  async reposition() {
    var _a;
    (_a = this.popoverNode) === null || _a === void 0 ? void 0 : _a.reposition();
  }
  // Events
  imageChangedReRenderHandler(event) {
    event.stopPropagation();
    this.reRender = this.reRender ? false : true;
  }
  calciteBlockToggleHandler() {
    this.closePopupPopovers.emit();
  }
  closePopupPopoversHandler() {
    this.removeAttributesSelectionPopover();
  }
  closeMultiMediaPopoverHandler() {
    this.removeAttributesSelectionPopover();
  }
  calciteBlockSectionToggleHandler(event) {
    const composedPath = event.composedPath();
    if ((composedPath === null || composedPath === void 0 ? void 0 : composedPath[0].id) === "refreshImageBlockSection_id") {
      this.editRefreshImage.value = 0;
      this.changeImageProperties(event);
      this.hostElement.shadowRoot.getElementById("managePopover_Id")["reposition"]();
    }
    event.stopPropagation();
  }
  // private methods and properties
  removeAttributesSelectionPopover() {
    if (this.popupFieldSelectionPickList) {
      document.body.removeChild(this.popupFieldSelectionPickList);
      this.popupFieldSelectionPickList = null;
    }
    this.panelElement.disabled = false;
  }
  // field selection for title and caption
  popupFieldSelectionPickListChanges(event, currImageComponentInputTypes) {
    const selectedFieldName = event.detail.selectedFields[0];
    if (currImageComponentInputTypes === _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.i.sourceUrl) {
      this.editImageUrl.value = addSelectedFieldAtCursor(this.editImageUrl, selectedFieldName);
      this.editImageUrl.setFocus();
    }
    else if (currImageComponentInputTypes === _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.i.title) {
      this.editImageTitle.value = addSelectedFieldAtCursor(this.editImageTitle, selectedFieldName);
      this.editImageTitle.setFocus();
    }
    else if (currImageComponentInputTypes === _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.i.caption) {
      this.editImageCaption.value = addSelectedFieldAtCursor(this.editImageCaption, selectedFieldName);
      this.editImageCaption.setFocus();
    }
    else if (currImageComponentInputTypes === _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.i.linkUrl) {
      this.editImageLinkUrl.value = addSelectedFieldAtCursor(this.editImageLinkUrl, selectedFieldName);
      this.editImageLinkUrl.setFocus();
    }
    else if (currImageComponentInputTypes === _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.i.altText) {
      this.editAltText.value = addSelectedFieldAtCursor(this.editAltText, selectedFieldName);
      this.editAltText.setFocus();
    }
    this.closePopupPopovers.emit(this.guid);
    this.changeImageProperties();
  }
  render() {
    const refreshImageInput = ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-block-section", { id: "refreshImageBlockSection_id", text: this.strings.refreshInterval, toggleDisplay: "switch", open: this.imageMediaInfo.refreshInterval ? true : false }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "refresh-label" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-label", { scale: "s", layout: "inline" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-input", { class: CSS$2.refreshImageInput, type: "number", min: 0, max: 1440, ref: (element) => {
        element.addEventListener("calciteInputChange", this.changeImageProperties);
        this.editRefreshImage = element;
      }, value: this.imageMediaInfo.refreshInterval
        ? this.imageMediaInfo.refreshInterval.toString()
        : "0", onClick: () => this.closePopupPopovers.emit(this.guid), onCalciteInputInput: () => {
        if (this.editRefreshImage.value) {
          const value = parseInt(this.editRefreshImage.value);
          if (value < 0) {
            this.editRefreshImage.value = 0;
          }
          else if (value > 1440) {
            this.editRefreshImage.value = 1440;
          }
        }
      } }), this.strings.minutes))));
    const imageDiv = ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "ignore-elements-sortable" }, this.imageFormInput(_commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.i.sourceUrl), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-block-section", { open: true, text: this.strings.options }, this.imageFormInput(_commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.i.title), this.imageFormInput(_commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.i.caption), this.imageFormInput(_commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.i.altText), this.imageFormInput(_commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_2__.i.linkUrl), refreshImageInput)));
    const doneBtn = ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { appearance: "outline-fill", scale: "m", slot: "footer", width: "full", onClick: () => this.closePopupPopovers.emit() }, this.strings.done));
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)(_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.H, { class: "js-app-flyout" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-popover", { dir: (0,_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_7__.g)(this.hostElement), id: "managePopover_Id", placement: "leading-start", open: this.isOpen, pointerDisabled: true, referenceElement: this.refElement, offsetDistance: -Math.round(this.refElement.getBoundingClientRect().width), offsetSkidding: 50, label: "", style: {
        zIndex: "100"
      }, triggerDisabled: true, ref: (node) => (this.popoverNode = node) }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-panel", { ref: (element) => (this.panelElement = element), closable: true, style: {
        width: `${this.refElement.getBoundingClientRect().width}px`
      }, onCalcitePanelClose: () => this.closePopupPopovers.emit() }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { slot: "header-content" }, this.strings.configureImage), doneBtn, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS$2.popoverImageDiv }, imageDiv)))));
  }
  get hostElement() { return (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.d)(this); }
};
ArcgisPopupImage.style = arcgisPopupImageCss;

const ArcgisPopupMainContentpopover = class {
  constructor(hostRef) {
    (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.r)(this, hostRef);
    this.closePopupPopovers = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "closePopupPopovers", 7);
    this.notifyAddContentSelection = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "notifyAddContentSelection", 7);
    this.notifyAddMultiMediaContentSelection = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "notifyAddMultiMediaContentSelection", 7);
    this.contentPopoverRefElement = undefined;
    this.popupHasAttachment = undefined;
    this.popoverPanelWidth = undefined;
    this.isMultimediaContent = false;
    this.guid = undefined;
    this.isOpen = false;
  }
  async reposition() {
    var _a;
    (_a = this.popoverElement) === null || _a === void 0 ? void 0 : _a.reposition();
  }
  componentWillLoad() {
    this.strings = _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.strings;
    this.layerHasAttachment = _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.layerHasAttachment;
    this.layerHasET = _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.layerHasET;
    this.layerHasAttributes = _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.layerHasAttributes;
    this.layerHasCharts = _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.layerHasCharts;
    this.layerHasImages = _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.layerHasImages;
    this.layerHasText = _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.layerHasText;
    this.popupTemplate = _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.popupTemplate;
    this.supportsArcade = _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.supportsArcade;
  }
  componentDidLoad() {
    this.hostElement.shadowRoot.getElementById("managePopover_Id")["reposition"]();
    this.isOpen = true;
    // need timeout because of re-render
    setTimeout(() => requestAnimationFrame(() => this.panelElement.setFocus()), 300);
  }
  contentSelection(content) {
    if (this.isMultimediaContent) {
      this.notifyAddMultiMediaContentSelection.emit({ guid: this.guid, content: content });
    }
    else {
      this.notifyAddContentSelection.emit(content);
    }
  }
  // rendor methods
  render() {
    const attributes = ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { label: this.strings.fieldsList, text: this.strings.fieldsList, textEnabled: true, onClick: () => {
        this.contentSelection(ContentSelection.attributes);
      } }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-icon", { scale: "s", icon: "feature-details" })));
    const attachments = ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { label: this.strings.attachments, text: this.strings.attachments, textEnabled: true, onClick: () => {
        this.contentSelection(ContentSelection.attachments);
      }, disabled: this.popupHasAttachment ? true : false }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-icon", { scale: "s", icon: "attachment" })));
    const charts = ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { label: this.strings.chart, text: this.strings.chart, textEnabled: true, onClick: () => {
        this.contentSelection(ContentSelection.charts);
      } }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-icon", { scale: "s", icon: "graph-bar" })));
    const images = ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { label: this.strings.image, text: this.strings.image, textEnabled: true, onClick: () => {
        this.contentSelection(ContentSelection.images);
      } }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-icon", { scale: "s", icon: "image" })));
    const richText = ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { label: this.strings.text, text: this.strings.text, textEnabled: true, onClick: () => {
        this.contentSelection(ContentSelection.richText);
      } }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-icon", { scale: "s", icon: "text" })));
    const arcade = ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { label: this.strings.arcade, text: this.strings.arcade, icon: "code", textEnabled: true, onClick: () => {
        this.contentSelection(ContentSelection.arcade);
      } }));
    const et = ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { label: this.strings.summaryETHeading, text: this.strings.summaryETHeading, textEnabled: true, onClick: () => {
        this.contentSelection(ContentSelection.summaryET);
      }, disabled: this.popupTemplate.lastEditInfoEnabled ? true : false }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-icon", { scale: "s", icon: "user" })));
    const relatedRecords = ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { label: this.strings.relatedRecords, text: this.strings.relatedRecords, textEnabled: true, onClick: () => {
        this.contentSelection(ContentSelection.relationship);
      } }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-icon", { scale: "s", icon: "link" })));
    const panel = (0,_commonFunctions_5262b094_js__WEBPACK_IMPORTED_MODULE_3__.q)(this.contentPopoverRefElement, "calcite-flow-item");
    const panelTop = (panel === null || panel === void 0 ? void 0 : panel.getBoundingClientRect().top) || 56;
    const buttonTop = this.contentPopoverRefElement.getBoundingClientRect().top;
    // 54: panel header; 10: panel arrow
    const popoverMaxHeight = buttonTop - panelTop - 54 - 10;
    const contentStyle = { maxHeight: popoverMaxHeight > 0 ? `${popoverMaxHeight}px` : "60vh" };
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)(_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.H, { class: "js-app-flyout" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-popover", { ref: (el) => (this.popoverElement = el), dir: (0,_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_7__.g)(this.hostElement), id: "managePopover_Id", placement: "bottom", open: this.isOpen, referenceElement: this.contentPopoverRefElement, label: this.isMultimediaContent ? this.strings.addMedia : this.strings.addContent, style: {
        zIndex: "100"
      }, triggerDisabled: true }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-panel", { ref: (el) => (this.panelElement = el), closable: true, style: {
        width: `${this.popoverPanelWidth}px`
      }, onCalcitePanelClose: () => this.closePopupPopovers.emit() }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { slot: "header-content" }, this.isMultimediaContent ? this.strings.addMedia : this.strings.content), this.isMultimediaContent ? ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { style: contentStyle }, this.layerHasCharts && charts, this.layerHasImages && images)) : ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { style: contentStyle }, this.layerHasAttributes && attributes, this.layerHasAttachment && attachments, this.layerHasCharts && charts, this.layerHasImages && images, this.layerHasText && richText, this.supportsArcade && arcade, this.layerHasET && et, _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.layerHasRelatedRecords && relatedRecords))))));
  }
  get hostElement() { return (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.d)(this); }
};

const CSS$1 = {
  addMediaButton: "add-media-button",
  formInputButton: "form-input-button",
  disableSpacing: "disable-spacing"
};

const arcgisPopupMultimediaCss = ".add-media-button{display:flex;justify-content:center;padding:var(--arcgis-app-cap-spacing-half) 0 0 0}.form-input-button{display:flex}.form-input-button calcite-input[type=text]{display:flex;flex-flow:column nowrap;flex:1 0 0%;overflow:hidden}.form-input-button calcite-action{margin:0;flex:0 0 0%;justify-self:flex-end}.disable-spacing{--calcite-label-margin-bottom:0}";

const ArcgisPopupMultimedia = class {
  constructor(hostRef) {
    (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.r)(this, hostRef);
    this.closePopupPopovers = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "closePopupPopovers", 7);
    this.closeMultiMediaPopover = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "closeMultiMediaPopover", 7);
    this.internalPopupUpdated = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "internalPopupUpdated", 7);
    this.deleteComponent = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "deleteComponent", 7);
    this.disablePopupPanel = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "disablePopupPanel", 7);
    this.pickList = [];
    // to keep track of drag and drop
    this.mediaMap = new Map();
    this.calciteValueListItem = (mediaInfo, listItemGuid) => ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-value-list-item", { id: listItemGuid, label: (mediaInfo.title &&
        `${mediaInfo.title.substring(0, 25)}${mediaInfo.title.length > 25 ? "..." : ""}`) ||
        this.strings.noTitle, description: this.getMultiMediaText(mediaInfo.type), value: listItemGuid, onClick: (event) => {
        event.stopPropagation();
        this.closePopupPopovers.emit();
        this.openMediaPopover(mediaInfo, this.findChartIndexPosition(listItemGuid));
      } }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { slot: "actions-end", appearance: "transparent", text: this.strings.remove, onClick: (event) => {
        event.stopPropagation();
        this.closePopupPopovers.emit();
        // each list-item has id. Find id, and splice by index
        const allListItems = this.hostElement.shadowRoot
          .getElementById("valueList_Id")
          .getElementsByTagName("calcite-value-list-item");
        for (let x = 0; x < allListItems.length; x++) {
          if (allListItems[x].id === listItemGuid) {
            this.multimediaContent.mediaInfos.splice(x, 1);
            // delete component if empty, else re-render
            if (this.multimediaContent.mediaInfos.length === 0) {
              this.deleteComponent.emit(this.guid);
            }
            else {
              // reset to 0 on delete
              this.setActiveMediaInfoIndex(0);
              this.reRender = this.reRender ? false : true;
            }
            break;
          }
        }
      } }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-icon", { scale: "s", icon: "x" }))));
    this.formInput = (formType, formString, formInputElement, formValue, formPlaceholder
    // promptMessage: string
    ) => {
      var _a;
      return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-label", { scale: "s" }, formString, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS$1.formInputButton }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-input", { type: "text", autofocus: true, ref: formInputElement, value: formValue, placeholder: formPlaceholder, onCalciteInputInput: (event) => {
          event.stopPropagation();
          const inputVal = event.target.value;
          if (formType === "title") {
            this.multimediaContent.title = inputVal;
          }
          else {
            this.multimediaContent.description = inputVal;
          }
          this.reRender = !this.reRender;
        }, onClick: () => this.closePopupPopovers.emit() }), ((_a = this.popupTemplate.fieldInfos) === null || _a === void 0 ? void 0 : _a.length) > 0 && ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { text: this.strings.attributes, onClick: () => {
          this.closePopupPopovers.emit();
          if (!this.popupFieldSelectionPickList) {
            this.popupFieldSelectionPickList = document.createElement("arcgis-popup-field-pick-list");
            this.popupFieldSelectionPickList.popoverProps = {
              refElement: this.popupFlowItem
            };
            this.popupFieldSelectionPickList.multiple = false;
            this.popupFieldSelectionPickList.heading = this.strings.addField;
            this.popupFieldSelectionPickList.addEventListener("arcgisPopupPickListDismissed", () => {
              this.closePopupPopovers.emit();
            });
            this.popupFieldSelectionPickList.addEventListener("arcgisPopupPickListChange", (event) => this.popupFieldSelectionPickListChanges(event, formType));
            document.body.appendChild(this.popupFieldSelectionPickList);
            this.disablePopupPanel.emit(true);
          }
        }, scale: "s", icon: "brackets-curly" })))));
    };
    this.guid = undefined;
    this.multimediaContent = undefined;
    this.blockOpen = false;
    this.popupFlowItem = undefined;
    this.reRender = undefined;
  }
  // lifecycle methods
  async componentWillLoad() {
    this.strings = _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.strings;
    this.mapView = _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.mapView;
    this.popupTemplate = _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.popupTemplate;
    // watch if popup changes to reset the index
    const [reactiveUtils] = await (0,_loadModules_aaf30bd6_js__WEBPACK_IMPORTED_MODULE_4__.l)(["esri/core/reactiveUtils"]);
    reactiveUtils.watch(() => { var _a; return (_a = this.mapView.popup) === null || _a === void 0 ? void 0 : _a.selectedFeature; }, () => this.setActiveMediaInfoIndex(0));
    reactiveUtils.watch(() => { var _a; return (_a = this.mapView.popup) === null || _a === void 0 ? void 0 : _a.visible; }, () => this.setActiveMediaInfoIndex(0));
    if (!this.multimediaContent.title) {
      this.multimediaContent.title = "";
    }
    if (!this.multimediaContent.description) {
      this.multimediaContent.description = "";
    }
  }
  componentDidLoad() {
    if (this.blockOpen) {
      this.addMediaBtn.scrollIntoView({ behavior: "auto", block: "nearest", inline: "start" });
      if (this.multimediaContent.mediaInfos.length === 1) {
        this.openMediaPopover(this.multimediaContent.mediaInfos[0], 0);
      }
      else {
        this.blockOptions.setFocus();
      }
    }
  }
  componentWillRender() {
    this.pickList = [];
    this.mediaMap.clear();
    this.multimediaContent.mediaInfos.forEach((mediaInfo) => {
      const listItemGuid = (0,_guid_4f4176ba_js__WEBPACK_IMPORTED_MODULE_5__.g)();
      this.mediaMap.set(listItemGuid, mediaInfo);
      this.pickList.push(this.calciteValueListItem(mediaInfo, listItemGuid));
    });
  }
  componentDidUpdate() {
    this.internalPopupUpdated.emit();
  }
  disconnectedCallback() {
    if (this.imagePopover) {
      document.body.removeChild(this.imagePopover);
    }
    if (this.chartPopover) {
      document.body.removeChild(this.chartPopover);
    }
    if (this.multimediaContentPopover) {
      document.body.removeChild(this.multimediaContentPopover);
    }
    if (this.popupFieldSelectionPickList) {
      document.body.removeChild(this.popupFieldSelectionPickList);
    }
  }
  // events
  calciteBlockToggleHandler() {
    this.closePopupPopovers.emit();
  }
  // drag and drop to re-order
  calciteListOrderChangeHandler() {
    let tempMediaInfos = [];
    const allListItems = this.hostElement.shadowRoot
      .getElementById("valueList_Id")
      .getElementsByTagName("calcite-value-list-item");
    const eventValueGuids = Array.from(allListItems).map((item) => item.id);
    eventValueGuids.forEach((eventValueGuid) => {
      if (this.mediaMap.has(eventValueGuid)) {
        tempMediaInfos.push(this.mediaMap.get(eventValueGuid));
      }
    });
    if (tempMediaInfos.length > 0) {
      this.multimediaContent.mediaInfos = tempMediaInfos;
    }
    // reset to 0 on drag and drop
    this.setActiveMediaInfoIndex(0, true);
    // dont need to re-render since only updating media infos.
    // calcite pick list takes care of rendering correctly.
    this.closePopupPopovers.emit();
  }
  resetMultiMediaIndexHandler() {
    this.setActiveMediaInfoIndex(0, true);
  }
  closePopupPopoversHandler(event) {
    if ((event === null || event === void 0 ? void 0 : event.detail) !== this.guid && this.imagePopover) {
      this.closeMultiMediaPopover.emit();
      document.body.removeChild(this.imagePopover);
      this.imagePopover = null;
      this.addMediaBtn.setFocus();
      this.disablePopupPanel.emit(false);
    }
    if ((event === null || event === void 0 ? void 0 : event.detail) !== this.guid && this.chartPopover) {
      this.closeMultiMediaPopover.emit();
      document.body.removeChild(this.chartPopover);
      this.chartPopover = null;
      this.addMediaBtn.setFocus();
      this.disablePopupPanel.emit(false);
    }
    if (this.multimediaContentPopover) {
      document.body.removeChild(this.multimediaContentPopover);
      this.multimediaContentPopover = null;
      this.addMediaBtn.disabled = false;
      requestAnimationFrame(() => this.addMediaBtn.setFocus());
      this.disablePopupPanel.emit(false);
    }
    if (this.popupFieldSelectionPickList) {
      document.body.removeChild(this.popupFieldSelectionPickList);
      this.popupFieldSelectionPickList = null;
      this.disablePopupPanel.emit(false);
    }
  }
  notifyMultiMediaChangeHandler(event) {
    var _a, _b;
    if (((_a = event.detail) === null || _a === void 0 ? void 0 : _a.guid) === this.guid) {
      this.setActiveMediaInfoIndex((_b = event.detail) === null || _b === void 0 ? void 0 : _b.mediaIndexPosition);
      this.reRender = this.reRender ? false : true;
    }
  }
  async notifyAddMultiMediaContentSelectionHandler(event) {
    event.stopPropagation();
    this.closePopupPopovers.emit();
    if (event.detail.guid === this.guid) {
      const contentType = event.detail.content;
      const [ImageMediaInfo, ColumnChartMediaInfo, ImageMediaInfoValue, ChartMediaInfoValue] = await (0,_loadModules_aaf30bd6_js__WEBPACK_IMPORTED_MODULE_4__.l)([
        "esri/popup/content/ImageMediaInfo",
        "esri/popup/content/ColumnChartMediaInfo",
        "esri/popup/content/support/ImageMediaInfoValue",
        "esri/popup/content/support/ChartMediaInfoValue"
      ]);
      let multiMediaElement;
      if (contentType === ContentSelection.images) {
        multiMediaElement = new ImageMediaInfo({
          title: "",
          caption: "",
          altText: "",
          value: new ImageMediaInfoValue({
            sourceURL: "",
            linkURL: ""
          })
        });
      }
      else if (contentType === ContentSelection.charts) {
        multiMediaElement = new ColumnChartMediaInfo({
          title: "",
          caption: "",
          altText: "",
          value: new ChartMediaInfoValue({
            fields: []
          })
        });
      }
      this.multimediaContent.mediaInfos.push(multiMediaElement);
      this.reRender = !this.reRender;
      this.openMediaPopover(multiMediaElement, this.multimediaContent.mediaInfos.length - 1);
    }
  }
  // private methods
  setActiveMediaInfoIndex(index, updatePopup) {
    this.multimediaContent.activeMediaInfoIndex = index || 0;
    updatePopup && this.internalPopupUpdated.emit();
  }
  findChartIndexPosition(listItemGuid) {
    const allListItems = this.hostElement.shadowRoot
      .getElementById("valueList_Id")
      .getElementsByTagName("calcite-value-list-item");
    for (let x = 0; x < allListItems.length; x++) {
      if (allListItems[x].id === listItemGuid) {
        return x;
      }
    }
  }
  getMultiMediaText(type) {
    if (type === PopupMultiMediaType.image) {
      return this.strings.image;
    }
    else if (type === PopupMultiMediaType.barChart || type === PopupMultiMediaType.columnChart) {
      return this.strings.barChart;
    }
    else if (type === PopupMultiMediaType.lineChart) {
      return this.strings.lineChart;
    }
    else if (type === PopupMultiMediaType.pieChart) {
      return this.strings.pieChart;
    }
    return this.strings.image;
  }
  openMediaPopover(mediaInfo, indexPosition) {
    if (mediaInfo.type === PopupMultiMediaType.image) {
      this.imagePopover = document.createElement("arcgis-popup-image");
      this.imagePopover.guid = this.guid;
      this.imagePopover.refElement = this.popupFlowItem;
      this.imagePopover.imageMediaInfo = mediaInfo;
      this.imagePopover.mediaIndexPosition = indexPosition;
      document.body.appendChild(this.imagePopover);
    }
    else {
      this.chartPopover = document.createElement("arcgis-popup-chart");
      this.chartPopover.guid = this.guid;
      this.chartPopover.refElement = this.popupFlowItem;
      this.chartPopover.chartMediaInfo = mediaInfo;
      this.chartPopover.mediaContent = this.multimediaContent;
      this.chartPopover.mediaIndexPosition = indexPosition;
      document.body.appendChild(this.chartPopover);
    }
    this.disablePopupPanel.emit(true);
  }
  getSummartText() {
    if (this.multimediaContent.mediaInfos.length > 1) {
      return `${this.strings.multiple} (${this.multimediaContent.mediaInfos.length})`;
    }
    else {
      return this.getMultiMediaText(this.multimediaContent.mediaInfos[0].type);
    }
  }
  // field selection for title and caption
  popupFieldSelectionPickListChanges(event, formType) {
    const selectedFieldName = event.detail.selectedFields[0];
    if (formType === "title") {
      this.contentTitle.value = addSelectedFieldAtCursor(this.contentTitle, selectedFieldName);
      this.contentTitle.setFocus();
      this.multimediaContent.title = this.contentTitle.value;
    }
    else if (formType === "description") {
      this.contentDescription.value = addSelectedFieldAtCursor(this.contentDescription, selectedFieldName);
      this.contentDescription.setFocus();
      this.multimediaContent.description = this.contentDescription.value;
    }
    this.closePopupPopovers.emit();
    this.reRender = !this.reRender;
  }
  // rendor methods
  render() {
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)(_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.H, null, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-block", { dir: (0,_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_7__.g)(this.hostElement), heading: this.multimediaContent.mediaInfos.length > 1
        ? this.strings.mediaGroup
        : this.strings.media, description: (this.multimediaContent.title &&
        `${this.multimediaContent.title.substring(0, 25)}${this.multimediaContent.title.length > 25 ? "..." : ""}`) ||
        this.getSummartText(), collapsible: true, open: this.blockOpen, dragHandle: true }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "ignore-elements-sortable", slot: "control" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-calcite-block-options", { ref: (el) => (this.blockOptions = el), guid: this.guid, intlOptions: this.strings.options, intlDelete: this.strings.delete, intlDuplicate: this.strings.duplicate, calciteBlockOptions: { hasDelete: true, hasDuplicate: true } })), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { slot: "icon" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-icon", { scale: "m", icon: "images" })), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "ignore-elements-sortable" }, this.formInput("title", this.strings.title, (element) => {
      return (this.contentTitle = element);
    }, this.multimediaContent.title, this.strings.enterTitle
    // this.strings.titleContext.replace("${titleContext}", this.strings.media_L)
    ), this.formInput("description", this.strings.desc, (element) => {
      return (this.contentDescription = element);
    }, this.multimediaContent.description, this.strings.enterDescription
    // this.strings.descriptionContext.replace("${descriptionContext}", this.strings.media_L)
    ), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-label", { class: CSS$1.disableSpacing, scale: "s" }, this.strings.mediaContent), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-value-list", { id: "valueList_Id", "drag-enabled": true }, this.pickList), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { ref: (el) => (this.addMediaBtn = el), title: this.strings.addMedia, appearance: "outline-fill", round: true, scale: "s", class: CSS$1.addMediaButton, iconStart: "plus", onClick: (event) => {
        event.stopPropagation();
        this.closePopupPopovers.emit();
        if (!this.multimediaContentPopover) {
          this.multimediaContentPopover = document.createElement("arcgis-popup-main-contentpopover");
          this.multimediaContentPopover.contentPopoverRefElement = this.addMediaBtn;
          this.multimediaContentPopover.popoverPanelWidth =
            this.hostElement.getBoundingClientRect().width;
          this.multimediaContentPopover.isMultimediaContent = true;
          this.multimediaContentPopover.guid = this.guid;
          document.body.appendChild(this.multimediaContentPopover);
          this.addMediaBtn.disabled = true;
          this.disablePopupPanel.emit(true);
        }
      } })))));
  }
  get hostElement() { return (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.d)(this); }
};
ArcgisPopupMultimedia.style = arcgisPopupMultimediaCss;

const arcgisPopupRelationshipCss = ".form-input-button{display:flex}.form-input-button calcite-input[type=text]{display:flex;flex-flow:column nowrap;flex:1 0 0%;overflow:hidden}.form-input-button calcite-action{margin:0;flex:0 0 0%;justify-self:flex-end}.dropdown{display:block}";

const ArcgisPopupRelationship = class {
  constructor(hostRef) {
    (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.r)(this, hostRef);
    this.closePopupPopovers = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "closePopupPopovers", 7);
    this.internalPopupUpdated = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "internalPopupUpdated", 7);
    this.disablePopupPanel = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "disablePopupPanel", 7);
    this.maxPreviewCount = 11;
    this.fieldPickListChanges = (event) => {
      var _a, _b;
      event.stopPropagation();
      const selectedField = (_b = (_a = event.detail) === null || _a === void 0 ? void 0 : _a.selectedFields) === null || _b === void 0 ? void 0 : _b[0];
      if (selectedField) {
        this.relatedRecordsContent.orderByFields[0].field = selectedField;
        this.reRender = !this.reRender;
      }
      this.closePopupPopovers.emit();
    };
    this.formInput = (formType, formString, formInputElement, formValue, formPlaceholder) => {
      var _a;
      return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-label", { scale: "s" }, formString, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "form-input-button" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-input", { type: "text", autofocus: true, ref: formInputElement, value: formValue, placeholder: formPlaceholder, disabled: !this.hasRelationshipLayer, onCalciteInputInput: (event) => {
          event.stopPropagation();
          const inputVal = event.target.value;
          if (formType === "title") {
            this.relatedRecordsContent.title = inputVal;
          }
          else {
            this.relatedRecordsContent.description = inputVal;
          }
          this.reRender = !this.reRender;
        }, onClick: () => this.closePopupPopovers.emit() }), ((_a = this.popupTemplate.fieldInfos) === null || _a === void 0 ? void 0 : _a.length) && ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { text: this.strings.attributes, disabled: !this.hasRelationshipLayer, onClick: () => {
          this.closePopupPopovers.emit();
          if (!this.popupFieldSelectionPickList) {
            this.popupFieldSelectionPickList = document.createElement("arcgis-popup-field-pick-list");
            this.popupFieldSelectionPickList.popoverProps = {
              refElement: this.popupFlowItem,
              offsetSkidding: 50
            };
            this.popupFieldSelectionPickList.multiple = false;
            this.popupFieldSelectionPickList.heading = this.strings.addField;
            this.popupFieldSelectionPickList.addEventListener("arcgisPopupPickListDismissed", () => {
              this.closePopupPopovers.emit();
            });
            this.popupFieldSelectionPickList.addEventListener("arcgisPopupPickListChange", (event) => this.popupFieldSelectionPickListChanges(event, formType));
            document.body.appendChild(this.popupFieldSelectionPickList);
            this.disablePopupPanel.emit(true);
          }
        }, scale: "s", icon: "brackets-curly" })))));
    };
    this.guid = undefined;
    this.relatedRecordsContent = undefined;
    this.blockOpen = false;
    this.popupFlowItem = undefined;
    this.reRender = undefined;
    this.hasRelationshipLayer = true;
  }
  // --------------------------------------------------------------------------
  //
  //  Lifecycle
  //
  // --------------------------------------------------------------------------
  async componentWillLoad() {
    this.strings = _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.strings;
    this.layer = _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.layer;
    this.view = _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.mapView;
    this.popupTemplate = _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.popupTemplate;
    await this.loadAllModules();
    this.hasRelationshipLayer = await this.checkIfRelationshipExists();
    if (!this.relatedRecordsContent.title) {
      this.relatedRecordsContent.title = "";
    }
    if (!this.relatedRecordsContent.description) {
      this.relatedRecordsContent.description = "";
    }
  }
  componentDidLoad() {
    if (this.blockOpen) {
      this.blockOptions.scrollIntoView({ behavior: "smooth", block: "nearest", inline: "start" });
      this.blockOptions.setFocus();
    }
    this.watchForChangesToLayersList();
  }
  componentDidUpdate() {
    this.internalPopupUpdated.emit();
  }
  disconnectedCallback() {
    var _a;
    (_a = this.watchLayersTables) === null || _a === void 0 ? void 0 : _a.remove();
    if (this.popupFieldSelectionPickList) {
      document.body.removeChild(this.popupFieldSelectionPickList);
    }
    if (this.arcgisFieldPickList) {
      document.body.removeChild(this.arcgisFieldPickList);
    }
  }
  // --------------------------------------------------------------------------
  //
  // Events
  //
  // --------------------------------------------------------------------------
  closePopupPopoversHandler() {
    if (this.popupFieldSelectionPickList) {
      document.body.removeChild(this.popupFieldSelectionPickList);
      this.popupFieldSelectionPickList = null;
      this.disablePopupPanel.emit(false);
    }
    if (this.arcgisFieldPickList) {
      document.body.removeChild(this.arcgisFieldPickList);
      this.arcgisFieldPickList = null;
      this.disablePopupPanel.emit(false);
    }
  }
  // --------------------------------------------------------------------------
  //
  // Private Methods
  //
  // --------------------------------------------------------------------------
  async loadAllModules() {
    [this.RelatedRecordsInfoFieldOrder, this.reactiveUtils] = await (0,_loadModules_aaf30bd6_js__WEBPACK_IMPORTED_MODULE_4__.l)([
      "esri/popup/support/RelatedRecordsInfoFieldOrder",
      "esri/core/reactiveUtils"
    ]);
  }
  // field selection for title and caption
  popupFieldSelectionPickListChanges(event, formType) {
    const selectedFieldName = event.detail.selectedFields[0];
    if (formType === "title") {
      this.contentTitle.value = addSelectedFieldAtCursor(this.contentTitle, selectedFieldName);
      this.contentTitle.setFocus();
      this.relatedRecordsContent.title = this.contentTitle.value;
    }
    else if (formType === "description") {
      this.contentDescription.value = addSelectedFieldAtCursor(this.contentDescription, selectedFieldName);
      this.contentDescription.setFocus();
      this.relatedRecordsContent.description = this.contentDescription.value;
    }
    this.closePopupPopovers.emit();
    this.reRender = !this.reRender;
  }
  async openPickList(currLayer) {
    var _a, _b, _c;
    this.closePopupPopovers.emit();
    if (!this.arcgisFieldPickList) {
      this.arcgisFieldPickList = document.createElement("arcgis-field-pick-list");
      this.arcgisFieldPickList.popoverProps = {
        refElement: this.popupFlowItem,
        offsetSkidding: 50
      };
      this.arcgisFieldPickList.fields = currLayer.fields.filter((field) => field.visible);
      this.arcgisFieldPickList.layer = currLayer;
      this.arcgisFieldPickList.mapView = this.view;
      this.arcgisFieldPickList.showFieldInfo = true;
      this.arcgisFieldPickList.showFieldName = true;
      this.arcgisFieldPickList.selectedFields = [
        (_c = (_b = (_a = this.relatedRecordsContent) === null || _a === void 0 ? void 0 : _a.orderByFields) === null || _b === void 0 ? void 0 : _b[0]) === null || _c === void 0 ? void 0 : _c.field
      ];
      this.arcgisFieldPickList.addEventListener("arcgisFieldPickListDismissed", this.fieldPickListChanges);
      document.body.appendChild(this.arcgisFieldPickList);
      this.disablePopupPanel.emit(true);
    }
  }
  async checkIfRelationshipExists() {
    var _a;
    for (const relationship of (_a = this.layer) === null || _a === void 0 ? void 0 : _a.relationships) {
      if (relationship.id === this.relatedRecordsContent.relationshipId) {
        for (const currLayerOrTable of [...this.view.map.allLayers, ...this.view.map.allTables]) {
          const curr = currLayerOrTable;
          if (await relationshipExists(this.layer, curr, relationship)) {
            await curr.load();
            return Promise.resolve(true);
          }
        }
        return Promise.resolve(false);
      }
    }
    return Promise.resolve(false);
  }
  watchForChangesToLayersList() {
    this.watchLayersTables = this.reactiveUtils.watch(() => [this.view.map.allLayers.length, this.view.map.allTables.length], async () => {
      // check if related layer/table is removed, and disable panel/show warning if yes
      this.hasRelationshipLayer = await this.checkIfRelationshipExists();
    });
  }
  // --------------------------------------------------------------------------
  //
  // Rendor  Methods
  //
  // --------------------------------------------------------------------------
  render() {
    var _a, _b, _c, _d, _e, _f, _g;
    const relationship = ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-label", null, this.strings.relationship, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-dropdown", { disabled: !this.hasRelationshipLayer, overlayPositioning: "fixed", class: "dropdown" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { slot: "trigger", appearance: "outline-fill", kind: "neutral", iconEnd: "chevronDown", alignment: "icon-end-space-between", width: "full", scale: "m" }, (() => {
      for (const relationship of this.layer.relationships) {
        if (relationship.id === this.relatedRecordsContent.relationshipId) {
          return relationship.name || this.strings.relationship;
        }
      }
      return this.strings.relationship;
    })()), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-dropdown-group", null, this.layer.relationships.map((relationship) => {
      for (const currLayerOrTable of [
        ...this.view.map.allLayers,
        ...this.view.map.allTables
      ]) {
        const curr = currLayerOrTable;
        if (relationshipExistsCheckWithoutLoad(this.layer, curr, relationship)) {
          return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-dropdown-item", { selected: this.relatedRecordsContent.relationshipId === relationship.id, onClick: async () => {
              var _a;
              await curr.load();
              this.relatedRecordsContent.relationshipId = relationship.id;
              this.relatedRecordsContent.orderByFields = [
                new this.RelatedRecordsInfoFieldOrder({
                  field: curr.fields.find((field) => field.visible)
                    .name,
                  order: ((_a = this.relatedRecordsContent.orderByFields) === null || _a === void 0 ? void 0 : _a[0].order) || "asc"
                })
              ];
              this.reRender = !this.reRender;
            } }, relationship.name || this.strings.relationship));
        }
      }
    })))));
    const sortBy = ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-label", null, this.strings.sortBy, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { appearance: "outline-fill", kind: "neutral", iconEnd: "chevronDown", alignment: "icon-end-space-between", width: "full", scale: "m", disabled: !this.hasRelationshipLayer, onClick: async () => {
        // find the layer/table, and display the pick list based on the related layer/table
        this.layer.relationships.map(async (relationship) => {
          for (const currLayerOrTable of [
            ...this.view.map.allLayers,
            ...this.view.map.allTables
          ]) {
            const curr = currLayerOrTable;
            if (this.relatedRecordsContent.relationshipId === relationship.id &&
              relationshipExistsCheckWithoutLoad(this.layer, curr, relationship)) {
              this.openPickList(curr);
            }
          }
        });
      } }, ((_c = (_b = (_a = this.relatedRecordsContent) === null || _a === void 0 ? void 0 : _a.orderByFields) === null || _b === void 0 ? void 0 : _b[0]) === null || _c === void 0 ? void 0 : _c.field) || this.strings.default)));
    const sortOrder = ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-label", null, this.strings.sortOrder, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-dropdown", { disabled: !this.hasRelationshipLayer, overlayPositioning: "fixed" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { slot: "trigger", appearance: "outline-fill", kind: "neutral", iconEnd: "chevronDown", alignment: "icon-end-space-between", width: "full", scale: "m" }, ((_d = this.relatedRecordsContent.orderByFields) === null || _d === void 0 ? void 0 : _d[0].order) === "desc"
      ? this.strings.descending
      : this.strings.ascending), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-dropdown-item", { selected: ((_e = this.relatedRecordsContent.orderByFields) === null || _e === void 0 ? void 0 : _e[0].order) === "asc", onClick: () => {
        this.relatedRecordsContent.orderByFields[0].order = "asc";
        this.reRender = !this.reRender;
      } }, this.strings.ascending), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-dropdown-item", { selected: ((_f = this.relatedRecordsContent.orderByFields) === null || _f === void 0 ? void 0 : _f[0].order) === "desc", onClick: () => {
        this.relatedRecordsContent.orderByFields[0].order = "desc";
        this.reRender = !this.reRender;
      } }, this.strings.descending))));
    const previewCount = ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-label", null, this.strings.previewCount, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-dropdown", { disabled: !this.hasRelationshipLayer, overlayPositioning: "fixed" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { slot: "trigger", appearance: "outline-fill", kind: "neutral", iconEnd: "chevronDown", alignment: "icon-end-space-between", width: "full", scale: "m" }, (_g = (this.relatedRecordsContent.displayCount === 0
      ? this.strings.none
      : this.relatedRecordsContent.displayCount)) !== null && _g !== void 0 ? _g : 1), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-dropdown-group", null, [...Array(this.maxPreviewCount).keys()].map((x) => {
      return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-dropdown-item", { selected: this.relatedRecordsContent.displayCount === x, onClick: () => {
          this.relatedRecordsContent.displayCount = x;
          this.reRender = !this.reRender;
        } }, x === 0 ? this.strings.none : x));
    })))));
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)(_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.H, null, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-block", { dir: (0,_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_7__.g)(this.hostElement), heading: this.strings.relatedRecords, description: (this.relatedRecordsContent.title &&
        `${this.relatedRecordsContent.title.substring(0, 25)}${this.relatedRecordsContent.title.length > 25 ? "..." : ""}`) ||
        (() => {
          for (const relationship of this.layer.relationships) {
            if (relationship.id === this.relatedRecordsContent.relationshipId) {
              return relationship.name;
            }
          }
          return this.strings.selectTable;
        })(), collapsible: true, open: this.blockOpen, dragHandle: true, onCalciteBlockToggle: () => this.closePopupPopovers.emit() }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "ignore-elements-sortable", slot: "control" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-calcite-block-options", { ref: (el) => (this.blockOptions = el), guid: this.guid, intlOptions: this.strings.options, intlDelete: this.strings.delete, intlDuplicate: this.strings.duplicate, calciteBlockOptions: { hasDelete: true, hasDuplicate: this.hasRelationshipLayer } })), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { slot: "icon" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-icon", { scale: "m", icon: this.hasRelationshipLayer ? "link" : "exclamation-mark-triangle" })), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "ignore-elements-sortable" }, this.formInput("title", this.strings.title, (element) => {
      return (this.contentTitle = element);
    }, this.relatedRecordsContent.title, this.strings.enterTitle), this.formInput("description", this.strings.desc, (element) => {
      return (this.contentDescription = element);
    }, this.relatedRecordsContent.description, this.strings.enterDescription), relationship, sortBy, sortOrder, previewCount))));
  }
  get hostElement() { return (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.d)(this); }
};
ArcgisPopupRelationship.style = arcgisPopupRelationshipCss;

const ArcgisPopupRichtext = class {
  constructor(hostRef) {
    (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.r)(this, hostRef);
    this.closePopupPopovers = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "closePopupPopovers", 7);
    this.internalPopupUpdated = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "internalPopupUpdated", 7);
    this.richTextChangedReRender = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "richTextChangedReRender", 7);
    this.disablePopupPanel = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "disablePopupPanel", 7);
    this.arcadeExpMap = new Map();
    this.guid = undefined;
    this.fieldExpressionData = undefined;
    this.arcgisColorPickerData = undefined;
    this.richtextContent = undefined;
    this.blockOpen = false;
    this.popupFlowItem = undefined;
    this.reRender = undefined;
  }
  // lifecycle methods
  componentWillLoad() {
    this.strings = _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.strings;
    this.currentLanguage = _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.currentLanguage;
    this.popupTemplate = _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.popupTemplate;
  }
  componentDidLoad() {
    this.ckEditorMentionFieldsSetup();
    if (this.blockOpen) {
      const content = this.hostElement.shadowRoot.getElementById("content_Id");
      content.scrollIntoView({
        behavior: "auto",
        block: "nearest",
        inline: "start"
      });
      this.showRichTextEditor();
    }
  }
  componentDidUpdate() {
    this.internalPopupUpdated.emit();
  }
  disconnectedCallback() {
    if (this.arcgisCkeditor5) {
      document.body.removeChild(this.arcgisCkeditor5);
    }
  }
  // Events
  richTextChangedReRenderHandler(event) {
    event.stopPropagation();
    this.reRender = this.reRender ? false : true;
  }
  closeAllPopoversHandler() {
    if (this.arcgisCkeditor5) {
      document.body.removeChild(this.arcgisCkeditor5);
      this.arcgisCkeditor5 = null;
      this.disablePopupPanel.emit(false);
    }
  }
  ckEditorPopoverClosedHandler(event) {
    var _a, _b, _c, _d, _e;
    if (((_a = event.detail) === null || _a === void 0 ? void 0 : _a.guid) === this.guid) {
      event.stopPropagation();
      if (((_c = (_b = event.detail) === null || _b === void 0 ? void 0 : _b.data) === null || _c === void 0 ? void 0 : _c.length) || ((_e = (_d = event.detail) === null || _d === void 0 ? void 0 : _d.data) === null || _e === void 0 ? void 0 : _e.length) === 0) {
        this.richtextContent.text = event.detail.data;
        this.reRender = !this.reRender;
        this.richTextChangedReRender.emit();
      } // else null
      this.closePopupPopovers.emit();
    }
  }
  calciteBlockToggleHandler() {
    this.closePopupPopovers.emit();
  }
  // for arcade changes
  arcadeChangeNotificationHandler() {
    this.ckEditorMentionFieldsSetup();
  }
  // private methods and properties
  ckEditorMentionFieldsSetup() {
    var _a;
    this.arcadeExpMap = (0,_commonFunctions_5262b094_js__WEBPACK_IMPORTED_MODULE_3__.e)(this.popupTemplate);
    this.ckEditorMentionFields = [];
    (_a = this.popupTemplate.fieldInfos) === null || _a === void 0 ? void 0 : _a.forEach((field) => {
      if (field.fieldName) {
        this.ckEditorMentionFields.push({
          id: "{" + field.fieldName + "}",
          name: (0,_commonFunctions_5262b094_js__WEBPACK_IMPORTED_MODULE_3__.b)(field, this.arcadeExpMap)
        });
      }
    });
  }
  getTextFromHtml(totalChars) {
    var _a;
    const tempHtml = (_a = this.richtextContent.text) !== null && _a !== void 0 ? _a : "";
    const tempDiv = document.createElement("div");
    tempDiv.innerHTML = tempHtml;
    const tempString = tempDiv.textContent || tempDiv.innerText || "";
    return `${tempString.substring(0, totalChars)}${tempString.length > totalChars ? "..." : ""}`;
  }
  showRichTextEditor() {
    var _a, _b;
    this.closePopupPopovers.emit();
    this.arcgisCkeditor5 = document.createElement("arcgis-ckeditor5");
    this.arcgisCkeditor5.fieldExpressionConfig = this.fieldExpressionData;
    this.arcgisCkeditor5.arcgisColorPickerConfig = Object.assign(Object.assign({}, this.arcgisColorPickerData), { enableFields: this.arcgisColorPickerData.data && this.arcgisColorPickerData.data.length ? true : false });
    this.arcgisCkeditor5.guid = this.guid;
    this.arcgisCkeditor5.refElement = this.popupFlowItem;
    this.arcgisCkeditor5.textData = (_a = this.richtextContent.text) !== null && _a !== void 0 ? _a : "";
    this.arcgisCkeditor5.ckEditorMentionFields = this.ckEditorMentionFields;
    this.arcgisCkeditor5.intlTextPlaceHolder =
      ((_b = this.popupTemplate.fieldInfos) === null || _b === void 0 ? void 0 : _b.length) > 0
        ? this.strings.textPlaceHolder
        : this.strings.textPlaceHolderLabel;
    this.arcgisCkeditor5.intlOk = this.strings.ok;
    this.arcgisCkeditor5.intlCancel = this.strings.cancel;
    this.arcgisCkeditor5.currentLanguage = this.currentLanguage;
    document.body.appendChild(this.arcgisCkeditor5);
    this.arcgisCkeditor5.setFocus();
    this.disablePopupPanel.emit(true);
  }
  // rendor methods
  render() {
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)(_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.H, null, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-block", { dir: (0,_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_7__.g)(this.hostElement), id: "richText_Id", heading: this.strings.text, description: this.getTextFromHtml(25), open: this.blockOpen, collapsible: true, dragHandle: true }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "ignore-elements-sortable", slot: "control" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-calcite-block-options", { guid: this.guid, intlOptions: this.strings.options, intlDelete: this.strings.delete, intlDuplicate: this.strings.duplicate, calciteBlockOptions: { hasDelete: true, hasDuplicate: true } })), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { slot: "icon" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-icon", { scale: "m", icon: "text" })), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "ignore-elements-sortable", id: "content_Id" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { appearance: "transparent", width: "full", onClick: () => this.showRichTextEditor() }, this.strings.editText)))));
  }
  get hostElement() { return (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.d)(this); }
};

const CSS = {
  formInputButton: "form-input-button"
};

const arcgisPopupTitleCss = ".form-input-button{display:flex}.form-input-button calcite-input[type=text]{display:flex;flex-flow:column nowrap;flex:1 0 0%;overflow:hidden}.form-input-button calcite-action{margin:0;flex:0 0 0%;justify-self:flex-end}";

const ArcgisPopupTitle = class {
  constructor(hostRef) {
    (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.r)(this, hostRef);
    this.closePopupPopovers = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "closePopupPopovers", 7);
    this.titleChangedReRender = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "titleChangedReRender", 7);
    this.internalPopupUpdated = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "internalPopupUpdated", 7);
    this.disablePopupPanel = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "disablePopupPanel", 7);
    // private methods and properties
    this.changeTitle = () => {
      this.popupTemplate.title = this.titleInput.value;
      this.internalPopupUpdated.emit();
      this.titleChangedReRender.emit();
    };
    // open popover
    this.openAttributesList = (event) => {
      event.stopPropagation();
      // close first since we can have multiple attributes open
      this.closePopupPopovers.emit();
      // lazy load attribute selection component
      if (!this.popupFieldSelectionPickList) {
        this.popupFieldSelectionPickList = document.createElement("arcgis-popup-field-pick-list");
        this.popupFieldSelectionPickList.popoverProps = {
          refElement: this.popupFlowItem
        };
        this.popupFieldSelectionPickList.multiple = false;
        this.popupFieldSelectionPickList.heading = this.strings.addField;
        this.popupFieldSelectionPickList.addEventListener("arcgisPopupPickListDismissed", () => {
          this.closePopupPopovers.emit();
        });
        this.popupFieldSelectionPickList.addEventListener("arcgisPopupPickListChange", this.popupFieldSelectionPickListChanges);
        document.body.appendChild(this.popupFieldSelectionPickList);
        this.disablePopupPanel.emit(true);
      }
    };
    this.popupFieldSelectionPickListChanges = (event) => {
      const selectedFieldName = event.detail.selectedFields[0];
      this.titleInput.value = addSelectedFieldAtCursor(this.titleInput, selectedFieldName);
      this.titleInput.setFocus();
      this.popupTemplate.title = this.titleInput.value;
      this.changeTitle();
      this.closePopupPopovers.emit();
    };
    this.popupFlowItem = undefined;
    this.reRender = undefined;
  }
  // lifecycle methods
  componentWillLoad() {
    this.strings = _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.strings;
    this.popupTemplate = _popupStore_a5d93b58_js__WEBPACK_IMPORTED_MODULE_9__.p.popupTemplate;
  }
  componentDidLoad() {
    this.guidForSelection = (0,_guid_4f4176ba_js__WEBPACK_IMPORTED_MODULE_5__.g)();
  }
  // Events
  titleChangedReRenderHandler(event) {
    event.stopPropagation();
    this.reRender = this.reRender ? false : true;
  }
  closePopupPopoversHandler() {
    if (this.popupFieldSelectionPickList) {
      document.body.removeChild(this.popupFieldSelectionPickList);
      this.popupFieldSelectionPickList = null;
      this.titleInput.setFocus();
      this.disablePopupPanel.emit(false);
    }
  }
  // rendor methods
  render() {
    var _a;
    const popupTitle = this.popupTemplate.title;
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)(_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.H, null, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-block", { dir: (0,_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_7__.g)(this.hostElement), heading: this.strings.popupTitle, description: popupTitle && `${popupTitle.substring(0, 25)}${popupTitle.length > 25 ? "..." : ""}`, collapsible: true }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { slot: "icon" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-icon", { scale: "m", icon: "title" })), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS.formInputButton }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-input", { type: "text", autofocus: true, ref: (element) => {
        this.titleInput = element;
      }, value: popupTitle, onCalciteInputInput: (event) => {
        event.stopPropagation();
        this.changeTitle();
      }, onClick: () => this.closePopupPopovers.emit() }), ((_a = this.popupTemplate.fieldInfos) === null || _a === void 0 ? void 0 : _a.length) > 0 && ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { scale: "s", text: this.strings.attributes, onClick: this.openAttributesList, icon: "brackets-curly" }))))));
  }
  get hostElement() { return (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.d)(this); }
};
ArcgisPopupTitle.style = arcgisPopupTitleCss;




/***/ }),

/***/ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/guid-4f4176ba.js":
/*!**********************************************************************************************************!*\
  !*** ./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/guid-4f4176ba.js ***!
  \**********************************************************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   g: () => (/* binding */ guid)
/* harmony export */ });
/*!
 * All material copyright ESRI, All Rights Reserved, unless otherwise specified.
 * v3.0.99
 */
function generateId(counts) {
  return counts
    .map((count) => {
    let out = "";
    for (let i = 0; i < count; i++) {
      out += (((1 + Math.random()) * 0x10000) | 0).toString(16).substring(1);
    }
    return out;
  })
    .join("-");
}
const guid = () => generateId([2, 1, 1, 1, 3]);




/***/ }),

/***/ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/index-81d548b7.js":
/*!***********************************************************************************************************!*\
  !*** ./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/index-81d548b7.js ***!
  \***********************************************************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   c: () => (/* binding */ createStore)
/* harmony export */ });
/* harmony import */ var _index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./index-92ebb396.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/index-92ebb396.js");
/*!
 * All material copyright ESRI, All Rights Reserved, unless otherwise specified.
 * v3.0.99
 */


const appendToMap = (map, propName, value) => {
    const items = map.get(propName);
    if (!items) {
        map.set(propName, [value]);
    }
    else if (!items.includes(value)) {
        items.push(value);
    }
};
const debounce = (fn, ms) => {
    let timeoutId;
    return (...args) => {
        if (timeoutId) {
            clearTimeout(timeoutId);
        }
        timeoutId = setTimeout(() => {
            timeoutId = 0;
            fn(...args);
        }, ms);
    };
};

/**
 * Check if a possible element isConnected.
 * The property might not be there, so we check for it.
 *
 * We want it to return true if isConnected is not a property,
 * otherwise we would remove these elements and would not update.
 *
 * Better leak in Edge than to be useless.
 */
const isConnected = (maybeElement) => !('isConnected' in maybeElement) || maybeElement.isConnected;
const cleanupElements = debounce((map) => {
    for (let key of map.keys()) {
        map.set(key, map.get(key).filter(isConnected));
    }
}, 2000);
const stencilSubscription = () => {
    if (typeof _index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.g !== 'function') {
        // If we are not in a stencil project, we do nothing.
        // This function is not really exported by @stencil/core.
        return {};
    }
    const elmsToUpdate = new Map();
    return {
        dispose: () => elmsToUpdate.clear(),
        get: (propName) => {
            const elm = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.g)();
            if (elm) {
                appendToMap(elmsToUpdate, propName, elm);
            }
        },
        set: (propName) => {
            const elements = elmsToUpdate.get(propName);
            if (elements) {
                elmsToUpdate.set(propName, elements.filter(_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.f));
            }
            cleanupElements(elmsToUpdate);
        },
        reset: () => {
            elmsToUpdate.forEach((elms) => elms.forEach(_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.f));
            cleanupElements(elmsToUpdate);
        },
    };
};

const unwrap = (val) => (typeof val === 'function' ? val() : val);
const createObservableMap = (defaultState, shouldUpdate = (a, b) => a !== b) => {
    const unwrappedState = unwrap(defaultState);
    let states = new Map(Object.entries(unwrappedState !== null && unwrappedState !== void 0 ? unwrappedState : {}));
    const handlers = {
        dispose: [],
        get: [],
        set: [],
        reset: [],
    };
    const reset = () => {
        var _a;
        // When resetting the state, the default state may be a function - unwrap it to invoke it.
        // otherwise, the state won't be properly reset
        states = new Map(Object.entries((_a = unwrap(defaultState)) !== null && _a !== void 0 ? _a : {}));
        handlers.reset.forEach((cb) => cb());
    };
    const dispose = () => {
        // Call first dispose as resetting the state would
        // cause less updates ;)
        handlers.dispose.forEach((cb) => cb());
        reset();
    };
    const get = (propName) => {
        handlers.get.forEach((cb) => cb(propName));
        return states.get(propName);
    };
    const set = (propName, value) => {
        const oldValue = states.get(propName);
        if (shouldUpdate(value, oldValue, propName)) {
            states.set(propName, value);
            handlers.set.forEach((cb) => cb(propName, value, oldValue));
        }
    };
    const state = (typeof Proxy === 'undefined'
        ? {}
        : new Proxy(unwrappedState, {
            get(_, propName) {
                return get(propName);
            },
            ownKeys(_) {
                return Array.from(states.keys());
            },
            getOwnPropertyDescriptor() {
                return {
                    enumerable: true,
                    configurable: true,
                };
            },
            has(_, propName) {
                return states.has(propName);
            },
            set(_, propName, value) {
                set(propName, value);
                return true;
            },
        }));
    const on = (eventName, callback) => {
        handlers[eventName].push(callback);
        return () => {
            removeFromArray(handlers[eventName], callback);
        };
    };
    const onChange = (propName, cb) => {
        const unSet = on('set', (key, newValue) => {
            if (key === propName) {
                cb(newValue);
            }
        });
        // We need to unwrap the defaultState because it might be a function.
        // Otherwise we might not be sending the right reset value.
        const unReset = on('reset', () => cb(unwrap(defaultState)[propName]));
        return () => {
            unSet();
            unReset();
        };
    };
    const use = (...subscriptions) => {
        const unsubs = subscriptions.reduce((unsubs, subscription) => {
            if (subscription.set) {
                unsubs.push(on('set', subscription.set));
            }
            if (subscription.get) {
                unsubs.push(on('get', subscription.get));
            }
            if (subscription.reset) {
                unsubs.push(on('reset', subscription.reset));
            }
            if (subscription.dispose) {
                unsubs.push(on('dispose', subscription.dispose));
            }
            return unsubs;
        }, []);
        return () => unsubs.forEach((unsub) => unsub());
    };
    const forceUpdate = (key) => {
        const oldValue = states.get(key);
        handlers.set.forEach((cb) => cb(key, oldValue, oldValue));
    };
    return {
        state,
        get,
        set,
        on,
        onChange,
        use,
        dispose,
        reset,
        forceUpdate,
    };
};
const removeFromArray = (array, item) => {
    const index = array.indexOf(item);
    if (index >= 0) {
        array[index] = array[array.length - 1];
        array.length--;
    }
};

const createStore = (defaultState, shouldUpdate) => {
    const map = createObservableMap(defaultState, shouldUpdate);
    map.use(stencilSubscription());
    return map;
};




/***/ }),

/***/ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/popupStore-a5d93b58.js":
/*!****************************************************************************************************************!*\
  !*** ./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/popupStore-a5d93b58.js ***!
  \****************************************************************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   c: () => (/* binding */ clearPopupState),
/* harmony export */   p: () => (/* binding */ popupState)
/* harmony export */ });
/* harmony import */ var _index_81d548b7_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./index-81d548b7.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/index-81d548b7.js");
/*!
 * All material copyright ESRI, All Rights Reserved, unless otherwise specified.
 * v3.0.99
 */


const popupStore = (0,_index_81d548b7_js__WEBPACK_IMPORTED_MODULE_0__.c)({
  layer: null,
  mapView: null,
  portal: null,
  config: null,
  strings: null,
  currentLanguage: null,
  currentLanguageIntl: null,
  serviceType: null,
  popupTemplate: null,
  layerHasAttachment: null,
  layerHasET: null,
  layerHasAttributes: null,
  layerHasCharts: null,
  layerHasImages: null,
  layerHasText: null,
  layerDisplayType: null,
  supportsArcade: null,
  layerHasRelatedRecords: false
});
// workaround for starting a panel with a clean state
function clearPopupState(popupState) {
  popupState.layer = null;
  popupState.mapView = null;
  popupState.portal = null;
  popupState.config = null;
  popupState.strings = null;
  popupState.currentLanguage = null;
  popupState.currentLanguageIntl = null;
  popupState.serviceType = null;
  popupState.popupTemplate = null;
  popupState.layerHasAttachment = null;
  popupState.layerHasET = null;
  popupState.layerHasAttributes = null;
  popupState.layerHasCharts = null;
  popupState.layerHasImages = null;
  popupState.layerHasText = null;
  popupState.layerDisplayType = null;
  popupState.supportsArcade = null;
  popupState.layerHasRelatedRecords = false;
}
const popupState = popupStore.state;




/***/ })

}]);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2lkZ2V0cy9jaHVua3MvYXJjZ2lzX2FuYWx5c2lzX25vZGVfbW9kdWxlc19hcmNnaXNfYXBwLWNvbXBvbmVudHNfZGlzdF9lc21fYXJjZ2lzLWFkMGI0Yy5qcyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDK0g7QUFDekQ7QUFDMEg7QUFDaUs7QUFDcFM7QUFDZDtBQUM4QztBQUM3QjtBQUNQO0FBQ3dCO0FBQ3REO0FBQ0U7O0FBRTdCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EscURBQXFELEVBQUUsbUJBQW1CO0FBQzFFO0FBQ0E7QUFDQSxjQUFjLG9CQUFvQixFQUFFLG1CQUFtQjtBQUN2RDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxPQUFPLHVEQUFlLFVBQVUsdURBQWU7QUFDL0M7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxPQUFPLHVEQUFlLFVBQVUsdURBQWU7QUFDL0M7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxtQkFBbUI7QUFDbkI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxDQUFDLDRDQUE0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QUFvQjtBQUN4RDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGdDQUFnQywrREFBc0I7QUFDdEQsd0JBQXdCLCtEQUEyQjtBQUNuRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxhQUFhO0FBQ2I7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxtR0FBbUcsMkRBQVc7QUFDOUc7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsT0FBTztBQUNQO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsT0FBTztBQUNQO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsT0FBTztBQUNQO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsT0FBTztBQUNQO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSx3QkFBd0IscURBQUMsZ0NBQWdDO0FBQ3pEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTLEVBQUUscURBQUMscUNBQXFDO0FBQ2pELG1FQUFtRSxxQkFBcUIscURBQUMscUNBQXFDLDJJQUEySSxzQkFBc0IscURBQUMscUNBQXFDLGlJQUFpSTtBQUN0Yyx5QkFBeUIscURBQUMsZ0NBQWdDLHlJQUF5SSxnQkFBZ0I7QUFDbk47QUFDQTtBQUNBO0FBQ0E7QUFDQSxPQUFPLG9IQUFvSDtBQUMzSCx5QkFBeUIscURBQUMsb0JBQW9CLGdDQUFnQyw0QkFBNEIscURBQUMscUJBQXFCO0FBQ2hJO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFFBQVEscURBQVc7QUFDbkIsU0FBUyxFQUFFLHFEQUFDLG1CQUFtQiwyQkFBMkI7QUFDMUQ7QUFDQSx1QkFBdUIscURBQUMsY0FBYyxxREFBQyxxQkFBcUI7QUFDNUQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxXQUFXO0FBQ1g7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTLGtDQUFrQyxxREFBQyxtQkFBbUI7QUFDL0Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsV0FBVztBQUNYLFNBQVM7QUFDVDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFdBQVc7QUFDWDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxXQUFXO0FBQ1g7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQSx3RUFBd0UscURBQUMsY0FBYywyQkFBMkIsRUFBRSxxREFBQyxZQUFZLGdDQUFnQyx1Q0FBdUMscURBQUMscUJBQXFCO0FBQzlOO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNULDRCQUE0QixxREFBQyw0QkFBNEI7QUFDekQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFNBQVMsRUFBRSxxREFBQyxVQUFVLDRDQUE0QyxFQUFFLHFEQUFDLGFBQWE7QUFDbEY7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTLEVBQUUscURBQUMsV0FBVyx5Q0FBeUM7QUFDaEUsUUFBUSwrREFBbUI7QUFDM0IsbUNBQW1DLHFEQUFDLFdBQVcseUNBQXlDLEVBQUUscURBQUMsbUJBQW1CLDRCQUE0QjtBQUMxSSxxQkFBcUIscURBQUMscUJBQXFCLHNIQUFzSDtBQUNqSyxZQUFZLHFEQUFDLENBQUMsaURBQUksSUFBSSx3QkFBd0IsRUFBRSxxREFBQyxzQkFBc0IsS0FBSyw0REFBYTtBQUN6RjtBQUNBLE9BQU8seUJBQXlCLEVBQUUscURBQUMsb0JBQW9CO0FBQ3ZELGtCQUFrQiw4Q0FBOEM7QUFDaEUsT0FBTyw2REFBNkQsRUFBRSxxREFBQyxVQUFVLHdCQUF3Qix5Q0FBeUMscURBQUMsVUFBVSw4QkFBOEI7QUFDM0w7QUFDQTtBQUNBLFlBQVksb0NBQW9DO0FBQ2hEO0FBQ0E7QUFDQTtBQUNBLFlBQVkscURBQUMsVUFBVSw4QkFBOEIsd0NBQXdDO0FBQzdGO0FBQ0E7QUFDQTtBQUNBLE9BQU87QUFDUDtBQUNBLFNBQVM7QUFDVDtBQUNBO0FBQ0E7QUFDQSxZQUFZLDZCQUE2QjtBQUN6QztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMLGlFQUFpRSxrQkFBa0I7QUFDbkY7QUFDQTtBQUNBO0FBQ0E7QUFDQSxNQUFNLHFEQUFXO0FBQ2pCLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQSxzRUFBc0U7QUFDdEU7QUFDQTtBQUNBO0FBQ0EsWUFBWSx3Q0FBd0M7QUFDcEQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHNCQUFzQixPQUFPLHFEQUFVO0FBQ3ZDO0FBQ0E7O0FBRUE7QUFDQTtBQUNBLElBQUkscURBQWdCO0FBQ3BCLG9DQUFvQyxxREFBVztBQUMvQyxnQ0FBZ0MscURBQVc7QUFDM0M7QUFDQTtBQUNBO0FBQ0EsOENBQThDLHFEQUFDLDhCQUE4Qix5Q0FBeUMsRUFBRSx1REFBbUIsWUFBWSxFQUFFLGtCQUFrQjtBQUMzSztBQUNBLGdCQUFnQixFQUFFLHVEQUFtQixZQUFZLEVBQUUsa0JBQWtCO0FBQ3JFLE9BQU8sNkRBQTZELEVBQUUscURBQUMscUJBQXFCLDZJQUE2SSxFQUFFLHFEQUFDLG1CQUFtQix1QkFBdUI7QUFDdFI7QUFDQTtBQUNBO0FBQ0EsaUJBQWlCLHNEQUFVO0FBQzNCLG1CQUFtQixzREFBVTtBQUM3QixrQkFBa0Isc0RBQVU7QUFDNUIsa0JBQWtCLHNEQUFVO0FBQzVCLG1CQUFtQixzREFBVTtBQUM3QiwyQkFBMkIsc0RBQVU7QUFDckMsdUJBQXVCLHNEQUFVO0FBQ2pDLHlCQUF5QixzREFBVTtBQUNuQyw0QkFBNEIsc0RBQVU7QUFDdEM7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLE9BQU87QUFDUDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsdURBQXVELDJEQUFXO0FBQ2xFO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLE9BQU87QUFDUDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQSw4QkFBOEIscURBQUMsa0JBQWtCLHVSQUF1UjtBQUN4VSxZQUFZLHFEQUFDLENBQUMsaURBQUksSUFBSSwrQkFBK0IsRUFBRSxxREFBQyx3QkFBd0IsS0FBSyw0REFBYSw4R0FBOEcscUdBQXFHLHFEQUFDLHlCQUF5QiwwRUFBMEU7QUFDelo7QUFDQSxzQkFBc0IsT0FBTyxxREFBVTtBQUN2Qzs7QUFFQSw4Q0FBOEMsWUFBWSxPQUFPLGlCQUFpQixTQUFTLCtCQUErQixzQkFBc0IsaUJBQWlCLFFBQVEsV0FBVyxvQkFBb0IsYUFBYSx1QkFBdUIsaUJBQWlCOztBQUU3UDtBQUNBO0FBQ0EsSUFBSSxxREFBZ0I7QUFDcEIsd0NBQXdDLHFEQUFXO0FBQ25ELHFDQUFxQyxxREFBVztBQUNoRCxvQ0FBb0MscURBQVc7QUFDL0M7QUFDQSxpREFBaUQscURBQUMsNkJBQTZCLHFGQUFxRixFQUFFLFlBQVk7QUFDbEw7QUFDQTtBQUNBO0FBQ0EsU0FBUyw0QkFBNEIsdURBQW9CO0FBQ3pELDJCQUEyQix1REFBbUIsbUJBQW1CLHFEQUFDLHFCQUFxQjtBQUN2RjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFNBQVM7QUFDVCx1REFBdUQscURBQUMsNkJBQTZCLHFGQUFxRixFQUFFLFlBQVk7QUFDeEw7QUFDQTtBQUNBO0FBQ0EsU0FBUyxFQUFFLHFEQUFDLFVBQVUsa0RBQWtELEVBQUUscURBQUMscUJBQXFCLHNIQUFzSCx1REFBYztBQUNwTztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUyxHQUFHLHFEQUFDLHFCQUFxQjtBQUNsQztBQUNBLHNDQUFzQyxTQUFTO0FBQy9DO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0EsV0FBVztBQUNYO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSx1QkFBdUIsdURBQVc7QUFDbEM7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsaUJBQWlCLHNEQUFVO0FBQzNCLG1CQUFtQixzREFBVTtBQUM3QixrQkFBa0Isc0RBQVU7QUFDNUIsa0JBQWtCLHNEQUFVO0FBQzVCLG1CQUFtQixzREFBVTtBQUM3QiwyQkFBMkIsc0RBQVU7QUFDckMsK0JBQStCLHNEQUFVO0FBQ3pDLHVCQUF1QixzREFBVTtBQUNqQyx5QkFBeUIsc0RBQVU7QUFDbkMsNEJBQTRCLHNEQUFVO0FBQ3RDLDBCQUEwQixzREFBVTtBQUNwQyxnQ0FBZ0MsK0RBQXNCO0FBQ3RELHdCQUF3QiwrREFBMkI7QUFDbkQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSx3QkFBd0IsK0RBQTJCO0FBQ25EO0FBQ0Esa0NBQWtDLHVEQUFtQjtBQUNyRCxLQUFLO0FBQ0w7QUFDQSxpQ0FBaUMsdURBQW1CO0FBQ3BELEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsNkJBQTZCLHVEQUFXO0FBQ3hDO0FBQ0E7QUFDQSxrQ0FBa0MsdURBQVc7QUFDN0M7QUFDQTtBQUNBLGtDQUFrQyx1REFBVztBQUM3QztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLE9BQU87QUFDUCxLQUFLO0FBQ0w7QUFDQTtBQUNBLHVEQUF1RCwyREFBVztBQUNsRTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSx5QkFBeUIsdURBQW1CLFlBQVksRUFBRSxxQkFBcUI7QUFDL0U7QUFDQTtBQUNBO0FBQ0E7QUFDQSxPQUFPO0FBQ1A7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSw0Q0FBNEMsbURBQW1EO0FBQy9GO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxxQ0FBcUMsK0RBQWtCO0FBQ3ZEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGlCQUFpQiwrREFBbUI7QUFDcEMsZ0JBQWdCLCtEQUFZO0FBQzVCLFNBQVM7QUFDVDtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQSxlQUFlLCtEQUFtQjtBQUNsQyxjQUFjLCtEQUFZO0FBQzFCLE9BQU87QUFDUCxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0Esd0JBQXdCLHVEQUFjO0FBQ3RDLHdCQUF3Qix1REFBYztBQUN0Qyx3QkFBd0IsdURBQWM7QUFDdEMsd0JBQXdCLHVEQUFjO0FBQ3RDLHdCQUF3Qix1REFBYztBQUN0Qyx3QkFBd0IsdURBQWM7QUFDdEMsd0JBQXdCLHVEQUFjO0FBQ3RDLHdCQUF3Qix1REFBYztBQUN0QywrQ0FBK0MsdURBQW1CO0FBQ2xFO0FBQ0E7QUFDQSxPQUFPO0FBQ1A7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0Esb0JBQW9CLHFEQUFDLHFCQUFxQjtBQUMxQztBQUNBO0FBQ0EsU0FBUztBQUNULFNBQVM7QUFDVCx1QkFBdUIscURBQUMscUJBQXFCLHlJQUF5STtBQUN0TCxrQkFBa0IscURBQUMsdUJBQXVCLDRFQUE0RSxFQUFFLHFEQUFDLHFCQUFxQixvRUFBb0UsRUFBRSxxREFBQyxtQkFBbUIsb0NBQW9DLElBQUkscURBQUMsaUNBQWlDLHFEQUFDLDRCQUE0QiwrQkFBK0IsdURBQVcsNkNBQTZDLHVEQUFXLFdBQVcseUJBQXlCLHFEQUFDLDRCQUE0QiwrQkFBK0IsdURBQVcsNkNBQTZDLHVEQUFXLFdBQVcsNkJBQTZCLHFEQUFDLDRCQUE0QiwrQkFBK0IsdURBQVcsMENBQTBDLHVEQUFXLFFBQVEsc0JBQXNCLHFEQUFDLDRCQUE0QiwrQkFBK0IsdURBQVcsMkNBQTJDLHVEQUFXLFNBQVM7QUFDNTVCLDBCQUEwQixxREFBQyxVQUFVLCtCQUErQixFQUFFLHFEQUFDLHFCQUFxQjtBQUM1RjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGFBQWE7QUFDYjtBQUNBLFNBQVM7QUFDVCwrQkFBK0IscURBQUMscUJBQXFCO0FBQ3JEO0FBQ0EsU0FBUztBQUNULFlBQVkscURBQUMsQ0FBQyxpREFBSSxJQUFJLHdCQUF3QixFQUFFLHFEQUFDLHNCQUFzQixLQUFLLDREQUFhO0FBQ3pGLCtOQUErTixFQUFFLHFEQUFDLG1CQUFtQjtBQUNyUDtBQUNBLE9BQU87QUFDUCxrQkFBa0I7QUFDbEIscUVBQXFFO0FBQ3JFLFNBQVMsRUFBRSxxREFBQyx3QkFBd0IseUtBQXlLLEVBQUUscURBQUMsVUFBVSxpQ0FBaUMsb0dBQW9HLHFEQUFDLHdCQUF3QjtBQUN4WDtBQUNBLE9BQU87QUFDUDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxhQUFhO0FBQ2I7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFNBQVM7QUFDVDtBQUNBLG1EQUFtRCxxQ0FBcUM7QUFDeEY7QUFDQSxTQUFTLDhHQUE4RyxxREFBQyw4QkFBOEIseUNBQXlDO0FBQy9MO0FBQ0EsS0FBSyxNQUFNLHFEQUFDLG9CQUFvQixxQkFBcUIsa0NBQWtDLHFEQUFDLDhCQUE4QixrRUFBa0U7QUFDeEw7QUFDQSxLQUFLO0FBQ0w7QUFDQSxzQkFBc0IsT0FBTyxxREFBVTtBQUN2QztBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUEsZ0RBQWdELDhDQUE4QywwRUFBMEUsK0JBQStCLGVBQWUsZUFBZSxtQkFBbUIsYUFBYSw0Q0FBNEMsYUFBYSx3QkFBd0IsWUFBWSxnQkFBZ0Isa0NBQWtDLFNBQVMsWUFBWSxzQkFBc0IscUJBQXFCLFdBQVc7O0FBRS9kO0FBQ0E7QUFDQSxJQUFJLHFEQUFnQjtBQUNwQiw4QkFBOEIscURBQVc7QUFDekMsZ0NBQWdDLHFEQUFXO0FBQzNDLGtDQUFrQyxxREFBVztBQUM3QztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxjQUFjLHFEQUFDLG9CQUFvQixZQUFZLCtCQUErQixxREFBQyxVQUFVLDhEQUE4RCxFQUFFLHFEQUFDLG9CQUFvQiw4TUFBOE0saUdBQWlHLHFEQUFDLHFCQUFxQixrS0FBa0s7QUFDcnBCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGdEQUFnRCw0QkFBNEI7QUFDNUUsNkJBQTZCLHVEQUE0QjtBQUN6RDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0Esa0NBQWtDLHVEQUE0QjtBQUM5RDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0Esa0NBQWtDLHVEQUE0QjtBQUM5RDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0Esa0NBQWtDLHVEQUE0QjtBQUM5RDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0Esa0NBQWtDLHVEQUE0QjtBQUM5RDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLG1CQUFtQixzREFBVTtBQUM3Qix5QkFBeUIsc0RBQVU7QUFDbkM7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHlDQUF5Qyx1REFBNEI7QUFDckU7QUFDQTtBQUNBO0FBQ0EsOENBQThDLHVEQUE0QjtBQUMxRTtBQUNBO0FBQ0E7QUFDQSw4Q0FBOEMsdURBQTRCO0FBQzFFO0FBQ0E7QUFDQTtBQUNBLDhDQUE4Qyx1REFBNEI7QUFDMUU7QUFDQTtBQUNBO0FBQ0EsOENBQThDLHVEQUE0QjtBQUMxRTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLCtCQUErQixxREFBQyw0QkFBNEIsMEpBQTBKLEVBQUUscURBQUMsVUFBVSx3QkFBd0IsRUFBRSxxREFBQyxvQkFBb0IsOEJBQThCLEVBQUUscURBQUMsb0JBQW9CO0FBQ3ZVO0FBQ0E7QUFDQSxPQUFPO0FBQ1A7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFNBQVM7QUFDVCxzQkFBc0IscURBQUMsVUFBVSxtQ0FBbUMsc0JBQXNCLHVEQUE0QixhQUFhLHFEQUFDLDRCQUE0Qix3Q0FBd0Msc0JBQXNCLHVEQUE0Qiw2QkFBNkIsdURBQTRCLCtCQUErQix1REFBNEIsK0JBQStCLHVEQUE0QjtBQUN6YSxxQkFBcUIscURBQUMscUJBQXFCLHNIQUFzSDtBQUNqSyxZQUFZLHFEQUFDLENBQUMsaURBQUksSUFBSSx3QkFBd0IsRUFBRSxxREFBQyxzQkFBc0IsS0FBSyw0REFBYTtBQUN6RjtBQUNBLE9BQU8sbUVBQW1FLEVBQUUscURBQUMsb0JBQW9CO0FBQ2pHLGtCQUFrQiw4Q0FBOEM7QUFDaEUsT0FBTyw2REFBNkQsRUFBRSxxREFBQyxVQUFVLHdCQUF3Qix5Q0FBeUMscURBQUMsVUFBVSw4QkFBOEI7QUFDM0w7QUFDQSxzQkFBc0IsT0FBTyxxREFBVTtBQUN2QztBQUNBOztBQUVBO0FBQ0E7QUFDQSxJQUFJLHFEQUFnQjtBQUNwQiw4QkFBOEIscURBQVc7QUFDekMscUNBQXFDLHFEQUFXO0FBQ2hELCtDQUErQyxxREFBVztBQUMxRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxtQkFBbUIsc0RBQVU7QUFDN0IsOEJBQThCLHNEQUFVO0FBQ3hDLHNCQUFzQixzREFBVTtBQUNoQyw4QkFBOEIsc0RBQVU7QUFDeEMsMEJBQTBCLHNEQUFVO0FBQ3BDLDBCQUEwQixzREFBVTtBQUNwQyx3QkFBd0Isc0RBQVU7QUFDbEMseUJBQXlCLHNEQUFVO0FBQ25DLDBCQUEwQixzREFBVTtBQUNwQztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxzREFBc0QsbUNBQW1DO0FBQ3pGO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0Esd0JBQXdCLHFEQUFDLHFCQUFxQjtBQUM5QztBQUNBLFNBQVMsRUFBRSxxREFBQyxtQkFBbUIscUNBQXFDO0FBQ3BFLHlCQUF5QixxREFBQyxxQkFBcUI7QUFDL0M7QUFDQSxPQUFPLG9EQUFvRCxFQUFFLHFEQUFDLG1CQUFtQixnQ0FBZ0M7QUFDakgsb0JBQW9CLHFEQUFDLHFCQUFxQjtBQUMxQztBQUNBLFNBQVMsRUFBRSxxREFBQyxtQkFBbUIsK0JBQStCO0FBQzlELG9CQUFvQixxREFBQyxxQkFBcUI7QUFDMUM7QUFDQSxTQUFTLEVBQUUscURBQUMsbUJBQW1CLDJCQUEyQjtBQUMxRCxzQkFBc0IscURBQUMscUJBQXFCO0FBQzVDO0FBQ0EsU0FBUyxFQUFFLHFEQUFDLG1CQUFtQiwwQkFBMEI7QUFDekQsb0JBQW9CLHFEQUFDLHFCQUFxQjtBQUMxQztBQUNBLFNBQVM7QUFDVCxnQkFBZ0IscURBQUMscUJBQXFCO0FBQ3RDO0FBQ0EsT0FBTyxtRUFBbUUsRUFBRSxxREFBQyxtQkFBbUIsMEJBQTBCO0FBQzFILDRCQUE0QixxREFBQyxxQkFBcUI7QUFDbEQ7QUFDQSxTQUFTLEVBQUUscURBQUMsbUJBQW1CLDBCQUEwQjtBQUN6RCxrQkFBa0IsK0RBQWtCO0FBQ3BDO0FBQ0E7QUFDQSx5QkFBeUI7QUFDekI7QUFDQSwyQkFBMkIscUNBQXFDLGlCQUFpQjtBQUNqRixZQUFZLHFEQUFDLENBQUMsaURBQUksSUFBSSx3QkFBd0IsRUFBRSxxREFBQyxzQkFBc0IsOENBQThDLDREQUFhO0FBQ2xJO0FBQ0EsT0FBTyx5QkFBeUIsRUFBRSxxREFBQyxvQkFBb0I7QUFDdkQsa0JBQWtCLHVCQUF1QjtBQUN6QyxPQUFPLDZEQUE2RCxFQUFFLHFEQUFDLFVBQVUsd0JBQXdCLHdHQUF3RyxxREFBQyxVQUFVLHFCQUFxQixvRUFBb0UscURBQUMsVUFBVSxxQkFBcUIsb09BQW9PLHNEQUFVO0FBQ25rQjtBQUNBLHNCQUFzQixPQUFPLHFEQUFVO0FBQ3ZDOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUEsb0RBQW9ELGFBQWEsdUJBQXVCLGlEQUFpRCxtQkFBbUIsYUFBYSw0Q0FBNEMsYUFBYSx3QkFBd0IsWUFBWSxnQkFBZ0Isa0NBQWtDLFNBQVMsWUFBWSxzQkFBc0IsaUJBQWlCLGdDQUFnQzs7QUFFcFo7QUFDQTtBQUNBLElBQUkscURBQWdCO0FBQ3BCLDhCQUE4QixxREFBVztBQUN6QyxrQ0FBa0MscURBQVc7QUFDN0MsZ0NBQWdDLHFEQUFXO0FBQzNDLDJCQUEyQixxREFBVztBQUN0Qyw2QkFBNkIscURBQVc7QUFDeEM7QUFDQTtBQUNBO0FBQ0EsOERBQThELHFEQUFDLDhCQUE4QjtBQUM3RixXQUFXLGlDQUFpQyxFQUFFLHlDQUF5QztBQUN2RjtBQUNBO0FBQ0E7QUFDQTtBQUNBLFNBQVMsRUFBRSxxREFBQyxxQkFBcUI7QUFDakM7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0Esd0JBQXdCLHlCQUF5QjtBQUNqRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUyxFQUFFLHFEQUFDLG1CQUFtQix1QkFBdUI7QUFDdEQ7QUFDQTtBQUNBO0FBQ0E7QUFDQSxjQUFjLHFEQUFDLG9CQUFvQixZQUFZLGNBQWMscURBQUMsVUFBVSw4QkFBOEIsRUFBRSxxREFBQyxvQkFBb0I7QUFDN0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUyxpREFBaUQsaUdBQWlHLHFEQUFDLHFCQUFxQjtBQUNqTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGFBQWE7QUFDYjtBQUNBO0FBQ0E7QUFDQTtBQUNBLFNBQVMsc0NBQXNDO0FBQy9DO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLG1CQUFtQixzREFBVTtBQUM3QixtQkFBbUIsc0RBQVU7QUFDN0IseUJBQXlCLHNEQUFVO0FBQ25DO0FBQ0Esa0NBQWtDLDJEQUFXO0FBQzdDLGdDQUFnQyxRQUFRLDJGQUEyRjtBQUNuSSxnQ0FBZ0MsUUFBUSxtRkFBbUY7QUFDM0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0Esd0NBQXdDLHFEQUFxRDtBQUM3RjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSwyQkFBMkIsb0RBQUk7QUFDL0I7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxxR0FBcUcsMkRBQVc7QUFDaEg7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFdBQVc7QUFDWCxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFdBQVc7QUFDWCxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0Esb0JBQW9CLHlCQUF5QjtBQUM3QztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxnQkFBZ0IsdUJBQXVCLEdBQUcseUNBQXlDO0FBQ25GO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxZQUFZLHFEQUFDLENBQUMsaURBQUksUUFBUSxxREFBQyxvQkFBb0IsS0FBSyw0REFBYTtBQUNqRTtBQUNBO0FBQ0EsV0FBVyw4Q0FBOEMsRUFBRSxzREFBc0Q7QUFDakgsMEZBQTBGLEVBQUUscURBQUMsVUFBVSxvREFBb0QsRUFBRSxxREFBQyxtQ0FBbUMsMExBQTBMLHVDQUF1QyxJQUFJLHFEQUFDLFVBQVUsY0FBYyxFQUFFLHFEQUFDLG1CQUFtQiw0QkFBNEIsSUFBSSxxREFBQyxVQUFVLG1DQUFtQztBQUNuaUI7QUFDQSxLQUFLO0FBQ0wsNENBQTRDLGFBQWE7QUFDekQ7QUFDQTtBQUNBLEtBQUs7QUFDTCxrREFBa0QsbUJBQW1CO0FBQ3JFLE9BQU8scURBQUMsb0JBQW9CLHlDQUF5Qyw4QkFBOEIscURBQUMseUJBQXlCLDBDQUEwQyxrQkFBa0IscURBQUMscUJBQXFCO0FBQy9NO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0Esc0JBQXNCLE9BQU8scURBQVU7QUFDdkM7QUFDQTs7QUFFQSx1REFBdUQsYUFBYSw0Q0FBNEMsYUFBYSx3QkFBd0IsWUFBWSxnQkFBZ0Isa0NBQWtDLFNBQVMsWUFBWSxzQkFBc0IsVUFBVSxjQUFjOztBQUV0UjtBQUNBO0FBQ0EsSUFBSSxxREFBZ0I7QUFDcEIsOEJBQThCLHFEQUFXO0FBQ3pDLGdDQUFnQyxxREFBVztBQUMzQyw2QkFBNkIscURBQVc7QUFDeEM7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxjQUFjLHFEQUFDLG9CQUFvQixZQUFZLGNBQWMscURBQUMsVUFBVSw0QkFBNEIsRUFBRSxxREFBQyxvQkFBb0I7QUFDM0g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUyxpREFBaUQsNkZBQTZGLHFEQUFDLHFCQUFxQjtBQUM3SztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUyxzQ0FBc0M7QUFDL0M7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLG1CQUFtQixzREFBVTtBQUM3QixpQkFBaUIsc0RBQVU7QUFDM0IsZ0JBQWdCLHNEQUFVO0FBQzFCLHlCQUF5QixzREFBVTtBQUNuQztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EseUNBQXlDLHVEQUF1RDtBQUNoRztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLG9FQUFvRSwyREFBVztBQUMvRTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSwwQkFBMEIscURBQUMsbURBQW1ELHFEQUFDLHVCQUF1QixzRkFBc0YsRUFBRSxxREFBQyxxQkFBcUIsc0pBQXNKO0FBQzFXO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUssTUFBTSxxREFBQztBQUNaO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGtCQUFrQixxREFBQyw0QkFBNEI7QUFDL0M7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGlCQUFpQjtBQUNqQjtBQUNBO0FBQ0EsZUFBZTtBQUNmO0FBQ0E7QUFDQSxLQUFLO0FBQ0wsb0JBQW9CLHFEQUFDLDZDQUE2QyxxREFBQyxxQkFBcUI7QUFDeEY7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNULFNBQVM7QUFDVCx1QkFBdUIscURBQUMsZ0RBQWdELHFEQUFDLHVCQUF1QixtRUFBbUUsRUFBRSxxREFBQyxxQkFBcUIsc0pBQXNKO0FBQ2pWO0FBQ0EsaUNBQWlDLHFEQUFDLDRCQUE0QjtBQUM5RDtBQUNBO0FBQ0EsU0FBUywyQkFBMkIscURBQUMsNEJBQTRCO0FBQ2pFO0FBQ0E7QUFDQSxTQUFTO0FBQ1QsMEJBQTBCLHFEQUFDLG1EQUFtRCxxREFBQyx1QkFBdUIsbUVBQW1FLEVBQUUscURBQUMscUJBQXFCLHNKQUFzSjtBQUN2VjtBQUNBLHVGQUF1RixxREFBQztBQUN4RixjQUFjLHFEQUFDLDRCQUE0QjtBQUMzQztBQUNBO0FBQ0EsV0FBVztBQUNYLEtBQUs7QUFDTCxZQUFZLHFEQUFDLENBQUMsaURBQUksUUFBUSxxREFBQyxvQkFBb0IsS0FBSyw0REFBYTtBQUNqRSxXQUFXLGtEQUFrRCxFQUFFLDBEQUEwRDtBQUN6SDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFNBQVMsNEhBQTRILEVBQUUscURBQUMsVUFBVSxvREFBb0QsRUFBRSxxREFBQyxtQ0FBbUMsMExBQTBMLDREQUE0RCxJQUFJLHFEQUFDLFVBQVUsY0FBYyxFQUFFLHFEQUFDLG1CQUFtQixvRkFBb0YsSUFBSSxxREFBQyxVQUFVLG1DQUFtQztBQUMzcEI7QUFDQSxLQUFLO0FBQ0w7QUFDQSxLQUFLO0FBQ0w7QUFDQSxzQkFBc0IsT0FBTyxxREFBVTtBQUN2QztBQUNBOztBQUVBO0FBQ0E7QUFDQSxJQUFJLHFEQUFnQjtBQUNwQiw4QkFBOEIscURBQVc7QUFDekMsZ0NBQWdDLHFEQUFXO0FBQzNDLG1DQUFtQyxxREFBVztBQUM5Qyw2QkFBNkIscURBQVc7QUFDeEM7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLG1CQUFtQixzREFBVTtBQUM3QiwyQkFBMkIsc0RBQVU7QUFDckMseUJBQXlCLHNEQUFVO0FBQ25DO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLE9BQU87QUFDUDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFFBQVE7QUFDUjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHdCQUF3QiwrREFBMkI7QUFDbkQ7QUFDQTtBQUNBO0FBQ0E7QUFDQSxnQkFBZ0Isd0JBQXdCO0FBQ3hDLGdCQUFnQiwrREFBbUI7QUFDbkMsU0FBUztBQUNUO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsY0FBYyxvQ0FBb0MsRUFBRSw0Q0FBNEM7QUFDaEc7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsaUZBQWlGLGlDQUFpQyx3R0FBd0c7QUFDMU47QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFlBQVkscURBQUMsQ0FBQyxpREFBSSxRQUFRLHFEQUFDLG9CQUFvQixLQUFLLDREQUFhLHFLQUFxSyxFQUFFLHFEQUFDLFVBQVUsb0RBQW9ELEVBQUUscURBQUMsbUNBQW1DLG1KQUFtSix1Q0FBdUMsSUFBSSxxREFBQyxVQUFVLGNBQWMsRUFBRSxxREFBQyxtQkFBbUIsMEJBQTBCLElBQUkscURBQUMsVUFBVSxxREFBcUQsRUFBRSxxREFBQyxxQkFBcUIsb0ZBQW9GO0FBQ3B3QjtBQUNBLHNCQUFzQixPQUFPLHFEQUFVO0FBQ3ZDOztBQUVBO0FBQ0E7QUFDQTs7QUFFQSxnREFBZ0QsYUFBYSw0Q0FBNEMsYUFBYSx3QkFBd0IsWUFBWSxnQkFBZ0Isa0NBQWtDLFNBQVMsWUFBWSxzQkFBc0I7O0FBRXZQO0FBQ0E7QUFDQSxJQUFJLHFEQUFnQjtBQUNwQiw4QkFBOEIscURBQVc7QUFDekMsZ0NBQWdDLHFEQUFXO0FBQzNDLGdDQUFnQyxxREFBVztBQUMzQyw2QkFBNkIscURBQVc7QUFDeEM7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLG1CQUFtQixzREFBVTtBQUM3Qix5QkFBeUIsc0RBQVU7QUFDbkM7QUFDQTtBQUNBLDRCQUE0QixvREFBSTtBQUNoQztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxZQUFZLHFEQUFDLENBQUMsaURBQUksUUFBUSxxREFBQyxvQkFBb0IsS0FBSyw0REFBYSxvRkFBb0YsNEJBQTRCLEVBQUUsb0NBQW9DLHNCQUFzQixFQUFFLHFEQUFDLFVBQVUsY0FBYyxFQUFFLHFEQUFDLG1CQUFtQiwyQkFBMkIsSUFBSSxxREFBQyxVQUFVLDRCQUE0QixFQUFFLHFEQUFDLG9CQUFvQjtBQUMzWDtBQUNBLE9BQU87QUFDUDtBQUNBO0FBQ0EsT0FBTyxpREFBaUQsaUdBQWlHLHFEQUFDLHFCQUFxQixxR0FBcUc7QUFDcFI7QUFDQSxzQkFBc0IsT0FBTyxxREFBVTtBQUN2QztBQUNBOztBQUVzbkI7Ozs7Ozs7Ozs7Ozs7OztBQ3Q5SHRuQjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0Esb0JBQW9CLFdBQVc7QUFDL0I7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTs7QUFFcUI7Ozs7Ozs7Ozs7Ozs7Ozs7QUNqQnJCO0FBQ0E7QUFDQTtBQUNBO0FBQzZFOztBQUU3RTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsQ0FBQztBQUNEO0FBQ0EsZUFBZSxpREFBZTtBQUM5QjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0Esd0JBQXdCLHFEQUFlO0FBQ3ZDO0FBQ0E7QUFDQTtBQUNBLFNBQVM7QUFDVDtBQUNBO0FBQ0E7QUFDQSwyREFBMkQsaURBQVc7QUFDdEU7QUFDQTtBQUNBLFNBQVM7QUFDVDtBQUNBLHdEQUF3RCxpREFBVztBQUNuRTtBQUNBLFNBQVM7QUFDVDtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBLGtIQUFrSDtBQUNsSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHVHQUF1RztBQUN2RztBQUNBO0FBQ0E7QUFDQTtBQUNBLCtCQUErQjtBQUMvQjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGFBQWE7QUFDYjtBQUNBO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxhQUFhO0FBQ2I7QUFDQTtBQUNBLGFBQWE7QUFDYjtBQUNBO0FBQ0E7QUFDQSxhQUFhO0FBQ2IsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFNBQVM7QUFDVDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUU0Qjs7Ozs7Ozs7Ozs7Ozs7Ozs7QUNyTTVCO0FBQ0E7QUFDQTtBQUNBO0FBQ3VEOztBQUV2RCxtQkFBbUIscURBQVc7QUFDOUI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsQ0FBQztBQUNEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVpRCIsInNvdXJjZXMiOlsid2VicGFjazovL2V4Yi1jbGllbnQvLi9leHRlbnNpb25zL3dpZGdldHMvYXJjZ2lzL2FuYWx5c2lzL25vZGVfbW9kdWxlcy9AYXJjZ2lzL2FwcC1jb21wb25lbnRzL2Rpc3QvZXNtL2FyY2dpcy1wb3B1cF8xMy5lbnRyeS5qcyIsIndlYnBhY2s6Ly9leGItY2xpZW50Ly4vZXh0ZW5zaW9ucy93aWRnZXRzL2FyY2dpcy9hbmFseXNpcy9ub2RlX21vZHVsZXMvQGFyY2dpcy9hcHAtY29tcG9uZW50cy9kaXN0L2VzbS9ndWlkLTRmNDE3NmJhLmpzIiwid2VicGFjazovL2V4Yi1jbGllbnQvLi9leHRlbnNpb25zL3dpZGdldHMvYXJjZ2lzL2FuYWx5c2lzL25vZGVfbW9kdWxlcy9AYXJjZ2lzL2FwcC1jb21wb25lbnRzL2Rpc3QvZXNtL2luZGV4LTgxZDU0OGI3LmpzIiwid2VicGFjazovL2V4Yi1jbGllbnQvLi9leHRlbnNpb25zL3dpZGdldHMvYXJjZ2lzL2FuYWx5c2lzL25vZGVfbW9kdWxlcy9AYXJjZ2lzL2FwcC1jb21wb25lbnRzL2Rpc3QvZXNtL3BvcHVwU3RvcmUtYTVkOTNiNTguanMiXSwic291cmNlc0NvbnRlbnQiOlsiLyohXG4gKiBBbGwgbWF0ZXJpYWwgY29weXJpZ2h0IEVTUkksIEFsbCBSaWdodHMgUmVzZXJ2ZWQsIHVubGVzcyBvdGhlcndpc2Ugc3BlY2lmaWVkLlxuICogdjMuMC45OVxuICovXG5pbXBvcnQgeyByIGFzIHJlZ2lzdGVySW5zdGFuY2UsIGMgYXMgY3JlYXRlRXZlbnQsIGgsIEggYXMgSG9zdCwgZCBhcyBnZXRFbGVtZW50LCBmIGFzIGZvcmNlVXBkYXRlIH0gZnJvbSAnLi9pbmRleC05MmViYjM5Ni5qcyc7XG5pbXBvcnQgeyBnIGFzIGdldExvY2FsZUNvbXBvbmVudFN0cmluZ3MgfSBmcm9tICcuL2xvY2FsZS0xM2UwMGE3NS5qcyc7XG5pbXBvcnQgeyBzIGFzIHNlcnZpY2VUeXBlRW51bSwgbCBhcyBsYXllckRpc3BsYXlUeXBlRW51bSwgZiBhcyBmaWVsZEluZm9QcmVmaXhFbnVtLCBhIGFzIGZpZWxkVHlwZXNFbnVtLCBMIGFzIExhc3RTb3J0eUJ5LCBpIGFzIGltYWdlQ29tcG9uZW50SW5wdXRUeXBlc0VudW0gfSBmcm9tICcuL2NvbW1vbkVudW1zLWY5OGEzMjNjLmpzJztcbmltcG9ydCB7IGsgYXMgZ2V0Q2x1c3RlckZpZWxkcywgbCBhcyBnZXRTaW5nbGVDbHVzdGVyRmVhdHVyZSwgbSBhcyBnZXRTaW5nbGVGZWF0dXJlLCBjIGFzIGdldFNlcnZpY2VUeXBlLCBvIGFzIGdldFBvaW50RnJvbUdlb21ldHJ5LCBwIGFzIGdldFNlcnZpY2VWZXJzaW9uLCBiIGFzIGdldEZpZWxkRGlzcGxheU5hbWUsIGUgYXMgZ2VuZXJhdGVBcmNhZGVFeHByZXNzaW9uTWFwLCBqIGFzIGdldEZpZWxkc0Zyb21MYXllciwgZCBhcyBnZW5lcmF0ZUxheWVyRmllbGRzTWFwLCBhIGFzIGdldEZpZWxkVHlwZSwgcSBhcyBxdWVyeVBhcmVudEVsZW1lbnQgfSBmcm9tICcuL2NvbW1vbkZ1bmN0aW9ucy01MjYyYjA5NC5qcyc7XG5pbXBvcnQgeyBsIGFzIGxvYWRNb2R1bGVzIH0gZnJvbSAnLi9sb2FkTW9kdWxlcy1hYWYzMGJkNi5qcyc7XG5pbXBvcnQgeyBnIGFzIGd1aWQgfSBmcm9tICcuL2d1aWQtNGY0MTc2YmEuanMnO1xuaW1wb3J0IHsgZyBhcyBnZW5lcmF0ZU1hc3RlckZpZWxkSW5mbywgcCBhcyBwcmV2aWV3UG9wdXAgfSBmcm9tICcuL3ByZXZpZXdQb3B1cC0wNWY1ZDE5Ni5qcyc7XG5pbXBvcnQgeyBnIGFzIGdldEVsZW1lbnREaXIgfSBmcm9tICcuL2xhbmd1YWdlVXRpbC0yMjI1OGM5MC5qcyc7XG5pbXBvcnQgeyBkIGFzIGRlYm91bmNlIH0gZnJvbSAnLi9mdW5jdGlvbmFsLWM4MmY1YWI5LmpzJztcbmltcG9ydCB7IGMgYXMgY2xlYXJQb3B1cFN0YXRlLCBwIGFzIHBvcHVwU3RhdGUgfSBmcm9tICcuL3BvcHVwU3RvcmUtYTVkOTNiNTguanMnO1xuaW1wb3J0ICcuL2RvbS0xM2Y1YjAwYy5qcyc7XG5pbXBvcnQgJy4vaW5kZXgtODFkNTQ4YjcuanMnO1xuXG5jb25zdCBDU1MkNiA9IHtcbiAgZW5hYmxlUG9wdXA6IFwiZW5hYmxlLXBvcHVwXCIsXG4gIGNvbXBvbmVudERpdjogXCJjb21wb25lbnQtdWxcIixcbiAgc3VtbWFyeUVUOiBcInN1bW1hcnktZXRcIixcbiAgc3VtbWFyeUVUTGFiZWw6IFwic3VtbWFyeS1ldC1sYWJlbFwiLFxuICBzdW1tYXJ5RVRBY3Rpb246IFwic3VtbWFyeS1ldC1hY3Rpb25cIixcbiAgaW1hZ2VyeU9wdGlvbnM6IFwiaW1hZ2VyeS1vcHRpb25zXCIsXG4gIG5vdGljZTogXCJub3RpY2VcIlxufTtcblxuLy8gYWRkIGZpZWxkIGF0IGN1cnNvciBpZiBwb3NpdGlvbiBpcyBhdmFpbGFibGVcbmNvbnN0IGFkZFNlbGVjdGVkRmllbGRBdEN1cnNvciA9IChpbnB1dEVsZW1lbnQsIHNlbGVjdGVkRmllbGROYW1lKSA9PiB7XG4gIHZhciBfYSwgX2I7XG4gIGNvbnN0IHBvc2l0aW9uID0gKF9iID0gKF9hID0gaW5wdXRFbGVtZW50ID09PSBudWxsIHx8IGlucHV0RWxlbWVudCA9PT0gdm9pZCAwID8gdm9pZCAwIDogaW5wdXRFbGVtZW50LnNoYWRvd1Jvb3QpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5xdWVyeVNlbGVjdG9yKFwiaW5wdXRcIikpID09PSBudWxsIHx8IF9iID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYi5zZWxlY3Rpb25TdGFydDtcbiAgaWYgKGlzRGVmaW5lZChwb3NpdGlvbikpIHtcbiAgICByZXR1cm4gW2lucHV0RWxlbWVudC52YWx1ZS5zbGljZSgwLCBwb3NpdGlvbiksIGB7JHtzZWxlY3RlZEZpZWxkTmFtZX19YCwgaW5wdXRFbGVtZW50LnZhbHVlLnNsaWNlKHBvc2l0aW9uKV0uam9pbihcIlwiKTtcbiAgfVxuICBlbHNlIHtcbiAgICByZXR1cm4gYCR7aW5wdXRFbGVtZW50LnZhbHVlfXske3NlbGVjdGVkRmllbGROYW1lfX1gO1xuICB9XG59O1xuY29uc3QgaXNEZWZpbmVkID0gKHZhbHVlKSA9PiB7XG4gIHJldHVybiB2YWx1ZSAhPT0gdW5kZWZpbmVkICYmIHZhbHVlICE9PSBudWxsO1xufTtcbmNvbnN0IGxheWVySGFzUmVsYXRlZFJlY29yZHMgPSBhc3luYyAobGF5ZXIsIHZpZXcsIHNlcnZpY2VUeXBlKSA9PiB7XG4gIHZhciBfYSwgX2IsIF9jLCBfZCwgX2U7XG4gIGNvbnN0IHN1cHBvcnRzQ291bnQgPSAoX2IgPSAoX2EgPSBsYXllci5jYXBhYmlsaXRpZXMpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5xdWVyeVJlbGF0ZWQpID09PSBudWxsIHx8IF9iID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYi5zdXBwb3J0c0NvdW50O1xuICBjb25zdCBzdXBwb3J0c1BhZ2luYXRpb24gPSAoX2QgPSAoX2MgPSBsYXllci5jYXBhYmlsaXRpZXMpID09PSBudWxsIHx8IF9jID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYy5xdWVyeVJlbGF0ZWQpID09PSBudWxsIHx8IF9kID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfZC5zdXBwb3J0c1BhZ2luYXRpb247XG4gIGlmIChbc2VydmljZVR5cGVFbnVtLmZlYXR1cmUsIHNlcnZpY2VUeXBlRW51bS5zY2VuZV0uaW5kZXhPZihzZXJ2aWNlVHlwZSkgPiAtMSAmJlxuICAgICgoX2UgPSBsYXllciA9PT0gbnVsbCB8fCBsYXllciA9PT0gdm9pZCAwID8gdm9pZCAwIDogbGF5ZXIucmVsYXRpb25zaGlwcykgPT09IG51bGwgfHwgX2UgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9lLmxlbmd0aCkgJiZcbiAgICBzdXBwb3J0c0NvdW50ICYmXG4gICAgc3VwcG9ydHNQYWdpbmF0aW9uKSB7XG4gICAgZm9yIChjb25zdCByZWxhdGlvbnNoaXAgb2YgbGF5ZXIucmVsYXRpb25zaGlwcykge1xuICAgICAgLy8gY2hlY2sgdGFibGUgYW5kIGxheWVycywgaW5jbHVkaW5nIGdyb3VwIGxheWVycyBpbiBtYXAgdmlld1xuICAgICAgLy8gcmV0dXJuIHRydWUgaWYgYW55IHJlbGF0ZWQgbGF5ZXIvdGFibGUgaXMgZm91bmQgaW4gdGhlIG1hcFxuICAgICAgZm9yIChjb25zdCBjdXJyTGF5ZXJPclRhYmxlIG9mIFsuLi52aWV3Lm1hcC5hbGxMYXllcnMsIC4uLnZpZXcubWFwLmFsbFRhYmxlc10pIHtcbiAgICAgICAgY29uc3QgY3VyciA9IGN1cnJMYXllck9yVGFibGU7XG4gICAgICAgIGlmIChhd2FpdCByZWxhdGlvbnNoaXBFeGlzdHMobGF5ZXIsIGN1cnIsIHJlbGF0aW9uc2hpcCkpIHtcbiAgICAgICAgICBhd2FpdCBjdXJyLmxvYWQoKTtcbiAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHRydWUpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9XG4gIHJldHVybiBQcm9taXNlLnJlc29sdmUoZmFsc2UpO1xufTtcbmNvbnN0IGdldERlZmF1bHRSZWxhdGlvbnNoaXBBbmRMYXllciA9IGFzeW5jIChsYXllciwgdmlldywgc2VydmljZVR5cGUpID0+IHtcbiAgdmFyIF9hO1xuICBpZiAoW3NlcnZpY2VUeXBlRW51bS5mZWF0dXJlLCBzZXJ2aWNlVHlwZUVudW0uc2NlbmVdLmluZGV4T2Yoc2VydmljZVR5cGUpID4gLTEgJiYgKChfYSA9IGxheWVyID09PSBudWxsIHx8IGxheWVyID09PSB2b2lkIDAgPyB2b2lkIDAgOiBsYXllci5yZWxhdGlvbnNoaXBzKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EubGVuZ3RoKSkge1xuICAgIGZvciAoY29uc3QgcmVsYXRpb25zaGlwIG9mIGxheWVyLnJlbGF0aW9uc2hpcHMpIHtcbiAgICAgIC8vIGNoZWNrIHRhYmxlIGFuZCBsYXllcnMsIGluY2x1ZGluZyBncm91cCBsYXllcnMgaW4gbWFwIHZpZXdcbiAgICAgIGZvciAoY29uc3QgY3VyckxheWVyT3JUYWJsZSBvZiBbLi4udmlldy5tYXAuYWxsTGF5ZXJzLCAuLi52aWV3Lm1hcC5hbGxUYWJsZXNdKSB7XG4gICAgICAgIGNvbnN0IGN1cnIgPSBjdXJyTGF5ZXJPclRhYmxlO1xuICAgICAgICAvLyBieSBkZWZhdWx0IHNldHVwIHJlbGF0aW9uc2hpcHMgYmFzZWQgb24gdGhlIDFzdCBsYXllci90YWJsZSBmb3VuZFxuICAgICAgICBpZiAoYXdhaXQgcmVsYXRpb25zaGlwRXhpc3RzKGxheWVyLCBjdXJyLCByZWxhdGlvbnNoaXApKSB7XG4gICAgICAgICAgYXdhaXQgY3Vyci5sb2FkKCk7XG4gICAgICAgICAgcmV0dXJuIHsgcmVsYXRpb25zaGlwOiByZWxhdGlvbnNoaXAsIGN1cnJMYXllcjogY3VyciB9O1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9XG59O1xuZnVuY3Rpb24gdHJpbVNlcnZlckZyb21VcmwobGF5ZXIpIHtcbiAgaWYgKGxheWVyLnR5cGUgPT09IFwiZmVhdHVyZVwiICYmIGxheWVyLnVybC50b0xvY2FsZUxvd2VyQ2FzZSgpLmVuZHNXaXRoKFwiL2ZlYXR1cmVzZXJ2ZXJcIikpIHtcbiAgICByZXR1cm4gbGF5ZXIudXJsLnN1YnN0cmluZygwLCBsYXllci51cmwubGVuZ3RoIC0gMTQpO1xuICB9XG4gIGVsc2UgaWYgKGxheWVyLnR5cGUgPT09IFwic2NlbmVcIiAmJiBsYXllci51cmwudG9Mb2NhbGVMb3dlckNhc2UoKS5lbmRzV2l0aChcIi9zY2VuZXNlcnZlclwiKSkge1xuICAgIHJldHVybiBsYXllci51cmwuc3Vic3RyaW5nKDAsIGxheWVyLnVybC5sZW5ndGggLSAxMik7XG4gIH1cbiAgcmV0dXJuIGxheWVyLnVybDtcbn1cbmFzeW5jIGZ1bmN0aW9uIHJlbGF0aW9uc2hpcEV4aXN0cyhsYXllciwgcmVsYXRlZExheWVyLCByZWxhdGlvbnNoaXApIHtcbiAgdmFyIF9hLCBfYiwgX2M7XG4gIGNvbnN0IHNhbWVQYXJlbnQgPSByZWxhdGVkTGF5ZXIudXJsXG4gICAgPyByZWxhdGVkTGF5ZXIudXJsID09PSBsYXllci51cmwgfHwgdHJpbVNlcnZlckZyb21VcmwocmVsYXRlZExheWVyKSA9PT0gdHJpbVNlcnZlckZyb21VcmwobGF5ZXIpXG4gICAgOiBcInR5cGVcIiBpbiByZWxhdGVkTGF5ZXIucGFyZW50ICYmXG4gICAgICByZWxhdGVkTGF5ZXIucGFyZW50LnR5cGUgPT09IFwiZ3JvdXBcIiAmJlxuICAgICAgKChfYiA9IChfYSA9IHJlbGF0ZWRMYXllci5wYXJlbnQpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5wb3J0YWxJdGVtKSA9PT0gbnVsbCB8fCBfYiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2IuaWQpID09PSAoKF9jID0gbGF5ZXIucG9ydGFsSXRlbSkgPT09IG51bGwgfHwgX2MgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9jLmlkKTtcbiAgaWYgKFtcImZlYXR1cmVcIiwgXCJzY2VuZVwiXS5pbmRleE9mKHJlbGF0ZWRMYXllci50eXBlKSA+IC0xICYmIHNhbWVQYXJlbnQgJiYgIWlzRGVmaW5lZChyZWxhdGVkTGF5ZXIubGF5ZXJJZCkpIHtcbiAgICAvLyBoYXBwZW5zIGluIFNWXG4gICAgYXdhaXQgcmVsYXRlZExheWVyLmxvYWQoKTtcbiAgfVxuICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKFtcImZlYXR1cmVcIiwgXCJzY2VuZVwiXS5pbmRleE9mKHJlbGF0ZWRMYXllci50eXBlKSA+IC0xICYmXG4gICAgc2FtZVBhcmVudCAmJlxuICAgIHJlbGF0ZWRMYXllci5sYXllcklkID09PSByZWxhdGlvbnNoaXAucmVsYXRlZFRhYmxlSWQpO1xufVxuZnVuY3Rpb24gcmVsYXRpb25zaGlwRXhpc3RzQ2hlY2tXaXRob3V0TG9hZChsYXllciwgcmVsYXRlZExheWVyLCByZWxhdGlvbnNoaXApIHtcbiAgdmFyIF9hLCBfYiwgX2M7XG4gIGNvbnN0IHNhbWVQYXJlbnQgPSByZWxhdGVkTGF5ZXIudXJsXG4gICAgPyByZWxhdGVkTGF5ZXIudXJsID09PSBsYXllci51cmwgfHwgdHJpbVNlcnZlckZyb21VcmwocmVsYXRlZExheWVyKSA9PT0gdHJpbVNlcnZlckZyb21VcmwobGF5ZXIpXG4gICAgOiBcInR5cGVcIiBpbiByZWxhdGVkTGF5ZXIucGFyZW50ICYmXG4gICAgICByZWxhdGVkTGF5ZXIucGFyZW50LnR5cGUgPT09IFwiZ3JvdXBcIiAmJlxuICAgICAgKChfYiA9IChfYSA9IHJlbGF0ZWRMYXllci5wYXJlbnQpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5wb3J0YWxJdGVtKSA9PT0gbnVsbCB8fCBfYiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2IuaWQpID09PSAoKF9jID0gbGF5ZXIucG9ydGFsSXRlbSkgPT09IG51bGwgfHwgX2MgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9jLmlkKTtcbiAgcmV0dXJuIChbXCJmZWF0dXJlXCIsIFwic2NlbmVcIl0uaW5kZXhPZihyZWxhdGVkTGF5ZXIudHlwZSkgPiAtMSAmJlxuICAgIHNhbWVQYXJlbnQgJiZcbiAgICByZWxhdGVkTGF5ZXIubGF5ZXJJZCA9PT0gcmVsYXRpb25zaGlwLnJlbGF0ZWRUYWJsZUlkKTtcbn1cblxudmFyIENvbnRlbnRTZWxlY3Rpb247XG4oZnVuY3Rpb24gKENvbnRlbnRTZWxlY3Rpb24pIHtcbiAgQ29udGVudFNlbGVjdGlvbltcImF0dHJpYnV0ZXNcIl0gPSBcImF0dHJpYnV0ZXNcIjtcbiAgQ29udGVudFNlbGVjdGlvbltcImF0dGFjaG1lbnRzXCJdID0gXCJhdHRhY2htZW50c1wiO1xuICBDb250ZW50U2VsZWN0aW9uW1wiY2hhcnRzXCJdID0gXCJjaGFydHNcIjtcbiAgQ29udGVudFNlbGVjdGlvbltcImltYWdlc1wiXSA9IFwiaW1hZ2VzXCI7XG4gIENvbnRlbnRTZWxlY3Rpb25bXCJyaWNoVGV4dFwiXSA9IFwicmljaFRleHRcIjtcbiAgQ29udGVudFNlbGVjdGlvbltcInN1bW1hcnlFVFwiXSA9IFwic3VtbWFyeUVUXCI7XG4gIENvbnRlbnRTZWxlY3Rpb25bXCJhcmNhZGVcIl0gPSBcImFyY2FkZVwiO1xuICBDb250ZW50U2VsZWN0aW9uW1wicmVsYXRpb25zaGlwXCJdID0gXCJyZWxhdGlvbnNoaXBcIjtcbn0pKENvbnRlbnRTZWxlY3Rpb24gfHwgKENvbnRlbnRTZWxlY3Rpb24gPSB7fSkpO1xudmFyIFBvcHVwTXVsdGlNZWRpYVR5cGU7XG4oZnVuY3Rpb24gKFBvcHVwTXVsdGlNZWRpYVR5cGUpIHtcbiAgUG9wdXBNdWx0aU1lZGlhVHlwZVtcImltYWdlXCJdID0gXCJpbWFnZVwiO1xuICBQb3B1cE11bHRpTWVkaWFUeXBlW1wiYmFyQ2hhcnRcIl0gPSBcImJhci1jaGFydFwiO1xuICBQb3B1cE11bHRpTWVkaWFUeXBlW1wiY29sdW1uQ2hhcnRcIl0gPSBcImNvbHVtbi1jaGFydFwiO1xuICBQb3B1cE11bHRpTWVkaWFUeXBlW1wibGluZUNoYXJ0XCJdID0gXCJsaW5lLWNoYXJ0XCI7XG4gIFBvcHVwTXVsdGlNZWRpYVR5cGVbXCJwaWVDaGFydFwiXSA9IFwicGllLWNoYXJ0XCI7XG59KShQb3B1cE11bHRpTWVkaWFUeXBlIHx8IChQb3B1cE11bHRpTWVkaWFUeXBlID0ge30pKTtcbnZhciBBdHRhY2htZW50RGlzcGxheVR5cGU7XG4oZnVuY3Rpb24gKEF0dGFjaG1lbnREaXNwbGF5VHlwZSkge1xuICBBdHRhY2htZW50RGlzcGxheVR5cGVbXCJwcmV2aWV3XCJdID0gXCJwcmV2aWV3XCI7XG4gIEF0dGFjaG1lbnREaXNwbGF5VHlwZVtcImxpc3RcIl0gPSBcImxpc3RcIjtcbiAgQXR0YWNobWVudERpc3BsYXlUeXBlW1wiYXV0b1wiXSA9IFwiYXV0b1wiO1xufSkoQXR0YWNobWVudERpc3BsYXlUeXBlIHx8IChBdHRhY2htZW50RGlzcGxheVR5cGUgPSB7fSkpO1xuXG5jb25zdCBnZXRBcmNhZGVTY3JpcHQgPSAoZXhwcmVzc2lvbiwgbGF5ZXJEaXNwbGF5VHlwZSwgc3RyaW5ncykgPT4ge1xuICBpZiAoZXhwcmVzc2lvbikge1xuICAgIHJldHVybiBleHByZXNzaW9uO1xuICB9XG4gIGlmIChsYXllckRpc3BsYXlUeXBlID09PSBsYXllckRpc3BsYXlUeXBlRW51bS5jbHVzdGVyKSB7XG4gICAgcmV0dXJuIGRlZmF1bHRDbHVzdGVyUG9wdXBTY3JpcHQoc3RyaW5ncyk7XG4gIH1cbiAgcmV0dXJuIGRlZmF1bHRQb3B1cFNjcmlwdChzdHJpbmdzKTtcbn07XG5jb25zdCBnZXRBcmNhZGVQcm9maWxlID0gYXN5bmMgKGxheWVyLCBtYXBWaWV3LCBzZXJ2aWNlVHlwZSwgcG9wdXBUZW1wbGF0ZSwgbGF5ZXJEaXNwbGF5VHlwZSkgPT4ge1xuICBpZiAobGF5ZXJEaXNwbGF5VHlwZSA9PT0gbGF5ZXJEaXNwbGF5VHlwZUVudW0uY2x1c3Rlcikge1xuICAgIHJldHVybiB7XG4gICAgICBpZDogXCJwb3B1cC1mZWF0dXJlLXJlZHVjdGlvblwiLFxuICAgICAgZGVmaW5pdGlvbnM6IHtcbiAgICAgICAgJGZlYXR1cmU6IHsgZmllbGRzOiBnZXRDbHVzdGVyRmllbGRzKHBvcHVwVGVtcGxhdGUsIGZhbHNlKSB9LFxuICAgICAgICAkYWdncmVnYXRlZEZlYXR1cmVzOiBhd2FpdCBnZXRBZ2dyZWdhdGVkRmVhdHVyZVNldChtYXBWaWV3LCBsYXllciwgcG9wdXBUZW1wbGF0ZSlcbiAgICAgIH1cbiAgICB9O1xuICB9XG4gIHJldHVybiBPYmplY3QuYXNzaWduKE9iamVjdC5hc3NpZ24oeyBpZDogXCJwb3B1cFwiIH0sICgoc2VydmljZVR5cGUgPT09IHNlcnZpY2VUeXBlRW51bS5jc3YgfHxcbiAgICBzZXJ2aWNlVHlwZSA9PT0gc2VydmljZVR5cGVFbnVtLmdlb2pzb24gfHxcbiAgICBzZXJ2aWNlVHlwZSA9PT0gc2VydmljZVR5cGVFbnVtLm1hcEltYWdlIHx8XG4gICAgc2VydmljZVR5cGUgPT09IHNlcnZpY2VUeXBlRW51bS50aWxlKSAmJiB7XG4gICAgZGlzYWJsZWRWYXJpYWJsZXM6IFtcIiRsYXllclwiLCBcIiRtYXBcIiwgXCIkZGF0YXN0b3JlXCJdXG4gIH0pKSwgeyBkZWZpbml0aW9uczoge1xuICAgICAgJGZlYXR1cmU6IGxheWVyLFxuICAgICAgJGxheWVyOiBsYXllcixcbiAgICAgICRtYXA6IG1hcFZpZXcubWFwLFxuICAgICAgJGRhdGFzdG9yZTogbGF5ZXJcbiAgICB9IH0pO1xufTtcbmNvbnN0IGdldFRlc3REYXRhID0gYXN5bmMgKGxheWVyLCBtYXBWaWV3LCBsYXllckRpc3BsYXlUeXBlLCBwb3B1cFRlbXBsYXRlKSA9PiB7XG4gIHRyeSB7XG4gICAgaWYgKGxheWVyRGlzcGxheVR5cGUgPT09IGxheWVyRGlzcGxheVR5cGVFbnVtLmNsdXN0ZXIpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHByb2ZpbGVWYXJpYWJsZUluc3RhbmNlczoge1xuICAgICAgICAgICRmZWF0dXJlOiBhd2FpdCBnZXRTaW5nbGVDbHVzdGVyRmVhdHVyZShtYXBWaWV3LCBsYXllciwgcG9wdXBUZW1wbGF0ZSksXG4gICAgICAgICAgJGFnZ3JlZ2F0ZWRGZWF0dXJlczogYXdhaXQgZ2V0QWdncmVnYXRlZEZlYXR1cmVTZXQobWFwVmlldywgbGF5ZXIsIHBvcHVwVGVtcGxhdGUpXG4gICAgICAgIH0sXG4gICAgICAgIHNwYXRpYWxSZWZlcmVuY2U6IG1hcFZpZXcuc3BhdGlhbFJlZmVyZW5jZSxcbiAgICAgICAgdGltZVpvbmU6IG1hcFZpZXcudGltZVpvbmVcbiAgICAgIH07XG4gICAgfVxuICAgIHJldHVybiB7XG4gICAgICBwcm9maWxlVmFyaWFibGVJbnN0YW5jZXM6IHtcbiAgICAgICAgJGZlYXR1cmU6IChhd2FpdCBnZXRTaW5nbGVGZWF0dXJlKGxheWVyLCBtYXBWaWV3KSkuZmVhdHVyZXNbMF0sXG4gICAgICAgICRsYXllcjogbGF5ZXIsXG4gICAgICAgICRtYXA6IG1hcFZpZXcubWFwLFxuICAgICAgICAkZGF0YXN0b3JlOiBsYXllci51cmxcbiAgICAgIH0sXG4gICAgICBzcGF0aWFsUmVmZXJlbmNlOiBtYXBWaWV3LnNwYXRpYWxSZWZlcmVuY2UsXG4gICAgICB0aW1lWm9uZTogbWFwVmlldy50aW1lWm9uZVxuICAgIH07XG4gIH1cbiAgY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5sb2coZXJyb3IpO1xuICB9XG59O1xuY29uc3QgZ2V0VGVtcGxhdGVzID0gKHN0cmluZ3MpID0+IHtcbiAgcmV0dXJuIFtcbiAgICB7XG4gICAgICBsYWJlbDogc3RyaW5ncy50ZW1wbGF0ZXMsXG4gICAgICBzdWdnZXN0aW9uczogW1xuICAgICAgICB7XG4gICAgICAgICAgbGFiZWw6IHN0cmluZ3MuY2hhcnRUZW1wbGF0ZSxcbiAgICAgICAgICBjb2RlOiBjaGFydFRlbXBsYXRlKClcbiAgICAgICAgfSxcbiAgICAgICAge1xuICAgICAgICAgIGxhYmVsOiBzdHJpbmdzLmZpZWxkc0xpc3RUZW1wbGF0ZSxcbiAgICAgICAgICBjb2RlOiBmaWVsZFRlbXBsYXRlKClcbiAgICAgICAgfSxcbiAgICAgICAge1xuICAgICAgICAgIGxhYmVsOiBzdHJpbmdzLnJpY2hUZXh0LFxuICAgICAgICAgIGNvZGU6IHJpY2hUZXh0VGVtcGxhdGUoKVxuICAgICAgICB9XG4gICAgICBdXG4gICAgfVxuICBdO1xufTtcbmNvbnN0IGdldEFnZ3JlZ2F0ZWRGZWF0dXJlU2V0ID0gYXN5bmMgKG1hcFZpZXcsIGxheWVyLCBwb3B1cFRlbXBsYXRlKSA9PiB7XG4gIGNvbnN0IGxheWVyVmlldyA9IGF3YWl0IG1hcFZpZXcud2hlbkxheWVyVmlldyhsYXllcik7XG4gIGNvbnN0IHEgPSBsYXllclZpZXcuY3JlYXRlUXVlcnkoKTtcbiAgcS5hZ2dyZWdhdGVJZHMgPSBbKGF3YWl0IGdldFNpbmdsZUNsdXN0ZXJGZWF0dXJlKG1hcFZpZXcsIGxheWVyLCBwb3B1cFRlbXBsYXRlKSkuZ2V0T2JqZWN0SWQoKV07XG4gIHJldHVybiBsYXllclZpZXcucXVlcnlGZWF0dXJlcyhxKTtcbn07XG5jb25zdCBkZWZhdWx0UG9wdXBTY3JpcHQgPSAoc3RyaW5ncykgPT4ge1xuICByZXR1cm4gYC8vICR7c3RyaW5ncy5hcmNhZGVTY3JpcHRMaW5lMX0gXFxuLy8gJHtzdHJpbmdzLmFyY2FkZVNjcmlwdExpbmUyfVxcbi8vIEF2ZXJhZ2UoJGZlYXR1cmUuU2FsZXNRMSwgJGZlYXR1cmUuU2FsZXNRMiwgJGZlYXR1cmUuU2FsZXNRMywgJGZlYXR1cmUuU2FsZXNRNClcXG5gO1xufTtcbmNvbnN0IGRlZmF1bHRDbHVzdGVyUG9wdXBTY3JpcHQgPSAoc3RyaW5ncykgPT4ge1xuICByZXR1cm4gYC8vICR7c3RyaW5ncy5jbHVzdGVyQXJjYWRlU2NyaXB0TGluZTN9IFxcbkV4cGVjdHMoJGFnZ3JlZ2F0ZWRGZWF0dXJlcywgXCJmaWVsZDFcIiwgXCJmaWVsZDJcIilcXG5cXG4vLyAke3N0cmluZ3MuY2x1c3RlckFyY2FkZVNjcmlwdExpbmUxfSBcXG4vLyAke3N0cmluZ3MuY2x1c3RlckFyY2FkZVNjcmlwdExpbmUyfVxcbi8vIENvdW50KEZpbHRlcigkYWdncmVnYXRlZEZlYXR1cmVzLCBcImZpZWxkMSA9ICd2YWx1ZSdcIikpXFxuYDtcbn07XG5jb25zdCBkZWZhdWx0Q29udGVudE1lc3NhZ2UgPSAobGF5ZXJEaXNwbGF5VHlwZSwgc3RyaW5ncykgPT4ge1xuICBjb25zdCBjbHVzdGVyTWVzc2FnZSA9IGAvLyAke3N0cmluZ3MuYXJjYWRlQ29udGVudENsdXN0ZXJTY3JpcHRMaW5lfSBcXG5FeHBlY3RzKCRhZ2dyZWdhdGVkRmVhdHVyZXMsIFwiZmllbGQxXCIsIFwiZmllbGQyXCIpXFxuXFxuYDtcbiAgY29uc3QgZGVmYXVsdE1lc3NhZ2UgPSBgLyogXFxuJHtzdHJpbmdzLmFyY2FkZUNvbnRlbnRTY3JpcHRMaW5lMX0gXFxuJHtzdHJpbmdzLmFyY2FkZUNvbnRlbnRTY3JpcHRMaW5lMn0gXFxuaHR0cHM6Ly9kZXZlbG9wZXJzLmFyY2dpcy5jb20vYXJjYWRlL2d1aWRlL3Byb2ZpbGVzLyNwb3B1cC1lbGVtZW50IFxcbiovXFxuXFxuJHtyaWNoVGV4dFRlbXBsYXRlKCl9YDtcbiAgcmV0dXJuIGxheWVyRGlzcGxheVR5cGUgPT09IGxheWVyRGlzcGxheVR5cGVFbnVtLmNsdXN0ZXIgPyBjbHVzdGVyTWVzc2FnZSArIGRlZmF1bHRNZXNzYWdlIDogZGVmYXVsdE1lc3NhZ2U7XG59O1xuY29uc3QgcmljaFRleHRUZW1wbGF0ZSA9ICgpID0+IHtcbiAgcmV0dXJuIGByZXR1cm4geyBcXG5cXHR0eXBlIDogJ3RleHQnLCBcXG5cXHR0ZXh0IDogJ3BsYWNlIHlvdXIgdGV4dCBvciBodG1sIGhlcmUnIC8vdGhpcyBwcm9wZXJ0eSBzdXBwb3J0cyBodG1sIHRhZ3MgXFxufWA7XG59O1xuY29uc3QgZmllbGRUZW1wbGF0ZSA9ICgpID0+IHtcbiAgcmV0dXJuIGByZXR1cm4ge1xuICAgIHR5cGU6ICdmaWVsZHMnLFxuICAgIC8vdGl0bGU6ICcnLFxuICAgIC8vZGVzY3JpcHRpb24gOiAnJyxcbiAgICBmaWVsZEluZm9zOiAgW3tcbiAgICAgICAgICBmaWVsZE5hbWU6IFwiYXR0MVwiICAvLyBmaWVsZE5hbWUgc2hvdWxkIG1hdGNoIHRoZSBrZXkgaW4gdGhlIGF0dHJpYnV0ZXMgZGljdGlvbmFyeVxuICAgICAgICB9LFxuICAgICAgICB7XG4gICAgICAgICAgZmllbGROYW1lOiBcImF0dDJcIiAgLy8gZmllbGROYW1lIHNob3VsZCBtYXRjaCB0aGUga2V5IGluIHRoZSBhdHRyaWJ1dGVzIGRpY3Rpb25hcnlcbiAgICAgICAgfSxcbiAgICAgICAge1xuICAgICAgICAgIGZpZWxkTmFtZTogXCJhdHQzXCIgIC8vIGZpZWxkTmFtZSBzaG91bGQgbWF0Y2ggdGhlIGtleSBpbiB0aGUgYXR0cmlidXRlcyBkaWN0aW9uYXJ5XG4gICAgICAgIH1dLFxuICAgIGF0dHJpYnV0ZXMgOiB7YXR0MSA6IDIsIGF0dDIgOiAzLCBhdHQzIDogNH0gIC8vIHJlcGxhY2UgdGhpcyBkaWN0aW9uYXJ5IHdpdGggeW91ciBvd24ga2V5LXZhbHVlIHBhaXJzXG4gIH1gO1xufTtcbmNvbnN0IGNoYXJ0VGVtcGxhdGUgPSAoKSA9PiB7XG4gIHJldHVybiBgcmV0dXJuIHtcbiAgICB0eXBlOiAnbWVkaWEnLFxuICAgIC8vIHRpdGxlIDogJ1RoZSB0aXRsZSBmb3IgYWxsIG1lZGlhIGluIHRoZSBlbGVtZW50JyxcbiAgICAvLyBkZXNjcmlwdGlvbiA6ICcnLFxuICAgIGF0dHJpYnV0ZXMgOiB7YXR0MSA6IDIsIGF0dDIgOiAzLCBhdHQzIDogNH0sICAvLyByZXBsYWNlIHRoaXMgZGljdGlvbmFyeSB3aXRoIHlvdXIgb3duIGtleS12YWx1ZSBwYWlycyxcbiAgICBtZWRpYUluZm9zOiBbe1xuICAgICAgICB0eXBlIDogJ3BpZWNoYXJ0JywgLy9saW5lY2hhcnQgfCBiYXJjaGFydCB8IHBpZWNoYXJ0IHwgY29sdW1uY2hhcnRcbiAgICAgICAgdGl0bGUgOiAnZ2l2ZSB5b3VyIGNoYXJ0IGEgdGl0bGUnLFxuICAgICAgICAvLyBjYXB0aW9uIDogJycsXG4gICAgICAgIGFsdFRleHQgOiAnJywgLy9hbHRUZXh0IHdpbGwgYmUgcmVhZCBieSBzY3JlZW4gcmVhZGVyc1xuICAgICAgICB2YWx1ZSA6IHtcbiAgICAgICAgICBmaWVsZHM6IFtcImF0dDFcIiwgXCJhdHQyXCIsIFwiYXR0M1wiXSwgIC8vIGNob29zZSB3aGF0IGF0dHJpYnV0ZXMgdG8gdXNlIGluIHRoZSBjaGFydFxuICAgICAgICAgIC8qIGNvbG9yczogWyAgLy8gdmFsdWVzIG11c3QgYmUgYW4gYXJyYXkgb2YgW3IsIGcsIGIsIGFdIHZhbHVlcyAoMC0yNTUpXG4gICAgICAgICAgICBbMTIyLCAxOTAsIDIyOSwgMjU1XSxcbiAgICAgICAgICAgIFsxNzksIDE1NSwgMjEzLCAyNTVdLFxuICAgICAgICAgICAgWzI0OCwgMTc0LCAxMzEsIDI1NV1cbiAgICAgICAgICBdLCAqL1xuICAgICAgICAgIC8vbm9ybWFsaXplRmllbGQgOiAnJywgIC8vIHRoZSBuYW1lIG9mIHRoZSBhdHRyaWJ1dGUgdG8gbm9ybWFsaXplIGJ5IG9yIHZhbHVlXG4gICAgICAgIH1cbiAgICAgIH1dXG4gIH1gO1xufTtcbmNvbnN0IGdldENsdXN0ZXJGaWVsZEluZm9zID0gKHBvcHVwVGVtcGxhdGUsIEZpZWxkSW5mbykgPT4ge1xuICB2YXIgX2E7XG4gIGNvbnN0IGNsdXN0ZXJGaWVsZEluZm9zID0gW107XG4gIC8vIHJlbW92ZSBleHByZXNzaW9uc1xuICBwb3B1cFRlbXBsYXRlLmZpZWxkSW5mb3MuZm9yRWFjaCgoZmllbGRJbmZvKSA9PiB7XG4gICAgaWYgKCFmaWVsZEluZm8uZmllbGROYW1lLmluY2x1ZGVzKGZpZWxkSW5mb1ByZWZpeEVudW0uZXhwcmVzc2lvbikpIHtcbiAgICAgIGNsdXN0ZXJGaWVsZEluZm9zLnB1c2goZmllbGRJbmZvKTtcbiAgICB9XG4gIH0pO1xuICAvLyBhZGQgcG90ZW50aWFsIG5ldyBhbmQgZXhpc3RpbmcgZXhwcmVzc2lvbnNcbiAgKF9hID0gcG9wdXBUZW1wbGF0ZS5leHByZXNzaW9uSW5mb3MpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5mb3JFYWNoKGFzeW5jIChleHByZXNzaW9uSW5mbykgPT4ge1xuICAgIGNvbnN0IHRlbXBGaWVsZEluZm8gPSBuZXcgRmllbGRJbmZvKCk7XG4gICAgdGVtcEZpZWxkSW5mby5maWVsZE5hbWUgPSBgJHtmaWVsZEluZm9QcmVmaXhFbnVtLmV4cHJlc3Npb259JHtleHByZXNzaW9uSW5mby5uYW1lfWA7XG4gICAgdGVtcEZpZWxkSW5mby52aXNpYmxlID0gZmFsc2U7XG4gICAgY2x1c3RlckZpZWxkSW5mb3MucHVzaCh0ZW1wRmllbGRJbmZvKTtcbiAgfSk7XG4gIHJldHVybiBjbHVzdGVyRmllbGRJbmZvcztcbn07XG5jb25zdCBnZXRFeHByZXNzaW9OYW1lID0gKHBvcHVwVGVtcGxhdGUsIGFyY2FkZUZpZWxkTmFtZSkgPT4ge1xuICB2YXIgX2E7XG4gIGlmIChhcmNhZGVGaWVsZE5hbWUpIHtcbiAgICByZXR1cm4gYXJjYWRlRmllbGROYW1lO1xuICB9XG4gIGVsc2Uge1xuICAgIGlmICgoX2EgPSBwb3B1cFRlbXBsYXRlLmV4cHJlc3Npb25JbmZvcykgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmxlbmd0aCkge1xuICAgICAgY29uc3QgdGVtcEV4cCA9IHBvcHVwVGVtcGxhdGUuZXhwcmVzc2lvbkluZm9zW3BvcHVwVGVtcGxhdGUuZXhwcmVzc2lvbkluZm9zLmxlbmd0aCAtIDFdO1xuICAgICAgY29uc3QgbWF0Y2hlcyA9IHRlbXBFeHAubmFtZS5tYXRjaCgvXFxkKyQvKTtcbiAgICAgIGlmIChtYXRjaGVzID09PSBudWxsIHx8IG1hdGNoZXMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG1hdGNoZXNbMF0pIHtcbiAgICAgICAgcmV0dXJuIGBleHByJHtOdW1iZXIobWF0Y2hlc1swXSkgKyAxfWA7XG4gICAgICB9XG4gICAgICBlbHNlIHtcbiAgICAgICAgcmV0dXJuIGBleHByJHtwb3B1cFRlbXBsYXRlLmV4cHJlc3Npb25JbmZvcy5sZW5ndGh9YDtcbiAgICAgIH1cbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICByZXR1cm4gXCJleHByMFwiO1xuICAgIH1cbiAgfVxufTtcbmNvbnN0IHNldEV4cHJlc3Npb25JbmZvSW5Qb3B1cFRlbXBsYXRlID0gKG9iamVjdEFyY2FkZUVkaXRvciwgY3VycmVudEFyY2FkZUZpZWxkTmFtZSwgUG9wdXBFeHByZXNzaW9uSW5mbywgcG9wdXBUZW1wbGF0ZSkgPT4ge1xuICBjb25zdCB0ZW1wQ3VycmVudEFyY2FkZUZpZWxkTmFtZSA9IGN1cnJlbnRBcmNhZGVGaWVsZE5hbWU7XG4gIGNvbnN0IHRlbXBFeHAgPSBuZXcgUG9wdXBFeHByZXNzaW9uSW5mbygpO1xuICB0ZW1wRXhwLmV4cHJlc3Npb24gPSBvYmplY3RBcmNhZGVFZGl0b3Iuc2NyaXB0O1xuICB0ZW1wRXhwLnRpdGxlID0gb2JqZWN0QXJjYWRlRWRpdG9yLnRpdGxlO1xuICB0ZW1wRXhwLm5hbWUgPSBnZXRFeHByZXNzaW9OYW1lKHBvcHVwVGVtcGxhdGUsIHRlbXBDdXJyZW50QXJjYWRlRmllbGROYW1lKTtcbiAgdGVtcEV4cC5yZXR1cm5UeXBlID0gb2JqZWN0QXJjYWRlRWRpdG9yLnByZWRpY3RPdXRwdXRUeXBlID09PSBcIm51bWJlclwiID8gXCJudW1iZXJcIiA6IFwic3RyaW5nXCI7XG4gIGlmIChwb3B1cFRlbXBsYXRlLmV4cHJlc3Npb25JbmZvcykge1xuICAgIGlmICh0ZW1wQ3VycmVudEFyY2FkZUZpZWxkTmFtZSkge1xuICAgICAgcG9wdXBUZW1wbGF0ZS5leHByZXNzaW9uSW5mb3MuZmluZCgoZXhwLCBpbmRleCkgPT4ge1xuICAgICAgICBpZiAoZXhwLm5hbWUgPT09IHRlbXBDdXJyZW50QXJjYWRlRmllbGROYW1lKSB7XG4gICAgICAgICAgcG9wdXBUZW1wbGF0ZS5leHByZXNzaW9uSW5mb3NbaW5kZXhdID0gdGVtcEV4cDtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgcG9wdXBUZW1wbGF0ZS5leHByZXNzaW9uSW5mb3MucHVzaCh0ZW1wRXhwKTtcbiAgICB9XG4gIH1cbiAgZWxzZSB7XG4gICAgcG9wdXBUZW1wbGF0ZS5leHByZXNzaW9uSW5mb3MgPSBbdGVtcEV4cF07XG4gIH1cbiAgcmV0dXJuIHRlbXBFeHA7XG59O1xuY29uc3Qgc2V0TGF5ZXJFeHByZXNzaW9uQW5kRmllbGRJbmZvID0gYXN5bmMgKHBvcHVwVGVtcGxhdGUsIGxheWVyRGlzcGxheVR5cGUsIGxheWVyLCBGaWVsZEluZm8pID0+IHtcbiAgaWYgKGxheWVyRGlzcGxheVR5cGUgPT09IGxheWVyRGlzcGxheVR5cGVFbnVtLmNsdXN0ZXIpIHtcbiAgICBsYXllci5mZWF0dXJlUmVkdWN0aW9uLnBvcHVwVGVtcGxhdGUuZXhwcmVzc2lvbkluZm9zID1cbiAgICAgIFsuLi5wb3B1cFRlbXBsYXRlLmV4cHJlc3Npb25JbmZvc107XG4gICAgcG9wdXBUZW1wbGF0ZS5maWVsZEluZm9zID0gZ2V0Q2x1c3RlckZpZWxkSW5mb3MocG9wdXBUZW1wbGF0ZSwgRmllbGRJbmZvKTtcbiAgfVxuICBlbHNlIHtcbiAgICBsYXllci5wb3B1cFRlbXBsYXRlLmV4cHJlc3Npb25JbmZvcyA9IFsuLi5wb3B1cFRlbXBsYXRlLmV4cHJlc3Npb25JbmZvc107XG4gICAgcG9wdXBUZW1wbGF0ZS5maWVsZEluZm9zID0gWy4uLihhd2FpdCBnZW5lcmF0ZU1hc3RlckZpZWxkSW5mbyhsYXllciwgcG9wdXBUZW1wbGF0ZSkpXTtcbiAgfVxufTtcblxuY29uc3QgYXJjZ2lzUG9wdXBDc3MgPSBcIi5lbmFibGUtcG9wdXB7YmFja2dyb3VuZC1jb2xvcjp2YXIoLS1hcmNnaXMtYXBwLWJhY2tncm91bmQpO2Rpc3BsYXk6ZmxleDtwYWRkaW5nOnZhcigtLWFyY2dpcy1hcHAtY2FwLXNwYWNpbmcpIHZhcigtLWFyY2dpcy1hcHAtY2FwLXNwYWNpbmctaGFsZikgdmFyKC0tYXJjZ2lzLWFwcC1jYXAtc3BhY2luZy1xdWFydGVyKTtib3JkZXItYm90dG9tOnNvbGlkIDFweCB2YXIoLS1hcmNnaXMtYXBwLWJvcmRlcil9LmNvbXBvbmVudC11bHttYXJnaW46MCAwIHZhcigtLWFyY2dpcy1hcHAtY2FwLXNwYWNpbmcpO3BhZGRpbmc6MH0uc3VtbWFyeS1ldHtkaXNwbGF5OmZsZXg7YWxpZ24taXRlbXM6Y2VudGVyO3BhZGRpbmc6MCUgdmFyKC0tYXJjZ2lzLWFwcC1jYXAtc3BhY2luZy10aHJlZS1xdWFydGVycyl9LnN1bW1hcnktZXQtbGFiZWx7ZGlzcGxheTpmbGV4O2ZsZXgtZmxvdzpjb2x1bW4gbm93cmFwO2ZsZXg6MSAwIDAlO292ZXJmbG93OmhpZGRlbjtwYWRkaW5nOjAlIHZhcigtLWFyY2dpcy1hcHAtY2FwLXNwYWNpbmctaGFsZik7Zm9udC1zaXplOm1lZGl1bX0uc3VtbWFyeS1ldC1hY3Rpb257bWFyZ2luOjA7ZmxleDowIDAgMCU7anVzdGlmeS1zZWxmOmZsZXgtZW5kfS5ub3RpY2V7bWFyZ2luOjAuNXJlbX0uaW1hZ2VyeS1vcHRpb25ze3BhZGRpbmc6MCB2YXIoLS1hcmNnaXMtYXBwLWNhcC1zcGFjaW5nLXRocmVlLXF1YXJ0ZXJzKX1cIjtcblxuY29uc3QgQXJjZ2lzUG9wdXAgPSBjbGFzcyB7XG4gIGNvbnN0cnVjdG9yKGhvc3RSZWYpIHtcbiAgICByZWdpc3Rlckluc3RhbmNlKHRoaXMsIGhvc3RSZWYpO1xuICAgIHRoaXMucG9wdXBVcGRhdGVkID0gY3JlYXRlRXZlbnQodGhpcywgXCJwb3B1cFVwZGF0ZWRcIiwgNyk7XG4gICAgdGhpcy5hcmNnaXNQb3B1cERpc21pc3NlZENoYW5nZSA9IGNyZWF0ZUV2ZW50KHRoaXMsIFwiYXJjZ2lzUG9wdXBEaXNtaXNzZWRDaGFuZ2VcIiwgNyk7XG4gICAgdGhpcy5pbnRlcm5hbFBvcHVwVXBkYXRlZCA9IGNyZWF0ZUV2ZW50KHRoaXMsIFwiaW50ZXJuYWxQb3B1cFVwZGF0ZWRcIiwgNyk7XG4gICAgdGhpcy5jbG9zZVBvcHVwUG9wb3ZlcnMgPSBjcmVhdGVFdmVudCh0aGlzLCBcImNsb3NlUG9wdXBQb3BvdmVyc1wiLCA3KTtcbiAgICB0aGlzLnJlc2V0TXVsdGlNZWRpYUluZGV4ID0gY3JlYXRlRXZlbnQodGhpcywgXCJyZXNldE11bHRpTWVkaWFJbmRleFwiLCA3KTtcbiAgICB0aGlzLm1haW5Qb3B1cFJlUmVuZGVyID0gY3JlYXRlRXZlbnQodGhpcywgXCJtYWluUG9wdXBSZVJlbmRlclwiLCA3KTtcbiAgICB0aGlzLmRpc2FibGVQb3B1cFBhbmVsID0gY3JlYXRlRXZlbnQodGhpcywgXCJkaXNhYmxlUG9wdXBQYW5lbFwiLCA3KTtcbiAgICB0aGlzLmNsb3NlQXR0cmlidXRlUG9wb3ZlcnMgPSBjcmVhdGVFdmVudCh0aGlzLCBcImNsb3NlQXR0cmlidXRlUG9wb3ZlcnNcIiwgNyk7XG4gICAgdGhpcy5hdHRyaWJ1dGVzQ2hhbmdlTm90aWZpY2F0aW9uID0gY3JlYXRlRXZlbnQodGhpcywgXCJhdHRyaWJ1dGVzQ2hhbmdlTm90aWZpY2F0aW9uXCIsIDcpO1xuICAgIHRoaXMuYXJjYWRlQ2hhbmdlTm90aWZpY2F0aW9uID0gY3JlYXRlRXZlbnQodGhpcywgXCJhcmNhZGVDaGFuZ2VOb3RpZmljYXRpb25cIiwgNyk7XG4gICAgdGhpcy5hdHRyaWJ1dGVEYXRhID0gW107XG4gICAgdGhpcy5maWVsZERhdGEgPSBbXTtcbiAgICB0aGlzLnJpY2hUZXh0RWxlbWVudHMgPSBbXTtcbiAgICB0aGlzLnBvcHVwSGFzQXR0YWNobWVudCA9IGZhbHNlO1xuICAgIHRoaXMubGF5ZXJIYXNBdHRyaWJ1dGVzID0gdHJ1ZTtcbiAgICB0aGlzLmxheWVySGFzQ2hhcnRzID0gdHJ1ZTtcbiAgICB0aGlzLmxheWVySGFzSW1hZ2VzID0gdHJ1ZTtcbiAgICB0aGlzLmxheWVySGFzVGV4dCA9IHRydWU7XG4gICAgdGhpcy5pc1BvcHVwT3BlbkZvckN1cnJlbnRMYXllciA9IGZhbHNlO1xuICAgIHRoaXMucmVsYXRlZFJlY29yZHNEZWZhdWx0Q291bnQgPSAxO1xuICAgIHRoaXMuZ3VpZExpc3QgPSBbXTtcbiAgICB0aGlzLmRlYm91bmNlZFBvcHVwVXBkYXRlcyA9IGRlYm91bmNlKChkZXRhaWwpID0+IHtcbiAgICAgIHZhciBfYTtcbiAgICAgIGlmICh0aGlzLnNlcnZpY2VUeXBlICE9PSBzZXJ2aWNlVHlwZUVudW0ud21zKSB7XG4gICAgICAgIC8vIGlmIGV2ZW50LmRldGFpbCBpcyB0cnVlLCBvbmx5IHVwZGF0ZSBleHRlcm5hbFxuICAgICAgICBpZiAoIWRldGFpbCB8fCAhKChfYSA9IHRoaXMubGF5ZXIpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5wb3B1cFRlbXBsYXRlKSkge1xuICAgICAgICAgIGlmICh0aGlzLmxheWVyRGlzcGxheVR5cGUgPT09IGxheWVyRGlzcGxheVR5cGVFbnVtLmZlYXR1cmUpIHtcbiAgICAgICAgICAgIHRoaXMubGF5ZXIucG9wdXBUZW1wbGF0ZSA9IHRoaXMucG9wdXBUZW1wbGF0ZS5jbG9uZSgpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBlbHNlIGlmICh0aGlzLmxheWVyRGlzcGxheVR5cGUgPT09IGxheWVyRGlzcGxheVR5cGVFbnVtLmNsdXN0ZXIpIHtcbiAgICAgICAgICAgIHRoaXMubGF5ZXIuZmVhdHVyZVJlZHVjdGlvbi5wb3B1cFRlbXBsYXRlID0gdGhpcy5wb3B1cFRlbXBsYXRlLmNsb25lKCk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgICB0aGlzLnBvcHVwVXBkYXRlZC5lbWl0KHRoaXMubGF5ZXJEaXNwbGF5VHlwZSA9PT0gbGF5ZXJEaXNwbGF5VHlwZUVudW0ubWFwTm90ZXMgJiYge1xuICAgICAgICBtYXBOb3Rlc1BvcHVwdGVtcGxhdGU6IHRoaXMubWFwTm90ZXNQb3B1cEVuYWJsZWQgPyB0aGlzLnBvcHVwVGVtcGxhdGUuY2xvbmUoKSA6IG51bGxcbiAgICAgIH0pO1xuICAgIH0sIDEwMDApO1xuICAgIHRoaXMubWFuYWdlRXhwcmVzc2lvbkJ0bkNsaWNrID0gKGV2ZW50KSA9PiB7XG4gICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgIHRoaXMuY2xvc2VQb3B1cFBvcG92ZXJzLmVtaXQoKTtcbiAgICAgIGNvbnN0IGV4cHJlc3Npb25Db21wb25lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiYXJjZ2lzLXBvcHVwLWV4cHJlc3Npb25zXCIpO1xuICAgICAgaWYgKHRoaXMuY2FsY2l0ZUZsb3dQcm9wcykge1xuICAgICAgICB0aGlzLmNhbGNpdGVGbG93UHJvcHMuZmxvdy5hcHBlbmRDaGlsZChleHByZXNzaW9uQ29tcG9uZW50KTtcbiAgICAgIH1cbiAgICAgIGVsc2Uge1xuICAgICAgICB0aGlzLmhvc3RFbGVtZW50LnNoYWRvd1Jvb3QuZ2V0RWxlbWVudEJ5SWQoXCJwb3B1cEZsb3dfSWRcIikuYXBwZW5kQ2hpbGQoZXhwcmVzc2lvbkNvbXBvbmVudCk7XG4gICAgICB9XG4gICAgICBzZXRUaW1lb3V0KCgpID0+IHJlcXVlc3RBbmltYXRpb25GcmFtZSgoKSA9PiBleHByZXNzaW9uQ29tcG9uZW50LnNldEZvY3VzKCkpLCAyMDApO1xuICAgIH07XG4gICAgLy8gcmVuZG9yIG1ldGhvZHNcbiAgICB0aGlzLnBvcHVwVGl0bGVDb21wb25lbnQgPSAoKSA9PiAoaChcImFyY2dpcy1wb3B1cC10aXRsZVwiLCB7IHBvcHVwRmxvd0l0ZW06IHRoaXMucG9wdXBQYW5lbCB9KSk7XG4gICAgdGhpcy5maWVsZENvbXBvbmVudCA9ICh1bmlxdWVHdWlkLCBjb250ZW50LCBibG9ja09wZW4pID0+IChoKFwiZGl2XCIsIHsga2V5OiB1bmlxdWVHdWlkLCBpZDogdW5pcXVlR3VpZCB9LCBoKFwiYXJjZ2lzLXBvcHVwLWF0dHJpYnV0ZXNcIiwgeyBndWlkOiB1bmlxdWVHdWlkLCBwb3B1cENvbnRlbnQ6IGNvbnRlbnQsIHBvcHVwRmxvd0l0ZW06IHRoaXMucG9wdXBQYW5lbCwgYmxvY2tPcGVuOiBibG9ja09wZW4gfSkpKTtcbiAgICB0aGlzLmF0dGFjaG1lbnRDb21wb25lbnQgPSAodW5pcXVlR3VpZCwgY29udGVudCwgYmxvY2tPcGVuKSA9PiB7XG4gICAgICB2YXIgX2EsIF9iLCBfYztcbiAgICAgIHJldHVybiAoaChcImRpdlwiLCB7IGtleTogdW5pcXVlR3VpZCwgaWQ6IHVuaXF1ZUd1aWQgfSwgaChcImFyY2dpcy1wb3B1cC1hdHRhY2htZW50c1wiLCB7IGd1aWQ6IHVuaXF1ZUd1aWQsIGF0dGFjaG1lbnRDb250ZW50OiBjb250ZW50LCBsYXllclN1cHBvcnRzUmVzaXplQXR0YWNobWVudHM6ICgoX2MgPSAoX2IgPSAoX2EgPSB0aGlzLmxheWVyKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EuY2FwYWJpbGl0aWVzKSA9PT0gbnVsbCB8fCBfYiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2Iub3BlcmF0aW9ucykgPT09IG51bGwgfHwgX2MgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9jLnN1cHBvcnRzUmVzaXplQXR0YWNobWVudHMpXG4gICAgICAgICAgPyB0cnVlXG4gICAgICAgICAgOiBmYWxzZSwgcG9wdXBGbG93SXRlbTogdGhpcy5wb3B1cFBhbmVsLCBibG9ja09wZW46IGJsb2NrT3BlbiB9KSkpO1xuICAgIH07XG4gICAgdGhpcy5yaWNodGV4dENvbXBvbmVudCA9ICh1bmlxdWVHdWlkLCBjb250ZW50LCBibG9ja09wZW4pID0+IHtcbiAgICAgIC8vIHNrZXRjaC9tYXBOb3RlcyBsYXllcnMgaGF2ZSBubyBmaWVsZEluZm9zXG4gICAgICB2YXIgX2EsIF9iO1xuICAgICAgY29uc3QgcG9wdXBEYXRhID0gdGhpcy5wb3B1cFRlbXBsYXRlLnRvSlNPTigpO1xuICAgICAgY29uc3QgZmllbGREYXRhID0gKF9hID0gcG9wdXBEYXRhLmZpZWxkSW5mb3MpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5tYXAoKHsgZmllbGROYW1lLCBsYWJlbCB9KSA9PiB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgbmFtZTogZmllbGROYW1lLFxuICAgICAgICAgIGFsaWFzOiBsYWJlbCB8fCBmaWVsZE5hbWVcbiAgICAgICAgfTtcbiAgICAgIH0pO1xuICAgICAgdGhpcy5maWVsZERhdGEgPSBmaWVsZERhdGEgfHwgW107XG4gICAgICAvLyB0aGUgb25seSB3YXkgdG8gc2VlIHRoZSBjdXJyZW50IGFyY2FkZSBleHByZXNzaW9ucyBpbiB0aGUgY29sb3IgcGlja2VyIHBsdWdpbiBpcyBpZiBpdCBpcyBmaXJzdFxuICAgICAgLy8gYWRkZWQgaW4gYmVmb3JlIHRoZSByaWNodGV4dCBlZGl0b3IgY29tcG9uZW50IGlzIG1vdW50ZWQgb24gaW5pdGlhbGx5XG4gICAgICBjb25zdCBleHByZXNzaW9uSW5mb3MgPSAoX2IgPSB0aGlzLnBvcHVwVGVtcGxhdGUpID09PSBudWxsIHx8IF9iID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYi50b0pTT04oKS5leHByZXNzaW9uSW5mb3M7XG4gICAgICBjb25zdCBuZXdFeHByZXNzaW9uRGF0YSA9IGV4cHJlc3Npb25JbmZvcyA9PT0gbnVsbCB8fCBleHByZXNzaW9uSW5mb3MgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGV4cHJlc3Npb25JbmZvcy5tYXAoKHsgZXhwcmVzc2lvbiwgbmFtZSwgcmV0dXJuVHlwZSwgdGl0bGUgfSkgPT4ge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIG5hbWU6IGBleHByZXNzaW9uLyR7bmFtZX1gLFxuICAgICAgICAgIGFsaWFzOiB0aXRsZSA9PT0gXCJOZXcgZXhwcmVzc2lvblwiID8gXCIgXCIgOiB0aXRsZSxcbiAgICAgICAgICB0eXBlOiByZXR1cm5UeXBlLFxuICAgICAgICAgIGRlc2NyaXB0aW9uOiBleHByZXNzaW9uXG4gICAgICAgIH07XG4gICAgICB9KTtcbiAgICAgIGlmIChuZXdFeHByZXNzaW9uRGF0YSA9PT0gbnVsbCB8fCBuZXdFeHByZXNzaW9uRGF0YSA9PT0gdm9pZCAwID8gdm9pZCAwIDogbmV3RXhwcmVzc2lvbkRhdGEubGVuZ3RoKSB7XG4gICAgICAgIHRoaXMuZmllbGREYXRhID0gdGhpcy5maWVsZERhdGEuZmlsdGVyKChmaWVsZCkgPT4gIW5ld0V4cHJlc3Npb25EYXRhLnNvbWUoKGV4cHJlc3Npb24pID0+IGV4cHJlc3Npb24ubmFtZSA9PT0gZmllbGQubmFtZSkpO1xuICAgICAgfVxuICAgICAgdGhpcy5hdHRyaWJ1dGVEYXRhID0gbmV3RXhwcmVzc2lvbkRhdGFcbiAgICAgICAgPyBbLi4ubmV3RXhwcmVzc2lvbkRhdGEsIC4uLnRoaXMuZmllbGREYXRhXVxuICAgICAgICA6IHRoaXMuZmllbGREYXRhO1xuICAgICAgcmV0dXJuIChoKFwiZGl2XCIsIHsga2V5OiB1bmlxdWVHdWlkLCBpZDogdW5pcXVlR3VpZCwgcmVmOiAoZWwpID0+IHtcbiAgICAgICAgICBpZiAoZWwpIHtcbiAgICAgICAgICAgIHRoaXMucmljaFRleHRFbGVtZW50cyA9IFsuLi50aGlzLnJpY2hUZXh0RWxlbWVudHMsIGVsXTtcbiAgICAgICAgICB9XG4gICAgICAgIH0gfSwgaChcImFyY2dpcy1wb3B1cC1yaWNodGV4dFwiLCB7IGZpZWxkRXhwcmVzc2lvbkRhdGE6IHtcbiAgICAgICAgICBkYXRhOiB0aGlzLmF0dHJpYnV0ZURhdGEsXG4gICAgICAgICAgcGxhY2Vob2xkZXJUZXh0OiB0aGlzLnN0cmluZ3Muc2VhcmNoRmllbGRzLFxuICAgICAgICAgIGhlYWRpbmc6IHRoaXMuc3RyaW5ncy5zZWxlY3RGaWVsZCxcbiAgICAgICAgICBsYWJlbDogdGhpcy5zdHJpbmdzLmZpZWxkc0xpc3RQbHVnaW5OYW1lLFxuICAgICAgICAgIG1hcFZpZXc6IHRoaXMubWFwVmlldyxcbiAgICAgICAgICBsYXllcjogdGhpcy5sYXllclxuICAgICAgICB9LCBhcmNnaXNDb2xvclBpY2tlckRhdGE6IHtcbiAgICAgICAgICBkYXRhOiB0aGlzLmF0dHJpYnV0ZURhdGEsXG4gICAgICAgICAgZmlsdGVyUGxhY2Vob2xkZXI6IHRoaXMuc3RyaW5ncy5zZWFyY2hBdHRyaWJ1dGVzLFxuICAgICAgICAgIGxhYmVsOiB0aGlzLnN0cmluZ3MuY29sb3JQaWNrZXIsXG4gICAgICAgICAgZG9uZVRleHQ6IHRoaXMuc3RyaW5ncy5kb25lLFxuICAgICAgICAgIGN1c3RvbVRleHQ6IHRoaXMuc3RyaW5ncy5jdXN0b21UZXh0LFxuICAgICAgICAgIGF0dHJpYnV0ZVRleHQ6IHRoaXMuc3RyaW5ncy5hdHRyaWJ1dGVUZXh0XG4gICAgICAgIH0sIGd1aWQ6IHVuaXF1ZUd1aWQsIHJpY2h0ZXh0Q29udGVudDogY29udGVudCwgcG9wdXBGbG93SXRlbTogdGhpcy5wb3B1cFBhbmVsLCBibG9ja09wZW46IGJsb2NrT3BlbiB9KSkpO1xuICAgIH07XG4gICAgdGhpcy5tdWx0aW1lZGlhQ29tcG9uZW50ID0gKHVuaXF1ZUd1aWQsIGNvbnRlbnQsIGJsb2NrT3BlbikgPT4gKGgoXCJkaXZcIiwgeyBrZXk6IHVuaXF1ZUd1aWQsIGlkOiB1bmlxdWVHdWlkIH0sIGgoXCJhcmNnaXMtcG9wdXAtbXVsdGltZWRpYVwiLCB7IGd1aWQ6IHVuaXF1ZUd1aWQsIG11bHRpbWVkaWFDb250ZW50OiBjb250ZW50LCBwb3B1cEZsb3dJdGVtOiB0aGlzLnBvcHVwUGFuZWwsIGJsb2NrT3BlbjogYmxvY2tPcGVuIH0pKSk7XG4gICAgdGhpcy5hcmNhZGVDb21wb25lbnQgPSAodW5pcXVlR3VpZCwgY29udGVudCwgYmxvY2tPcGVuKSA9PiAoaChcImRpdlwiLCB7IGtleTogdW5pcXVlR3VpZCwgaWQ6IHVuaXF1ZUd1aWQgfSwgaChcImFyY2dpcy1wb3B1cC1hcmNhZGVcIiwgeyBndWlkOiB1bmlxdWVHdWlkLCBhcmNhZGVDb250ZW50OiBjb250ZW50LCBibG9ja09wZW46IGJsb2NrT3BlbiB9KSkpO1xuICAgIHRoaXMucmVsYXRpb25zaGlwQ29tcG9uZW50ID0gKHVuaXF1ZUd1aWQsIGNvbnRlbnQsIGJsb2NrT3BlbikgPT4gKGgoXCJkaXZcIiwgeyBrZXk6IHVuaXF1ZUd1aWQsIGlkOiB1bmlxdWVHdWlkIH0sIGgoXCJhcmNnaXMtcG9wdXAtcmVsYXRpb25zaGlwXCIsIHsgZ3VpZDogdW5pcXVlR3VpZCwgcmVsYXRlZFJlY29yZHNDb250ZW50OiBjb250ZW50LCBwb3B1cEZsb3dJdGVtOiB0aGlzLnBvcHVwUGFuZWwsIGJsb2NrT3BlbjogYmxvY2tPcGVuIH0pKSk7XG4gICAgdGhpcy5tYXBWaWV3ID0gdW5kZWZpbmVkO1xuICAgIHRoaXMubGF5ZXIgPSB1bmRlZmluZWQ7XG4gICAgdGhpcy5wb3J0YWwgPSB1bmRlZmluZWQ7XG4gICAgdGhpcy5kaXNwbGF5UG9wdXAgPSB0cnVlO1xuICAgIHRoaXMuY29uZmlnID0gdW5kZWZpbmVkO1xuICAgIHRoaXMubGF5ZXJEaXNwbGF5VHlwZSA9IGxheWVyRGlzcGxheVR5cGVFbnVtLmZlYXR1cmU7XG4gICAgdGhpcy5kaXNtaXNzaWJsZSA9IGZhbHNlO1xuICAgIHRoaXMuYmFja0J1dHRvbiA9IGZhbHNlO1xuICAgIHRoaXMuaGlkZUxheWVyVGl0bGUgPSBmYWxzZTtcbiAgICB0aGlzLnNob3dDb25maWd1cmVGaWVsZHMgPSBmYWxzZTtcbiAgICB0aGlzLnNob3dNYW5hZ2VFeHByZXNzaW9ucyA9IHRydWU7XG4gICAgdGhpcy5jYWxjaXRlRmxvd1Byb3BzID0gbnVsbDtcbiAgICB0aGlzLm1hcE5vdGVzUG9wdXBUZW1wbGF0ZSA9IHVuZGVmaW5lZDtcbiAgICB0aGlzLm1hcE5vdGVzR3JhcGhpYyA9IHVuZGVmaW5lZDtcbiAgICB0aGlzLnJlUmVuZGVyID0gdW5kZWZpbmVkO1xuICAgIHRoaXMucG9wdXBDb21wb25lbnRzID0gW107XG4gICAgdGhpcy5oYXNFcnJvciA9IGZhbHNlO1xuICB9XG4gIC8vIGxpZmVjeWNsZSBtZXRob2RzXG4gIGFzeW5jIGNvbXBvbmVudFdpbGxMb2FkKCkge1xuICAgIHZhciBfYSwgX2IsIF9jO1xuICAgIC8vIHBvcHVwU3RhdGUgaGVyZSBoYXMgdGhlIHNldHRpbmdzIGZyb20gdGhlIGxhc3RcbiAgICAvLyBzZXNzaW9uIG9mIHRoaXMgY29tcG9uZW50IGluc3RlYWQgb2YgYSBjbGVhbiBuZXcgb25lXG4gICAgLy8gYmVjYXVzZSBjcmVhdGVTdG9yZSBnZXRzIGNhbGxlZCBqdXN0IG9uY2UgaW4gYSBhcHAgc2Vzc2lvblxuICAgIC8vIHNvIGluc3RlYWQgY2FsbCBhIGNsZWFyIG1ldGhvZCwgYXMgYSB3b3JrYXJvdW5kXG4gICAgY2xlYXJQb3B1cFN0YXRlKHBvcHVwU3RhdGUpO1xuICAgIFt0aGlzLnN0cmluZ3MsIHRoaXMuY3VycmVudExhbmd1YWdlLCB0aGlzLmN1cnJlbnRMYW5ndWFnZUludGxdID1cbiAgICAgIGF3YWl0IGdldExvY2FsZUNvbXBvbmVudFN0cmluZ3ModGhpcy5ob3N0RWxlbWVudCk7XG4gICAgdGhpcy5zZXJ2aWNlVHlwZSA9IGdldFNlcnZpY2VUeXBlKHRoaXMubGF5ZXIpO1xuICAgIGF3YWl0IHRoaXMubG9hZEFsbE1vZHVsZXMoKTtcbiAgICAvLyBkZXRlcm1pbmUgaWYgdG8gc2hvdyBtYW5hZ2UgZXhwcmVzc2lvbnMgYW5kIGFsc28gYXJjYWRlIGNvbnRlbnRcbiAgICB0aGlzLnN1cHBvcnRzQXJjYWRlID1cbiAgICAgIHRoaXMuc2hvd01hbmFnZUV4cHJlc3Npb25zICYmXG4gICAgICAgICh0aGlzLmxheWVyRGlzcGxheVR5cGUgPT09IGxheWVyRGlzcGxheVR5cGVFbnVtLmZlYXR1cmUgfHxcbiAgICAgICAgICB0aGlzLmxheWVyRGlzcGxheVR5cGUgPT09IGxheWVyRGlzcGxheVR5cGVFbnVtLmNsdXN0ZXIpICYmXG4gICAgICAgIHRoaXMuc2VydmljZVR5cGUgIT09IHNlcnZpY2VUeXBlRW51bS5vZ2NGZWF0dXJlICYmXG4gICAgICAgIHRoaXMuc2VydmljZVR5cGUgIT09IHNlcnZpY2VUeXBlRW51bS53ZnMgJiZcbiAgICAgICAgdGhpcy5zZXJ2aWNlVHlwZSAhPT0gc2VydmljZVR5cGVFbnVtLmltYWdlcnkgJiZcbiAgICAgICAgdGhpcy5zZXJ2aWNlVHlwZSAhPT0gc2VydmljZVR5cGVFbnVtLmltYWdlcnlUaWxlICYmXG4gICAgICAgIHRoaXMuc2VydmljZVR5cGUgIT09IHNlcnZpY2VUeXBlRW51bS5zdWJ0eXBlO1xuICAgIGlmICh0aGlzLnNlcnZpY2VUeXBlID09PSBzZXJ2aWNlVHlwZUVudW0udGlsZSAmJlxuICAgICAgXCJ1cmxcIiBpbiB0aGlzLmxheWVyICYmXG4gICAgICAhKFwidHlwZVwiIGluIHRoaXMubGF5ZXIpICYmXG4gICAgICB0aGlzLmxheWVyLnVybC5pbmRleE9mKHRoaXMubGF5ZXIubGF5ZXIudXJsKSA+IC0xKSB7XG4gICAgICAvLyBKUy1BUEkgZG9lcyB0aGUgY2hlY2sgaWYgYSByZWxhdGVkIEZMIGV4aXN0c1xuICAgICAgdGhpcy5oYXNFcnJvciA9IHRydWU7XG4gICAgICBjb25zb2xlLmVycm9yKFwicG9wdXBzIG5vdCBzdXBwb3J0ZWQsIG5vIHJlbGF0ZWQgZmVhdHVyZSBzZXJ2aWNlXCIpO1xuICAgIH1cbiAgICBlbHNlIGlmICh0aGlzLnNlcnZpY2VUeXBlICE9PSBzZXJ2aWNlVHlwZUVudW0ud21zKSB7XG4gICAgICBpZiAodGhpcy5sYXllckRpc3BsYXlUeXBlID09PSBsYXllckRpc3BsYXlUeXBlRW51bS5mZWF0dXJlKSB7XG4gICAgICAgIGNvbnN0IGxheWVyVHlwZSA9IFwidHlwZVwiIGluIHRoaXMubGF5ZXIgPyB0aGlzLmxheWVyLnR5cGUgOiBcInN1YmxheWVyXCI7XG4gICAgICAgIGNvbnN0IHNvdXJjZUxheWVyID0gdGhpcy5tYXBWaWV3LnBvcHVwLnZpc2libGVcbiAgICAgICAgICA/IChfYSA9IHRoaXMubWFwVmlldy5wb3B1cC5zZWxlY3RlZEZlYXR1cmUpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5zb3VyY2VMYXllclxuICAgICAgICAgIDogdW5kZWZpbmVkO1xuICAgICAgICB0aGlzLmlzUG9wdXBPcGVuRm9yQ3VycmVudExheWVyID1cbiAgICAgICAgICBsYXllclR5cGUgPT09IFwic3VidHlwZS1zdWJsYXllclwiXG4gICAgICAgICAgICA/IChzb3VyY2VMYXllciA9PT0gbnVsbCB8fCBzb3VyY2VMYXllciA9PT0gdm9pZCAwID8gdm9pZCAwIDogc291cmNlTGF5ZXIuc3VidHlwZUNvZGUpID09PSB0aGlzLmxheWVyLnN1YnR5cGVDb2RlICYmXG4gICAgICAgICAgICAgIChzb3VyY2VMYXllciA9PT0gbnVsbCB8fCBzb3VyY2VMYXllciA9PT0gdm9pZCAwID8gdm9pZCAwIDogc291cmNlTGF5ZXIucGFyZW50LmlkKSA9PT0gdGhpcy5sYXllci5wYXJlbnQuaWQgLy8gVE9ETyBhbnkgKyBwYXJlbnRcbiAgICAgICAgICAgIDogbGF5ZXJUeXBlID09PSBcInN1YmxheWVyXCJcbiAgICAgICAgICAgICAgPyAoc291cmNlTGF5ZXIgPT09IG51bGwgfHwgc291cmNlTGF5ZXIgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHNvdXJjZUxheWVyLmlkKSA9PT0gdGhpcy5sYXllci5pZCAmJlxuICAgICAgICAgICAgICAgIChzb3VyY2VMYXllciA9PT0gbnVsbCB8fCBzb3VyY2VMYXllciA9PT0gdm9pZCAwID8gdm9pZCAwIDogc291cmNlTGF5ZXIubGF5ZXIuaWQpID09PSB0aGlzLmxheWVyLmxheWVyLmlkXG4gICAgICAgICAgICAgIDogXCJpZFwiIGluIHRoaXMubGF5ZXIgJiYgKHNvdXJjZUxheWVyID09PSBudWxsIHx8IHNvdXJjZUxheWVyID09PSB2b2lkIDAgPyB2b2lkIDAgOiBzb3VyY2VMYXllci5pZCkgPT09IHRoaXMubGF5ZXIuaWQ7XG4gICAgICAgIC8vIGRvZXMgbGF5ZXIgaGF2ZSBhdHRhY2htZW50XG4gICAgICAgIGlmIChpc0RlZmluZWQoKF9jID0gKF9iID0gdGhpcy5sYXllci5jYXBhYmlsaXRpZXMpID09PSBudWxsIHx8IF9iID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYi5kYXRhKSA9PT0gbnVsbCB8fCBfYyA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2Muc3VwcG9ydHNBdHRhY2htZW50KSkge1xuICAgICAgICAgIHRoaXMubGF5ZXJIYXNBdHRhY2htZW50ID0gdGhpcy5sYXllci5jYXBhYmlsaXRpZXMuZGF0YS5zdXBwb3J0c0F0dGFjaG1lbnQ7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5sYXllckhhc0VUID0gdGhpcy5sYXllci5lZGl0RmllbGRzSW5mbyA/IHRydWUgOiBmYWxzZTtcbiAgICAgICAgcG9wdXBTdGF0ZS5sYXllckhhc1JlbGF0ZWRSZWNvcmRzID0gYXdhaXQgbGF5ZXJIYXNSZWxhdGVkUmVjb3Jkcyh0aGlzLmxheWVyLCB0aGlzLm1hcFZpZXcsIHRoaXMuc2VydmljZVR5cGUpO1xuICAgICAgICAvLyB0ZW1wLCB0dXJuIG9mZiBwb3B1cEVuYWJsZWQgZm9yIE1JTFxuICAgICAgICBpZiAodGhpcy5zZXJ2aWNlVHlwZSA9PT0gc2VydmljZVR5cGVFbnVtLm1hcEltYWdlICYmXG4gICAgICAgICAgIXRoaXMubGF5ZXIucG9wdXBUZW1wbGF0ZSkge1xuICAgICAgICAgIHRoaXMubGF5ZXIucG9wdXBFbmFibGVkID0gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgICAgLy8gZ2VuZXJhdGUgZGVmYXVsdCBpZiB0ZW1wbGF0ZSBpcyBlbXB0eVxuICAgICAgICB0aGlzLnBvcHVwVGVtcGxhdGUgPSB0aGlzLmxheWVyLnBvcHVwVGVtcGxhdGVcbiAgICAgICAgICA/IHRoaXMubGF5ZXIucG9wdXBUZW1wbGF0ZS5jbG9uZSgpXG4gICAgICAgICAgOiB0aGlzLmxheWVyLmNyZWF0ZVBvcHVwVGVtcGxhdGUoKTtcbiAgICAgICAgLy8gZ2VuZXJhdGUgbWFzdGVyIGZpZWxkIGluZm9cbiAgICAgICAgdGhpcy5wb3B1cFRlbXBsYXRlLmZpZWxkSW5mb3MgPSBbXG4gICAgICAgICAgLi4uKGF3YWl0IGdlbmVyYXRlTWFzdGVyRmllbGRJbmZvKHRoaXMubGF5ZXIsIHRoaXMucG9wdXBUZW1wbGF0ZSkpXG4gICAgICAgIF07XG4gICAgICB9XG4gICAgICBlbHNlIGlmICh0aGlzLmxheWVyRGlzcGxheVR5cGUgPT09IGxheWVyRGlzcGxheVR5cGVFbnVtLmNsdXN0ZXIpIHtcbiAgICAgICAgdGhpcy5sYXllckhhc0F0dGFjaG1lbnQgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5sYXllckhhc0VUID0gZmFsc2U7XG4gICAgICAgIHRoaXMucG9wdXBUZW1wbGF0ZSA9IHRoaXMubGF5ZXIuZmVhdHVyZVJlZHVjdGlvbi5wb3B1cFRlbXBsYXRlLmNsb25lKCk7XG4gICAgICB9XG4gICAgICBlbHNlIGlmICh0aGlzLmxheWVyRGlzcGxheVR5cGUgPT09IGxheWVyRGlzcGxheVR5cGVFbnVtLm1hcE5vdGVzKSB7XG4gICAgICAgIGlmICh0aGlzLm1hcE5vdGVzUG9wdXBUZW1wbGF0ZSkge1xuICAgICAgICAgIHRoaXMubWFwTm90ZXNQb3B1cEVuYWJsZWQgPSB0cnVlO1xuICAgICAgICAgIHRoaXMucG9wdXBUZW1wbGF0ZSA9IHRoaXMubWFwTm90ZXNQb3B1cFRlbXBsYXRlLmNsb25lKCk7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgdGhpcy5tYXBOb3Rlc1BvcHVwRW5hYmxlZCA9IGZhbHNlO1xuICAgICAgICAgIGNvbnN0IFtQb3B1cFRlbXBsYXRlXSA9IGF3YWl0IGxvYWRNb2R1bGVzKFtcbiAgICAgICAgICAgIFwiZXNyaS9Qb3B1cFRlbXBsYXRlXCJcbiAgICAgICAgICBdKTtcbiAgICAgICAgICB0aGlzLnBvcHVwVGVtcGxhdGUgPSBuZXcgUG9wdXBUZW1wbGF0ZSgpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMubGF5ZXJIYXNBdHRhY2htZW50ID0gZmFsc2U7XG4gICAgICAgIHRoaXMubGF5ZXJIYXNFVCA9IGZhbHNlO1xuICAgICAgICB0aGlzLmxheWVySGFzQXR0cmlidXRlcyA9IGZhbHNlO1xuICAgICAgICB0aGlzLmxheWVySGFzQ2hhcnRzID0gZmFsc2U7XG4gICAgICB9XG4gICAgfVxuICAgIHBvcHVwU3RhdGUubGF5ZXIgPSB0aGlzLmxheWVyO1xuICAgIHBvcHVwU3RhdGUubWFwVmlldyA9IHRoaXMubWFwVmlldztcbiAgICBwb3B1cFN0YXRlLnBvcnRhbCA9IHRoaXMucG9ydGFsO1xuICAgIHBvcHVwU3RhdGUuY29uZmlnID0gdGhpcy5jb25maWc7XG4gICAgcG9wdXBTdGF0ZS5zdHJpbmdzID0gdGhpcy5zdHJpbmdzO1xuICAgIHBvcHVwU3RhdGUuY3VycmVudExhbmd1YWdlID0gdGhpcy5jdXJyZW50TGFuZ3VhZ2U7XG4gICAgcG9wdXBTdGF0ZS5jdXJyZW50TGFuZ3VhZ2VJbnRsID0gdGhpcy5jdXJyZW50TGFuZ3VhZ2VJbnRsO1xuICAgIHBvcHVwU3RhdGUuc2VydmljZVR5cGUgPSB0aGlzLnNlcnZpY2VUeXBlO1xuICAgIHBvcHVwU3RhdGUucG9wdXBUZW1wbGF0ZSA9IHRoaXMucG9wdXBUZW1wbGF0ZTtcbiAgICBwb3B1cFN0YXRlLmxheWVySGFzQXR0YWNobWVudCA9IHRoaXMubGF5ZXJIYXNBdHRhY2htZW50O1xuICAgIHBvcHVwU3RhdGUubGF5ZXJIYXNFVCA9IHRoaXMubGF5ZXJIYXNFVDtcbiAgICBwb3B1cFN0YXRlLmxheWVySGFzQXR0cmlidXRlcyA9IHRoaXMubGF5ZXJIYXNBdHRyaWJ1dGVzO1xuICAgIHBvcHVwU3RhdGUubGF5ZXJIYXNDaGFydHMgPSB0aGlzLmxheWVySGFzQ2hhcnRzO1xuICAgIHBvcHVwU3RhdGUubGF5ZXJIYXNJbWFnZXMgPSB0aGlzLmxheWVySGFzSW1hZ2VzO1xuICAgIHBvcHVwU3RhdGUubGF5ZXJIYXNUZXh0ID0gdGhpcy5sYXllckhhc1RleHQ7XG4gICAgcG9wdXBTdGF0ZS5sYXllckRpc3BsYXlUeXBlID0gdGhpcy5sYXllckRpc3BsYXlUeXBlO1xuICAgIHBvcHVwU3RhdGUuc3VwcG9ydHNBcmNhZGUgPSB0aGlzLnN1cHBvcnRzQXJjYWRlO1xuICB9XG4gIGFzeW5jIGNvbXBvbmVudERpZExvYWQoKSB7XG4gICAgdmFyIF9hO1xuICAgIC8vIGxvYWQgY29udGVudCBvbmx5IG9uY2UgcG9wdXBGbG93SXRlbSBleGlzdHNcbiAgICAvLyBwb3B1cFRlbXBsYXRlLmNvbnRlbnQgY2FuIGJlIFtdLCBzdHJpbmcsIGZ1bmN0aW9uIGFuZCBwcm9taXNlXG4gICAgLy8gaWYgc3RyaW5nLCBjb252ZXJ0IHRvIHRleHQgY29udGVudFxuICAgIGlmICh0aGlzLnBvcHVwVGVtcGxhdGUpIHtcbiAgICAgIGlmICh0eXBlb2YgdGhpcy5wb3B1cFRlbXBsYXRlLmNvbnRlbnQgPT09IFwic3RyaW5nXCIpIHtcbiAgICAgICAgY29uc3QgdGV4dENvbnRlbnQgPSBhd2FpdCBsb2FkTW9kdWxlcyhbXCJlc3JpL3BvcHVwL2NvbnRlbnQvVGV4dENvbnRlbnRcIl0pLnRoZW4oKFtUZXh0Q29udGVudF0pID0+IHtcbiAgICAgICAgICByZXR1cm4gbmV3IFRleHRDb250ZW50KHtcbiAgICAgICAgICAgIHRleHQ6IHRoaXMucG9wdXBUZW1wbGF0ZS5jb250ZW50XG4gICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLnBvcHVwVGVtcGxhdGUuY29udGVudCA9IFt0ZXh0Q29udGVudF07XG4gICAgICB9XG4gICAgICBpZiAoQXJyYXkuaXNBcnJheSh0aGlzLnBvcHVwVGVtcGxhdGUuY29udGVudCkpIHtcbiAgICAgICAgdGhpcy5wb3B1cFRlbXBsYXRlLmNvbnRlbnQuZm9yRWFjaCgoY29udGVudCwgaW5kZXgpID0+IHtcbiAgICAgICAgICAvLyBpZiBsYXllciBoYXMgbm8gYXR0YWNobWVudCwgcmVtb3ZlIGl0XG4gICAgICAgICAgaWYgKGNvbnRlbnQudHlwZSA9PT0gXCJhdHRhY2htZW50c1wiICYmICF0aGlzLmxheWVySGFzQXR0YWNobWVudCkge1xuICAgICAgICAgICAgdGhpcy5wb3B1cFRlbXBsYXRlLmNvbnRlbnQuc3BsaWNlKGluZGV4LCAxKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmFkZFRvUG9wdXBDb21wb25lbnRzKGNvbnRlbnQpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgICBlbHNlIHtcbiAgICAgICAgY29uc29sZS5lcnJvcihcImNvbnRlbnQgbm90IHN1cHBvcnRlZFwiKTtcbiAgICAgIH1cbiAgICAgIHRoaXMucmVSZW5kZXIgPSAhdGhpcy5yZVJlbmRlcjtcbiAgICB9IC8vIGVsc2UgV01TXG4gICAgaWYgKHRoaXMuc2VydmljZVR5cGUgIT09IHNlcnZpY2VUeXBlRW51bS53bXMpIHtcbiAgICAgIC8vIHdhdGNoIGZvciBjaGFuZ2VzIHRvIGxheWVycy90YWJsZXMgdG8gc2hvdy9oaWRlIHJlbGF0aW9uc2hpcFxuICAgICAgaWYgKHRoaXMubGF5ZXJEaXNwbGF5VHlwZSA9PT0gbGF5ZXJEaXNwbGF5VHlwZUVudW0uZmVhdHVyZSkge1xuICAgICAgICB0aGlzLndhdGNoRm9yQ2hhbmdlc1RvTGF5ZXJzTGlzdCgpO1xuICAgICAgfVxuICAgICAgdGhpcy5zb3J0YWJsZUNvbXBvbmVudHMgPSB0aGlzLmhvc3RFbGVtZW50LnNoYWRvd1Jvb3QuZ2V0RWxlbWVudEJ5SWQoXCJTb3J0YWJsZUNvbXBvbmVudHNfSWRcIik7XG4gICAgICB0aGlzLmNhbGNpdGVGYWIgPVxuICAgICAgICAoKF9hID0gdGhpcy5jYWxjaXRlRmxvd1Byb3BzKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EuY2FsY2l0ZUZhYikgfHxcbiAgICAgICAgICB0aGlzLmhvc3RFbGVtZW50LnNoYWRvd1Jvb3QuZ2V0RWxlbWVudEJ5SWQoXCJhZGRDb21wb25lbnRCdG5fSWRcIik7XG4gICAgICBjb25zdCB0ZW1wUG9wdXBQcm9wID0gdGhpcy5nZXRQb3B1cEVuYWJsZWRQcm9wKCk7XG4gICAgICB0aGlzLmVuYWJsZURpc2FibGVQb3B1cCh0ZW1wUG9wdXBQcm9wKTtcbiAgICAgIC8vdGhpcy5zaG93UHJldmlld1BvcHVwKHRlbXBQb3B1cFByb3ApOyAtIHNldHVwUmVzaXplT2JzZXJ2ZXIgb3BlbnMgdGhlIHBvcHVwIGFscmVhZHlcbiAgICAgIC8vIE1WIHdvcmtmbG93XG4gICAgICB0aGlzLnNldHVwUmVzaXplT2JzZXJ2ZXIoKTtcbiAgICAgIC8vIGZhYiBmb3IgY29udGVudCBwb3BvdmVyXG4gICAgICB0aGlzLmNhbGNpdGVGYWIub25jbGljayA9IChldmVudCkgPT4ge1xuICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgdGhpcy5jbG9zZVBvcHVwUG9wb3ZlcnMuZW1pdCgpO1xuICAgICAgICBpZiAoIXRoaXMuY29udGVudFBvcG92ZXIpIHtcbiAgICAgICAgICB0aGlzLmNvbnRlbnRQb3BvdmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImFyY2dpcy1wb3B1cC1tYWluLWNvbnRlbnRwb3BvdmVyXCIpO1xuICAgICAgICAgIHRoaXMuY29udGVudFBvcG92ZXIuY29udGVudFBvcG92ZXJSZWZFbGVtZW50ID0gdGhpcy5jYWxjaXRlRmFiO1xuICAgICAgICAgIHRoaXMuY29udGVudFBvcG92ZXIucG9wdXBIYXNBdHRhY2htZW50ID0gdGhpcy5wb3B1cEhhc0F0dGFjaG1lbnQ7XG4gICAgICAgICAgdGhpcy5jb250ZW50UG9wb3Zlci5wb3BvdmVyUGFuZWxXaWR0aCA9IHRoaXMuaG9zdEVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkud2lkdGg7XG4gICAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZCh0aGlzLmNvbnRlbnRQb3BvdmVyKTtcbiAgICAgICAgICB0aGlzLmNhbGNpdGVGYWIuZGlzYWJsZWQgPSB0cnVlO1xuICAgICAgICAgIHRoaXMuZGlzYWJsZVBvcHVwUGFuZWwuZW1pdCh0cnVlKTtcbiAgICAgICAgfVxuICAgICAgfTtcbiAgICB9XG4gICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKCgpID0+IHRoaXMucG9wdXBQYW5lbC5zZXRGb2N1cygpKTtcbiAgfVxuICBjb21wb25lbnREaWRVcGRhdGUoKSB7XG4gICAgdGhpcy5pbnRlcm5hbFBvcHVwVXBkYXRlZC5lbWl0KCk7XG4gIH1cbiAgZGlzY29ubmVjdGVkQ2FsbGJhY2soKSB7XG4gICAgdmFyIF9hLCBfYjtcbiAgICAoX2EgPSB0aGlzLnBhcmVudFNoZWxsT2JzZXJ2ZXIpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5kaXNjb25uZWN0KCk7XG4gICAgKF9iID0gdGhpcy53YXRjaExheWVyc0FuZFRhYmxlcykgPT09IG51bGwgfHwgX2IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9iLnJlbW92ZSgpO1xuICAgIGlmICh0aGlzLmNvbnRlbnRQb3BvdmVyKSB7XG4gICAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKHRoaXMuY29udGVudFBvcG92ZXIpO1xuICAgIH1cbiAgfVxuICAvLyBQdWJsaWMgTWV0aG9kc1xuICBhc3luYyBkb25lKCkge1xuICAgIHZhciBfYTtcbiAgICB0aGlzLnJlc2V0TXVsdGlNZWRpYUluZGV4LmVtaXQoKTtcbiAgICB0aGlzLmNsb3NlUG9wdXBQb3BvdmVycy5lbWl0KCk7XG4gICAgKF9hID0gdGhpcy5hdHRyaWJ1dGVzQ29tcG9uZW50KSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EuZG9uZSgpO1xuICAgIHRoaXMuc2hvd1ByZXZpZXdQb3B1cChmYWxzZSk7XG4gIH1cbiAgLyoqXG4gICAqIEBkZXByZWNhdGVkIHdpdGggMy4wLnhcbiAgICogQHBhcmFtIGZvY3VzSWRcbiAgICoqL1xuICBhc3luYyBzZXRGb2N1cyhmb2N1c0lkKSB7XG4gICAgdmFyIF9hO1xuICAgIChfYSA9IHRoaXMuY2FsY2l0ZUZhYikgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLnNldEZvY3VzKCk7XG4gIH1cbiAgLy8gRXZlbnRzXG4gIGNhbGNpdGVGbG93SXRlbUJhY2tIYW5kbGVyKGV2ZW50KSB7XG4gICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgdGhpcy5jbG9zZVBvcHVwUG9wb3ZlcnMuZW1pdCgpO1xuICB9XG4gIG1haW5Qb3B1cFJlUmVuZGVySGFuZGxlcihldmVudCkge1xuICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgIHRoaXMucmVSZW5kZXIgPSB0aGlzLnJlUmVuZGVyID8gZmFsc2UgOiB0cnVlO1xuICB9XG4gIC8vIHVwZGF0ZSBwb3B1cFxuICBpbnRlcm5hbFBvcHVwVXBkYXRlZEhhbmRsZXIoZXZlbnQpIHtcbiAgICB2YXIgX2EsIF9iO1xuICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgIC8vIHJlZnJlc2ggcG9wdXAgaW4gY2FzZSBpdCdzIGluIGEgZHJpbGwtaW4gc3RhdGVcbiAgICBpZiAodGhpcy5zaW5nbGVGZWF0dXJlICYmICgoX2IgPSAoX2EgPSB0aGlzLm1hcFZpZXcucG9wdXApID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5fZmxvd0l0ZW1zKSA9PT0gbnVsbCB8fCBfYiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2IubGVuZ3RoKSkge1xuICAgICAgdGhpcy5tYXBWaWV3LnBvcHVwLmZlYXR1cmVzID0gdW5kZWZpbmVkO1xuICAgICAgLy8gd2FpdGluZyBoZXJlIG1ha2VzIHN1cmUgaXQgZG9lc24ndCByZWZyZXNoIHR3aWNlXG4gICAgICAvLyBhIHRpbWVvdXQgb2YgYXQgbGVhc3QgMCBpcyBuZWVkZWQgdG8gcmVzZXQgdGhlIGZlYXR1cmVzIGxpc3RcbiAgICAgIHNldFRpbWVvdXQoKCkgPT4gKHRoaXMubWFwVmlldy5wb3B1cC5mZWF0dXJlcyA9IFt0aGlzLnNpbmdsZUZlYXR1cmVdKSwgMTAwMCk7XG4gICAgfVxuICAgIHRoaXMuZGVib3VuY2VkUG9wdXBVcGRhdGVzKGV2ZW50LmRldGFpbCk7XG4gIH1cbiAgZGVsZXRlQ29tcG9uZW50SGFuZGxlcihldmVudCkge1xuICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgIHRoaXMuY2xvc2VQb3B1cFBvcG92ZXJzLmVtaXQoKTtcbiAgICAvLyBlYWNoIGRpdiBoYXMgaWQuIEZpbmQgaWQsIGFuZCBzcGxpY2UgYnkgaW5kZXhcbiAgICBjb25zdCBhbGxDb21wb25lbnRzID0gdGhpcy5zb3J0YWJsZUNvbXBvbmVudHMuZ2V0RWxlbWVudHNCeVRhZ05hbWUoXCJkaXZcIik7XG4gICAgZm9yIChsZXQgeCA9IDA7IHggPCBhbGxDb21wb25lbnRzLmxlbmd0aDsgeCsrKSB7XG4gICAgICBpZiAoYWxsQ29tcG9uZW50c1t4XS5pZCA9PT0gZXZlbnQuZGV0YWlsKSB7XG4gICAgICAgIHRoaXMucG9wdXBUZW1wbGF0ZS5jb250ZW50LnNwbGljZSh4LCAxKTtcbiAgICAgICAgdGhpcy5wb3B1cENvbXBvbmVudHMuc3BsaWNlKHgsIDEpO1xuICAgICAgICB0aGlzLmd1aWRMaXN0LnNwbGljZSh4LCAxKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgfVxuICAgIC8vIG9ubHkgYWxsb3cgMSBhdHRhY2htZW50XG4gICAgdGhpcy5wb3B1cEhhc0F0dGFjaG1lbnQgPSB0aGlzLnBvcHVwVGVtcGxhdGUuY29udGVudC5zb21lKChjb250ZW50KSA9PiB7XG4gICAgICBpZiAoY29udGVudC50eXBlID09PSBcImF0dGFjaG1lbnRzXCIpIHtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICB9XG4gICAgfSk7XG4gICAgaWYgKHRoaXMucmljaFRleHRFbGVtZW50cykge1xuICAgICAgLy8gUmVtb3ZlIHRoZSByZWZlcmVuY2UgdG8gdGhlIHJpY2ggdGV4dCBlZGl0b3IgaWYgdGhlIHJpY2ggdGV4dCBlZGl0b3IgaXMgYmVpbmcgZGVzdHJveWVkXG4gICAgICBjb25zdCBuZXdFbGVtZW50cyA9IHRoaXMucmljaFRleHRFbGVtZW50cy5maWx0ZXIoKHJlZikgPT4gcmVmLmlkICE9PSBldmVudC5kZXRhaWwpO1xuICAgICAgdGhpcy5yaWNoVGV4dEVsZW1lbnRzID0gbmV3RWxlbWVudHM7XG4gICAgfVxuICAgIHRoaXMubWFpblBvcHVwUmVSZW5kZXIuZW1pdCgpO1xuICAgIHRoaXMuY2FsY2l0ZUZhYi5zZXRGb2N1cygpO1xuICB9XG4gIGR1cGxpY2F0ZUNvbXBvbmVudEhhbmRsZXIoZXZlbnQpIHtcbiAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICB0aGlzLmNsb3NlUG9wdXBQb3BvdmVycy5lbWl0KCk7XG4gICAgLy8gZWFjaCBkaXYgaGFzIGlkLiBGaW5kIGlkLCBhbmQgY2xvbmVcbiAgICBjb25zdCBhbGxDb21wb25lbnRzID0gdGhpcy5zb3J0YWJsZUNvbXBvbmVudHMuZ2V0RWxlbWVudHNCeVRhZ05hbWUoXCJkaXZcIik7XG4gICAgZm9yIChsZXQgeCA9IDA7IHggPCBhbGxDb21wb25lbnRzLmxlbmd0aDsgeCsrKSB7XG4gICAgICBpZiAoYWxsQ29tcG9uZW50c1t4XS5pZCA9PT0gZXZlbnQuZGV0YWlsKSB7XG4gICAgICAgIGNvbnN0IHRlbXBDb250ZW50ID0gdGhpcy5wb3B1cFRlbXBsYXRlLmNvbnRlbnRbeF0uY2xvbmUoKTtcbiAgICAgICAgdGhpcy5wb3B1cFRlbXBsYXRlLmNvbnRlbnQucHVzaCh0ZW1wQ29udGVudCk7XG4gICAgICAgIHRoaXMuYWRkVG9Qb3B1cENvbXBvbmVudHModGVtcENvbnRlbnQsIHRydWUpO1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICB9XG4gIH1cbiAgY2xvc2VQb3B1cFBvcG92ZXJzSGFuZGxlcigpIHtcbiAgICBpZiAodGhpcy5jb250ZW50UG9wb3Zlcikge1xuICAgICAgZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZCh0aGlzLmNvbnRlbnRQb3BvdmVyKTtcbiAgICAgIHRoaXMuY29udGVudFBvcG92ZXIgPSBudWxsO1xuICAgICAgdGhpcy5jYWxjaXRlRmFiLmRpc2FibGVkID0gZmFsc2U7XG4gICAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKCkgPT4gdGhpcy5jYWxjaXRlRmFiLnNldEZvY3VzKCkpO1xuICAgICAgdGhpcy5kaXNhYmxlUG9wdXBQYW5lbC5lbWl0KGZhbHNlKTtcbiAgICB9XG4gIH1cbiAgbm90aWZ5QWRkQ29udGVudFNlbGVjdGlvbkhhbmRsZXIoZXZlbnQpIHtcbiAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICB0aGlzLmNsb3NlUG9wdXBQb3BvdmVycy5lbWl0KCk7XG4gICAgLy8gZWRpdG9yIHRyYWNraW5nXG4gICAgaWYgKGV2ZW50LmRldGFpbCA9PT0gQ29udGVudFNlbGVjdGlvbi5zdW1tYXJ5RVQpIHtcbiAgICAgIHRoaXMucG9wdXBUZW1wbGF0ZS5sYXN0RWRpdEluZm9FbmFibGVkID0gdHJ1ZTtcbiAgICAgIHRoaXMubWFpblBvcHVwUmVSZW5kZXIuZW1pdCgpO1xuICAgICAgdGhpcy5zdW1tYXJ5RVREaXYuc2Nyb2xsSW50b1ZpZXcoeyBiZWhhdmlvcjogXCJzbW9vdGhcIiwgYmxvY2s6IFwibmVhcmVzdFwiLCBpbmxpbmU6IFwic3RhcnRcIiB9KTtcbiAgICAgIHRoaXMuY2FsY2l0ZUZhYi5zZXRGb2N1cygpO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgIHRoaXMuYWRkUG9wdXBDb250ZW50cyhldmVudC5kZXRhaWwpO1xuICAgIH1cbiAgfVxuICBkaXNhYmxlUG9wdXBQYW5lbEhhbmRsZXIoZXZlbnQpIHtcbiAgICB2YXIgX2E7XG4gICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgY29uc3QgcGFuZWwgPSAoKF9hID0gdGhpcy5jYWxjaXRlRmxvd1Byb3BzKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EuY2FsY2l0ZUZsb3dJdGVtKSB8fCB0aGlzLnBvcHVwUGFuZWw7XG4gICAgcGFuZWwuZGlzYWJsZWQgPSBldmVudC5kZXRhaWw7XG4gIH1cbiAgLy91cGRhdGVzIHRvIGF0dHJpYnV0ZXNcbiAgYXN5bmMgYXR0cmlidXRlc1VwZGF0ZWRIYW5kbGVyKGV2ZW50KSB7XG4gICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgdGhpcy5wb3B1cFRlbXBsYXRlLmZpZWxkSW5mb3MgPSBbXG4gICAgICAuLi4oYXdhaXQgZ2VuZXJhdGVNYXN0ZXJGaWVsZEluZm8odGhpcy5sYXllciwgdGhpcy5sYXllci5wb3B1cFRlbXBsYXRlIHx8IHRoaXMucG9wdXBUZW1wbGF0ZSkpXG4gICAgXTtcbiAgICBpZiAodGhpcy5sYXllci5wb3B1cFRlbXBsYXRlLmV4cHJlc3Npb25JbmZvcykge1xuICAgICAgdGhpcy5wb3B1cFRlbXBsYXRlLmV4cHJlc3Npb25JbmZvcyA9IFtcbiAgICAgICAgLi4udGhpcy5sYXllci5wb3B1cFRlbXBsYXRlLmV4cHJlc3Npb25JbmZvc1xuICAgICAgXTtcbiAgICAgIHRoaXMuYXJjYWRlQ2hhbmdlTm90aWZpY2F0aW9uLmVtaXQoKTtcbiAgICB9XG4gICAgdGhpcy5hdHRyaWJ1dGVzQ2hhbmdlTm90aWZpY2F0aW9uLmVtaXQoKTtcbiAgICB0aGlzLm1haW5Qb3B1cFJlUmVuZGVyLmVtaXQoKTtcbiAgfVxuICAvLyBmb3IgYXJjYWRlIGNoYW5nZXNcbiAgYXJjYWRlQ2hhbmdlTm90aWZpY2F0aW9uSGFuZGxlcigpIHtcbiAgICB2YXIgX2E7XG4gICAgLy8gaWYgYW4gYXJjYWRlIGV4cHJlc3Npb24gaXMgYWRkZWQvcmVtb3ZlZCwgdXBkYXRlIHRoZSBzZWxlY3Rpb24gb2YgZXhwcmVzc2lvbnMgaW4gdGhlIHJpY2hcbiAgICAvLyB0ZXh0IGVkaXRvcidzIGNvbG9yIHBpY2tlciBwbHVnaW5cbiAgICBpZiAodGhpcy5yaWNoVGV4dEVsZW1lbnRzKSB7XG4gICAgICBjb25zdCBuZXdFeHByZXNzaW9uRGF0YSA9IChfYSA9IHRoaXMucG9wdXBUZW1wbGF0ZSkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLnRvSlNPTigpLmV4cHJlc3Npb25JbmZvcy5tYXAoKHsgZXhwcmVzc2lvbiwgbmFtZSwgcmV0dXJuVHlwZSwgdGl0bGUgfSkgPT4ge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIG5hbWU6IGBleHByZXNzaW9uLyR7bmFtZX1gLFxuICAgICAgICAgIGFsaWFzOiB0aXRsZSA9PT0gXCJOZXcgZXhwcmVzc2lvblwiID8gXCIgXCIgOiB0aXRsZSxcbiAgICAgICAgICB0eXBlOiByZXR1cm5UeXBlLFxuICAgICAgICAgIGRlc2NyaXB0aW9uOiBleHByZXNzaW9uXG4gICAgICAgIH07XG4gICAgICB9KTtcbiAgICAgIHRoaXMuYXR0cmlidXRlRGF0YSA9IG5ld0V4cHJlc3Npb25EYXRhXG4gICAgICAgID8gWy4uLm5ld0V4cHJlc3Npb25EYXRhLCAuLi50aGlzLmZpZWxkRGF0YV1cbiAgICAgICAgOiB0aGlzLmZpZWxkRGF0YTtcbiAgICAgIC8vIHVwZGF0aW5nIHRoZSBzdGF0ZSBoZXJlIG1hbnVhbGx5IGhlcmUgc2luY2UgdGhlIHJpY2ggdGV4dCBlZGl0b3Igd2lsbCBub3QgbGlzdGVuIGZvciBjaGFuZ2VzIGluIHN0YXRlXG4gICAgICAvLyBpbiBpbml0aWFsaXphdGlvbiAtIHdlIGRvIG5vdCBuZWVkIHRvIGtlZXAgbGlzdCBvZiBleHByZXNzaW9ucyBpbiBhIHN0YXRlIGRlY29yYXRvciBlaXRoZXJcbiAgICAgIHRoaXMucmljaFRleHRFbGVtZW50cy5mb3JFYWNoKChlbCkgPT4ge1xuICAgICAgICBjb25zdCByaWNoVGV4dEVsZW1lbnQgPSBlbC5maXJzdENoaWxkO1xuICAgICAgICByaWNoVGV4dEVsZW1lbnQuYXJjZ2lzQ29sb3JQaWNrZXJEYXRhLmRhdGEgPSB0aGlzLmF0dHJpYnV0ZURhdGE7XG4gICAgICAgIHJpY2hUZXh0RWxlbWVudC5maWVsZEV4cHJlc3Npb25EYXRhLmRhdGEgPSB0aGlzLmF0dHJpYnV0ZURhdGE7XG4gICAgICB9KTtcbiAgICB9XG4gICAgdGhpcy5tYWluUG9wdXBSZVJlbmRlci5lbWl0KCk7XG4gIH1cbiAgLy8gcHJpdmF0ZSBtZXRob2RzIGFuZCBwcm9wZXJ0aWVzXG4gIGFzeW5jIGxvYWRBbGxNb2R1bGVzKCkge1xuICAgIFt0aGlzLkxheWVyT3B0aW9ucywgdGhpcy5yZWFjdGl2ZVV0aWxzXSA9IGF3YWl0IGxvYWRNb2R1bGVzKFtcbiAgICAgIFwiZXNyaS9wb3B1cC9MYXllck9wdGlvbnNcIixcbiAgICAgIFwiZXNyaS9jb3JlL3JlYWN0aXZlVXRpbHNcIlxuICAgIF0pO1xuICB9XG4gIHdhdGNoRm9yQ2hhbmdlc1RvTGF5ZXJzTGlzdCgpIHtcbiAgICB2YXIgX2EsIF9iO1xuICAgIGlmICh0aGlzLmxheWVyRGlzcGxheVR5cGUgPT09IGxheWVyRGlzcGxheVR5cGVFbnVtLmZlYXR1cmUgJiZcbiAgICAgIHRoaXMuc2VydmljZVR5cGUgPT09IHNlcnZpY2VUeXBlRW51bS5mZWF0dXJlICYmXG4gICAgICAoKF9iID0gKF9hID0gdGhpcy5sYXllcikgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLnJlbGF0aW9uc2hpcHMpID09PSBudWxsIHx8IF9iID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYi5sZW5ndGgpKSB7XG4gICAgICB0aGlzLndhdGNoTGF5ZXJzQW5kVGFibGVzID0gdGhpcy5yZWFjdGl2ZVV0aWxzLndhdGNoKCgpID0+IFt0aGlzLm1hcFZpZXcubWFwLmFsbExheWVycy5sZW5ndGgsIHRoaXMubWFwVmlldy5tYXAuYWxsVGFibGVzLmxlbmd0aF0sIGFzeW5jICgpID0+IHtcbiAgICAgICAgcG9wdXBTdGF0ZS5sYXllckhhc1JlbGF0ZWRSZWNvcmRzID0gYXdhaXQgbGF5ZXJIYXNSZWxhdGVkUmVjb3Jkcyh0aGlzLmxheWVyLCB0aGlzLm1hcFZpZXcsIHRoaXMuc2VydmljZVR5cGUpO1xuICAgICAgfSk7XG4gICAgfVxuICB9XG4gIGVuYWJsZURpc2FibGVQb3B1cChwb3B1cEJvb2wpIHtcbiAgICAvLyBoaWRlIHJlc3Qgb2YgdGhlIGNvbXBvbmVudC5cbiAgICBpZiAodGhpcy5zZXJ2aWNlVHlwZSAhPT0gc2VydmljZVR5cGVFbnVtLndtcykge1xuICAgICAgY29uc3QgcG9wdXBEaXYgPSB0aGlzLmhvc3RFbGVtZW50LnNoYWRvd1Jvb3QuZ2V0RWxlbWVudEJ5SWQoXCJwb3B1cERpdl9JZFwiKTtcbiAgICAgIHBvcHVwRGl2LnN0eWxlLmRpc3BsYXkgPSBwb3B1cEJvb2wgPyBcImJsb2NrXCIgOiBcIm5vbmVcIjtcbiAgICAgIHRoaXMuY2FsY2l0ZUZhYi5zdHlsZS5kaXNwbGF5ID0gcG9wdXBCb29sID8gXCJibG9ja1wiIDogXCJub25lXCI7XG4gICAgfVxuICAgIHRoaXMuY2xvc2VQb3B1cFBvcG92ZXJzLmVtaXQoKTtcbiAgfVxuICBnZXRQb3B1cEVuYWJsZWRQcm9wKCkge1xuICAgIHN3aXRjaCAodGhpcy5sYXllckRpc3BsYXlUeXBlKSB7XG4gICAgICBjYXNlIGxheWVyRGlzcGxheVR5cGVFbnVtLmZlYXR1cmU6IHtcbiAgICAgICAgaWYgKHRoaXMuc2VydmljZVR5cGUgPT09IHNlcnZpY2VUeXBlRW51bS53bXMpIHtcbiAgICAgICAgICByZXR1cm4gdGhpcy5sYXllci5wb3B1cEVuYWJsZWQ7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgcmV0dXJuIHRoaXMubGF5ZXIucG9wdXBUZW1wbGF0ZVxuICAgICAgICAgICAgPyB0aGlzLmxheWVyLnBvcHVwRW5hYmxlZFxuICAgICAgICAgICAgOiBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgY2FzZSBsYXllckRpc3BsYXlUeXBlRW51bS5jbHVzdGVyOiB7XG4gICAgICAgIHJldHVybiB0aGlzLmxheWVyLmZlYXR1cmVSZWR1Y3Rpb24ucG9wdXBFbmFibGVkO1xuICAgICAgfVxuICAgICAgY2FzZSBsYXllckRpc3BsYXlUeXBlRW51bS5tYXBOb3Rlczoge1xuICAgICAgICByZXR1cm4gdGhpcy5tYXBOb3Rlc1BvcHVwRW5hYmxlZDtcbiAgICAgIH1cbiAgICAgIGRlZmF1bHQ6IHtcbiAgICAgICAgcmV0dXJuIHRoaXMubGF5ZXIucG9wdXBFbmFibGVkO1xuICAgICAgfVxuICAgIH1cbiAgfVxuICByZW9yZGVyKGFyciwgb2xkSWR4cywgbmV3SWR4cykge1xuICAgIGNvbnN0IG9sZEFyciA9IFsuLi5hcnJdO1xuICAgIGFyci5sZW5ndGggPSAwO1xuICAgIG9sZEFyci5mb3JFYWNoKChpdGVtLCBpZHgpID0+IHtcbiAgICAgIGxldCBuZXdJZHg7XG4gICAgICBuZXdJZHhzLmZvckVhY2goKGd1aWQsIGlkeDIpID0+IHtcbiAgICAgICAgaWYgKG9sZElkeHNbaWR4XSA9PT0gZ3VpZCkge1xuICAgICAgICAgIG5ld0lkeCA9IGlkeDI7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgICAgYXJyW25ld0lkeF0gPSBpdGVtO1xuICAgIH0pO1xuICB9XG4gIGFkZFRvUG9wdXBDb21wb25lbnRzKGNvbnRlbnQsIGJsb2NrT3BlbiA9IGZhbHNlKSB7XG4gICAgY29uc3QgbmV3R3VpZCA9IGd1aWQoKTtcbiAgICBpZiAoY29udGVudC50eXBlID09PSBcImZpZWxkc1wiKSB7XG4gICAgICB0aGlzLnBvcHVwQ29tcG9uZW50cyA9IFtcbiAgICAgICAgLi4udGhpcy5wb3B1cENvbXBvbmVudHMsXG4gICAgICAgIHRoaXMuZmllbGRDb21wb25lbnQobmV3R3VpZCwgY29udGVudCwgYmxvY2tPcGVuKVxuICAgICAgXTtcbiAgICAgIHRoaXMuZ3VpZExpc3QgPSBbLi4udGhpcy5ndWlkTGlzdCwgbmV3R3VpZF07XG4gICAgfVxuICAgIGVsc2UgaWYgKGNvbnRlbnQudHlwZSA9PT0gXCJhdHRhY2htZW50c1wiKSB7XG4gICAgICB0aGlzLnBvcHVwQ29tcG9uZW50cyA9IFtcbiAgICAgICAgLi4udGhpcy5wb3B1cENvbXBvbmVudHMsXG4gICAgICAgIHRoaXMuYXR0YWNobWVudENvbXBvbmVudChuZXdHdWlkLCBjb250ZW50LCBibG9ja09wZW4pXG4gICAgICBdO1xuICAgICAgdGhpcy5wb3B1cEhhc0F0dGFjaG1lbnQgPSB0cnVlO1xuICAgICAgdGhpcy5ndWlkTGlzdCA9IFsuLi50aGlzLmd1aWRMaXN0LCBuZXdHdWlkXTtcbiAgICB9XG4gICAgZWxzZSBpZiAoY29udGVudC50eXBlID09PSBcIm1lZGlhXCIpIHtcbiAgICAgIHRoaXMucG9wdXBDb21wb25lbnRzID0gW1xuICAgICAgICAuLi50aGlzLnBvcHVwQ29tcG9uZW50cyxcbiAgICAgICAgdGhpcy5tdWx0aW1lZGlhQ29tcG9uZW50KG5ld0d1aWQsIGNvbnRlbnQsIGJsb2NrT3BlbilcbiAgICAgIF07XG4gICAgICB0aGlzLmd1aWRMaXN0ID0gWy4uLnRoaXMuZ3VpZExpc3QsIG5ld0d1aWRdO1xuICAgIH1cbiAgICBlbHNlIGlmIChjb250ZW50LnR5cGUgPT09IFwidGV4dFwiKSB7XG4gICAgICB0aGlzLnBvcHVwQ29tcG9uZW50cyA9IFtcbiAgICAgICAgLi4udGhpcy5wb3B1cENvbXBvbmVudHMsXG4gICAgICAgIHRoaXMucmljaHRleHRDb21wb25lbnQobmV3R3VpZCwgY29udGVudCwgYmxvY2tPcGVuKVxuICAgICAgXTtcbiAgICAgIHRoaXMuZ3VpZExpc3QgPSBbLi4udGhpcy5ndWlkTGlzdCwgbmV3R3VpZF07XG4gICAgfVxuICAgIGVsc2UgaWYgKGNvbnRlbnQudHlwZSA9PT0gXCJleHByZXNzaW9uXCIpIHtcbiAgICAgIHRoaXMucG9wdXBDb21wb25lbnRzID0gW1xuICAgICAgICAuLi50aGlzLnBvcHVwQ29tcG9uZW50cyxcbiAgICAgICAgdGhpcy5hcmNhZGVDb21wb25lbnQobmV3R3VpZCwgY29udGVudCwgYmxvY2tPcGVuKVxuICAgICAgXTtcbiAgICAgIHRoaXMuZ3VpZExpc3QgPSBbLi4udGhpcy5ndWlkTGlzdCwgbmV3R3VpZF07XG4gICAgfVxuICAgIGVsc2UgaWYgKGNvbnRlbnQudHlwZSA9PT0gXCJyZWxhdGlvbnNoaXBcIikge1xuICAgICAgdGhpcy5wb3B1cENvbXBvbmVudHMgPSBbXG4gICAgICAgIC4uLnRoaXMucG9wdXBDb21wb25lbnRzLFxuICAgICAgICB0aGlzLnJlbGF0aW9uc2hpcENvbXBvbmVudChuZXdHdWlkLCBjb250ZW50LCBibG9ja09wZW4pXG4gICAgICBdO1xuICAgICAgdGhpcy5ndWlkTGlzdCA9IFsuLi50aGlzLmd1aWRMaXN0LCBuZXdHdWlkXTtcbiAgICB9XG4gIH1cbiAgYXN5bmMgYWRkUG9wdXBDb250ZW50cyhwb3B1cENvbnRlbnRUeXBlKSB7XG4gICAgY29uc3QgW0ZpZWxkc0NvbnRlbnQsIEF0dGFjaG1lbnRzQ29udGVudCwgVGV4dENvbnRlbnQsIE1lZGlhQ29udGVudCwgSW1hZ2VNZWRpYUluZm8sIENvbHVtbkNoYXJ0TWVkaWFJbmZvLCBJbWFnZU1lZGlhSW5mb1ZhbHVlLCBDaGFydE1lZGlhSW5mb1ZhbHVlLCBFeHByZXNzaW9uQ29udGVudCwgUmVsYXRpb25zaGlwQ29udGVudF0gPSBhd2FpdCBsb2FkTW9kdWxlcyhbXG4gICAgICBcImVzcmkvcG9wdXAvY29udGVudC9GaWVsZHNDb250ZW50XCIsXG4gICAgICBcImVzcmkvcG9wdXAvY29udGVudC9BdHRhY2htZW50c0NvbnRlbnRcIixcbiAgICAgIFwiZXNyaS9wb3B1cC9jb250ZW50L1RleHRDb250ZW50XCIsXG4gICAgICBcImVzcmkvcG9wdXAvY29udGVudC9NZWRpYUNvbnRlbnRcIixcbiAgICAgIFwiZXNyaS9wb3B1cC9jb250ZW50L0ltYWdlTWVkaWFJbmZvXCIsXG4gICAgICBcImVzcmkvcG9wdXAvY29udGVudC9Db2x1bW5DaGFydE1lZGlhSW5mb1wiLFxuICAgICAgXCJlc3JpL3BvcHVwL2NvbnRlbnQvc3VwcG9ydC9JbWFnZU1lZGlhSW5mb1ZhbHVlXCIsXG4gICAgICBcImVzcmkvcG9wdXAvY29udGVudC9zdXBwb3J0L0NoYXJ0TWVkaWFJbmZvVmFsdWVcIixcbiAgICAgIFwiZXNyaS9wb3B1cC9jb250ZW50L0V4cHJlc3Npb25Db250ZW50XCIsXG4gICAgICBcImVzcmkvcG9wdXAvY29udGVudC9SZWxhdGlvbnNoaXBDb250ZW50XCJcbiAgICBdKTtcbiAgICBsZXQgY29udGVudCA9IG51bGw7XG4gICAgaWYgKHBvcHVwQ29udGVudFR5cGUgPT09IENvbnRlbnRTZWxlY3Rpb24uYXR0cmlidXRlcykge1xuICAgICAgY29udGVudCA9IG5ldyBGaWVsZHNDb250ZW50KHtcbiAgICAgICAgZmllbGRJbmZvczogbnVsbFxuICAgICAgfSk7XG4gICAgfVxuICAgIGVsc2UgaWYgKHBvcHVwQ29udGVudFR5cGUgPT09IENvbnRlbnRTZWxlY3Rpb24uYXR0YWNobWVudHMpIHtcbiAgICAgIGNvbnRlbnQgPSBuZXcgQXR0YWNobWVudHNDb250ZW50KHtcbiAgICAgICAgZGlzcGxheVR5cGU6IG51bGxcbiAgICAgIH0pO1xuICAgIH1cbiAgICBlbHNlIGlmIChwb3B1cENvbnRlbnRUeXBlID09PSBDb250ZW50U2VsZWN0aW9uLnJpY2hUZXh0KSB7XG4gICAgICBjb250ZW50ID0gbmV3IFRleHRDb250ZW50KHtcbiAgICAgICAgdGV4dDogbnVsbFxuICAgICAgfSk7XG4gICAgfVxuICAgIGVsc2UgaWYgKHBvcHVwQ29udGVudFR5cGUgPT09IENvbnRlbnRTZWxlY3Rpb24uaW1hZ2VzKSB7XG4gICAgICBjb25zdCBpbWFnZUVsZW1lbnQgPSBuZXcgSW1hZ2VNZWRpYUluZm8oe1xuICAgICAgICB0aXRsZTogXCJcIixcbiAgICAgICAgY2FwdGlvbjogXCJcIixcbiAgICAgICAgYWx0VGV4dDogXCJcIixcbiAgICAgICAgdmFsdWU6IG5ldyBJbWFnZU1lZGlhSW5mb1ZhbHVlKHtcbiAgICAgICAgICBzb3VyY2VVUkw6IFwiXCIsXG4gICAgICAgICAgbGlua1VSTDogXCJcIlxuICAgICAgICB9KVxuICAgICAgfSk7XG4gICAgICBjb250ZW50ID0gbmV3IE1lZGlhQ29udGVudCh7XG4gICAgICAgIG1lZGlhSW5mb3M6IFtpbWFnZUVsZW1lbnRdXG4gICAgICB9KTtcbiAgICB9XG4gICAgZWxzZSBpZiAocG9wdXBDb250ZW50VHlwZSA9PT0gQ29udGVudFNlbGVjdGlvbi5jaGFydHMpIHtcbiAgICAgIGNvbnN0IGNoYXJ0RWxlbWVudCA9IG5ldyBDb2x1bW5DaGFydE1lZGlhSW5mbyh7XG4gICAgICAgIHRpdGxlOiBcIlwiLFxuICAgICAgICBjYXB0aW9uOiBcIlwiLFxuICAgICAgICBhbHRUZXh0OiBcIlwiLFxuICAgICAgICB2YWx1ZTogbmV3IENoYXJ0TWVkaWFJbmZvVmFsdWUoe1xuICAgICAgICAgIGZpZWxkczogW11cbiAgICAgICAgfSlcbiAgICAgIH0pO1xuICAgICAgY29udGVudCA9IG5ldyBNZWRpYUNvbnRlbnQoe1xuICAgICAgICBtZWRpYUluZm9zOiBbY2hhcnRFbGVtZW50XVxuICAgICAgfSk7XG4gICAgfVxuICAgIGVsc2UgaWYgKHBvcHVwQ29udGVudFR5cGUgPT09IENvbnRlbnRTZWxlY3Rpb24uYXJjYWRlKSB7XG4gICAgICBjb250ZW50ID0gbmV3IEV4cHJlc3Npb25Db250ZW50KHtcbiAgICAgICAgZXhwcmVzc2lvbkluZm86IHtcbiAgICAgICAgICBleHByZXNzaW9uOiBkZWZhdWx0Q29udGVudE1lc3NhZ2UodGhpcy5sYXllckRpc3BsYXlUeXBlLCB0aGlzLnN0cmluZ3MpXG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cbiAgICBlbHNlIGlmIChwb3B1cENvbnRlbnRUeXBlID09PSBDb250ZW50U2VsZWN0aW9uLnJlbGF0aW9uc2hpcCkge1xuICAgICAgY29uc3QgcmVsYXRpb25zaGlwQW5kTGF5ZXIgPSBhd2FpdCBnZXREZWZhdWx0UmVsYXRpb25zaGlwQW5kTGF5ZXIodGhpcy5sYXllciwgdGhpcy5tYXBWaWV3LCB0aGlzLnNlcnZpY2VUeXBlKTtcbiAgICAgIGxldCBkZWZhdWx0RmllbGQgPSByZWxhdGlvbnNoaXBBbmRMYXllci5jdXJyTGF5ZXIuZmllbGRzLmZpbmQoKGZpZWxkKSA9PiBmaWVsZC52aXNpYmxlICYmIGZpZWxkLnR5cGUgPT09IFwiZGF0ZVwiKTtcbiAgICAgIGlmICghZGVmYXVsdEZpZWxkKSB7XG4gICAgICAgIGRlZmF1bHRGaWVsZCA9IHJlbGF0aW9uc2hpcEFuZExheWVyLmN1cnJMYXllci5maWVsZHMuZmluZCgoZmllbGQpID0+IGZpZWxkLnZpc2libGUpO1xuICAgICAgfVxuICAgICAgY29udGVudCA9IG5ldyBSZWxhdGlvbnNoaXBDb250ZW50KHtcbiAgICAgICAgZGlzcGxheUNvdW50OiB0aGlzLnJlbGF0ZWRSZWNvcmRzRGVmYXVsdENvdW50LFxuICAgICAgICByZWxhdGlvbnNoaXBJZDogcmVsYXRpb25zaGlwQW5kTGF5ZXIucmVsYXRpb25zaGlwLmlkLFxuICAgICAgICBvcmRlckJ5RmllbGRzOiBbeyBmaWVsZDogZGVmYXVsdEZpZWxkLm5hbWUsIG9yZGVyOiBcImFzY1wiIH1dXG4gICAgICB9KTtcbiAgICB9XG4gICAgdGhpcy5wb3B1cFRlbXBsYXRlLmNvbnRlbnQucHVzaChjb250ZW50KTtcbiAgICB0aGlzLmFkZFRvUG9wdXBDb21wb25lbnRzKGNvbnRlbnQsIHRydWUpO1xuICB9XG4gIGFzeW5jIHNob3dQcmV2aWV3UG9wdXAoc2hvdykge1xuICAgIHZhciBfYSwgX2IsIF9jO1xuICAgIGlmICh0aGlzLmRpc3BsYXlQb3B1cCAmJlxuICAgICAgdGhpcy5sYXllckRpc3BsYXlUeXBlID09PSBsYXllckRpc3BsYXlUeXBlRW51bS5mZWF0dXJlICYmXG4gICAgICAhdGhpcy5pc1BvcHVwT3BlbkZvckN1cnJlbnRMYXllcikge1xuICAgICAgaWYgKHNob3cgJiZcbiAgICAgICAgdGhpcy5sYXllci5wb3B1cEVuYWJsZWQgJiZcbiAgICAgICAgdGhpcy5sYXllci5wb3B1cFRlbXBsYXRlKSB7XG4gICAgICAgIGlmICgoX2IgPSAoX2EgPSB0aGlzLm1hcFZpZXcucG9wdXApID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5mZWF0dXJlcykgPT09IG51bGwgfHwgX2IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9iLmxlbmd0aCkge1xuICAgICAgICAgIC8vIGlmIHdlIGhhdmUgYSBwb3B1cCwgbWF5YmUgZnJvbSBhbm90aGVyIGxheWVyXG4gICAgICAgICAgLy8gbWFrZSBzdXJlIHdlIGRvbid0IHN0YXkgaW4gYSBkcmlsbC1pbiBzdGF0ZVxuICAgICAgICAgIC8vIHBvcHVwIG1pZ2h0IG5vdCBiZSB2aXNpYmxlIGF0IHRoaXMgbW9tZW50XG4gICAgICAgICAgdGhpcy5tYXBWaWV3LmNsb3NlUG9wdXAoKTtcbiAgICAgICAgICB0aGlzLm1hcFZpZXcucG9wdXAuZmVhdHVyZXMgPSB1bmRlZmluZWQ7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5wcmV2aWV3UG9wdXBDb250cm9sbGVyID0gbmV3IEFib3J0Q29udHJvbGxlcigpO1xuICAgICAgICB0aGlzLnNpbmdsZUZlYXR1cmUgPSBhd2FpdCBwcmV2aWV3UG9wdXAodGhpcy5tYXBWaWV3LCB0aGlzLmxheWVyLCB0aGlzLnByZXZpZXdQb3B1cENvbnRyb2xsZXIpO1xuICAgICAgfVxuICAgICAgZWxzZSB7XG4gICAgICAgIChfYyA9IHRoaXMucHJldmlld1BvcHVwQ29udHJvbGxlcikgPT09IG51bGwgfHwgX2MgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9jLmFib3J0KCk7XG4gICAgICAgIHRoaXMubWFwVmlldy5jbG9zZVBvcHVwKCk7XG4gICAgICB9XG4gICAgfVxuICAgIGVsc2UgaWYgKHRoaXMubGF5ZXJEaXNwbGF5VHlwZSA9PT0gbGF5ZXJEaXNwbGF5VHlwZUVudW0ubWFwTm90ZXMpIHtcbiAgICAgIGlmIChzaG93KSB7XG4gICAgICAgIHRoaXMubWFwVmlldy5vcGVuUG9wdXAoe1xuICAgICAgICAgIGZlYXR1cmVzOiBbdGhpcy5tYXBOb3Rlc0dyYXBoaWNdLFxuICAgICAgICAgIGxvY2F0aW9uOiBnZXRQb2ludEZyb21HZW9tZXRyeSh0aGlzLm1hcE5vdGVzR3JhcGhpYy5nZW9tZXRyeSlcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgICBlbHNlIHtcbiAgICAgICAgdGhpcy5tYXBWaWV3LmNsb3NlUG9wdXAoKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbiAgLy8gaWYgcGFyZW50IGlzIHNoZWxsIHBhbmVsLiBNViB3b3JrZmxvdy5cbiAgc2V0dXBSZXNpemVPYnNlcnZlcigpIHtcbiAgICB2YXIgX2E7XG4gICAgY29uc3QgcGFyZW50Tm9kZSA9IChfYSA9IHRoaXMuaG9zdEVsZW1lbnQpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5wYXJlbnRFbGVtZW50O1xuICAgIGlmICgocGFyZW50Tm9kZSA9PT0gbnVsbCB8fCBwYXJlbnROb2RlID09PSB2b2lkIDAgPyB2b2lkIDAgOiBwYXJlbnROb2RlLnRhZ05hbWUpID09PSBcIkNBTENJVEUtU0hFTEwtUEFORUxcIikge1xuICAgICAgY29uc3Qgc2hlbGxQYW5lbE5vZGUgPSBwYXJlbnROb2RlO1xuICAgICAgaWYgKGlzRGVmaW5lZChzaGVsbFBhbmVsTm9kZS5jb2xsYXBzZWQpKSB7XG4gICAgICAgIHRoaXMucGFyZW50U2hlbGxPYnNlcnZlciA9IG5ldyBSZXNpemVPYnNlcnZlcigoKSA9PiB7XG4gICAgICAgICAgaWYgKHNoZWxsUGFuZWxOb2RlLmNvbGxhcHNlZCkge1xuICAgICAgICAgICAgdGhpcy5kb25lKCk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5zaG93UHJldmlld1BvcHVwKHRydWUpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMucGFyZW50U2hlbGxPYnNlcnZlci5vYnNlcnZlKHNoZWxsUGFuZWxOb2RlKTtcbiAgICAgIH1cbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICB0aGlzLnNob3dQcmV2aWV3UG9wdXAodHJ1ZSk7XG4gICAgfVxuICB9XG4gIGNyZWF0ZUxheWVyT3B0aW9ucygpIHtcbiAgICB2YXIgX2EsIF9iO1xuICAgIGNvbnN0IGxheWVyT3B0aW9ucyA9IHRoaXMucG9wdXBUZW1wbGF0ZS5sYXllck9wdGlvbnMgfHwgbmV3IHRoaXMuTGF5ZXJPcHRpb25zKCk7XG4gICAgLy8gc2hvd05vRGF0YVJlY29yZHMgYW5kIHJldHVyblRvcG1vc3RSYXN0ZXIgY2FuIGJlIG51bGwgd2hlbiBub3Qgc2V0XG4gICAgbGF5ZXJPcHRpb25zLnNob3dOb0RhdGFSZWNvcmRzID0gKF9hID0gbGF5ZXJPcHRpb25zLnNob3dOb0RhdGFSZWNvcmRzKSAhPT0gbnVsbCAmJiBfYSAhPT0gdm9pZCAwID8gX2EgOiBmYWxzZTtcbiAgICBsYXllck9wdGlvbnMucmV0dXJuVG9wbW9zdFJhc3RlciA9IChfYiA9IGxheWVyT3B0aW9ucy5yZXR1cm5Ub3Btb3N0UmFzdGVyKSAhPT0gbnVsbCAmJiBfYiAhPT0gdm9pZCAwID8gX2IgOiB0cnVlO1xuICAgIHRoaXMucG9wdXBUZW1wbGF0ZS5sYXllck9wdGlvbnMgPSBsYXllck9wdGlvbnM7XG4gIH1cbiAgcmVuZGVyKCkge1xuICAgIHZhciBfYSwgX2IsIF9jLCBfZCwgX2UsIF9mO1xuICAgIGlmICh0aGlzLmhhc0Vycm9yKSB7XG4gICAgICByZXR1cm4gdGhpcy5yZW5kZXJQb3B1cEVycm9yKCk7XG4gICAgfVxuICAgIGNvbnN0IGVuYWJsZVBvcHVwID0gKGgoXCJjYWxjaXRlLWxhYmVsXCIsIHsgY2xhc3M6IENTUyQ2LmVuYWJsZVBvcHVwLCBhbGlnbm1lbnQ6IFwic3RhcnRcIiwgbGF5b3V0OiBcImlubGluZS1zcGFjZS1iZXR3ZWVuXCIgfSwgdGhpcy5zdHJpbmdzLmVuYWJsZVBvcHVwLCBoKFwiY2FsY2l0ZS1zd2l0Y2hcIiwgeyBzY2FsZTogXCJzXCIsIGNoZWNrZWQ6IHRoaXMuZ2V0UG9wdXBFbmFibGVkUHJvcCgpLCBvbkNhbGNpdGVTd2l0Y2hDaGFuZ2U6IChldmVudCkgPT4ge1xuICAgICAgICBjb25zdCBjaGVja2VkID0gZXZlbnQudGFyZ2V0LmNoZWNrZWQ7XG4gICAgICAgIHN3aXRjaCAodGhpcy5sYXllckRpc3BsYXlUeXBlKSB7XG4gICAgICAgICAgY2FzZSBsYXllckRpc3BsYXlUeXBlRW51bS5mZWF0dXJlOiB7XG4gICAgICAgICAgICB0aGlzLmxheWVyLnBvcHVwRW5hYmxlZCA9IGNoZWNrZWQ7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICB9XG4gICAgICAgICAgY2FzZSBsYXllckRpc3BsYXlUeXBlRW51bS5jbHVzdGVyOiB7XG4gICAgICAgICAgICB0aGlzLmxheWVyXG4gICAgICAgICAgICAgIC5mZWF0dXJlUmVkdWN0aW9uLnBvcHVwRW5hYmxlZCA9IGNoZWNrZWQ7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICB9XG4gICAgICAgICAgY2FzZSBsYXllckRpc3BsYXlUeXBlRW51bS5tYXBOb3Rlczoge1xuICAgICAgICAgICAgdGhpcy5tYXBOb3Rlc1BvcHVwRW5hYmxlZCA9IGNoZWNrZWQ7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICB9XG4gICAgICAgICAgZGVmYXVsdDoge1xuICAgICAgICAgICAgdGhpcy5sYXllci5wb3B1cEVuYWJsZWQgPSBjaGVja2VkO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICB0aGlzLmVuYWJsZURpc2FibGVQb3B1cChjaGVja2VkKTtcbiAgICAgICAgdGhpcy5pbnRlcm5hbFBvcHVwVXBkYXRlZC5lbWl0KHRydWUpO1xuICAgICAgICAvLyBsYXllci5wb3B1cFRlbXBsYXRlIGNhbiBiZSBudWxsLCBkdWUgdG8gZGVib3VuY2VkUG9wdXBVcGRhdGVzLCBjYXVzaW5nIHBvcHVwIHByZXZpZXcgdG8gbm90IHdvcmtcbiAgICAgICAgaWYgKHRoaXMubGF5ZXJEaXNwbGF5VHlwZSAhPT0gbGF5ZXJEaXNwbGF5VHlwZUVudW0ubWFwTm90ZXMgJiZcbiAgICAgICAgICBjaGVja2VkICYmXG4gICAgICAgICAgIXRoaXMubGF5ZXIucG9wdXBUZW1wbGF0ZSkge1xuICAgICAgICAgIHRoaXMubGF5ZXIucG9wdXBUZW1wbGF0ZSA9IHRoaXMucG9wdXBUZW1wbGF0ZTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnNob3dQcmV2aWV3UG9wdXAoY2hlY2tlZCk7XG4gICAgICB9IH0pKSk7XG4gICAgY29uc3QgbWFuYWdlRXhwcmVzc2lvbkJ0biA9IChoKFwiY2FsY2l0ZS1idXR0b25cIiwgeyBhbGlnbm1lbnQ6IFwiaWNvbi1lbmQtc3BhY2UtYmV0d2VlblwiLCBhcHBlYXJhbmNlOiBcInRyYW5zcGFyZW50XCIsIGtpbmQ6IFwibmV1dHJhbFwiLCBpY29uRW5kOiBnZXRFbGVtZW50RGlyKHRoaXMuaG9zdEVsZW1lbnQpID09PSBcInJ0bFwiID8gXCJjaGV2cm9uLWxlZnRcIiA6IFwiY2hldnJvbi1yaWdodFwiLCBsYWJlbDogdGhpcy5zdHJpbmdzLm1hbmFnZUV4cHJlc3Npb25zLCB3aWR0aDogXCJmdWxsXCIsIG9uQ2xpY2s6IHRoaXMubWFuYWdlRXhwcmVzc2lvbkJ0bkNsaWNrIH0sIHRoaXMuc3RyaW5ncy5tYW5hZ2VFeHByZXNzaW9ucykpO1xuICAgIGNvbnN0IGlnbm9yZU5vZGF0YSA9IChoKFwiY2FsY2l0ZS1sYWJlbFwiLCB7IGFsaWdubWVudDogXCJzdGFydFwiLCBsYXlvdXQ6IFwiaW5saW5lLXNwYWNlLWJldHdlZW5cIiB9LCB0aGlzLnN0cmluZ3MuaWdub3JlTm9EYXRhLCBoKFwiY2FsY2l0ZS1zd2l0Y2hcIiwgeyBzY2FsZTogXCJzXCIsIGNoZWNrZWQ6ICEoKF9jID0gKF9iID0gKF9hID0gdGhpcy5wb3B1cFRlbXBsYXRlKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EubGF5ZXJPcHRpb25zKSA9PT0gbnVsbCB8fCBfYiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2Iuc2hvd05vRGF0YVJlY29yZHMpICE9PSBudWxsICYmIF9jICE9PSB2b2lkIDAgPyBfYyA6IGZhbHNlKSwgb25DYWxjaXRlU3dpdGNoQ2hhbmdlOiAoZXZlbnQpID0+IHtcbiAgICAgICAgdmFyIF9hO1xuICAgICAgICBjb25zdCBjaGVja2VkID0gZXZlbnQudGFyZ2V0LmNoZWNrZWQ7XG4gICAgICAgIGlmICghKChfYSA9IHRoaXMucG9wdXBUZW1wbGF0ZSkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmxheWVyT3B0aW9ucykpIHtcbiAgICAgICAgICB0aGlzLmNyZWF0ZUxheWVyT3B0aW9ucygpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMucG9wdXBUZW1wbGF0ZS5sYXllck9wdGlvbnMuc2hvd05vRGF0YVJlY29yZHMgPSAhY2hlY2tlZDtcbiAgICAgICAgdGhpcy5pbnRlcm5hbFBvcHVwVXBkYXRlZC5lbWl0KCk7XG4gICAgICB9IH0pKSk7XG4gICAgY29uc3QgZGlzcGxheVRvcG1vc3QgPSAoaChcImNhbGNpdGUtbGFiZWxcIiwgeyBhbGlnbm1lbnQ6IFwic3RhcnRcIiwgbGF5b3V0OiBcImlubGluZS1zcGFjZS1iZXR3ZWVuXCIgfSwgdGhpcy5zdHJpbmdzLmRpc3BsYXlUb3Btb3N0LCBoKFwiY2FsY2l0ZS1zd2l0Y2hcIiwgeyBzY2FsZTogXCJzXCIsIGNoZWNrZWQ6IChfZiA9IChfZSA9IChfZCA9IHRoaXMucG9wdXBUZW1wbGF0ZSkgPT09IG51bGwgfHwgX2QgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9kLmxheWVyT3B0aW9ucykgPT09IG51bGwgfHwgX2UgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9lLnJldHVyblRvcG1vc3RSYXN0ZXIpICE9PSBudWxsICYmIF9mICE9PSB2b2lkIDAgPyBfZiA6IHRydWUsIG9uQ2FsY2l0ZVN3aXRjaENoYW5nZTogKGV2ZW50KSA9PiB7XG4gICAgICAgIHZhciBfYTtcbiAgICAgICAgY29uc3QgY2hlY2tlZCA9IGV2ZW50LnRhcmdldC5jaGVja2VkO1xuICAgICAgICBpZiAoISgoX2EgPSB0aGlzLnBvcHVwVGVtcGxhdGUpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5sYXllck9wdGlvbnMpKSB7XG4gICAgICAgICAgdGhpcy5jcmVhdGVMYXllck9wdGlvbnMoKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnBvcHVwVGVtcGxhdGUubGF5ZXJPcHRpb25zLnJldHVyblRvcG1vc3RSYXN0ZXIgPSBjaGVja2VkO1xuICAgICAgICB0aGlzLmludGVybmFsUG9wdXBVcGRhdGVkLmVtaXQoKTtcbiAgICAgIH0gfSkpKTtcbiAgICBjb25zdCBzdW1tYXJ5RVQgPSAoaChcInNlY3Rpb25cIiwgeyBjbGFzczogQ1NTJDYuc3VtbWFyeUVUIH0sIGgoXCJjYWxjaXRlLWljb25cIiwgeyBzY2FsZTogXCJtXCIsIGljb246IFwidXNlclwiIH0pLCBoKFwibGFiZWxcIiwgeyBjbGFzczogQ1NTJDYuc3VtbWFyeUVUTGFiZWwgfSwgdGhpcy5zdHJpbmdzLnN1bW1hcnlFVEhlYWRpbmcpLCBoKFwiY2FsY2l0ZS1hY3Rpb25cIiwgeyB0ZXh0OiB0aGlzLnN0cmluZ3MucmVtb3ZlLCBhcHBlYXJhbmNlOiBcInRyYW5zcGFyZW50XCIsIGljb246IFwieFwiLCBjbGFzczogQ1NTJDYuc3VtbWFyeUVUQWN0aW9uLCBvbkNsaWNrOiAoZXZlbnQpID0+IHtcbiAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgIHRoaXMuY2xvc2VQb3B1cFBvcG92ZXJzLmVtaXQoKTtcbiAgICAgICAgdGhpcy5wb3B1cFRlbXBsYXRlLmxhc3RFZGl0SW5mb0VuYWJsZWQgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5tYWluUG9wdXBSZVJlbmRlci5lbWl0KCk7XG4gICAgICAgIHRoaXMuY2FsY2l0ZUZhYi5zZXRGb2N1cygpO1xuICAgICAgfSB9KSkpO1xuICAgIGNvbnN0IGNhbGNpdGVGYWIgPSAoaChcImNhbGNpdGUtZmFiXCIsIHsgaWQ6IFwiYWRkQ29tcG9uZW50QnRuX0lkXCIsIGljb246IFwicGx1c1wiLCBzbG90OiBcImZhYlwiLCBzY2FsZTogXCJzXCIsIGFwcGVhcmFuY2U6IFwib3V0bGluZS1maWxsXCIsIGtpbmQ6IFwibmV1dHJhbFwiLCBsYWJlbDogdGhpcy5zdHJpbmdzLmFkZENvbnRlbnQsIHRleHQ6IHRoaXMuc3RyaW5ncy5hZGRDb250ZW50LCBcInRleHQtZW5hYmxlZFwiOiB0cnVlIH0pKTtcbiAgICBjb25zdCBtYW5hZ2VGaWVsZHNCdG4gPSAoaChcImNhbGNpdGUtYnV0dG9uXCIsIHsgYWxpZ25tZW50OiBcImljb24tZW5kLXNwYWNlLWJldHdlZW5cIiwgYXBwZWFyYW5jZTogXCJ0cmFuc3BhcmVudFwiLCBraW5kOiBcIm5ldXRyYWxcIiwgaWNvbkVuZDogZ2V0RWxlbWVudERpcih0aGlzLmhvc3RFbGVtZW50KSA9PT0gXCJydGxcIiA/IFwiY2hldnJvbi1sZWZ0XCIgOiBcImNoZXZyb24tcmlnaHRcIiwgbGFiZWw6IHRoaXMuc3RyaW5ncy5jb25maWd1cmVGaWVsZHMsIHdpZHRoOiBcImZ1bGxcIiwgb25DbGljazogKGV2ZW50KSA9PiB7XG4gICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICB0aGlzLmNsb3NlUG9wdXBQb3BvdmVycy5lbWl0KCk7XG4gICAgICAgIGNvbnN0IGF0dHJpYnV0ZXNGbG93SXRlbSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJjYWxjaXRlLWZsb3ctaXRlbVwiKTtcbiAgICAgICAgYXR0cmlidXRlc0Zsb3dJdGVtLmhlYWRpbmcgPSB0aGlzLnN0cmluZ3MuYXR0cmlidXRlcztcbiAgICAgICAgYXR0cmlidXRlc0Zsb3dJdGVtLmRlc2NyaXB0aW9uID0gIXRoaXMuaGlkZUxheWVyVGl0bGUgPyB0aGlzLmxheWVyLnRpdGxlIDogdW5kZWZpbmVkO1xuICAgICAgICB0aGlzLmF0dHJpYnV0ZXNDb21wb25lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiYXJjZ2lzLWF0dHJpYnV0ZXNcIik7XG4gICAgICAgIHRoaXMuYXR0cmlidXRlc0NvbXBvbmVudC5sYW5nID0gdGhpcy5jdXJyZW50TGFuZ3VhZ2U7XG4gICAgICAgIHRoaXMuYXR0cmlidXRlc0NvbXBvbmVudC5sYXllciA9IHRoaXMubGF5ZXI7XG4gICAgICAgIHRoaXMuYXR0cmlidXRlc0NvbXBvbmVudC5tYXBWaWV3ID0gdGhpcy5tYXBWaWV3O1xuICAgICAgICB0aGlzLmF0dHJpYnV0ZXNDb21wb25lbnQucG9ydGFsID0gdGhpcy5wb3J0YWw7XG4gICAgICAgIHRoaXMuYXR0cmlidXRlc0NvbXBvbmVudC5sYXllckRpc3BsYXlUeXBlID0gdGhpcy5sYXllckRpc3BsYXlUeXBlO1xuICAgICAgICB0aGlzLmF0dHJpYnV0ZXNDb21wb25lbnQuY29uZmlnID0gdGhpcy5jb25maWc7XG4gICAgICAgIHRoaXMuYXR0cmlidXRlc0NvbXBvbmVudC5jYWxjaXRlRmxvd1Byb3BzID0gdHJ1ZTtcbiAgICAgICAgdGhpcy5hdHRyaWJ1dGVzQ29tcG9uZW50LmRpc3BsYXlQb3B1cCA9IGZhbHNlO1xuICAgICAgICBhdHRyaWJ1dGVzRmxvd0l0ZW0uYXBwZW5kQ2hpbGQodGhpcy5hdHRyaWJ1dGVzQ29tcG9uZW50KTtcbiAgICAgICAgYXR0cmlidXRlc0Zsb3dJdGVtLmJlZm9yZUJhY2sgPSBhc3luYyAoKSA9PiB7XG4gICAgICAgICAgdGhpcy5jbG9zZUF0dHJpYnV0ZVBvcG92ZXJzLmVtaXQoKTtcbiAgICAgICAgfTtcbiAgICAgICAgaWYgKHRoaXMuY2FsY2l0ZUZsb3dQcm9wcykge1xuICAgICAgICAgIHRoaXMuY2FsY2l0ZUZsb3dQcm9wcy5mbG93LmFwcGVuZENoaWxkKGF0dHJpYnV0ZXNGbG93SXRlbSk7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgdGhpcy5ob3N0RWxlbWVudC5zaGFkb3dSb290XG4gICAgICAgICAgICAuZ2V0RWxlbWVudEJ5SWQoXCJwb3B1cEZsb3dfSWRcIilcbiAgICAgICAgICAgIC5hcHBlbmRDaGlsZChhdHRyaWJ1dGVzRmxvd0l0ZW0pO1xuICAgICAgICB9XG4gICAgICAgIHNldFRpbWVvdXQoKCkgPT4gcmVxdWVzdEFuaW1hdGlvbkZyYW1lKCgpID0+IGF0dHJpYnV0ZXNGbG93SXRlbS5zZXRGb2N1cygpKSwgMjAwKTtcbiAgICAgIH0gfSwgdGhpcy5zdHJpbmdzLmNvbmZpZ3VyZUZpZWxkcykpO1xuICAgIGNvbnN0IHBvcHVwT3B0aW9ucyA9ICgpID0+IHtcbiAgICAgIC8vIHNob3cgcG9wdXAgb3B0aW9ucyBpZiBhbnkgb2YgdGhlIGZvbGxvd2luZyBpcyB0cnVlXG4gICAgICBjb25zdCBjb25maWd1cmVGaWVsZHMgPSB0aGlzLnNob3dDb25maWd1cmVGaWVsZHM7XG4gICAgICBjb25zdCBpc0ltYWdlcnkgPSB0aGlzLnNlcnZpY2VUeXBlID09PSBzZXJ2aWNlVHlwZUVudW0uaW1hZ2VyeTtcbiAgICAgIGlmIChjb25maWd1cmVGaWVsZHMgfHwgdGhpcy5zdXBwb3J0c0FyY2FkZSB8fCBpc0ltYWdlcnkpIHtcbiAgICAgICAgcmV0dXJuIChoKFwiY2FsY2l0ZS1ibG9ja1wiLCB7IGhlYWRpbmc6IHRoaXMuc3RyaW5ncy5vcHRpb25zLCBvcGVuOiB0cnVlLCBjb2xsYXBzaWJsZTogdHJ1ZSB9LCBpc0ltYWdlcnkgJiYgaW1hZ2VyeU9wdGlvbnMoKSwgdGhpcy5zdXBwb3J0c0FyY2FkZSAmJiBtYW5hZ2VFeHByZXNzaW9uQnRuLCBjb25maWd1cmVGaWVsZHMgJiYgbWFuYWdlRmllbGRzQnRuKSk7XG4gICAgICB9XG4gICAgfTtcbiAgICBjb25zdCBpbWFnZXJ5T3B0aW9ucyA9ICgpID0+IHtcbiAgICAgIHZhciBfYSwgX2IsIF9jO1xuICAgICAgLy9lbmFibGUgZGlzcGxheSB0b3Btb3N0IGlmIHNlcnZpY2UgdmVyc2lvbiBpcyBncmVhdGVyIHRoYW4gMTAuOCBhbmQgaWYgaXRzIG1vc2FpYyBkYXRhc2V0XG4gICAgICAvL29yIHNpbmdsZSByYXN0ZXIgZGF0YXNldCB3aGljaCBpcyBtdWx0aWRpbWVuc2lvbmFsXG4gICAgICBjb25zdCBsYXllciA9IHRoaXMubGF5ZXI7XG4gICAgICBjb25zdCBpc01vc2FpY0RhdGFzZXRTZXJ2aWNlID0gISEoKF9iID0gKF9hID0gbGF5ZXIuY2FwYWJpbGl0aWVzKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2Eub3BlcmF0aW9ucykgPT09IG51bGwgfHwgX2IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9iLnN1cHBvcnRzUXVlcnkpICYmICgoX2MgPSBsYXllci5maWVsZHMpID09PSBudWxsIHx8IF9jID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYy5sZW5ndGgpO1xuICAgICAgY29uc3QgaXNNdWx0aWRpbWVuc2lvbmFsID0gbGF5ZXIuaGFzTXVsdGlkaW1lbnNpb25zO1xuICAgICAgcmV0dXJuIChoKFwiZGl2XCIsIHsgY2xhc3M6IENTUyQ2LmltYWdlcnlPcHRpb25zIH0sIGlnbm9yZU5vZGF0YSwgZ2V0U2VydmljZVZlcnNpb24obGF5ZXIpID49IDEwLjggJiZcbiAgICAgICAgKGlzTW9zYWljRGF0YXNldFNlcnZpY2UgfHwgaXNNdWx0aWRpbWVuc2lvbmFsKSAmJlxuICAgICAgICBkaXNwbGF5VG9wbW9zdCkpO1xuICAgIH07XG4gICAgY29uc3QgcG9wdXBNYWluID0gKGgoXCJkaXZcIiwgbnVsbCwgZW5hYmxlUG9wdXAsIGgoXCJkaXZcIiwgeyBpZDogXCJwb3B1cERpdl9JZFwiIH0sIHBvcHVwT3B0aW9ucygpLCB0aGlzLnBvcHVwVGl0bGVDb21wb25lbnQoKSwgaChcImRpdlwiLCB7IGNsYXNzOiBDU1MkNi5jb21wb25lbnREaXYgfSwgaChcImNhbGNpdGUtc29ydGFibGUtbGlzdFwiLCB7IGlkOiBcIlNvcnRhYmxlQ29tcG9uZW50c19JZFwiLCBzdHlsZTogeyBwb3NpdGlvbjogXCJyZWxhdGl2ZVwiIH0sIG9uQ2FsY2l0ZUxpc3RPcmRlckNoYW5nZTogKGV2ZW50KSA9PiB7XG4gICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICB0aGlzLnNvcnRhYmxlQ29tcG9uZW50cyA9XG4gICAgICAgICAgdGhpcy5ob3N0RWxlbWVudC5zaGFkb3dSb290LmdldEVsZW1lbnRCeUlkKFwiU29ydGFibGVDb21wb25lbnRzX0lkXCIpO1xuICAgICAgICBjb25zdCBuZXdHdWlkTGlzdCA9IFtdO1xuICAgICAgICBjb25zdCBhbGxDb21wb25lbnRzID0gdGhpcy5zb3J0YWJsZUNvbXBvbmVudHMuZ2V0RWxlbWVudHNCeVRhZ05hbWUoXCJkaXZcIik7XG4gICAgICAgIGZvciAobGV0IHggPSAwOyB4IDwgYWxsQ29tcG9uZW50cy5sZW5ndGg7IHgrKykge1xuICAgICAgICAgIG5ld0d1aWRMaXN0LnB1c2goYWxsQ29tcG9uZW50c1t4XS5pZCk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5yZW9yZGVyKHRoaXMucG9wdXBUZW1wbGF0ZS5jb250ZW50LCB0aGlzLmd1aWRMaXN0LCBuZXdHdWlkTGlzdCk7XG4gICAgICAgIHRoaXMucmVvcmRlcih0aGlzLnBvcHVwQ29tcG9uZW50cywgdGhpcy5ndWlkTGlzdCwgbmV3R3VpZExpc3QpO1xuICAgICAgICB0aGlzLmd1aWRMaXN0ID0gbmV3R3VpZExpc3Q7XG4gICAgICAgIHRoaXMuaW50ZXJuYWxQb3B1cFVwZGF0ZWQuZW1pdCgpO1xuICAgICAgfSB9LCB0aGlzLnBvcHVwQ29tcG9uZW50cykpLCBoKFwiZGl2XCIsIHsgcmVmOiAoZWwpID0+ICh0aGlzLnN1bW1hcnlFVERpdiA9IGVsKSB9LCB0aGlzLmxheWVySGFzRVQgJiYgdGhpcy5wb3B1cFRlbXBsYXRlLmxhc3RFZGl0SW5mb0VuYWJsZWQgJiYgc3VtbWFyeUVUKSkpKTtcbiAgICBjb25zdCBiYWNrQnV0dG9uID0gKGgoXCJjYWxjaXRlLWFjdGlvblwiLCB7IHRleHQ6IHRoaXMuc3RyaW5ncy5iYWNrLCBzY2FsZTogXCJzXCIsIHNsb3Q6IFwiaGVhZGVyLWFjdGlvbnMtc3RhcnRcIiwgcmVmOiAoYmFja0J1dHRvbkVsKSA9PiAodGhpcy5iYWNrQnV0dG9uRWwgPSBiYWNrQnV0dG9uRWwpLCBvbkNsaWNrOiAoZXZlbnQpID0+IHtcbiAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgIHRoaXMuZG9uZSgpO1xuICAgICAgICB0aGlzLmFyY2dpc1BvcHVwRGlzbWlzc2VkQ2hhbmdlLmVtaXQoKTtcbiAgICAgIH0gfSwgaChcImNhbGNpdGUtaWNvblwiLCB7IGljb246IGdldEVsZW1lbnREaXIodGhpcy5ob3N0RWxlbWVudCkgPT09IFwicnRsXCIgPyBcImNoZXZyb24tcmlnaHRcIiA6IFwiY2hldnJvbi1sZWZ0XCIgfSkpKTtcbiAgICByZXR1cm4gKGgoSG9zdCwgeyBzdHlsZTogdGhpcy5jYWxjaXRlRmxvd1Byb3BzID8ge30gOiB7IGRpc3BsYXk6IFwiZmxleFwiLCBmbGV4OiBcIjEgMSBhdXRvXCIsIG92ZXJmbG93OiBcImhpZGRlblwiIH0gfSwgdGhpcy5jYWxjaXRlRmxvd1Byb3BzID8gKGgoXCJkaXZcIiwgeyBkaXI6IGdldEVsZW1lbnREaXIodGhpcy5ob3N0RWxlbWVudCksIHJlZjogKCkgPT4gKHRoaXMucG9wdXBQYW5lbCA9IHRoaXMuY2FsY2l0ZUZsb3dQcm9wcy5jYWxjaXRlRmxvd0l0ZW0pIH0sIHRoaXMuc2VydmljZVR5cGUgPT09IHNlcnZpY2VUeXBlRW51bS53bXMgPyBlbmFibGVQb3B1cCA6IHBvcHVwTWFpbikpIDogKGgoXCJjYWxjaXRlLWZsb3dcIiwgeyBpZDogXCJwb3B1cEZsb3dfSWRcIiwgZGlyOiBnZXRFbGVtZW50RGlyKHRoaXMuaG9zdEVsZW1lbnQpIH0sIGgoXCJjYWxjaXRlLWZsb3ctaXRlbVwiLCB7IHJlZjogKGVsKSA9PiAodGhpcy5wb3B1cFBhbmVsID0gZWwpLCBoZWFkaW5nOiB0aGlzLnN0cmluZ3MucG9wdXBIZWFkaW5nLCBkZXNjcmlwdGlvbjogIXRoaXMuaGlkZUxheWVyVGl0bGUgPyB0aGlzLmxheWVyLnRpdGxlIDogdW5kZWZpbmVkLCBjbG9zYWJsZTogdGhpcy5kaXNtaXNzaWJsZSwgb25DYWxjaXRlRmxvd0l0ZW1DbG9zZTogKGV2ZW50KSA9PiB7XG4gICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICB0aGlzLmRvbmUoKTtcbiAgICAgICAgdGhpcy5hcmNnaXNQb3B1cERpc21pc3NlZENoYW5nZS5lbWl0KCk7XG4gICAgICB9IH0sIHRoaXMuc2VydmljZVR5cGUgPT09IHNlcnZpY2VUeXBlRW51bS53bXMgPyBlbmFibGVQb3B1cCA6IHBvcHVwTWFpbiwgdGhpcy5zZXJ2aWNlVHlwZSAhPT0gc2VydmljZVR5cGVFbnVtLndtcyAmJiBjYWxjaXRlRmFiLCB0aGlzLmJhY2tCdXR0b24gJiYgYmFja0J1dHRvbikpKSkpO1xuICB9XG4gIHJlbmRlclBvcHVwRXJyb3IoKSB7XG4gICAgY29uc3QgcG9wdXBNYWluID0gKGgoXCJkaXZcIiwgeyBjbGFzczogQ1NTJDYubm90aWNlIH0sIGgoXCJjYWxjaXRlLW5vdGljZVwiLCB7IG9wZW46IHRydWUsIGNsb3NhYmxlOiBmYWxzZSwgaWNvbjogXCJleGNsYW1hdGlvbi1tYXJrLXRyaWFuZ2xlXCIsIHNjYWxlOiBcInNcIiB9LCBoKFwiZGl2XCIsIHsgc2xvdDogXCJtZXNzYWdlXCIgfSwgXCIgXCIsIHRoaXMuc3RyaW5ncy5wb3B1cFRpbGVFcnJvcikpKSk7XG4gICAgcmV0dXJuIChoKEhvc3QsIHsgc3R5bGU6IHRoaXMuY2FsY2l0ZUZsb3dQcm9wcyA/IHt9IDogeyBkaXNwbGF5OiBcImZsZXhcIiwgZmxleDogXCIxIDEgYXV0b1wiLCBvdmVyZmxvdzogXCJoaWRkZW5cIiB9IH0sIHRoaXMuY2FsY2l0ZUZsb3dQcm9wcyA/IChoKFwiZGl2XCIsIHsgZGlyOiBnZXRFbGVtZW50RGlyKHRoaXMuaG9zdEVsZW1lbnQpLCByZWY6ICgpID0+ICh0aGlzLnBvcHVwUGFuZWwgPSB0aGlzLmNhbGNpdGVGbG93UHJvcHMuY2FsY2l0ZUZsb3dJdGVtKSB9LCBwb3B1cE1haW4pKSA6IChoKFwiY2FsY2l0ZS1mbG93XCIsIHsgaWQ6IFwicG9wdXBGbG93X0lkXCIsIGRpcjogZ2V0RWxlbWVudERpcih0aGlzLmhvc3RFbGVtZW50KSB9LCBoKFwiY2FsY2l0ZS1mbG93LWl0ZW1cIiwgeyByZWY6IChlbCkgPT4gKHRoaXMucG9wdXBQYW5lbCA9IGVsKSwgaGVhZGluZzogdGhpcy5zdHJpbmdzLnBvcHVwSGVhZGluZywgZGVzY3JpcHRpb246ICF0aGlzLmhpZGVMYXllclRpdGxlID8gdGhpcy5sYXllci50aXRsZSA6IHVuZGVmaW5lZCwgY2xvc2FibGU6IHRoaXMuZGlzbWlzc2libGUsIG9uQ2FsY2l0ZUZsb3dJdGVtQ2xvc2U6IChldmVudCkgPT4ge1xuICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgdGhpcy5kb25lKCk7XG4gICAgICAgIHRoaXMuYXJjZ2lzUG9wdXBEaXNtaXNzZWRDaGFuZ2UuZW1pdCgpO1xuICAgICAgfSB9LCBwb3B1cE1haW4pKSkpKTtcbiAgfVxuICBnZXQgaG9zdEVsZW1lbnQoKSB7IHJldHVybiBnZXRFbGVtZW50KHRoaXMpOyB9XG59O1xuQXJjZ2lzUG9wdXAuc3R5bGUgPSBhcmNnaXNQb3B1cENzcztcblxuY29uc3QgQXJjZ2lzUG9wdXBBcmNhZGUgPSBjbGFzcyB7XG4gIGNvbnN0cnVjdG9yKGhvc3RSZWYpIHtcbiAgICByZWdpc3Rlckluc3RhbmNlKHRoaXMsIGhvc3RSZWYpO1xuICAgIHRoaXMuY2xvc2VQb3B1cFBvcG92ZXJzID0gY3JlYXRlRXZlbnQodGhpcywgXCJjbG9zZVBvcHVwUG9wb3ZlcnNcIiwgNyk7XG4gICAgdGhpcy5pbnRlcm5hbFBvcHVwVXBkYXRlZCA9IGNyZWF0ZUV2ZW50KHRoaXMsIFwiaW50ZXJuYWxQb3B1cFVwZGF0ZWRcIiwgNyk7XG4gICAgdGhpcy5kaXNhYmxlUG9wdXBQYW5lbCA9IGNyZWF0ZUV2ZW50KHRoaXMsIFwiZGlzYWJsZVBvcHVwUGFuZWxcIiwgNyk7XG4gICAgdGhpcy5ndWlkID0gdW5kZWZpbmVkO1xuICAgIHRoaXMuYXJjYWRlQ29udGVudCA9IHVuZGVmaW5lZDtcbiAgICB0aGlzLmJsb2NrT3BlbiA9IGZhbHNlO1xuICAgIHRoaXMucmVSZW5kZXIgPSB1bmRlZmluZWQ7XG4gIH1cbiAgLy8gbGlmZWN5Y2xlIG1ldGhvZHNcbiAgYXN5bmMgY29tcG9uZW50V2lsbExvYWQoKSB7XG4gICAgdGhpcy5sYXllciA9IHBvcHVwU3RhdGUubGF5ZXI7XG4gICAgdGhpcy5tYXBWaWV3ID0gcG9wdXBTdGF0ZS5tYXBWaWV3O1xuICAgIHRoaXMucG9ydGFsID0gcG9wdXBTdGF0ZS5wb3J0YWw7XG4gICAgdGhpcy5jb25maWcgPSBwb3B1cFN0YXRlLmNvbmZpZztcbiAgICB0aGlzLnN0cmluZ3MgPSBwb3B1cFN0YXRlLnN0cmluZ3M7XG4gICAgdGhpcy5jdXJyZW50TGFuZ3VhZ2UgPSBwb3B1cFN0YXRlLmN1cnJlbnRMYW5ndWFnZTtcbiAgICB0aGlzLnNlcnZpY2VUeXBlID0gcG9wdXBTdGF0ZS5zZXJ2aWNlVHlwZTtcbiAgICB0aGlzLnBvcHVwVGVtcGxhdGUgPSBwb3B1cFN0YXRlLnBvcHVwVGVtcGxhdGU7XG4gICAgdGhpcy5sYXllckRpc3BsYXlUeXBlID0gcG9wdXBTdGF0ZS5sYXllckRpc3BsYXlUeXBlO1xuICB9XG4gIGFzeW5jIGNvbXBvbmVudERpZExvYWQoKSB7XG4gICAgaWYgKHRoaXMuYmxvY2tPcGVuKSB7XG4gICAgICB0aGlzLmJsb2NrT3B0aW9ucy5zY3JvbGxJbnRvVmlldyh7IGJlaGF2aW9yOiBcInNtb290aFwiLCBibG9jazogXCJuZWFyZXN0XCIsIGlubGluZTogXCJzdGFydFwiIH0pO1xuICAgICAgYXdhaXQgdGhpcy5sYXVuY2hBcmNhZGUoKTtcbiAgICB9XG4gIH1cbiAgLy8gcHJpdmF0ZSBtZXRob2RzIGFuZCBwcm9wZXJ0aWVzXG4gIGFzeW5jIGxhdW5jaEFyY2FkZSgpIHtcbiAgICB2YXIgX2EsIF9iLCBfYztcbiAgICBpZiAoIXRoaXMuYXJjYWRlRWRpdG9yKSB7XG4gICAgICB0aGlzLmRpc2FibGVQb3B1cFBhbmVsLmVtaXQodHJ1ZSk7XG4gICAgICB0aGlzLmFyY2FkZUVkaXRvciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJhcmNnaXMtbW9kYWwtYXJjYWRlXCIpO1xuICAgICAgdGhpcy5hcmNhZGVFZGl0b3IuYXJjYWRlU2NyaXB0ID0gZ2V0QXJjYWRlU2NyaXB0KChfYSA9IHRoaXMuYXJjYWRlQ29udGVudC5leHByZXNzaW9uSW5mbykgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmV4cHJlc3Npb24sIHRoaXMubGF5ZXJEaXNwbGF5VHlwZSwgdGhpcy5zdHJpbmdzKTtcbiAgICAgIHRoaXMuYXJjYWRlRWRpdG9yLmFyY2FkZVByb2ZpbGUgPSBhd2FpdCBnZXRBcmNhZGVQcm9maWxlKHRoaXMubGF5ZXIsIHRoaXMubWFwVmlldywgdGhpcy5zZXJ2aWNlVHlwZSwgdGhpcy5wb3B1cFRlbXBsYXRlLCB0aGlzLmxheWVyRGlzcGxheVR5cGUpO1xuICAgICAgdGhpcy5hcmNhZGVFZGl0b3IudGVzdERhdGEgPSBhd2FpdCBnZXRUZXN0RGF0YSh0aGlzLmxheWVyLCB0aGlzLm1hcFZpZXcsIHRoaXMubGF5ZXJEaXNwbGF5VHlwZSwgdGhpcy5wb3B1cFRlbXBsYXRlKTtcbiAgICAgIHRoaXMuYXJjYWRlRWRpdG9yLnN1Z2dlc3Rpb25zID0gZ2V0VGVtcGxhdGVzKHRoaXMuc3RyaW5ncyk7XG4gICAgICB0aGlzLmFyY2FkZUVkaXRvci5hZGRFeGlzdGluZ0V4cHJlc3Npb25zID0gdHJ1ZTtcbiAgICAgIHRoaXMuYXJjYWRlRWRpdG9yLmxheWVyID0gdGhpcy5sYXllcjtcbiAgICAgIHRoaXMuYXJjYWRlRWRpdG9yLmFyY2FkZVRpdGxlID1cbiAgICAgICAgKChfYiA9IHRoaXMuYXJjYWRlQ29udGVudC5leHByZXNzaW9uSW5mbykgPT09IG51bGwgfHwgX2IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9iLnRpdGxlKSB8fCB0aGlzLnN0cmluZ3MuYXJjYWRlRGVmYXVsdFRpdGxlO1xuICAgICAgdGhpcy5hcmNhZGVFZGl0b3IuYXJjYWRlVGl0bGVFZGl0YWJsZSA9IHRydWU7XG4gICAgICB0aGlzLmFyY2FkZUVkaXRvci5yZXR1cm5QcmVkaWN0T3V0cHV0VHlwZSA9IGZhbHNlO1xuICAgICAgdGhpcy5hcmNhZGVFZGl0b3IuYXJjYWRlVGl0bGVFZGl0aW5nRW5hYmxlZCA9ICEoKF9jID0gdGhpcy5hcmNhZGVDb250ZW50LmV4cHJlc3Npb25JbmZvKSA9PT0gbnVsbCB8fCBfYyA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2MudGl0bGUpO1xuICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZCh0aGlzLmFyY2FkZUVkaXRvcik7XG4gICAgICB0aGlzLmFyY2FkZUVkaXRvci5hZGRFdmVudExpc3RlbmVyKFwiYXJjZ2lzTW9kYWxBcmNhZGVDbG9zZVwiLCAoZXZlbnQpID0+IHRoaXMuYXJjYWRlU2V0dXAoZXZlbnQuZGV0YWlsKSk7XG4gICAgfVxuICB9XG4gIGFzeW5jIGFyY2FkZVNldHVwKGFyY2FkZU9iamVjdCkge1xuICAgIGlmIChhcmNhZGVPYmplY3QpIHtcbiAgICAgIHRoaXMuYXJjYWRlQ29udGVudC5leHByZXNzaW9uSW5mby5leHByZXNzaW9uID0gYXJjYWRlT2JqZWN0LnNjcmlwdDtcbiAgICAgIHRoaXMuYXJjYWRlQ29udGVudC5leHByZXNzaW9uSW5mby50aXRsZSA9IGFyY2FkZU9iamVjdC50aXRsZTtcbiAgICAgIHRoaXMucmVSZW5kZXIgPSAhdGhpcy5yZVJlbmRlcjtcbiAgICAgIHRoaXMuaW50ZXJuYWxQb3B1cFVwZGF0ZWQuZW1pdCgpO1xuICAgIH1cbiAgICB0aGlzLmRpc2FibGVQb3B1cFBhbmVsLmVtaXQoZmFsc2UpO1xuICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQodGhpcy5hcmNhZGVFZGl0b3IpO1xuICAgIHRoaXMuYXJjYWRlRWRpdG9yID0gbnVsbDtcbiAgfVxuICByZW5kZXIoKSB7XG4gICAgcmV0dXJuIChoKEhvc3QsIG51bGwsIGgoXCJjYWxjaXRlLWJsb2NrXCIsIHsgZGlyOiBnZXRFbGVtZW50RGlyKHRoaXMuaG9zdEVsZW1lbnQpLCBoZWFkaW5nOiB0aGlzLnN0cmluZ3MuYXJjYWRlLCBkZXNjcmlwdGlvbjogdGhpcy5hcmNhZGVDb250ZW50LmV4cHJlc3Npb25JbmZvLnRpdGxlLCBjb2xsYXBzaWJsZTogdHJ1ZSwgb3BlbjogdGhpcy5ibG9ja09wZW4sIGRyYWdIYW5kbGU6IHRydWUgfSwgaChcImRpdlwiLCB7IGNsYXNzOiBcImlnbm9yZS1lbGVtZW50cy1zb3J0YWJsZVwiLCBzbG90OiBcImNvbnRyb2xcIiB9LCBoKFwiYXJjZ2lzLWNhbGNpdGUtYmxvY2stb3B0aW9uc1wiLCB7IHJlZjogKGVsKSA9PiAodGhpcy5ibG9ja09wdGlvbnMgPSBlbCksIGd1aWQ6IHRoaXMuZ3VpZCwgaW50bE9wdGlvbnM6IHRoaXMuc3RyaW5ncy5vcHRpb25zLCBpbnRsRGVsZXRlOiB0aGlzLnN0cmluZ3MuZGVsZXRlLCBpbnRsRHVwbGljYXRlOiB0aGlzLnN0cmluZ3MuZHVwbGljYXRlLCBjYWxjaXRlQmxvY2tPcHRpb25zOiB7IGhhc0RlbGV0ZTogdHJ1ZSwgaGFzRHVwbGljYXRlOiB0cnVlIH0gfSkpLCBoKFwiZGl2XCIsIHsgc2xvdDogXCJpY29uXCIgfSwgaChcImNhbGNpdGUtaWNvblwiLCB7IHNjYWxlOiBcIm1cIiwgaWNvbjogXCJjb2RlXCIgfSkpLCBoKFwiZGl2XCIsIHsgY2xhc3M6IFwiaWdub3JlLWVsZW1lbnRzLXNvcnRhYmxlXCIgfSwgaChcImNhbGNpdGUtYnV0dG9uXCIsIHsgYXBwZWFyYW5jZTogXCJ0cmFuc3BhcmVudFwiLCB3aWR0aDogXCJmdWxsXCIsIG9uQ2xpY2s6IGFzeW5jICgpID0+IGF3YWl0IHRoaXMubGF1bmNoQXJjYWRlKCkgfSwgdGhpcy5zdHJpbmdzLmVkaXRFeHByZXNzaW9uKSkpKSk7XG4gIH1cbiAgZ2V0IGhvc3RFbGVtZW50KCkgeyByZXR1cm4gZ2V0RWxlbWVudCh0aGlzKTsgfVxufTtcblxuY29uc3QgQ1NTJDUgPSB7XG4gIGxpc3RXYXJuaW5nRGl2OiBcImxpc3Qtd2FybmluZy1kaXZcIixcbiAgbGlzdFdhcm5pbmdJY29uOiBcImxpc3Qtd2FybmluZy1pY29uXCIsXG4gIGxpc3RXYXJuaW5nTGFiZWw6IFwibGlzdC13YXJuaW5nLWxhYmVsXCIsXG4gIGxpc3RXYXJuaW5nVGV4dDogXCJsaXN0LXdhcm5pbmctdGV4dFwiLFxuICBmb3JtSW5wdXRCdXR0b246IFwiZm9ybS1pbnB1dC1idXR0b25cIlxufTtcblxuY29uc3QgYXJjZ2lzUG9wdXBBdHRhY2htZW50c0NzcyA9IFwiLmxpc3Qtd2FybmluZy1kaXZ7YmFja2dyb3VuZC1jb2xvcjp2YXIoLS1hcmNnaXMtYXBwLWJhY2tncm91bmQpfS5saXN0LXdhcm5pbmctbGFiZWx7YWxpZ24taXRlbXM6c3RyZXRjaDtiYWNrZ3JvdW5kLWNvbG9yOnZhcigtLWFyY2dpcy1hcHAtYmFja2dyb3VuZCk7Ym9yZGVyLXJhZGl1czp2YXIoLS1hcmNnaXMtYXBwLWJvcmRlci1yYWRpdXMpO2JvcmRlcjoxcHggc29saWQgdmFyKC0tYXJjZ2lzLWFwcC1ib3JkZXIpO2Rpc3BsYXk6ZmxleDtmb250LXNpemU6dmFyKC0tYXJjZ2lzLWFwcC1mb250LXNpemUtLTIpfS5saXN0LXdhcm5pbmctaWNvbnthbGlnbi1pdGVtczpjZW50ZXI7YmFja2dyb3VuZC1jb2xvcjp2YXIoLS1hcmNnaXMtYXBwLWJhY2tncm91bmQtY29udGVudCk7ZGlzcGxheTpmbGV4O3BhZGRpbmc6MCB2YXIoLS1hcmNnaXMtYXBwLXNpZGUtc3BhY2luZy1oYWxmKX0ubGlzdC13YXJuaW5nLXRleHR7cGFkZGluZzp2YXIoLS1hcmNnaXMtYXBwLWNhcC1zcGFjaW5nLXF1YXJ0ZXIpIHZhcigtLWFyY2dpcy1hcHAtc2lkZS1zcGFjaW5nLWhhbGYpfS5mb3JtLWlucHV0LWJ1dHRvbntkaXNwbGF5OmZsZXh9LmZvcm0taW5wdXQtYnV0dG9uIGNhbGNpdGUtaW5wdXRbdHlwZT10ZXh0XXtkaXNwbGF5OmZsZXg7ZmxleC1mbG93OmNvbHVtbiBub3dyYXA7ZmxleDoxIDAgMCU7b3ZlcmZsb3c6aGlkZGVufS5mb3JtLWlucHV0LWJ1dHRvbiBjYWxjaXRlLWFjdGlvbnttYXJnaW46MDtmbGV4OjAgMCAwJTtqdXN0aWZ5LXNlbGY6ZmxleC1lbmR9XCI7XG5cbmNvbnN0IEFyY2dpc1BvcHVwQXR0YWNobWVudHMgPSBjbGFzcyB7XG4gIGNvbnN0cnVjdG9yKGhvc3RSZWYpIHtcbiAgICByZWdpc3Rlckluc3RhbmNlKHRoaXMsIGhvc3RSZWYpO1xuICAgIHRoaXMuY2xvc2VQb3B1cFBvcG92ZXJzID0gY3JlYXRlRXZlbnQodGhpcywgXCJjbG9zZVBvcHVwUG9wb3ZlcnNcIiwgNyk7XG4gICAgdGhpcy5pbnRlcm5hbFBvcHVwVXBkYXRlZCA9IGNyZWF0ZUV2ZW50KHRoaXMsIFwiaW50ZXJuYWxQb3B1cFVwZGF0ZWRcIiwgNyk7XG4gICAgdGhpcy5kaXNhYmxlUG9wdXBQYW5lbCA9IGNyZWF0ZUV2ZW50KHRoaXMsIFwiZGlzYWJsZVBvcHVwUGFuZWxcIiwgNyk7XG4gICAgdGhpcy5mb3JtSW5wdXQgPSAoZm9ybVR5cGUsIGZvcm1TdHJpbmcsIGZvcm1JbnB1dEVsZW1lbnQsIGZvcm1WYWx1ZSwgZm9ybVBsYWNlaG9sZGVyXG4gICAgLy8gcHJvbXB0TWVzc2FnZTogc3RyaW5nXG4gICAgKSA9PiB7XG4gICAgICB2YXIgX2E7XG4gICAgICByZXR1cm4gKGgoXCJjYWxjaXRlLWxhYmVsXCIsIHsgc2NhbGU6IFwic1wiIH0sIGZvcm1TdHJpbmcsIGgoXCJkaXZcIiwgeyBjbGFzczogQ1NTJDUuZm9ybUlucHV0QnV0dG9uIH0sIGgoXCJjYWxjaXRlLWlucHV0XCIsIHsgdHlwZTogXCJ0ZXh0XCIsIGF1dG9mb2N1czogdHJ1ZSwgcmVmOiBmb3JtSW5wdXRFbGVtZW50LCB2YWx1ZTogZm9ybVZhbHVlLCBwbGFjZWhvbGRlcjogZm9ybVBsYWNlaG9sZGVyLCBvbkNhbGNpdGVJbnB1dElucHV0OiAoZXZlbnQpID0+IHtcbiAgICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgICBjb25zdCBpbnB1dFZhbCA9IGV2ZW50LnRhcmdldC52YWx1ZTtcbiAgICAgICAgICBpZiAoZm9ybVR5cGUgPT09IFwidGl0bGVcIikge1xuICAgICAgICAgICAgdGhpcy5hdHRhY2htZW50Q29udGVudC50aXRsZSA9IGlucHV0VmFsO1xuICAgICAgICAgIH1cbiAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuYXR0YWNobWVudENvbnRlbnQuZGVzY3JpcHRpb24gPSBpbnB1dFZhbDtcbiAgICAgICAgICB9XG4gICAgICAgICAgdGhpcy5yZVJlbmRlciA9ICF0aGlzLnJlUmVuZGVyO1xuICAgICAgICB9LCBvbkNsaWNrOiAoKSA9PiB0aGlzLmNsb3NlUG9wdXBQb3BvdmVycy5lbWl0KCkgfSksICgoX2EgPSB0aGlzLnBvcHVwVGVtcGxhdGUuZmllbGRJbmZvcykgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmxlbmd0aCkgPiAwICYmIChoKFwiY2FsY2l0ZS1hY3Rpb25cIiwgeyB0ZXh0OiB0aGlzLnN0cmluZ3MuYXR0cmlidXRlcywgb25DbGljazogKCkgPT4ge1xuICAgICAgICAgIHRoaXMuY2xvc2VQb3B1cFBvcG92ZXJzLmVtaXQoKTtcbiAgICAgICAgICBpZiAoIXRoaXMucG9wdXBGaWVsZFNlbGVjdGlvblBpY2tMaXN0KSB7XG4gICAgICAgICAgICB0aGlzLnBvcHVwRmllbGRTZWxlY3Rpb25QaWNrTGlzdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJhcmNnaXMtcG9wdXAtZmllbGQtcGljay1saXN0XCIpO1xuICAgICAgICAgICAgdGhpcy5wb3B1cEZpZWxkU2VsZWN0aW9uUGlja0xpc3QucG9wb3ZlclByb3BzID0ge1xuICAgICAgICAgICAgICByZWZFbGVtZW50OiB0aGlzLnBvcHVwRmxvd0l0ZW1cbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICB0aGlzLnBvcHVwRmllbGRTZWxlY3Rpb25QaWNrTGlzdC5tdWx0aXBsZSA9IGZhbHNlO1xuICAgICAgICAgICAgdGhpcy5wb3B1cEZpZWxkU2VsZWN0aW9uUGlja0xpc3QuaGVhZGluZyA9IHRoaXMuc3RyaW5ncy5hZGRGaWVsZDtcbiAgICAgICAgICAgIHRoaXMucG9wdXBGaWVsZFNlbGVjdGlvblBpY2tMaXN0LmFkZEV2ZW50TGlzdGVuZXIoXCJhcmNnaXNQb3B1cFBpY2tMaXN0RGlzbWlzc2VkXCIsICgpID0+IHtcbiAgICAgICAgICAgICAgdGhpcy5jbG9zZVBvcHVwUG9wb3ZlcnMuZW1pdCgpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB0aGlzLnBvcHVwRmllbGRTZWxlY3Rpb25QaWNrTGlzdC5hZGRFdmVudExpc3RlbmVyKFwiYXJjZ2lzUG9wdXBQaWNrTGlzdENoYW5nZVwiLCAoZXZlbnQpID0+IHRoaXMucG9wdXBGaWVsZFNlbGVjdGlvblBpY2tMaXN0Q2hhbmdlcyhldmVudCwgZm9ybVR5cGUpKTtcbiAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQodGhpcy5wb3B1cEZpZWxkU2VsZWN0aW9uUGlja0xpc3QpO1xuICAgICAgICAgICAgdGhpcy5kaXNhYmxlUG9wdXBQYW5lbC5lbWl0KHRydWUpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSwgc2NhbGU6IFwic1wiLCBpY29uOiBcImJyYWNrZXRzLWN1cmx5XCIgfSkpKSkpO1xuICAgIH07XG4gICAgdGhpcy5ndWlkID0gdW5kZWZpbmVkO1xuICAgIHRoaXMuYXR0YWNobWVudENvbnRlbnQgPSB1bmRlZmluZWQ7XG4gICAgdGhpcy5sYXllclN1cHBvcnRzUmVzaXplQXR0YWNobWVudHMgPSB1bmRlZmluZWQ7XG4gICAgdGhpcy5ibG9ja09wZW4gPSBmYWxzZTtcbiAgICB0aGlzLnBvcHVwRmxvd0l0ZW0gPSB1bmRlZmluZWQ7XG4gICAgdGhpcy5yZVJlbmRlciA9IHVuZGVmaW5lZDtcbiAgfVxuICAvLyBsaWZlY3ljbGUgbWV0aG9kc1xuICBjb21wb25lbnRXaWxsTG9hZCgpIHtcbiAgICB0aGlzLnN0cmluZ3MgPSBwb3B1cFN0YXRlLnN0cmluZ3M7XG4gICAgdGhpcy5wb3B1cFRlbXBsYXRlID0gcG9wdXBTdGF0ZS5wb3B1cFRlbXBsYXRlO1xuICAgIGlmICh0aGlzLmxheWVyU3VwcG9ydHNSZXNpemVBdHRhY2htZW50cykge1xuICAgICAgaWYgKCF0aGlzLmF0dGFjaG1lbnRDb250ZW50LmRpc3BsYXlUeXBlKSB7XG4gICAgICAgIHRoaXMuYXR0YWNobWVudENvbnRlbnQuZGlzcGxheVR5cGUgPSBBdHRhY2htZW50RGlzcGxheVR5cGUuYXV0bztcbiAgICAgICAgLy8gdGVtcFxuICAgICAgICB0aGlzLmludGVybmFsUG9wdXBVcGRhdGVkLmVtaXQoKTtcbiAgICAgIH1cbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICB0aGlzLmF0dGFjaG1lbnRDb250ZW50LmRpc3BsYXlUeXBlID0gQXR0YWNobWVudERpc3BsYXlUeXBlLmxpc3Q7XG4gICAgfVxuICAgIGlmICghdGhpcy5hdHRhY2htZW50Q29udGVudC50aXRsZSkge1xuICAgICAgdGhpcy5hdHRhY2htZW50Q29udGVudC50aXRsZSA9IFwiXCI7XG4gICAgfVxuICAgIGlmICghdGhpcy5hdHRhY2htZW50Q29udGVudC5kZXNjcmlwdGlvbikge1xuICAgICAgdGhpcy5hdHRhY2htZW50Q29udGVudC5kZXNjcmlwdGlvbiA9IFwiXCI7XG4gICAgfVxuICB9XG4gIGNvbXBvbmVudERpZExvYWQoKSB7XG4gICAgaWYgKHRoaXMuYmxvY2tPcGVuKSB7XG4gICAgICB0aGlzLmJsb2NrT3B0aW9ucy5zY3JvbGxJbnRvVmlldyh7IGJlaGF2aW9yOiBcInNtb290aFwiLCBibG9jazogXCJuZWFyZXN0XCIsIGlubGluZTogXCJzdGFydFwiIH0pO1xuICAgICAgdGhpcy5ibG9ja09wdGlvbnMuc2V0Rm9jdXMoKTtcbiAgICB9XG4gIH1cbiAgY29tcG9uZW50RGlkVXBkYXRlKCkge1xuICAgIHRoaXMuaW50ZXJuYWxQb3B1cFVwZGF0ZWQuZW1pdCgpO1xuICB9XG4gIGRpc2Nvbm5lY3RlZENhbGxiYWNrKCkge1xuICAgIGlmICh0aGlzLnBvcHVwRmllbGRTZWxlY3Rpb25QaWNrTGlzdCkge1xuICAgICAgZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZCh0aGlzLnBvcHVwRmllbGRTZWxlY3Rpb25QaWNrTGlzdCk7XG4gICAgfVxuICB9XG4gIC8vIEV2ZW50c1xuICBjYWxjaXRlQmxvY2tUb2dnbGVIYW5kbGVyKCkge1xuICAgIHRoaXMuY2xvc2VQb3B1cFBvcG92ZXJzLmVtaXQoKTtcbiAgfVxuICBjbG9zZVBvcHVwUG9wb3ZlcnNIYW5kbGVyKCkge1xuICAgIGlmICh0aGlzLnBvcHVwRmllbGRTZWxlY3Rpb25QaWNrTGlzdCkge1xuICAgICAgZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZCh0aGlzLnBvcHVwRmllbGRTZWxlY3Rpb25QaWNrTGlzdCk7XG4gICAgICB0aGlzLnBvcHVwRmllbGRTZWxlY3Rpb25QaWNrTGlzdCA9IG51bGw7XG4gICAgICB0aGlzLmRpc2FibGVQb3B1cFBhbmVsLmVtaXQoZmFsc2UpO1xuICAgIH1cbiAgfVxuICAvLyBmaWVsZCBzZWxlY3Rpb24gZm9yIHRpdGxlIGFuZCBjYXB0aW9uXG4gIHBvcHVwRmllbGRTZWxlY3Rpb25QaWNrTGlzdENoYW5nZXMoZXZlbnQsIGZvcm1UeXBlKSB7XG4gICAgY29uc3Qgc2VsZWN0ZWRGaWVsZE5hbWUgPSBldmVudC5kZXRhaWwuc2VsZWN0ZWRGaWVsZHNbMF07XG4gICAgaWYgKGZvcm1UeXBlID09PSBcInRpdGxlXCIpIHtcbiAgICAgIHRoaXMuY29udGVudFRpdGxlLnZhbHVlID0gYWRkU2VsZWN0ZWRGaWVsZEF0Q3Vyc29yKHRoaXMuY29udGVudFRpdGxlLCBzZWxlY3RlZEZpZWxkTmFtZSk7XG4gICAgICB0aGlzLmNvbnRlbnRUaXRsZS5zZXRGb2N1cygpO1xuICAgICAgdGhpcy5hdHRhY2htZW50Q29udGVudC50aXRsZSA9IHRoaXMuY29udGVudFRpdGxlLnZhbHVlO1xuICAgIH1cbiAgICBlbHNlIGlmIChmb3JtVHlwZSA9PT0gXCJkZXNjcmlwdGlvblwiKSB7XG4gICAgICB0aGlzLmNvbnRlbnREZXNjcmlwdGlvbi52YWx1ZSA9IGFkZFNlbGVjdGVkRmllbGRBdEN1cnNvcih0aGlzLmNvbnRlbnREZXNjcmlwdGlvbiwgc2VsZWN0ZWRGaWVsZE5hbWUpO1xuICAgICAgdGhpcy5jb250ZW50RGVzY3JpcHRpb24uc2V0Rm9jdXMoKTtcbiAgICAgIHRoaXMuYXR0YWNobWVudENvbnRlbnQuZGVzY3JpcHRpb24gPSB0aGlzLmNvbnRlbnREZXNjcmlwdGlvbi52YWx1ZTtcbiAgICB9XG4gICAgdGhpcy5jbG9zZVBvcHVwUG9wb3ZlcnMuZW1pdCgpO1xuICAgIHRoaXMucmVSZW5kZXIgPSAhdGhpcy5yZVJlbmRlcjtcbiAgfVxuICAvLyByZW5kb3IgbWV0aG9kc1xuICByZW5kZXIoKSB7XG4gICAgY29uc3QgYXR0YWNobWVudERpc3BsYXlUeXBlID0gKGgoXCJjYWxjaXRlLWxhYmVsXCIsIG51bGwsIHRoaXMuc3RyaW5ncy5kaXNwbGF5QXR0YWNobWVudHNBcywgaChcImNhbGNpdGUtc2VnbWVudGVkLWNvbnRyb2xcIiwgeyB3aWR0aDogXCJmdWxsXCIsIHNjYWxlOiBcInNcIiwgZGlzYWJsZWQ6ICF0aGlzLmxheWVyU3VwcG9ydHNSZXNpemVBdHRhY2htZW50cywgb25DYWxjaXRlU2VnbWVudGVkQ29udHJvbENoYW5nZTogKGV2ZW50KSA9PiB7XG4gICAgICAgIGNvbnN0IG5vZGUgPSBldmVudC50YXJnZXQ7XG4gICAgICAgIGNvbnN0IHNlbGVjdGVkSXRlbSA9IG5vZGUuc2VsZWN0ZWRJdGVtO1xuICAgICAgICB0aGlzLmF0dGFjaG1lbnRDb250ZW50LmRpc3BsYXlUeXBlID0gc2VsZWN0ZWRJdGVtLnZhbHVlO1xuICAgICAgICB0aGlzLnJlUmVuZGVyID0gIXRoaXMucmVSZW5kZXI7XG4gICAgICB9IH0sIGgoXCJjYWxjaXRlLXNlZ21lbnRlZC1jb250cm9sLWl0ZW1cIiwgeyB2YWx1ZTogQXR0YWNobWVudERpc3BsYXlUeXBlLmF1dG8sIGljb25TdGFydDogXCJjaGVja1wiLCBjaGVja2VkOiB0aGlzLmF0dGFjaG1lbnRDb250ZW50LmRpc3BsYXlUeXBlID09PSBBdHRhY2htZW50RGlzcGxheVR5cGUuYXV0byB9LCB0aGlzLnN0cmluZ3MuYXV0byksIGgoXCJjYWxjaXRlLXNlZ21lbnRlZC1jb250cm9sLWl0ZW1cIiwgeyB2YWx1ZTogQXR0YWNobWVudERpc3BsYXlUeXBlLmxpc3QsIGljb25TdGFydDogXCJsaXN0XCIsIGNoZWNrZWQ6IHRoaXMuYXR0YWNobWVudENvbnRlbnQuZGlzcGxheVR5cGUgPT09IEF0dGFjaG1lbnREaXNwbGF5VHlwZS5saXN0IH0sIHRoaXMuc3RyaW5ncy5saXN0KSwgaChcImNhbGNpdGUtc2VnbWVudGVkLWNvbnRyb2wtaXRlbVwiLCB7IHZhbHVlOiBBdHRhY2htZW50RGlzcGxheVR5cGUucHJldmlldywgaWNvblN0YXJ0OiBcImltYWdlXCIsIGNoZWNrZWQ6IHRoaXMuYXR0YWNobWVudENvbnRlbnQuZGlzcGxheVR5cGUgPT09IEF0dGFjaG1lbnREaXNwbGF5VHlwZS5wcmV2aWV3IH0sIHRoaXMuc3RyaW5ncy5nYWxsZXJ5KSksIGgoXCJjYWxjaXRlLWxhYmVsXCIsIHsgc2NhbGU6IFwic1wiIH0sICgoKSA9PiB7XG4gICAgICBzd2l0Y2ggKHRoaXMuYXR0YWNobWVudENvbnRlbnQuZGlzcGxheVR5cGUpIHtcbiAgICAgICAgY2FzZSBBdHRhY2htZW50RGlzcGxheVR5cGUuYXV0bzpcbiAgICAgICAgICByZXR1cm4gdGhpcy5zdHJpbmdzLmF1dG9EaXNwbGF5TWVzc2FnZTtcbiAgICAgICAgY2FzZSBBdHRhY2htZW50RGlzcGxheVR5cGUubGlzdDpcbiAgICAgICAgICByZXR1cm4gdGhpcy5zdHJpbmdzLmxpc3REaXNwbGF5TWVzc2FnZTtcbiAgICAgICAgY2FzZSBBdHRhY2htZW50RGlzcGxheVR5cGUucHJldmlldzpcbiAgICAgICAgICByZXR1cm4gdGhpcy5zdHJpbmdzLnByZXZpZXdEaXNwbGF5TWVzc2FnZTtcbiAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICByZXR1cm4gdGhpcy5zdHJpbmdzLmxpc3REaXNwbGF5TWVzc2FnZTtcbiAgICAgIH1cbiAgICB9KSgpKSkpO1xuICAgIGNvbnN0IGxpc3RXYXJuaW5nTWVzc2FnZSA9IChoKFwiZGl2XCIsIHsgY2xhc3M6IENTUyQ1Lmxpc3RXYXJuaW5nRGl2IH0sIGgoXCJsYWJlbFwiLCB7IGNsYXNzOiBDU1MkNS5saXN0V2FybmluZ0xhYmVsIH0sIGgoXCJzcGFuXCIsIHsgY2xhc3M6IENTUyQ1Lmxpc3RXYXJuaW5nSWNvbiB9LCBoKFwiY2FsY2l0ZS1pY29uXCIsIHsgc2NhbGU6IFwic1wiLCBpY29uOiBcImV4Y2xhbWF0aW9uLW1hcmstdHJpYW5nbGVcIiB9KSksIGgoXCJzcGFuXCIsIHsgY2xhc3M6IENTUyQ1Lmxpc3RXYXJuaW5nVGV4dCB9LCB0aGlzLnN0cmluZ3MubGF5ZXJPbmx5U3VwcG9ydHNMaXN0VmlldykpKSk7XG4gICAgcmV0dXJuIChoKEhvc3QsIG51bGwsIGgoXCJjYWxjaXRlLWJsb2NrXCIsIHsgZGlyOiBnZXRFbGVtZW50RGlyKHRoaXMuaG9zdEVsZW1lbnQpLCBoZWFkaW5nOiB0aGlzLnN0cmluZ3MuYXR0YWNobWVudHMsIGRlc2NyaXB0aW9uOiAodGhpcy5hdHRhY2htZW50Q29udGVudC50aXRsZSAmJlxuICAgICAgICBgJHt0aGlzLmF0dGFjaG1lbnRDb250ZW50LnRpdGxlLnN1YnN0cmluZygwLCAyNSl9JHt0aGlzLmF0dGFjaG1lbnRDb250ZW50LnRpdGxlLmxlbmd0aCA+IDI1ID8gXCIuLi5cIiA6IFwiXCJ9YCkgfHxcbiAgICAgICAgKCgpID0+IHtcbiAgICAgICAgICBzd2l0Y2ggKHRoaXMuYXR0YWNobWVudENvbnRlbnQuZGlzcGxheVR5cGUpIHtcbiAgICAgICAgICAgIGNhc2UgQXR0YWNobWVudERpc3BsYXlUeXBlLmF1dG86XG4gICAgICAgICAgICAgIHJldHVybiB0aGlzLnN0cmluZ3MuYXV0bztcbiAgICAgICAgICAgIGNhc2UgQXR0YWNobWVudERpc3BsYXlUeXBlLmxpc3Q6XG4gICAgICAgICAgICAgIHJldHVybiB0aGlzLnN0cmluZ3MubGlzdDtcbiAgICAgICAgICAgIGNhc2UgQXR0YWNobWVudERpc3BsYXlUeXBlLnByZXZpZXc6XG4gICAgICAgICAgICAgIHJldHVybiB0aGlzLnN0cmluZ3MuZ2FsbGVyeTtcbiAgICAgICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICAgIHJldHVybiB0aGlzLnN0cmluZ3MubGlzdDtcbiAgICAgICAgICB9XG4gICAgICAgIH0pKCksIGNvbGxhcHNpYmxlOiB0cnVlLCBvcGVuOiB0aGlzLmJsb2NrT3BlbiwgZHJhZ0hhbmRsZTogdHJ1ZSB9LCBoKFwiZGl2XCIsIHsgY2xhc3M6IFwiaWdub3JlLWVsZW1lbnRzLXNvcnRhYmxlXCIsIHNsb3Q6IFwiY29udHJvbFwiIH0sIGgoXCJhcmNnaXMtY2FsY2l0ZS1ibG9jay1vcHRpb25zXCIsIHsgcmVmOiAoZWwpID0+ICh0aGlzLmJsb2NrT3B0aW9ucyA9IGVsKSwgZ3VpZDogdGhpcy5ndWlkLCBpbnRsT3B0aW9uczogdGhpcy5zdHJpbmdzLm9wdGlvbnMsIGludGxEZWxldGU6IHRoaXMuc3RyaW5ncy5kZWxldGUsIGNhbGNpdGVCbG9ja09wdGlvbnM6IHsgaGFzRGVsZXRlOiB0cnVlIH0gfSkpLCBoKFwiZGl2XCIsIHsgc2xvdDogXCJpY29uXCIgfSwgaChcImNhbGNpdGUtaWNvblwiLCB7IHNjYWxlOiBcIm1cIiwgaWNvbjogXCJhdHRhY2htZW50XCIgfSkpLCBoKFwiZGl2XCIsIHsgY2xhc3M6IFwiaWdub3JlLWVsZW1lbnRzLXNvcnRhYmxlXCIgfSwgdGhpcy5mb3JtSW5wdXQoXCJ0aXRsZVwiLCB0aGlzLnN0cmluZ3MudGl0bGUsIChlbGVtZW50KSA9PiB7XG4gICAgICByZXR1cm4gKHRoaXMuY29udGVudFRpdGxlID0gZWxlbWVudCk7XG4gICAgfSwgdGhpcy5hdHRhY2htZW50Q29udGVudC50aXRsZSwgdGhpcy5zdHJpbmdzLmVudGVyVGl0bGVcbiAgICAvLyB0aGlzLnN0cmluZ3MudGl0bGVDb250ZXh0LnJlcGxhY2UoXCIke3RpdGxlQ29udGV4dH1cIiwgdGhpcy5zdHJpbmdzLmF0dGFjaG1lbnRzX0wpXG4gICAgKSwgdGhpcy5mb3JtSW5wdXQoXCJkZXNjcmlwdGlvblwiLCB0aGlzLnN0cmluZ3MuZGVzYywgKGVsZW1lbnQpID0+IHtcbiAgICAgIHJldHVybiAodGhpcy5jb250ZW50RGVzY3JpcHRpb24gPSBlbGVtZW50KTtcbiAgICB9LCB0aGlzLmF0dGFjaG1lbnRDb250ZW50LmRlc2NyaXB0aW9uLCB0aGlzLnN0cmluZ3MuZW50ZXJEZXNjcmlwdGlvblxuICAgIC8vIHRoaXMuc3RyaW5ncy5kZXNjcmlwdGlvbkNvbnRleHQucmVwbGFjZShcbiAgICAvLyAgIFwiJHtkZXNjcmlwdGlvbkNvbnRleHR9XCIsXG4gICAgLy8gICB0aGlzLnN0cmluZ3MuYXR0YWNobWVudHNfTFxuICAgIC8vIClcbiAgICApLCBhdHRhY2htZW50RGlzcGxheVR5cGUsIHRoaXMubGF5ZXJTdXBwb3J0c1Jlc2l6ZUF0dGFjaG1lbnRzID8gbnVsbCA6IGxpc3RXYXJuaW5nTWVzc2FnZSkpKSk7XG4gIH1cbiAgZ2V0IGhvc3RFbGVtZW50KCkgeyByZXR1cm4gZ2V0RWxlbWVudCh0aGlzKTsgfVxufTtcbkFyY2dpc1BvcHVwQXR0YWNobWVudHMuc3R5bGUgPSBhcmNnaXNQb3B1cEF0dGFjaG1lbnRzQ3NzO1xuXG5jb25zdCBDU1MkNCA9IHtcbiAgbWFuYWdlQnRuOiBcIm1hbmFnZS1idG5cIixcbiAgZm9ybUlucHV0QnV0dG9uOiBcImZvcm0taW5wdXQtYnV0dG9uXCJcbn07XG5cbmNvbnN0IGFyY2dpc1BvcHVwQXR0cmlidXRlc0NzcyA9IFwiLm1hbmFnZS1idG57anVzdGlmeS1jb250ZW50OmZsZXgtZW5kO21hcmdpbjo0cHggMH0uZm9ybS1pbnB1dC1idXR0b257ZGlzcGxheTpmbGV4fS5mb3JtLWlucHV0LWJ1dHRvbiBjYWxjaXRlLWlucHV0W3R5cGU9dGV4dF17ZGlzcGxheTpmbGV4O2ZsZXgtZmxvdzpjb2x1bW4gbm93cmFwO2ZsZXg6MSAwIDAlO292ZXJmbG93OmhpZGRlbn0uZm9ybS1pbnB1dC1idXR0b24gY2FsY2l0ZS1hY3Rpb257bWFyZ2luOjA7ZmxleDowIDAgMCU7anVzdGlmeS1zZWxmOmZsZXgtZW5kfVwiO1xuXG5jb25zdCBBcmNnaXNQb3B1cEF0dHJpYnV0ZXMgPSBjbGFzcyB7XG4gIGNvbnN0cnVjdG9yKGhvc3RSZWYpIHtcbiAgICByZWdpc3Rlckluc3RhbmNlKHRoaXMsIGhvc3RSZWYpO1xuICAgIHRoaXMuY2xvc2VQb3B1cFBvcG92ZXJzID0gY3JlYXRlRXZlbnQodGhpcywgXCJjbG9zZVBvcHVwUG9wb3ZlcnNcIiwgNyk7XG4gICAgdGhpcy5pbnRlcm5hbFBvcHVwVXBkYXRlZCA9IGNyZWF0ZUV2ZW50KHRoaXMsIFwiaW50ZXJuYWxQb3B1cFVwZGF0ZWRcIiwgNyk7XG4gICAgdGhpcy5kaXNhYmxlUG9wdXBQYW5lbCA9IGNyZWF0ZUV2ZW50KHRoaXMsIFwiZGlzYWJsZVBvcHVwUGFuZWxcIiwgNyk7XG4gICAgdGhpcy5waWNrTGlzdCA9IFtdO1xuICAgIHRoaXMuYXJjYWRlRXhwTWFwID0gbmV3IE1hcCgpO1xuICAgIC8vIG9wZW4gcG9wb3ZlclxuICAgIHRoaXMubWFuYWdlQnRuQ2xpY2sgPSAoZXZlbnQpID0+IHtcbiAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgLy8gY2xvc2UgZmlyc3Qgc2luY2Ugd2UgY2FuIGhhdmUgbXVsdGlwbGUgYXR0cmlidXRlcyBvcGVuXG4gICAgICB0aGlzLmNsb3NlUG9wdXBQb3BvdmVycy5lbWl0KCk7XG4gICAgICAvLyBsYXp5IGxvYWQgYXR0cmlidXRlIG1hbmFnZXIgY29tcG9uZW50XG4gICAgICBpZiAoIXRoaXMucG9wdXBGaWVsZE1hbmFnZVBpY2tMaXN0KSB7XG4gICAgICAgIHRoaXMucG9wdXBGaWVsZE1hbmFnZVBpY2tMaXN0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImFyY2dpcy1wb3B1cC1maWVsZC1waWNrLWxpc3RcIik7XG4gICAgICAgIHRoaXMucG9wdXBGaWVsZE1hbmFnZVBpY2tMaXN0LnBvcG92ZXJQcm9wcyA9IHtcbiAgICAgICAgICByZWZFbGVtZW50OiB0aGlzLnBvcHVwRmxvd0l0ZW1cbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy5wb3B1cEZpZWxkTWFuYWdlUGlja0xpc3Quc2VsZWN0ZWRGaWVsZHMgPSB0aGlzLmdldFNlbGVjdGVkRmllbGRzKCk7XG4gICAgICAgIHRoaXMucG9wdXBGaWVsZE1hbmFnZVBpY2tMaXN0LnNob3dDYW5jZWwgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5wb3B1cEZpZWxkTWFuYWdlUGlja0xpc3QubXVsdGlwbGUgPSB0cnVlO1xuICAgICAgICB0aGlzLnBvcHVwRmllbGRNYW5hZ2VQaWNrTGlzdC5oZWFkaW5nID0gdGhpcy5zdHJpbmdzLnNlbGVjdEZpZWxkcztcbiAgICAgICAgdGhpcy5wb3B1cEZpZWxkTWFuYWdlUGlja0xpc3Qub2tCdG5UZXh0ID0gdGhpcy5zdHJpbmdzLmRvbmU7XG4gICAgICAgIHRoaXMucG9wdXBGaWVsZE1hbmFnZVBpY2tMaXN0LmFkZEV2ZW50TGlzdGVuZXIoXCJhcmNnaXNQb3B1cFBpY2tMaXN0RGlzbWlzc2VkXCIsICgpID0+IHtcbiAgICAgICAgICB0aGlzLmNsb3NlUG9wdXBQb3BvdmVycy5lbWl0KCk7XG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLnBvcHVwRmllbGRNYW5hZ2VQaWNrTGlzdC5hZGRFdmVudExpc3RlbmVyKFwiYXJjZ2lzUG9wdXBQaWNrTGlzdENoYW5nZVwiLCB0aGlzLnBvcHVwRmllbGRNYW5hZ2VQaWNrTGlzdENoYW5nZXMpO1xuICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHRoaXMucG9wdXBGaWVsZE1hbmFnZVBpY2tMaXN0KTtcbiAgICAgICAgdGhpcy5kaXNhYmxlUG9wdXBQYW5lbC5lbWl0KHRydWUpO1xuICAgICAgfVxuICAgIH07XG4gICAgdGhpcy5wb3B1cEZpZWxkTWFuYWdlUGlja0xpc3RDaGFuZ2VzID0gKGV2ZW50KSA9PiB7XG4gICAgICB2YXIgX2E7XG4gICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgIGNvbnN0IHNlbGVjdGVkRmllbGQgPSAoX2EgPSBldmVudC5kZXRhaWwpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5zZWxlY3RlZEZpZWxkcztcbiAgICAgIGNvbnN0IGZpZWxkSW5mb3MgPSBbXTtcbiAgICAgIHRoaXMuc2V0dXBGaWVsZE1hcEluZm8oKTtcbiAgICAgIHNlbGVjdGVkRmllbGQuZm9yRWFjaCgoZmllbGROYW1lKSA9PiB7XG4gICAgICAgIHZhciBfYTtcbiAgICAgICAgaWYgKHRoaXMuZmllbGRJbmZvTWFwLmhhcyhmaWVsZE5hbWUpKSB7XG4gICAgICAgICAgY29uc3QgdGVtcEZpZWxkID0gKF9hID0gdGhpcy5maWVsZEluZm9NYXAuZ2V0KGZpZWxkTmFtZSkpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5jbG9uZSgpO1xuICAgICAgICAgIHRlbXBGaWVsZC52aXNpYmxlID0gdHJ1ZTtcbiAgICAgICAgICBmaWVsZEluZm9zLnB1c2godGVtcEZpZWxkKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgICB0aGlzLnBvcHVwQ29udGVudC5maWVsZEluZm9zID0gWy4uLmZpZWxkSW5mb3NdO1xuICAgICAgdGhpcy5yZVJlbmRlciA9ICF0aGlzLnJlUmVuZGVyO1xuICAgIH07XG4gICAgdGhpcy5jYWxjaXRlUGlja0xpc3QgPSAoZmllbGQpID0+IChcbiAgICAvLyBmaWVsZC5maWVsZE5hbWUgaXMgYWx3YXlzIHVuaXF1ZVxuICAgIGgoXCJjYWxjaXRlLXZhbHVlLWxpc3QtaXRlbVwiLCB7IGtleTogZmllbGQuZmllbGROYW1lLCBsYWJlbDogZ2V0RmllbGREaXNwbGF5TmFtZShmaWVsZCwgdGhpcy5hcmNhZGVFeHBNYXApLCB2YWx1ZTogZmllbGQuZmllbGROYW1lIH0sIGgoXCJjYWxjaXRlLWFjdGlvblwiLCB7IHNsb3Q6IFwiYWN0aW9ucy1lbmRcIiwgYXBwZWFyYW5jZTogXCJ0cmFuc3BhcmVudFwiLCB0ZXh0OiB0aGlzLnN0cmluZ3MucmVtb3ZlLCBvbkNsaWNrOiAoKSA9PiB0aGlzLnJlbW92ZUJ0bkNsaWNrKGZpZWxkLmZpZWxkTmFtZSkgfSwgaChcImNhbGNpdGUtaWNvblwiLCB7IHNjYWxlOiBcInNcIiwgaWNvbjogXCJ4XCIgfSkpKSk7XG4gICAgdGhpcy5mb3JtSW5wdXQgPSAoZm9ybVR5cGUsIGZvcm1TdHJpbmcsIGZvcm1JbnB1dEVsZW1lbnQsIGZvcm1WYWx1ZSwgZm9ybVBsYWNlaG9sZGVyXG4gICAgLy8gcHJvbXB0TWVzc2FnZTogc3RyaW5nXG4gICAgKSA9PiB7XG4gICAgICB2YXIgX2E7XG4gICAgICByZXR1cm4gKGgoXCJjYWxjaXRlLWxhYmVsXCIsIHsgc2NhbGU6IFwic1wiIH0sIGZvcm1TdHJpbmcsIGgoXCJkaXZcIiwgeyBjbGFzczogQ1NTJDQuZm9ybUlucHV0QnV0dG9uIH0sIGgoXCJjYWxjaXRlLWlucHV0XCIsIHsgdHlwZTogXCJ0ZXh0XCIsIGF1dG9mb2N1czogdHJ1ZSwgcmVmOiBmb3JtSW5wdXRFbGVtZW50LCB2YWx1ZTogZm9ybVZhbHVlLCBwbGFjZWhvbGRlcjogZm9ybVBsYWNlaG9sZGVyLCBvbkNhbGNpdGVJbnB1dElucHV0OiAoZXZlbnQpID0+IHtcbiAgICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgICBjb25zdCBpbnB1dFZhbCA9IGV2ZW50LnRhcmdldC52YWx1ZTtcbiAgICAgICAgICBpZiAoZm9ybVR5cGUgPT09IFwidGl0bGVcIikge1xuICAgICAgICAgICAgdGhpcy5wb3B1cENvbnRlbnQudGl0bGUgPSBpbnB1dFZhbDtcbiAgICAgICAgICB9XG4gICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICB0aGlzLnBvcHVwQ29udGVudC5kZXNjcmlwdGlvbiA9IGlucHV0VmFsO1xuICAgICAgICAgIH1cbiAgICAgICAgICB0aGlzLnJlUmVuZGVyID0gIXRoaXMucmVSZW5kZXI7XG4gICAgICAgIH0sIG9uQ2xpY2s6ICgpID0+IHRoaXMuY2xvc2VQb3B1cFBvcG92ZXJzLmVtaXQoKSB9KSwgKChfYSA9IHRoaXMucG9wdXBUZW1wbGF0ZS5maWVsZEluZm9zKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EubGVuZ3RoKSA+IDAgJiYgKGgoXCJjYWxjaXRlLWFjdGlvblwiLCB7IHRleHQ6IHRoaXMuc3RyaW5ncy5hdHRyaWJ1dGVzLCBvbkNsaWNrOiAoKSA9PiB7XG4gICAgICAgICAgdGhpcy5jbG9zZVBvcHVwUG9wb3ZlcnMuZW1pdCgpO1xuICAgICAgICAgIGlmICghdGhpcy5wb3B1cEZpZWxkU2VsZWN0aW9uUGlja0xpc3QpIHtcbiAgICAgICAgICAgIHRoaXMucG9wdXBGaWVsZFNlbGVjdGlvblBpY2tMaXN0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImFyY2dpcy1wb3B1cC1maWVsZC1waWNrLWxpc3RcIik7XG4gICAgICAgICAgICB0aGlzLnBvcHVwRmllbGRTZWxlY3Rpb25QaWNrTGlzdC5wb3BvdmVyUHJvcHMgPSB7XG4gICAgICAgICAgICAgIHJlZkVsZW1lbnQ6IHRoaXMucG9wdXBGbG93SXRlbSxcbiAgICAgICAgICAgICAgb2Zmc2V0U2tpZGRpbmc6IDUwXG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgdGhpcy5wb3B1cEZpZWxkU2VsZWN0aW9uUGlja0xpc3QubXVsdGlwbGUgPSBmYWxzZTtcbiAgICAgICAgICAgIHRoaXMucG9wdXBGaWVsZFNlbGVjdGlvblBpY2tMaXN0LmhlYWRpbmcgPSB0aGlzLnN0cmluZ3MuYWRkRmllbGQ7XG4gICAgICAgICAgICB0aGlzLnBvcHVwRmllbGRTZWxlY3Rpb25QaWNrTGlzdC5hZGRFdmVudExpc3RlbmVyKFwiYXJjZ2lzUG9wdXBQaWNrTGlzdERpc21pc3NlZFwiLCAoKSA9PiB7XG4gICAgICAgICAgICAgIHRoaXMuY2xvc2VQb3B1cFBvcG92ZXJzLmVtaXQoKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgdGhpcy5wb3B1cEZpZWxkU2VsZWN0aW9uUGlja0xpc3QuYWRkRXZlbnRMaXN0ZW5lcihcImFyY2dpc1BvcHVwUGlja0xpc3RDaGFuZ2VcIiwgKGV2ZW50KSA9PiB0aGlzLnBvcHVwRmllbGRTZWxlY3Rpb25QaWNrTGlzdENoYW5nZXMoZXZlbnQsIGZvcm1UeXBlKSk7XG4gICAgICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHRoaXMucG9wdXBGaWVsZFNlbGVjdGlvblBpY2tMaXN0KTtcbiAgICAgICAgICAgIHRoaXMuZGlzYWJsZVBvcHVwUGFuZWwuZW1pdCh0cnVlKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0sIHNjYWxlOiBcInNcIiwgaWNvbjogXCJicmFja2V0cy1jdXJseVwiIH0pKSkpKTtcbiAgICB9O1xuICAgIHRoaXMuZ3VpZCA9IHVuZGVmaW5lZDtcbiAgICB0aGlzLnBvcHVwQ29udGVudCA9IHVuZGVmaW5lZDtcbiAgICB0aGlzLmJsb2NrT3BlbiA9IGZhbHNlO1xuICAgIHRoaXMucG9wdXBGbG93SXRlbSA9IHVuZGVmaW5lZDtcbiAgICB0aGlzLnJlUmVuZGVyID0gdW5kZWZpbmVkO1xuICB9XG4gIC8vIGxpZmVjeWNsZSBtZXRob2RzXG4gIGFzeW5jIGNvbXBvbmVudFdpbGxMb2FkKCkge1xuICAgIHRoaXMubGF5ZXIgPSBwb3B1cFN0YXRlLmxheWVyO1xuICAgIHRoaXMuc3RyaW5ncyA9IHBvcHVwU3RhdGUuc3RyaW5ncztcbiAgICB0aGlzLnBvcHVwVGVtcGxhdGUgPSBwb3B1cFN0YXRlLnBvcHVwVGVtcGxhdGU7XG4gICAgdGhpcy5sYXllckRpc3BsYXlUeXBlID0gcG9wdXBTdGF0ZS5sYXllckRpc3BsYXlUeXBlO1xuICAgIGlmICghdGhpcy5wb3B1cENvbnRlbnQuZmllbGRJbmZvcykge1xuICAgICAgdGhpcy5wb3B1cENvbnRlbnQuZmllbGRJbmZvcyA9IGF3YWl0IHRoaXMuZ2V0RmllbGRzQ29udGVudCgpO1xuICAgIH1cbiAgICBpZiAoIXRoaXMucG9wdXBDb250ZW50LnRpdGxlKSB7XG4gICAgICB0aGlzLnBvcHVwQ29udGVudC50aXRsZSA9IFwiXCI7XG4gICAgfVxuICAgIGlmICghdGhpcy5wb3B1cENvbnRlbnQuZGVzY3JpcHRpb24pIHtcbiAgICAgIHRoaXMucG9wdXBDb250ZW50LmRlc2NyaXB0aW9uID0gXCJcIjtcbiAgICB9XG4gIH1cbiAgY29tcG9uZW50RGlkTG9hZCgpIHtcbiAgICBpZiAodGhpcy5ibG9ja09wZW4pIHtcbiAgICAgIHRoaXMuYmxvY2tPcHRpb25zLnNjcm9sbEludG9WaWV3KHsgYmVoYXZpb3I6IFwic21vb3RoXCIsIGJsb2NrOiBcIm5lYXJlc3RcIiwgaW5saW5lOiBcInN0YXJ0XCIgfSk7XG4gICAgICB0aGlzLmJsb2NrT3B0aW9ucy5zZXRGb2N1cygpO1xuICAgICAgdGhpcy5pbnRlcm5hbFBvcHVwVXBkYXRlZC5lbWl0KCk7XG4gICAgfVxuICB9XG4gIGNvbXBvbmVudFdpbGxSZW5kZXIoKSB7XG4gICAgdGhpcy5hcmNhZGVFeHBNYXAgPSBnZW5lcmF0ZUFyY2FkZUV4cHJlc3Npb25NYXAodGhpcy5wb3B1cFRlbXBsYXRlKTtcbiAgICB0aGlzLnNldHVwRmllbGRNYXBJbmZvKCk7XG4gICAgdGhpcy5waWNrTGlzdCA9IFtdO1xuICAgIHRoaXMucG9wdXBDb250ZW50LmZpZWxkSW5mb3MuZm9yRWFjaCgoZmllbGQpID0+IHtcbiAgICAgIHRoaXMucGlja0xpc3QucHVzaCh0aGlzLmNhbGNpdGVQaWNrTGlzdChmaWVsZCkpO1xuICAgIH0pO1xuICB9XG4gIGNvbXBvbmVudERpZFVwZGF0ZSgpIHtcbiAgICB0aGlzLmludGVybmFsUG9wdXBVcGRhdGVkLmVtaXQoKTtcbiAgfVxuICBkaXNjb25uZWN0ZWRDYWxsYmFjaygpIHtcbiAgICBpZiAodGhpcy5wb3B1cEZpZWxkTWFuYWdlUGlja0xpc3QpIHtcbiAgICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQodGhpcy5wb3B1cEZpZWxkTWFuYWdlUGlja0xpc3QpO1xuICAgIH1cbiAgICBpZiAodGhpcy5wb3B1cEZpZWxkU2VsZWN0aW9uUGlja0xpc3QpIHtcbiAgICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQodGhpcy5wb3B1cEZpZWxkU2VsZWN0aW9uUGlja0xpc3QpO1xuICAgIH1cbiAgfVxuICAvLyBFdmVudHNcbiAgLy8gZm9yIGFyY2FkZSBjaGFuZ2VzXG4gIGFyY2FkZUNoYW5nZU5vdGlmaWNhdGlvbkhhbmRsZXIoKSB7XG4gICAgdGhpcy5yZVJlbmRlciA9IHRoaXMucmVSZW5kZXIgPyBmYWxzZSA6IHRydWU7XG4gIH1cbiAgLy8gZm9yIGF0dHJpYnV0ZSBjaGFuZ2VzXG4gIGFzeW5jIGF0dHJpYnV0ZXNDaGFuZ2VOb3RpZmljYXRpb25IYW5kbGVyKCkge1xuICAgIC8vIHVwZGF0ZSBmaWVsZCBpbmZvc1xuICAgIHRoaXMucG9wdXBDb250ZW50LmZpZWxkSW5mb3MuZm9yRWFjaCgoZmllbGQsIGluZGV4KSA9PiB7XG4gICAgICBpZiAodGhpcy5maWVsZEluZm9NYXAuaGFzKGZpZWxkLmZpZWxkTmFtZSkpIHtcbiAgICAgICAgdGhpcy5wb3B1cENvbnRlbnQuZmllbGRJbmZvc1tpbmRleF0gPSB0aGlzLmZpZWxkSW5mb01hcC5nZXQoZmllbGQuZmllbGROYW1lKS5jbG9uZSgpO1xuICAgICAgICB0aGlzLnBvcHVwQ29udGVudC5maWVsZEluZm9zW2luZGV4XS52aXNpYmxlID0gdHJ1ZTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICB0aGlzLnJlUmVuZGVyID0gIXRoaXMucmVSZW5kZXI7XG4gIH1cbiAgY2xvc2VQb3B1cFBvcG92ZXJzSGFuZGxlcigpIHtcbiAgICBpZiAodGhpcy5wb3B1cEZpZWxkTWFuYWdlUGlja0xpc3QpIHtcbiAgICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQodGhpcy5wb3B1cEZpZWxkTWFuYWdlUGlja0xpc3QpO1xuICAgICAgdGhpcy5wb3B1cEZpZWxkTWFuYWdlUGlja0xpc3QgPSBudWxsO1xuICAgICAgdGhpcy5ibG9ja09wdGlvbnMuc2V0Rm9jdXMoKTtcbiAgICAgIHRoaXMuZGlzYWJsZVBvcHVwUGFuZWwuZW1pdChmYWxzZSk7XG4gICAgfVxuICAgIGlmICh0aGlzLnBvcHVwRmllbGRTZWxlY3Rpb25QaWNrTGlzdCkge1xuICAgICAgZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZCh0aGlzLnBvcHVwRmllbGRTZWxlY3Rpb25QaWNrTGlzdCk7XG4gICAgICB0aGlzLnBvcHVwRmllbGRTZWxlY3Rpb25QaWNrTGlzdCA9IG51bGw7XG4gICAgICB0aGlzLmRpc2FibGVQb3B1cFBhbmVsLmVtaXQoZmFsc2UpO1xuICAgIH1cbiAgfVxuICBjYWxjaXRlQmxvY2tUb2dnbGVIYW5kbGVyKCkge1xuICAgIHRoaXMuY2xvc2VQb3B1cFBvcG92ZXJzLmVtaXQoKTtcbiAgfVxuICBjYWxjaXRlTGlzdE9yZGVyQ2hhbmdlSGFuZGxlcihldmVudCkge1xuICAgIGNvbnN0IHRlbXBGaWVsZHMgPSBldmVudC5kZXRhaWw7XG4gICAgY29uc3QgdGVtcEZpZWxkSW5mb3MgPSBbXTtcbiAgICB0ZW1wRmllbGRzLmZvckVhY2goKGZpZWxkTmFtZSkgPT4ge1xuICAgICAgdGhpcy5wb3B1cENvbnRlbnQuZmllbGRJbmZvcy5maW5kKChmaWVsZCkgPT4ge1xuICAgICAgICBpZiAoZmllbGQuZmllbGROYW1lID09PSBmaWVsZE5hbWUpIHtcbiAgICAgICAgICByZXR1cm4gdGVtcEZpZWxkSW5mb3MucHVzaChmaWVsZCk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH0pO1xuICAgIHRoaXMucG9wdXBDb250ZW50LmZpZWxkSW5mb3MgPSB0ZW1wRmllbGRJbmZvcztcbiAgICB0aGlzLmludGVybmFsUG9wdXBVcGRhdGVkLmVtaXQoKTtcbiAgfVxuICAvLyBwcml2YXRlIG1ldGhvZHMgYW5kIHByb3BlcnRpZXNcbiAgYXN5bmMgZ2V0RmllbGRzQ29udGVudCgpIHtcbiAgICB2YXIgX2EsIF9iO1xuICAgIGxldCBmaWVsZEluZm9zID0gW107XG4gICAgaWYgKHRoaXMuY2hlY2tGb3JDcmVhdGVGaWVsZHNDb250ZW50KCkpIHtcbiAgICAgIGNvbnN0IFtwb3B1cFV0aWxzXSA9IGF3YWl0IGxvYWRNb2R1bGVzKFtcImVzcmkvc3VwcG9ydC9wb3B1cFV0aWxzXCJdKTtcbiAgICAgIC8vIGdldCBkZWZhdWx0IGZyb20gY3JlYXRlRmllbGRzQ29udGVudFxuICAgICAgY29uc3QgcG9wdXBVdGlsc0ZpZWxkSW5mbyA9IChfYiA9IHBvcHVwVXRpbHMuY3JlYXRlRmllbGRzQ29udGVudCh7XG4gICAgICAgIGZpZWxkczogYXdhaXQgZ2V0RmllbGRzRnJvbUxheWVyKHRoaXMubGF5ZXIpLFxuICAgICAgICBvYmplY3RJZEZpZWxkOiB0aGlzLmxheWVyLm9iamVjdElkRmllbGQsXG4gICAgICAgIGVkaXRGaWVsZHNJbmZvOiAoKF9hID0gdGhpcy5sYXllcikgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmVkaXRGaWVsZHNJbmZvKSB8fCBudWxsXG4gICAgICB9KSkgPT09IG51bGwgfHwgX2IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9iLmZpZWxkSW5mb3M7XG4gICAgICAvLyBwb3B1cFV0aWxzRmllbGRJbmZvIHNob3VsZCBoYXZlIGEgc3Vic2V0IG9mIGZpZWxkSW5mb01hcFxuICAgICAgLy8gYnV0IHdpdGggZGlmZmVyZW5jZXMgaW4gZm9ybWF0IGFuZCB2aXNpYmlsaXR5XG4gICAgICAhdGhpcy5maWVsZEluZm9NYXAgJiYgdGhpcy5zZXR1cEZpZWxkTWFwSW5mbygpO1xuICAgICAgcG9wdXBVdGlsc0ZpZWxkSW5mby5mb3JFYWNoKChmaWVsZEluZm8pID0+IHtcbiAgICAgICAgaWYgKHRoaXMuZmllbGRJbmZvTWFwLmhhcyhmaWVsZEluZm8uZmllbGROYW1lKSkge1xuICAgICAgICAgIGNvbnN0IHRlbXBGaWVsZEluZm8gPSB0aGlzLmZpZWxkSW5mb01hcC5nZXQoZmllbGRJbmZvLmZpZWxkTmFtZSk7XG4gICAgICAgICAgZmllbGRJbmZvcy5wdXNoKHRlbXBGaWVsZEluZm8uY2xvbmUoKSk7XG4gICAgICAgICAgZmllbGRJbmZvc1tmaWVsZEluZm9zLmxlbmd0aCAtIDFdLnZpc2libGUgPSB0cnVlO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICAgIC8vIGFkZCBleHByZXNzaW9ucyBhbmQgcmVsYXRpb25zaGlwIGZpZWxkcyBpcyB2aXNpYmxlID0gdHJ1ZVxuICAgICAgdGhpcy5wb3B1cFRlbXBsYXRlLmZpZWxkSW5mb3MuZm9yRWFjaCgoZmllbGRJbmZvKSA9PiB7XG4gICAgICAgIGlmICgoZmllbGRJbmZvLmZpZWxkTmFtZS5pbmNsdWRlcyhmaWVsZEluZm9QcmVmaXhFbnVtLmV4cHJlc3Npb24pIHx8XG4gICAgICAgICAgZmllbGRJbmZvLmZpZWxkTmFtZS5pbmNsdWRlcyhmaWVsZEluZm9QcmVmaXhFbnVtLnJlbGF0aW9uc2hpcCkpICYmXG4gICAgICAgICAgZmllbGRJbmZvLnZpc2libGUpIHtcbiAgICAgICAgICBmaWVsZEluZm9zLnB1c2goZmllbGRJbmZvLmNsb25lKCkpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICAvLyBmZWF0dXJlIHJlZHVjdGlvbiwgM3ggYW5kIGRlZmF1bHQgY2FzZVxuICAgICAgdGhpcy5wb3B1cFRlbXBsYXRlLmZpZWxkSW5mb3MuZm9yRWFjaCgoZmllbGRJbmZvKSA9PiB7XG4gICAgICAgIGZpZWxkSW5mby52aXNpYmxlICYmIGZpZWxkSW5mb3MucHVzaChmaWVsZEluZm8uY2xvbmUoKSk7XG4gICAgICB9KTtcbiAgICB9XG4gICAgcmV0dXJuIGZpZWxkSW5mb3M7XG4gIH1cbiAgY2hlY2tGb3JDcmVhdGVGaWVsZHNDb250ZW50KCkge1xuICAgIHZhciBfYSwgX2IsIF9jO1xuICAgIC8vIHJlZ3VsYXIgZmVhdHVyZSBvciBmZWF0dXJlIHJlZHVjdGlvblxuICAgIGlmICh0aGlzLmxheWVyRGlzcGxheVR5cGUgPT09IGxheWVyRGlzcGxheVR5cGVFbnVtLmZlYXR1cmUpIHtcbiAgICAgIC8vIGNoZWNrIDFzdCBjb250ZW50IGZvciAzeCBhbmQgZGVmYXVsdCB1c2UgY2FzZVxuICAgICAgaWYgKCgoX2IgPSAoX2EgPSB0aGlzLnBvcHVwVGVtcGxhdGUpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5jb250ZW50WzBdKSA9PT0gbnVsbCB8fCBfYiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2IudHlwZSkgPT09IFwiZmllbGRzXCIpIHtcbiAgICAgICAgaWYgKChfYyA9IHRoaXMucG9wdXBUZW1wbGF0ZS5jb250ZW50WzBdKSA9PT0gbnVsbCB8fCBfYyA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2MuZmllbGRJbmZvcykge1xuICAgICAgICAgIC8vIHVzZSBjcmVhdGVGaWVsZHNDb250ZW50XG4gICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgLy8gRGVmYXVsdCBvciBjb21pbmcgZnJvbSAzeC5cbiAgICAgICAgICAvLyBEb250IHVzZSBjcmVhdGVGaWVsZHNDb250ZW50LCBidXQgZGVwZW5kIG9uIGZpZWxkSW5mb3NcbiAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGVsc2Uge1xuICAgICAgICAvLyAxc3QgZWxlbWVudCBpcyBub3QgZmllbGQsIHVzZSBjcmVhdGVGaWVsZHNDb250ZW50XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfVxuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgIC8vIGZlYXR1cmUgcmVkdWN0aW9uXG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICB9XG4gIHJlbW92ZUJ0bkNsaWNrKGZpZWxkTmFtZSkge1xuICAgIHRoaXMuY2xvc2VQb3B1cFBvcG92ZXJzLmVtaXQoKTtcbiAgICB0aGlzLnBvcHVwQ29udGVudC5maWVsZEluZm9zLmZpbmQoKGZpZWxkSW5Db250ZW50LCBpbmRleCkgPT4ge1xuICAgICAgaWYgKGZpZWxkSW5Db250ZW50LmZpZWxkTmFtZSA9PT0gZmllbGROYW1lKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnBvcHVwQ29udGVudC5maWVsZEluZm9zLnNwbGljZShpbmRleCwgMSk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgdGhpcy5yZVJlbmRlciA9ICF0aGlzLnJlUmVuZGVyO1xuICB9XG4gIGdldFNlbGVjdGVkRmllbGRzKCkge1xuICAgIGNvbnN0IHNlbGVjdGVkRmllbGRzID0gW107XG4gICAgdGhpcy5wb3B1cENvbnRlbnQuZmllbGRJbmZvcy5mb3JFYWNoKChmaWVsZCkgPT4ge1xuICAgICAgc2VsZWN0ZWRGaWVsZHMucHVzaChmaWVsZC5maWVsZE5hbWUpO1xuICAgIH0pO1xuICAgIHJldHVybiBzZWxlY3RlZEZpZWxkcztcbiAgfVxuICAvLyBmaWVsZCBzZWxlY3Rpb24gZm9yIHRpdGxlIGFuZCBjYXB0aW9uXG4gIHBvcHVwRmllbGRTZWxlY3Rpb25QaWNrTGlzdENoYW5nZXMoZXZlbnQsIGZvcm1UeXBlKSB7XG4gICAgY29uc3Qgc2VsZWN0ZWRGaWVsZE5hbWUgPSBldmVudC5kZXRhaWwuc2VsZWN0ZWRGaWVsZHNbMF07XG4gICAgaWYgKGZvcm1UeXBlID09PSBcInRpdGxlXCIpIHtcbiAgICAgIHRoaXMuY29udGVudFRpdGxlLnZhbHVlID0gYWRkU2VsZWN0ZWRGaWVsZEF0Q3Vyc29yKHRoaXMuY29udGVudFRpdGxlLCBzZWxlY3RlZEZpZWxkTmFtZSk7XG4gICAgICB0aGlzLmNvbnRlbnRUaXRsZS5zZXRGb2N1cygpO1xuICAgICAgdGhpcy5wb3B1cENvbnRlbnQudGl0bGUgPSB0aGlzLmNvbnRlbnRUaXRsZS52YWx1ZTtcbiAgICB9XG4gICAgZWxzZSBpZiAoZm9ybVR5cGUgPT09IFwiZGVzY3JpcHRpb25cIikge1xuICAgICAgdGhpcy5jb250ZW50RGVzY3JpcHRpb24udmFsdWUgPSBhZGRTZWxlY3RlZEZpZWxkQXRDdXJzb3IodGhpcy5jb250ZW50RGVzY3JpcHRpb24sIHNlbGVjdGVkRmllbGROYW1lKTtcbiAgICAgIHRoaXMuY29udGVudERlc2NyaXB0aW9uLnNldEZvY3VzKCk7XG4gICAgICB0aGlzLnBvcHVwQ29udGVudC5kZXNjcmlwdGlvbiA9IHRoaXMuY29udGVudERlc2NyaXB0aW9uLnZhbHVlO1xuICAgIH1cbiAgICB0aGlzLmNsb3NlUG9wdXBQb3BvdmVycy5lbWl0KCk7XG4gICAgdGhpcy5yZVJlbmRlciA9ICF0aGlzLnJlUmVuZGVyO1xuICB9XG4gIHNldHVwRmllbGRNYXBJbmZvKCkge1xuICAgIHRoaXMuZmllbGRJbmZvTWFwID0gbmV3IE1hcCh0aGlzLnBvcHVwVGVtcGxhdGUuZmllbGRJbmZvcy5tYXAoKGZpZWxkSW5mbykgPT4gW1xuICAgICAgZmllbGRJbmZvLmZpZWxkTmFtZSxcbiAgICAgIGZpZWxkSW5mb1xuICAgIF0pKTtcbiAgfVxuICAvLyByZW5kb3IgbWV0aG9kc1xuICByZW5kZXIoKSB7XG4gICAgcmV0dXJuIChoKEhvc3QsIG51bGwsIGgoXCJjYWxjaXRlLWJsb2NrXCIsIHsgZGlyOiBnZXRFbGVtZW50RGlyKHRoaXMuaG9zdEVsZW1lbnQpLCBoZWFkaW5nOiB0aGlzLnN0cmluZ3MuZmllbGRzTGlzdCwgZGVzY3JpcHRpb246ICh0aGlzLnBvcHVwQ29udGVudC50aXRsZSAmJlxuICAgICAgICBgJHt0aGlzLnBvcHVwQ29udGVudC50aXRsZS5zdWJzdHJpbmcoMCwgMjUpfSR7dGhpcy5wb3B1cENvbnRlbnQudGl0bGUubGVuZ3RoID4gMjUgPyBcIi4uLlwiIDogXCJcIn1gKSB8fFxuICAgICAgICBgJHt0aGlzLnBvcHVwQ29udGVudC5maWVsZEluZm9zLmxlbmd0aH0vJHt0aGlzLnBvcHVwVGVtcGxhdGUuZmllbGRJbmZvcy5sZW5ndGh9ICR7dGhpcy5zdHJpbmdzLmF0dHJpYnV0ZXNfTH1gLCBjb2xsYXBzaWJsZTogdHJ1ZSwgb3BlbjogdGhpcy5ibG9ja09wZW4sIGRyYWdIYW5kbGU6IHRydWUgfSwgaChcImRpdlwiLCB7IGNsYXNzOiBcImlnbm9yZS1lbGVtZW50cy1zb3J0YWJsZVwiLCBzbG90OiBcImNvbnRyb2xcIiB9LCBoKFwiYXJjZ2lzLWNhbGNpdGUtYmxvY2stb3B0aW9uc1wiLCB7IHJlZjogKGVsKSA9PiAodGhpcy5ibG9ja09wdGlvbnMgPSBlbCksIGd1aWQ6IHRoaXMuZ3VpZCwgaW50bE9wdGlvbnM6IHRoaXMuc3RyaW5ncy5vcHRpb25zLCBpbnRsRGVsZXRlOiB0aGlzLnN0cmluZ3MuZGVsZXRlLCBpbnRsRHVwbGljYXRlOiB0aGlzLnN0cmluZ3MuZHVwbGljYXRlLCBjYWxjaXRlQmxvY2tPcHRpb25zOiB7IGhhc0RlbGV0ZTogdHJ1ZSwgaGFzRHVwbGljYXRlOiB0cnVlIH0gfSkpLCBoKFwiZGl2XCIsIHsgc2xvdDogXCJpY29uXCIgfSwgaChcImNhbGNpdGUtaWNvblwiLCB7IHNjYWxlOiBcIm1cIiwgaWNvbjogXCJmZWF0dXJlLWRldGFpbHNcIiB9KSksIGgoXCJkaXZcIiwgeyBjbGFzczogXCJpZ25vcmUtZWxlbWVudHMtc29ydGFibGVcIiB9LCB0aGlzLmZvcm1JbnB1dChcInRpdGxlXCIsIHRoaXMuc3RyaW5ncy50aXRsZSwgKGVsZW1lbnQpID0+IHtcbiAgICAgIHJldHVybiAodGhpcy5jb250ZW50VGl0bGUgPSBlbGVtZW50KTtcbiAgICB9LCB0aGlzLnBvcHVwQ29udGVudC50aXRsZSwgdGhpcy5zdHJpbmdzLmVudGVyVGl0bGVcbiAgICAvLyB0aGlzLnN0cmluZ3MudGl0bGVDb250ZXh0LnJlcGxhY2UoXCIke3RpdGxlQ29udGV4dH1cIiwgdGhpcy5zdHJpbmdzLmF0dHJpYnV0ZXNfTClcbiAgICApLCB0aGlzLmZvcm1JbnB1dChcImRlc2NyaXB0aW9uXCIsIHRoaXMuc3RyaW5ncy5kZXNjLCAoZWxlbWVudCkgPT4ge1xuICAgICAgcmV0dXJuICh0aGlzLmNvbnRlbnREZXNjcmlwdGlvbiA9IGVsZW1lbnQpO1xuICAgIH0sIHRoaXMucG9wdXBDb250ZW50LmRlc2NyaXB0aW9uLCB0aGlzLnN0cmluZ3MuZW50ZXJEZXNjcmlwdGlvblxuICAgIC8vIHRoaXMuc3RyaW5ncy5kZXNjcmlwdGlvbkNvbnRleHQucmVwbGFjZShcbiAgICAvLyAgIFwiJHtkZXNjcmlwdGlvbkNvbnRleHR9XCIsXG4gICAgLy8gICB0aGlzLnN0cmluZ3MuYXR0cmlidXRlc19MXG4gICAgLy8gKVxuICAgICksIGgoXCJjYWxjaXRlLWJ1dHRvblwiLCB7IGNsYXNzOiBDU1MkNC5tYW5hZ2VCdG4sIGFwcGVhcmFuY2U6IFwidHJhbnNwYXJlbnRcIiwgc2NhbGU6IFwibVwiLCB3aWR0aDogXCJmdWxsXCIsIGlkOiBcIm9wZW5NYW5hZ2VBdHRyaWJ1dGVzX0lkXCIsIG9uQ2xpY2s6IHRoaXMubWFuYWdlQnRuQ2xpY2sgfSwgdGhpcy5zdHJpbmdzLnNlbGVjdEF0dHJpYnV0ZXMpLCBoKFwiY2FsY2l0ZS12YWx1ZS1saXN0XCIsIHsgXCJkcmFnLWVuYWJsZWRcIjogdHJ1ZSB9LCB0aGlzLnBpY2tMaXN0KSkpKSk7XG4gIH1cbiAgZ2V0IGhvc3RFbGVtZW50KCkgeyByZXR1cm4gZ2V0RWxlbWVudCh0aGlzKTsgfVxufTtcbkFyY2dpc1BvcHVwQXR0cmlidXRlcy5zdHlsZSA9IGFyY2dpc1BvcHVwQXR0cmlidXRlc0NzcztcblxuY29uc3QgQ1NTJDMgPSB7XG4gIG1hbmFnZUJ0bjogXCJtYW5hZ2UtYnRuXCIsXG4gIGVuYWJsZUNvbHVtbjogXCJlbmFibGUtY29sdW1uXCIsXG4gIGVuYWJsZUNvbHVtbkxhYmVsOiBcImVuYWJsZS1jb2x1bW4tbGFiZWxcIixcbiAgQ29sdW1uU3dpdGNoOiBcImNvbHVtbi1zd2l0Y2hcIixcbiAgbm9ybWFsaXplQmxvY2s6IFwibm9ybWFsaXplLWJsb2NrXCIsXG4gIG5vcm1hbGl6ZUNvbnRlbnRCdXR0b25TZWN0aW9uOiBcIm5vcm1hbGl6ZS1jb250ZW50LWJ0bi1zZWN0aW9uXCIsXG4gIG5vcm1hbGl6ZUNvbnRlbnRCdXR0b246IFwibm9ybWFsaXplLWNvbnRlbnQtYnRuXCIsXG4gIG5vcm1hbGl6ZUNvbnRlbnRCdXR0b25UZXh0OiBcIm5vcm1hbGl6ZS1jb250ZW50LWJ0bi10ZXh0XCIsXG4gIG5vcm1hbGl6ZUNvbnRlbnRCdXR0b25JY29uOiBcIm5vcm1hbGl6ZS1jb250ZW50LWJ0bi1pY29uXCIsXG4gIHBvcG92ZXJDaGFydERpdjogXCJwb3BvdmVyLWNoYXJ0LWRpdlwiLFxuICBmb3JtSW5wdXRCdXR0b246IFwiZm9ybS1pbnB1dC1idXR0b25cIixcbiAgY2hhcnRHcm91cDogXCJjaGFydC1ncm91cFwiXG59O1xuXG5jb25zdCBhcmNnaXNQb3B1cENoYXJ0Q3NzID0gXCIubWFuYWdlLWJ0bntqdXN0aWZ5LWNvbnRlbnQ6ZmxleC1lbmR9LmVuYWJsZS1jb2x1bW57YmFja2dyb3VuZC1jb2xvcjp2YXIoLS1hcmNnaXMtYXBwLWJhY2tncm91bmQpO2Rpc3BsYXk6ZmxleDtwYWRkaW5nOnZhcigtLWFyY2dpcy1hcHAtY2FwLXNwYWNpbmctaGFsZikgdmFyKC0tYXJjZ2lzLWFwcC1zaWRlLXNwYWNpbmctcXVhcnRlcil9LmVuYWJsZS1jb2x1bW4tbGFiZWx7ZGlzcGxheTpmbGV4O2ZsZXgtZmxvdzpjb2x1bW4gbm93cmFwO2ZsZXg6MSAwIDAlO292ZXJmbG93OmhpZGRlbn0uY29sdW1uLXN3aXRjaHttYXJnaW46MDtmbGV4OjAgMCAwJTtqdXN0aWZ5LXNlbGY6ZmxleC1lbmR9Lm5vcm1hbGl6ZS1ibG9ja3twYWRkaW5nOjAgdmFyKC0tYXJjZ2lzLWFwcC1zaWRlLXNwYWNpbmctcXVhcnRlcil9Lm5vcm1hbGl6ZS1jb250ZW50LWJ0bi1zZWN0aW9ue2JhY2tncm91bmQtY29sb3I6dmFyKC0tYXJjZ2lzLWFwcC1iYWNrZ3JvdW5kKTttaW4td2lkdGg6MTAwJX0ubm9ybWFsaXplLWNvbnRlbnQtYnRue2JhY2tncm91bmQ6dmFyKC0tYXJjZ2lzLWFwcC1iYWNrZ3JvdW5kLWNsZWFyKTtib3JkZXI6MXB4IHNvbGlkIHZhcigtLWFyY2dpcy1hcHAtYm9yZGVyKTtib3JkZXItcmFkaXVzOnZhcigtLWFyY2dpcy1hcHAtYm9yZGVyLXJhZGl1cyk7ZGlzcGxheTpmbGV4O2FsaWduLWl0ZW1zOmNlbnRlcjtqdXN0aWZ5LWNvbnRlbnQ6c3BhY2UtYmV0d2VlbjtwYWRkaW5nOnZhcigtLWFyY2dpcy1hcHAtY2FwLXNwYWNpbmctaGFsZikgdmFyKC0tYXJjZ2lzLWFwcC1zaWRlLXNwYWNpbmctcXVhcnRlcik7Y3Vyc29yOnBvaW50ZXI7d2lkdGg6MTAwJTt0ZXh0LWFsaWduOnVuc2V0O3RyYW5zaXRpb246YmFja2dyb3VuZC1jb2xvciB2YXIoLS1hcmNnaXMtYXBwLWFuaW1hdGlvbi10aW1lLWZhc3QpIHZhcigtLWFyY2dpcy1hcHAtZWFzaW5nLWZ1bmN0aW9uKSwgYm9yZGVyLWNvbG9yIHZhcigtLWFyY2dpcy1hcHAtYW5pbWF0aW9uLXRpbWUtZmFzdCkgdmFyKC0tYXJjZ2lzLWFwcC1lYXNpbmctZnVuY3Rpb24pfS5ub3JtYWxpemUtY29udGVudC1idG46aG92ZXJ7YmFja2dyb3VuZC1jb2xvcjp2YXIoLS1hcmNnaXMtYXBwLWJhY2tncm91bmQtaG92ZXIpO2JvcmRlci1jb2xvcjp2YXIoLS1hcmNnaXMtYXBwLWJvcmRlci1ob3Zlcil9Lm5vcm1hbGl6ZS1jb250ZW50LWJ0bi10ZXh0e2ZvbnQtZmFtaWx5OnZhcigtLWFyY2dpcy1hcHAtZm9udC1mYW1pbHkpO2ZvbnQtc2l6ZTp2YXIoLS1hcmNnaXMtYXBwLWZvbnQtc2l6ZS0wKTtmbGV4OjAgMSBhdXRvO292ZXJmbG93OmhpZGRlbjtwYWRkaW5nOjAgdmFyKC0tYXJjZ2lzLWFwcC1zaWRlLXNwYWNpbmctZWlnaHRoKTt0ZXh0LW92ZXJmbG93OmVsbGlwc2lzO3doaXRlLXNwYWNlOm5vd3JhcH0ubm9ybWFsaXplLWNvbnRlbnQtYnRuLWljb257ZmxleDowIDAgMCU7cGFkZGluZzowIHZhcigtLWFyY2dpcy1hcHAtc2lkZS1zcGFjaW5nLWhhbGYpfS5wb3BvdmVyLWNoYXJ0LWRpdntiYWNrZ3JvdW5kLWNvbG9yOnZhcigtLWFyY2dpcy1hcHAtYmFja2dyb3VuZCk7cGFkZGluZzp2YXIoLS1hcmNnaXMtYXBwLWNhcC1zcGFjaW5nKSB2YXIoLS1hcmNnaXMtYXBwLXNpZGUtc3BhY2luZy1oYWxmKTttYXgtaGVpZ2h0OjYwdmh9LmZvcm0taW5wdXQtYnV0dG9ue2Rpc3BsYXk6ZmxleH0uZm9ybS1pbnB1dC1idXR0b24gY2FsY2l0ZS1pbnB1dFt0eXBlPXRleHRde2Rpc3BsYXk6ZmxleDtmbGV4LWZsb3c6Y29sdW1uIG5vd3JhcDtmbGV4OjEgMCAwJTtvdmVyZmxvdzpoaWRkZW59LmZvcm0taW5wdXQtYnV0dG9uIGNhbGNpdGUtYWN0aW9ue21hcmdpbjowO2ZsZXg6MCAwIDAlO2p1c3RpZnktc2VsZjpmbGV4LWVuZH0uY2hhcnQtZ3JvdXB7bWFyZ2luLWJvdHRvbTp2YXIoLS1hcmNnaXMtYXBwLWNhcC1zcGFjaW5nLWhhbGYpfS5jb2xvci1pY29ue3dpZHRoOjE4cHg7aGVpZ2h0OjE4cHg7Ym9yZGVyLXJhZGl1czo5MCV9XCI7XG5cbmNvbnN0IE1BWF9SQU1QX0NPTE9SUyA9IDEwO1xuY29uc3QgQXJjZ2lzUG9wdXBDaGFydCA9IGNsYXNzIHtcbiAgY29uc3RydWN0b3IoaG9zdFJlZikge1xuICAgIHJlZ2lzdGVySW5zdGFuY2UodGhpcywgaG9zdFJlZik7XG4gICAgdGhpcy5jbG9zZVBvcHVwUG9wb3ZlcnMgPSBjcmVhdGVFdmVudCh0aGlzLCBcImNsb3NlUG9wdXBQb3BvdmVyc1wiLCA3KTtcbiAgICB0aGlzLmNoYXJ0Q2hhbmdlZFJlUmVuZGVyID0gY3JlYXRlRXZlbnQodGhpcywgXCJjaGFydENoYW5nZWRSZVJlbmRlclwiLCA3KTtcbiAgICB0aGlzLm5vdGlmeU11bHRpTWVkaWFDaGFuZ2UgPSBjcmVhdGVFdmVudCh0aGlzLCBcIm5vdGlmeU11bHRpTWVkaWFDaGFuZ2VcIiwgNyk7XG4gICAgdGhpcy5sYXN0Q29sb3JzID0ge307XG4gICAgdGhpcy5waWNrTGlzdCA9IFtdO1xuICAgIHRoaXMuYXJjYWRlRXhwTWFwID0gbmV3IE1hcCgpO1xuICAgIHRoaXMuY29sb3JOb2RlcyA9IFtdO1xuICAgIHRoaXMucG9wdXBGaWVsZE1hbmFnZVBpY2tMaXN0Q2hhbmdlcyA9IChldmVudCkgPT4ge1xuICAgICAgdmFyIF9hLCBfYiwgX2MsIF9kLCBfZSwgX2YsIF9nLCBfaCwgX2osIF9rO1xuICAgICAgY29uc3QgeyBlc3JpTGFuZywgZXNyaUNvbG9yLCByZW5kZXJlckNvbG9ycyB9ID0gdGhpcztcbiAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgY29uc3Qgb2xkRmllbGRzID0gdGhpcy5jaGFydE1lZGlhSW5mby52YWx1ZS5maWVsZHM7XG4gICAgICBjb25zdCBuZXdGaWVsZHMgPSBldmVudC5kZXRhaWwuc2VsZWN0ZWRGaWVsZHM7XG4gICAgICB0aGlzLmNoYXJ0TWVkaWFJbmZvLnZhbHVlLmZpZWxkcyA9IG5ld0ZpZWxkcztcbiAgICAgIGlmICh0aGlzLmNoYXJ0TWVkaWFJbmZvLnR5cGUgPT09IFBvcHVwTXVsdGlNZWRpYVR5cGUubGluZUNoYXJ0KSB7XG4gICAgICAgIGlmICgoKF9hID0gdGhpcy5jaGFydE1lZGlhSW5mby52YWx1ZS5maWVsZHMpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5sZW5ndGgpICYmICEoKF9iID0gdGhpcy5jaGFydE1lZGlhSW5mby52YWx1ZS5jb2xvcnMpID09PSBudWxsIHx8IF9iID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYi5sZW5ndGgpKSB7XG4gICAgICAgICAgY29uc3QgZGVmYXVsdFNjaGVtZSA9IHRoaXMuZ2V0RGVmYXVsdENvbG9yU2NoZW1lKCk7XG4gICAgICAgICAgdGhpcy5jb2xvcnMgPSBbZGVmYXVsdFNjaGVtZS5jb2xvcnNbMF1dO1xuICAgICAgICAgIHRoaXMuY2hhcnRNZWRpYUluZm8udmFsdWUuY29sb3JzID0gZXNyaUxhbmcuY2xvbmUodGhpcy5jb2xvcnMpO1xuICAgICAgICAgIGZvcmNlVXBkYXRlKHRoaXMuaG9zdEVsZW1lbnQpO1xuICAgICAgICB9XG4gICAgICAgIGVsc2UgaWYgKCEoKF9jID0gdGhpcy5jaGFydE1lZGlhSW5mby52YWx1ZS5maWVsZHMpID09PSBudWxsIHx8IF9jID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYy5sZW5ndGgpICYmXG4gICAgICAgICAgKChfZCA9IHRoaXMuY2hhcnRNZWRpYUluZm8udmFsdWUuY29sb3JzKSA9PT0gbnVsbCB8fCBfZCA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2QubGVuZ3RoKSkge1xuICAgICAgICAgIHRoaXMuY29sb3JzID0gdW5kZWZpbmVkO1xuICAgICAgICAgIHRoaXMuY2hhcnRNZWRpYUluZm8udmFsdWUuY29sb3JzID0gdW5kZWZpbmVkO1xuICAgICAgICAgIGZvcmNlVXBkYXRlKHRoaXMuaG9zdEVsZW1lbnQpO1xuICAgICAgICB9XG4gICAgICAgIGlmICgoX2UgPSB0aGlzLmxhc3RDb2xvcnMucmFtcENvbG9ycykgPT09IG51bGwgfHwgX2UgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9lLmxlbmd0aCkge1xuICAgICAgICAgIGNvbnN0IGRlZmF1bHRTY2hlbWUgPSB0aGlzLmdldERlZmF1bHRDb2xvclNjaGVtZSgpO1xuICAgICAgICAgIHRoaXMubGFzdENvbG9ycy5yYW1wQ29sb3JzID0gKF9mID0gdGhpcy5jaGFydE1lZGlhSW5mbykgPT09IG51bGwgfHwgX2YgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9mLnZhbHVlLmZpZWxkcy5tYXAoKGZpZWxkLCBpZHgpID0+IHtcbiAgICAgICAgICAgIHZhciBfYTtcbiAgICAgICAgICAgIGNvbnN0IG9sZElkeCA9IG9sZEZpZWxkcy5pbmRleE9mKGZpZWxkKTtcbiAgICAgICAgICAgIHJldHVybiAoKG9sZElkeCA+IC0xICYmICgoX2EgPSB0aGlzLmxhc3RDb2xvcnMucmFtcENvbG9ycykgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hW29sZElkeF0pKSB8fFxuICAgICAgICAgICAgICBuZXcgZXNyaUNvbG9yKGRlZmF1bHRTY2hlbWUuY29sb3JzW2lkeCAlIE1BWF9SQU1QX0NPTE9SU10pIHx8XG4gICAgICAgICAgICAgIG5ldyBlc3JpQ29sb3IoWzAsIDAsIDAsIDFdKSk7XG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGVsc2Uge1xuICAgICAgICBpZiAoKF9nID0gdGhpcy5jaGFydE1lZGlhSW5mby52YWx1ZS5maWVsZHMpID09PSBudWxsIHx8IF9nID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfZy5sZW5ndGgpIHtcbiAgICAgICAgICBjb25zdCBkZWZhdWx0U2NoZW1lID0gdGhpcy5nZXREZWZhdWx0Q29sb3JTY2hlbWUoKTtcbiAgICAgICAgICB0aGlzLmNvbG9ycyA9IChfaCA9IHRoaXMuY2hhcnRNZWRpYUluZm8pID09PSBudWxsIHx8IF9oID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfaC52YWx1ZS5maWVsZHMubWFwKChmaWVsZE5hbWUsIGlkeCkgPT4ge1xuICAgICAgICAgICAgdmFyIF9hO1xuICAgICAgICAgICAgY29uc3Qgb2xkSWR4ID0gb2xkRmllbGRzLmluZGV4T2YoZmllbGROYW1lKTtcbiAgICAgICAgICAgIHJldHVybiAoKG9sZElkeCA+IC0xICYmICgoX2EgPSB0aGlzLmNvbG9ycykgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hW29sZElkeF0pKSB8fFxuICAgICAgICAgICAgICAocmVuZGVyZXJDb2xvcnMuZ2V0KGZpZWxkTmFtZSlcbiAgICAgICAgICAgICAgICA/IGVzcmlMYW5nLmNsb25lKHJlbmRlcmVyQ29sb3JzLmdldChmaWVsZE5hbWUpWzBdKVxuICAgICAgICAgICAgICAgIDogbmV3IGVzcmlDb2xvcihkZWZhdWx0U2NoZW1lLmNvbG9yc1tpZHggJSBNQVhfUkFNUF9DT0xPUlNdKSB8fFxuICAgICAgICAgICAgICAgICAgbmV3IGVzcmlDb2xvcihbMCwgMCwgMCwgMV0pKSk7XG4gICAgICAgICAgfSk7XG4gICAgICAgICAgaWYgKChfaiA9IHRoaXMuY2hhcnRNZWRpYUluZm8udmFsdWUuY29sb3JzKSA9PT0gbnVsbCB8fCBfaiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2oubGVuZ3RoKSB7XG4gICAgICAgICAgICB0aGlzLmNoYXJ0TWVkaWFJbmZvLnZhbHVlLmNvbG9ycyA9IGVzcmlMYW5nLmNsb25lKHRoaXMuY29sb3JzKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAvLyBkb24ndCBhdXRvIHNhdmUgY29sb3JzIG9uIHJlbW92ZTsgdXBkYXRlIHRvIG1ha2Ugc3VyZSBkZWZhdWx0IGNvbG9ycyBzdGlsbCBtYXRjaFxuICAgICAgICAgICAgdGhpcy5jb2xvcnMgPSBbXTtcbiAgICAgICAgICAgIHRoaXMuc2V0Q29sb3JzKCk7XG4gICAgICAgICAgICBmb3JjZVVwZGF0ZSh0aGlzLmhvc3RFbGVtZW50KTtcbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKG9sZEZpZWxkcyA9PT0gbnVsbCB8fCBvbGRGaWVsZHMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG9sZEZpZWxkcy5sZW5ndGgpIHtcbiAgICAgICAgICAgIHRoaXMuY29sb3JCdXR0b25Ob2RlICYmIGZvcmNlVXBkYXRlKHRoaXMuY29sb3JCdXR0b25Ob2RlKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICBmb3JjZVVwZGF0ZSh0aGlzLmhvc3RFbGVtZW50KTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgdGhpcy5jb2xvcnMgPSB1bmRlZmluZWQ7XG4gICAgICAgICAgdGhpcy5jaGFydE1lZGlhSW5mby52YWx1ZS5jb2xvcnMgPSB1bmRlZmluZWQ7XG4gICAgICAgICAgZm9yY2VVcGRhdGUodGhpcy5ob3N0RWxlbWVudCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHRoaXMuY2hhcnRDaGFuZ2VkUmVSZW5kZXIuZW1pdCgpO1xuICAgICAgaWYgKCEob2xkRmllbGRzID09PSBudWxsIHx8IG9sZEZpZWxkcyA9PT0gdm9pZCAwID8gdm9pZCAwIDogb2xkRmllbGRzLmxlbmd0aCkgfHwgISgoX2sgPSB0aGlzLmNoYXJ0TWVkaWFJbmZvLnZhbHVlLmZpZWxkcykgPT09IG51bGwgfHwgX2sgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9rLmxlbmd0aCkpIHtcbiAgICAgICAgZm9yY2VVcGRhdGUodGhpcy5ob3N0RWxlbWVudCk7XG4gICAgICB9XG4gICAgfTtcbiAgICB0aGlzLmZpZWxkUGlja0xpc3RDaGFuZ2VzID0gKGV2ZW50KSA9PiB7XG4gICAgICB2YXIgX2EsIF9iO1xuICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICBjb25zdCBzZWxlY3RlZEZpZWxkID0gKF9iID0gKF9hID0gZXZlbnQuZGV0YWlsKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2Euc2VsZWN0ZWRGaWVsZHMpID09PSBudWxsIHx8IF9iID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYlswXTtcbiAgICAgIGlmIChzZWxlY3RlZEZpZWxkKSB7XG4gICAgICAgIHRoaXMuY2hhcnRNZWRpYUluZm8udmFsdWUubm9ybWFsaXplRmllbGQgPSBzZWxlY3RlZEZpZWxkO1xuICAgICAgICB0aGlzLmNoYXJ0Q2hhbmdlZFJlUmVuZGVyLmVtaXQoKTtcbiAgICAgIH1cbiAgICAgIHRoaXMuY2xvc2VQb3B1cFBvcG92ZXJzLmVtaXQodGhpcy5ndWlkKTtcbiAgICAgIHRoaXMubm9ybWFsaXplQnRuLmZvY3VzKCk7XG4gICAgfTtcbiAgICAvLyBmaWVsZCBzZWxlY3Rpb24gZm9yIHRpdGxlIGFuZCBjYXB0aW9uXG4gICAgdGhpcy5wb3B1cEZpZWxkU2VsZWN0aW9uUGlja0xpc3RDaGFuZ2VzID0gKGV2ZW50LCBmb3JtVHlwZSkgPT4ge1xuICAgICAgY29uc3Qgc2VsZWN0ZWRGaWVsZE5hbWUgPSBldmVudC5kZXRhaWwuc2VsZWN0ZWRGaWVsZHNbMF07XG4gICAgICBpZiAoZm9ybVR5cGUgPT09IFwidGl0bGVcIikge1xuICAgICAgICB0aGlzLmVkaXRDaGFydFRpdGxlLnZhbHVlID0gYWRkU2VsZWN0ZWRGaWVsZEF0Q3Vyc29yKHRoaXMuZWRpdENoYXJ0VGl0bGUsIHNlbGVjdGVkRmllbGROYW1lKTtcbiAgICAgICAgdGhpcy5jaGFydE1lZGlhSW5mby50aXRsZSA9IHRoaXMuZWRpdENoYXJ0VGl0bGUudmFsdWU7XG4gICAgICAgIHRoaXMuZWRpdENoYXJ0VGl0bGUuc2V0Rm9jdXMoKTtcbiAgICAgIH1cbiAgICAgIGVsc2UgaWYgKGZvcm1UeXBlID09PSBcImNhcHRpb25cIikge1xuICAgICAgICB0aGlzLmVkaXRDaGFydENhcHRpb24udmFsdWUgPSBhZGRTZWxlY3RlZEZpZWxkQXRDdXJzb3IodGhpcy5lZGl0Q2hhcnRDYXB0aW9uLCBzZWxlY3RlZEZpZWxkTmFtZSk7XG4gICAgICAgIHRoaXMuY2hhcnRNZWRpYUluZm8uY2FwdGlvbiA9IHRoaXMuZWRpdENoYXJ0Q2FwdGlvbi52YWx1ZTtcbiAgICAgICAgdGhpcy5lZGl0Q2hhcnRDYXB0aW9uLnNldEZvY3VzKCk7XG4gICAgICB9XG4gICAgICBlbHNlIGlmIChmb3JtVHlwZSA9PT0gXCJhbHRUZXh0XCIpIHtcbiAgICAgICAgdGhpcy5lZGl0QWx0VGV4dC52YWx1ZSA9IGFkZFNlbGVjdGVkRmllbGRBdEN1cnNvcih0aGlzLmVkaXRBbHRUZXh0LCBzZWxlY3RlZEZpZWxkTmFtZSk7XG4gICAgICAgIHRoaXMuY2hhcnRNZWRpYUluZm8uYWx0VGV4dCA9IHRoaXMuZWRpdEFsdFRleHQudmFsdWU7XG4gICAgICAgIHRoaXMuZWRpdEFsdFRleHQuc2V0Rm9jdXMoKTtcbiAgICAgIH1cbiAgICAgIHRoaXMuY2xvc2VQb3B1cFBvcG92ZXJzLmVtaXQodGhpcy5ndWlkKTtcbiAgICAgIHRoaXMuY2hhcnRDaGFuZ2VkUmVSZW5kZXIuZW1pdCgpO1xuICAgIH07XG4gICAgdGhpcy5jaGFydEZvcm1JbnB1dCA9IChjaGFydEZvcm1JbnB1dFR5cGUpID0+IHtcbiAgICAgIHZhciBfYTtcbiAgICAgIHJldHVybiAoaChcImNhbGNpdGUtbGFiZWxcIiwgeyBzY2FsZTogXCJzXCIgfSwgKCgpID0+IHtcbiAgICAgICAgaWYgKGNoYXJ0Rm9ybUlucHV0VHlwZSA9PT0gXCJ0aXRsZVwiKSB7XG4gICAgICAgICAgcmV0dXJuIHRoaXMuc3RyaW5ncy50aXRsZTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIGlmIChjaGFydEZvcm1JbnB1dFR5cGUgPT09IFwiY2FwdGlvblwiKSB7XG4gICAgICAgICAgcmV0dXJuIHRoaXMuc3RyaW5ncy5jYXB0aW9uO1xuICAgICAgICB9XG4gICAgICAgIGVsc2UgaWYgKGNoYXJ0Rm9ybUlucHV0VHlwZSA9PT0gXCJhbHRUZXh0XCIpIHtcbiAgICAgICAgICByZXR1cm4gdGhpcy5zdHJpbmdzLmRlc2NyaXB0aW9uO1xuICAgICAgICB9XG4gICAgICB9KSgpLCBoKFwiZGl2XCIsIHsgY2xhc3M6IENTUyQzLmZvcm1JbnB1dEJ1dHRvbiB9LCBoKFwiY2FsY2l0ZS1pbnB1dFwiLCB7IHR5cGU6IFwidGV4dFwiLCBhdXRvZm9jdXM6IHRydWUsIHJlZjogKGVsZW1lbnQpID0+IHtcbiAgICAgICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoXCJjYWxjaXRlSW5wdXRDaGFuZ2VcIiwgKGV2ZW50KSA9PiB7XG4gICAgICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgICAgIGNvbnN0IGlucHV0VmFsID0gZXZlbnQudGFyZ2V0LnZhbHVlO1xuICAgICAgICAgICAgaWYgKGNoYXJ0Rm9ybUlucHV0VHlwZSA9PT0gXCJ0aXRsZVwiKSB7XG4gICAgICAgICAgICAgIHRoaXMuY2hhcnRNZWRpYUluZm8udGl0bGUgPSBpbnB1dFZhbDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2UgaWYgKGNoYXJ0Rm9ybUlucHV0VHlwZSA9PT0gXCJjYXB0aW9uXCIpIHtcbiAgICAgICAgICAgICAgdGhpcy5jaGFydE1lZGlhSW5mby5jYXB0aW9uID0gaW5wdXRWYWw7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIGlmIChjaGFydEZvcm1JbnB1dFR5cGUgPT09IFwiYWx0VGV4dFwiKSB7XG4gICAgICAgICAgICAgIHRoaXMuY2hhcnRNZWRpYUluZm8uYWx0VGV4dCA9IGlucHV0VmFsO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5jaGFydENoYW5nZWRSZVJlbmRlci5lbWl0KCk7XG4gICAgICAgICAgfSk7XG4gICAgICAgICAgaWYgKGNoYXJ0Rm9ybUlucHV0VHlwZSA9PT0gXCJ0aXRsZVwiKSB7XG4gICAgICAgICAgICByZXR1cm4gKHRoaXMuZWRpdENoYXJ0VGl0bGUgPSBlbGVtZW50KTtcbiAgICAgICAgICB9XG4gICAgICAgICAgZWxzZSBpZiAoY2hhcnRGb3JtSW5wdXRUeXBlID09PSBcImNhcHRpb25cIikge1xuICAgICAgICAgICAgcmV0dXJuICh0aGlzLmVkaXRDaGFydENhcHRpb24gPSBlbGVtZW50KTtcbiAgICAgICAgICB9XG4gICAgICAgICAgZWxzZSBpZiAoY2hhcnRGb3JtSW5wdXRUeXBlID09PSBcImFsdFRleHRcIikge1xuICAgICAgICAgICAgcmV0dXJuICh0aGlzLmVkaXRBbHRUZXh0ID0gZWxlbWVudCk7XG4gICAgICAgICAgfVxuICAgICAgICB9LCB2YWx1ZTogKCgpID0+IHtcbiAgICAgICAgICBpZiAoY2hhcnRGb3JtSW5wdXRUeXBlID09PSBcInRpdGxlXCIpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmNoYXJ0TWVkaWFJbmZvLnRpdGxlO1xuICAgICAgICAgIH1cbiAgICAgICAgICBlbHNlIGlmIChjaGFydEZvcm1JbnB1dFR5cGUgPT09IFwiY2FwdGlvblwiKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5jaGFydE1lZGlhSW5mby5jYXB0aW9uO1xuICAgICAgICAgIH1cbiAgICAgICAgICBlbHNlIGlmIChjaGFydEZvcm1JbnB1dFR5cGUgPT09IFwiYWx0VGV4dFwiKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5jaGFydE1lZGlhSW5mby5hbHRUZXh0O1xuICAgICAgICAgIH1cbiAgICAgICAgfSkoKSwgcGxhY2Vob2xkZXI6ICgoKSA9PiB7XG4gICAgICAgICAgaWYgKGNoYXJ0Rm9ybUlucHV0VHlwZSA9PT0gXCJ0aXRsZVwiKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5zdHJpbmdzLmltYWdlVGl0bGVQbGFjZUhvbGRlcjtcbiAgICAgICAgICB9XG4gICAgICAgICAgZWxzZSBpZiAoY2hhcnRGb3JtSW5wdXRUeXBlID09PSBcImNhcHRpb25cIikge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuc3RyaW5ncy5pbWFnZUNhcHRpb25QbGFjZUhvbGRlcjtcbiAgICAgICAgICB9XG4gICAgICAgICAgZWxzZSBpZiAoY2hhcnRGb3JtSW5wdXRUeXBlID09PSBcImFsdFRleHRcIikge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuc3RyaW5ncy5kZXNjcmliZUNoYXJ0O1xuICAgICAgICAgIH1cbiAgICAgICAgfSkoKSwgb25DbGljazogKCkgPT4gdGhpcy5jbG9zZVBvcHVwUG9wb3ZlcnMuZW1pdCh0aGlzLmd1aWQpIH0pLCAoKF9hID0gdGhpcy5wb3B1cFRlbXBsYXRlLmZpZWxkSW5mb3MpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5sZW5ndGgpID4gMCAmJiAoaChcImNhbGNpdGUtYWN0aW9uXCIsIHsgdGV4dDogdGhpcy5zdHJpbmdzLmF0dHJpYnV0ZXMsIFwidGV4dC1kaXNwbGF5XCI6IFwiaGlkZGVuXCIsIG9uQ2xpY2s6ICgpID0+IHtcbiAgICAgICAgICB2YXIgX2E7XG4gICAgICAgICAgdGhpcy5jbG9zZVBvcHVwUG9wb3ZlcnMuZW1pdCh0aGlzLmd1aWQpO1xuICAgICAgICAgIChfYSA9IHRoaXMuY29sb3JCdXR0b25Ob2RlKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EuY2xvc2VQb3BvdmVyKCk7XG4gICAgICAgICAgdGhpcy5jbG9zZUNvbG9yUG9wb3ZlcigpO1xuICAgICAgICAgIGlmICghdGhpcy5wb3B1cEZpZWxkU2VsZWN0aW9uUGlja0xpc3QpIHtcbiAgICAgICAgICAgIHRoaXMucG9wdXBGaWVsZFNlbGVjdGlvblBpY2tMaXN0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImFyY2dpcy1wb3B1cC1maWVsZC1waWNrLWxpc3RcIik7XG4gICAgICAgICAgICB0aGlzLnBvcHVwRmllbGRTZWxlY3Rpb25QaWNrTGlzdC5wb3BvdmVyUHJvcHMgPSB7XG4gICAgICAgICAgICAgIHJlZkVsZW1lbnQ6IHRoaXMucGFuZWxFbGVtZW50XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgdGhpcy5wb3B1cEZpZWxkU2VsZWN0aW9uUGlja0xpc3QubXVsdGlwbGUgPSBmYWxzZTtcbiAgICAgICAgICAgIHRoaXMucG9wdXBGaWVsZFNlbGVjdGlvblBpY2tMaXN0LmhlYWRpbmcgPSB0aGlzLnN0cmluZ3MuYWRkRmllbGQ7XG4gICAgICAgICAgICB0aGlzLnBvcHVwRmllbGRTZWxlY3Rpb25QaWNrTGlzdC5hZGRFdmVudExpc3RlbmVyKFwiYXJjZ2lzUG9wdXBQaWNrTGlzdERpc21pc3NlZFwiLCAoKSA9PiB7XG4gICAgICAgICAgICAgIHRoaXMuY2xvc2VQb3B1cFBvcG92ZXJzLmVtaXQodGhpcy5ndWlkKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgdGhpcy5wb3B1cEZpZWxkU2VsZWN0aW9uUGlja0xpc3QuYWRkRXZlbnRMaXN0ZW5lcihcImFyY2dpc1BvcHVwUGlja0xpc3RDaGFuZ2VcIiwgKGV2ZW50KSA9PiB0aGlzLnBvcHVwRmllbGRTZWxlY3Rpb25QaWNrTGlzdENoYW5nZXMoZXZlbnQsIGNoYXJ0Rm9ybUlucHV0VHlwZSkpO1xuICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZCh0aGlzLnBvcHVwRmllbGRTZWxlY3Rpb25QaWNrTGlzdCk7XG4gICAgICAgICAgICB0aGlzLnBhbmVsRWxlbWVudC5kaXNhYmxlZCA9IHRydWU7XG4gICAgICAgICAgfVxuICAgICAgICB9LCBzY2FsZTogXCJzXCIsIGljb246IFwiYnJhY2tldHMtY3VybHlcIiB9KSkpKSk7XG4gICAgfTtcbiAgICB0aGlzLmNhbGNpdGVQaWNrTGlzdCA9IChmaWVsZCwgaWR4KSA9PiAoaChcImNhbGNpdGUtbGlzdC1pdGVtXCIsIHsga2V5OiBmaWVsZC5maWVsZE5hbWUsIGxhYmVsOiBnZXRGaWVsZERpc3BsYXlOYW1lKGZpZWxkLCB0aGlzLmFyY2FkZUV4cE1hcCksIHZhbHVlOiBmaWVsZC5maWVsZE5hbWUgfSwgdGhpcy5yZW5kZXJDb2xvckljb24oaWR4KSwgaChcImNhbGNpdGUtYWN0aW9uXCIsIHsgc2xvdDogXCJhY3Rpb25zLWVuZFwiLCBhcHBlYXJhbmNlOiBcInRyYW5zcGFyZW50XCIsIHRleHQ6IHRoaXMuc3RyaW5ncy5yZW1vdmUsIG9uQ2xpY2s6ICgpID0+IHtcbiAgICAgICAgdmFyIF9hLCBfYiwgX2M7XG4gICAgICAgIHRoaXMuY2xvc2VQb3B1cFBvcG92ZXJzLmVtaXQodGhpcy5ndWlkKTtcbiAgICAgICAgKF9hID0gdGhpcy5jb2xvckJ1dHRvbk5vZGUpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5jbG9zZVBvcG92ZXIoKTtcbiAgICAgICAgdGhpcy5jbG9zZUNvbG9yUG9wb3ZlcigpO1xuICAgICAgICBpZiAoKF9iID0gdGhpcy5jaGFydE1lZGlhSW5mby52YWx1ZS5jb2xvcnMpID09PSBudWxsIHx8IF9iID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYi5sZW5ndGgpIHtcbiAgICAgICAgICB0aGlzLmNoYXJ0TWVkaWFJbmZvLnZhbHVlLmZpZWxkcy5mb3JFYWNoKChmaWVsZE5hbWUsIGlkeCkgPT4ge1xuICAgICAgICAgICAgdmFyIF9hO1xuICAgICAgICAgICAgaWYgKGZpZWxkTmFtZSA9PT0gZmllbGQuZmllbGROYW1lKSB7XG4gICAgICAgICAgICAgIHRoaXMuY2hhcnRNZWRpYUluZm8udmFsdWUuZmllbGRzLnNwbGljZShpZHgsIDEpO1xuICAgICAgICAgICAgICBpZiAodGhpcy5jaGFydE1lZGlhSW5mby50eXBlICE9PSBQb3B1cE11bHRpTWVkaWFUeXBlLmxpbmVDaGFydCkge1xuICAgICAgICAgICAgICAgIHRoaXMuY2hhcnRNZWRpYUluZm8udmFsdWUuY29sb3JzLnNwbGljZShpZHgsIDEpO1xuICAgICAgICAgICAgICAgIHRoaXMuY29sb3JzLnNwbGljZShpZHgsIDEpO1xuICAgICAgICAgICAgICAgIHRoaXMuY29sb3JCdXR0b25Ob2RlICYmIGZvcmNlVXBkYXRlKHRoaXMuY29sb3JCdXR0b25Ob2RlKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICBpZiAoKF9hID0gdGhpcy5sYXN0Q29sb3JzLnJhbXBDb2xvcnMpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmxhc3RDb2xvcnMucmFtcENvbG9ycy5zcGxpY2UoaWR4LCAxKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgIHRoaXMuY2hhcnRNZWRpYUluZm8udmFsdWUuZmllbGRzLmZvckVhY2goKGZpZWxkTmFtZSwgaWR4KSA9PiB7XG4gICAgICAgICAgICBpZiAoZmllbGROYW1lID09PSBmaWVsZC5maWVsZE5hbWUpIHtcbiAgICAgICAgICAgICAgdGhpcy5jaGFydE1lZGlhSW5mby52YWx1ZS5maWVsZHMuc3BsaWNlKGlkeCwgMSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSk7XG4gICAgICAgICAgLy8gZG9uJ3QgYXV0byBzYXZlIGNvbG9ycyBvbiByZW1vdmUvYWRkOyB1cGRhdGUgdG8gbWFrZSBzdXJlIGRlZmF1bHQgY29sb3JzIHN0aWxsIG1hdGNoXG4gICAgICAgICAgdGhpcy5jb2xvcnMgPSBbXTtcbiAgICAgICAgICB0aGlzLnNldENvbG9ycygpO1xuICAgICAgICAgIGZvcmNlVXBkYXRlKHRoaXMuaG9zdEVsZW1lbnQpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuY2hhcnRDaGFuZ2VkUmVSZW5kZXIuZW1pdCgpO1xuICAgICAgICBpZiAoISgoX2MgPSB0aGlzLmNoYXJ0TWVkaWFJbmZvLnZhbHVlLmZpZWxkcykgPT09IG51bGwgfHwgX2MgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9jLmxlbmd0aCkpIHtcbiAgICAgICAgICBmb3JjZVVwZGF0ZSh0aGlzLmhvc3RFbGVtZW50KTtcbiAgICAgICAgfVxuICAgICAgfSB9LCBoKFwiY2FsY2l0ZS1pY29uXCIsIHsgc2NhbGU6IFwic1wiLCBpY29uOiBcInhcIiB9KSkpKTtcbiAgICB0aGlzLmd1aWQgPSB1bmRlZmluZWQ7XG4gICAgdGhpcy5jaGFydE1lZGlhSW5mbyA9IHVuZGVmaW5lZDtcbiAgICB0aGlzLm1lZGlhQ29udGVudCA9IHVuZGVmaW5lZDtcbiAgICB0aGlzLm1lZGlhSW5kZXhQb3NpdGlvbiA9IHVuZGVmaW5lZDtcbiAgICB0aGlzLnJlZkVsZW1lbnQgPSB1bmRlZmluZWQ7XG4gICAgdGhpcy5pc09wZW4gPSBmYWxzZTtcbiAgICB0aGlzLnJlUmVuZGVyID0gdW5kZWZpbmVkO1xuICB9XG4gIC8vIGxpZmVjeWNsZSBtZXRob2RzXG4gIGFzeW5jIGNvbXBvbmVudFdpbGxMb2FkKCkge1xuICAgIHZhciBfYTtcbiAgICB0aGlzLmxheWVyID0gcG9wdXBTdGF0ZS5sYXllcjtcbiAgICB0aGlzLm1hcFZpZXcgPSBwb3B1cFN0YXRlLm1hcFZpZXc7XG4gICAgdGhpcy5zdHJpbmdzID0gcG9wdXBTdGF0ZS5zdHJpbmdzO1xuICAgIHRoaXMucG9wdXBUZW1wbGF0ZSA9IHBvcHVwU3RhdGUucG9wdXBUZW1wbGF0ZTtcbiAgICB0aGlzLmxheWVyRGlzcGxheVR5cGUgPSBwb3B1cFN0YXRlLmxheWVyRGlzcGxheVR5cGU7XG4gICAgdGhpcy5jaGFydE1lZGlhSW5mby50aXRsZSA9IHRoaXMuY2hhcnRNZWRpYUluZm8udGl0bGUgfHwgXCJcIjtcbiAgICB0aGlzLmNoYXJ0TWVkaWFJbmZvLmFsdFRleHQgPSB0aGlzLmNoYXJ0TWVkaWFJbmZvLmFsdFRleHQgfHwgXCJcIjtcbiAgICB0aGlzLmNoYXJ0TWVkaWFJbmZvLmNhcHRpb24gPSB0aGlzLmNoYXJ0TWVkaWFJbmZvLmNhcHRpb24gfHwgXCJcIjtcbiAgICBjb25zdCBbZXNyaUxhbmcsIGVzcmlDb2xvciwgcGllQ2hhcnRTY2hlbWVzLCByZW5kZXJlclV0aWxzXSA9IGF3YWl0IGxvYWRNb2R1bGVzKFtcbiAgICAgIFwiZXNyaS9jb3JlL2xhbmdcIixcbiAgICAgIFwiZXNyaS9Db2xvclwiLFxuICAgICAgXCJlc3JpL3NtYXJ0TWFwcGluZy9zeW1ib2xvZ3kvcGllQ2hhcnRcIixcbiAgICAgIFwiZXNyaS9yZW5kZXJlcnMvc3VwcG9ydC91dGlsc1wiXG4gICAgXSk7XG4gICAgdGhpcy5lc3JpTGFuZyA9IGVzcmlMYW5nO1xuICAgIHRoaXMuZXNyaUNvbG9yID0gZXNyaUNvbG9yO1xuICAgIHRoaXMucGllQ2hhcnRTY2hlbWVzID0gcGllQ2hhcnRTY2hlbWVzO1xuICAgIHRoaXMucmVuZGVyZXJVdGlscyA9IHJlbmRlcmVyVXRpbHM7XG4gICAgaWYgKFwicmVuZGVyZXJcIiBpbiB0aGlzLmxheWVyKSB7XG4gICAgICBsZXQgcmVuZGVyZXI7XG4gICAgICBpZiAodGhpcy5sYXllckRpc3BsYXlUeXBlID09PSBsYXllckRpc3BsYXlUeXBlRW51bS5jbHVzdGVyKSB7XG4gICAgICAgIHJlbmRlcmVyID0gdGhpcy5sYXllci5mZWF0dXJlUmVkdWN0aW9uLnJlbmRlcmVyO1xuICAgICAgfVxuICAgICAgZWxzZSB7XG4gICAgICAgIHJlbmRlcmVyID0gdGhpcy5sYXllci5yZW5kZXJlcjtcbiAgICAgIH1cbiAgICAgIGlmIChbXCJjbGFzcy1icmVha3NcIiwgXCJkb3QtZGVuc2l0eVwiLCBcImhlYXRtYXBcIiwgXCJwaWUtY2hhcnRcIiwgXCJzaW1wbGVcIiwgXCJ1bmlxdWUtdmFsdWVcIl0uaW5kZXhPZihyZW5kZXJlci50eXBlKSA+IC0xKSB7XG4gICAgICAgIHRoaXMucmVuZGVyZXJDb2xvcnMgPSBhd2FpdCB0aGlzLnJlbmRlcmVyVXRpbHMuZ2V0Q29sb3JzRnJvbVJlbmRlcmVyKHJlbmRlcmVyKTtcbiAgICAgIH1cbiAgICB9XG4gICAgdGhpcy5jb2xvcnMgPSBlc3JpTGFuZy5jbG9uZSgoX2EgPSB0aGlzLmNoYXJ0TWVkaWFJbmZvKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EudmFsdWUuY29sb3JzKSB8fCBbXTtcbiAgICB0aGlzLnNldENvbG9ycygpO1xuICB9XG4gIGNvbXBvbmVudERpZExvYWQoKSB7XG4gICAgdGhpcy5pc09wZW4gPSB0cnVlO1xuICAgIC8vIG5lZWQgdGltZW91dCBiZWNhdXNlIG9mIHJlLXJlbmRlclxuICAgIHNldFRpbWVvdXQoKCkgPT4gcmVxdWVzdEFuaW1hdGlvbkZyYW1lKCgpID0+IHRoaXMucGFuZWxFbGVtZW50LnNldEZvY3VzKCkpLCAzMDApO1xuICB9XG4gIGFzeW5jIGNvbXBvbmVudFdpbGxSZW5kZXIoKSB7XG4gICAgdGhpcy5maWVsZEluZm9NYXAgPSBuZXcgTWFwKHRoaXMucG9wdXBUZW1wbGF0ZS5maWVsZEluZm9zLm1hcCgoZmllbGRJbmZvKSA9PiBbXG4gICAgICBmaWVsZEluZm8uZmllbGROYW1lLFxuICAgICAgZmllbGRJbmZvXG4gICAgXSkpO1xuICAgIHRoaXMubGF5ZXJGaWVsZHNNYXAgPSBhd2FpdCBnZW5lcmF0ZUxheWVyRmllbGRzTWFwKHRoaXMubGF5ZXIpO1xuICAgIHRoaXMuYXJjYWRlRXhwTWFwID0gZ2VuZXJhdGVBcmNhZGVFeHByZXNzaW9uTWFwKHRoaXMucG9wdXBUZW1wbGF0ZSk7XG4gICAgdGhpcy5waWNrTGlzdCA9IFtdO1xuICAgIHRoaXMuY2hhcnRNZWRpYUluZm8udmFsdWUuZmllbGRzLmZvckVhY2goKGZpZWxkLCBpZHgpID0+IHtcbiAgICAgIHZhciBfYSwgX2I7XG4gICAgICBpZiAodGhpcy5maWVsZEluZm9NYXAuaGFzKGZpZWxkKSkge1xuICAgICAgICBjb25zdCBjdXJyZW50RmllbGRJbmZvID0gdGhpcy5maWVsZEluZm9NYXAuZ2V0KGZpZWxkKTtcbiAgICAgICAgdGhpcy5waWNrTGlzdC5wdXNoKHRoaXMuY2FsY2l0ZVBpY2tMaXN0KGN1cnJlbnRGaWVsZEluZm8sIGlkeCkpO1xuICAgICAgfVxuICAgICAgZWxzZSB7XG4gICAgICAgIC8vIGZpZWxkIGRvZXMgbm90IGV4aXN0IGFueW1vcmUsIHJlbW92ZVxuICAgICAgICB0aGlzLmNoYXJ0TWVkaWFJbmZvLnZhbHVlLmZpZWxkcy5zcGxpY2UoaWR4LCAxKTtcbiAgICAgICAgaWYgKHRoaXMuY2hhcnRNZWRpYUluZm8udHlwZSAhPT0gUG9wdXBNdWx0aU1lZGlhVHlwZS5saW5lQ2hhcnQpIHtcbiAgICAgICAgICBpZiAoKF9hID0gdGhpcy5jaGFydE1lZGlhSW5mby52YWx1ZS5jb2xvcnMpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5sZW5ndGgpIHtcbiAgICAgICAgICAgIHRoaXMuY2hhcnRNZWRpYUluZm8udmFsdWUuY29sb3JzLnNwbGljZShpZHgsIDEpO1xuICAgICAgICAgICAgdGhpcy5jb2xvcnMuc3BsaWNlKGlkeCwgMSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgY29uc3QgZGVmYXVsdFNjaGVtZSA9IHRoaXMuZ2V0RGVmYXVsdENvbG9yU2NoZW1lKCk7XG4gICAgICAgICAgICB0aGlzLmNvbG9ycyA9IChfYiA9IHRoaXMuY2hhcnRNZWRpYUluZm8pID09PSBudWxsIHx8IF9iID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYi52YWx1ZS5maWVsZHMubWFwKChmaWVsZE5hbWUsIGlkeCkgPT4ge1xuICAgICAgICAgICAgICB2YXIgX2E7XG4gICAgICAgICAgICAgIHJldHVybiB0aGlzLnJlbmRlcmVyQ29sb3JzLmdldChmaWVsZE5hbWUpXG4gICAgICAgICAgICAgICAgPyB0aGlzLmVzcmlMYW5nLmNsb25lKHRoaXMucmVuZGVyZXJDb2xvcnMuZ2V0KGZpZWxkTmFtZSlbMF0pXG4gICAgICAgICAgICAgICAgOiAoKF9hID0gdGhpcy5jb2xvcnMpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYVtpZHhdKSB8fFxuICAgICAgICAgICAgICAgICAgbmV3IHRoaXMuZXNyaUNvbG9yKGRlZmF1bHRTY2hlbWUuY29sb3JzW2lkeCAlIE1BWF9SQU1QX0NPTE9SU10pIHx8XG4gICAgICAgICAgICAgICAgICBuZXcgdGhpcy5lc3JpQ29sb3IoWzAsIDAsIDAsIDFdKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuICB9XG4gIGNvbXBvbmVudERpZFVwZGF0ZSgpIHtcbiAgICB0aGlzLm5vdGlmeU11bHRpTWVkaWFDaGFuZ2UuZW1pdCh7XG4gICAgICBndWlkOiB0aGlzLmd1aWQsXG4gICAgICBtZWRpYUluZGV4UG9zaXRpb246IHRoaXMubWVkaWFJbmRleFBvc2l0aW9uXG4gICAgfSk7XG4gICAgdGhpcy5jaGFydFBvcG92ZXIucmVwb3NpdGlvbigpO1xuICB9XG4gIGRpc2Nvbm5lY3RlZENhbGxiYWNrKCkge1xuICAgIHZhciBfYTtcbiAgICBpZiAodGhpcy5wb3B1cEZpZWxkU2VsZWN0aW9uUGlja0xpc3QpIHtcbiAgICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQodGhpcy5wb3B1cEZpZWxkU2VsZWN0aW9uUGlja0xpc3QpO1xuICAgIH1cbiAgICBpZiAodGhpcy5wb3B1cEZpZWxkTWFuYWdlUGlja0xpc3QpIHtcbiAgICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQodGhpcy5wb3B1cEZpZWxkTWFuYWdlUGlja0xpc3QpO1xuICAgIH1cbiAgICBpZiAodGhpcy5hcmNnaXNGaWVsZFBpY2tMaXN0KSB7XG4gICAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKHRoaXMuYXJjZ2lzRmllbGRQaWNrTGlzdCk7XG4gICAgfVxuICAgIChfYSA9IHRoaXMuY29sb3JCdXR0b25Ob2RlKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EuY2xvc2VQb3BvdmVyKCk7XG4gIH1cbiAgLy8gUHVibGljIE1ldGhvZHNcbiAgYXN5bmMgcmVwb3NpdGlvbigpIHtcbiAgICB0aGlzLmNoYXJ0UG9wb3Zlci5yZXBvc2l0aW9uKCk7XG4gIH1cbiAgLy8gRXZlbnRzXG4gIGNoYXJ0Q2hhbmdlZFJlUmVuZGVySGFuZGxlcihldmVudCkge1xuICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgIHRoaXMucmVSZW5kZXIgPSB0aGlzLnJlUmVuZGVyID8gZmFsc2UgOiB0cnVlO1xuICB9XG4gIGNsb3NlUG9wdXBQb3BvdmVyc0hhbmRsZXIoKSB7XG4gICAgdGhpcy5yZW1vdmVBdHRyaWJ1dGVzU2VsZWN0aW9uUG9wb3ZlcigpO1xuICB9XG4gIGNsb3NlTXVsdGlNZWRpYVBvcG92ZXJIYW5kbGVyKCkge1xuICAgIHRoaXMucmVtb3ZlQXR0cmlidXRlc1NlbGVjdGlvblBvcG92ZXIoKTtcbiAgfVxuICAvLyBhcmNhZGUgY2hhbmdlc1xuICBhcmNhZGVDaGFuZ2VOb3RpZmljYXRpb25IYW5kbGVyKCkge1xuICAgIHRoaXMuY2hhcnRDaGFuZ2VkUmVSZW5kZXIuZW1pdCgpO1xuICB9XG4gIC8vIHByaXZhdGUgbWV0aG9kcyBhbmQgcHJvcGVydGllc1xuICByZW1vdmVBdHRyaWJ1dGVzU2VsZWN0aW9uUG9wb3ZlcigpIHtcbiAgICBpZiAodGhpcy5wb3B1cEZpZWxkU2VsZWN0aW9uUGlja0xpc3QpIHtcbiAgICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQodGhpcy5wb3B1cEZpZWxkU2VsZWN0aW9uUGlja0xpc3QpO1xuICAgICAgdGhpcy5wb3B1cEZpZWxkU2VsZWN0aW9uUGlja0xpc3QgPSBudWxsO1xuICAgIH1cbiAgICBpZiAodGhpcy5wb3B1cEZpZWxkTWFuYWdlUGlja0xpc3QpIHtcbiAgICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQodGhpcy5wb3B1cEZpZWxkTWFuYWdlUGlja0xpc3QpO1xuICAgICAgdGhpcy5wb3B1cEZpZWxkTWFuYWdlUGlja0xpc3QgPSBudWxsO1xuICAgIH1cbiAgICBpZiAodGhpcy5hcmNnaXNGaWVsZFBpY2tMaXN0KSB7XG4gICAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKHRoaXMuYXJjZ2lzRmllbGRQaWNrTGlzdCk7XG4gICAgICB0aGlzLmFyY2dpc0ZpZWxkUGlja0xpc3QgPSBudWxsO1xuICAgIH1cbiAgICBpZiAodGhpcy5jb2xvclBvcG92ZXJOb2RlKSB7XG4gICAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKHRoaXMuY29sb3JQb3BvdmVyTm9kZSk7XG4gICAgICB0aGlzLmNvbG9yUG9wb3Zlck5vZGUgPSBudWxsO1xuICAgIH1cbiAgICB0aGlzLnBhbmVsRWxlbWVudC5kaXNhYmxlZCA9IGZhbHNlO1xuICB9XG4gIGFzeW5jIGNoYXJ0U2VsZWN0aW9uKGNoYXJ0VHlwZSkge1xuICAgIGNvbnN0IFtCYXJDaGFydE1lZGlhSW5mbywgQ29sdW1uQ2hhcnRNZWRpYUluZm8sIExpbmVDaGFydE1lZGlhSW5mbywgUGllQ2hhcnRNZWRpYUluZm9dID0gYXdhaXQgbG9hZE1vZHVsZXMoW1xuICAgICAgXCJlc3JpL3BvcHVwL2NvbnRlbnQvQmFyQ2hhcnRNZWRpYUluZm9cIixcbiAgICAgIFwiZXNyaS9wb3B1cC9jb250ZW50L0NvbHVtbkNoYXJ0TWVkaWFJbmZvXCIsXG4gICAgICBcImVzcmkvcG9wdXAvY29udGVudC9MaW5lQ2hhcnRNZWRpYUluZm9cIixcbiAgICAgIFwiZXNyaS9wb3B1cC9jb250ZW50L1BpZUNoYXJ0TWVkaWFJbmZvXCJcbiAgICBdKTtcbiAgICBsZXQgY2hhcnRFbGVtZW50ID0gbnVsbDtcbiAgICBpZiAoY2hhcnRUeXBlID09PSBQb3B1cE11bHRpTWVkaWFUeXBlLmJhckNoYXJ0KSB7XG4gICAgICBjaGFydEVsZW1lbnQgPSBuZXcgQmFyQ2hhcnRNZWRpYUluZm8oe1xuICAgICAgICB0aXRsZTogdGhpcy5jaGFydE1lZGlhSW5mby50aXRsZSxcbiAgICAgICAgY2FwdGlvbjogdGhpcy5jaGFydE1lZGlhSW5mby5jYXB0aW9uLFxuICAgICAgICB2YWx1ZTogdGhpcy5jaGFydE1lZGlhSW5mby52YWx1ZSxcbiAgICAgICAgYWx0VGV4dDogdGhpcy5jaGFydE1lZGlhSW5mby5hbHRUZXh0XG4gICAgICB9KTtcbiAgICB9XG4gICAgaWYgKGNoYXJ0VHlwZSA9PT0gUG9wdXBNdWx0aU1lZGlhVHlwZS5jb2x1bW5DaGFydCkge1xuICAgICAgY2hhcnRFbGVtZW50ID0gbmV3IENvbHVtbkNoYXJ0TWVkaWFJbmZvKHtcbiAgICAgICAgdGl0bGU6IHRoaXMuY2hhcnRNZWRpYUluZm8udGl0bGUsXG4gICAgICAgIGNhcHRpb246IHRoaXMuY2hhcnRNZWRpYUluZm8uY2FwdGlvbixcbiAgICAgICAgdmFsdWU6IHRoaXMuY2hhcnRNZWRpYUluZm8udmFsdWUsXG4gICAgICAgIGFsdFRleHQ6IHRoaXMuY2hhcnRNZWRpYUluZm8uYWx0VGV4dFxuICAgICAgfSk7XG4gICAgfVxuICAgIGlmIChjaGFydFR5cGUgPT09IFBvcHVwTXVsdGlNZWRpYVR5cGUubGluZUNoYXJ0KSB7XG4gICAgICBjaGFydEVsZW1lbnQgPSBuZXcgTGluZUNoYXJ0TWVkaWFJbmZvKHtcbiAgICAgICAgdGl0bGU6IHRoaXMuY2hhcnRNZWRpYUluZm8udGl0bGUsXG4gICAgICAgIGNhcHRpb246IHRoaXMuY2hhcnRNZWRpYUluZm8uY2FwdGlvbixcbiAgICAgICAgdmFsdWU6IHRoaXMuY2hhcnRNZWRpYUluZm8udmFsdWUsXG4gICAgICAgIGFsdFRleHQ6IHRoaXMuY2hhcnRNZWRpYUluZm8uYWx0VGV4dFxuICAgICAgfSk7XG4gICAgfVxuICAgIGlmIChjaGFydFR5cGUgPT09IFBvcHVwTXVsdGlNZWRpYVR5cGUucGllQ2hhcnQpIHtcbiAgICAgIGNoYXJ0RWxlbWVudCA9IG5ldyBQaWVDaGFydE1lZGlhSW5mbyh7XG4gICAgICAgIHRpdGxlOiB0aGlzLmNoYXJ0TWVkaWFJbmZvLnRpdGxlLFxuICAgICAgICBjYXB0aW9uOiB0aGlzLmNoYXJ0TWVkaWFJbmZvLmNhcHRpb24sXG4gICAgICAgIHZhbHVlOiB0aGlzLmNoYXJ0TWVkaWFJbmZvLnZhbHVlLFxuICAgICAgICBhbHRUZXh0OiB0aGlzLmNoYXJ0TWVkaWFJbmZvLmFsdFRleHRcbiAgICAgIH0pO1xuICAgIH1cbiAgICB0aGlzLmNoYXJ0TWVkaWFJbmZvID0gY2hhcnRFbGVtZW50LmNsb25lKCk7XG4gICAgdGhpcy5tZWRpYUNvbnRlbnQubWVkaWFJbmZvc1t0aGlzLm1lZGlhSW5kZXhQb3NpdGlvbl0gPSB0aGlzLmNoYXJ0TWVkaWFJbmZvO1xuICAgIHRoaXMuY2hhcnRDaGFuZ2VkUmVSZW5kZXIuZW1pdCgpO1xuICB9XG4gIGdldFN1bW1hcnlTdHJpbmcoKSB7XG4gICAgaWYgKHRoaXMuY2hhcnRNZWRpYUluZm8udHlwZSA9PT0gUG9wdXBNdWx0aU1lZGlhVHlwZS5iYXJDaGFydCkge1xuICAgICAgcmV0dXJuIHRoaXMuc3RyaW5ncy5iYXI7XG4gICAgfVxuICAgIGlmICh0aGlzLmNoYXJ0TWVkaWFJbmZvLnR5cGUgPT09IFBvcHVwTXVsdGlNZWRpYVR5cGUuY29sdW1uQ2hhcnQpIHtcbiAgICAgIHJldHVybiB0aGlzLnN0cmluZ3MuY29sdW1uO1xuICAgIH1cbiAgICBpZiAodGhpcy5jaGFydE1lZGlhSW5mby50eXBlID09PSBQb3B1cE11bHRpTWVkaWFUeXBlLmxpbmVDaGFydCkge1xuICAgICAgcmV0dXJuIHRoaXMuc3RyaW5ncy5saW5lO1xuICAgIH1cbiAgICBpZiAodGhpcy5jaGFydE1lZGlhSW5mby50eXBlID09PSBQb3B1cE11bHRpTWVkaWFUeXBlLnBpZUNoYXJ0KSB7XG4gICAgICByZXR1cm4gdGhpcy5zdHJpbmdzLnBpZTtcbiAgICB9XG4gIH1cbiAgLy8gcmVuZG9yIG1ldGhvZHNcbiAgcmVuZGVyKCkge1xuICAgIHZhciBfYSwgX2I7XG4gICAgY29uc3QgaGFzRmllbGRzID0gISEoKF9hID0gdGhpcy5jaGFydE1lZGlhSW5mby52YWx1ZS5maWVsZHMpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5sZW5ndGgpO1xuICAgIGNvbnN0IGNoYXJ0R3JvdXAgPSAoaChcImNhbGNpdGUtc2VnbWVudGVkLWNvbnRyb2xcIiwgeyB3aWR0aDogXCJmdWxsXCIsIHNjYWxlOiBcInNcIiwgY2xhc3M6IENTUyQzLmNoYXJ0R3JvdXAsIG9uQ2FsY2l0ZVNlZ21lbnRlZENvbnRyb2xDaGFuZ2U6IGFzeW5jIChldmVudCkgPT4ge1xuICAgICAgICB2YXIgX2E7XG4gICAgICAgIChfYSA9IHRoaXMuY29sb3JCdXR0b25Ob2RlKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EuY2xvc2VQb3BvdmVyKCk7XG4gICAgICAgIHRoaXMuY2xvc2VDb2xvclBvcG92ZXIoKTtcbiAgICAgICAgY29uc3Qgbm9kZSA9IGV2ZW50LnRhcmdldDtcbiAgICAgICAgY29uc3Qgc2VsZWN0ZWRJdGVtID0gbm9kZS5zZWxlY3RlZEl0ZW07XG4gICAgICAgIGlmICgodGhpcy5jaGFydE1lZGlhSW5mby50eXBlID09PSBQb3B1cE11bHRpTWVkaWFUeXBlLmxpbmVDaGFydCAmJlxuICAgICAgICAgIHNlbGVjdGVkSXRlbS52YWx1ZSAhPT0gUG9wdXBNdWx0aU1lZGlhVHlwZS5saW5lQ2hhcnQpIHx8XG4gICAgICAgICAgKHRoaXMuY2hhcnRNZWRpYUluZm8udHlwZSAhPT0gUG9wdXBNdWx0aU1lZGlhVHlwZS5saW5lQ2hhcnQgJiZcbiAgICAgICAgICAgIHNlbGVjdGVkSXRlbS52YWx1ZSA9PT0gUG9wdXBNdWx0aU1lZGlhVHlwZS5saW5lQ2hhcnQpKSB7XG4gICAgICAgICAgY29uc3Qgc2F2ZWRDb2xvcnMgPSB0aGlzLmNoYXJ0TWVkaWFJbmZvLnZhbHVlLmNvbG9ycztcbiAgICAgICAgICBpZiAodGhpcy5jaGFydE1lZGlhSW5mby50eXBlID09PSBQb3B1cE11bHRpTWVkaWFUeXBlLmxpbmVDaGFydCkge1xuICAgICAgICAgICAgdGhpcy5sYXN0Q29sb3JzLmxpbmVDb2xvcnMgPSBzYXZlZENvbG9ycyAmJiB0aGlzLmVzcmlMYW5nLmNsb25lKHNhdmVkQ29sb3JzKTtcbiAgICAgICAgICAgIHRoaXMuY29sb3JzID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgdGhpcy5jaGFydE1lZGlhSW5mby52YWx1ZS5jb2xvcnMgPSB1bmRlZmluZWQ7XG4gICAgICAgICAgfVxuICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5sYXN0Q29sb3JzLnJhbXBDb2xvcnMgPSBzYXZlZENvbG9ycyAmJiB0aGlzLmVzcmlMYW5nLmNsb25lKHNhdmVkQ29sb3JzKTtcbiAgICAgICAgICAgIGlmIChzZWxlY3RlZEl0ZW0udmFsdWUgPT09IFBvcHVwTXVsdGlNZWRpYVR5cGUubGluZUNoYXJ0KSB7XG4gICAgICAgICAgICAgIHRoaXMuY29sb3JzID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgICB0aGlzLmNoYXJ0TWVkaWFJbmZvLnZhbHVlLmNvbG9ycyA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHNlbGVjdGVkSXRlbS52YWx1ZSAhPT0gdGhpcy5jaGFydE1lZGlhSW5mby50eXBlKSB7XG4gICAgICAgICAgLy8gYmFyIGFuZCBjb2x1bW4gYXJlIGluIHNhbWUgcmFkaW8gZ3JvdXBcbiAgICAgICAgICAhKHNlbGVjdGVkSXRlbS52YWx1ZSA9PT0gUG9wdXBNdWx0aU1lZGlhVHlwZS5jb2x1bW5DaGFydCAmJlxuICAgICAgICAgICAgdGhpcy5jaGFydE1lZGlhSW5mby50eXBlID09PSBQb3B1cE11bHRpTWVkaWFUeXBlLmJhckNoYXJ0KSAmJiAoYXdhaXQgdGhpcy5jaGFydFNlbGVjdGlvbihzZWxlY3RlZEl0ZW0udmFsdWUpKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnNldENvbG9ycygpO1xuICAgICAgfSB9LCBoKFwiY2FsY2l0ZS1zZWdtZW50ZWQtY29udHJvbC1pdGVtXCIsIHsgdmFsdWU6IFBvcHVwTXVsdGlNZWRpYVR5cGUuY29sdW1uQ2hhcnQsIGljb25TdGFydDogXCJncmFwaC1iYXJcIiwgY2hlY2tlZDogdGhpcy5jaGFydE1lZGlhSW5mby50eXBlID09PSBQb3B1cE11bHRpTWVkaWFUeXBlLmNvbHVtbkNoYXJ0IHx8XG4gICAgICAgIHRoaXMuY2hhcnRNZWRpYUluZm8udHlwZSA9PT0gUG9wdXBNdWx0aU1lZGlhVHlwZS5iYXJDaGFydCB9LCB0aGlzLnN0cmluZ3MuYmFyKSwgaChcImNhbGNpdGUtc2VnbWVudGVkLWNvbnRyb2wtaXRlbVwiLCB7IHZhbHVlOiBQb3B1cE11bHRpTWVkaWFUeXBlLmxpbmVDaGFydCwgaWNvblN0YXJ0OiBcImdyYXBoLXRpbWUtc2VyaWVzXCIsIGNoZWNrZWQ6IHRoaXMuY2hhcnRNZWRpYUluZm8udHlwZSA9PT0gUG9wdXBNdWx0aU1lZGlhVHlwZS5saW5lQ2hhcnQgfSwgdGhpcy5zdHJpbmdzLmxpbmUpLCBoKFwiY2FsY2l0ZS1zZWdtZW50ZWQtY29udHJvbC1pdGVtXCIsIHsgdmFsdWU6IFBvcHVwTXVsdGlNZWRpYVR5cGUucGllQ2hhcnQsIGljb25TdGFydDogXCJwaWUtY2hhcnRcIiwgY2hlY2tlZDogdGhpcy5jaGFydE1lZGlhSW5mby50eXBlID09PSBQb3B1cE11bHRpTWVkaWFUeXBlLnBpZUNoYXJ0IH0sIHRoaXMuc3RyaW5ncy5waWUpKSk7XG4gICAgY29uc3QgY29sb3JCdXR0b24gPSAoaChcImFyY2dpcy1wb3B1cC1jb2xvci1idXR0b25cIiwgeyBjaGFydE1lZGlhSW5mbzogdGhpcy5jaGFydE1lZGlhSW5mbywgY29sb3JzOiB0aGlzLmNvbG9ycywgcG9wb3ZlclJlZmVyZW5jZUVsZW1lbnQ6IHRoaXMucGFuZWxFbGVtZW50LCBvbkFyY2dpc1BvcHVwQ29sb3JCdXR0b25DaGFuZ2U6ICh7IGRldGFpbDogY29sb3JzIH0pID0+IHtcbiAgICAgICAgdGhpcy5jb2xvcnMgPSBjb2xvcnM7XG4gICAgICAgIC8vIG9uY2UgdGhlIHVzZXIgbWFrZXMgYSBjaGFuZ2Ugd2Ugc2F2ZSBhbGwgY29sb3JzXG4gICAgICAgIHRoaXMuY2hhcnRNZWRpYUluZm8udmFsdWUuY29sb3JzID0gdGhpcy5lc3JpTGFuZy5jbG9uZShjb2xvcnMpO1xuICAgICAgICB0aGlzLmNoYXJ0Q2hhbmdlZFJlUmVuZGVyLmVtaXQoKTtcbiAgICAgIH0sIG9uQXJjZ2lzUG9wdXBDb2xvckJ1dHRvbkJlZm9yZU9wZW46ICgpID0+IHRoaXMuY2xvc2VDb2xvclBvcG92ZXIoKSwgcmVmOiAobm9kZSkgPT4gKHRoaXMuY29sb3JCdXR0b25Ob2RlID0gbm9kZSkgfSkpO1xuICAgIGNvbnN0IHJlc2V0QnV0dG9uID0gKGgoXCJjYWxjaXRlLWxhYmVsXCIsIHsgbGF5b3V0OiBcImlubGluZS1zcGFjZS1iZXR3ZWVuXCIgfSwgdGhpcy5zdHJpbmdzLnJlc2V0Q29sb3JzLCBoKFwiY2FsY2l0ZS1hY3Rpb25cIiwgeyBhcHBlYXJhbmNlOiBcInRyYW5zcGFyZW50XCIsIHRleHQ6IHRoaXMuc3RyaW5ncy5yZXNldENvbG9ycywgZGlzYWJsZWQ6ICEoKF9iID0gdGhpcy5jaGFydE1lZGlhSW5mby52YWx1ZS5jb2xvcnMpID09PSBudWxsIHx8IF9iID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYi5sZW5ndGgpLCBvbkNsaWNrOiAoKSA9PiB7XG4gICAgICAgIHZhciBfYTtcbiAgICAgICAgKF9hID0gdGhpcy5jb2xvckJ1dHRvbk5vZGUpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5jbG9zZVBvcG92ZXIoKTtcbiAgICAgICAgdGhpcy5jbG9zZUNvbG9yUG9wb3ZlcigpO1xuICAgICAgICB0aGlzLmNoYXJ0TWVkaWFJbmZvLnZhbHVlLmNvbG9ycyA9IG51bGw7XG4gICAgICAgIHRoaXMuY29sb3JzID0gW107XG4gICAgICAgIGlmICh0aGlzLmNoYXJ0TWVkaWFJbmZvLnR5cGUgPT09IFBvcHVwTXVsdGlNZWRpYVR5cGUubGluZUNoYXJ0KSB7XG4gICAgICAgICAgdGhpcy5sYXN0Q29sb3JzLmxpbmVDb2xvcnMgPSB1bmRlZmluZWQ7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgdGhpcy5sYXN0Q29sb3JzLnJhbXBDb2xvcnMgPSB1bmRlZmluZWQ7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5zZXRDb2xvcnMoKTtcbiAgICAgICAgZm9yY2VVcGRhdGUodGhpcy5ob3N0RWxlbWVudCk7XG4gICAgICB9IH0sIGgoXCJjYWxjaXRlLWljb25cIiwgeyBzY2FsZTogXCJzXCIsIGljb246IFwicmVzZXRcIiB9KSkpKTtcbiAgICAvLyBtYW5hZ2UgYnV0dG9uIGFuZCBsaXN0IG9mIHNlbGVjdGVkIGZpZWxkc1xuICAgIGNvbnN0IGZpZWxkTGlzdCA9IChoKFwiZGl2XCIsIG51bGwsIGgoXCJjYWxjaXRlLWJ1dHRvblwiLCB7IGNsYXNzOiBDU1MkMy5tYW5hZ2VCdG4sIGFwcGVhcmFuY2U6IFwidHJhbnNwYXJlbnRcIiwgc2NhbGU6IFwibVwiLCB3aWR0aDogXCJmdWxsXCIsIG9uQ2xpY2s6IGFzeW5jIChldmVudCkgPT4ge1xuICAgICAgICB2YXIgX2EsIF9iLCBfYztcbiAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgIHRoaXMuY2xvc2VQb3B1cFBvcG92ZXJzLmVtaXQodGhpcy5ndWlkKTtcbiAgICAgICAgKF9hID0gdGhpcy5jb2xvckJ1dHRvbk5vZGUpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5jbG9zZVBvcG92ZXIoKTtcbiAgICAgICAgdGhpcy5jbG9zZUNvbG9yUG9wb3ZlcigpO1xuICAgICAgICBpZiAoIXRoaXMucG9wdXBGaWVsZE1hbmFnZVBpY2tMaXN0KSB7XG4gICAgICAgICAgdGhpcy5wb3B1cEZpZWxkTWFuYWdlUGlja0xpc3QgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiYXJjZ2lzLXBvcHVwLWZpZWxkLXBpY2stbGlzdFwiKTtcbiAgICAgICAgICB0aGlzLnBvcHVwRmllbGRNYW5hZ2VQaWNrTGlzdC5wb3BvdmVyUHJvcHMgPSB7XG4gICAgICAgICAgICByZWZFbGVtZW50OiB0aGlzLnBhbmVsRWxlbWVudFxuICAgICAgICAgIH07XG4gICAgICAgICAgdGhpcy5wb3B1cEZpZWxkTWFuYWdlUGlja0xpc3Quc2VsZWN0ZWRGaWVsZHMgPVxuICAgICAgICAgICAgKChfYyA9IChfYiA9IHRoaXMuY2hhcnRNZWRpYUluZm8pID09PSBudWxsIHx8IF9iID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYi52YWx1ZSkgPT09IG51bGwgfHwgX2MgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9jLmZpZWxkcykgfHwgW107XG4gICAgICAgICAgdGhpcy5wb3B1cEZpZWxkTWFuYWdlUGlja0xpc3Quc2hvd0NhbmNlbCA9IGZhbHNlO1xuICAgICAgICAgIHRoaXMucG9wdXBGaWVsZE1hbmFnZVBpY2tMaXN0Lm11bHRpcGxlID0gdHJ1ZTtcbiAgICAgICAgICB0aGlzLnBvcHVwRmllbGRNYW5hZ2VQaWNrTGlzdC5oZWFkaW5nID0gdGhpcy5zdHJpbmdzLnNlbGVjdEZpZWxkcztcbiAgICAgICAgICB0aGlzLnBvcHVwRmllbGRNYW5hZ2VQaWNrTGlzdC5va0J0blRleHQgPSB0aGlzLnN0cmluZ3MuZG9uZTtcbiAgICAgICAgICB0aGlzLnBvcHVwRmllbGRNYW5hZ2VQaWNrTGlzdC5udW1iZXJzT25seSA9IHRydWU7XG4gICAgICAgICAgdGhpcy5wb3B1cEZpZWxkTWFuYWdlUGlja0xpc3QuYWRkRXZlbnRMaXN0ZW5lcihcImFyY2dpc1BvcHVwUGlja0xpc3REaXNtaXNzZWRcIiwgKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5jbG9zZVBvcHVwUG9wb3ZlcnMuZW1pdCh0aGlzLmd1aWQpO1xuICAgICAgICAgIH0pO1xuICAgICAgICAgIHRoaXMucG9wdXBGaWVsZE1hbmFnZVBpY2tMaXN0LmFkZEV2ZW50TGlzdGVuZXIoXCJhcmNnaXNQb3B1cFBpY2tMaXN0Q2hhbmdlXCIsIHRoaXMucG9wdXBGaWVsZE1hbmFnZVBpY2tMaXN0Q2hhbmdlcyk7XG4gICAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZCh0aGlzLnBvcHVwRmllbGRNYW5hZ2VQaWNrTGlzdCk7XG4gICAgICAgICAgdGhpcy5wYW5lbEVsZW1lbnQuZGlzYWJsZWQgPSB0cnVlO1xuICAgICAgICB9XG4gICAgICB9IH0sIHRoaXMuc3RyaW5ncy5zZWxlY3RBdHRyaWJ1dGVzKSwgaChcImNhbGNpdGUtbGlzdFwiLCB7IFwiZHJhZy1lbmFibGVkXCI6IHRydWUsIG9uQ2FsY2l0ZUxpc3RPcmRlckNoYW5nZTogYXN5bmMgKGV2ZW50KSA9PiB7XG4gICAgICAgIHZhciBfYSwgX2I7XG4gICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICBjb25zdCBhbGxJdGVtcyA9IGV2ZW50LnRhcmdldC5xdWVyeVNlbGVjdG9yQWxsKFwiY2FsY2l0ZS1saXN0LWl0ZW1cIik7XG4gICAgICAgIGNvbnN0IG5ld0luZGV4T3JkZXIgPSBbXTtcbiAgICAgICAgYWxsSXRlbXMuZm9yRWFjaCgoaXRlbSkgPT4ge1xuICAgICAgICAgIHRoaXMuY2hhcnRNZWRpYUluZm8udmFsdWUuZmllbGRzLmZvckVhY2goKGZpZWxkLCBpZHgpID0+IHtcbiAgICAgICAgICAgIGlmIChpdGVtLnZhbHVlID09PSBmaWVsZCkge1xuICAgICAgICAgICAgICBuZXdJbmRleE9yZGVyLnB1c2goaWR4KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgICAgIGlmICh0aGlzLmNoYXJ0TWVkaWFJbmZvLnR5cGUgPT09IFBvcHVwTXVsdGlNZWRpYVR5cGUubGluZUNoYXJ0KSB7XG4gICAgICAgICAgdGhpcy5jaGFydE1lZGlhSW5mby52YWx1ZS5maWVsZHMgPSBBcnJheS5mcm9tKGFsbEl0ZW1zKS5tYXAoKGl0ZW0pID0+IGl0ZW0udmFsdWUpO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgIGlmICghKChfYSA9IHRoaXMuY2hhcnRNZWRpYUluZm8udmFsdWUuY29sb3JzKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EubGVuZ3RoKSkge1xuICAgICAgICAgICAgLy8gb25jZSB0aGUgdXNlciBtYWtlcyBhIHJlLW9yZGVyIGNoYW5nZSB3ZSBzYXZlIGFsbCBjb2xvcnNcbiAgICAgICAgICAgIHRoaXMuY2hhcnRNZWRpYUluZm8udmFsdWUuY29sb3JzID0gdGhpcy5lc3JpTGFuZy5jbG9uZSh0aGlzLmNvbG9ycyk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGNvbnN0IG5ld0ZpZWxkcyA9IFtdO1xuICAgICAgICAgIGNvbnN0IG5ld0NvbG9ycyA9IFtdO1xuICAgICAgICAgIG5ld0luZGV4T3JkZXIuZm9yRWFjaCgoaWR4KSA9PiB7XG4gICAgICAgICAgICBuZXdGaWVsZHMucHVzaCh0aGlzLmNoYXJ0TWVkaWFJbmZvLnZhbHVlLmZpZWxkc1tpZHhdKTtcbiAgICAgICAgICAgIG5ld0NvbG9ycy5wdXNoKHRoaXMuZXNyaUxhbmcuY2xvbmUodGhpcy5jaGFydE1lZGlhSW5mby52YWx1ZS5jb2xvcnNbaWR4XSkpO1xuICAgICAgICAgIH0pO1xuICAgICAgICAgIHRoaXMuY2hhcnRNZWRpYUluZm8udmFsdWUuZmllbGRzID0gbmV3RmllbGRzO1xuICAgICAgICAgIHRoaXMuY29sb3JzID0gbmV3Q29sb3JzO1xuICAgICAgICAgIC8vIHdlIHNhdmUgY29sb3JzIG9uIHJlLW9yZGVyXG4gICAgICAgICAgdGhpcy5jaGFydE1lZGlhSW5mby52YWx1ZS5jb2xvcnMgPSB0aGlzLmVzcmlMYW5nLmNsb25lKG5ld0NvbG9ycyk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKChfYiA9IHRoaXMubGFzdENvbG9ycy5yYW1wQ29sb3JzKSA9PT0gbnVsbCB8fCBfYiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2IubGVuZ3RoKSB7XG4gICAgICAgICAgY29uc3QgcmFtcENvbG9ycyA9IFtdO1xuICAgICAgICAgIG5ld0luZGV4T3JkZXIuZm9yRWFjaCgoaWR4KSA9PiB7XG4gICAgICAgICAgICByYW1wQ29sb3JzLnB1c2godGhpcy5sYXN0Q29sb3JzLnJhbXBDb2xvcnNbaWR4XSk7XG4gICAgICAgICAgfSk7XG4gICAgICAgICAgdGhpcy5sYXN0Q29sb3JzLnJhbXBDb2xvcnMgPSByYW1wQ29sb3JzO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuY2hhcnRDaGFuZ2VkUmVSZW5kZXIuZW1pdCgpO1xuICAgICAgfSB9LCB0aGlzLnBpY2tMaXN0KSkpO1xuICAgIC8vIGJhciBjaGFydCBjaGVja2JveCBvbmx5IHVuZGVyIGRlZmF1bHQgY29sdW1uLWNoYXJ0XG4gICAgY29uc3QgYmFyQ2hhcnQgPSAodGhpcy5jaGFydE1lZGlhSW5mby50eXBlID09PSBQb3B1cE11bHRpTWVkaWFUeXBlLmJhckNoYXJ0IHx8XG4gICAgICB0aGlzLmNoYXJ0TWVkaWFJbmZvLnR5cGUgPT09IFBvcHVwTXVsdGlNZWRpYVR5cGUuY29sdW1uQ2hhcnQpICYmIChoKFwic2VjdGlvblwiLCB7IGNsYXNzOiBDU1MkMy5lbmFibGVDb2x1bW4gfSwgaChcImxhYmVsXCIsIHsgY2xhc3M6IENTUyQzLmVuYWJsZUNvbHVtbkxhYmVsIH0sIHRoaXMuc3RyaW5ncy5ob3Jpem9udGFsT3JpZW50YXRpb24pLCBoKFwiY2FsY2l0ZS1zd2l0Y2hcIiwgeyBzY2FsZTogXCJzXCIsIGNsYXNzOiBDU1MkMy5Db2x1bW5Td2l0Y2gsIGNoZWNrZWQ6IHRoaXMuY2hhcnRNZWRpYUluZm8udHlwZSA9PT0gUG9wdXBNdWx0aU1lZGlhVHlwZS5iYXJDaGFydCA/IHRydWUgOiBmYWxzZSwgb25DYWxjaXRlU3dpdGNoQ2hhbmdlOiBhc3luYyAoZXZlbnQpID0+IHtcbiAgICAgICAgdmFyIF9hO1xuICAgICAgICBhd2FpdCB0aGlzLmNoYXJ0U2VsZWN0aW9uKCgoX2EgPSBldmVudC50YXJnZXQpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5jaGVja2VkKVxuICAgICAgICAgID8gUG9wdXBNdWx0aU1lZGlhVHlwZS5iYXJDaGFydFxuICAgICAgICAgIDogUG9wdXBNdWx0aU1lZGlhVHlwZS5jb2x1bW5DaGFydCk7XG4gICAgICB9IH0pKSk7XG4gICAgY29uc3Qgbm9ybWFsaXplRmllbGQgPSAoaChcImNhbGNpdGUtYmxvY2stc2VjdGlvblwiLCB7IGNsYXNzOiBDU1MkMy5ub3JtYWxpemVCbG9jaywgdGV4dDogdGhpcy5zdHJpbmdzLm5vcm1hbGl6ZSwgdG9nZ2xlRGlzcGxheTogXCJzd2l0Y2hcIiwgb3BlbjogdGhpcy5jaGFydE1lZGlhSW5mby52YWx1ZS5ub3JtYWxpemVGaWVsZCA/IHRydWUgOiBmYWxzZSwgb25DYWxjaXRlQmxvY2tTZWN0aW9uVG9nZ2xlOiAoZXZlbnQpID0+IHtcbiAgICAgICAgaWYgKGV2ZW50LnRhcmdldC5vcGVuKSB7XG4gICAgICAgICAgdGhpcy5jaGFydE1lZGlhSW5mby52YWx1ZS5ub3JtYWxpemVGaWVsZCA9IHRoaXMudGVtcE5vcm1hbGl6ZWRGaWVsZDtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICB0aGlzLnRlbXBOb3JtYWxpemVkRmllbGQgPSB0aGlzLmNoYXJ0TWVkaWFJbmZvLnZhbHVlLm5vcm1hbGl6ZUZpZWxkO1xuICAgICAgICAgIHRoaXMuY2hhcnRNZWRpYUluZm8udmFsdWUubm9ybWFsaXplRmllbGQgPSBcIlwiO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuY2hhcnRDaGFuZ2VkUmVSZW5kZXIuZW1pdCgpO1xuICAgICAgfSB9LCBoKFwiZGl2XCIsIHsgY2xhc3M6IENTUyQzLm5vcm1hbGl6ZUNvbnRlbnRCdXR0b25TZWN0aW9uIH0sIGgoXCJidXR0b25cIiwgeyByZWY6IChlbCkgPT4gKHRoaXMubm9ybWFsaXplQnRuID0gZWwpLCBjbGFzczogQ1NTJDMubm9ybWFsaXplQ29udGVudEJ1dHRvbiwgdGl0bGU6IHRoaXMuc3RyaW5ncy5ub3JtYWxpemVCeSwgb25DbGljazogKGV2ZW50KSA9PiB7XG4gICAgICAgIHZhciBfYTtcbiAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgIHRoaXMuY2xvc2VQb3B1cFBvcG92ZXJzLmVtaXQodGhpcy5ndWlkKTtcbiAgICAgICAgKF9hID0gdGhpcy5jb2xvckJ1dHRvbk5vZGUpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5jbG9zZVBvcG92ZXIoKTtcbiAgICAgICAgdGhpcy5jbG9zZUNvbG9yUG9wb3ZlcigpO1xuICAgICAgICAvLyBsYXp5IGxvYWQgYXR0cmlidXRlIHNlbGVjdGlvbiBjb21wb25lbnRcbiAgICAgICAgaWYgKCF0aGlzLmFyY2dpc0ZpZWxkUGlja0xpc3QpIHtcbiAgICAgICAgICB0aGlzLmFyY2dpc0ZpZWxkUGlja0xpc3QgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiYXJjZ2lzLXBvcHVwLWZpZWxkLXBpY2stbGlzdFwiKTtcbiAgICAgICAgICB0aGlzLmFyY2dpc0ZpZWxkUGlja0xpc3QucG9wb3ZlclByb3BzID0ge1xuICAgICAgICAgICAgcmVmRWxlbWVudDogdGhpcy5wYW5lbEVsZW1lbnRcbiAgICAgICAgICB9O1xuICAgICAgICAgIHRoaXMuYXJjZ2lzRmllbGRQaWNrTGlzdC5zZWxlY3RlZEZpZWxkcyA9IFtcbiAgICAgICAgICAgIHRoaXMuY2hhcnRNZWRpYUluZm8udmFsdWUubm9ybWFsaXplRmllbGRcbiAgICAgICAgICBdO1xuICAgICAgICAgIHRoaXMuYXJjZ2lzRmllbGRQaWNrTGlzdC5udW1iZXJzT25seSA9IHRydWU7XG4gICAgICAgICAgdGhpcy5hcmNnaXNGaWVsZFBpY2tMaXN0LmFkZEV2ZW50TGlzdGVuZXIoXCJhcmNnaXNQb3B1cFBpY2tMaXN0RGlzbWlzc2VkXCIsIHRoaXMuZmllbGRQaWNrTGlzdENoYW5nZXMpO1xuICAgICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQodGhpcy5hcmNnaXNGaWVsZFBpY2tMaXN0KTtcbiAgICAgICAgICB0aGlzLnBhbmVsRWxlbWVudC5kaXNhYmxlZCA9IHRydWU7XG4gICAgICAgIH1cbiAgICAgIH0gfSwgaChcInNwYW5cIiwgeyBjbGFzczogQ1NTJDMubm9ybWFsaXplQ29udGVudEJ1dHRvblRleHQgfSwgdGhpcy5maWVsZEluZm9NYXAuaGFzKHRoaXMuY2hhcnRNZWRpYUluZm8udmFsdWUubm9ybWFsaXplRmllbGQpXG4gICAgICA/IGdldEZpZWxkRGlzcGxheU5hbWUodGhpcy5maWVsZEluZm9NYXAuZ2V0KHRoaXMuY2hhcnRNZWRpYUluZm8udmFsdWUubm9ybWFsaXplRmllbGQpLCB0aGlzLmFyY2FkZUV4cE1hcClcbiAgICAgIDogdGhpcy5zdHJpbmdzLm5vcm1hbGl6ZUJ5KSwgaChcInNwYW5cIiwgeyBjbGFzczogQ1NTJDMubm9ybWFsaXplQ29udGVudEJ1dHRvbkljb24gfSwgaChcImNhbGNpdGUtaWNvblwiLCB7IHNjYWxlOiBcInNcIiwgaWNvbjogXCJwZW5jaWxcIiB9KSkpKSkpO1xuICAgIGNvbnN0IGRvbmVCdG4gPSAoaChcImNhbGNpdGUtYnV0dG9uXCIsIHsgYXBwZWFyYW5jZTogXCJvdXRsaW5lLWZpbGxcIiwgc2NhbGU6IFwibVwiLCBzbG90OiBcImZvb3RlclwiLCB3aWR0aDogXCJmdWxsXCIsIG9uQ2xpY2s6ICgpID0+IHRoaXMuY2xvc2VQb3B1cFBvcG92ZXJzLmVtaXQoKSB9LCB0aGlzLnN0cmluZ3MuZG9uZSkpO1xuICAgIHJldHVybiAoaChIb3N0LCB7IGNsYXNzOiBcImpzLWFwcC1mbHlvdXRcIiB9LCBoKFwiY2FsY2l0ZS1wb3BvdmVyXCIsIHsgZGlyOiBnZXRFbGVtZW50RGlyKHRoaXMuaG9zdEVsZW1lbnQpLCByZWY6IChlbGVtZW50KSA9PiAodGhpcy5jaGFydFBvcG92ZXIgPSBlbGVtZW50KSwgcGxhY2VtZW50OiBcImxlYWRpbmctc3RhcnRcIiwgb3BlbjogdGhpcy5pc09wZW4sIHBvaW50ZXJEaXNhYmxlZDogdHJ1ZSwgcmVmZXJlbmNlRWxlbWVudDogdGhpcy5yZWZFbGVtZW50LCBvZmZzZXREaXN0YW5jZTogLU1hdGgucm91bmQodGhpcy5yZWZFbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLndpZHRoKSwgb2Zmc2V0U2tpZGRpbmc6IDUwLCBsYWJlbDogXCJcIiwgc3R5bGU6IHtcbiAgICAgICAgekluZGV4OiBcIjEwMFwiXG4gICAgICB9LCB0cmlnZ2VyRGlzYWJsZWQ6IHRydWUgfSwgaChcImNhbGNpdGUtcGFuZWxcIiwgeyByZWY6IChlbGVtZW50KSA9PiAodGhpcy5wYW5lbEVsZW1lbnQgPSBlbGVtZW50KSwgY2xvc2FibGU6IHRydWUsIHN0eWxlOiB7XG4gICAgICAgIHdpZHRoOiBgJHt0aGlzLnJlZkVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkud2lkdGh9cHhgXG4gICAgICB9LCBvbkNhbGNpdGVQYW5lbENsb3NlOiAoKSA9PiB0aGlzLmNsb3NlUG9wdXBQb3BvdmVycy5lbWl0KCkgfSwgaChcImRpdlwiLCB7IHNsb3Q6IFwiaGVhZGVyLWNvbnRlbnRcIiB9LCB0aGlzLnN0cmluZ3MuY29uZmlndXJlQ2hhcnQpLCBkb25lQnRuLCBoKFwiZGl2XCIsIHsgY2xhc3M6IENTUyQzLnBvcG92ZXJDaGFydERpdiB9LCBjaGFydEdyb3VwLCB0aGlzLmNoYXJ0Rm9ybUlucHV0KFwidGl0bGVcIiksIHRoaXMuY2hhcnRGb3JtSW5wdXQoXCJjYXB0aW9uXCIpLCB0aGlzLmNoYXJ0Rm9ybUlucHV0KFwiYWx0VGV4dFwiKSwgaGFzRmllbGRzICYmIGNvbG9yQnV0dG9uLCBoYXNGaWVsZHMgJiYgcmVzZXRCdXR0b24sIGZpZWxkTGlzdCwgYmFyQ2hhcnQsIG5vcm1hbGl6ZUZpZWxkKSkpKSk7XG4gIH1cbiAgcmVuZGVyQ29sb3JJY29uKGluZGV4KSB7XG4gICAgY29uc3QgeyBzdHJpbmdzLCBzZWxlY3RlZEZpZWxkSWR4LCBjb2xvcnMgfSA9IHRoaXM7XG4gICAgaWYgKHRoaXMuY2hhcnRNZWRpYUluZm8udHlwZSA9PT0gUG9wdXBNdWx0aU1lZGlhVHlwZS5saW5lQ2hhcnQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgcmV0dXJuIChoKFwiZGl2XCIsIHsgY2xhc3M6IFwiY29sb3ItaWNvblwiLCBzdHlsZTogeyBiYWNrZ3JvdW5kQ29sb3I6IGNvbG9yc1tpbmRleF0udG9IZXgoKSB9LCBzbG90OiBcImNvbnRlbnQtc3RhcnRcIiwgb25DbGljazogKCkgPT4gdGhpcy5vcGVuQ29sb3JQaWNrZXIoaW5kZXgpLCByb2xlOiBcImJ1dHRvblwiLCB0YWJJbmRleDogMCwgXCJhcmlhLWxhYmVsXCI6IHN0cmluZ3MuY2hhbmdlQ29sb3IsIFwiYXJpYS1oYXNwb3B1cFwiOiBcInRydWVcIiwgXCJhcmlhLWV4cGFuZGVkXCI6IHNlbGVjdGVkRmllbGRJZHggPT09IGluZGV4LCBvbktleVVwOiAoZXZlbnQpID0+IHtcbiAgICAgICAgaWYgKGV2ZW50LmtleSA9PT0gXCIgXCIgfHwgZXZlbnQua2V5ID09PSBcIkVudGVyXCIpIHtcbiAgICAgICAgICB0aGlzLm9wZW5Db2xvclBpY2tlcihpbmRleCk7XG4gICAgICAgIH1cbiAgICAgIH0sIHJlZjogKG5vZGUpID0+IHtcbiAgICAgICAgdGhpcy5jb2xvck5vZGVzW2luZGV4XSA9IG5vZGU7XG4gICAgICB9IH0pKTtcbiAgfVxuICBvcGVuQ29sb3JQaWNrZXIoaW5kZXgpIHtcbiAgICB2YXIgX2E7XG4gICAgY29uc3QgeyBjb2xvcnMsIHN0cmluZ3MsIGVzcmlDb2xvciB9ID0gdGhpcztcbiAgICAoX2EgPSB0aGlzLmNvbG9yQnV0dG9uTm9kZSkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmNsb3NlUG9wb3ZlcigpO1xuICAgIHRoaXMuY2xvc2VDb2xvclBvcG92ZXIoKTtcbiAgICB0aGlzLnNlbGVjdGVkRmllbGRJZHggPSBpbmRleDtcbiAgICBjb25zdCBwb3BvdmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImFyY2dpcy1wb3B1cC1jb2xvci1wb3BvdmVyXCIpO1xuICAgIHBvcG92ZXIuaGVhZGluZyA9IHN0cmluZ3Muc2VsZWN0Q29sb3I7XG4gICAgcG9wb3Zlci5pbnRsRG9uZSA9IHN0cmluZ3MuZG9uZTtcbiAgICBwb3BvdmVyLmxhYmVsID0gc3RyaW5ncy5zZWxlY3RDb2xvcjtcbiAgICBwb3BvdmVyLmhleENvbG9yID0gY29sb3JzW2luZGV4XS50b0hleCgpO1xuICAgIHBvcG92ZXIucG9wb3ZlclByb3BzID0ge1xuICAgICAgcGxhY2VtZW50OiBcImxlYWRpbmctc3RhcnRcIixcbiAgICAgIG9mZnNldERpc3RhbmNlOiAxLFxuICAgICAgb2Zmc2V0U2tpZGRpbmc6IDUyLFxuICAgICAgcG9pbnRlckRpc2FibGVkOiBcInRydWVcIixcbiAgICAgIHBvcG92ZXJXaWR0aDogMzE1LFxuICAgICAgLy9vdmVybGF5UG9zaXRpb25pbmc6IFwiZml4ZWRcIiwgLS0gYnVnZ3ksIG9mZnNldCBpc3N1ZVxuICAgICAgcmVmRWxlbWVudDogdGhpcy5jaGFydFBvcG92ZXJcbiAgICB9O1xuICAgIHBvcG92ZXIuYWRkRXZlbnRMaXN0ZW5lcihcImFyY2dpc1BvcHVwQ29sb3JQb3BvdmVyQ2xvc2VcIiwgKCkgPT4ge1xuICAgICAgdGhpcy5zZWxlY3RlZEZpZWxkSWR4ID0gdW5kZWZpbmVkO1xuICAgICAgdGhpcy5jb2xvclBvcG92ZXJOb2RlID0gbnVsbDtcbiAgICB9KTtcbiAgICBwb3BvdmVyLmFkZEV2ZW50TGlzdGVuZXIoXCJhcmNnaXNQb3B1cENvbG9yUG9wb3ZlckNoYW5nZVwiLCAoeyBkZXRhaWw6IGhleENvbG9yIH0pID0+IHtcbiAgICAgIGNvbG9yc1tpbmRleF0gPSBuZXcgZXNyaUNvbG9yKGhleENvbG9yKTtcbiAgICAgIC8vIG9uY2UgdGhlIHVzZXIgbWFrZXMgYSBjaGFuZ2Ugd2Ugc2F2ZSBhbGwgY29sb3JzXG4gICAgICB0aGlzLmNoYXJ0TWVkaWFJbmZvLnZhbHVlLmNvbG9ycyA9IHRoaXMuZXNyaUxhbmcuY2xvbmUoY29sb3JzKTtcbiAgICAgIHRoaXMuY2hhcnRDaGFuZ2VkUmVSZW5kZXIuZW1pdCgpO1xuICAgICAgZm9yY2VVcGRhdGUodGhpcy5jb2xvckJ1dHRvbk5vZGUpO1xuICAgIH0pO1xuICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQocG9wb3Zlcik7XG4gICAgcG9wb3Zlci5zZXRPcGVuKHRydWUpO1xuICAgIHRoaXMuY29sb3JQb3BvdmVyTm9kZSA9IHBvcG92ZXI7XG4gICAgLy9wb3BvdmVyLmFkZEV2ZW50TGlzdGVuZXIoXCJhcmNnaXNQb3B1cENvbG9yUG9wb3Zlck9wZW5cIiwgKCkgPT4ge30pO1xuICB9XG4gIHNldENvbG9ycygpIHtcbiAgICB2YXIgX2EsIF9iLCBfYywgX2QsIF9lLCBfZjtcbiAgICBjb25zdCB7IGVzcmlDb2xvciwgbGFzdENvbG9ycywgcmVuZGVyZXJDb2xvcnMgfSA9IHRoaXM7XG4gICAgaWYgKHRoaXMuY2hhcnRNZWRpYUluZm8udHlwZSA9PT0gUG9wdXBNdWx0aU1lZGlhVHlwZS5saW5lQ2hhcnQpIHtcbiAgICAgIGlmICghKChfYSA9IHRoaXMuY29sb3JzKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EubGVuZ3RoKSAmJiBsYXN0Q29sb3JzLmxpbmVDb2xvcnMpIHtcbiAgICAgICAgdGhpcy5jb2xvcnMgPSBsYXN0Q29sb3JzLmxpbmVDb2xvcnM7XG4gICAgICAgIHRoaXMuY2hhcnRNZWRpYUluZm8udmFsdWUuY29sb3JzID0gdGhpcy5lc3JpTGFuZy5jbG9uZSh0aGlzLmNvbG9ycyk7XG4gICAgICB9XG4gICAgICBpZiAoISgoX2IgPSB0aGlzLmNvbG9ycykgPT09IG51bGwgfHwgX2IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9iLmxlbmd0aCkpIHtcbiAgICAgICAgY29uc3QgZGVmYXVsdFNjaGVtZSA9IHRoaXMuZ2V0RGVmYXVsdENvbG9yU2NoZW1lKCk7XG4gICAgICAgIHRoaXMuY29sb3JzID0gW2RlZmF1bHRTY2hlbWUuY29sb3JzWzBdXTtcbiAgICAgIH1cbiAgICAgIGVsc2UgaWYgKHRoaXMuY29sb3JzLmxlbmd0aCA+IDEpIHtcbiAgICAgICAgdGhpcy5jb2xvcnMgPSBbdGhpcy5jb2xvcnNbMF1dO1xuICAgICAgfVxuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgIGlmICghKChfYyA9IHRoaXMuY29sb3JzKSA9PT0gbnVsbCB8fCBfYyA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2MubGVuZ3RoKSAmJiBsYXN0Q29sb3JzLnJhbXBDb2xvcnMpIHtcbiAgICAgICAgdGhpcy5jb2xvcnMgPSB0aGlzLmVzcmlMYW5nLmNsb25lKGxhc3RDb2xvcnMucmFtcENvbG9ycyk7XG4gICAgICAgIHRoaXMuY2hhcnRNZWRpYUluZm8udmFsdWUuY29sb3JzID0gdGhpcy5lc3JpTGFuZy5jbG9uZSh0aGlzLmNvbG9ycyk7XG4gICAgICB9XG4gICAgICBpZiAoISgoX2QgPSB0aGlzLmNvbG9ycykgPT09IG51bGwgfHwgX2QgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9kLmxlbmd0aCkgfHwgdGhpcy5jb2xvcnMubGVuZ3RoICE9PSAoKF9lID0gdGhpcy5jaGFydE1lZGlhSW5mbykgPT09IG51bGwgfHwgX2UgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9lLnZhbHVlLmZpZWxkcy5sZW5ndGgpKSB7XG4gICAgICAgIGNvbnN0IGRlZmF1bHRTY2hlbWUgPSB0aGlzLmdldERlZmF1bHRDb2xvclNjaGVtZSgpO1xuICAgICAgICB0aGlzLmNvbG9ycyA9IChfZiA9IHRoaXMuY2hhcnRNZWRpYUluZm8pID09PSBudWxsIHx8IF9mID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfZi52YWx1ZS5maWVsZHMubWFwKChmaWVsZE5hbWUsIGlkeCkgPT4ge1xuICAgICAgICAgIHZhciBfYTtcbiAgICAgICAgICByZXR1cm4gcmVuZGVyZXJDb2xvcnMuZ2V0KGZpZWxkTmFtZSlcbiAgICAgICAgICAgID8gdGhpcy5lc3JpTGFuZy5jbG9uZShyZW5kZXJlckNvbG9ycy5nZXQoZmllbGROYW1lKVswXSlcbiAgICAgICAgICAgIDogKChfYSA9IHRoaXMuY29sb3JzKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2FbaWR4XSkgfHxcbiAgICAgICAgICAgICAgbmV3IGVzcmlDb2xvcihkZWZhdWx0U2NoZW1lLmNvbG9yc1tpZHggJSBNQVhfUkFNUF9DT0xPUlNdKSB8fFxuICAgICAgICAgICAgICBuZXcgZXNyaUNvbG9yKFswLCAwLCAwLCAxXSk7XG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH1cbiAgfVxuICBnZXREZWZhdWx0Q29sb3JTY2hlbWUoKSB7XG4gICAgY29uc3Qgc2NoZW1lcyA9IHRoaXMucGllQ2hhcnRTY2hlbWVzLmdldFNjaGVtZXMoe1xuICAgICAgYmFzZW1hcDogdGhpcy5tYXBWaWV3Lm1hcC5iYXNlbWFwLFxuICAgICAgZ2VvbWV0cnlUeXBlOiBcInBvbHlnb25cIixcbiAgICAgIG51bUNvbG9yczogTWF0aC5taW4oTUFYX1JBTVBfQ09MT1JTLCB0aGlzLmNoYXJ0TWVkaWFJbmZvLnZhbHVlLmZpZWxkcy5sZW5ndGgpXG4gICAgfSk7XG4gICAgcmV0dXJuIChbc2NoZW1lcy5wcmltYXJ5U2NoZW1lXVxuICAgICAgLmNvbmNhdChzY2hlbWVzLnNlY29uZGFyeVNjaGVtZXMpXG4gICAgICAuZmluZCgoc2NoZW1lKSA9PiBzY2hlbWUubmFtZSA9PT0gXCJPbHltcGljIFN1bnNldFwiKSB8fFxuICAgICAgc2NoZW1lcy5wcmltYXJ5U2NoZW1lKTtcbiAgfVxuICBjbG9zZUNvbG9yUG9wb3ZlcigpIHtcbiAgICBpZiAodGhpcy5jb2xvclBvcG92ZXJOb2RlKSB7XG4gICAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKHRoaXMuY29sb3JQb3BvdmVyTm9kZSk7XG4gICAgICB0aGlzLmNvbG9yUG9wb3Zlck5vZGUgPSBudWxsO1xuICAgIH1cbiAgfVxuICBnZXQgaG9zdEVsZW1lbnQoKSB7IHJldHVybiBnZXRFbGVtZW50KHRoaXMpOyB9XG59O1xuQXJjZ2lzUG9wdXBDaGFydC5zdHlsZSA9IGFyY2dpc1BvcHVwQ2hhcnRDc3M7XG5cbmNvbnN0IEFyY2dpc1BvcHVwRXhwcmVzc2lvbnMgPSBjbGFzcyB7XG4gIGNvbnN0cnVjdG9yKGhvc3RSZWYpIHtcbiAgICByZWdpc3Rlckluc3RhbmNlKHRoaXMsIGhvc3RSZWYpO1xuICAgIHRoaXMuYXJjYWRlQ2hhbmdlTm90aWZpY2F0aW9uID0gY3JlYXRlRXZlbnQodGhpcywgXCJhcmNhZGVDaGFuZ2VOb3RpZmljYXRpb25cIiwgNyk7XG4gICAgdGhpcy5pbnRlcm5hbFBvcHVwVXBkYXRlZCA9IGNyZWF0ZUV2ZW50KHRoaXMsIFwiaW50ZXJuYWxQb3B1cFVwZGF0ZWRcIiwgNyk7XG4gICAgdGhpcy52YWx1ZUxpc3QgPSBbXTtcbiAgICB0aGlzLmZpbHRlckxlbmd0aCA9IDU7XG4gICAgLy8gcmVuZG9yIG1ldGhvZHNcbiAgICB0aGlzLmNhbGNpdGVWYWx1ZUxpc3QgPSAoYXJjYWRlRmllbGQpID0+IChoKFwiY2FsY2l0ZS12YWx1ZS1saXN0LWl0ZW1cIiwgeyBsYWJlbDogYXJjYWRlRmllbGQudGl0bGUsIGRlc2NyaXB0aW9uOiBgeyR7ZmllbGRJbmZvUHJlZml4RW51bS5leHByZXNzaW9ufSR7YXJjYWRlRmllbGQubmFtZX19YCwgdmFsdWU6IGFyY2FkZUZpZWxkLm5hbWUsIG1ldGFkYXRhOiB7XG4gICAgICAgIHRpdGxlOiBhcmNhZGVGaWVsZC50aXRsZSxcbiAgICAgICAgbmFtZTogYHske2ZpZWxkSW5mb1ByZWZpeEVudW0uZXhwcmVzc2lvbn0ke2FyY2FkZUZpZWxkLm5hbWV9fWBcbiAgICAgIH0sIG9uQ2xpY2s6IChldmVudCkgPT4gdGhpcy5sYXVuY2hBcmNhZGUoZXZlbnQsIGFyY2FkZUZpZWxkKSB9LCBoKFwiY2FsY2l0ZS1hY3Rpb25cIiwgeyBzbG90OiBcImFjdGlvbnMtZW5kXCIsIGFwcGVhcmFuY2U6IFwidHJhbnNwYXJlbnRcIiwgdGV4dDogdGhpcy5zdHJpbmdzLnJlbW92ZSwgb25DbGljazogKGV2ZW50KSA9PiB0aGlzLnJlbW92ZUJ0bkNsaWNrKGV2ZW50LCBhcmNhZGVGaWVsZC5uYW1lKSB9LCBoKFwiY2FsY2l0ZS1pY29uXCIsIHsgc2NhbGU6IFwic1wiLCBpY29uOiBcInhcIiB9KSkpKTtcbiAgICB0aGlzLnJlUmVuZGVyID0gdW5kZWZpbmVkO1xuICB9XG4gIGNvbXBvbmVudFdpbGxMb2FkKCkge1xuICAgIHRoaXMubGF5ZXIgPSBwb3B1cFN0YXRlLmxheWVyO1xuICAgIHRoaXMubWFwVmlldyA9IHBvcHVwU3RhdGUubWFwVmlldztcbiAgICB0aGlzLnBvcnRhbCA9IHBvcHVwU3RhdGUucG9ydGFsO1xuICAgIHRoaXMuY29uZmlnID0gcG9wdXBTdGF0ZS5jb25maWc7XG4gICAgdGhpcy5zdHJpbmdzID0gcG9wdXBTdGF0ZS5zdHJpbmdzO1xuICAgIHRoaXMuY3VycmVudExhbmd1YWdlID0gcG9wdXBTdGF0ZS5jdXJyZW50TGFuZ3VhZ2U7XG4gICAgdGhpcy5zZXJ2aWNlVHlwZSA9IHBvcHVwU3RhdGUuc2VydmljZVR5cGU7XG4gICAgdGhpcy5wb3B1cFRlbXBsYXRlID0gcG9wdXBTdGF0ZS5wb3B1cFRlbXBsYXRlO1xuICAgIHRoaXMubGF5ZXJEaXNwbGF5VHlwZSA9IHBvcHVwU3RhdGUubGF5ZXJEaXNwbGF5VHlwZTtcbiAgfVxuICAvLyBsaWZlY3ljbGUgbWV0aG9kc1xuICBhc3luYyBjb21wb25lbnREaWRMb2FkKCkge1xuICAgIGF3YWl0IHRoaXMubG9hZEFsbE1vZHVsZXMoKTtcbiAgfVxuICBjb21wb25lbnRXaWxsUmVuZGVyKCkge1xuICAgIHZhciBfYTtcbiAgICB0aGlzLnZhbHVlTGlzdCA9IFtdO1xuICAgIGlmICgoX2EgPSB0aGlzLnBvcHVwVGVtcGxhdGUuZXhwcmVzc2lvbkluZm9zKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EubGVuZ3RoKSB7XG4gICAgICB0aGlzLnBvcHVwVGVtcGxhdGUuZXhwcmVzc2lvbkluZm9zLmZvckVhY2goKGFyY2FkZUZpZWxkKSA9PiB7XG4gICAgICAgIHRoaXMudmFsdWVMaXN0LnB1c2godGhpcy5jYWxjaXRlVmFsdWVMaXN0KGFyY2FkZUZpZWxkKSk7XG4gICAgICB9KTtcbiAgICB9XG4gIH1cbiAgLy8gUHVibGljIE1ldGhvZHNcbiAgYXN5bmMgc2V0Rm9jdXMoKSB7XG4gICAgdGhpcy5leHByZXNzaW9uRmxvd0l0ZW0uc2V0Rm9jdXMoKTtcbiAgfVxuICAvLyBwcml2YXRlIG1ldGhvZHMgYW5kIHByb3BlcnRpZXNcbiAgYXN5bmMgbG9hZEFsbE1vZHVsZXMoKSB7XG4gICAgW3RoaXMuRmllbGRJbmZvLCB0aGlzLlBvcHVwRXhwcmVzc2lvbkluZm9dID0gYXdhaXQgbG9hZE1vZHVsZXMoW1xuICAgICAgXCJlc3JpL3BvcHVwL0ZpZWxkSW5mb1wiLFxuICAgICAgXCJlc3JpL3BvcHVwL0V4cHJlc3Npb25JbmZvXCJcbiAgICBdKTtcbiAgfVxuICBhc3luYyBsYXVuY2hBcmNhZGUoZXZlbnQsIGN1cnJlbnRFeHByZXNzaW9uKSB7XG4gICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgaWYgKCF0aGlzLmFyY2FkZUVkaXRvcikge1xuICAgICAgdGhpcy5leHByZXNzaW9uRmxvd0l0ZW0uZGlzYWJsZWQgPSB0cnVlO1xuICAgICAgdGhpcy5hcmNhZGVFZGl0b3IgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiYXJjZ2lzLW1vZGFsLWFyY2FkZVwiKTtcbiAgICAgIHRoaXMuYXJjYWRlRWRpdG9yLmFyY2FkZVNjcmlwdCA9IGdldEFyY2FkZVNjcmlwdChjdXJyZW50RXhwcmVzc2lvbiA9PT0gbnVsbCB8fCBjdXJyZW50RXhwcmVzc2lvbiA9PT0gdm9pZCAwID8gdm9pZCAwIDogY3VycmVudEV4cHJlc3Npb24uZXhwcmVzc2lvbiwgdGhpcy5sYXllckRpc3BsYXlUeXBlLCB0aGlzLnN0cmluZ3MpO1xuICAgICAgdGhpcy5hcmNhZGVFZGl0b3IuYXJjYWRlUHJvZmlsZSA9IGF3YWl0IGdldEFyY2FkZVByb2ZpbGUodGhpcy5sYXllciwgdGhpcy5tYXBWaWV3LCB0aGlzLnNlcnZpY2VUeXBlLCB0aGlzLnBvcHVwVGVtcGxhdGUsIHRoaXMubGF5ZXJEaXNwbGF5VHlwZSk7XG4gICAgICB0aGlzLmFyY2FkZUVkaXRvci50ZXN0RGF0YSA9IGF3YWl0IGdldFRlc3REYXRhKHRoaXMubGF5ZXIsIHRoaXMubWFwVmlldywgdGhpcy5sYXllckRpc3BsYXlUeXBlLCB0aGlzLnBvcHVwVGVtcGxhdGUpO1xuICAgICAgdGhpcy5hcmNhZGVFZGl0b3IuYWRkRXhpc3RpbmdFeHByZXNzaW9ucyA9IHRydWU7XG4gICAgICB0aGlzLmFyY2FkZUVkaXRvci5sYXllciA9IHRoaXMubGF5ZXI7XG4gICAgICB0aGlzLmFyY2FkZUVkaXRvci5hcmNhZGVUaXRsZSA9IChjdXJyZW50RXhwcmVzc2lvbiA9PT0gbnVsbCB8fCBjdXJyZW50RXhwcmVzc2lvbiA9PT0gdm9pZCAwID8gdm9pZCAwIDogY3VycmVudEV4cHJlc3Npb24udGl0bGUpIHx8IHRoaXMuc3RyaW5ncy5hcmNhZGVEZWZhdWx0VGl0bGU7XG4gICAgICB0aGlzLmFyY2FkZUVkaXRvci5hcmNhZGVUaXRsZUVkaXRhYmxlID0gdHJ1ZTtcbiAgICAgIHRoaXMuYXJjYWRlRWRpdG9yLmFyY2FkZVRpdGxlRWRpdGluZ0VuYWJsZWQgPSAhKGN1cnJlbnRFeHByZXNzaW9uID09PSBudWxsIHx8IGN1cnJlbnRFeHByZXNzaW9uID09PSB2b2lkIDAgPyB2b2lkIDAgOiBjdXJyZW50RXhwcmVzc2lvbi50aXRsZSk7XG4gICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHRoaXMuYXJjYWRlRWRpdG9yKTtcbiAgICAgIHRoaXMuYXJjYWRlRWRpdG9yLmFkZEV2ZW50TGlzdGVuZXIoXCJhcmNnaXNNb2RhbEFyY2FkZUNsb3NlXCIsIChldmVudCkgPT4ge1xuICAgICAgICB0aGlzLmFyY2FkZVNldHVwKGV2ZW50LmRldGFpbCwgY3VycmVudEV4cHJlc3Npb24pO1xuICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHRoaXMuZmFiQnV0dG9uTm9kZS5zZXRGb2N1cygpLCAzMDApO1xuICAgICAgfSk7XG4gICAgfVxuICB9XG4gIGFzeW5jIGFyY2FkZVNldHVwKGFyY2FkZU9iamVjdCwgY3VycmVudEV4cHJlc3Npb24pIHtcbiAgICBpZiAoYXJjYWRlT2JqZWN0KSB7XG4gICAgICBzZXRFeHByZXNzaW9uSW5mb0luUG9wdXBUZW1wbGF0ZShhcmNhZGVPYmplY3QsIGN1cnJlbnRFeHByZXNzaW9uID09PSBudWxsIHx8IGN1cnJlbnRFeHByZXNzaW9uID09PSB2b2lkIDAgPyB2b2lkIDAgOiBjdXJyZW50RXhwcmVzc2lvbi5uYW1lLCB0aGlzLlBvcHVwRXhwcmVzc2lvbkluZm8sIHRoaXMucG9wdXBUZW1wbGF0ZSk7XG4gICAgICBhd2FpdCB0aGlzLnBvcHVwRXhwcmVzc2lvblNldHVwKCk7XG4gICAgfVxuICAgIHRoaXMuZXhwcmVzc2lvbkZsb3dJdGVtLmRpc2FibGVkID0gZmFsc2U7XG4gICAgZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZCh0aGlzLmFyY2FkZUVkaXRvcik7XG4gICAgdGhpcy5hcmNhZGVFZGl0b3IgPSBudWxsO1xuICB9XG4gIC8vIHVwZGF0ZSBtYXN0ZXIgZmllbGQgaW5mbyBhbmQgZW1pdCBmb3IgYXR0cmlidXRlcyByZS1yZW5kZXIsIHNlbGYgcmUtcmVuZGVyIGFuZCB1cGRhdGUgcG9wdXBcbiAgYXN5bmMgcG9wdXBFeHByZXNzaW9uU2V0dXAoKSB7XG4gICAgYXdhaXQgc2V0TGF5ZXJFeHByZXNzaW9uQW5kRmllbGRJbmZvKHRoaXMucG9wdXBUZW1wbGF0ZSwgdGhpcy5sYXllckRpc3BsYXlUeXBlLCB0aGlzLmxheWVyLCB0aGlzLkZpZWxkSW5mbyk7XG4gICAgdGhpcy5hcmNhZGVDaGFuZ2VOb3RpZmljYXRpb24uZW1pdCgpO1xuICAgIHRoaXMuaW50ZXJuYWxQb3B1cFVwZGF0ZWQuZW1pdCgpO1xuICAgIHRoaXMucmVSZW5kZXIgPSAhdGhpcy5yZVJlbmRlcjtcbiAgfVxuICByZW1vdmVCdG5DbGljayhldmVudCwgZmllbGROYW1lKSB7XG4gICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgdGhpcy5wb3B1cFRlbXBsYXRlLmV4cHJlc3Npb25JbmZvcy5maW5kKChleHAsIGluZGV4KSA9PiB7XG4gICAgICBpZiAoZXhwLm5hbWUgPT09IGZpZWxkTmFtZSkge1xuICAgICAgICByZXR1cm4gdGhpcy5wb3B1cFRlbXBsYXRlLmV4cHJlc3Npb25JbmZvcy5zcGxpY2UoaW5kZXgsIDEpO1xuICAgICAgfVxuICAgIH0pO1xuICAgIHRoaXMucG9wdXBFeHByZXNzaW9uU2V0dXAoKTtcbiAgfVxuICByZW5kZXIoKSB7XG4gICAgdmFyIF9hO1xuICAgIGNvbnN0IGFkZEV4cHJlc3Npb25CdG4gPSAoaChcImNhbGNpdGUtZmFiXCIsIHsgc2xvdDogXCJmYWJcIiwgY2xhc3M6IFwiZmFiXCIsIGljb246IFwicGx1c1wiLCBzY2FsZTogXCJzXCIsIGFwcGVhcmFuY2U6IFwib3V0bGluZS1maWxsXCIsIGtpbmQ6IFwibmV1dHJhbFwiLCBsYWJlbDogdGhpcy5zdHJpbmdzLmFkZEV4cHJlc3Npb24sIHRleHQ6IHRoaXMuc3RyaW5ncy5hZGRFeHByZXNzaW9uLCBcInRleHQtZW5hYmxlZFwiOiB0cnVlLCBvbkNsaWNrOiAoZXZlbnQpID0+IHRoaXMubGF1bmNoQXJjYWRlKGV2ZW50KSwgcmVmOiAobm9kZSkgPT4gKHRoaXMuZmFiQnV0dG9uTm9kZSA9IG5vZGUpIH0pKTtcbiAgICByZXR1cm4gKGgoSG9zdCwgeyBjbGFzczogXCJjYWxjaXRlLW1hdGNoLWhlaWdodFwiIH0sIGgoXCJjYWxjaXRlLWZsb3ctaXRlbVwiLCB7IGRpcjogZ2V0RWxlbWVudERpcih0aGlzLmhvc3RFbGVtZW50KSwgaGVhZGluZzogdGhpcy5zdHJpbmdzLm1hbmFnZUV4cHJlc3Npb25zLCByZWY6IChub2RlKSA9PiAodGhpcy5leHByZXNzaW9uRmxvd0l0ZW0gPSBub2RlKSB9LCAoKF9hID0gdGhpcy5wb3B1cFRlbXBsYXRlLmV4cHJlc3Npb25JbmZvcykgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmxlbmd0aCkgPiAwICYmIChoKFwiY2FsY2l0ZS12YWx1ZS1saXN0XCIsIHsgZmlsdGVyRW5hYmxlZDogdGhpcy52YWx1ZUxpc3QubGVuZ3RoID49IHRoaXMuZmlsdGVyTGVuZ3RoID8gdHJ1ZSA6IGZhbHNlIH0sIHRoaXMudmFsdWVMaXN0KSksIGFkZEV4cHJlc3Npb25CdG4pKSk7XG4gIH1cbiAgZ2V0IGhvc3RFbGVtZW50KCkgeyByZXR1cm4gZ2V0RWxlbWVudCh0aGlzKTsgfVxufTtcblxuY29uc3QgYXJjZ2lzUG9wdXBGaWVsZFBpY2tMaXN0Q3NzID0gXCIucG9wb3Zlcnt6LWluZGV4OjEwMH0ucGFuZWx7bWluLWhlaWdodDozMDBweH0uY29udGVudHttYXgtaGVpZ2h0OmNhbGMoNjB2aCAtIDE0MnB4KTt9LnNlbGVjdGlvbi1idXR0b24tZGl2e3BhZGRpbmc6NHB4IDEwcHh9LmZvb3Rlcnt3aWR0aDoxMDAlfS5leHByZXNzaW9uLWFjdGlvbnN7ZGlzcGxheTpmbGV4fS5hZGQtZXhwcmVzc2lvbi1idXR0b257bWFyZ2luOjRweCAwIDhweH1cIjtcblxuY29uc3QgQXJjZ2lzUG9wdXBGaWVsZFBpY2tMaXN0ID0gY2xhc3Mge1xuICBjb25zdHJ1Y3Rvcihob3N0UmVmKSB7XG4gICAgcmVnaXN0ZXJJbnN0YW5jZSh0aGlzLCBob3N0UmVmKTtcbiAgICB0aGlzLmFyY2dpc1BvcHVwUGlja0xpc3REaXNtaXNzZWQgPSBjcmVhdGVFdmVudCh0aGlzLCBcImFyY2dpc1BvcHVwUGlja0xpc3REaXNtaXNzZWRcIiwgNyk7XG4gICAgdGhpcy5hcmNnaXNQb3B1cFBpY2tMaXN0Q2hhbmdlID0gY3JlYXRlRXZlbnQodGhpcywgXCJhcmNnaXNQb3B1cFBpY2tMaXN0Q2hhbmdlXCIsIDcpO1xuICAgIHRoaXMuYXJjYWRlQ2hhbmdlTm90aWZpY2F0aW9uID0gY3JlYXRlRXZlbnQodGhpcywgXCJhcmNhZGVDaGFuZ2VOb3RpZmljYXRpb25cIiwgNyk7XG4gICAgdGhpcy5hcmNhZGVFeHBNYXAgPSBuZXcgTWFwKCk7XG4gICAgdGhpcy5jYWxjaXRlRmllbGRPbmx5VmFsdWVMaXN0ID0gKGZpZWxkKSA9PiAoaChcImNhbGNpdGUtcGljay1saXN0LWl0ZW1cIiwgeyBrZXk6IGZpZWxkLm5hbWUsIGxhYmVsOiBmaWVsZC5hbGlhcyB8fCBmaWVsZC5uYW1lLCB2YWx1ZTogZmllbGQubmFtZSwgZGVzY3JpcHRpb246IGB7JHtmaWVsZC5uYW1lfX1gLCBzZWxlY3RlZDogKCF0aGlzLm11bHRpcGxlICYmIGZpZWxkLm5hbWUgPT09IHRoaXMuc2VsZWN0ZWRGaWVsZHNbMF0pIHx8XG4gICAgICAgICh0aGlzLm11bHRpcGxlICYmIHRoaXMuc2VsZWN0ZWRGaWVsZHMuaW5kZXhPZihmaWVsZC5uYW1lKSA+IC0xKSwgbWV0YWRhdGE6IHtcbiAgICAgICAgbGFiZWw6IGZpZWxkLmFsaWFzLFxuICAgICAgICBmaWVsZE5hbWU6IGZpZWxkLm5hbWVcbiAgICAgIH0gfSwgdGhpcy5sYXllckRpc3BsYXlUeXBlID09PSBsYXllckRpc3BsYXlUeXBlRW51bS5mZWF0dXJlICYmXG4gICAgICAhZmllbGQubmFtZS5pbmNsdWRlcyhmaWVsZEluZm9QcmVmaXhFbnVtLnJlbGF0aW9uc2hpcCkgJiYgKGgoXCJjYWxjaXRlLWFjdGlvblwiLCB7IHNsb3Q6IFwiYWN0aW9ucy1lbmRcIiwgdGV4dDogdGhpcy5zdHJpbmdzLmluZm8sIHRpdGxlOiB0aGlzLnN0cmluZ3MuaW5mbywgc2NhbGU6IFwic1wiLCBpY29uOiBcImluZm9ybWF0aW9uXCIsIG9uQ2xpY2s6IChldmVudCkgPT4ge1xuICAgICAgICB2YXIgX2E7XG4gICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICBjb25zdCBhY3Rpb24gPSBldmVudC50YXJnZXQ7XG4gICAgICAgIGNvbnN0IGZpZWxkSW5mb0Zsb3dJdGVtID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImNhbGNpdGUtZmxvdy1pdGVtXCIpO1xuICAgICAgICBmaWVsZEluZm9GbG93SXRlbS5oZWFkaW5nID0gKF9hID0gZmllbGQuYWxpYXMpICE9PSBudWxsICYmIF9hICE9PSB2b2lkIDAgPyBfYSA6IGZpZWxkLm5hbWU7XG4gICAgICAgIGZpZWxkSW5mb0Zsb3dJdGVtLmRlc2NyaXB0aW9uID0gZmllbGQubmFtZTtcbiAgICAgICAgY29uc3QgZmllbGRJbmZvID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImFyY2dpcy1maWVsZC1pbmZvXCIpO1xuICAgICAgICBmaWVsZEluZm8ubGFuZyA9IHRoaXMuY3VycmVudExhbmd1YWdlSW50bDtcbiAgICAgICAgZmllbGRJbmZvLmZpZWxkTmFtZSA9IGZpZWxkLm5hbWU7XG4gICAgICAgIGZpZWxkSW5mby5sYXllciA9IHRoaXMubGF5ZXI7XG4gICAgICAgIGZpZWxkSW5mby52aWV3ID0gdGhpcy5tYXBWaWV3O1xuICAgICAgICBmaWVsZEluZm8uY2xhc3NMaXN0LmFkZChcImNvbnRlbnRcIik7XG4gICAgICAgIGZpZWxkSW5mb0Zsb3dJdGVtLmFkZEV2ZW50TGlzdGVuZXIoXCJjYWxjaXRlRmxvd0l0ZW1CYWNrXCIsICgpID0+IHJlcXVlc3RBbmltYXRpb25GcmFtZSgoKSA9PiBhY3Rpb24uc2V0Rm9jdXMoKSkpO1xuICAgICAgICBmaWVsZEluZm9GbG93SXRlbS5hcHBlbmRDaGlsZChmaWVsZEluZm8pO1xuICAgICAgICB0aGlzLmZsb3dFbGVtZW50LmFwcGVuZENoaWxkKGZpZWxkSW5mb0Zsb3dJdGVtKTtcbiAgICAgICAgc2V0VGltZW91dCgoKSA9PiBmaWVsZEluZm9GbG93SXRlbS5zZXRGb2N1cygpLCAyMDApO1xuICAgICAgfSB9KSkpKTtcbiAgICB0aGlzLmNhbGNpdGVFeHByZXNzaW9uc09ubHlWYWx1ZUxpc3QgPSAoZmllbGQpID0+IChoKFwiY2FsY2l0ZS1waWNrLWxpc3QtaXRlbVwiLCB7IGtleTogZmllbGQubmFtZSwgbGFiZWw6IGZpZWxkLmFsaWFzIHx8IGZpZWxkLm5hbWUsIHZhbHVlOiBmaWVsZC5uYW1lLCBkZXNjcmlwdGlvbjogYHske2ZpZWxkLm5hbWV9fWAsIHNlbGVjdGVkOiAoIXRoaXMubXVsdGlwbGUgJiYgZmllbGQubmFtZSA9PT0gdGhpcy5zZWxlY3RlZEZpZWxkc1swXSkgfHxcbiAgICAgICAgKHRoaXMubXVsdGlwbGUgJiYgdGhpcy5zZWxlY3RlZEZpZWxkcy5pbmRleE9mKGZpZWxkLm5hbWUpID4gLTEpLCBtZXRhZGF0YToge1xuICAgICAgICBsYWJlbDogZmllbGQuYWxpYXMsXG4gICAgICAgIGZpZWxkTmFtZTogZmllbGQubmFtZVxuICAgICAgfSB9LCBoKFwiZGl2XCIsIHsgY2xhc3M6IFwiZXhwcmVzc2lvbi1hY3Rpb25zXCIsIHNsb3Q6IFwiYWN0aW9ucy1lbmRcIiB9LCBoKFwiY2FsY2l0ZS1hY3Rpb25cIiwgeyB0ZXh0OiB0aGlzLnN0cmluZ3MuZWRpdCwgdGl0bGU6IHRoaXMuc3RyaW5ncy5lZGl0LCBzY2FsZTogXCJzXCIsIGljb246IHRoaXMubnVtYmVyc09ubHkgJiYgZmllbGQudHlwZS50b0xvd2VyQ2FzZSgpICE9PSBmaWVsZFR5cGVzRW51bS5udW1iZXJcbiAgICAgICAgPyBcImV4Y2xhbWF0aW9uLW1hcmstdHJpYW5nbGVcIlxuICAgICAgICA6IFwicGVuY2lsXCIsIG9uQ2xpY2s6ICgpID0+IHtcbiAgICAgICAgaWYgKHRoaXMuYXJjYWRlRXhwTWFwLmhhcyhmaWVsZC5uYW1lKSkge1xuICAgICAgICAgIHRoaXMubGF1bmNoQXJjYWRlKHRoaXMuYXJjYWRlRXhwTWFwLmdldChmaWVsZC5uYW1lKSk7XG4gICAgICAgIH1cbiAgICAgIH0gfSksIGgoXCJjYWxjaXRlLWFjdGlvblwiLCB7IHRleHQ6IHRoaXMuc3RyaW5ncy5yZW1vdmUsIHRpdGxlOiB0aGlzLnN0cmluZ3MucmVtb3ZlLCBzY2FsZTogXCJzXCIsIGljb246IFwidHJhc2hcIiwgb25DbGljazogYXN5bmMgKCkgPT4ge1xuICAgICAgICB0aGlzLnBvcHVwVGVtcGxhdGUuZXhwcmVzc2lvbkluZm9zLmZpbmQoKGV4cCwgaW5kZXgpID0+IHtcbiAgICAgICAgICBpZiAoZmllbGQubmFtZS5pbmNsdWRlcyhgLyR7ZXhwLm5hbWV9YCkpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnBvcHVwVGVtcGxhdGUuZXhwcmVzc2lvbkluZm9zLnNwbGljZShpbmRleCwgMSk7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgYXdhaXQgc2V0TGF5ZXJFeHByZXNzaW9uQW5kRmllbGRJbmZvKHRoaXMucG9wdXBUZW1wbGF0ZSwgdGhpcy5sYXllckRpc3BsYXlUeXBlLCB0aGlzLmxheWVyLCB0aGlzLkZpZWxkSW5mbyk7XG4gICAgICAgIHRoaXMuZmllbGRzID0gdGhpcy5maWVsZHMuZmlsdGVyKChjdXJyRmllbGQpID0+IHtcbiAgICAgICAgICByZXR1cm4gY3VyckZpZWxkLm5hbWUgIT09IGZpZWxkLm5hbWU7XG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLnNlbGVjdGVkRmllbGRzID0gWy4uLnRoaXMuc2VsZWN0ZWRGaWVsZHNdLmZpbHRlcigoZmllbGROYW1lKSA9PiB7XG4gICAgICAgICAgcmV0dXJuIGZpZWxkTmFtZSAhPT0gZmllbGQubmFtZTtcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMubXVsdGlwbGUgJiZcbiAgICAgICAgICB0aGlzLmFyY2dpc1BvcHVwUGlja0xpc3RDaGFuZ2UuZW1pdCh7XG4gICAgICAgICAgICBzZWxlY3RlZEZpZWxkczogWy4uLm5ldyBTZXQodGhpcy5zZWxlY3RlZEZpZWxkcyldXG4gICAgICAgICAgfSk7XG4gICAgICAgIHRoaXMuYXJjYWRlQ2hhbmdlTm90aWZpY2F0aW9uLmVtaXQoKTtcbiAgICAgIH0gfSkpKSk7XG4gICAgdGhpcy5zZWxlY3RlZEZpZWxkcyA9IFtdO1xuICAgIHRoaXMucG9wb3ZlclByb3BzID0gdW5kZWZpbmVkO1xuICAgIHRoaXMuc2hvd0NhbmNlbCA9IHRydWU7XG4gICAgdGhpcy5tdWx0aXBsZSA9IGZhbHNlO1xuICAgIHRoaXMuaGVhZGluZyA9IHVuZGVmaW5lZDtcbiAgICB0aGlzLm9rQnRuVGV4dCA9IHVuZGVmaW5lZDtcbiAgICB0aGlzLnNob3dGaWx0ZXJMZW5ndGggPSA1O1xuICAgIHRoaXMubnVtYmVyc09ubHkgPSBmYWxzZTtcbiAgICB0aGlzLmxhc3RTb3J0eUJ5ID0gTGFzdFNvcnR5QnkuZGVmYXVsdDtcbiAgICB0aGlzLmZpbHRlckZpZWxkcyA9IG51bGw7XG4gICAgdGhpcy5hcmNhZGVFZGl0b3IgPSB1bmRlZmluZWQ7XG4gIH1cbiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgLy9cbiAgLy8gIExpZmVjeWNsZVxuICAvL1xuICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICBhc3luYyBjb21wb25lbnRXaWxsTG9hZCgpIHtcbiAgICB0aGlzLmxheWVyID0gcG9wdXBTdGF0ZS5sYXllcjtcbiAgICB0aGlzLm1hcFZpZXcgPSBwb3B1cFN0YXRlLm1hcFZpZXc7XG4gICAgdGhpcy5wb3J0YWwgPSBwb3B1cFN0YXRlLnBvcnRhbDtcbiAgICB0aGlzLmNvbmZpZyA9IHBvcHVwU3RhdGUuY29uZmlnO1xuICAgIHRoaXMuc3RyaW5ncyA9IHBvcHVwU3RhdGUuc3RyaW5ncztcbiAgICB0aGlzLmN1cnJlbnRMYW5ndWFnZSA9IHBvcHVwU3RhdGUuY3VycmVudExhbmd1YWdlO1xuICAgIHRoaXMuY3VycmVudExhbmd1YWdlSW50bCA9IHBvcHVwU3RhdGUuY3VycmVudExhbmd1YWdlSW50bDtcbiAgICB0aGlzLnNlcnZpY2VUeXBlID0gcG9wdXBTdGF0ZS5zZXJ2aWNlVHlwZTtcbiAgICB0aGlzLnBvcHVwVGVtcGxhdGUgPSBwb3B1cFN0YXRlLnBvcHVwVGVtcGxhdGU7XG4gICAgdGhpcy5sYXllckRpc3BsYXlUeXBlID0gcG9wdXBTdGF0ZS5sYXllckRpc3BsYXlUeXBlO1xuICAgIHRoaXMuc3VwcG9ydHNBcmNhZGUgPSBwb3B1cFN0YXRlLnN1cHBvcnRzQXJjYWRlO1xuICAgIHRoaXMubGF5ZXJGaWVsZHNNYXAgPSBhd2FpdCBnZW5lcmF0ZUxheWVyRmllbGRzTWFwKHRoaXMubGF5ZXIpO1xuICAgIHRoaXMuYXJjYWRlRXhwTWFwID0gZ2VuZXJhdGVBcmNhZGVFeHByZXNzaW9uTWFwKHRoaXMucG9wdXBUZW1wbGF0ZSk7XG4gICAgdGhpcy5maWVsZHMgPSBhd2FpdCB0aGlzLmdldEZpZWxkcygpO1xuICAgIC8vIGluIGNhc2UgbW9yZSB0aGFuIDEgc2VsZWN0ZWQgZmllbGQgYW5kIG11bHRpcGxlIGlzIHNldCB0byBmYWxzZVxuICAgIGlmICghdGhpcy5tdWx0aXBsZSAmJiB0aGlzLnNlbGVjdGVkRmllbGRzLmxlbmd0aCA+IDEpIHtcbiAgICAgIHRoaXMuc2VsZWN0ZWRGaWVsZHMgPSBbdGhpcy5zZWxlY3RlZEZpZWxkc1swXV07XG4gICAgfVxuICB9XG4gIGFzeW5jIGNvbXBvbmVudERpZExvYWQoKSB7XG4gICAgYXdhaXQgdGhpcy5sb2FkQWxsTW9kdWxlcygpO1xuICAgIHRoaXMucG9wb3Zlck5vZGUub3BlbiA9IHRydWU7XG4gICAgLy8gbmVlZCB0aW1lb3V0IGJlY2F1c2Ugb2YgcmUtcmVuZGVyXG4gICAgc2V0VGltZW91dCgoKSA9PiByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKCkgPT4gdGhpcy5mbG93SXRlbUVsZW1lbnQuc2V0Rm9jdXMoKSksIDIwMCk7XG4gIH1cbiAgY29tcG9uZW50V2lsbFJlbmRlcigpIHtcbiAgICB0aGlzLmFyY2FkZUV4cE1hcCA9IGdlbmVyYXRlQXJjYWRlRXhwcmVzc2lvbk1hcCh0aGlzLnBvcHVwVGVtcGxhdGUpO1xuICAgIHRoaXMuZmllbGRzT25seSA9IFsuLi50aGlzLmdldFNvcnRlZExpc3QoKV0uZmlsdGVyKChmaWVsZCkgPT4ge1xuICAgICAgcmV0dXJuICFmaWVsZC5uYW1lLmluY2x1ZGVzKGZpZWxkSW5mb1ByZWZpeEVudW0uZXhwcmVzc2lvbik7XG4gICAgfSk7XG4gICAgdGhpcy5leHByZXNzaW9uc09ubHkgPSBbLi4udGhpcy5nZXRTb3J0ZWRMaXN0KCldLmZpbHRlcigoZmllbGQpID0+IHtcbiAgICAgIHJldHVybiBmaWVsZC5uYW1lLmluY2x1ZGVzKGZpZWxkSW5mb1ByZWZpeEVudW0uZXhwcmVzc2lvbik7XG4gICAgfSk7XG4gIH1cbiAgLy8gUHVibGljIE1ldGhvZHNcbiAgYXN5bmMgcmVwb3NpdGlvbigpIHtcbiAgICB2YXIgX2E7XG4gICAgKF9hID0gdGhpcy5wb3BvdmVyTm9kZSkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLnJlcG9zaXRpb24oKTtcbiAgfVxuICAvLyB0ZW1wOiBodHRwczovL2dpdGh1Yi5jb20vRXNyaS9jYWxjaXRlLWNvbXBvbmVudHMvaXNzdWVzLzQzMzNcbiAgY2FsY2l0ZUZpbHRlckNoYW5nZUhhbmRsZXIoZXZlbnQpIHtcbiAgICB2YXIgX2EsIF9iO1xuICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgIGNvbnN0IGZpbHRlck5vZGUgPSAoX2EgPSBldmVudCA9PT0gbnVsbCB8fCBldmVudCA9PT0gdm9pZCAwID8gdm9pZCAwIDogZXZlbnQucGF0aCkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmZpbmQoKGl0ZW0pID0+IGl0ZW0ubm9kZU5hbWUgPT09IFwiQ0FMQ0lURS1GSUxURVJcIik7XG4gICAgdGhpcy5maWx0ZXJGaWVsZHMgPSAoX2IgPSBmaWx0ZXJOb2RlID09PSBudWxsIHx8IGZpbHRlck5vZGUgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGZpbHRlck5vZGUuZmlsdGVyZWRJdGVtcykgPT09IG51bGwgfHwgX2IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9iLm1hcCgoaXRlbSkgPT4ge1xuICAgICAgcmV0dXJuIGl0ZW0udmFsdWU7XG4gICAgfSk7XG4gIH1cbiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgLy9cbiAgLy8gUHJpdmF0ZSBNZXRob2RzXG4gIC8vXG4gIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIGdldFNvcnRlZExpc3QoKSB7XG4gICAgY29uc3QgdGVtcFNvcnRlZCA9IFsuLi50aGlzLmZpZWxkc107XG4gICAgaWYgKHRoaXMubGFzdFNvcnR5QnkgPT09IExhc3RTb3J0eUJ5LmRpc3BsYXkpIHtcbiAgICAgIHRlbXBTb3J0ZWQuc29ydCgoYSwgYikgPT4gYS5hbGlhcy5sb2NhbGVDb21wYXJlKGIuYWxpYXMpKTtcbiAgICB9XG4gICAgZWxzZSBpZiAodGhpcy5sYXN0U29ydHlCeSA9PT0gTGFzdFNvcnR5QnkuZmllbGQpIHtcbiAgICAgIHRlbXBTb3J0ZWQuc29ydCgoYSwgYikgPT4gYS5uYW1lLmxvY2FsZUNvbXBhcmUoYi5uYW1lKSk7XG4gICAgfVxuICAgIGVsc2UgaWYgKHRoaXMubGFzdFNvcnR5QnkgPT09IExhc3RTb3J0eUJ5LnR5cGUpIHtcbiAgICAgIHRlbXBTb3J0ZWQuc29ydCgoYSwgYikgPT4gYS50eXBlLmxvY2FsZUNvbXBhcmUoYi50eXBlKSk7XG4gICAgfVxuICAgIHJldHVybiB0ZW1wU29ydGVkO1xuICB9XG4gIC8vIHJldHVybiB0cnVlIGZvciBkZXNlbGVjdCBhbGwsIGZhbHNlIGZvciBzZWxlY3QgYWxsXG4gIHNlbGVjdERlc2VsZWN0KCkge1xuICAgIHZhciBfYTtcbiAgICByZXR1cm4gKChfYSA9IHRoaXMuZmlsdGVyRmllbGRzKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EubGVuZ3RoKVxuICAgICAgPyB0aGlzLmZpbHRlckNvbnRhaW5zQWxsKClcbiAgICAgIDogdGhpcy5zZWxlY3RlZEZpZWxkcy5sZW5ndGggPT09IHRoaXMuZmllbGRzLmxlbmd0aDtcbiAgfVxuICAvLyBjaGVjayBpZiBmaWx0ZXIgaGFzIGFsbCBjdXJyZW50IGZpZWxkIGluZm9cbiAgZmlsdGVyQ29udGFpbnNBbGwoKSB7XG4gICAgcmV0dXJuIHRoaXMuZmlsdGVyRmllbGRzLmV2ZXJ5KChmaWx0ZXIpID0+IHtcbiAgICAgIHJldHVybiB0aGlzLnNlbGVjdGVkRmllbGRzLnNvbWUoKGN1cnIpID0+IHtcbiAgICAgICAgcmV0dXJuIGN1cnIgPT09IGZpbHRlcjtcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9XG4gIGFzeW5jIGxvYWRBbGxNb2R1bGVzKCkge1xuICAgIFt0aGlzLlBvcHVwRXhwcmVzc2lvbkluZm8sIHRoaXMuRmllbGRJbmZvXSA9IGF3YWl0IGxvYWRNb2R1bGVzKFtcbiAgICAgIFwiZXNyaS9wb3B1cC9FeHByZXNzaW9uSW5mb1wiLFxuICAgICAgXCJlc3JpL3BvcHVwL0ZpZWxkSW5mb1wiXG4gICAgXSk7XG4gIH1cbiAgYXN5bmMgbGF1bmNoQXJjYWRlKGN1cnJlbnRFeHByZXNzaW9uKSB7XG4gICAgaWYgKCF0aGlzLmFyY2FkZUVkaXRvcikge1xuICAgICAgdGhpcy5mbG93SXRlbUVsZW1lbnQuZGlzYWJsZWQgPSB0cnVlO1xuICAgICAgdGhpcy5hcmNhZGVFZGl0b3IgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiYXJjZ2lzLW1vZGFsLWFyY2FkZVwiKTtcbiAgICAgIHRoaXMuYXJjYWRlRWRpdG9yLmFyY2FkZVNjcmlwdCA9IGdldEFyY2FkZVNjcmlwdChjdXJyZW50RXhwcmVzc2lvbiA9PT0gbnVsbCB8fCBjdXJyZW50RXhwcmVzc2lvbiA9PT0gdm9pZCAwID8gdm9pZCAwIDogY3VycmVudEV4cHJlc3Npb24uZXhwcmVzc2lvbiwgdGhpcy5sYXllckRpc3BsYXlUeXBlLCB0aGlzLnN0cmluZ3MpO1xuICAgICAgdGhpcy5hcmNhZGVFZGl0b3IuYXJjYWRlUHJvZmlsZSA9IGF3YWl0IGdldEFyY2FkZVByb2ZpbGUodGhpcy5sYXllciwgdGhpcy5tYXBWaWV3LCB0aGlzLnNlcnZpY2VUeXBlLCB0aGlzLnBvcHVwVGVtcGxhdGUsIHRoaXMubGF5ZXJEaXNwbGF5VHlwZSk7XG4gICAgICB0aGlzLmFyY2FkZUVkaXRvci50ZXN0RGF0YSA9IGF3YWl0IGdldFRlc3REYXRhKHRoaXMubGF5ZXIsIHRoaXMubWFwVmlldywgdGhpcy5sYXllckRpc3BsYXlUeXBlLCB0aGlzLnBvcHVwVGVtcGxhdGUpO1xuICAgICAgdGhpcy5hcmNhZGVFZGl0b3IuYWRkRXhpc3RpbmdFeHByZXNzaW9ucyA9IHRydWU7XG4gICAgICB0aGlzLmFyY2FkZUVkaXRvci5sYXllciA9IHRoaXMubGF5ZXI7XG4gICAgICB0aGlzLmFyY2FkZUVkaXRvci5hcmNhZGVUaXRsZSA9IChjdXJyZW50RXhwcmVzc2lvbiA9PT0gbnVsbCB8fCBjdXJyZW50RXhwcmVzc2lvbiA9PT0gdm9pZCAwID8gdm9pZCAwIDogY3VycmVudEV4cHJlc3Npb24udGl0bGUpIHx8IHRoaXMuc3RyaW5ncy5hcmNhZGVEZWZhdWx0VGl0bGU7XG4gICAgICB0aGlzLmFyY2FkZUVkaXRvci5hcmNhZGVUaXRsZUVkaXRhYmxlID0gdHJ1ZTtcbiAgICAgIHRoaXMuYXJjYWRlRWRpdG9yLmFyY2FkZVRpdGxlRWRpdGluZ0VuYWJsZWQgPSAhKGN1cnJlbnRFeHByZXNzaW9uID09PSBudWxsIHx8IGN1cnJlbnRFeHByZXNzaW9uID09PSB2b2lkIDAgPyB2b2lkIDAgOiBjdXJyZW50RXhwcmVzc2lvbi50aXRsZSk7XG4gICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHRoaXMuYXJjYWRlRWRpdG9yKTtcbiAgICAgIHRoaXMuYXJjYWRlRWRpdG9yLmFkZEV2ZW50TGlzdGVuZXIoXCJhcmNnaXNNb2RhbEFyY2FkZUNsb3NlXCIsIChldmVudCkgPT4gdGhpcy5hcmNhZGVTZXR1cChldmVudC5kZXRhaWwsIGN1cnJlbnRFeHByZXNzaW9uKSk7XG4gICAgfVxuICB9XG4gIGFzeW5jIGFyY2FkZVNldHVwKGFyY2FkZU9iamVjdCwgY3VycmVudEV4cHJlc3Npb24pIHtcbiAgICBpZiAoYXJjYWRlT2JqZWN0KSB7XG4gICAgICBjb25zdCBwb3B1cEV4cHJlc3Npb24gPSBzZXRFeHByZXNzaW9uSW5mb0luUG9wdXBUZW1wbGF0ZShhcmNhZGVPYmplY3QsIGN1cnJlbnRFeHByZXNzaW9uID09PSBudWxsIHx8IGN1cnJlbnRFeHByZXNzaW9uID09PSB2b2lkIDAgPyB2b2lkIDAgOiBjdXJyZW50RXhwcmVzc2lvbi5uYW1lLCB0aGlzLlBvcHVwRXhwcmVzc2lvbkluZm8sIHRoaXMucG9wdXBUZW1wbGF0ZSk7XG4gICAgICBhd2FpdCBzZXRMYXllckV4cHJlc3Npb25BbmRGaWVsZEluZm8odGhpcy5wb3B1cFRlbXBsYXRlLCB0aGlzLmxheWVyRGlzcGxheVR5cGUsIHRoaXMubGF5ZXIsIHRoaXMuRmllbGRJbmZvKTtcbiAgICAgIGNvbnN0IGV4cE5hbWUgPSBgJHtmaWVsZEluZm9QcmVmaXhFbnVtLmV4cHJlc3Npb259JHtwb3B1cEV4cHJlc3Npb24ubmFtZX1gO1xuICAgICAgdGhpcy5maWVsZHMucHVzaCh7XG4gICAgICAgIG5hbWU6IGV4cE5hbWUsXG4gICAgICAgIGFsaWFzOiBwb3B1cEV4cHJlc3Npb24udGl0bGUsXG4gICAgICAgIHR5cGU6IHBvcHVwRXhwcmVzc2lvbi5yZXR1cm5UeXBlXG4gICAgICB9KTtcbiAgICAgIC8vIHJlbW92ZSBkdXBsaWNhdGVzXG4gICAgICB0aGlzLmZpZWxkcyA9IFtcbiAgICAgICAgLi4ubmV3IE1hcCh0aGlzLmZpZWxkcy5tYXAoKGl0ZW0pID0+IFtpdGVtLm5hbWUsIGl0ZW1dKSkudmFsdWVzKClcbiAgICAgIF07XG4gICAgICBpZiAodGhpcy5tdWx0aXBsZSkge1xuICAgICAgICB0aGlzLnNlbGVjdGVkRmllbGRzLnB1c2goZXhwTmFtZSk7XG4gICAgICB9XG4gICAgICBlbHNlIHtcbiAgICAgICAgdGhpcy5zZWxlY3RlZEZpZWxkcyA9IFtleHBOYW1lXTtcbiAgICAgIH1cbiAgICAgIHRoaXMuYXJjZ2lzUG9wdXBQaWNrTGlzdENoYW5nZS5lbWl0KHsgc2VsZWN0ZWRGaWVsZHM6IFsuLi5uZXcgU2V0KHRoaXMuc2VsZWN0ZWRGaWVsZHMpXSB9KTtcbiAgICAgIHRoaXMuYXJjYWRlQ2hhbmdlTm90aWZpY2F0aW9uLmVtaXQoKTtcbiAgICB9XG4gICAgdGhpcy5mbG93SXRlbUVsZW1lbnQuZGlzYWJsZWQgPSBmYWxzZTtcbiAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKHRoaXMuYXJjYWRlRWRpdG9yKTtcbiAgICB0aGlzLmFyY2FkZUVkaXRvciA9IG51bGw7XG4gIH1cbiAgYXN5bmMgZ2V0RmllbGRzKCkge1xuICAgIGNvbnN0IHRlbXBGaWVsZEFuZEZpZWxkSW5mbyA9IFtdO1xuICAgIGxldCBmaWVsZHNPcmRlckluU2VydmljZSA9IGF3YWl0IGdldEZpZWxkc0Zyb21MYXllcih0aGlzLmxheWVyKTtcbiAgICBmaWVsZHNPcmRlckluU2VydmljZSA9IGZpZWxkc09yZGVySW5TZXJ2aWNlLmZpbHRlcigoZmllbGQpID0+IGZpZWxkLnZpc2libGUpO1xuICAgIC8vIG1hcCBmaWVsZEluZm9zIGZvciBmYXN0ZXIgYWNjZXNzXG4gICAgY29uc3QgZmllbGRJbmZvTWFwID0gbmV3IE1hcCh0aGlzLnBvcHVwVGVtcGxhdGUuZmllbGRJbmZvcy5tYXAoKGZpZWxkSW5mbykgPT4gW1xuICAgICAgZmllbGRJbmZvLmZpZWxkTmFtZSxcbiAgICAgIGZpZWxkSW5mb1xuICAgIF0pKTtcbiAgICAvLyBvcmRlciBiYXNlZCBvbiBvcmRlciBvZiBmaWVsZHMgaW4gdGhlIHNlcnZpY2VcbiAgICBmaWVsZHNPcmRlckluU2VydmljZS5mb3JFYWNoKChsYXllckZpZWxkKSA9PiB7XG4gICAgICBpZiAoZmllbGRJbmZvTWFwLmhhcyhsYXllckZpZWxkLm5hbWUpKSB7XG4gICAgICAgIGNvbnN0IGZpZWxkSW5mbyA9IGZpZWxkSW5mb01hcC5nZXQobGF5ZXJGaWVsZC5uYW1lKTtcbiAgICAgICAgdGVtcEZpZWxkQW5kRmllbGRJbmZvLnB1c2goe1xuICAgICAgICAgIG5hbWU6IGZpZWxkSW5mby5maWVsZE5hbWUsXG4gICAgICAgICAgYWxpYXM6IGdldEZpZWxkRGlzcGxheU5hbWUoZmllbGRJbmZvLCB0aGlzLmFyY2FkZUV4cE1hcCksXG4gICAgICAgICAgdHlwZTogZ2V0RmllbGRUeXBlKGZpZWxkSW5mby5maWVsZE5hbWUsIHRoaXMubGF5ZXJGaWVsZHNNYXAsIHRoaXMuYXJjYWRlRXhwTWFwKVxuICAgICAgICB9KTtcbiAgICAgICAgLy8gZGVsZXRlIGZyb20gbWFwXG4gICAgICAgIGZpZWxkSW5mb01hcC5kZWxldGUobGF5ZXJGaWVsZC5uYW1lKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICAvLyBhZGQgcmVtYWluaW5nIGZpZWxkcyBpbiBwb3B1cHRlbXBsYXRlLiBlLmcuIGFyY2FkZSwgcmVsYXRlZFxuICAgIGZpZWxkSW5mb01hcC5mb3JFYWNoKChmaWVsZEluZm8pID0+IHtcbiAgICAgIHRlbXBGaWVsZEFuZEZpZWxkSW5mby5wdXNoKHtcbiAgICAgICAgbmFtZTogZmllbGRJbmZvLmZpZWxkTmFtZSxcbiAgICAgICAgYWxpYXM6IGdldEZpZWxkRGlzcGxheU5hbWUoZmllbGRJbmZvLCB0aGlzLmFyY2FkZUV4cE1hcCksXG4gICAgICAgIHR5cGU6IGdldEZpZWxkVHlwZShmaWVsZEluZm8uZmllbGROYW1lLCB0aGlzLmxheWVyRmllbGRzTWFwLCB0aGlzLmFyY2FkZUV4cE1hcClcbiAgICAgIH0pO1xuICAgIH0pO1xuICAgIGlmICh0aGlzLm51bWJlcnNPbmx5KSB7XG4gICAgICAvLyBzZXQgZm9yIGZhc3RlciBsb29rdXBcbiAgICAgIGNvbnN0IHNlbGVjdGVkRmllbGRzU2V0ID0gbmV3IFNldCh0aGlzLnNlbGVjdGVkRmllbGRzKTtcbiAgICAgIHJldHVybiB0ZW1wRmllbGRBbmRGaWVsZEluZm8uZmlsdGVyKChjdXJyRmllbGRBbmRGaWVsZEluZm8pID0+IHtcbiAgICAgICAgY29uc3QgZmllbGRUeXBlID0gY3VyckZpZWxkQW5kRmllbGRJbmZvLnR5cGUudG9Mb3dlckNhc2UoKTtcbiAgICAgICAgaWYgKChzZWxlY3RlZEZpZWxkc1NldC5oYXMoY3VyckZpZWxkQW5kRmllbGRJbmZvLm5hbWUpIHx8XG4gICAgICAgICAgZmllbGRUeXBlID09PSBmaWVsZFR5cGVzRW51bS5pbnRlZ2VyIHx8XG4gICAgICAgICAgZmllbGRUeXBlID09PSBmaWVsZFR5cGVzRW51bS5zbWFsbEludGVnZXIgfHxcbiAgICAgICAgICBmaWVsZFR5cGUgPT09IGZpZWxkVHlwZXNFbnVtLmJpZ0ludGVnZXIgfHxcbiAgICAgICAgICBmaWVsZFR5cGUgPT09IGZpZWxkVHlwZXNFbnVtLnNpbmdsZSB8fFxuICAgICAgICAgIGZpZWxkVHlwZSA9PT0gZmllbGRUeXBlc0VudW0uZG91YmxlIHx8XG4gICAgICAgICAgZmllbGRUeXBlID09PSBmaWVsZFR5cGVzRW51bS5sb25nIHx8XG4gICAgICAgICAgZmllbGRUeXBlID09PSBmaWVsZFR5cGVzRW51bS5udW1iZXIgfHxcbiAgICAgICAgICBmaWVsZFR5cGUgPT09IGZpZWxkVHlwZXNFbnVtLm9pZCkgJiZcbiAgICAgICAgICAhY3VyckZpZWxkQW5kRmllbGRJbmZvLm5hbWUuaW5jbHVkZXMoZmllbGRJbmZvUHJlZml4RW51bS5yZWxhdGlvbnNoaXApKSB7XG4gICAgICAgICAgcmV0dXJuIGN1cnJGaWVsZEFuZEZpZWxkSW5mbztcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuICAgIHJldHVybiB0ZW1wRmllbGRBbmRGaWVsZEluZm87XG4gIH1cbiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgLy9cbiAgLy8gUmVuZG9yICBNZXRob2RzXG4gIC8vXG4gIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIHJlbmRlcigpIHtcbiAgICBjb25zdCBhZGRCdG4gPSAoaChcImNhbGNpdGUtYnV0dG9uXCIsIHsgYXBwZWFyYW5jZTogdGhpcy5zaG93Q2FuY2VsID8gXCJzb2xpZFwiIDogXCJvdXRsaW5lLWZpbGxcIiwgd2lkdGg6IHRoaXMuc2hvd0NhbmNlbCA/IFwiaGFsZlwiIDogXCJmdWxsXCIsIHNjYWxlOiBcIm1cIiwgb25DbGljazogKCkgPT4ge1xuICAgICAgICB0aGlzLmFyY2dpc1BvcHVwUGlja0xpc3REaXNtaXNzZWQuZW1pdCh7XG4gICAgICAgICAgc2VsZWN0ZWRGaWVsZHM6IFsuLi5uZXcgU2V0KHRoaXMuc2VsZWN0ZWRGaWVsZHMpXVxuICAgICAgICB9KTtcbiAgICAgIH0gfSwgdGhpcy5va0J0blRleHQgfHwgKHRoaXMubXVsdGlwbGUgPyB0aGlzLnN0cmluZ3MuZG9uZSA6IHRoaXMuc3RyaW5ncy5vaykpKTtcbiAgICBjb25zdCBjYW5jZWxCdG4gPSAoaChcImNhbGNpdGUtYnV0dG9uXCIsIHsgYXBwZWFyYW5jZTogXCJvdXRsaW5lLWZpbGxcIiwgd2lkdGg6IHRoaXMubXVsdGlwbGUgPyBcImhhbGZcIiA6IFwiZnVsbFwiLCBzY2FsZTogXCJtXCIsIG9uQ2xpY2s6ICgpID0+IHRoaXMuYXJjZ2lzUG9wdXBQaWNrTGlzdERpc21pc3NlZC5lbWl0KCkgfSwgdGhpcy5zdHJpbmdzLmNhbmNlbCkpO1xuICAgIGNvbnN0IHNvcnQgPSAoaChcImNhbGNpdGUtZHJvcGRvd25cIiwgeyBzbG90OiBcIm1lbnUtYWN0aW9uc1wiLCBwbGFjZW1lbnQ6IFwiYm90dG9tLWVuZFwiLCBvdmVybGF5UG9zaXRpb25pbmc6IFwiZml4ZWRcIiB9LCBoKFwiY2FsY2l0ZS1hY3Rpb25cIiwgeyBzbG90OiBcInRyaWdnZXJcIiwgdGV4dDogdGhpcy5zdHJpbmdzLnNvcnQsIHRpdGxlOiB0aGlzLnN0cmluZ3Muc29ydCB9LCBoKFwiY2FsY2l0ZS1pY29uXCIsIHsgc2NhbGU6IFwic1wiLCBpY29uOiBcInNvcnREZXNjZW5kaW5nXCIgfSkpLCBoKFwiY2FsY2l0ZS1kcm9wZG93bi1ncm91cFwiLCBudWxsLCBoKFwiY2FsY2l0ZS1kcm9wZG93bi1pdGVtXCIsIHsgc2VsZWN0ZWQ6IHRoaXMubGFzdFNvcnR5QnkgPT09IExhc3RTb3J0eUJ5LmRlZmF1bHQsIG9uQ2xpY2s6ICgpID0+ICh0aGlzLmxhc3RTb3J0eUJ5ID0gTGFzdFNvcnR5QnkuZGVmYXVsdCkgfSwgdGhpcy5zdHJpbmdzLmRlZmF1bHQpLCBoKFwiY2FsY2l0ZS1kcm9wZG93bi1pdGVtXCIsIHsgc2VsZWN0ZWQ6IHRoaXMubGFzdFNvcnR5QnkgPT09IExhc3RTb3J0eUJ5LmRpc3BsYXksIG9uQ2xpY2s6ICgpID0+ICh0aGlzLmxhc3RTb3J0eUJ5ID0gTGFzdFNvcnR5QnkuZGlzcGxheSkgfSwgdGhpcy5zdHJpbmdzLmRpc3BsYXlOYW1lKSwgaChcImNhbGNpdGUtZHJvcGRvd24taXRlbVwiLCB7IHNlbGVjdGVkOiB0aGlzLmxhc3RTb3J0eUJ5ID09PSBMYXN0U29ydHlCeS50eXBlLCBvbkNsaWNrOiAoKSA9PiAodGhpcy5sYXN0U29ydHlCeSA9IExhc3RTb3J0eUJ5LnR5cGUpIH0sIHRoaXMuc3RyaW5ncy50eXBlKSwgaChcImNhbGNpdGUtZHJvcGRvd24taXRlbVwiLCB7IHNlbGVjdGVkOiB0aGlzLmxhc3RTb3J0eUJ5ID09PSBMYXN0U29ydHlCeS5maWVsZCwgb25DbGljazogKCkgPT4gKHRoaXMubGFzdFNvcnR5QnkgPSBMYXN0U29ydHlCeS5maWVsZCkgfSwgdGhpcy5zdHJpbmdzLmZpZWxkTmFtZSkpKSk7XG4gICAgY29uc3Qgc2VsZWN0aW9uQnRuID0gKGgoXCJkaXZcIiwgeyBjbGFzczogXCJzZWxlY3Rpb24tYnV0dG9uLWRpdlwiIH0sIGgoXCJjYWxjaXRlLWJ1dHRvblwiLCB7IGFwcGVhcmFuY2U6IFwidHJhbnNwYXJlbnRcIiwgc2NhbGU6IFwibVwiLCB3aWR0aDogXCJmdWxsXCIsIGNsYXNzOiBcInNlbGVjdGlvbi1idXR0b25cIiwgb25DbGljazogKCkgPT4ge1xuICAgICAgICB2YXIgX2EsIF9iO1xuICAgICAgICBpZiAodGhpcy5zZWxlY3REZXNlbGVjdCgpKSB7XG4gICAgICAgICAgLy9kZXNlbGVjdCBhbGxcbiAgICAgICAgICB0aGlzLnNlbGVjdGVkRmllbGRzID0gKChfYSA9IHRoaXMuZmlsdGVyRmllbGRzKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EubGVuZ3RoKVxuICAgICAgICAgICAgPyB0aGlzLnNlbGVjdGVkRmllbGRzLmZpbHRlcigoaXRlbSkgPT4gIXRoaXMuZmlsdGVyRmllbGRzLmluY2x1ZGVzKGl0ZW0pKVxuICAgICAgICAgICAgOiBbXTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAvL3NlbGVjdCBhbGxcbiAgICAgICAgICB0aGlzLnNlbGVjdGVkRmllbGRzID0gKChfYiA9IHRoaXMuZmlsdGVyRmllbGRzKSA9PT0gbnVsbCB8fCBfYiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2IubGVuZ3RoKVxuICAgICAgICAgICAgPyBbLi4ubmV3IFNldChbLi4udGhpcy5zZWxlY3RlZEZpZWxkcywgLi4udGhpcy5maWx0ZXJGaWVsZHNdKV1cbiAgICAgICAgICAgIDogdGhpcy5maWVsZHMubWFwKChmaWVsZCkgPT4ge1xuICAgICAgICAgICAgICByZXR1cm4gZmllbGQubmFtZTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICB9IH0sIHRoaXMuc2VsZWN0RGVzZWxlY3QoKSA/IHRoaXMuc3RyaW5ncy5kZXNlbGVjdEFsbCA6IHRoaXMuc3RyaW5ncy5zZWxlY3RBbGwpKSk7XG4gICAgY29uc3QgYWRkRXhwcmVzc2lvbnNCdG4gPSAoaChcImNhbGNpdGUtYnV0dG9uXCIsIHsgYXBwZWFyYW5jZTogXCJ0cmFuc3BhcmVudFwiLCBzY2FsZTogXCJtXCIsIHdpZHRoOiBcImZ1bGxcIiwgaWNvblN0YXJ0OiBcInBsdXNcIiwgY2xhc3M6IFwiYWRkLWV4cHJlc3Npb24tYnV0dG9uXCIsIG9uQ2xpY2s6ICgpID0+IHtcbiAgICAgICAgdGhpcy5sYXVuY2hBcmNhZGUoKTtcbiAgICAgIH0gfSwgdGhpcy5zdHJpbmdzLmFkZEV4cHJlc3Npb24pKTtcbiAgICByZXR1cm4gKGgoSG9zdCwgeyBjbGFzczogXCJqcy1hcHAtZmx5b3V0XCIgfSwgaChcImNhbGNpdGUtcG9wb3ZlclwiLCB7IGRpcjogZ2V0RWxlbWVudERpcih0aGlzLmhvc3RFbGVtZW50KSwgY2xhc3M6IFwicG9wb3ZlclwiLCBwbGFjZW1lbnQ6IHRoaXMucG9wb3ZlclByb3BzLnBsYWNlbWVudCB8fCBcImxlYWRpbmctc3RhcnRcIiwgb3BlbjogZmFsc2UsIHBvaW50ZXJEaXNhYmxlZDogdHJ1ZSwgcmVmZXJlbmNlRWxlbWVudDogdGhpcy5wb3BvdmVyUHJvcHMucmVmRWxlbWVudCwgb2Zmc2V0RGlzdGFuY2U6IHRoaXMucG9wb3ZlclByb3BzLm9mZnNldERpc3RhbmNlIHx8XG4gICAgICAgIC1NYXRoLnJvdW5kKHRoaXMucG9wb3ZlclByb3BzLnJlZkVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkud2lkdGgpLCBvZmZzZXRTa2lkZGluZzogdGhpcy5wb3BvdmVyUHJvcHMub2Zmc2V0U2tpZGRpbmcgfHwgNTAsIGxhYmVsOiB0aGlzLmhlYWRpbmcsIHRyaWdnZXJEaXNhYmxlZDogdHJ1ZSwgcmVmOiAobm9kZSkgPT4gKHRoaXMucG9wb3Zlck5vZGUgPSBub2RlKSB9LCBoKFwiY2FsY2l0ZS1mbG93XCIsIHsgcmVmOiAobm9kZSkgPT4ge1xuICAgICAgICB0aGlzLmZsb3dFbGVtZW50ID0gbm9kZTtcbiAgICAgIH0sIHN0eWxlOiB7XG4gICAgICAgIHdpZHRoOiBgJHt0aGlzLnBvcG92ZXJQcm9wcy5wb3BvdmVyV2lkdGggfHxcbiAgICAgICAgICB0aGlzLnBvcG92ZXJQcm9wcy5yZWZFbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLndpZHRofXB4YFxuICAgICAgfSB9LCBoKFwiY2FsY2l0ZS1mbG93LWl0ZW1cIiwgeyByZWY6IChlbCkgPT4gKHRoaXMuZmxvd0l0ZW1FbGVtZW50ID0gZWwpLCBjbGFzczogXCJwYW5lbFwiLCBoZWFkaW5nOiB0aGlzLmhlYWRpbmcsIGNsb3NhYmxlOiB0cnVlLCBvbkNhbGNpdGVGbG93SXRlbUNsb3NlOiAoKSA9PiB0aGlzLmFyY2dpc1BvcHVwUGlja0xpc3REaXNtaXNzZWQuZW1pdCgpIH0sIGgoXCJkaXZcIiwgeyBjbGFzczogXCJmb290ZXJcIiwgc2xvdDogXCJmb290ZXJcIiB9LCB0aGlzLnN1cHBvcnRzQXJjYWRlICYmIGFkZEV4cHJlc3Npb25zQnRuLCB0aGlzLm11bHRpcGxlICYmIGFkZEJ0biwgdGhpcy5zaG93Q2FuY2VsICYmIGNhbmNlbEJ0biksIGgoXCJjYWxjaXRlLXBpY2stbGlzdFwiLCB7IGNsYXNzOiBcImNvbnRlbnRcIiwgbXVsdGlwbGU6IHRoaXMubXVsdGlwbGUsIHJlZjogKG5vZGUpID0+IHtcbiAgICAgICAgdGhpcy5waWNrTGlzdE5vZGUgPSBub2RlO1xuICAgICAgfSwgZmlsdGVyRW5hYmxlZDogdGhpcy5maWVsZHMubGVuZ3RoID49IHRoaXMuc2hvd0ZpbHRlckxlbmd0aCA/IHRydWUgOiBmYWxzZSwgZmlsdGVyUGxhY2Vob2xkZXI6IHRoaXMuc3RyaW5ncy5zZWFyY2hGaWVsZHMsIG9uQ2FsY2l0ZUxpc3RDaGFuZ2U6IGFzeW5jICgpID0+IHtcbiAgICAgICAgLy8ga2VlcCBvcmlnaW5hbCBvcmRlci4gQWRkIGFkZGlvbmFsIHZhbHVlcyBhdCB0aGUgZW5kXG4gICAgICAgIGNvbnN0IHRlbXBTZWxlY3RlZEZpZWxkcyA9IGF3YWl0IHRoaXMucGlja0xpc3ROb2RlLmdldFNlbGVjdGVkSXRlbXMoKTtcbiAgICAgICAgdGhpcy5zZWxlY3RlZEZpZWxkcyA9IFtcbiAgICAgICAgICAuLi5uZXcgU2V0KFtcbiAgICAgICAgICAgIC4uLnRoaXMuc2VsZWN0ZWRGaWVsZHMuZmlsdGVyKChpdGVtKSA9PiB7XG4gICAgICAgICAgICAgIHJldHVybiB0ZW1wU2VsZWN0ZWRGaWVsZHMuaGFzKGl0ZW0pO1xuICAgICAgICAgICAgfSksXG4gICAgICAgICAgICAuLi50ZW1wU2VsZWN0ZWRGaWVsZHMua2V5cygpXG4gICAgICAgICAgXSlcbiAgICAgICAgXTtcbiAgICAgICAgdGhpcy5hcmNnaXNQb3B1cFBpY2tMaXN0Q2hhbmdlLmVtaXQoe1xuICAgICAgICAgIHNlbGVjdGVkRmllbGRzOiB0aGlzLnNlbGVjdGVkRmllbGRzXG4gICAgICAgIH0pO1xuICAgICAgICBpZiAoIXRoaXMubXVsdGlwbGUpIHtcbiAgICAgICAgICB0aGlzLmFyY2dpc1BvcHVwUGlja0xpc3REaXNtaXNzZWQuZW1pdCh7IHNlbGVjdGVkRmllbGRzOiB0aGlzLnNlbGVjdGVkRmllbGRzIH0pO1xuICAgICAgICB9XG4gICAgICB9IH0sIHRoaXMuZmllbGRzLmxlbmd0aCA+PSB0aGlzLnNob3dGaWx0ZXJMZW5ndGggJiYgc29ydCwgdGhpcy5tdWx0aXBsZSAmJiBzZWxlY3Rpb25CdG4sIHRoaXMuc3VwcG9ydHNBcmNhZGUgJiYgKGgoXCJjYWxjaXRlLXBpY2stbGlzdC1ncm91cFwiLCB7IFwiZ3JvdXAtdGl0bGVcIjogdGhpcy5zdHJpbmdzLmV4cHJlc3Npb25zIH0sIHRoaXMuZXhwcmVzc2lvbnNPbmx5Lmxlbmd0aCA/ICh0aGlzLmV4cHJlc3Npb25zT25seS5tYXAoKGZpZWxkKSA9PiB7XG4gICAgICByZXR1cm4gdGhpcy5jYWxjaXRlRXhwcmVzc2lvbnNPbmx5VmFsdWVMaXN0KGZpZWxkKTtcbiAgICB9KSkgOiAoaChcImNhbGNpdGUtbGFiZWxcIiwgeyBhbGlnbm1lbnQ6IFwiY2VudGVyXCIgfSwgdGhpcy5zdHJpbmdzLm5vRXhwcmVzc2lvbnMpKSkpLCBoKFwiY2FsY2l0ZS1waWNrLWxpc3QtZ3JvdXBcIiwgeyBncm91cFRpdGxlOiB0aGlzLnN1cHBvcnRzQXJjYWRlID8gdGhpcy5zdHJpbmdzLmF0dHJpYnV0ZXMgOiBudWxsIH0sIHRoaXMuZmllbGRzT25seS5tYXAoKGZpZWxkKSA9PiB7XG4gICAgICByZXR1cm4gdGhpcy5jYWxjaXRlRmllbGRPbmx5VmFsdWVMaXN0KGZpZWxkKTtcbiAgICB9KSkpKSkpKSk7XG4gIH1cbiAgZ2V0IGhvc3RFbGVtZW50KCkgeyByZXR1cm4gZ2V0RWxlbWVudCh0aGlzKTsgfVxufTtcbkFyY2dpc1BvcHVwRmllbGRQaWNrTGlzdC5zdHlsZSA9IGFyY2dpc1BvcHVwRmllbGRQaWNrTGlzdENzcztcblxuY29uc3QgQ1NTJDIgPSB7XG4gIHBvcG92ZXJJbWFnZURpdjogXCJwb3BvdmVyLWltYWdlLWRpdlwiLFxuICBmb3JtSW5wdXRCdXR0b246IFwiZm9ybS1pbnB1dC1idXR0b25cIixcbiAgcmVmcmVzaEltYWdlSW5wdXQ6IFwicmVmcmVzaC1pbWFnZS1pbnB1dFwiXG59O1xuXG5jb25zdCBhcmNnaXNQb3B1cEltYWdlQ3NzID0gXCIucG9wb3Zlci1pbWFnZS1kaXZ7YmFja2dyb3VuZC1jb2xvcjp2YXIoLS1hcmNnaXMtYXBwLWJhY2tncm91bmQpO3BhZGRpbmc6dmFyKC0tYXJjZ2lzLWFwcC1jYXAtc3BhY2luZykgdmFyKC0tYXJjZ2lzLWFwcC1zaWRlLXNwYWNpbmctaGFsZik7bWF4LWhlaWdodDpjYWxjKDYwdmggLSAxMDJweCk7fS5yZWZyZXNoLWxhYmVse21hcmdpbi10b3A6NnB4fS5mb3JtLWlucHV0LWJ1dHRvbntkaXNwbGF5OmZsZXh9LmZvcm0taW5wdXQtYnV0dG9uIGNhbGNpdGUtaW5wdXRbdHlwZT10ZXh0XXtkaXNwbGF5OmZsZXg7ZmxleC1mbG93OmNvbHVtbiBub3dyYXA7ZmxleDoxIDAgMCU7b3ZlcmZsb3c6aGlkZGVufS5mb3JtLWlucHV0LWJ1dHRvbiBjYWxjaXRlLWFjdGlvbnttYXJnaW46MDtmbGV4OjAgMCAwJTtqdXN0aWZ5LXNlbGY6ZmxleC1lbmR9LnJlZnJlc2gtaW1hZ2UtaW5wdXR7d2lkdGg6NXJlbX1cIjtcblxuY29uc3QgQXJjZ2lzUG9wdXBJbWFnZSA9IGNsYXNzIHtcbiAgY29uc3RydWN0b3IoaG9zdFJlZikge1xuICAgIHJlZ2lzdGVySW5zdGFuY2UodGhpcywgaG9zdFJlZik7XG4gICAgdGhpcy5jbG9zZVBvcHVwUG9wb3ZlcnMgPSBjcmVhdGVFdmVudCh0aGlzLCBcImNsb3NlUG9wdXBQb3BvdmVyc1wiLCA3KTtcbiAgICB0aGlzLmltYWdlQ2hhbmdlZFJlUmVuZGVyID0gY3JlYXRlRXZlbnQodGhpcywgXCJpbWFnZUNoYW5nZWRSZVJlbmRlclwiLCA3KTtcbiAgICB0aGlzLm5vdGlmeU11bHRpTWVkaWFDaGFuZ2UgPSBjcmVhdGVFdmVudCh0aGlzLCBcIm5vdGlmeU11bHRpTWVkaWFDaGFuZ2VcIiwgNyk7XG4gICAgdGhpcy5jaGFuZ2VJbWFnZVByb3BlcnRpZXMgPSAoZXZlbnQpID0+IHtcbiAgICAgIGV2ZW50ID09PSBudWxsIHx8IGV2ZW50ID09PSB2b2lkIDAgPyB2b2lkIDAgOiBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgIGV2ZW50ID09PSBudWxsIHx8IGV2ZW50ID09PSB2b2lkIDAgPyB2b2lkIDAgOiBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgLy8gaGlkZSByZXN0IG9mIHRoZSBjb21wb25lbnQuXG4gICAgICB0aGlzLmltYWdlTWVkaWFJbmZvLnZhbHVlLnNvdXJjZVVSTCA9IHRoaXMuZWRpdEltYWdlVXJsLnZhbHVlO1xuICAgICAgdGhpcy5pbWFnZU1lZGlhSW5mby50aXRsZSA9IHRoaXMuZWRpdEltYWdlVGl0bGUudmFsdWU7XG4gICAgICB0aGlzLmltYWdlTWVkaWFJbmZvLnJlZnJlc2hJbnRlcnZhbCA9IHRoaXMuZWRpdFJlZnJlc2hJbWFnZS52YWx1ZSB8fCAwO1xuICAgICAgdGhpcy5pbWFnZU1lZGlhSW5mby5jYXB0aW9uID0gdGhpcy5lZGl0SW1hZ2VDYXB0aW9uLnZhbHVlO1xuICAgICAgdGhpcy5pbWFnZU1lZGlhSW5mby5hbHRUZXh0ID0gdGhpcy5lZGl0QWx0VGV4dC52YWx1ZTtcbiAgICAgIHRoaXMuaW1hZ2VNZWRpYUluZm8udmFsdWUubGlua1VSTCA9IHRoaXMuZWRpdEltYWdlTGlua1VybC52YWx1ZTtcbiAgICAgIHRoaXMuaW1hZ2VDaGFuZ2VkUmVSZW5kZXIuZW1pdCgpO1xuICAgIH07XG4gICAgLy8gb3BlbiBwb3BvdmVyXG4gICAgdGhpcy5vcGVuQXR0cmlidXRlc0xpc3QgPSAoaW1hZ2VDb21wb25lbnRJbnB1dFR5cGUpID0+IHtcbiAgICAgIC8vIGNsb3NlIGZpcnN0IHNpbmNlIHdlIGNhbiBoYXZlIG11bHRpcGxlIGF0dHJpYnV0ZXMgb3BlblxuICAgICAgdGhpcy5jbG9zZVBvcHVwUG9wb3ZlcnMuZW1pdCh0aGlzLmd1aWQpO1xuICAgICAgLy8gbGF6eSBsb2FkIGF0dHJpYnV0ZSBzZWxlY3Rpb24gY29tcG9uZW50XG4gICAgICBpZiAoIXRoaXMucG9wdXBGaWVsZFNlbGVjdGlvblBpY2tMaXN0KSB7XG4gICAgICAgIHRoaXMucG9wdXBGaWVsZFNlbGVjdGlvblBpY2tMaXN0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImFyY2dpcy1wb3B1cC1maWVsZC1waWNrLWxpc3RcIik7XG4gICAgICAgIHRoaXMucG9wdXBGaWVsZFNlbGVjdGlvblBpY2tMaXN0LnBvcG92ZXJQcm9wcyA9IHtcbiAgICAgICAgICByZWZFbGVtZW50OiB0aGlzLnBhbmVsRWxlbWVudFxuICAgICAgICB9O1xuICAgICAgICB0aGlzLnBvcHVwRmllbGRTZWxlY3Rpb25QaWNrTGlzdC5tdWx0aXBsZSA9IGZhbHNlO1xuICAgICAgICB0aGlzLnBvcHVwRmllbGRTZWxlY3Rpb25QaWNrTGlzdC5oZWFkaW5nID0gdGhpcy5zdHJpbmdzLmFkZEZpZWxkO1xuICAgICAgICB0aGlzLnBvcHVwRmllbGRTZWxlY3Rpb25QaWNrTGlzdC5hZGRFdmVudExpc3RlbmVyKFwiYXJjZ2lzUG9wdXBQaWNrTGlzdERpc21pc3NlZFwiLCAoKSA9PiB7XG4gICAgICAgICAgdGhpcy5jbG9zZVBvcHVwUG9wb3ZlcnMuZW1pdCh0aGlzLmd1aWQpO1xuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5wb3B1cEZpZWxkU2VsZWN0aW9uUGlja0xpc3QuYWRkRXZlbnRMaXN0ZW5lcihcImFyY2dpc1BvcHVwUGlja0xpc3RDaGFuZ2VcIiwgKGV2ZW50KSA9PiB0aGlzLnBvcHVwRmllbGRTZWxlY3Rpb25QaWNrTGlzdENoYW5nZXMoZXZlbnQsIGltYWdlQ29tcG9uZW50SW5wdXRUeXBlKSk7XG4gICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQodGhpcy5wb3B1cEZpZWxkU2VsZWN0aW9uUGlja0xpc3QpO1xuICAgICAgICB0aGlzLnBhbmVsRWxlbWVudC5kaXNhYmxlZCA9IHRydWU7XG4gICAgICB9XG4gICAgfTtcbiAgICB0aGlzLmltYWdlRm9ybUlucHV0ID0gKGltYWdlSW5wdXRUeXBlKSA9PiB7XG4gICAgICB2YXIgX2E7XG4gICAgICBjb25zdCBpbWFnZUlucHV0T2JqZWN0ID0gdGhpcy5nZXRJbWFnZUlucHV0T2JqZWN0KGltYWdlSW5wdXRUeXBlKTtcbiAgICAgIHJldHVybiAoaChcImNhbGNpdGUtbGFiZWxcIiwgeyBzY2FsZTogXCJzXCIgfSwgaW1hZ2VJbnB1dE9iamVjdC5pbnB1dExhYmVsLCBoKFwiZGl2XCIsIHsgaWQ6IGltYWdlSW5wdXRPYmplY3QucG9wb3ZlcklkLCBjbGFzczogQ1NTJDIuZm9ybUlucHV0QnV0dG9uIH0sIGgoXCJjYWxjaXRlLWlucHV0XCIsIHsgdHlwZTogXCJ0ZXh0XCIsIGF1dG9mb2N1czogdHJ1ZSwgcmVmOiBpbWFnZUlucHV0T2JqZWN0LnJlZmVyZW5jZUVsZW1lbnQsIHZhbHVlOiBpbWFnZUlucHV0T2JqZWN0LmlucHV0VmFsdWUsIHBsYWNlaG9sZGVyOiBpbWFnZUlucHV0T2JqZWN0LnBsYWNlSG9sZGVyLCBvbkNsaWNrOiAoKSA9PiB0aGlzLmNsb3NlUG9wdXBQb3BvdmVycy5lbWl0KHRoaXMuZ3VpZCkgfSksICgoX2EgPSB0aGlzLnBvcHVwVGVtcGxhdGUuZmllbGRJbmZvcykgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmxlbmd0aCkgPiAwICYmIChoKFwiY2FsY2l0ZS1hY3Rpb25cIiwgeyB0ZXh0OiB0aGlzLnN0cmluZ3MuYXR0cmlidXRlcywgXCJ0ZXh0LWRpc3BsYXlcIjogXCJoaWRkZW5cIiwgb25DbGljazogKCkgPT4gdGhpcy5vcGVuQXR0cmlidXRlc0xpc3QoaW1hZ2VJbnB1dE9iamVjdC5pbWFnZUlucHV0KSwgc2NhbGU6IFwic1wiLCBpY29uOiBcImJyYWNrZXRzLWN1cmx5XCIgfSkpKSkpO1xuICAgIH07XG4gICAgdGhpcy5nZXRJbWFnZUlucHV0T2JqZWN0ID0gKGltYWdlSW5wdXRUeXBlKSA9PiB7XG4gICAgICBjbGFzcyBJbWFnZUlucHV0Q2xhc3Mge1xuICAgICAgfVxuICAgICAgY29uc3QgaW1hZ2VJbnB1dE9iamVjdCA9IG5ldyBJbWFnZUlucHV0Q2xhc3MoKTtcbiAgICAgIGltYWdlSW5wdXRPYmplY3QuaW1hZ2VJbnB1dCA9IGltYWdlSW5wdXRUeXBlO1xuICAgICAgaW1hZ2VJbnB1dE9iamVjdC5wb3BvdmVySWQgPSBgcG9wb3ZlcklkXyR7aW1hZ2VJbnB1dE9iamVjdC5pbWFnZUlucHV0fWA7XG4gICAgICBpZiAoaW1hZ2VJbnB1dFR5cGUgPT09IGltYWdlQ29tcG9uZW50SW5wdXRUeXBlc0VudW0uc291cmNlVXJsKSB7XG4gICAgICAgIGltYWdlSW5wdXRPYmplY3QuaW5wdXRMYWJlbCA9IHRoaXMuc3RyaW5ncy51cmw7XG4gICAgICAgIGltYWdlSW5wdXRPYmplY3QucmVmZXJlbmNlRWxlbWVudCA9IChlbGVtZW50KSA9PiB7XG4gICAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKFwiY2FsY2l0ZUlucHV0Q2hhbmdlXCIsIHRoaXMuY2hhbmdlSW1hZ2VQcm9wZXJ0aWVzKTtcbiAgICAgICAgICB0aGlzLmVkaXRJbWFnZVVybCA9IGVsZW1lbnQ7XG4gICAgICAgIH07XG4gICAgICAgIGltYWdlSW5wdXRPYmplY3QuaW5wdXRWYWx1ZSA9IHRoaXMuaW1hZ2VNZWRpYUluZm8udmFsdWUuc291cmNlVVJMO1xuICAgICAgICBpbWFnZUlucHV0T2JqZWN0LnBsYWNlSG9sZGVyID0gdGhpcy5zdHJpbmdzLmltYWdlVXJsUGxhY2VIb2xkZXI7XG4gICAgICB9XG4gICAgICBlbHNlIGlmIChpbWFnZUlucHV0VHlwZSA9PT0gaW1hZ2VDb21wb25lbnRJbnB1dFR5cGVzRW51bS50aXRsZSkge1xuICAgICAgICBpbWFnZUlucHV0T2JqZWN0LmlucHV0TGFiZWwgPSB0aGlzLnN0cmluZ3MudGl0bGU7XG4gICAgICAgIGltYWdlSW5wdXRPYmplY3QucmVmZXJlbmNlRWxlbWVudCA9IChlbGVtZW50KSA9PiB7XG4gICAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKFwiY2FsY2l0ZUlucHV0Q2hhbmdlXCIsIHRoaXMuY2hhbmdlSW1hZ2VQcm9wZXJ0aWVzKTtcbiAgICAgICAgICB0aGlzLmVkaXRJbWFnZVRpdGxlID0gZWxlbWVudDtcbiAgICAgICAgfTtcbiAgICAgICAgaW1hZ2VJbnB1dE9iamVjdC5pbnB1dFZhbHVlID0gdGhpcy5pbWFnZU1lZGlhSW5mby50aXRsZTtcbiAgICAgICAgaW1hZ2VJbnB1dE9iamVjdC5wbGFjZUhvbGRlciA9IHRoaXMuc3RyaW5ncy5pbWFnZVRpdGxlUGxhY2VIb2xkZXI7XG4gICAgICB9XG4gICAgICBlbHNlIGlmIChpbWFnZUlucHV0VHlwZSA9PT0gaW1hZ2VDb21wb25lbnRJbnB1dFR5cGVzRW51bS5jYXB0aW9uKSB7XG4gICAgICAgIGltYWdlSW5wdXRPYmplY3QuaW5wdXRMYWJlbCA9IHRoaXMuc3RyaW5ncy5jYXB0aW9uO1xuICAgICAgICBpbWFnZUlucHV0T2JqZWN0LnJlZmVyZW5jZUVsZW1lbnQgPSAoZWxlbWVudCkgPT4ge1xuICAgICAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihcImNhbGNpdGVJbnB1dENoYW5nZVwiLCB0aGlzLmNoYW5nZUltYWdlUHJvcGVydGllcyk7XG4gICAgICAgICAgdGhpcy5lZGl0SW1hZ2VDYXB0aW9uID0gZWxlbWVudDtcbiAgICAgICAgfTtcbiAgICAgICAgaW1hZ2VJbnB1dE9iamVjdC5pbnB1dFZhbHVlID0gdGhpcy5pbWFnZU1lZGlhSW5mby5jYXB0aW9uO1xuICAgICAgICBpbWFnZUlucHV0T2JqZWN0LnBsYWNlSG9sZGVyID0gdGhpcy5zdHJpbmdzLmltYWdlQ2FwdGlvblBsYWNlSG9sZGVyO1xuICAgICAgfVxuICAgICAgZWxzZSBpZiAoaW1hZ2VJbnB1dFR5cGUgPT09IGltYWdlQ29tcG9uZW50SW5wdXRUeXBlc0VudW0uYWx0VGV4dCkge1xuICAgICAgICBpbWFnZUlucHV0T2JqZWN0LmlucHV0TGFiZWwgPSB0aGlzLnN0cmluZ3MuZGVzY3JpcHRpb247XG4gICAgICAgIGltYWdlSW5wdXRPYmplY3QucmVmZXJlbmNlRWxlbWVudCA9IChlbGVtZW50KSA9PiB7XG4gICAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKFwiY2FsY2l0ZUlucHV0Q2hhbmdlXCIsIHRoaXMuY2hhbmdlSW1hZ2VQcm9wZXJ0aWVzKTtcbiAgICAgICAgICB0aGlzLmVkaXRBbHRUZXh0ID0gZWxlbWVudDtcbiAgICAgICAgfTtcbiAgICAgICAgaW1hZ2VJbnB1dE9iamVjdC5pbnB1dFZhbHVlID0gdGhpcy5pbWFnZU1lZGlhSW5mby5hbHRUZXh0O1xuICAgICAgICBpbWFnZUlucHV0T2JqZWN0LnBsYWNlSG9sZGVyID0gdGhpcy5zdHJpbmdzLmRlc2NyaWJlSW1hZ2U7XG4gICAgICB9XG4gICAgICBlbHNlIGlmIChpbWFnZUlucHV0VHlwZSA9PT0gaW1hZ2VDb21wb25lbnRJbnB1dFR5cGVzRW51bS5saW5rVXJsKSB7XG4gICAgICAgIGltYWdlSW5wdXRPYmplY3QuaW5wdXRMYWJlbCA9IHRoaXMuc3RyaW5ncy5saW5rO1xuICAgICAgICBpbWFnZUlucHV0T2JqZWN0LnJlZmVyZW5jZUVsZW1lbnQgPSAoZWxlbWVudCkgPT4ge1xuICAgICAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihcImNhbGNpdGVJbnB1dENoYW5nZVwiLCB0aGlzLmNoYW5nZUltYWdlUHJvcGVydGllcyk7XG4gICAgICAgICAgdGhpcy5lZGl0SW1hZ2VMaW5rVXJsID0gZWxlbWVudDtcbiAgICAgICAgfTtcbiAgICAgICAgaW1hZ2VJbnB1dE9iamVjdC5pbnB1dFZhbHVlID0gdGhpcy5pbWFnZU1lZGlhSW5mby52YWx1ZS5saW5rVVJMO1xuICAgICAgICBpbWFnZUlucHV0T2JqZWN0LnBsYWNlSG9sZGVyID0gdGhpcy5zdHJpbmdzLmltYWdlTGlua1VybFBsYWNlSG9sZGVyO1xuICAgICAgfVxuICAgICAgcmV0dXJuIGltYWdlSW5wdXRPYmplY3Q7XG4gICAgfTtcbiAgICB0aGlzLmd1aWQgPSB1bmRlZmluZWQ7XG4gICAgdGhpcy5pbWFnZU1lZGlhSW5mbyA9IHVuZGVmaW5lZDtcbiAgICB0aGlzLnJlZkVsZW1lbnQgPSB1bmRlZmluZWQ7XG4gICAgdGhpcy5tZWRpYUluZGV4UG9zaXRpb24gPSB1bmRlZmluZWQ7XG4gICAgdGhpcy5pc09wZW4gPSBmYWxzZTtcbiAgICB0aGlzLnJlUmVuZGVyID0gdW5kZWZpbmVkO1xuICB9XG4gIC8vIGxpZmVjeWNsZSBtZXRob2RzXG4gIGNvbXBvbmVudFdpbGxMb2FkKCkge1xuICAgIHRoaXMuc3RyaW5ncyA9IHBvcHVwU3RhdGUuc3RyaW5ncztcbiAgICB0aGlzLnBvcHVwVGVtcGxhdGUgPSBwb3B1cFN0YXRlLnBvcHVwVGVtcGxhdGU7XG4gICAgdGhpcy5pbWFnZU1lZGlhSW5mby50aXRsZSA9IHRoaXMuaW1hZ2VNZWRpYUluZm8udGl0bGUgfHwgXCJcIjtcbiAgICB0aGlzLmltYWdlTWVkaWFJbmZvLmFsdFRleHQgPSB0aGlzLmltYWdlTWVkaWFJbmZvLmFsdFRleHQgfHwgXCJcIjtcbiAgICB0aGlzLmltYWdlTWVkaWFJbmZvLmNhcHRpb24gPSB0aGlzLmltYWdlTWVkaWFJbmZvLmNhcHRpb24gfHwgXCJcIjtcbiAgICB0aGlzLmltYWdlTWVkaWFJbmZvLnZhbHVlLnNvdXJjZVVSTCA9IHRoaXMuaW1hZ2VNZWRpYUluZm8udmFsdWUuc291cmNlVVJMIHx8IFwiXCI7XG4gICAgdGhpcy5pbWFnZU1lZGlhSW5mby52YWx1ZS5saW5rVVJMID0gdGhpcy5pbWFnZU1lZGlhSW5mby52YWx1ZS5saW5rVVJMIHx8IFwiXCI7XG4gIH1cbiAgY29tcG9uZW50RGlkTG9hZCgpIHtcbiAgICB0aGlzLmVkaXRJbWFnZVVybC52YWx1ZSA9IHRoaXMuaW1hZ2VNZWRpYUluZm8udmFsdWUuc291cmNlVVJMO1xuICAgIHRoaXMuZWRpdEltYWdlVGl0bGUudmFsdWUgPSB0aGlzLmltYWdlTWVkaWFJbmZvLnRpdGxlO1xuICAgIHRoaXMuZWRpdFJlZnJlc2hJbWFnZS52YWx1ZSA9IHRoaXMuaW1hZ2VNZWRpYUluZm8ucmVmcmVzaEludGVydmFsIHx8IDA7XG4gICAgdGhpcy5lZGl0SW1hZ2VDYXB0aW9uLnZhbHVlID0gdGhpcy5pbWFnZU1lZGlhSW5mby5jYXB0aW9uO1xuICAgIHRoaXMuZWRpdEltYWdlTGlua1VybC52YWx1ZSA9IHRoaXMuaW1hZ2VNZWRpYUluZm8udmFsdWUubGlua1VSTDtcbiAgICB0aGlzLmVkaXRBbHRUZXh0LnZhbHVlID0gdGhpcy5pbWFnZU1lZGlhSW5mby5hbHRUZXh0O1xuICAgIHRoaXMuaXNPcGVuID0gdHJ1ZTtcbiAgICAvLyBuZWVkIHRpbWVvdXQgYmVjYXVzZSBvZiByZS1yZW5kZXJcbiAgICBzZXRUaW1lb3V0KCgpID0+IHJlcXVlc3RBbmltYXRpb25GcmFtZSgoKSA9PiB0aGlzLnBhbmVsRWxlbWVudC5zZXRGb2N1cygpKSwgMzAwKTtcbiAgfVxuICBjb21wb25lbnREaWRVcGRhdGUoKSB7XG4gICAgdGhpcy5ub3RpZnlNdWx0aU1lZGlhQ2hhbmdlLmVtaXQoe1xuICAgICAgZ3VpZDogdGhpcy5ndWlkLFxuICAgICAgbWVkaWFJbmRleFBvc2l0aW9uOiB0aGlzLm1lZGlhSW5kZXhQb3NpdGlvblxuICAgIH0pO1xuICB9XG4gIGRpc2Nvbm5lY3RlZENhbGxiYWNrKCkge1xuICAgIGlmICh0aGlzLnBvcHVwRmllbGRTZWxlY3Rpb25QaWNrTGlzdCkge1xuICAgICAgZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZCh0aGlzLnBvcHVwRmllbGRTZWxlY3Rpb25QaWNrTGlzdCk7XG4gICAgfVxuICB9XG4gIC8vIFB1YmxpYyBNZXRob2RzXG4gIGFzeW5jIHJlcG9zaXRpb24oKSB7XG4gICAgdmFyIF9hO1xuICAgIChfYSA9IHRoaXMucG9wb3Zlck5vZGUpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5yZXBvc2l0aW9uKCk7XG4gIH1cbiAgLy8gRXZlbnRzXG4gIGltYWdlQ2hhbmdlZFJlUmVuZGVySGFuZGxlcihldmVudCkge1xuICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgIHRoaXMucmVSZW5kZXIgPSB0aGlzLnJlUmVuZGVyID8gZmFsc2UgOiB0cnVlO1xuICB9XG4gIGNhbGNpdGVCbG9ja1RvZ2dsZUhhbmRsZXIoKSB7XG4gICAgdGhpcy5jbG9zZVBvcHVwUG9wb3ZlcnMuZW1pdCgpO1xuICB9XG4gIGNsb3NlUG9wdXBQb3BvdmVyc0hhbmRsZXIoKSB7XG4gICAgdGhpcy5yZW1vdmVBdHRyaWJ1dGVzU2VsZWN0aW9uUG9wb3ZlcigpO1xuICB9XG4gIGNsb3NlTXVsdGlNZWRpYVBvcG92ZXJIYW5kbGVyKCkge1xuICAgIHRoaXMucmVtb3ZlQXR0cmlidXRlc1NlbGVjdGlvblBvcG92ZXIoKTtcbiAgfVxuICBjYWxjaXRlQmxvY2tTZWN0aW9uVG9nZ2xlSGFuZGxlcihldmVudCkge1xuICAgIGNvbnN0IGNvbXBvc2VkUGF0aCA9IGV2ZW50LmNvbXBvc2VkUGF0aCgpO1xuICAgIGlmICgoY29tcG9zZWRQYXRoID09PSBudWxsIHx8IGNvbXBvc2VkUGF0aCA9PT0gdm9pZCAwID8gdm9pZCAwIDogY29tcG9zZWRQYXRoWzBdLmlkKSA9PT0gXCJyZWZyZXNoSW1hZ2VCbG9ja1NlY3Rpb25faWRcIikge1xuICAgICAgdGhpcy5lZGl0UmVmcmVzaEltYWdlLnZhbHVlID0gMDtcbiAgICAgIHRoaXMuY2hhbmdlSW1hZ2VQcm9wZXJ0aWVzKGV2ZW50KTtcbiAgICAgIHRoaXMuaG9zdEVsZW1lbnQuc2hhZG93Um9vdC5nZXRFbGVtZW50QnlJZChcIm1hbmFnZVBvcG92ZXJfSWRcIilbXCJyZXBvc2l0aW9uXCJdKCk7XG4gICAgfVxuICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICB9XG4gIC8vIHByaXZhdGUgbWV0aG9kcyBhbmQgcHJvcGVydGllc1xuICByZW1vdmVBdHRyaWJ1dGVzU2VsZWN0aW9uUG9wb3ZlcigpIHtcbiAgICBpZiAodGhpcy5wb3B1cEZpZWxkU2VsZWN0aW9uUGlja0xpc3QpIHtcbiAgICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQodGhpcy5wb3B1cEZpZWxkU2VsZWN0aW9uUGlja0xpc3QpO1xuICAgICAgdGhpcy5wb3B1cEZpZWxkU2VsZWN0aW9uUGlja0xpc3QgPSBudWxsO1xuICAgIH1cbiAgICB0aGlzLnBhbmVsRWxlbWVudC5kaXNhYmxlZCA9IGZhbHNlO1xuICB9XG4gIC8vIGZpZWxkIHNlbGVjdGlvbiBmb3IgdGl0bGUgYW5kIGNhcHRpb25cbiAgcG9wdXBGaWVsZFNlbGVjdGlvblBpY2tMaXN0Q2hhbmdlcyhldmVudCwgY3VyckltYWdlQ29tcG9uZW50SW5wdXRUeXBlcykge1xuICAgIGNvbnN0IHNlbGVjdGVkRmllbGROYW1lID0gZXZlbnQuZGV0YWlsLnNlbGVjdGVkRmllbGRzWzBdO1xuICAgIGlmIChjdXJySW1hZ2VDb21wb25lbnRJbnB1dFR5cGVzID09PSBpbWFnZUNvbXBvbmVudElucHV0VHlwZXNFbnVtLnNvdXJjZVVybCkge1xuICAgICAgdGhpcy5lZGl0SW1hZ2VVcmwudmFsdWUgPSBhZGRTZWxlY3RlZEZpZWxkQXRDdXJzb3IodGhpcy5lZGl0SW1hZ2VVcmwsIHNlbGVjdGVkRmllbGROYW1lKTtcbiAgICAgIHRoaXMuZWRpdEltYWdlVXJsLnNldEZvY3VzKCk7XG4gICAgfVxuICAgIGVsc2UgaWYgKGN1cnJJbWFnZUNvbXBvbmVudElucHV0VHlwZXMgPT09IGltYWdlQ29tcG9uZW50SW5wdXRUeXBlc0VudW0udGl0bGUpIHtcbiAgICAgIHRoaXMuZWRpdEltYWdlVGl0bGUudmFsdWUgPSBhZGRTZWxlY3RlZEZpZWxkQXRDdXJzb3IodGhpcy5lZGl0SW1hZ2VUaXRsZSwgc2VsZWN0ZWRGaWVsZE5hbWUpO1xuICAgICAgdGhpcy5lZGl0SW1hZ2VUaXRsZS5zZXRGb2N1cygpO1xuICAgIH1cbiAgICBlbHNlIGlmIChjdXJySW1hZ2VDb21wb25lbnRJbnB1dFR5cGVzID09PSBpbWFnZUNvbXBvbmVudElucHV0VHlwZXNFbnVtLmNhcHRpb24pIHtcbiAgICAgIHRoaXMuZWRpdEltYWdlQ2FwdGlvbi52YWx1ZSA9IGFkZFNlbGVjdGVkRmllbGRBdEN1cnNvcih0aGlzLmVkaXRJbWFnZUNhcHRpb24sIHNlbGVjdGVkRmllbGROYW1lKTtcbiAgICAgIHRoaXMuZWRpdEltYWdlQ2FwdGlvbi5zZXRGb2N1cygpO1xuICAgIH1cbiAgICBlbHNlIGlmIChjdXJySW1hZ2VDb21wb25lbnRJbnB1dFR5cGVzID09PSBpbWFnZUNvbXBvbmVudElucHV0VHlwZXNFbnVtLmxpbmtVcmwpIHtcbiAgICAgIHRoaXMuZWRpdEltYWdlTGlua1VybC52YWx1ZSA9IGFkZFNlbGVjdGVkRmllbGRBdEN1cnNvcih0aGlzLmVkaXRJbWFnZUxpbmtVcmwsIHNlbGVjdGVkRmllbGROYW1lKTtcbiAgICAgIHRoaXMuZWRpdEltYWdlTGlua1VybC5zZXRGb2N1cygpO1xuICAgIH1cbiAgICBlbHNlIGlmIChjdXJySW1hZ2VDb21wb25lbnRJbnB1dFR5cGVzID09PSBpbWFnZUNvbXBvbmVudElucHV0VHlwZXNFbnVtLmFsdFRleHQpIHtcbiAgICAgIHRoaXMuZWRpdEFsdFRleHQudmFsdWUgPSBhZGRTZWxlY3RlZEZpZWxkQXRDdXJzb3IodGhpcy5lZGl0QWx0VGV4dCwgc2VsZWN0ZWRGaWVsZE5hbWUpO1xuICAgICAgdGhpcy5lZGl0QWx0VGV4dC5zZXRGb2N1cygpO1xuICAgIH1cbiAgICB0aGlzLmNsb3NlUG9wdXBQb3BvdmVycy5lbWl0KHRoaXMuZ3VpZCk7XG4gICAgdGhpcy5jaGFuZ2VJbWFnZVByb3BlcnRpZXMoKTtcbiAgfVxuICByZW5kZXIoKSB7XG4gICAgY29uc3QgcmVmcmVzaEltYWdlSW5wdXQgPSAoaChcImNhbGNpdGUtYmxvY2stc2VjdGlvblwiLCB7IGlkOiBcInJlZnJlc2hJbWFnZUJsb2NrU2VjdGlvbl9pZFwiLCB0ZXh0OiB0aGlzLnN0cmluZ3MucmVmcmVzaEludGVydmFsLCB0b2dnbGVEaXNwbGF5OiBcInN3aXRjaFwiLCBvcGVuOiB0aGlzLmltYWdlTWVkaWFJbmZvLnJlZnJlc2hJbnRlcnZhbCA/IHRydWUgOiBmYWxzZSB9LCBoKFwiZGl2XCIsIHsgY2xhc3M6IFwicmVmcmVzaC1sYWJlbFwiIH0sIGgoXCJjYWxjaXRlLWxhYmVsXCIsIHsgc2NhbGU6IFwic1wiLCBsYXlvdXQ6IFwiaW5saW5lXCIgfSwgaChcImNhbGNpdGUtaW5wdXRcIiwgeyBjbGFzczogQ1NTJDIucmVmcmVzaEltYWdlSW5wdXQsIHR5cGU6IFwibnVtYmVyXCIsIG1pbjogMCwgbWF4OiAxNDQwLCByZWY6IChlbGVtZW50KSA9PiB7XG4gICAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihcImNhbGNpdGVJbnB1dENoYW5nZVwiLCB0aGlzLmNoYW5nZUltYWdlUHJvcGVydGllcyk7XG4gICAgICAgIHRoaXMuZWRpdFJlZnJlc2hJbWFnZSA9IGVsZW1lbnQ7XG4gICAgICB9LCB2YWx1ZTogdGhpcy5pbWFnZU1lZGlhSW5mby5yZWZyZXNoSW50ZXJ2YWxcbiAgICAgICAgPyB0aGlzLmltYWdlTWVkaWFJbmZvLnJlZnJlc2hJbnRlcnZhbC50b1N0cmluZygpXG4gICAgICAgIDogXCIwXCIsIG9uQ2xpY2s6ICgpID0+IHRoaXMuY2xvc2VQb3B1cFBvcG92ZXJzLmVtaXQodGhpcy5ndWlkKSwgb25DYWxjaXRlSW5wdXRJbnB1dDogKCkgPT4ge1xuICAgICAgICBpZiAodGhpcy5lZGl0UmVmcmVzaEltYWdlLnZhbHVlKSB7XG4gICAgICAgICAgY29uc3QgdmFsdWUgPSBwYXJzZUludCh0aGlzLmVkaXRSZWZyZXNoSW1hZ2UudmFsdWUpO1xuICAgICAgICAgIGlmICh2YWx1ZSA8IDApIHtcbiAgICAgICAgICAgIHRoaXMuZWRpdFJlZnJlc2hJbWFnZS52YWx1ZSA9IDA7XG4gICAgICAgICAgfVxuICAgICAgICAgIGVsc2UgaWYgKHZhbHVlID4gMTQ0MCkge1xuICAgICAgICAgICAgdGhpcy5lZGl0UmVmcmVzaEltYWdlLnZhbHVlID0gMTQ0MDtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0gfSksIHRoaXMuc3RyaW5ncy5taW51dGVzKSkpKTtcbiAgICBjb25zdCBpbWFnZURpdiA9IChoKFwiZGl2XCIsIHsgY2xhc3M6IFwiaWdub3JlLWVsZW1lbnRzLXNvcnRhYmxlXCIgfSwgdGhpcy5pbWFnZUZvcm1JbnB1dChpbWFnZUNvbXBvbmVudElucHV0VHlwZXNFbnVtLnNvdXJjZVVybCksIGgoXCJjYWxjaXRlLWJsb2NrLXNlY3Rpb25cIiwgeyBvcGVuOiB0cnVlLCB0ZXh0OiB0aGlzLnN0cmluZ3Mub3B0aW9ucyB9LCB0aGlzLmltYWdlRm9ybUlucHV0KGltYWdlQ29tcG9uZW50SW5wdXRUeXBlc0VudW0udGl0bGUpLCB0aGlzLmltYWdlRm9ybUlucHV0KGltYWdlQ29tcG9uZW50SW5wdXRUeXBlc0VudW0uY2FwdGlvbiksIHRoaXMuaW1hZ2VGb3JtSW5wdXQoaW1hZ2VDb21wb25lbnRJbnB1dFR5cGVzRW51bS5hbHRUZXh0KSwgdGhpcy5pbWFnZUZvcm1JbnB1dChpbWFnZUNvbXBvbmVudElucHV0VHlwZXNFbnVtLmxpbmtVcmwpLCByZWZyZXNoSW1hZ2VJbnB1dCkpKTtcbiAgICBjb25zdCBkb25lQnRuID0gKGgoXCJjYWxjaXRlLWJ1dHRvblwiLCB7IGFwcGVhcmFuY2U6IFwib3V0bGluZS1maWxsXCIsIHNjYWxlOiBcIm1cIiwgc2xvdDogXCJmb290ZXJcIiwgd2lkdGg6IFwiZnVsbFwiLCBvbkNsaWNrOiAoKSA9PiB0aGlzLmNsb3NlUG9wdXBQb3BvdmVycy5lbWl0KCkgfSwgdGhpcy5zdHJpbmdzLmRvbmUpKTtcbiAgICByZXR1cm4gKGgoSG9zdCwgeyBjbGFzczogXCJqcy1hcHAtZmx5b3V0XCIgfSwgaChcImNhbGNpdGUtcG9wb3ZlclwiLCB7IGRpcjogZ2V0RWxlbWVudERpcih0aGlzLmhvc3RFbGVtZW50KSwgaWQ6IFwibWFuYWdlUG9wb3Zlcl9JZFwiLCBwbGFjZW1lbnQ6IFwibGVhZGluZy1zdGFydFwiLCBvcGVuOiB0aGlzLmlzT3BlbiwgcG9pbnRlckRpc2FibGVkOiB0cnVlLCByZWZlcmVuY2VFbGVtZW50OiB0aGlzLnJlZkVsZW1lbnQsIG9mZnNldERpc3RhbmNlOiAtTWF0aC5yb3VuZCh0aGlzLnJlZkVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkud2lkdGgpLCBvZmZzZXRTa2lkZGluZzogNTAsIGxhYmVsOiBcIlwiLCBzdHlsZToge1xuICAgICAgICB6SW5kZXg6IFwiMTAwXCJcbiAgICAgIH0sIHRyaWdnZXJEaXNhYmxlZDogdHJ1ZSwgcmVmOiAobm9kZSkgPT4gKHRoaXMucG9wb3Zlck5vZGUgPSBub2RlKSB9LCBoKFwiY2FsY2l0ZS1wYW5lbFwiLCB7IHJlZjogKGVsZW1lbnQpID0+ICh0aGlzLnBhbmVsRWxlbWVudCA9IGVsZW1lbnQpLCBjbG9zYWJsZTogdHJ1ZSwgc3R5bGU6IHtcbiAgICAgICAgd2lkdGg6IGAke3RoaXMucmVmRWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKS53aWR0aH1weGBcbiAgICAgIH0sIG9uQ2FsY2l0ZVBhbmVsQ2xvc2U6ICgpID0+IHRoaXMuY2xvc2VQb3B1cFBvcG92ZXJzLmVtaXQoKSB9LCBoKFwiZGl2XCIsIHsgc2xvdDogXCJoZWFkZXItY29udGVudFwiIH0sIHRoaXMuc3RyaW5ncy5jb25maWd1cmVJbWFnZSksIGRvbmVCdG4sIGgoXCJkaXZcIiwgeyBjbGFzczogQ1NTJDIucG9wb3ZlckltYWdlRGl2IH0sIGltYWdlRGl2KSkpKSk7XG4gIH1cbiAgZ2V0IGhvc3RFbGVtZW50KCkgeyByZXR1cm4gZ2V0RWxlbWVudCh0aGlzKTsgfVxufTtcbkFyY2dpc1BvcHVwSW1hZ2Uuc3R5bGUgPSBhcmNnaXNQb3B1cEltYWdlQ3NzO1xuXG5jb25zdCBBcmNnaXNQb3B1cE1haW5Db250ZW50cG9wb3ZlciA9IGNsYXNzIHtcbiAgY29uc3RydWN0b3IoaG9zdFJlZikge1xuICAgIHJlZ2lzdGVySW5zdGFuY2UodGhpcywgaG9zdFJlZik7XG4gICAgdGhpcy5jbG9zZVBvcHVwUG9wb3ZlcnMgPSBjcmVhdGVFdmVudCh0aGlzLCBcImNsb3NlUG9wdXBQb3BvdmVyc1wiLCA3KTtcbiAgICB0aGlzLm5vdGlmeUFkZENvbnRlbnRTZWxlY3Rpb24gPSBjcmVhdGVFdmVudCh0aGlzLCBcIm5vdGlmeUFkZENvbnRlbnRTZWxlY3Rpb25cIiwgNyk7XG4gICAgdGhpcy5ub3RpZnlBZGRNdWx0aU1lZGlhQ29udGVudFNlbGVjdGlvbiA9IGNyZWF0ZUV2ZW50KHRoaXMsIFwibm90aWZ5QWRkTXVsdGlNZWRpYUNvbnRlbnRTZWxlY3Rpb25cIiwgNyk7XG4gICAgdGhpcy5jb250ZW50UG9wb3ZlclJlZkVsZW1lbnQgPSB1bmRlZmluZWQ7XG4gICAgdGhpcy5wb3B1cEhhc0F0dGFjaG1lbnQgPSB1bmRlZmluZWQ7XG4gICAgdGhpcy5wb3BvdmVyUGFuZWxXaWR0aCA9IHVuZGVmaW5lZDtcbiAgICB0aGlzLmlzTXVsdGltZWRpYUNvbnRlbnQgPSBmYWxzZTtcbiAgICB0aGlzLmd1aWQgPSB1bmRlZmluZWQ7XG4gICAgdGhpcy5pc09wZW4gPSBmYWxzZTtcbiAgfVxuICBhc3luYyByZXBvc2l0aW9uKCkge1xuICAgIHZhciBfYTtcbiAgICAoX2EgPSB0aGlzLnBvcG92ZXJFbGVtZW50KSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EucmVwb3NpdGlvbigpO1xuICB9XG4gIGNvbXBvbmVudFdpbGxMb2FkKCkge1xuICAgIHRoaXMuc3RyaW5ncyA9IHBvcHVwU3RhdGUuc3RyaW5ncztcbiAgICB0aGlzLmxheWVySGFzQXR0YWNobWVudCA9IHBvcHVwU3RhdGUubGF5ZXJIYXNBdHRhY2htZW50O1xuICAgIHRoaXMubGF5ZXJIYXNFVCA9IHBvcHVwU3RhdGUubGF5ZXJIYXNFVDtcbiAgICB0aGlzLmxheWVySGFzQXR0cmlidXRlcyA9IHBvcHVwU3RhdGUubGF5ZXJIYXNBdHRyaWJ1dGVzO1xuICAgIHRoaXMubGF5ZXJIYXNDaGFydHMgPSBwb3B1cFN0YXRlLmxheWVySGFzQ2hhcnRzO1xuICAgIHRoaXMubGF5ZXJIYXNJbWFnZXMgPSBwb3B1cFN0YXRlLmxheWVySGFzSW1hZ2VzO1xuICAgIHRoaXMubGF5ZXJIYXNUZXh0ID0gcG9wdXBTdGF0ZS5sYXllckhhc1RleHQ7XG4gICAgdGhpcy5wb3B1cFRlbXBsYXRlID0gcG9wdXBTdGF0ZS5wb3B1cFRlbXBsYXRlO1xuICAgIHRoaXMuc3VwcG9ydHNBcmNhZGUgPSBwb3B1cFN0YXRlLnN1cHBvcnRzQXJjYWRlO1xuICB9XG4gIGNvbXBvbmVudERpZExvYWQoKSB7XG4gICAgdGhpcy5ob3N0RWxlbWVudC5zaGFkb3dSb290LmdldEVsZW1lbnRCeUlkKFwibWFuYWdlUG9wb3Zlcl9JZFwiKVtcInJlcG9zaXRpb25cIl0oKTtcbiAgICB0aGlzLmlzT3BlbiA9IHRydWU7XG4gICAgLy8gbmVlZCB0aW1lb3V0IGJlY2F1c2Ugb2YgcmUtcmVuZGVyXG4gICAgc2V0VGltZW91dCgoKSA9PiByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKCkgPT4gdGhpcy5wYW5lbEVsZW1lbnQuc2V0Rm9jdXMoKSksIDMwMCk7XG4gIH1cbiAgY29udGVudFNlbGVjdGlvbihjb250ZW50KSB7XG4gICAgaWYgKHRoaXMuaXNNdWx0aW1lZGlhQ29udGVudCkge1xuICAgICAgdGhpcy5ub3RpZnlBZGRNdWx0aU1lZGlhQ29udGVudFNlbGVjdGlvbi5lbWl0KHsgZ3VpZDogdGhpcy5ndWlkLCBjb250ZW50OiBjb250ZW50IH0pO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgIHRoaXMubm90aWZ5QWRkQ29udGVudFNlbGVjdGlvbi5lbWl0KGNvbnRlbnQpO1xuICAgIH1cbiAgfVxuICAvLyByZW5kb3IgbWV0aG9kc1xuICByZW5kZXIoKSB7XG4gICAgY29uc3QgYXR0cmlidXRlcyA9IChoKFwiY2FsY2l0ZS1hY3Rpb25cIiwgeyBsYWJlbDogdGhpcy5zdHJpbmdzLmZpZWxkc0xpc3QsIHRleHQ6IHRoaXMuc3RyaW5ncy5maWVsZHNMaXN0LCB0ZXh0RW5hYmxlZDogdHJ1ZSwgb25DbGljazogKCkgPT4ge1xuICAgICAgICB0aGlzLmNvbnRlbnRTZWxlY3Rpb24oQ29udGVudFNlbGVjdGlvbi5hdHRyaWJ1dGVzKTtcbiAgICAgIH0gfSwgaChcImNhbGNpdGUtaWNvblwiLCB7IHNjYWxlOiBcInNcIiwgaWNvbjogXCJmZWF0dXJlLWRldGFpbHNcIiB9KSkpO1xuICAgIGNvbnN0IGF0dGFjaG1lbnRzID0gKGgoXCJjYWxjaXRlLWFjdGlvblwiLCB7IGxhYmVsOiB0aGlzLnN0cmluZ3MuYXR0YWNobWVudHMsIHRleHQ6IHRoaXMuc3RyaW5ncy5hdHRhY2htZW50cywgdGV4dEVuYWJsZWQ6IHRydWUsIG9uQ2xpY2s6ICgpID0+IHtcbiAgICAgICAgdGhpcy5jb250ZW50U2VsZWN0aW9uKENvbnRlbnRTZWxlY3Rpb24uYXR0YWNobWVudHMpO1xuICAgICAgfSwgZGlzYWJsZWQ6IHRoaXMucG9wdXBIYXNBdHRhY2htZW50ID8gdHJ1ZSA6IGZhbHNlIH0sIGgoXCJjYWxjaXRlLWljb25cIiwgeyBzY2FsZTogXCJzXCIsIGljb246IFwiYXR0YWNobWVudFwiIH0pKSk7XG4gICAgY29uc3QgY2hhcnRzID0gKGgoXCJjYWxjaXRlLWFjdGlvblwiLCB7IGxhYmVsOiB0aGlzLnN0cmluZ3MuY2hhcnQsIHRleHQ6IHRoaXMuc3RyaW5ncy5jaGFydCwgdGV4dEVuYWJsZWQ6IHRydWUsIG9uQ2xpY2s6ICgpID0+IHtcbiAgICAgICAgdGhpcy5jb250ZW50U2VsZWN0aW9uKENvbnRlbnRTZWxlY3Rpb24uY2hhcnRzKTtcbiAgICAgIH0gfSwgaChcImNhbGNpdGUtaWNvblwiLCB7IHNjYWxlOiBcInNcIiwgaWNvbjogXCJncmFwaC1iYXJcIiB9KSkpO1xuICAgIGNvbnN0IGltYWdlcyA9IChoKFwiY2FsY2l0ZS1hY3Rpb25cIiwgeyBsYWJlbDogdGhpcy5zdHJpbmdzLmltYWdlLCB0ZXh0OiB0aGlzLnN0cmluZ3MuaW1hZ2UsIHRleHRFbmFibGVkOiB0cnVlLCBvbkNsaWNrOiAoKSA9PiB7XG4gICAgICAgIHRoaXMuY29udGVudFNlbGVjdGlvbihDb250ZW50U2VsZWN0aW9uLmltYWdlcyk7XG4gICAgICB9IH0sIGgoXCJjYWxjaXRlLWljb25cIiwgeyBzY2FsZTogXCJzXCIsIGljb246IFwiaW1hZ2VcIiB9KSkpO1xuICAgIGNvbnN0IHJpY2hUZXh0ID0gKGgoXCJjYWxjaXRlLWFjdGlvblwiLCB7IGxhYmVsOiB0aGlzLnN0cmluZ3MudGV4dCwgdGV4dDogdGhpcy5zdHJpbmdzLnRleHQsIHRleHRFbmFibGVkOiB0cnVlLCBvbkNsaWNrOiAoKSA9PiB7XG4gICAgICAgIHRoaXMuY29udGVudFNlbGVjdGlvbihDb250ZW50U2VsZWN0aW9uLnJpY2hUZXh0KTtcbiAgICAgIH0gfSwgaChcImNhbGNpdGUtaWNvblwiLCB7IHNjYWxlOiBcInNcIiwgaWNvbjogXCJ0ZXh0XCIgfSkpKTtcbiAgICBjb25zdCBhcmNhZGUgPSAoaChcImNhbGNpdGUtYWN0aW9uXCIsIHsgbGFiZWw6IHRoaXMuc3RyaW5ncy5hcmNhZGUsIHRleHQ6IHRoaXMuc3RyaW5ncy5hcmNhZGUsIGljb246IFwiY29kZVwiLCB0ZXh0RW5hYmxlZDogdHJ1ZSwgb25DbGljazogKCkgPT4ge1xuICAgICAgICB0aGlzLmNvbnRlbnRTZWxlY3Rpb24oQ29udGVudFNlbGVjdGlvbi5hcmNhZGUpO1xuICAgICAgfSB9KSk7XG4gICAgY29uc3QgZXQgPSAoaChcImNhbGNpdGUtYWN0aW9uXCIsIHsgbGFiZWw6IHRoaXMuc3RyaW5ncy5zdW1tYXJ5RVRIZWFkaW5nLCB0ZXh0OiB0aGlzLnN0cmluZ3Muc3VtbWFyeUVUSGVhZGluZywgdGV4dEVuYWJsZWQ6IHRydWUsIG9uQ2xpY2s6ICgpID0+IHtcbiAgICAgICAgdGhpcy5jb250ZW50U2VsZWN0aW9uKENvbnRlbnRTZWxlY3Rpb24uc3VtbWFyeUVUKTtcbiAgICAgIH0sIGRpc2FibGVkOiB0aGlzLnBvcHVwVGVtcGxhdGUubGFzdEVkaXRJbmZvRW5hYmxlZCA/IHRydWUgOiBmYWxzZSB9LCBoKFwiY2FsY2l0ZS1pY29uXCIsIHsgc2NhbGU6IFwic1wiLCBpY29uOiBcInVzZXJcIiB9KSkpO1xuICAgIGNvbnN0IHJlbGF0ZWRSZWNvcmRzID0gKGgoXCJjYWxjaXRlLWFjdGlvblwiLCB7IGxhYmVsOiB0aGlzLnN0cmluZ3MucmVsYXRlZFJlY29yZHMsIHRleHQ6IHRoaXMuc3RyaW5ncy5yZWxhdGVkUmVjb3JkcywgdGV4dEVuYWJsZWQ6IHRydWUsIG9uQ2xpY2s6ICgpID0+IHtcbiAgICAgICAgdGhpcy5jb250ZW50U2VsZWN0aW9uKENvbnRlbnRTZWxlY3Rpb24ucmVsYXRpb25zaGlwKTtcbiAgICAgIH0gfSwgaChcImNhbGNpdGUtaWNvblwiLCB7IHNjYWxlOiBcInNcIiwgaWNvbjogXCJsaW5rXCIgfSkpKTtcbiAgICBjb25zdCBwYW5lbCA9IHF1ZXJ5UGFyZW50RWxlbWVudCh0aGlzLmNvbnRlbnRQb3BvdmVyUmVmRWxlbWVudCwgXCJjYWxjaXRlLWZsb3ctaXRlbVwiKTtcbiAgICBjb25zdCBwYW5lbFRvcCA9IChwYW5lbCA9PT0gbnVsbCB8fCBwYW5lbCA9PT0gdm9pZCAwID8gdm9pZCAwIDogcGFuZWwuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkudG9wKSB8fCA1NjtcbiAgICBjb25zdCBidXR0b25Ub3AgPSB0aGlzLmNvbnRlbnRQb3BvdmVyUmVmRWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKS50b3A7XG4gICAgLy8gNTQ6IHBhbmVsIGhlYWRlcjsgMTA6IHBhbmVsIGFycm93XG4gICAgY29uc3QgcG9wb3Zlck1heEhlaWdodCA9IGJ1dHRvblRvcCAtIHBhbmVsVG9wIC0gNTQgLSAxMDtcbiAgICBjb25zdCBjb250ZW50U3R5bGUgPSB7IG1heEhlaWdodDogcG9wb3Zlck1heEhlaWdodCA+IDAgPyBgJHtwb3BvdmVyTWF4SGVpZ2h0fXB4YCA6IFwiNjB2aFwiIH07XG4gICAgcmV0dXJuIChoKEhvc3QsIHsgY2xhc3M6IFwianMtYXBwLWZseW91dFwiIH0sIGgoXCJjYWxjaXRlLXBvcG92ZXJcIiwgeyByZWY6IChlbCkgPT4gKHRoaXMucG9wb3ZlckVsZW1lbnQgPSBlbCksIGRpcjogZ2V0RWxlbWVudERpcih0aGlzLmhvc3RFbGVtZW50KSwgaWQ6IFwibWFuYWdlUG9wb3Zlcl9JZFwiLCBwbGFjZW1lbnQ6IFwiYm90dG9tXCIsIG9wZW46IHRoaXMuaXNPcGVuLCByZWZlcmVuY2VFbGVtZW50OiB0aGlzLmNvbnRlbnRQb3BvdmVyUmVmRWxlbWVudCwgbGFiZWw6IHRoaXMuaXNNdWx0aW1lZGlhQ29udGVudCA/IHRoaXMuc3RyaW5ncy5hZGRNZWRpYSA6IHRoaXMuc3RyaW5ncy5hZGRDb250ZW50LCBzdHlsZToge1xuICAgICAgICB6SW5kZXg6IFwiMTAwXCJcbiAgICAgIH0sIHRyaWdnZXJEaXNhYmxlZDogdHJ1ZSB9LCBoKFwiY2FsY2l0ZS1wYW5lbFwiLCB7IHJlZjogKGVsKSA9PiAodGhpcy5wYW5lbEVsZW1lbnQgPSBlbCksIGNsb3NhYmxlOiB0cnVlLCBzdHlsZToge1xuICAgICAgICB3aWR0aDogYCR7dGhpcy5wb3BvdmVyUGFuZWxXaWR0aH1weGBcbiAgICAgIH0sIG9uQ2FsY2l0ZVBhbmVsQ2xvc2U6ICgpID0+IHRoaXMuY2xvc2VQb3B1cFBvcG92ZXJzLmVtaXQoKSB9LCBoKFwiZGl2XCIsIHsgc2xvdDogXCJoZWFkZXItY29udGVudFwiIH0sIHRoaXMuaXNNdWx0aW1lZGlhQ29udGVudCA/IHRoaXMuc3RyaW5ncy5hZGRNZWRpYSA6IHRoaXMuc3RyaW5ncy5jb250ZW50KSwgdGhpcy5pc011bHRpbWVkaWFDb250ZW50ID8gKGgoXCJkaXZcIiwgeyBzdHlsZTogY29udGVudFN0eWxlIH0sIHRoaXMubGF5ZXJIYXNDaGFydHMgJiYgY2hhcnRzLCB0aGlzLmxheWVySGFzSW1hZ2VzICYmIGltYWdlcykpIDogKGgoXCJkaXZcIiwgeyBzdHlsZTogY29udGVudFN0eWxlIH0sIHRoaXMubGF5ZXJIYXNBdHRyaWJ1dGVzICYmIGF0dHJpYnV0ZXMsIHRoaXMubGF5ZXJIYXNBdHRhY2htZW50ICYmIGF0dGFjaG1lbnRzLCB0aGlzLmxheWVySGFzQ2hhcnRzICYmIGNoYXJ0cywgdGhpcy5sYXllckhhc0ltYWdlcyAmJiBpbWFnZXMsIHRoaXMubGF5ZXJIYXNUZXh0ICYmIHJpY2hUZXh0LCB0aGlzLnN1cHBvcnRzQXJjYWRlICYmIGFyY2FkZSwgdGhpcy5sYXllckhhc0VUICYmIGV0LCBwb3B1cFN0YXRlLmxheWVySGFzUmVsYXRlZFJlY29yZHMgJiYgcmVsYXRlZFJlY29yZHMpKSkpKSk7XG4gIH1cbiAgZ2V0IGhvc3RFbGVtZW50KCkgeyByZXR1cm4gZ2V0RWxlbWVudCh0aGlzKTsgfVxufTtcblxuY29uc3QgQ1NTJDEgPSB7XG4gIGFkZE1lZGlhQnV0dG9uOiBcImFkZC1tZWRpYS1idXR0b25cIixcbiAgZm9ybUlucHV0QnV0dG9uOiBcImZvcm0taW5wdXQtYnV0dG9uXCIsXG4gIGRpc2FibGVTcGFjaW5nOiBcImRpc2FibGUtc3BhY2luZ1wiXG59O1xuXG5jb25zdCBhcmNnaXNQb3B1cE11bHRpbWVkaWFDc3MgPSBcIi5hZGQtbWVkaWEtYnV0dG9ue2Rpc3BsYXk6ZmxleDtqdXN0aWZ5LWNvbnRlbnQ6Y2VudGVyO3BhZGRpbmc6dmFyKC0tYXJjZ2lzLWFwcC1jYXAtc3BhY2luZy1oYWxmKSAwIDAgMH0uZm9ybS1pbnB1dC1idXR0b257ZGlzcGxheTpmbGV4fS5mb3JtLWlucHV0LWJ1dHRvbiBjYWxjaXRlLWlucHV0W3R5cGU9dGV4dF17ZGlzcGxheTpmbGV4O2ZsZXgtZmxvdzpjb2x1bW4gbm93cmFwO2ZsZXg6MSAwIDAlO292ZXJmbG93OmhpZGRlbn0uZm9ybS1pbnB1dC1idXR0b24gY2FsY2l0ZS1hY3Rpb257bWFyZ2luOjA7ZmxleDowIDAgMCU7anVzdGlmeS1zZWxmOmZsZXgtZW5kfS5kaXNhYmxlLXNwYWNpbmd7LS1jYWxjaXRlLWxhYmVsLW1hcmdpbi1ib3R0b206MH1cIjtcblxuY29uc3QgQXJjZ2lzUG9wdXBNdWx0aW1lZGlhID0gY2xhc3Mge1xuICBjb25zdHJ1Y3Rvcihob3N0UmVmKSB7XG4gICAgcmVnaXN0ZXJJbnN0YW5jZSh0aGlzLCBob3N0UmVmKTtcbiAgICB0aGlzLmNsb3NlUG9wdXBQb3BvdmVycyA9IGNyZWF0ZUV2ZW50KHRoaXMsIFwiY2xvc2VQb3B1cFBvcG92ZXJzXCIsIDcpO1xuICAgIHRoaXMuY2xvc2VNdWx0aU1lZGlhUG9wb3ZlciA9IGNyZWF0ZUV2ZW50KHRoaXMsIFwiY2xvc2VNdWx0aU1lZGlhUG9wb3ZlclwiLCA3KTtcbiAgICB0aGlzLmludGVybmFsUG9wdXBVcGRhdGVkID0gY3JlYXRlRXZlbnQodGhpcywgXCJpbnRlcm5hbFBvcHVwVXBkYXRlZFwiLCA3KTtcbiAgICB0aGlzLmRlbGV0ZUNvbXBvbmVudCA9IGNyZWF0ZUV2ZW50KHRoaXMsIFwiZGVsZXRlQ29tcG9uZW50XCIsIDcpO1xuICAgIHRoaXMuZGlzYWJsZVBvcHVwUGFuZWwgPSBjcmVhdGVFdmVudCh0aGlzLCBcImRpc2FibGVQb3B1cFBhbmVsXCIsIDcpO1xuICAgIHRoaXMucGlja0xpc3QgPSBbXTtcbiAgICAvLyB0byBrZWVwIHRyYWNrIG9mIGRyYWcgYW5kIGRyb3BcbiAgICB0aGlzLm1lZGlhTWFwID0gbmV3IE1hcCgpO1xuICAgIHRoaXMuY2FsY2l0ZVZhbHVlTGlzdEl0ZW0gPSAobWVkaWFJbmZvLCBsaXN0SXRlbUd1aWQpID0+IChoKFwiY2FsY2l0ZS12YWx1ZS1saXN0LWl0ZW1cIiwgeyBpZDogbGlzdEl0ZW1HdWlkLCBsYWJlbDogKG1lZGlhSW5mby50aXRsZSAmJlxuICAgICAgICBgJHttZWRpYUluZm8udGl0bGUuc3Vic3RyaW5nKDAsIDI1KX0ke21lZGlhSW5mby50aXRsZS5sZW5ndGggPiAyNSA/IFwiLi4uXCIgOiBcIlwifWApIHx8XG4gICAgICAgIHRoaXMuc3RyaW5ncy5ub1RpdGxlLCBkZXNjcmlwdGlvbjogdGhpcy5nZXRNdWx0aU1lZGlhVGV4dChtZWRpYUluZm8udHlwZSksIHZhbHVlOiBsaXN0SXRlbUd1aWQsIG9uQ2xpY2s6IChldmVudCkgPT4ge1xuICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgdGhpcy5jbG9zZVBvcHVwUG9wb3ZlcnMuZW1pdCgpO1xuICAgICAgICB0aGlzLm9wZW5NZWRpYVBvcG92ZXIobWVkaWFJbmZvLCB0aGlzLmZpbmRDaGFydEluZGV4UG9zaXRpb24obGlzdEl0ZW1HdWlkKSk7XG4gICAgICB9IH0sIGgoXCJjYWxjaXRlLWFjdGlvblwiLCB7IHNsb3Q6IFwiYWN0aW9ucy1lbmRcIiwgYXBwZWFyYW5jZTogXCJ0cmFuc3BhcmVudFwiLCB0ZXh0OiB0aGlzLnN0cmluZ3MucmVtb3ZlLCBvbkNsaWNrOiAoZXZlbnQpID0+IHtcbiAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgIHRoaXMuY2xvc2VQb3B1cFBvcG92ZXJzLmVtaXQoKTtcbiAgICAgICAgLy8gZWFjaCBsaXN0LWl0ZW0gaGFzIGlkLiBGaW5kIGlkLCBhbmQgc3BsaWNlIGJ5IGluZGV4XG4gICAgICAgIGNvbnN0IGFsbExpc3RJdGVtcyA9IHRoaXMuaG9zdEVsZW1lbnQuc2hhZG93Um9vdFxuICAgICAgICAgIC5nZXRFbGVtZW50QnlJZChcInZhbHVlTGlzdF9JZFwiKVxuICAgICAgICAgIC5nZXRFbGVtZW50c0J5VGFnTmFtZShcImNhbGNpdGUtdmFsdWUtbGlzdC1pdGVtXCIpO1xuICAgICAgICBmb3IgKGxldCB4ID0gMDsgeCA8IGFsbExpc3RJdGVtcy5sZW5ndGg7IHgrKykge1xuICAgICAgICAgIGlmIChhbGxMaXN0SXRlbXNbeF0uaWQgPT09IGxpc3RJdGVtR3VpZCkge1xuICAgICAgICAgICAgdGhpcy5tdWx0aW1lZGlhQ29udGVudC5tZWRpYUluZm9zLnNwbGljZSh4LCAxKTtcbiAgICAgICAgICAgIC8vIGRlbGV0ZSBjb21wb25lbnQgaWYgZW1wdHksIGVsc2UgcmUtcmVuZGVyXG4gICAgICAgICAgICBpZiAodGhpcy5tdWx0aW1lZGlhQ29udGVudC5tZWRpYUluZm9zLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICB0aGlzLmRlbGV0ZUNvbXBvbmVudC5lbWl0KHRoaXMuZ3VpZCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgLy8gcmVzZXQgdG8gMCBvbiBkZWxldGVcbiAgICAgICAgICAgICAgdGhpcy5zZXRBY3RpdmVNZWRpYUluZm9JbmRleCgwKTtcbiAgICAgICAgICAgICAgdGhpcy5yZVJlbmRlciA9IHRoaXMucmVSZW5kZXIgPyBmYWxzZSA6IHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0gfSwgaChcImNhbGNpdGUtaWNvblwiLCB7IHNjYWxlOiBcInNcIiwgaWNvbjogXCJ4XCIgfSkpKSk7XG4gICAgdGhpcy5mb3JtSW5wdXQgPSAoZm9ybVR5cGUsIGZvcm1TdHJpbmcsIGZvcm1JbnB1dEVsZW1lbnQsIGZvcm1WYWx1ZSwgZm9ybVBsYWNlaG9sZGVyXG4gICAgLy8gcHJvbXB0TWVzc2FnZTogc3RyaW5nXG4gICAgKSA9PiB7XG4gICAgICB2YXIgX2E7XG4gICAgICByZXR1cm4gKGgoXCJjYWxjaXRlLWxhYmVsXCIsIHsgc2NhbGU6IFwic1wiIH0sIGZvcm1TdHJpbmcsIGgoXCJkaXZcIiwgeyBjbGFzczogQ1NTJDEuZm9ybUlucHV0QnV0dG9uIH0sIGgoXCJjYWxjaXRlLWlucHV0XCIsIHsgdHlwZTogXCJ0ZXh0XCIsIGF1dG9mb2N1czogdHJ1ZSwgcmVmOiBmb3JtSW5wdXRFbGVtZW50LCB2YWx1ZTogZm9ybVZhbHVlLCBwbGFjZWhvbGRlcjogZm9ybVBsYWNlaG9sZGVyLCBvbkNhbGNpdGVJbnB1dElucHV0OiAoZXZlbnQpID0+IHtcbiAgICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgICBjb25zdCBpbnB1dFZhbCA9IGV2ZW50LnRhcmdldC52YWx1ZTtcbiAgICAgICAgICBpZiAoZm9ybVR5cGUgPT09IFwidGl0bGVcIikge1xuICAgICAgICAgICAgdGhpcy5tdWx0aW1lZGlhQ29udGVudC50aXRsZSA9IGlucHV0VmFsO1xuICAgICAgICAgIH1cbiAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMubXVsdGltZWRpYUNvbnRlbnQuZGVzY3JpcHRpb24gPSBpbnB1dFZhbDtcbiAgICAgICAgICB9XG4gICAgICAgICAgdGhpcy5yZVJlbmRlciA9ICF0aGlzLnJlUmVuZGVyO1xuICAgICAgICB9LCBvbkNsaWNrOiAoKSA9PiB0aGlzLmNsb3NlUG9wdXBQb3BvdmVycy5lbWl0KCkgfSksICgoX2EgPSB0aGlzLnBvcHVwVGVtcGxhdGUuZmllbGRJbmZvcykgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmxlbmd0aCkgPiAwICYmIChoKFwiY2FsY2l0ZS1hY3Rpb25cIiwgeyB0ZXh0OiB0aGlzLnN0cmluZ3MuYXR0cmlidXRlcywgb25DbGljazogKCkgPT4ge1xuICAgICAgICAgIHRoaXMuY2xvc2VQb3B1cFBvcG92ZXJzLmVtaXQoKTtcbiAgICAgICAgICBpZiAoIXRoaXMucG9wdXBGaWVsZFNlbGVjdGlvblBpY2tMaXN0KSB7XG4gICAgICAgICAgICB0aGlzLnBvcHVwRmllbGRTZWxlY3Rpb25QaWNrTGlzdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJhcmNnaXMtcG9wdXAtZmllbGQtcGljay1saXN0XCIpO1xuICAgICAgICAgICAgdGhpcy5wb3B1cEZpZWxkU2VsZWN0aW9uUGlja0xpc3QucG9wb3ZlclByb3BzID0ge1xuICAgICAgICAgICAgICByZWZFbGVtZW50OiB0aGlzLnBvcHVwRmxvd0l0ZW1cbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICB0aGlzLnBvcHVwRmllbGRTZWxlY3Rpb25QaWNrTGlzdC5tdWx0aXBsZSA9IGZhbHNlO1xuICAgICAgICAgICAgdGhpcy5wb3B1cEZpZWxkU2VsZWN0aW9uUGlja0xpc3QuaGVhZGluZyA9IHRoaXMuc3RyaW5ncy5hZGRGaWVsZDtcbiAgICAgICAgICAgIHRoaXMucG9wdXBGaWVsZFNlbGVjdGlvblBpY2tMaXN0LmFkZEV2ZW50TGlzdGVuZXIoXCJhcmNnaXNQb3B1cFBpY2tMaXN0RGlzbWlzc2VkXCIsICgpID0+IHtcbiAgICAgICAgICAgICAgdGhpcy5jbG9zZVBvcHVwUG9wb3ZlcnMuZW1pdCgpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB0aGlzLnBvcHVwRmllbGRTZWxlY3Rpb25QaWNrTGlzdC5hZGRFdmVudExpc3RlbmVyKFwiYXJjZ2lzUG9wdXBQaWNrTGlzdENoYW5nZVwiLCAoZXZlbnQpID0+IHRoaXMucG9wdXBGaWVsZFNlbGVjdGlvblBpY2tMaXN0Q2hhbmdlcyhldmVudCwgZm9ybVR5cGUpKTtcbiAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQodGhpcy5wb3B1cEZpZWxkU2VsZWN0aW9uUGlja0xpc3QpO1xuICAgICAgICAgICAgdGhpcy5kaXNhYmxlUG9wdXBQYW5lbC5lbWl0KHRydWUpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSwgc2NhbGU6IFwic1wiLCBpY29uOiBcImJyYWNrZXRzLWN1cmx5XCIgfSkpKSkpO1xuICAgIH07XG4gICAgdGhpcy5ndWlkID0gdW5kZWZpbmVkO1xuICAgIHRoaXMubXVsdGltZWRpYUNvbnRlbnQgPSB1bmRlZmluZWQ7XG4gICAgdGhpcy5ibG9ja09wZW4gPSBmYWxzZTtcbiAgICB0aGlzLnBvcHVwRmxvd0l0ZW0gPSB1bmRlZmluZWQ7XG4gICAgdGhpcy5yZVJlbmRlciA9IHVuZGVmaW5lZDtcbiAgfVxuICAvLyBsaWZlY3ljbGUgbWV0aG9kc1xuICBhc3luYyBjb21wb25lbnRXaWxsTG9hZCgpIHtcbiAgICB0aGlzLnN0cmluZ3MgPSBwb3B1cFN0YXRlLnN0cmluZ3M7XG4gICAgdGhpcy5tYXBWaWV3ID0gcG9wdXBTdGF0ZS5tYXBWaWV3O1xuICAgIHRoaXMucG9wdXBUZW1wbGF0ZSA9IHBvcHVwU3RhdGUucG9wdXBUZW1wbGF0ZTtcbiAgICAvLyB3YXRjaCBpZiBwb3B1cCBjaGFuZ2VzIHRvIHJlc2V0IHRoZSBpbmRleFxuICAgIGNvbnN0IFtyZWFjdGl2ZVV0aWxzXSA9IGF3YWl0IGxvYWRNb2R1bGVzKFtcImVzcmkvY29yZS9yZWFjdGl2ZVV0aWxzXCJdKTtcbiAgICByZWFjdGl2ZVV0aWxzLndhdGNoKCgpID0+IHsgdmFyIF9hOyByZXR1cm4gKF9hID0gdGhpcy5tYXBWaWV3LnBvcHVwKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2Euc2VsZWN0ZWRGZWF0dXJlOyB9LCAoKSA9PiB0aGlzLnNldEFjdGl2ZU1lZGlhSW5mb0luZGV4KDApKTtcbiAgICByZWFjdGl2ZVV0aWxzLndhdGNoKCgpID0+IHsgdmFyIF9hOyByZXR1cm4gKF9hID0gdGhpcy5tYXBWaWV3LnBvcHVwKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EudmlzaWJsZTsgfSwgKCkgPT4gdGhpcy5zZXRBY3RpdmVNZWRpYUluZm9JbmRleCgwKSk7XG4gICAgaWYgKCF0aGlzLm11bHRpbWVkaWFDb250ZW50LnRpdGxlKSB7XG4gICAgICB0aGlzLm11bHRpbWVkaWFDb250ZW50LnRpdGxlID0gXCJcIjtcbiAgICB9XG4gICAgaWYgKCF0aGlzLm11bHRpbWVkaWFDb250ZW50LmRlc2NyaXB0aW9uKSB7XG4gICAgICB0aGlzLm11bHRpbWVkaWFDb250ZW50LmRlc2NyaXB0aW9uID0gXCJcIjtcbiAgICB9XG4gIH1cbiAgY29tcG9uZW50RGlkTG9hZCgpIHtcbiAgICBpZiAodGhpcy5ibG9ja09wZW4pIHtcbiAgICAgIHRoaXMuYWRkTWVkaWFCdG4uc2Nyb2xsSW50b1ZpZXcoeyBiZWhhdmlvcjogXCJhdXRvXCIsIGJsb2NrOiBcIm5lYXJlc3RcIiwgaW5saW5lOiBcInN0YXJ0XCIgfSk7XG4gICAgICBpZiAodGhpcy5tdWx0aW1lZGlhQ29udGVudC5tZWRpYUluZm9zLmxlbmd0aCA9PT0gMSkge1xuICAgICAgICB0aGlzLm9wZW5NZWRpYVBvcG92ZXIodGhpcy5tdWx0aW1lZGlhQ29udGVudC5tZWRpYUluZm9zWzBdLCAwKTtcbiAgICAgIH1cbiAgICAgIGVsc2Uge1xuICAgICAgICB0aGlzLmJsb2NrT3B0aW9ucy5zZXRGb2N1cygpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuICBjb21wb25lbnRXaWxsUmVuZGVyKCkge1xuICAgIHRoaXMucGlja0xpc3QgPSBbXTtcbiAgICB0aGlzLm1lZGlhTWFwLmNsZWFyKCk7XG4gICAgdGhpcy5tdWx0aW1lZGlhQ29udGVudC5tZWRpYUluZm9zLmZvckVhY2goKG1lZGlhSW5mbykgPT4ge1xuICAgICAgY29uc3QgbGlzdEl0ZW1HdWlkID0gZ3VpZCgpO1xuICAgICAgdGhpcy5tZWRpYU1hcC5zZXQobGlzdEl0ZW1HdWlkLCBtZWRpYUluZm8pO1xuICAgICAgdGhpcy5waWNrTGlzdC5wdXNoKHRoaXMuY2FsY2l0ZVZhbHVlTGlzdEl0ZW0obWVkaWFJbmZvLCBsaXN0SXRlbUd1aWQpKTtcbiAgICB9KTtcbiAgfVxuICBjb21wb25lbnREaWRVcGRhdGUoKSB7XG4gICAgdGhpcy5pbnRlcm5hbFBvcHVwVXBkYXRlZC5lbWl0KCk7XG4gIH1cbiAgZGlzY29ubmVjdGVkQ2FsbGJhY2soKSB7XG4gICAgaWYgKHRoaXMuaW1hZ2VQb3BvdmVyKSB7XG4gICAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKHRoaXMuaW1hZ2VQb3BvdmVyKTtcbiAgICB9XG4gICAgaWYgKHRoaXMuY2hhcnRQb3BvdmVyKSB7XG4gICAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKHRoaXMuY2hhcnRQb3BvdmVyKTtcbiAgICB9XG4gICAgaWYgKHRoaXMubXVsdGltZWRpYUNvbnRlbnRQb3BvdmVyKSB7XG4gICAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKHRoaXMubXVsdGltZWRpYUNvbnRlbnRQb3BvdmVyKTtcbiAgICB9XG4gICAgaWYgKHRoaXMucG9wdXBGaWVsZFNlbGVjdGlvblBpY2tMaXN0KSB7XG4gICAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKHRoaXMucG9wdXBGaWVsZFNlbGVjdGlvblBpY2tMaXN0KTtcbiAgICB9XG4gIH1cbiAgLy8gZXZlbnRzXG4gIGNhbGNpdGVCbG9ja1RvZ2dsZUhhbmRsZXIoKSB7XG4gICAgdGhpcy5jbG9zZVBvcHVwUG9wb3ZlcnMuZW1pdCgpO1xuICB9XG4gIC8vIGRyYWcgYW5kIGRyb3AgdG8gcmUtb3JkZXJcbiAgY2FsY2l0ZUxpc3RPcmRlckNoYW5nZUhhbmRsZXIoKSB7XG4gICAgbGV0IHRlbXBNZWRpYUluZm9zID0gW107XG4gICAgY29uc3QgYWxsTGlzdEl0ZW1zID0gdGhpcy5ob3N0RWxlbWVudC5zaGFkb3dSb290XG4gICAgICAuZ2V0RWxlbWVudEJ5SWQoXCJ2YWx1ZUxpc3RfSWRcIilcbiAgICAgIC5nZXRFbGVtZW50c0J5VGFnTmFtZShcImNhbGNpdGUtdmFsdWUtbGlzdC1pdGVtXCIpO1xuICAgIGNvbnN0IGV2ZW50VmFsdWVHdWlkcyA9IEFycmF5LmZyb20oYWxsTGlzdEl0ZW1zKS5tYXAoKGl0ZW0pID0+IGl0ZW0uaWQpO1xuICAgIGV2ZW50VmFsdWVHdWlkcy5mb3JFYWNoKChldmVudFZhbHVlR3VpZCkgPT4ge1xuICAgICAgaWYgKHRoaXMubWVkaWFNYXAuaGFzKGV2ZW50VmFsdWVHdWlkKSkge1xuICAgICAgICB0ZW1wTWVkaWFJbmZvcy5wdXNoKHRoaXMubWVkaWFNYXAuZ2V0KGV2ZW50VmFsdWVHdWlkKSk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgaWYgKHRlbXBNZWRpYUluZm9zLmxlbmd0aCA+IDApIHtcbiAgICAgIHRoaXMubXVsdGltZWRpYUNvbnRlbnQubWVkaWFJbmZvcyA9IHRlbXBNZWRpYUluZm9zO1xuICAgIH1cbiAgICAvLyByZXNldCB0byAwIG9uIGRyYWcgYW5kIGRyb3BcbiAgICB0aGlzLnNldEFjdGl2ZU1lZGlhSW5mb0luZGV4KDAsIHRydWUpO1xuICAgIC8vIGRvbnQgbmVlZCB0byByZS1yZW5kZXIgc2luY2Ugb25seSB1cGRhdGluZyBtZWRpYSBpbmZvcy5cbiAgICAvLyBjYWxjaXRlIHBpY2sgbGlzdCB0YWtlcyBjYXJlIG9mIHJlbmRlcmluZyBjb3JyZWN0bHkuXG4gICAgdGhpcy5jbG9zZVBvcHVwUG9wb3ZlcnMuZW1pdCgpO1xuICB9XG4gIHJlc2V0TXVsdGlNZWRpYUluZGV4SGFuZGxlcigpIHtcbiAgICB0aGlzLnNldEFjdGl2ZU1lZGlhSW5mb0luZGV4KDAsIHRydWUpO1xuICB9XG4gIGNsb3NlUG9wdXBQb3BvdmVyc0hhbmRsZXIoZXZlbnQpIHtcbiAgICBpZiAoKGV2ZW50ID09PSBudWxsIHx8IGV2ZW50ID09PSB2b2lkIDAgPyB2b2lkIDAgOiBldmVudC5kZXRhaWwpICE9PSB0aGlzLmd1aWQgJiYgdGhpcy5pbWFnZVBvcG92ZXIpIHtcbiAgICAgIHRoaXMuY2xvc2VNdWx0aU1lZGlhUG9wb3Zlci5lbWl0KCk7XG4gICAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKHRoaXMuaW1hZ2VQb3BvdmVyKTtcbiAgICAgIHRoaXMuaW1hZ2VQb3BvdmVyID0gbnVsbDtcbiAgICAgIHRoaXMuYWRkTWVkaWFCdG4uc2V0Rm9jdXMoKTtcbiAgICAgIHRoaXMuZGlzYWJsZVBvcHVwUGFuZWwuZW1pdChmYWxzZSk7XG4gICAgfVxuICAgIGlmICgoZXZlbnQgPT09IG51bGwgfHwgZXZlbnQgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGV2ZW50LmRldGFpbCkgIT09IHRoaXMuZ3VpZCAmJiB0aGlzLmNoYXJ0UG9wb3Zlcikge1xuICAgICAgdGhpcy5jbG9zZU11bHRpTWVkaWFQb3BvdmVyLmVtaXQoKTtcbiAgICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQodGhpcy5jaGFydFBvcG92ZXIpO1xuICAgICAgdGhpcy5jaGFydFBvcG92ZXIgPSBudWxsO1xuICAgICAgdGhpcy5hZGRNZWRpYUJ0bi5zZXRGb2N1cygpO1xuICAgICAgdGhpcy5kaXNhYmxlUG9wdXBQYW5lbC5lbWl0KGZhbHNlKTtcbiAgICB9XG4gICAgaWYgKHRoaXMubXVsdGltZWRpYUNvbnRlbnRQb3BvdmVyKSB7XG4gICAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKHRoaXMubXVsdGltZWRpYUNvbnRlbnRQb3BvdmVyKTtcbiAgICAgIHRoaXMubXVsdGltZWRpYUNvbnRlbnRQb3BvdmVyID0gbnVsbDtcbiAgICAgIHRoaXMuYWRkTWVkaWFCdG4uZGlzYWJsZWQgPSBmYWxzZTtcbiAgICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZSgoKSA9PiB0aGlzLmFkZE1lZGlhQnRuLnNldEZvY3VzKCkpO1xuICAgICAgdGhpcy5kaXNhYmxlUG9wdXBQYW5lbC5lbWl0KGZhbHNlKTtcbiAgICB9XG4gICAgaWYgKHRoaXMucG9wdXBGaWVsZFNlbGVjdGlvblBpY2tMaXN0KSB7XG4gICAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKHRoaXMucG9wdXBGaWVsZFNlbGVjdGlvblBpY2tMaXN0KTtcbiAgICAgIHRoaXMucG9wdXBGaWVsZFNlbGVjdGlvblBpY2tMaXN0ID0gbnVsbDtcbiAgICAgIHRoaXMuZGlzYWJsZVBvcHVwUGFuZWwuZW1pdChmYWxzZSk7XG4gICAgfVxuICB9XG4gIG5vdGlmeU11bHRpTWVkaWFDaGFuZ2VIYW5kbGVyKGV2ZW50KSB7XG4gICAgdmFyIF9hLCBfYjtcbiAgICBpZiAoKChfYSA9IGV2ZW50LmRldGFpbCkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmd1aWQpID09PSB0aGlzLmd1aWQpIHtcbiAgICAgIHRoaXMuc2V0QWN0aXZlTWVkaWFJbmZvSW5kZXgoKF9iID0gZXZlbnQuZGV0YWlsKSA9PT0gbnVsbCB8fCBfYiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2IubWVkaWFJbmRleFBvc2l0aW9uKTtcbiAgICAgIHRoaXMucmVSZW5kZXIgPSB0aGlzLnJlUmVuZGVyID8gZmFsc2UgOiB0cnVlO1xuICAgIH1cbiAgfVxuICBhc3luYyBub3RpZnlBZGRNdWx0aU1lZGlhQ29udGVudFNlbGVjdGlvbkhhbmRsZXIoZXZlbnQpIHtcbiAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICB0aGlzLmNsb3NlUG9wdXBQb3BvdmVycy5lbWl0KCk7XG4gICAgaWYgKGV2ZW50LmRldGFpbC5ndWlkID09PSB0aGlzLmd1aWQpIHtcbiAgICAgIGNvbnN0IGNvbnRlbnRUeXBlID0gZXZlbnQuZGV0YWlsLmNvbnRlbnQ7XG4gICAgICBjb25zdCBbSW1hZ2VNZWRpYUluZm8sIENvbHVtbkNoYXJ0TWVkaWFJbmZvLCBJbWFnZU1lZGlhSW5mb1ZhbHVlLCBDaGFydE1lZGlhSW5mb1ZhbHVlXSA9IGF3YWl0IGxvYWRNb2R1bGVzKFtcbiAgICAgICAgXCJlc3JpL3BvcHVwL2NvbnRlbnQvSW1hZ2VNZWRpYUluZm9cIixcbiAgICAgICAgXCJlc3JpL3BvcHVwL2NvbnRlbnQvQ29sdW1uQ2hhcnRNZWRpYUluZm9cIixcbiAgICAgICAgXCJlc3JpL3BvcHVwL2NvbnRlbnQvc3VwcG9ydC9JbWFnZU1lZGlhSW5mb1ZhbHVlXCIsXG4gICAgICAgIFwiZXNyaS9wb3B1cC9jb250ZW50L3N1cHBvcnQvQ2hhcnRNZWRpYUluZm9WYWx1ZVwiXG4gICAgICBdKTtcbiAgICAgIGxldCBtdWx0aU1lZGlhRWxlbWVudDtcbiAgICAgIGlmIChjb250ZW50VHlwZSA9PT0gQ29udGVudFNlbGVjdGlvbi5pbWFnZXMpIHtcbiAgICAgICAgbXVsdGlNZWRpYUVsZW1lbnQgPSBuZXcgSW1hZ2VNZWRpYUluZm8oe1xuICAgICAgICAgIHRpdGxlOiBcIlwiLFxuICAgICAgICAgIGNhcHRpb246IFwiXCIsXG4gICAgICAgICAgYWx0VGV4dDogXCJcIixcbiAgICAgICAgICB2YWx1ZTogbmV3IEltYWdlTWVkaWFJbmZvVmFsdWUoe1xuICAgICAgICAgICAgc291cmNlVVJMOiBcIlwiLFxuICAgICAgICAgICAgbGlua1VSTDogXCJcIlxuICAgICAgICAgIH0pXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgICAgZWxzZSBpZiAoY29udGVudFR5cGUgPT09IENvbnRlbnRTZWxlY3Rpb24uY2hhcnRzKSB7XG4gICAgICAgIG11bHRpTWVkaWFFbGVtZW50ID0gbmV3IENvbHVtbkNoYXJ0TWVkaWFJbmZvKHtcbiAgICAgICAgICB0aXRsZTogXCJcIixcbiAgICAgICAgICBjYXB0aW9uOiBcIlwiLFxuICAgICAgICAgIGFsdFRleHQ6IFwiXCIsXG4gICAgICAgICAgdmFsdWU6IG5ldyBDaGFydE1lZGlhSW5mb1ZhbHVlKHtcbiAgICAgICAgICAgIGZpZWxkczogW11cbiAgICAgICAgICB9KVxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICAgIHRoaXMubXVsdGltZWRpYUNvbnRlbnQubWVkaWFJbmZvcy5wdXNoKG11bHRpTWVkaWFFbGVtZW50KTtcbiAgICAgIHRoaXMucmVSZW5kZXIgPSAhdGhpcy5yZVJlbmRlcjtcbiAgICAgIHRoaXMub3Blbk1lZGlhUG9wb3ZlcihtdWx0aU1lZGlhRWxlbWVudCwgdGhpcy5tdWx0aW1lZGlhQ29udGVudC5tZWRpYUluZm9zLmxlbmd0aCAtIDEpO1xuICAgIH1cbiAgfVxuICAvLyBwcml2YXRlIG1ldGhvZHNcbiAgc2V0QWN0aXZlTWVkaWFJbmZvSW5kZXgoaW5kZXgsIHVwZGF0ZVBvcHVwKSB7XG4gICAgdGhpcy5tdWx0aW1lZGlhQ29udGVudC5hY3RpdmVNZWRpYUluZm9JbmRleCA9IGluZGV4IHx8IDA7XG4gICAgdXBkYXRlUG9wdXAgJiYgdGhpcy5pbnRlcm5hbFBvcHVwVXBkYXRlZC5lbWl0KCk7XG4gIH1cbiAgZmluZENoYXJ0SW5kZXhQb3NpdGlvbihsaXN0SXRlbUd1aWQpIHtcbiAgICBjb25zdCBhbGxMaXN0SXRlbXMgPSB0aGlzLmhvc3RFbGVtZW50LnNoYWRvd1Jvb3RcbiAgICAgIC5nZXRFbGVtZW50QnlJZChcInZhbHVlTGlzdF9JZFwiKVxuICAgICAgLmdldEVsZW1lbnRzQnlUYWdOYW1lKFwiY2FsY2l0ZS12YWx1ZS1saXN0LWl0ZW1cIik7XG4gICAgZm9yIChsZXQgeCA9IDA7IHggPCBhbGxMaXN0SXRlbXMubGVuZ3RoOyB4KyspIHtcbiAgICAgIGlmIChhbGxMaXN0SXRlbXNbeF0uaWQgPT09IGxpc3RJdGVtR3VpZCkge1xuICAgICAgICByZXR1cm4geDtcbiAgICAgIH1cbiAgICB9XG4gIH1cbiAgZ2V0TXVsdGlNZWRpYVRleHQodHlwZSkge1xuICAgIGlmICh0eXBlID09PSBQb3B1cE11bHRpTWVkaWFUeXBlLmltYWdlKSB7XG4gICAgICByZXR1cm4gdGhpcy5zdHJpbmdzLmltYWdlO1xuICAgIH1cbiAgICBlbHNlIGlmICh0eXBlID09PSBQb3B1cE11bHRpTWVkaWFUeXBlLmJhckNoYXJ0IHx8IHR5cGUgPT09IFBvcHVwTXVsdGlNZWRpYVR5cGUuY29sdW1uQ2hhcnQpIHtcbiAgICAgIHJldHVybiB0aGlzLnN0cmluZ3MuYmFyQ2hhcnQ7XG4gICAgfVxuICAgIGVsc2UgaWYgKHR5cGUgPT09IFBvcHVwTXVsdGlNZWRpYVR5cGUubGluZUNoYXJ0KSB7XG4gICAgICByZXR1cm4gdGhpcy5zdHJpbmdzLmxpbmVDaGFydDtcbiAgICB9XG4gICAgZWxzZSBpZiAodHlwZSA9PT0gUG9wdXBNdWx0aU1lZGlhVHlwZS5waWVDaGFydCkge1xuICAgICAgcmV0dXJuIHRoaXMuc3RyaW5ncy5waWVDaGFydDtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuc3RyaW5ncy5pbWFnZTtcbiAgfVxuICBvcGVuTWVkaWFQb3BvdmVyKG1lZGlhSW5mbywgaW5kZXhQb3NpdGlvbikge1xuICAgIGlmIChtZWRpYUluZm8udHlwZSA9PT0gUG9wdXBNdWx0aU1lZGlhVHlwZS5pbWFnZSkge1xuICAgICAgdGhpcy5pbWFnZVBvcG92ZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiYXJjZ2lzLXBvcHVwLWltYWdlXCIpO1xuICAgICAgdGhpcy5pbWFnZVBvcG92ZXIuZ3VpZCA9IHRoaXMuZ3VpZDtcbiAgICAgIHRoaXMuaW1hZ2VQb3BvdmVyLnJlZkVsZW1lbnQgPSB0aGlzLnBvcHVwRmxvd0l0ZW07XG4gICAgICB0aGlzLmltYWdlUG9wb3Zlci5pbWFnZU1lZGlhSW5mbyA9IG1lZGlhSW5mbztcbiAgICAgIHRoaXMuaW1hZ2VQb3BvdmVyLm1lZGlhSW5kZXhQb3NpdGlvbiA9IGluZGV4UG9zaXRpb247XG4gICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHRoaXMuaW1hZ2VQb3BvdmVyKTtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICB0aGlzLmNoYXJ0UG9wb3ZlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJhcmNnaXMtcG9wdXAtY2hhcnRcIik7XG4gICAgICB0aGlzLmNoYXJ0UG9wb3Zlci5ndWlkID0gdGhpcy5ndWlkO1xuICAgICAgdGhpcy5jaGFydFBvcG92ZXIucmVmRWxlbWVudCA9IHRoaXMucG9wdXBGbG93SXRlbTtcbiAgICAgIHRoaXMuY2hhcnRQb3BvdmVyLmNoYXJ0TWVkaWFJbmZvID0gbWVkaWFJbmZvO1xuICAgICAgdGhpcy5jaGFydFBvcG92ZXIubWVkaWFDb250ZW50ID0gdGhpcy5tdWx0aW1lZGlhQ29udGVudDtcbiAgICAgIHRoaXMuY2hhcnRQb3BvdmVyLm1lZGlhSW5kZXhQb3NpdGlvbiA9IGluZGV4UG9zaXRpb247XG4gICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHRoaXMuY2hhcnRQb3BvdmVyKTtcbiAgICB9XG4gICAgdGhpcy5kaXNhYmxlUG9wdXBQYW5lbC5lbWl0KHRydWUpO1xuICB9XG4gIGdldFN1bW1hcnRUZXh0KCkge1xuICAgIGlmICh0aGlzLm11bHRpbWVkaWFDb250ZW50Lm1lZGlhSW5mb3MubGVuZ3RoID4gMSkge1xuICAgICAgcmV0dXJuIGAke3RoaXMuc3RyaW5ncy5tdWx0aXBsZX0gKCR7dGhpcy5tdWx0aW1lZGlhQ29udGVudC5tZWRpYUluZm9zLmxlbmd0aH0pYDtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICByZXR1cm4gdGhpcy5nZXRNdWx0aU1lZGlhVGV4dCh0aGlzLm11bHRpbWVkaWFDb250ZW50Lm1lZGlhSW5mb3NbMF0udHlwZSk7XG4gICAgfVxuICB9XG4gIC8vIGZpZWxkIHNlbGVjdGlvbiBmb3IgdGl0bGUgYW5kIGNhcHRpb25cbiAgcG9wdXBGaWVsZFNlbGVjdGlvblBpY2tMaXN0Q2hhbmdlcyhldmVudCwgZm9ybVR5cGUpIHtcbiAgICBjb25zdCBzZWxlY3RlZEZpZWxkTmFtZSA9IGV2ZW50LmRldGFpbC5zZWxlY3RlZEZpZWxkc1swXTtcbiAgICBpZiAoZm9ybVR5cGUgPT09IFwidGl0bGVcIikge1xuICAgICAgdGhpcy5jb250ZW50VGl0bGUudmFsdWUgPSBhZGRTZWxlY3RlZEZpZWxkQXRDdXJzb3IodGhpcy5jb250ZW50VGl0bGUsIHNlbGVjdGVkRmllbGROYW1lKTtcbiAgICAgIHRoaXMuY29udGVudFRpdGxlLnNldEZvY3VzKCk7XG4gICAgICB0aGlzLm11bHRpbWVkaWFDb250ZW50LnRpdGxlID0gdGhpcy5jb250ZW50VGl0bGUudmFsdWU7XG4gICAgfVxuICAgIGVsc2UgaWYgKGZvcm1UeXBlID09PSBcImRlc2NyaXB0aW9uXCIpIHtcbiAgICAgIHRoaXMuY29udGVudERlc2NyaXB0aW9uLnZhbHVlID0gYWRkU2VsZWN0ZWRGaWVsZEF0Q3Vyc29yKHRoaXMuY29udGVudERlc2NyaXB0aW9uLCBzZWxlY3RlZEZpZWxkTmFtZSk7XG4gICAgICB0aGlzLmNvbnRlbnREZXNjcmlwdGlvbi5zZXRGb2N1cygpO1xuICAgICAgdGhpcy5tdWx0aW1lZGlhQ29udGVudC5kZXNjcmlwdGlvbiA9IHRoaXMuY29udGVudERlc2NyaXB0aW9uLnZhbHVlO1xuICAgIH1cbiAgICB0aGlzLmNsb3NlUG9wdXBQb3BvdmVycy5lbWl0KCk7XG4gICAgdGhpcy5yZVJlbmRlciA9ICF0aGlzLnJlUmVuZGVyO1xuICB9XG4gIC8vIHJlbmRvciBtZXRob2RzXG4gIHJlbmRlcigpIHtcbiAgICByZXR1cm4gKGgoSG9zdCwgbnVsbCwgaChcImNhbGNpdGUtYmxvY2tcIiwgeyBkaXI6IGdldEVsZW1lbnREaXIodGhpcy5ob3N0RWxlbWVudCksIGhlYWRpbmc6IHRoaXMubXVsdGltZWRpYUNvbnRlbnQubWVkaWFJbmZvcy5sZW5ndGggPiAxXG4gICAgICAgID8gdGhpcy5zdHJpbmdzLm1lZGlhR3JvdXBcbiAgICAgICAgOiB0aGlzLnN0cmluZ3MubWVkaWEsIGRlc2NyaXB0aW9uOiAodGhpcy5tdWx0aW1lZGlhQ29udGVudC50aXRsZSAmJlxuICAgICAgICBgJHt0aGlzLm11bHRpbWVkaWFDb250ZW50LnRpdGxlLnN1YnN0cmluZygwLCAyNSl9JHt0aGlzLm11bHRpbWVkaWFDb250ZW50LnRpdGxlLmxlbmd0aCA+IDI1ID8gXCIuLi5cIiA6IFwiXCJ9YCkgfHxcbiAgICAgICAgdGhpcy5nZXRTdW1tYXJ0VGV4dCgpLCBjb2xsYXBzaWJsZTogdHJ1ZSwgb3BlbjogdGhpcy5ibG9ja09wZW4sIGRyYWdIYW5kbGU6IHRydWUgfSwgaChcImRpdlwiLCB7IGNsYXNzOiBcImlnbm9yZS1lbGVtZW50cy1zb3J0YWJsZVwiLCBzbG90OiBcImNvbnRyb2xcIiB9LCBoKFwiYXJjZ2lzLWNhbGNpdGUtYmxvY2stb3B0aW9uc1wiLCB7IHJlZjogKGVsKSA9PiAodGhpcy5ibG9ja09wdGlvbnMgPSBlbCksIGd1aWQ6IHRoaXMuZ3VpZCwgaW50bE9wdGlvbnM6IHRoaXMuc3RyaW5ncy5vcHRpb25zLCBpbnRsRGVsZXRlOiB0aGlzLnN0cmluZ3MuZGVsZXRlLCBpbnRsRHVwbGljYXRlOiB0aGlzLnN0cmluZ3MuZHVwbGljYXRlLCBjYWxjaXRlQmxvY2tPcHRpb25zOiB7IGhhc0RlbGV0ZTogdHJ1ZSwgaGFzRHVwbGljYXRlOiB0cnVlIH0gfSkpLCBoKFwiZGl2XCIsIHsgc2xvdDogXCJpY29uXCIgfSwgaChcImNhbGNpdGUtaWNvblwiLCB7IHNjYWxlOiBcIm1cIiwgaWNvbjogXCJpbWFnZXNcIiB9KSksIGgoXCJkaXZcIiwgeyBjbGFzczogXCJpZ25vcmUtZWxlbWVudHMtc29ydGFibGVcIiB9LCB0aGlzLmZvcm1JbnB1dChcInRpdGxlXCIsIHRoaXMuc3RyaW5ncy50aXRsZSwgKGVsZW1lbnQpID0+IHtcbiAgICAgIHJldHVybiAodGhpcy5jb250ZW50VGl0bGUgPSBlbGVtZW50KTtcbiAgICB9LCB0aGlzLm11bHRpbWVkaWFDb250ZW50LnRpdGxlLCB0aGlzLnN0cmluZ3MuZW50ZXJUaXRsZVxuICAgIC8vIHRoaXMuc3RyaW5ncy50aXRsZUNvbnRleHQucmVwbGFjZShcIiR7dGl0bGVDb250ZXh0fVwiLCB0aGlzLnN0cmluZ3MubWVkaWFfTClcbiAgICApLCB0aGlzLmZvcm1JbnB1dChcImRlc2NyaXB0aW9uXCIsIHRoaXMuc3RyaW5ncy5kZXNjLCAoZWxlbWVudCkgPT4ge1xuICAgICAgcmV0dXJuICh0aGlzLmNvbnRlbnREZXNjcmlwdGlvbiA9IGVsZW1lbnQpO1xuICAgIH0sIHRoaXMubXVsdGltZWRpYUNvbnRlbnQuZGVzY3JpcHRpb24sIHRoaXMuc3RyaW5ncy5lbnRlckRlc2NyaXB0aW9uXG4gICAgLy8gdGhpcy5zdHJpbmdzLmRlc2NyaXB0aW9uQ29udGV4dC5yZXBsYWNlKFwiJHtkZXNjcmlwdGlvbkNvbnRleHR9XCIsIHRoaXMuc3RyaW5ncy5tZWRpYV9MKVxuICAgICksIGgoXCJjYWxjaXRlLWxhYmVsXCIsIHsgY2xhc3M6IENTUyQxLmRpc2FibGVTcGFjaW5nLCBzY2FsZTogXCJzXCIgfSwgdGhpcy5zdHJpbmdzLm1lZGlhQ29udGVudCksIGgoXCJjYWxjaXRlLXZhbHVlLWxpc3RcIiwgeyBpZDogXCJ2YWx1ZUxpc3RfSWRcIiwgXCJkcmFnLWVuYWJsZWRcIjogdHJ1ZSB9LCB0aGlzLnBpY2tMaXN0KSwgaChcImNhbGNpdGUtYnV0dG9uXCIsIHsgcmVmOiAoZWwpID0+ICh0aGlzLmFkZE1lZGlhQnRuID0gZWwpLCB0aXRsZTogdGhpcy5zdHJpbmdzLmFkZE1lZGlhLCBhcHBlYXJhbmNlOiBcIm91dGxpbmUtZmlsbFwiLCByb3VuZDogdHJ1ZSwgc2NhbGU6IFwic1wiLCBjbGFzczogQ1NTJDEuYWRkTWVkaWFCdXR0b24sIGljb25TdGFydDogXCJwbHVzXCIsIG9uQ2xpY2s6IChldmVudCkgPT4ge1xuICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgdGhpcy5jbG9zZVBvcHVwUG9wb3ZlcnMuZW1pdCgpO1xuICAgICAgICBpZiAoIXRoaXMubXVsdGltZWRpYUNvbnRlbnRQb3BvdmVyKSB7XG4gICAgICAgICAgdGhpcy5tdWx0aW1lZGlhQ29udGVudFBvcG92ZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiYXJjZ2lzLXBvcHVwLW1haW4tY29udGVudHBvcG92ZXJcIik7XG4gICAgICAgICAgdGhpcy5tdWx0aW1lZGlhQ29udGVudFBvcG92ZXIuY29udGVudFBvcG92ZXJSZWZFbGVtZW50ID0gdGhpcy5hZGRNZWRpYUJ0bjtcbiAgICAgICAgICB0aGlzLm11bHRpbWVkaWFDb250ZW50UG9wb3Zlci5wb3BvdmVyUGFuZWxXaWR0aCA9XG4gICAgICAgICAgICB0aGlzLmhvc3RFbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLndpZHRoO1xuICAgICAgICAgIHRoaXMubXVsdGltZWRpYUNvbnRlbnRQb3BvdmVyLmlzTXVsdGltZWRpYUNvbnRlbnQgPSB0cnVlO1xuICAgICAgICAgIHRoaXMubXVsdGltZWRpYUNvbnRlbnRQb3BvdmVyLmd1aWQgPSB0aGlzLmd1aWQ7XG4gICAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZCh0aGlzLm11bHRpbWVkaWFDb250ZW50UG9wb3Zlcik7XG4gICAgICAgICAgdGhpcy5hZGRNZWRpYUJ0bi5kaXNhYmxlZCA9IHRydWU7XG4gICAgICAgICAgdGhpcy5kaXNhYmxlUG9wdXBQYW5lbC5lbWl0KHRydWUpO1xuICAgICAgICB9XG4gICAgICB9IH0pKSkpKTtcbiAgfVxuICBnZXQgaG9zdEVsZW1lbnQoKSB7IHJldHVybiBnZXRFbGVtZW50KHRoaXMpOyB9XG59O1xuQXJjZ2lzUG9wdXBNdWx0aW1lZGlhLnN0eWxlID0gYXJjZ2lzUG9wdXBNdWx0aW1lZGlhQ3NzO1xuXG5jb25zdCBhcmNnaXNQb3B1cFJlbGF0aW9uc2hpcENzcyA9IFwiLmZvcm0taW5wdXQtYnV0dG9ue2Rpc3BsYXk6ZmxleH0uZm9ybS1pbnB1dC1idXR0b24gY2FsY2l0ZS1pbnB1dFt0eXBlPXRleHRde2Rpc3BsYXk6ZmxleDtmbGV4LWZsb3c6Y29sdW1uIG5vd3JhcDtmbGV4OjEgMCAwJTtvdmVyZmxvdzpoaWRkZW59LmZvcm0taW5wdXQtYnV0dG9uIGNhbGNpdGUtYWN0aW9ue21hcmdpbjowO2ZsZXg6MCAwIDAlO2p1c3RpZnktc2VsZjpmbGV4LWVuZH0uZHJvcGRvd257ZGlzcGxheTpibG9ja31cIjtcblxuY29uc3QgQXJjZ2lzUG9wdXBSZWxhdGlvbnNoaXAgPSBjbGFzcyB7XG4gIGNvbnN0cnVjdG9yKGhvc3RSZWYpIHtcbiAgICByZWdpc3Rlckluc3RhbmNlKHRoaXMsIGhvc3RSZWYpO1xuICAgIHRoaXMuY2xvc2VQb3B1cFBvcG92ZXJzID0gY3JlYXRlRXZlbnQodGhpcywgXCJjbG9zZVBvcHVwUG9wb3ZlcnNcIiwgNyk7XG4gICAgdGhpcy5pbnRlcm5hbFBvcHVwVXBkYXRlZCA9IGNyZWF0ZUV2ZW50KHRoaXMsIFwiaW50ZXJuYWxQb3B1cFVwZGF0ZWRcIiwgNyk7XG4gICAgdGhpcy5kaXNhYmxlUG9wdXBQYW5lbCA9IGNyZWF0ZUV2ZW50KHRoaXMsIFwiZGlzYWJsZVBvcHVwUGFuZWxcIiwgNyk7XG4gICAgdGhpcy5tYXhQcmV2aWV3Q291bnQgPSAxMTtcbiAgICB0aGlzLmZpZWxkUGlja0xpc3RDaGFuZ2VzID0gKGV2ZW50KSA9PiB7XG4gICAgICB2YXIgX2EsIF9iO1xuICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICBjb25zdCBzZWxlY3RlZEZpZWxkID0gKF9iID0gKF9hID0gZXZlbnQuZGV0YWlsKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2Euc2VsZWN0ZWRGaWVsZHMpID09PSBudWxsIHx8IF9iID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYlswXTtcbiAgICAgIGlmIChzZWxlY3RlZEZpZWxkKSB7XG4gICAgICAgIHRoaXMucmVsYXRlZFJlY29yZHNDb250ZW50Lm9yZGVyQnlGaWVsZHNbMF0uZmllbGQgPSBzZWxlY3RlZEZpZWxkO1xuICAgICAgICB0aGlzLnJlUmVuZGVyID0gIXRoaXMucmVSZW5kZXI7XG4gICAgICB9XG4gICAgICB0aGlzLmNsb3NlUG9wdXBQb3BvdmVycy5lbWl0KCk7XG4gICAgfTtcbiAgICB0aGlzLmZvcm1JbnB1dCA9IChmb3JtVHlwZSwgZm9ybVN0cmluZywgZm9ybUlucHV0RWxlbWVudCwgZm9ybVZhbHVlLCBmb3JtUGxhY2Vob2xkZXIpID0+IHtcbiAgICAgIHZhciBfYTtcbiAgICAgIHJldHVybiAoaChcImNhbGNpdGUtbGFiZWxcIiwgeyBzY2FsZTogXCJzXCIgfSwgZm9ybVN0cmluZywgaChcImRpdlwiLCB7IGNsYXNzOiBcImZvcm0taW5wdXQtYnV0dG9uXCIgfSwgaChcImNhbGNpdGUtaW5wdXRcIiwgeyB0eXBlOiBcInRleHRcIiwgYXV0b2ZvY3VzOiB0cnVlLCByZWY6IGZvcm1JbnB1dEVsZW1lbnQsIHZhbHVlOiBmb3JtVmFsdWUsIHBsYWNlaG9sZGVyOiBmb3JtUGxhY2Vob2xkZXIsIGRpc2FibGVkOiAhdGhpcy5oYXNSZWxhdGlvbnNoaXBMYXllciwgb25DYWxjaXRlSW5wdXRJbnB1dDogKGV2ZW50KSA9PiB7XG4gICAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgICAgY29uc3QgaW5wdXRWYWwgPSBldmVudC50YXJnZXQudmFsdWU7XG4gICAgICAgICAgaWYgKGZvcm1UeXBlID09PSBcInRpdGxlXCIpIHtcbiAgICAgICAgICAgIHRoaXMucmVsYXRlZFJlY29yZHNDb250ZW50LnRpdGxlID0gaW5wdXRWYWw7XG4gICAgICAgICAgfVxuICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5yZWxhdGVkUmVjb3Jkc0NvbnRlbnQuZGVzY3JpcHRpb24gPSBpbnB1dFZhbDtcbiAgICAgICAgICB9XG4gICAgICAgICAgdGhpcy5yZVJlbmRlciA9ICF0aGlzLnJlUmVuZGVyO1xuICAgICAgICB9LCBvbkNsaWNrOiAoKSA9PiB0aGlzLmNsb3NlUG9wdXBQb3BvdmVycy5lbWl0KCkgfSksICgoX2EgPSB0aGlzLnBvcHVwVGVtcGxhdGUuZmllbGRJbmZvcykgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmxlbmd0aCkgJiYgKGgoXCJjYWxjaXRlLWFjdGlvblwiLCB7IHRleHQ6IHRoaXMuc3RyaW5ncy5hdHRyaWJ1dGVzLCBkaXNhYmxlZDogIXRoaXMuaGFzUmVsYXRpb25zaGlwTGF5ZXIsIG9uQ2xpY2s6ICgpID0+IHtcbiAgICAgICAgICB0aGlzLmNsb3NlUG9wdXBQb3BvdmVycy5lbWl0KCk7XG4gICAgICAgICAgaWYgKCF0aGlzLnBvcHVwRmllbGRTZWxlY3Rpb25QaWNrTGlzdCkge1xuICAgICAgICAgICAgdGhpcy5wb3B1cEZpZWxkU2VsZWN0aW9uUGlja0xpc3QgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiYXJjZ2lzLXBvcHVwLWZpZWxkLXBpY2stbGlzdFwiKTtcbiAgICAgICAgICAgIHRoaXMucG9wdXBGaWVsZFNlbGVjdGlvblBpY2tMaXN0LnBvcG92ZXJQcm9wcyA9IHtcbiAgICAgICAgICAgICAgcmVmRWxlbWVudDogdGhpcy5wb3B1cEZsb3dJdGVtLFxuICAgICAgICAgICAgICBvZmZzZXRTa2lkZGluZzogNTBcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICB0aGlzLnBvcHVwRmllbGRTZWxlY3Rpb25QaWNrTGlzdC5tdWx0aXBsZSA9IGZhbHNlO1xuICAgICAgICAgICAgdGhpcy5wb3B1cEZpZWxkU2VsZWN0aW9uUGlja0xpc3QuaGVhZGluZyA9IHRoaXMuc3RyaW5ncy5hZGRGaWVsZDtcbiAgICAgICAgICAgIHRoaXMucG9wdXBGaWVsZFNlbGVjdGlvblBpY2tMaXN0LmFkZEV2ZW50TGlzdGVuZXIoXCJhcmNnaXNQb3B1cFBpY2tMaXN0RGlzbWlzc2VkXCIsICgpID0+IHtcbiAgICAgICAgICAgICAgdGhpcy5jbG9zZVBvcHVwUG9wb3ZlcnMuZW1pdCgpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB0aGlzLnBvcHVwRmllbGRTZWxlY3Rpb25QaWNrTGlzdC5hZGRFdmVudExpc3RlbmVyKFwiYXJjZ2lzUG9wdXBQaWNrTGlzdENoYW5nZVwiLCAoZXZlbnQpID0+IHRoaXMucG9wdXBGaWVsZFNlbGVjdGlvblBpY2tMaXN0Q2hhbmdlcyhldmVudCwgZm9ybVR5cGUpKTtcbiAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQodGhpcy5wb3B1cEZpZWxkU2VsZWN0aW9uUGlja0xpc3QpO1xuICAgICAgICAgICAgdGhpcy5kaXNhYmxlUG9wdXBQYW5lbC5lbWl0KHRydWUpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSwgc2NhbGU6IFwic1wiLCBpY29uOiBcImJyYWNrZXRzLWN1cmx5XCIgfSkpKSkpO1xuICAgIH07XG4gICAgdGhpcy5ndWlkID0gdW5kZWZpbmVkO1xuICAgIHRoaXMucmVsYXRlZFJlY29yZHNDb250ZW50ID0gdW5kZWZpbmVkO1xuICAgIHRoaXMuYmxvY2tPcGVuID0gZmFsc2U7XG4gICAgdGhpcy5wb3B1cEZsb3dJdGVtID0gdW5kZWZpbmVkO1xuICAgIHRoaXMucmVSZW5kZXIgPSB1bmRlZmluZWQ7XG4gICAgdGhpcy5oYXNSZWxhdGlvbnNoaXBMYXllciA9IHRydWU7XG4gIH1cbiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgLy9cbiAgLy8gIExpZmVjeWNsZVxuICAvL1xuICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICBhc3luYyBjb21wb25lbnRXaWxsTG9hZCgpIHtcbiAgICB0aGlzLnN0cmluZ3MgPSBwb3B1cFN0YXRlLnN0cmluZ3M7XG4gICAgdGhpcy5sYXllciA9IHBvcHVwU3RhdGUubGF5ZXI7XG4gICAgdGhpcy52aWV3ID0gcG9wdXBTdGF0ZS5tYXBWaWV3O1xuICAgIHRoaXMucG9wdXBUZW1wbGF0ZSA9IHBvcHVwU3RhdGUucG9wdXBUZW1wbGF0ZTtcbiAgICBhd2FpdCB0aGlzLmxvYWRBbGxNb2R1bGVzKCk7XG4gICAgdGhpcy5oYXNSZWxhdGlvbnNoaXBMYXllciA9IGF3YWl0IHRoaXMuY2hlY2tJZlJlbGF0aW9uc2hpcEV4aXN0cygpO1xuICAgIGlmICghdGhpcy5yZWxhdGVkUmVjb3Jkc0NvbnRlbnQudGl0bGUpIHtcbiAgICAgIHRoaXMucmVsYXRlZFJlY29yZHNDb250ZW50LnRpdGxlID0gXCJcIjtcbiAgICB9XG4gICAgaWYgKCF0aGlzLnJlbGF0ZWRSZWNvcmRzQ29udGVudC5kZXNjcmlwdGlvbikge1xuICAgICAgdGhpcy5yZWxhdGVkUmVjb3Jkc0NvbnRlbnQuZGVzY3JpcHRpb24gPSBcIlwiO1xuICAgIH1cbiAgfVxuICBjb21wb25lbnREaWRMb2FkKCkge1xuICAgIGlmICh0aGlzLmJsb2NrT3Blbikge1xuICAgICAgdGhpcy5ibG9ja09wdGlvbnMuc2Nyb2xsSW50b1ZpZXcoeyBiZWhhdmlvcjogXCJzbW9vdGhcIiwgYmxvY2s6IFwibmVhcmVzdFwiLCBpbmxpbmU6IFwic3RhcnRcIiB9KTtcbiAgICAgIHRoaXMuYmxvY2tPcHRpb25zLnNldEZvY3VzKCk7XG4gICAgfVxuICAgIHRoaXMud2F0Y2hGb3JDaGFuZ2VzVG9MYXllcnNMaXN0KCk7XG4gIH1cbiAgY29tcG9uZW50RGlkVXBkYXRlKCkge1xuICAgIHRoaXMuaW50ZXJuYWxQb3B1cFVwZGF0ZWQuZW1pdCgpO1xuICB9XG4gIGRpc2Nvbm5lY3RlZENhbGxiYWNrKCkge1xuICAgIHZhciBfYTtcbiAgICAoX2EgPSB0aGlzLndhdGNoTGF5ZXJzVGFibGVzKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EucmVtb3ZlKCk7XG4gICAgaWYgKHRoaXMucG9wdXBGaWVsZFNlbGVjdGlvblBpY2tMaXN0KSB7XG4gICAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKHRoaXMucG9wdXBGaWVsZFNlbGVjdGlvblBpY2tMaXN0KTtcbiAgICB9XG4gICAgaWYgKHRoaXMuYXJjZ2lzRmllbGRQaWNrTGlzdCkge1xuICAgICAgZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZCh0aGlzLmFyY2dpc0ZpZWxkUGlja0xpc3QpO1xuICAgIH1cbiAgfVxuICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAvL1xuICAvLyBFdmVudHNcbiAgLy9cbiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgY2xvc2VQb3B1cFBvcG92ZXJzSGFuZGxlcigpIHtcbiAgICBpZiAodGhpcy5wb3B1cEZpZWxkU2VsZWN0aW9uUGlja0xpc3QpIHtcbiAgICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQodGhpcy5wb3B1cEZpZWxkU2VsZWN0aW9uUGlja0xpc3QpO1xuICAgICAgdGhpcy5wb3B1cEZpZWxkU2VsZWN0aW9uUGlja0xpc3QgPSBudWxsO1xuICAgICAgdGhpcy5kaXNhYmxlUG9wdXBQYW5lbC5lbWl0KGZhbHNlKTtcbiAgICB9XG4gICAgaWYgKHRoaXMuYXJjZ2lzRmllbGRQaWNrTGlzdCkge1xuICAgICAgZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZCh0aGlzLmFyY2dpc0ZpZWxkUGlja0xpc3QpO1xuICAgICAgdGhpcy5hcmNnaXNGaWVsZFBpY2tMaXN0ID0gbnVsbDtcbiAgICAgIHRoaXMuZGlzYWJsZVBvcHVwUGFuZWwuZW1pdChmYWxzZSk7XG4gICAgfVxuICB9XG4gIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIC8vXG4gIC8vIFByaXZhdGUgTWV0aG9kc1xuICAvL1xuICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICBhc3luYyBsb2FkQWxsTW9kdWxlcygpIHtcbiAgICBbdGhpcy5SZWxhdGVkUmVjb3Jkc0luZm9GaWVsZE9yZGVyLCB0aGlzLnJlYWN0aXZlVXRpbHNdID0gYXdhaXQgbG9hZE1vZHVsZXMoW1xuICAgICAgXCJlc3JpL3BvcHVwL3N1cHBvcnQvUmVsYXRlZFJlY29yZHNJbmZvRmllbGRPcmRlclwiLFxuICAgICAgXCJlc3JpL2NvcmUvcmVhY3RpdmVVdGlsc1wiXG4gICAgXSk7XG4gIH1cbiAgLy8gZmllbGQgc2VsZWN0aW9uIGZvciB0aXRsZSBhbmQgY2FwdGlvblxuICBwb3B1cEZpZWxkU2VsZWN0aW9uUGlja0xpc3RDaGFuZ2VzKGV2ZW50LCBmb3JtVHlwZSkge1xuICAgIGNvbnN0IHNlbGVjdGVkRmllbGROYW1lID0gZXZlbnQuZGV0YWlsLnNlbGVjdGVkRmllbGRzWzBdO1xuICAgIGlmIChmb3JtVHlwZSA9PT0gXCJ0aXRsZVwiKSB7XG4gICAgICB0aGlzLmNvbnRlbnRUaXRsZS52YWx1ZSA9IGFkZFNlbGVjdGVkRmllbGRBdEN1cnNvcih0aGlzLmNvbnRlbnRUaXRsZSwgc2VsZWN0ZWRGaWVsZE5hbWUpO1xuICAgICAgdGhpcy5jb250ZW50VGl0bGUuc2V0Rm9jdXMoKTtcbiAgICAgIHRoaXMucmVsYXRlZFJlY29yZHNDb250ZW50LnRpdGxlID0gdGhpcy5jb250ZW50VGl0bGUudmFsdWU7XG4gICAgfVxuICAgIGVsc2UgaWYgKGZvcm1UeXBlID09PSBcImRlc2NyaXB0aW9uXCIpIHtcbiAgICAgIHRoaXMuY29udGVudERlc2NyaXB0aW9uLnZhbHVlID0gYWRkU2VsZWN0ZWRGaWVsZEF0Q3Vyc29yKHRoaXMuY29udGVudERlc2NyaXB0aW9uLCBzZWxlY3RlZEZpZWxkTmFtZSk7XG4gICAgICB0aGlzLmNvbnRlbnREZXNjcmlwdGlvbi5zZXRGb2N1cygpO1xuICAgICAgdGhpcy5yZWxhdGVkUmVjb3Jkc0NvbnRlbnQuZGVzY3JpcHRpb24gPSB0aGlzLmNvbnRlbnREZXNjcmlwdGlvbi52YWx1ZTtcbiAgICB9XG4gICAgdGhpcy5jbG9zZVBvcHVwUG9wb3ZlcnMuZW1pdCgpO1xuICAgIHRoaXMucmVSZW5kZXIgPSAhdGhpcy5yZVJlbmRlcjtcbiAgfVxuICBhc3luYyBvcGVuUGlja0xpc3QoY3VyckxheWVyKSB7XG4gICAgdmFyIF9hLCBfYiwgX2M7XG4gICAgdGhpcy5jbG9zZVBvcHVwUG9wb3ZlcnMuZW1pdCgpO1xuICAgIGlmICghdGhpcy5hcmNnaXNGaWVsZFBpY2tMaXN0KSB7XG4gICAgICB0aGlzLmFyY2dpc0ZpZWxkUGlja0xpc3QgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiYXJjZ2lzLWZpZWxkLXBpY2stbGlzdFwiKTtcbiAgICAgIHRoaXMuYXJjZ2lzRmllbGRQaWNrTGlzdC5wb3BvdmVyUHJvcHMgPSB7XG4gICAgICAgIHJlZkVsZW1lbnQ6IHRoaXMucG9wdXBGbG93SXRlbSxcbiAgICAgICAgb2Zmc2V0U2tpZGRpbmc6IDUwXG4gICAgICB9O1xuICAgICAgdGhpcy5hcmNnaXNGaWVsZFBpY2tMaXN0LmZpZWxkcyA9IGN1cnJMYXllci5maWVsZHMuZmlsdGVyKChmaWVsZCkgPT4gZmllbGQudmlzaWJsZSk7XG4gICAgICB0aGlzLmFyY2dpc0ZpZWxkUGlja0xpc3QubGF5ZXIgPSBjdXJyTGF5ZXI7XG4gICAgICB0aGlzLmFyY2dpc0ZpZWxkUGlja0xpc3QubWFwVmlldyA9IHRoaXMudmlldztcbiAgICAgIHRoaXMuYXJjZ2lzRmllbGRQaWNrTGlzdC5zaG93RmllbGRJbmZvID0gdHJ1ZTtcbiAgICAgIHRoaXMuYXJjZ2lzRmllbGRQaWNrTGlzdC5zaG93RmllbGROYW1lID0gdHJ1ZTtcbiAgICAgIHRoaXMuYXJjZ2lzRmllbGRQaWNrTGlzdC5zZWxlY3RlZEZpZWxkcyA9IFtcbiAgICAgICAgKF9jID0gKF9iID0gKF9hID0gdGhpcy5yZWxhdGVkUmVjb3Jkc0NvbnRlbnQpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5vcmRlckJ5RmllbGRzKSA9PT0gbnVsbCB8fCBfYiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2JbMF0pID09PSBudWxsIHx8IF9jID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYy5maWVsZFxuICAgICAgXTtcbiAgICAgIHRoaXMuYXJjZ2lzRmllbGRQaWNrTGlzdC5hZGRFdmVudExpc3RlbmVyKFwiYXJjZ2lzRmllbGRQaWNrTGlzdERpc21pc3NlZFwiLCB0aGlzLmZpZWxkUGlja0xpc3RDaGFuZ2VzKTtcbiAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQodGhpcy5hcmNnaXNGaWVsZFBpY2tMaXN0KTtcbiAgICAgIHRoaXMuZGlzYWJsZVBvcHVwUGFuZWwuZW1pdCh0cnVlKTtcbiAgICB9XG4gIH1cbiAgYXN5bmMgY2hlY2tJZlJlbGF0aW9uc2hpcEV4aXN0cygpIHtcbiAgICB2YXIgX2E7XG4gICAgZm9yIChjb25zdCByZWxhdGlvbnNoaXAgb2YgKF9hID0gdGhpcy5sYXllcikgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLnJlbGF0aW9uc2hpcHMpIHtcbiAgICAgIGlmIChyZWxhdGlvbnNoaXAuaWQgPT09IHRoaXMucmVsYXRlZFJlY29yZHNDb250ZW50LnJlbGF0aW9uc2hpcElkKSB7XG4gICAgICAgIGZvciAoY29uc3QgY3VyckxheWVyT3JUYWJsZSBvZiBbLi4udGhpcy52aWV3Lm1hcC5hbGxMYXllcnMsIC4uLnRoaXMudmlldy5tYXAuYWxsVGFibGVzXSkge1xuICAgICAgICAgIGNvbnN0IGN1cnIgPSBjdXJyTGF5ZXJPclRhYmxlO1xuICAgICAgICAgIGlmIChhd2FpdCByZWxhdGlvbnNoaXBFeGlzdHModGhpcy5sYXllciwgY3VyciwgcmVsYXRpb25zaGlwKSkge1xuICAgICAgICAgICAgYXdhaXQgY3Vyci5sb2FkKCk7XG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHRydWUpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKGZhbHNlKTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShmYWxzZSk7XG4gIH1cbiAgd2F0Y2hGb3JDaGFuZ2VzVG9MYXllcnNMaXN0KCkge1xuICAgIHRoaXMud2F0Y2hMYXllcnNUYWJsZXMgPSB0aGlzLnJlYWN0aXZlVXRpbHMud2F0Y2goKCkgPT4gW3RoaXMudmlldy5tYXAuYWxsTGF5ZXJzLmxlbmd0aCwgdGhpcy52aWV3Lm1hcC5hbGxUYWJsZXMubGVuZ3RoXSwgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gY2hlY2sgaWYgcmVsYXRlZCBsYXllci90YWJsZSBpcyByZW1vdmVkLCBhbmQgZGlzYWJsZSBwYW5lbC9zaG93IHdhcm5pbmcgaWYgeWVzXG4gICAgICB0aGlzLmhhc1JlbGF0aW9uc2hpcExheWVyID0gYXdhaXQgdGhpcy5jaGVja0lmUmVsYXRpb25zaGlwRXhpc3RzKCk7XG4gICAgfSk7XG4gIH1cbiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgLy9cbiAgLy8gUmVuZG9yICBNZXRob2RzXG4gIC8vXG4gIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIHJlbmRlcigpIHtcbiAgICB2YXIgX2EsIF9iLCBfYywgX2QsIF9lLCBfZiwgX2c7XG4gICAgY29uc3QgcmVsYXRpb25zaGlwID0gKGgoXCJjYWxjaXRlLWxhYmVsXCIsIG51bGwsIHRoaXMuc3RyaW5ncy5yZWxhdGlvbnNoaXAsIGgoXCJjYWxjaXRlLWRyb3Bkb3duXCIsIHsgZGlzYWJsZWQ6ICF0aGlzLmhhc1JlbGF0aW9uc2hpcExheWVyLCBvdmVybGF5UG9zaXRpb25pbmc6IFwiZml4ZWRcIiwgY2xhc3M6IFwiZHJvcGRvd25cIiB9LCBoKFwiY2FsY2l0ZS1idXR0b25cIiwgeyBzbG90OiBcInRyaWdnZXJcIiwgYXBwZWFyYW5jZTogXCJvdXRsaW5lLWZpbGxcIiwga2luZDogXCJuZXV0cmFsXCIsIGljb25FbmQ6IFwiY2hldnJvbkRvd25cIiwgYWxpZ25tZW50OiBcImljb24tZW5kLXNwYWNlLWJldHdlZW5cIiwgd2lkdGg6IFwiZnVsbFwiLCBzY2FsZTogXCJtXCIgfSwgKCgpID0+IHtcbiAgICAgIGZvciAoY29uc3QgcmVsYXRpb25zaGlwIG9mIHRoaXMubGF5ZXIucmVsYXRpb25zaGlwcykge1xuICAgICAgICBpZiAocmVsYXRpb25zaGlwLmlkID09PSB0aGlzLnJlbGF0ZWRSZWNvcmRzQ29udGVudC5yZWxhdGlvbnNoaXBJZCkge1xuICAgICAgICAgIHJldHVybiByZWxhdGlvbnNoaXAubmFtZSB8fCB0aGlzLnN0cmluZ3MucmVsYXRpb25zaGlwO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICByZXR1cm4gdGhpcy5zdHJpbmdzLnJlbGF0aW9uc2hpcDtcbiAgICB9KSgpKSwgaChcImNhbGNpdGUtZHJvcGRvd24tZ3JvdXBcIiwgbnVsbCwgdGhpcy5sYXllci5yZWxhdGlvbnNoaXBzLm1hcCgocmVsYXRpb25zaGlwKSA9PiB7XG4gICAgICBmb3IgKGNvbnN0IGN1cnJMYXllck9yVGFibGUgb2YgW1xuICAgICAgICAuLi50aGlzLnZpZXcubWFwLmFsbExheWVycyxcbiAgICAgICAgLi4udGhpcy52aWV3Lm1hcC5hbGxUYWJsZXNcbiAgICAgIF0pIHtcbiAgICAgICAgY29uc3QgY3VyciA9IGN1cnJMYXllck9yVGFibGU7XG4gICAgICAgIGlmIChyZWxhdGlvbnNoaXBFeGlzdHNDaGVja1dpdGhvdXRMb2FkKHRoaXMubGF5ZXIsIGN1cnIsIHJlbGF0aW9uc2hpcCkpIHtcbiAgICAgICAgICByZXR1cm4gKGgoXCJjYWxjaXRlLWRyb3Bkb3duLWl0ZW1cIiwgeyBzZWxlY3RlZDogdGhpcy5yZWxhdGVkUmVjb3Jkc0NvbnRlbnQucmVsYXRpb25zaGlwSWQgPT09IHJlbGF0aW9uc2hpcC5pZCwgb25DbGljazogYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgICB2YXIgX2E7XG4gICAgICAgICAgICAgIGF3YWl0IGN1cnIubG9hZCgpO1xuICAgICAgICAgICAgICB0aGlzLnJlbGF0ZWRSZWNvcmRzQ29udGVudC5yZWxhdGlvbnNoaXBJZCA9IHJlbGF0aW9uc2hpcC5pZDtcbiAgICAgICAgICAgICAgdGhpcy5yZWxhdGVkUmVjb3Jkc0NvbnRlbnQub3JkZXJCeUZpZWxkcyA9IFtcbiAgICAgICAgICAgICAgICBuZXcgdGhpcy5SZWxhdGVkUmVjb3Jkc0luZm9GaWVsZE9yZGVyKHtcbiAgICAgICAgICAgICAgICAgIGZpZWxkOiBjdXJyLmZpZWxkcy5maW5kKChmaWVsZCkgPT4gZmllbGQudmlzaWJsZSlcbiAgICAgICAgICAgICAgICAgICAgLm5hbWUsXG4gICAgICAgICAgICAgICAgICBvcmRlcjogKChfYSA9IHRoaXMucmVsYXRlZFJlY29yZHNDb250ZW50Lm9yZGVyQnlGaWVsZHMpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYVswXS5vcmRlcikgfHwgXCJhc2NcIlxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgIF07XG4gICAgICAgICAgICAgIHRoaXMucmVSZW5kZXIgPSAhdGhpcy5yZVJlbmRlcjtcbiAgICAgICAgICAgIH0gfSwgcmVsYXRpb25zaGlwLm5hbWUgfHwgdGhpcy5zdHJpbmdzLnJlbGF0aW9uc2hpcCkpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSkpKSkpO1xuICAgIGNvbnN0IHNvcnRCeSA9IChoKFwiY2FsY2l0ZS1sYWJlbFwiLCBudWxsLCB0aGlzLnN0cmluZ3Muc29ydEJ5LCBoKFwiY2FsY2l0ZS1idXR0b25cIiwgeyBhcHBlYXJhbmNlOiBcIm91dGxpbmUtZmlsbFwiLCBraW5kOiBcIm5ldXRyYWxcIiwgaWNvbkVuZDogXCJjaGV2cm9uRG93blwiLCBhbGlnbm1lbnQ6IFwiaWNvbi1lbmQtc3BhY2UtYmV0d2VlblwiLCB3aWR0aDogXCJmdWxsXCIsIHNjYWxlOiBcIm1cIiwgZGlzYWJsZWQ6ICF0aGlzLmhhc1JlbGF0aW9uc2hpcExheWVyLCBvbkNsaWNrOiBhc3luYyAoKSA9PiB7XG4gICAgICAgIC8vIGZpbmQgdGhlIGxheWVyL3RhYmxlLCBhbmQgZGlzcGxheSB0aGUgcGljayBsaXN0IGJhc2VkIG9uIHRoZSByZWxhdGVkIGxheWVyL3RhYmxlXG4gICAgICAgIHRoaXMubGF5ZXIucmVsYXRpb25zaGlwcy5tYXAoYXN5bmMgKHJlbGF0aW9uc2hpcCkgPT4ge1xuICAgICAgICAgIGZvciAoY29uc3QgY3VyckxheWVyT3JUYWJsZSBvZiBbXG4gICAgICAgICAgICAuLi50aGlzLnZpZXcubWFwLmFsbExheWVycyxcbiAgICAgICAgICAgIC4uLnRoaXMudmlldy5tYXAuYWxsVGFibGVzXG4gICAgICAgICAgXSkge1xuICAgICAgICAgICAgY29uc3QgY3VyciA9IGN1cnJMYXllck9yVGFibGU7XG4gICAgICAgICAgICBpZiAodGhpcy5yZWxhdGVkUmVjb3Jkc0NvbnRlbnQucmVsYXRpb25zaGlwSWQgPT09IHJlbGF0aW9uc2hpcC5pZCAmJlxuICAgICAgICAgICAgICByZWxhdGlvbnNoaXBFeGlzdHNDaGVja1dpdGhvdXRMb2FkKHRoaXMubGF5ZXIsIGN1cnIsIHJlbGF0aW9uc2hpcCkpIHtcbiAgICAgICAgICAgICAgdGhpcy5vcGVuUGlja0xpc3QoY3Vycik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgIH0gfSwgKChfYyA9IChfYiA9IChfYSA9IHRoaXMucmVsYXRlZFJlY29yZHNDb250ZW50KSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2Eub3JkZXJCeUZpZWxkcykgPT09IG51bGwgfHwgX2IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9iWzBdKSA9PT0gbnVsbCB8fCBfYyA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2MuZmllbGQpIHx8IHRoaXMuc3RyaW5ncy5kZWZhdWx0KSkpO1xuICAgIGNvbnN0IHNvcnRPcmRlciA9IChoKFwiY2FsY2l0ZS1sYWJlbFwiLCBudWxsLCB0aGlzLnN0cmluZ3Muc29ydE9yZGVyLCBoKFwiY2FsY2l0ZS1kcm9wZG93blwiLCB7IGRpc2FibGVkOiAhdGhpcy5oYXNSZWxhdGlvbnNoaXBMYXllciwgb3ZlcmxheVBvc2l0aW9uaW5nOiBcImZpeGVkXCIgfSwgaChcImNhbGNpdGUtYnV0dG9uXCIsIHsgc2xvdDogXCJ0cmlnZ2VyXCIsIGFwcGVhcmFuY2U6IFwib3V0bGluZS1maWxsXCIsIGtpbmQ6IFwibmV1dHJhbFwiLCBpY29uRW5kOiBcImNoZXZyb25Eb3duXCIsIGFsaWdubWVudDogXCJpY29uLWVuZC1zcGFjZS1iZXR3ZWVuXCIsIHdpZHRoOiBcImZ1bGxcIiwgc2NhbGU6IFwibVwiIH0sICgoX2QgPSB0aGlzLnJlbGF0ZWRSZWNvcmRzQ29udGVudC5vcmRlckJ5RmllbGRzKSA9PT0gbnVsbCB8fCBfZCA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2RbMF0ub3JkZXIpID09PSBcImRlc2NcIlxuICAgICAgPyB0aGlzLnN0cmluZ3MuZGVzY2VuZGluZ1xuICAgICAgOiB0aGlzLnN0cmluZ3MuYXNjZW5kaW5nKSwgaChcImNhbGNpdGUtZHJvcGRvd24taXRlbVwiLCB7IHNlbGVjdGVkOiAoKF9lID0gdGhpcy5yZWxhdGVkUmVjb3Jkc0NvbnRlbnQub3JkZXJCeUZpZWxkcykgPT09IG51bGwgfHwgX2UgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9lWzBdLm9yZGVyKSA9PT0gXCJhc2NcIiwgb25DbGljazogKCkgPT4ge1xuICAgICAgICB0aGlzLnJlbGF0ZWRSZWNvcmRzQ29udGVudC5vcmRlckJ5RmllbGRzWzBdLm9yZGVyID0gXCJhc2NcIjtcbiAgICAgICAgdGhpcy5yZVJlbmRlciA9ICF0aGlzLnJlUmVuZGVyO1xuICAgICAgfSB9LCB0aGlzLnN0cmluZ3MuYXNjZW5kaW5nKSwgaChcImNhbGNpdGUtZHJvcGRvd24taXRlbVwiLCB7IHNlbGVjdGVkOiAoKF9mID0gdGhpcy5yZWxhdGVkUmVjb3Jkc0NvbnRlbnQub3JkZXJCeUZpZWxkcykgPT09IG51bGwgfHwgX2YgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9mWzBdLm9yZGVyKSA9PT0gXCJkZXNjXCIsIG9uQ2xpY2s6ICgpID0+IHtcbiAgICAgICAgdGhpcy5yZWxhdGVkUmVjb3Jkc0NvbnRlbnQub3JkZXJCeUZpZWxkc1swXS5vcmRlciA9IFwiZGVzY1wiO1xuICAgICAgICB0aGlzLnJlUmVuZGVyID0gIXRoaXMucmVSZW5kZXI7XG4gICAgICB9IH0sIHRoaXMuc3RyaW5ncy5kZXNjZW5kaW5nKSkpKTtcbiAgICBjb25zdCBwcmV2aWV3Q291bnQgPSAoaChcImNhbGNpdGUtbGFiZWxcIiwgbnVsbCwgdGhpcy5zdHJpbmdzLnByZXZpZXdDb3VudCwgaChcImNhbGNpdGUtZHJvcGRvd25cIiwgeyBkaXNhYmxlZDogIXRoaXMuaGFzUmVsYXRpb25zaGlwTGF5ZXIsIG92ZXJsYXlQb3NpdGlvbmluZzogXCJmaXhlZFwiIH0sIGgoXCJjYWxjaXRlLWJ1dHRvblwiLCB7IHNsb3Q6IFwidHJpZ2dlclwiLCBhcHBlYXJhbmNlOiBcIm91dGxpbmUtZmlsbFwiLCBraW5kOiBcIm5ldXRyYWxcIiwgaWNvbkVuZDogXCJjaGV2cm9uRG93blwiLCBhbGlnbm1lbnQ6IFwiaWNvbi1lbmQtc3BhY2UtYmV0d2VlblwiLCB3aWR0aDogXCJmdWxsXCIsIHNjYWxlOiBcIm1cIiB9LCAoX2cgPSAodGhpcy5yZWxhdGVkUmVjb3Jkc0NvbnRlbnQuZGlzcGxheUNvdW50ID09PSAwXG4gICAgICA/IHRoaXMuc3RyaW5ncy5ub25lXG4gICAgICA6IHRoaXMucmVsYXRlZFJlY29yZHNDb250ZW50LmRpc3BsYXlDb3VudCkpICE9PSBudWxsICYmIF9nICE9PSB2b2lkIDAgPyBfZyA6IDEpLCBoKFwiY2FsY2l0ZS1kcm9wZG93bi1ncm91cFwiLCBudWxsLCBbLi4uQXJyYXkodGhpcy5tYXhQcmV2aWV3Q291bnQpLmtleXMoKV0ubWFwKCh4KSA9PiB7XG4gICAgICByZXR1cm4gKGgoXCJjYWxjaXRlLWRyb3Bkb3duLWl0ZW1cIiwgeyBzZWxlY3RlZDogdGhpcy5yZWxhdGVkUmVjb3Jkc0NvbnRlbnQuZGlzcGxheUNvdW50ID09PSB4LCBvbkNsaWNrOiAoKSA9PiB7XG4gICAgICAgICAgdGhpcy5yZWxhdGVkUmVjb3Jkc0NvbnRlbnQuZGlzcGxheUNvdW50ID0geDtcbiAgICAgICAgICB0aGlzLnJlUmVuZGVyID0gIXRoaXMucmVSZW5kZXI7XG4gICAgICAgIH0gfSwgeCA9PT0gMCA/IHRoaXMuc3RyaW5ncy5ub25lIDogeCkpO1xuICAgIH0pKSkpKTtcbiAgICByZXR1cm4gKGgoSG9zdCwgbnVsbCwgaChcImNhbGNpdGUtYmxvY2tcIiwgeyBkaXI6IGdldEVsZW1lbnREaXIodGhpcy5ob3N0RWxlbWVudCksIGhlYWRpbmc6IHRoaXMuc3RyaW5ncy5yZWxhdGVkUmVjb3JkcywgZGVzY3JpcHRpb246ICh0aGlzLnJlbGF0ZWRSZWNvcmRzQ29udGVudC50aXRsZSAmJlxuICAgICAgICBgJHt0aGlzLnJlbGF0ZWRSZWNvcmRzQ29udGVudC50aXRsZS5zdWJzdHJpbmcoMCwgMjUpfSR7dGhpcy5yZWxhdGVkUmVjb3Jkc0NvbnRlbnQudGl0bGUubGVuZ3RoID4gMjUgPyBcIi4uLlwiIDogXCJcIn1gKSB8fFxuICAgICAgICAoKCkgPT4ge1xuICAgICAgICAgIGZvciAoY29uc3QgcmVsYXRpb25zaGlwIG9mIHRoaXMubGF5ZXIucmVsYXRpb25zaGlwcykge1xuICAgICAgICAgICAgaWYgKHJlbGF0aW9uc2hpcC5pZCA9PT0gdGhpcy5yZWxhdGVkUmVjb3Jkc0NvbnRlbnQucmVsYXRpb25zaGlwSWQpIHtcbiAgICAgICAgICAgICAgcmV0dXJuIHJlbGF0aW9uc2hpcC5uYW1lO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgICByZXR1cm4gdGhpcy5zdHJpbmdzLnNlbGVjdFRhYmxlO1xuICAgICAgICB9KSgpLCBjb2xsYXBzaWJsZTogdHJ1ZSwgb3BlbjogdGhpcy5ibG9ja09wZW4sIGRyYWdIYW5kbGU6IHRydWUsIG9uQ2FsY2l0ZUJsb2NrVG9nZ2xlOiAoKSA9PiB0aGlzLmNsb3NlUG9wdXBQb3BvdmVycy5lbWl0KCkgfSwgaChcImRpdlwiLCB7IGNsYXNzOiBcImlnbm9yZS1lbGVtZW50cy1zb3J0YWJsZVwiLCBzbG90OiBcImNvbnRyb2xcIiB9LCBoKFwiYXJjZ2lzLWNhbGNpdGUtYmxvY2stb3B0aW9uc1wiLCB7IHJlZjogKGVsKSA9PiAodGhpcy5ibG9ja09wdGlvbnMgPSBlbCksIGd1aWQ6IHRoaXMuZ3VpZCwgaW50bE9wdGlvbnM6IHRoaXMuc3RyaW5ncy5vcHRpb25zLCBpbnRsRGVsZXRlOiB0aGlzLnN0cmluZ3MuZGVsZXRlLCBpbnRsRHVwbGljYXRlOiB0aGlzLnN0cmluZ3MuZHVwbGljYXRlLCBjYWxjaXRlQmxvY2tPcHRpb25zOiB7IGhhc0RlbGV0ZTogdHJ1ZSwgaGFzRHVwbGljYXRlOiB0aGlzLmhhc1JlbGF0aW9uc2hpcExheWVyIH0gfSkpLCBoKFwiZGl2XCIsIHsgc2xvdDogXCJpY29uXCIgfSwgaChcImNhbGNpdGUtaWNvblwiLCB7IHNjYWxlOiBcIm1cIiwgaWNvbjogdGhpcy5oYXNSZWxhdGlvbnNoaXBMYXllciA/IFwibGlua1wiIDogXCJleGNsYW1hdGlvbi1tYXJrLXRyaWFuZ2xlXCIgfSkpLCBoKFwiZGl2XCIsIHsgY2xhc3M6IFwiaWdub3JlLWVsZW1lbnRzLXNvcnRhYmxlXCIgfSwgdGhpcy5mb3JtSW5wdXQoXCJ0aXRsZVwiLCB0aGlzLnN0cmluZ3MudGl0bGUsIChlbGVtZW50KSA9PiB7XG4gICAgICByZXR1cm4gKHRoaXMuY29udGVudFRpdGxlID0gZWxlbWVudCk7XG4gICAgfSwgdGhpcy5yZWxhdGVkUmVjb3Jkc0NvbnRlbnQudGl0bGUsIHRoaXMuc3RyaW5ncy5lbnRlclRpdGxlKSwgdGhpcy5mb3JtSW5wdXQoXCJkZXNjcmlwdGlvblwiLCB0aGlzLnN0cmluZ3MuZGVzYywgKGVsZW1lbnQpID0+IHtcbiAgICAgIHJldHVybiAodGhpcy5jb250ZW50RGVzY3JpcHRpb24gPSBlbGVtZW50KTtcbiAgICB9LCB0aGlzLnJlbGF0ZWRSZWNvcmRzQ29udGVudC5kZXNjcmlwdGlvbiwgdGhpcy5zdHJpbmdzLmVudGVyRGVzY3JpcHRpb24pLCByZWxhdGlvbnNoaXAsIHNvcnRCeSwgc29ydE9yZGVyLCBwcmV2aWV3Q291bnQpKSkpO1xuICB9XG4gIGdldCBob3N0RWxlbWVudCgpIHsgcmV0dXJuIGdldEVsZW1lbnQodGhpcyk7IH1cbn07XG5BcmNnaXNQb3B1cFJlbGF0aW9uc2hpcC5zdHlsZSA9IGFyY2dpc1BvcHVwUmVsYXRpb25zaGlwQ3NzO1xuXG5jb25zdCBBcmNnaXNQb3B1cFJpY2h0ZXh0ID0gY2xhc3Mge1xuICBjb25zdHJ1Y3Rvcihob3N0UmVmKSB7XG4gICAgcmVnaXN0ZXJJbnN0YW5jZSh0aGlzLCBob3N0UmVmKTtcbiAgICB0aGlzLmNsb3NlUG9wdXBQb3BvdmVycyA9IGNyZWF0ZUV2ZW50KHRoaXMsIFwiY2xvc2VQb3B1cFBvcG92ZXJzXCIsIDcpO1xuICAgIHRoaXMuaW50ZXJuYWxQb3B1cFVwZGF0ZWQgPSBjcmVhdGVFdmVudCh0aGlzLCBcImludGVybmFsUG9wdXBVcGRhdGVkXCIsIDcpO1xuICAgIHRoaXMucmljaFRleHRDaGFuZ2VkUmVSZW5kZXIgPSBjcmVhdGVFdmVudCh0aGlzLCBcInJpY2hUZXh0Q2hhbmdlZFJlUmVuZGVyXCIsIDcpO1xuICAgIHRoaXMuZGlzYWJsZVBvcHVwUGFuZWwgPSBjcmVhdGVFdmVudCh0aGlzLCBcImRpc2FibGVQb3B1cFBhbmVsXCIsIDcpO1xuICAgIHRoaXMuYXJjYWRlRXhwTWFwID0gbmV3IE1hcCgpO1xuICAgIHRoaXMuZ3VpZCA9IHVuZGVmaW5lZDtcbiAgICB0aGlzLmZpZWxkRXhwcmVzc2lvbkRhdGEgPSB1bmRlZmluZWQ7XG4gICAgdGhpcy5hcmNnaXNDb2xvclBpY2tlckRhdGEgPSB1bmRlZmluZWQ7XG4gICAgdGhpcy5yaWNodGV4dENvbnRlbnQgPSB1bmRlZmluZWQ7XG4gICAgdGhpcy5ibG9ja09wZW4gPSBmYWxzZTtcbiAgICB0aGlzLnBvcHVwRmxvd0l0ZW0gPSB1bmRlZmluZWQ7XG4gICAgdGhpcy5yZVJlbmRlciA9IHVuZGVmaW5lZDtcbiAgfVxuICAvLyBsaWZlY3ljbGUgbWV0aG9kc1xuICBjb21wb25lbnRXaWxsTG9hZCgpIHtcbiAgICB0aGlzLnN0cmluZ3MgPSBwb3B1cFN0YXRlLnN0cmluZ3M7XG4gICAgdGhpcy5jdXJyZW50TGFuZ3VhZ2UgPSBwb3B1cFN0YXRlLmN1cnJlbnRMYW5ndWFnZTtcbiAgICB0aGlzLnBvcHVwVGVtcGxhdGUgPSBwb3B1cFN0YXRlLnBvcHVwVGVtcGxhdGU7XG4gIH1cbiAgY29tcG9uZW50RGlkTG9hZCgpIHtcbiAgICB0aGlzLmNrRWRpdG9yTWVudGlvbkZpZWxkc1NldHVwKCk7XG4gICAgaWYgKHRoaXMuYmxvY2tPcGVuKSB7XG4gICAgICBjb25zdCBjb250ZW50ID0gdGhpcy5ob3N0RWxlbWVudC5zaGFkb3dSb290LmdldEVsZW1lbnRCeUlkKFwiY29udGVudF9JZFwiKTtcbiAgICAgIGNvbnRlbnQuc2Nyb2xsSW50b1ZpZXcoe1xuICAgICAgICBiZWhhdmlvcjogXCJhdXRvXCIsXG4gICAgICAgIGJsb2NrOiBcIm5lYXJlc3RcIixcbiAgICAgICAgaW5saW5lOiBcInN0YXJ0XCJcbiAgICAgIH0pO1xuICAgICAgdGhpcy5zaG93UmljaFRleHRFZGl0b3IoKTtcbiAgICB9XG4gIH1cbiAgY29tcG9uZW50RGlkVXBkYXRlKCkge1xuICAgIHRoaXMuaW50ZXJuYWxQb3B1cFVwZGF0ZWQuZW1pdCgpO1xuICB9XG4gIGRpc2Nvbm5lY3RlZENhbGxiYWNrKCkge1xuICAgIGlmICh0aGlzLmFyY2dpc0NrZWRpdG9yNSkge1xuICAgICAgZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZCh0aGlzLmFyY2dpc0NrZWRpdG9yNSk7XG4gICAgfVxuICB9XG4gIC8vIEV2ZW50c1xuICByaWNoVGV4dENoYW5nZWRSZVJlbmRlckhhbmRsZXIoZXZlbnQpIHtcbiAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICB0aGlzLnJlUmVuZGVyID0gdGhpcy5yZVJlbmRlciA/IGZhbHNlIDogdHJ1ZTtcbiAgfVxuICBjbG9zZUFsbFBvcG92ZXJzSGFuZGxlcigpIHtcbiAgICBpZiAodGhpcy5hcmNnaXNDa2VkaXRvcjUpIHtcbiAgICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQodGhpcy5hcmNnaXNDa2VkaXRvcjUpO1xuICAgICAgdGhpcy5hcmNnaXNDa2VkaXRvcjUgPSBudWxsO1xuICAgICAgdGhpcy5kaXNhYmxlUG9wdXBQYW5lbC5lbWl0KGZhbHNlKTtcbiAgICB9XG4gIH1cbiAgY2tFZGl0b3JQb3BvdmVyQ2xvc2VkSGFuZGxlcihldmVudCkge1xuICAgIHZhciBfYSwgX2IsIF9jLCBfZCwgX2U7XG4gICAgaWYgKCgoX2EgPSBldmVudC5kZXRhaWwpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5ndWlkKSA9PT0gdGhpcy5ndWlkKSB7XG4gICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgIGlmICgoKF9jID0gKF9iID0gZXZlbnQuZGV0YWlsKSA9PT0gbnVsbCB8fCBfYiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2IuZGF0YSkgPT09IG51bGwgfHwgX2MgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9jLmxlbmd0aCkgfHwgKChfZSA9IChfZCA9IGV2ZW50LmRldGFpbCkgPT09IG51bGwgfHwgX2QgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9kLmRhdGEpID09PSBudWxsIHx8IF9lID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfZS5sZW5ndGgpID09PSAwKSB7XG4gICAgICAgIHRoaXMucmljaHRleHRDb250ZW50LnRleHQgPSBldmVudC5kZXRhaWwuZGF0YTtcbiAgICAgICAgdGhpcy5yZVJlbmRlciA9ICF0aGlzLnJlUmVuZGVyO1xuICAgICAgICB0aGlzLnJpY2hUZXh0Q2hhbmdlZFJlUmVuZGVyLmVtaXQoKTtcbiAgICAgIH0gLy8gZWxzZSBudWxsXG4gICAgICB0aGlzLmNsb3NlUG9wdXBQb3BvdmVycy5lbWl0KCk7XG4gICAgfVxuICB9XG4gIGNhbGNpdGVCbG9ja1RvZ2dsZUhhbmRsZXIoKSB7XG4gICAgdGhpcy5jbG9zZVBvcHVwUG9wb3ZlcnMuZW1pdCgpO1xuICB9XG4gIC8vIGZvciBhcmNhZGUgY2hhbmdlc1xuICBhcmNhZGVDaGFuZ2VOb3RpZmljYXRpb25IYW5kbGVyKCkge1xuICAgIHRoaXMuY2tFZGl0b3JNZW50aW9uRmllbGRzU2V0dXAoKTtcbiAgfVxuICAvLyBwcml2YXRlIG1ldGhvZHMgYW5kIHByb3BlcnRpZXNcbiAgY2tFZGl0b3JNZW50aW9uRmllbGRzU2V0dXAoKSB7XG4gICAgdmFyIF9hO1xuICAgIHRoaXMuYXJjYWRlRXhwTWFwID0gZ2VuZXJhdGVBcmNhZGVFeHByZXNzaW9uTWFwKHRoaXMucG9wdXBUZW1wbGF0ZSk7XG4gICAgdGhpcy5ja0VkaXRvck1lbnRpb25GaWVsZHMgPSBbXTtcbiAgICAoX2EgPSB0aGlzLnBvcHVwVGVtcGxhdGUuZmllbGRJbmZvcykgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmZvckVhY2goKGZpZWxkKSA9PiB7XG4gICAgICBpZiAoZmllbGQuZmllbGROYW1lKSB7XG4gICAgICAgIHRoaXMuY2tFZGl0b3JNZW50aW9uRmllbGRzLnB1c2goe1xuICAgICAgICAgIGlkOiBcIntcIiArIGZpZWxkLmZpZWxkTmFtZSArIFwifVwiLFxuICAgICAgICAgIG5hbWU6IGdldEZpZWxkRGlzcGxheU5hbWUoZmllbGQsIHRoaXMuYXJjYWRlRXhwTWFwKVxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuICBnZXRUZXh0RnJvbUh0bWwodG90YWxDaGFycykge1xuICAgIHZhciBfYTtcbiAgICBjb25zdCB0ZW1wSHRtbCA9IChfYSA9IHRoaXMucmljaHRleHRDb250ZW50LnRleHQpICE9PSBudWxsICYmIF9hICE9PSB2b2lkIDAgPyBfYSA6IFwiXCI7XG4gICAgY29uc3QgdGVtcERpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIik7XG4gICAgdGVtcERpdi5pbm5lckhUTUwgPSB0ZW1wSHRtbDtcbiAgICBjb25zdCB0ZW1wU3RyaW5nID0gdGVtcERpdi50ZXh0Q29udGVudCB8fCB0ZW1wRGl2LmlubmVyVGV4dCB8fCBcIlwiO1xuICAgIHJldHVybiBgJHt0ZW1wU3RyaW5nLnN1YnN0cmluZygwLCB0b3RhbENoYXJzKX0ke3RlbXBTdHJpbmcubGVuZ3RoID4gdG90YWxDaGFycyA/IFwiLi4uXCIgOiBcIlwifWA7XG4gIH1cbiAgc2hvd1JpY2hUZXh0RWRpdG9yKCkge1xuICAgIHZhciBfYSwgX2I7XG4gICAgdGhpcy5jbG9zZVBvcHVwUG9wb3ZlcnMuZW1pdCgpO1xuICAgIHRoaXMuYXJjZ2lzQ2tlZGl0b3I1ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImFyY2dpcy1ja2VkaXRvcjVcIik7XG4gICAgdGhpcy5hcmNnaXNDa2VkaXRvcjUuZmllbGRFeHByZXNzaW9uQ29uZmlnID0gdGhpcy5maWVsZEV4cHJlc3Npb25EYXRhO1xuICAgIHRoaXMuYXJjZ2lzQ2tlZGl0b3I1LmFyY2dpc0NvbG9yUGlja2VyQ29uZmlnID0gT2JqZWN0LmFzc2lnbihPYmplY3QuYXNzaWduKHt9LCB0aGlzLmFyY2dpc0NvbG9yUGlja2VyRGF0YSksIHsgZW5hYmxlRmllbGRzOiB0aGlzLmFyY2dpc0NvbG9yUGlja2VyRGF0YS5kYXRhICYmIHRoaXMuYXJjZ2lzQ29sb3JQaWNrZXJEYXRhLmRhdGEubGVuZ3RoID8gdHJ1ZSA6IGZhbHNlIH0pO1xuICAgIHRoaXMuYXJjZ2lzQ2tlZGl0b3I1Lmd1aWQgPSB0aGlzLmd1aWQ7XG4gICAgdGhpcy5hcmNnaXNDa2VkaXRvcjUucmVmRWxlbWVudCA9IHRoaXMucG9wdXBGbG93SXRlbTtcbiAgICB0aGlzLmFyY2dpc0NrZWRpdG9yNS50ZXh0RGF0YSA9IChfYSA9IHRoaXMucmljaHRleHRDb250ZW50LnRleHQpICE9PSBudWxsICYmIF9hICE9PSB2b2lkIDAgPyBfYSA6IFwiXCI7XG4gICAgdGhpcy5hcmNnaXNDa2VkaXRvcjUuY2tFZGl0b3JNZW50aW9uRmllbGRzID0gdGhpcy5ja0VkaXRvck1lbnRpb25GaWVsZHM7XG4gICAgdGhpcy5hcmNnaXNDa2VkaXRvcjUuaW50bFRleHRQbGFjZUhvbGRlciA9XG4gICAgICAoKF9iID0gdGhpcy5wb3B1cFRlbXBsYXRlLmZpZWxkSW5mb3MpID09PSBudWxsIHx8IF9iID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYi5sZW5ndGgpID4gMFxuICAgICAgICA/IHRoaXMuc3RyaW5ncy50ZXh0UGxhY2VIb2xkZXJcbiAgICAgICAgOiB0aGlzLnN0cmluZ3MudGV4dFBsYWNlSG9sZGVyTGFiZWw7XG4gICAgdGhpcy5hcmNnaXNDa2VkaXRvcjUuaW50bE9rID0gdGhpcy5zdHJpbmdzLm9rO1xuICAgIHRoaXMuYXJjZ2lzQ2tlZGl0b3I1LmludGxDYW5jZWwgPSB0aGlzLnN0cmluZ3MuY2FuY2VsO1xuICAgIHRoaXMuYXJjZ2lzQ2tlZGl0b3I1LmN1cnJlbnRMYW5ndWFnZSA9IHRoaXMuY3VycmVudExhbmd1YWdlO1xuICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQodGhpcy5hcmNnaXNDa2VkaXRvcjUpO1xuICAgIHRoaXMuYXJjZ2lzQ2tlZGl0b3I1LnNldEZvY3VzKCk7XG4gICAgdGhpcy5kaXNhYmxlUG9wdXBQYW5lbC5lbWl0KHRydWUpO1xuICB9XG4gIC8vIHJlbmRvciBtZXRob2RzXG4gIHJlbmRlcigpIHtcbiAgICByZXR1cm4gKGgoSG9zdCwgbnVsbCwgaChcImNhbGNpdGUtYmxvY2tcIiwgeyBkaXI6IGdldEVsZW1lbnREaXIodGhpcy5ob3N0RWxlbWVudCksIGlkOiBcInJpY2hUZXh0X0lkXCIsIGhlYWRpbmc6IHRoaXMuc3RyaW5ncy50ZXh0LCBkZXNjcmlwdGlvbjogdGhpcy5nZXRUZXh0RnJvbUh0bWwoMjUpLCBvcGVuOiB0aGlzLmJsb2NrT3BlbiwgY29sbGFwc2libGU6IHRydWUsIGRyYWdIYW5kbGU6IHRydWUgfSwgaChcImRpdlwiLCB7IGNsYXNzOiBcImlnbm9yZS1lbGVtZW50cy1zb3J0YWJsZVwiLCBzbG90OiBcImNvbnRyb2xcIiB9LCBoKFwiYXJjZ2lzLWNhbGNpdGUtYmxvY2stb3B0aW9uc1wiLCB7IGd1aWQ6IHRoaXMuZ3VpZCwgaW50bE9wdGlvbnM6IHRoaXMuc3RyaW5ncy5vcHRpb25zLCBpbnRsRGVsZXRlOiB0aGlzLnN0cmluZ3MuZGVsZXRlLCBpbnRsRHVwbGljYXRlOiB0aGlzLnN0cmluZ3MuZHVwbGljYXRlLCBjYWxjaXRlQmxvY2tPcHRpb25zOiB7IGhhc0RlbGV0ZTogdHJ1ZSwgaGFzRHVwbGljYXRlOiB0cnVlIH0gfSkpLCBoKFwiZGl2XCIsIHsgc2xvdDogXCJpY29uXCIgfSwgaChcImNhbGNpdGUtaWNvblwiLCB7IHNjYWxlOiBcIm1cIiwgaWNvbjogXCJ0ZXh0XCIgfSkpLCBoKFwiZGl2XCIsIHsgY2xhc3M6IFwiaWdub3JlLWVsZW1lbnRzLXNvcnRhYmxlXCIsIGlkOiBcImNvbnRlbnRfSWRcIiB9LCBoKFwiY2FsY2l0ZS1idXR0b25cIiwgeyBhcHBlYXJhbmNlOiBcInRyYW5zcGFyZW50XCIsIHdpZHRoOiBcImZ1bGxcIiwgb25DbGljazogKCkgPT4gdGhpcy5zaG93UmljaFRleHRFZGl0b3IoKSB9LCB0aGlzLnN0cmluZ3MuZWRpdFRleHQpKSkpKTtcbiAgfVxuICBnZXQgaG9zdEVsZW1lbnQoKSB7IHJldHVybiBnZXRFbGVtZW50KHRoaXMpOyB9XG59O1xuXG5jb25zdCBDU1MgPSB7XG4gIGZvcm1JbnB1dEJ1dHRvbjogXCJmb3JtLWlucHV0LWJ1dHRvblwiXG59O1xuXG5jb25zdCBhcmNnaXNQb3B1cFRpdGxlQ3NzID0gXCIuZm9ybS1pbnB1dC1idXR0b257ZGlzcGxheTpmbGV4fS5mb3JtLWlucHV0LWJ1dHRvbiBjYWxjaXRlLWlucHV0W3R5cGU9dGV4dF17ZGlzcGxheTpmbGV4O2ZsZXgtZmxvdzpjb2x1bW4gbm93cmFwO2ZsZXg6MSAwIDAlO292ZXJmbG93OmhpZGRlbn0uZm9ybS1pbnB1dC1idXR0b24gY2FsY2l0ZS1hY3Rpb257bWFyZ2luOjA7ZmxleDowIDAgMCU7anVzdGlmeS1zZWxmOmZsZXgtZW5kfVwiO1xuXG5jb25zdCBBcmNnaXNQb3B1cFRpdGxlID0gY2xhc3Mge1xuICBjb25zdHJ1Y3Rvcihob3N0UmVmKSB7XG4gICAgcmVnaXN0ZXJJbnN0YW5jZSh0aGlzLCBob3N0UmVmKTtcbiAgICB0aGlzLmNsb3NlUG9wdXBQb3BvdmVycyA9IGNyZWF0ZUV2ZW50KHRoaXMsIFwiY2xvc2VQb3B1cFBvcG92ZXJzXCIsIDcpO1xuICAgIHRoaXMudGl0bGVDaGFuZ2VkUmVSZW5kZXIgPSBjcmVhdGVFdmVudCh0aGlzLCBcInRpdGxlQ2hhbmdlZFJlUmVuZGVyXCIsIDcpO1xuICAgIHRoaXMuaW50ZXJuYWxQb3B1cFVwZGF0ZWQgPSBjcmVhdGVFdmVudCh0aGlzLCBcImludGVybmFsUG9wdXBVcGRhdGVkXCIsIDcpO1xuICAgIHRoaXMuZGlzYWJsZVBvcHVwUGFuZWwgPSBjcmVhdGVFdmVudCh0aGlzLCBcImRpc2FibGVQb3B1cFBhbmVsXCIsIDcpO1xuICAgIC8vIHByaXZhdGUgbWV0aG9kcyBhbmQgcHJvcGVydGllc1xuICAgIHRoaXMuY2hhbmdlVGl0bGUgPSAoKSA9PiB7XG4gICAgICB0aGlzLnBvcHVwVGVtcGxhdGUudGl0bGUgPSB0aGlzLnRpdGxlSW5wdXQudmFsdWU7XG4gICAgICB0aGlzLmludGVybmFsUG9wdXBVcGRhdGVkLmVtaXQoKTtcbiAgICAgIHRoaXMudGl0bGVDaGFuZ2VkUmVSZW5kZXIuZW1pdCgpO1xuICAgIH07XG4gICAgLy8gb3BlbiBwb3BvdmVyXG4gICAgdGhpcy5vcGVuQXR0cmlidXRlc0xpc3QgPSAoZXZlbnQpID0+IHtcbiAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgLy8gY2xvc2UgZmlyc3Qgc2luY2Ugd2UgY2FuIGhhdmUgbXVsdGlwbGUgYXR0cmlidXRlcyBvcGVuXG4gICAgICB0aGlzLmNsb3NlUG9wdXBQb3BvdmVycy5lbWl0KCk7XG4gICAgICAvLyBsYXp5IGxvYWQgYXR0cmlidXRlIHNlbGVjdGlvbiBjb21wb25lbnRcbiAgICAgIGlmICghdGhpcy5wb3B1cEZpZWxkU2VsZWN0aW9uUGlja0xpc3QpIHtcbiAgICAgICAgdGhpcy5wb3B1cEZpZWxkU2VsZWN0aW9uUGlja0xpc3QgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiYXJjZ2lzLXBvcHVwLWZpZWxkLXBpY2stbGlzdFwiKTtcbiAgICAgICAgdGhpcy5wb3B1cEZpZWxkU2VsZWN0aW9uUGlja0xpc3QucG9wb3ZlclByb3BzID0ge1xuICAgICAgICAgIHJlZkVsZW1lbnQ6IHRoaXMucG9wdXBGbG93SXRlbVxuICAgICAgICB9O1xuICAgICAgICB0aGlzLnBvcHVwRmllbGRTZWxlY3Rpb25QaWNrTGlzdC5tdWx0aXBsZSA9IGZhbHNlO1xuICAgICAgICB0aGlzLnBvcHVwRmllbGRTZWxlY3Rpb25QaWNrTGlzdC5oZWFkaW5nID0gdGhpcy5zdHJpbmdzLmFkZEZpZWxkO1xuICAgICAgICB0aGlzLnBvcHVwRmllbGRTZWxlY3Rpb25QaWNrTGlzdC5hZGRFdmVudExpc3RlbmVyKFwiYXJjZ2lzUG9wdXBQaWNrTGlzdERpc21pc3NlZFwiLCAoKSA9PiB7XG4gICAgICAgICAgdGhpcy5jbG9zZVBvcHVwUG9wb3ZlcnMuZW1pdCgpO1xuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5wb3B1cEZpZWxkU2VsZWN0aW9uUGlja0xpc3QuYWRkRXZlbnRMaXN0ZW5lcihcImFyY2dpc1BvcHVwUGlja0xpc3RDaGFuZ2VcIiwgdGhpcy5wb3B1cEZpZWxkU2VsZWN0aW9uUGlja0xpc3RDaGFuZ2VzKTtcbiAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZCh0aGlzLnBvcHVwRmllbGRTZWxlY3Rpb25QaWNrTGlzdCk7XG4gICAgICAgIHRoaXMuZGlzYWJsZVBvcHVwUGFuZWwuZW1pdCh0cnVlKTtcbiAgICAgIH1cbiAgICB9O1xuICAgIHRoaXMucG9wdXBGaWVsZFNlbGVjdGlvblBpY2tMaXN0Q2hhbmdlcyA9IChldmVudCkgPT4ge1xuICAgICAgY29uc3Qgc2VsZWN0ZWRGaWVsZE5hbWUgPSBldmVudC5kZXRhaWwuc2VsZWN0ZWRGaWVsZHNbMF07XG4gICAgICB0aGlzLnRpdGxlSW5wdXQudmFsdWUgPSBhZGRTZWxlY3RlZEZpZWxkQXRDdXJzb3IodGhpcy50aXRsZUlucHV0LCBzZWxlY3RlZEZpZWxkTmFtZSk7XG4gICAgICB0aGlzLnRpdGxlSW5wdXQuc2V0Rm9jdXMoKTtcbiAgICAgIHRoaXMucG9wdXBUZW1wbGF0ZS50aXRsZSA9IHRoaXMudGl0bGVJbnB1dC52YWx1ZTtcbiAgICAgIHRoaXMuY2hhbmdlVGl0bGUoKTtcbiAgICAgIHRoaXMuY2xvc2VQb3B1cFBvcG92ZXJzLmVtaXQoKTtcbiAgICB9O1xuICAgIHRoaXMucG9wdXBGbG93SXRlbSA9IHVuZGVmaW5lZDtcbiAgICB0aGlzLnJlUmVuZGVyID0gdW5kZWZpbmVkO1xuICB9XG4gIC8vIGxpZmVjeWNsZSBtZXRob2RzXG4gIGNvbXBvbmVudFdpbGxMb2FkKCkge1xuICAgIHRoaXMuc3RyaW5ncyA9IHBvcHVwU3RhdGUuc3RyaW5ncztcbiAgICB0aGlzLnBvcHVwVGVtcGxhdGUgPSBwb3B1cFN0YXRlLnBvcHVwVGVtcGxhdGU7XG4gIH1cbiAgY29tcG9uZW50RGlkTG9hZCgpIHtcbiAgICB0aGlzLmd1aWRGb3JTZWxlY3Rpb24gPSBndWlkKCk7XG4gIH1cbiAgLy8gRXZlbnRzXG4gIHRpdGxlQ2hhbmdlZFJlUmVuZGVySGFuZGxlcihldmVudCkge1xuICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgIHRoaXMucmVSZW5kZXIgPSB0aGlzLnJlUmVuZGVyID8gZmFsc2UgOiB0cnVlO1xuICB9XG4gIGNsb3NlUG9wdXBQb3BvdmVyc0hhbmRsZXIoKSB7XG4gICAgaWYgKHRoaXMucG9wdXBGaWVsZFNlbGVjdGlvblBpY2tMaXN0KSB7XG4gICAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKHRoaXMucG9wdXBGaWVsZFNlbGVjdGlvblBpY2tMaXN0KTtcbiAgICAgIHRoaXMucG9wdXBGaWVsZFNlbGVjdGlvblBpY2tMaXN0ID0gbnVsbDtcbiAgICAgIHRoaXMudGl0bGVJbnB1dC5zZXRGb2N1cygpO1xuICAgICAgdGhpcy5kaXNhYmxlUG9wdXBQYW5lbC5lbWl0KGZhbHNlKTtcbiAgICB9XG4gIH1cbiAgLy8gcmVuZG9yIG1ldGhvZHNcbiAgcmVuZGVyKCkge1xuICAgIHZhciBfYTtcbiAgICBjb25zdCBwb3B1cFRpdGxlID0gdGhpcy5wb3B1cFRlbXBsYXRlLnRpdGxlO1xuICAgIHJldHVybiAoaChIb3N0LCBudWxsLCBoKFwiY2FsY2l0ZS1ibG9ja1wiLCB7IGRpcjogZ2V0RWxlbWVudERpcih0aGlzLmhvc3RFbGVtZW50KSwgaGVhZGluZzogdGhpcy5zdHJpbmdzLnBvcHVwVGl0bGUsIGRlc2NyaXB0aW9uOiBwb3B1cFRpdGxlICYmIGAke3BvcHVwVGl0bGUuc3Vic3RyaW5nKDAsIDI1KX0ke3BvcHVwVGl0bGUubGVuZ3RoID4gMjUgPyBcIi4uLlwiIDogXCJcIn1gLCBjb2xsYXBzaWJsZTogdHJ1ZSB9LCBoKFwiZGl2XCIsIHsgc2xvdDogXCJpY29uXCIgfSwgaChcImNhbGNpdGUtaWNvblwiLCB7IHNjYWxlOiBcIm1cIiwgaWNvbjogXCJ0aXRsZVwiIH0pKSwgaChcImRpdlwiLCB7IGNsYXNzOiBDU1MuZm9ybUlucHV0QnV0dG9uIH0sIGgoXCJjYWxjaXRlLWlucHV0XCIsIHsgdHlwZTogXCJ0ZXh0XCIsIGF1dG9mb2N1czogdHJ1ZSwgcmVmOiAoZWxlbWVudCkgPT4ge1xuICAgICAgICB0aGlzLnRpdGxlSW5wdXQgPSBlbGVtZW50O1xuICAgICAgfSwgdmFsdWU6IHBvcHVwVGl0bGUsIG9uQ2FsY2l0ZUlucHV0SW5wdXQ6IChldmVudCkgPT4ge1xuICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgdGhpcy5jaGFuZ2VUaXRsZSgpO1xuICAgICAgfSwgb25DbGljazogKCkgPT4gdGhpcy5jbG9zZVBvcHVwUG9wb3ZlcnMuZW1pdCgpIH0pLCAoKF9hID0gdGhpcy5wb3B1cFRlbXBsYXRlLmZpZWxkSW5mb3MpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5sZW5ndGgpID4gMCAmJiAoaChcImNhbGNpdGUtYWN0aW9uXCIsIHsgc2NhbGU6IFwic1wiLCB0ZXh0OiB0aGlzLnN0cmluZ3MuYXR0cmlidXRlcywgb25DbGljazogdGhpcy5vcGVuQXR0cmlidXRlc0xpc3QsIGljb246IFwiYnJhY2tldHMtY3VybHlcIiB9KSkpKSkpO1xuICB9XG4gIGdldCBob3N0RWxlbWVudCgpIHsgcmV0dXJuIGdldEVsZW1lbnQodGhpcyk7IH1cbn07XG5BcmNnaXNQb3B1cFRpdGxlLnN0eWxlID0gYXJjZ2lzUG9wdXBUaXRsZUNzcztcblxuZXhwb3J0IHsgQXJjZ2lzUG9wdXAgYXMgYXJjZ2lzX3BvcHVwLCBBcmNnaXNQb3B1cEFyY2FkZSBhcyBhcmNnaXNfcG9wdXBfYXJjYWRlLCBBcmNnaXNQb3B1cEF0dGFjaG1lbnRzIGFzIGFyY2dpc19wb3B1cF9hdHRhY2htZW50cywgQXJjZ2lzUG9wdXBBdHRyaWJ1dGVzIGFzIGFyY2dpc19wb3B1cF9hdHRyaWJ1dGVzLCBBcmNnaXNQb3B1cENoYXJ0IGFzIGFyY2dpc19wb3B1cF9jaGFydCwgQXJjZ2lzUG9wdXBFeHByZXNzaW9ucyBhcyBhcmNnaXNfcG9wdXBfZXhwcmVzc2lvbnMsIEFyY2dpc1BvcHVwRmllbGRQaWNrTGlzdCBhcyBhcmNnaXNfcG9wdXBfZmllbGRfcGlja19saXN0LCBBcmNnaXNQb3B1cEltYWdlIGFzIGFyY2dpc19wb3B1cF9pbWFnZSwgQXJjZ2lzUG9wdXBNYWluQ29udGVudHBvcG92ZXIgYXMgYXJjZ2lzX3BvcHVwX21haW5fY29udGVudHBvcG92ZXIsIEFyY2dpc1BvcHVwTXVsdGltZWRpYSBhcyBhcmNnaXNfcG9wdXBfbXVsdGltZWRpYSwgQXJjZ2lzUG9wdXBSZWxhdGlvbnNoaXAgYXMgYXJjZ2lzX3BvcHVwX3JlbGF0aW9uc2hpcCwgQXJjZ2lzUG9wdXBSaWNodGV4dCBhcyBhcmNnaXNfcG9wdXBfcmljaHRleHQsIEFyY2dpc1BvcHVwVGl0bGUgYXMgYXJjZ2lzX3BvcHVwX3RpdGxlIH07XG4iLCIvKiFcbiAqIEFsbCBtYXRlcmlhbCBjb3B5cmlnaHQgRVNSSSwgQWxsIFJpZ2h0cyBSZXNlcnZlZCwgdW5sZXNzIG90aGVyd2lzZSBzcGVjaWZpZWQuXG4gKiB2My4wLjk5XG4gKi9cbmZ1bmN0aW9uIGdlbmVyYXRlSWQoY291bnRzKSB7XG4gIHJldHVybiBjb3VudHNcbiAgICAubWFwKChjb3VudCkgPT4ge1xuICAgIGxldCBvdXQgPSBcIlwiO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY291bnQ7IGkrKykge1xuICAgICAgb3V0ICs9ICgoKDEgKyBNYXRoLnJhbmRvbSgpKSAqIDB4MTAwMDApIHwgMCkudG9TdHJpbmcoMTYpLnN1YnN0cmluZygxKTtcbiAgICB9XG4gICAgcmV0dXJuIG91dDtcbiAgfSlcbiAgICAuam9pbihcIi1cIik7XG59XG5jb25zdCBndWlkID0gKCkgPT4gZ2VuZXJhdGVJZChbMiwgMSwgMSwgMSwgM10pO1xuXG5leHBvcnQgeyBndWlkIGFzIGcgfTtcbiIsIi8qIVxuICogQWxsIG1hdGVyaWFsIGNvcHlyaWdodCBFU1JJLCBBbGwgUmlnaHRzIFJlc2VydmVkLCB1bmxlc3Mgb3RoZXJ3aXNlIHNwZWNpZmllZC5cbiAqIHYzLjAuOTlcbiAqL1xuaW1wb3J0IHsgZyBhcyBnZXRSZW5kZXJpbmdSZWYsIGYgYXMgZm9yY2VVcGRhdGUgfSBmcm9tICcuL2luZGV4LTkyZWJiMzk2LmpzJztcblxuY29uc3QgYXBwZW5kVG9NYXAgPSAobWFwLCBwcm9wTmFtZSwgdmFsdWUpID0+IHtcbiAgICBjb25zdCBpdGVtcyA9IG1hcC5nZXQocHJvcE5hbWUpO1xuICAgIGlmICghaXRlbXMpIHtcbiAgICAgICAgbWFwLnNldChwcm9wTmFtZSwgW3ZhbHVlXSk7XG4gICAgfVxuICAgIGVsc2UgaWYgKCFpdGVtcy5pbmNsdWRlcyh2YWx1ZSkpIHtcbiAgICAgICAgaXRlbXMucHVzaCh2YWx1ZSk7XG4gICAgfVxufTtcbmNvbnN0IGRlYm91bmNlID0gKGZuLCBtcykgPT4ge1xuICAgIGxldCB0aW1lb3V0SWQ7XG4gICAgcmV0dXJuICguLi5hcmdzKSA9PiB7XG4gICAgICAgIGlmICh0aW1lb3V0SWQpIHtcbiAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0SWQpO1xuICAgICAgICB9XG4gICAgICAgIHRpbWVvdXRJZCA9IHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgdGltZW91dElkID0gMDtcbiAgICAgICAgICAgIGZuKC4uLmFyZ3MpO1xuICAgICAgICB9LCBtcyk7XG4gICAgfTtcbn07XG5cbi8qKlxuICogQ2hlY2sgaWYgYSBwb3NzaWJsZSBlbGVtZW50IGlzQ29ubmVjdGVkLlxuICogVGhlIHByb3BlcnR5IG1pZ2h0IG5vdCBiZSB0aGVyZSwgc28gd2UgY2hlY2sgZm9yIGl0LlxuICpcbiAqIFdlIHdhbnQgaXQgdG8gcmV0dXJuIHRydWUgaWYgaXNDb25uZWN0ZWQgaXMgbm90IGEgcHJvcGVydHksXG4gKiBvdGhlcndpc2Ugd2Ugd291bGQgcmVtb3ZlIHRoZXNlIGVsZW1lbnRzIGFuZCB3b3VsZCBub3QgdXBkYXRlLlxuICpcbiAqIEJldHRlciBsZWFrIGluIEVkZ2UgdGhhbiB0byBiZSB1c2VsZXNzLlxuICovXG5jb25zdCBpc0Nvbm5lY3RlZCA9IChtYXliZUVsZW1lbnQpID0+ICEoJ2lzQ29ubmVjdGVkJyBpbiBtYXliZUVsZW1lbnQpIHx8IG1heWJlRWxlbWVudC5pc0Nvbm5lY3RlZDtcbmNvbnN0IGNsZWFudXBFbGVtZW50cyA9IGRlYm91bmNlKChtYXApID0+IHtcbiAgICBmb3IgKGxldCBrZXkgb2YgbWFwLmtleXMoKSkge1xuICAgICAgICBtYXAuc2V0KGtleSwgbWFwLmdldChrZXkpLmZpbHRlcihpc0Nvbm5lY3RlZCkpO1xuICAgIH1cbn0sIDIwMDApO1xuY29uc3Qgc3RlbmNpbFN1YnNjcmlwdGlvbiA9ICgpID0+IHtcbiAgICBpZiAodHlwZW9mIGdldFJlbmRlcmluZ1JlZiAhPT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAvLyBJZiB3ZSBhcmUgbm90IGluIGEgc3RlbmNpbCBwcm9qZWN0LCB3ZSBkbyBub3RoaW5nLlxuICAgICAgICAvLyBUaGlzIGZ1bmN0aW9uIGlzIG5vdCByZWFsbHkgZXhwb3J0ZWQgYnkgQHN0ZW5jaWwvY29yZS5cbiAgICAgICAgcmV0dXJuIHt9O1xuICAgIH1cbiAgICBjb25zdCBlbG1zVG9VcGRhdGUgPSBuZXcgTWFwKCk7XG4gICAgcmV0dXJuIHtcbiAgICAgICAgZGlzcG9zZTogKCkgPT4gZWxtc1RvVXBkYXRlLmNsZWFyKCksXG4gICAgICAgIGdldDogKHByb3BOYW1lKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBlbG0gPSBnZXRSZW5kZXJpbmdSZWYoKTtcbiAgICAgICAgICAgIGlmIChlbG0pIHtcbiAgICAgICAgICAgICAgICBhcHBlbmRUb01hcChlbG1zVG9VcGRhdGUsIHByb3BOYW1lLCBlbG0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9LFxuICAgICAgICBzZXQ6IChwcm9wTmFtZSkgPT4ge1xuICAgICAgICAgICAgY29uc3QgZWxlbWVudHMgPSBlbG1zVG9VcGRhdGUuZ2V0KHByb3BOYW1lKTtcbiAgICAgICAgICAgIGlmIChlbGVtZW50cykge1xuICAgICAgICAgICAgICAgIGVsbXNUb1VwZGF0ZS5zZXQocHJvcE5hbWUsIGVsZW1lbnRzLmZpbHRlcihmb3JjZVVwZGF0ZSkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY2xlYW51cEVsZW1lbnRzKGVsbXNUb1VwZGF0ZSk7XG4gICAgICAgIH0sXG4gICAgICAgIHJlc2V0OiAoKSA9PiB7XG4gICAgICAgICAgICBlbG1zVG9VcGRhdGUuZm9yRWFjaCgoZWxtcykgPT4gZWxtcy5mb3JFYWNoKGZvcmNlVXBkYXRlKSk7XG4gICAgICAgICAgICBjbGVhbnVwRWxlbWVudHMoZWxtc1RvVXBkYXRlKTtcbiAgICAgICAgfSxcbiAgICB9O1xufTtcblxuY29uc3QgdW53cmFwID0gKHZhbCkgPT4gKHR5cGVvZiB2YWwgPT09ICdmdW5jdGlvbicgPyB2YWwoKSA6IHZhbCk7XG5jb25zdCBjcmVhdGVPYnNlcnZhYmxlTWFwID0gKGRlZmF1bHRTdGF0ZSwgc2hvdWxkVXBkYXRlID0gKGEsIGIpID0+IGEgIT09IGIpID0+IHtcbiAgICBjb25zdCB1bndyYXBwZWRTdGF0ZSA9IHVud3JhcChkZWZhdWx0U3RhdGUpO1xuICAgIGxldCBzdGF0ZXMgPSBuZXcgTWFwKE9iamVjdC5lbnRyaWVzKHVud3JhcHBlZFN0YXRlICE9PSBudWxsICYmIHVud3JhcHBlZFN0YXRlICE9PSB2b2lkIDAgPyB1bndyYXBwZWRTdGF0ZSA6IHt9KSk7XG4gICAgY29uc3QgaGFuZGxlcnMgPSB7XG4gICAgICAgIGRpc3Bvc2U6IFtdLFxuICAgICAgICBnZXQ6IFtdLFxuICAgICAgICBzZXQ6IFtdLFxuICAgICAgICByZXNldDogW10sXG4gICAgfTtcbiAgICBjb25zdCByZXNldCA9ICgpID0+IHtcbiAgICAgICAgdmFyIF9hO1xuICAgICAgICAvLyBXaGVuIHJlc2V0dGluZyB0aGUgc3RhdGUsIHRoZSBkZWZhdWx0IHN0YXRlIG1heSBiZSBhIGZ1bmN0aW9uIC0gdW53cmFwIGl0IHRvIGludm9rZSBpdC5cbiAgICAgICAgLy8gb3RoZXJ3aXNlLCB0aGUgc3RhdGUgd29uJ3QgYmUgcHJvcGVybHkgcmVzZXRcbiAgICAgICAgc3RhdGVzID0gbmV3IE1hcChPYmplY3QuZW50cmllcygoX2EgPSB1bndyYXAoZGVmYXVsdFN0YXRlKSkgIT09IG51bGwgJiYgX2EgIT09IHZvaWQgMCA/IF9hIDoge30pKTtcbiAgICAgICAgaGFuZGxlcnMucmVzZXQuZm9yRWFjaCgoY2IpID0+IGNiKCkpO1xuICAgIH07XG4gICAgY29uc3QgZGlzcG9zZSA9ICgpID0+IHtcbiAgICAgICAgLy8gQ2FsbCBmaXJzdCBkaXNwb3NlIGFzIHJlc2V0dGluZyB0aGUgc3RhdGUgd291bGRcbiAgICAgICAgLy8gY2F1c2UgbGVzcyB1cGRhdGVzIDspXG4gICAgICAgIGhhbmRsZXJzLmRpc3Bvc2UuZm9yRWFjaCgoY2IpID0+IGNiKCkpO1xuICAgICAgICByZXNldCgpO1xuICAgIH07XG4gICAgY29uc3QgZ2V0ID0gKHByb3BOYW1lKSA9PiB7XG4gICAgICAgIGhhbmRsZXJzLmdldC5mb3JFYWNoKChjYikgPT4gY2IocHJvcE5hbWUpKTtcbiAgICAgICAgcmV0dXJuIHN0YXRlcy5nZXQocHJvcE5hbWUpO1xuICAgIH07XG4gICAgY29uc3Qgc2V0ID0gKHByb3BOYW1lLCB2YWx1ZSkgPT4ge1xuICAgICAgICBjb25zdCBvbGRWYWx1ZSA9IHN0YXRlcy5nZXQocHJvcE5hbWUpO1xuICAgICAgICBpZiAoc2hvdWxkVXBkYXRlKHZhbHVlLCBvbGRWYWx1ZSwgcHJvcE5hbWUpKSB7XG4gICAgICAgICAgICBzdGF0ZXMuc2V0KHByb3BOYW1lLCB2YWx1ZSk7XG4gICAgICAgICAgICBoYW5kbGVycy5zZXQuZm9yRWFjaCgoY2IpID0+IGNiKHByb3BOYW1lLCB2YWx1ZSwgb2xkVmFsdWUpKTtcbiAgICAgICAgfVxuICAgIH07XG4gICAgY29uc3Qgc3RhdGUgPSAodHlwZW9mIFByb3h5ID09PSAndW5kZWZpbmVkJ1xuICAgICAgICA/IHt9XG4gICAgICAgIDogbmV3IFByb3h5KHVud3JhcHBlZFN0YXRlLCB7XG4gICAgICAgICAgICBnZXQoXywgcHJvcE5hbWUpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gZ2V0KHByb3BOYW1lKTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBvd25LZXlzKF8pIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gQXJyYXkuZnJvbShzdGF0ZXMua2V5cygpKTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBnZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLFxuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgaGFzKF8sIHByb3BOYW1lKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHN0YXRlcy5oYXMocHJvcE5hbWUpO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHNldChfLCBwcm9wTmFtZSwgdmFsdWUpIHtcbiAgICAgICAgICAgICAgICBzZXQocHJvcE5hbWUsIHZhbHVlKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgIH0pKTtcbiAgICBjb25zdCBvbiA9IChldmVudE5hbWUsIGNhbGxiYWNrKSA9PiB7XG4gICAgICAgIGhhbmRsZXJzW2V2ZW50TmFtZV0ucHVzaChjYWxsYmFjayk7XG4gICAgICAgIHJldHVybiAoKSA9PiB7XG4gICAgICAgICAgICByZW1vdmVGcm9tQXJyYXkoaGFuZGxlcnNbZXZlbnROYW1lXSwgY2FsbGJhY2spO1xuICAgICAgICB9O1xuICAgIH07XG4gICAgY29uc3Qgb25DaGFuZ2UgPSAocHJvcE5hbWUsIGNiKSA9PiB7XG4gICAgICAgIGNvbnN0IHVuU2V0ID0gb24oJ3NldCcsIChrZXksIG5ld1ZhbHVlKSA9PiB7XG4gICAgICAgICAgICBpZiAoa2V5ID09PSBwcm9wTmFtZSkge1xuICAgICAgICAgICAgICAgIGNiKG5ld1ZhbHVlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIC8vIFdlIG5lZWQgdG8gdW53cmFwIHRoZSBkZWZhdWx0U3RhdGUgYmVjYXVzZSBpdCBtaWdodCBiZSBhIGZ1bmN0aW9uLlxuICAgICAgICAvLyBPdGhlcndpc2Ugd2UgbWlnaHQgbm90IGJlIHNlbmRpbmcgdGhlIHJpZ2h0IHJlc2V0IHZhbHVlLlxuICAgICAgICBjb25zdCB1blJlc2V0ID0gb24oJ3Jlc2V0JywgKCkgPT4gY2IodW53cmFwKGRlZmF1bHRTdGF0ZSlbcHJvcE5hbWVdKSk7XG4gICAgICAgIHJldHVybiAoKSA9PiB7XG4gICAgICAgICAgICB1blNldCgpO1xuICAgICAgICAgICAgdW5SZXNldCgpO1xuICAgICAgICB9O1xuICAgIH07XG4gICAgY29uc3QgdXNlID0gKC4uLnN1YnNjcmlwdGlvbnMpID0+IHtcbiAgICAgICAgY29uc3QgdW5zdWJzID0gc3Vic2NyaXB0aW9ucy5yZWR1Y2UoKHVuc3Vicywgc3Vic2NyaXB0aW9uKSA9PiB7XG4gICAgICAgICAgICBpZiAoc3Vic2NyaXB0aW9uLnNldCkge1xuICAgICAgICAgICAgICAgIHVuc3Vicy5wdXNoKG9uKCdzZXQnLCBzdWJzY3JpcHRpb24uc2V0KSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoc3Vic2NyaXB0aW9uLmdldCkge1xuICAgICAgICAgICAgICAgIHVuc3Vicy5wdXNoKG9uKCdnZXQnLCBzdWJzY3JpcHRpb24uZ2V0KSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoc3Vic2NyaXB0aW9uLnJlc2V0KSB7XG4gICAgICAgICAgICAgICAgdW5zdWJzLnB1c2gob24oJ3Jlc2V0Jywgc3Vic2NyaXB0aW9uLnJlc2V0KSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoc3Vic2NyaXB0aW9uLmRpc3Bvc2UpIHtcbiAgICAgICAgICAgICAgICB1bnN1YnMucHVzaChvbignZGlzcG9zZScsIHN1YnNjcmlwdGlvbi5kaXNwb3NlKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gdW5zdWJzO1xuICAgICAgICB9LCBbXSk7XG4gICAgICAgIHJldHVybiAoKSA9PiB1bnN1YnMuZm9yRWFjaCgodW5zdWIpID0+IHVuc3ViKCkpO1xuICAgIH07XG4gICAgY29uc3QgZm9yY2VVcGRhdGUgPSAoa2V5KSA9PiB7XG4gICAgICAgIGNvbnN0IG9sZFZhbHVlID0gc3RhdGVzLmdldChrZXkpO1xuICAgICAgICBoYW5kbGVycy5zZXQuZm9yRWFjaCgoY2IpID0+IGNiKGtleSwgb2xkVmFsdWUsIG9sZFZhbHVlKSk7XG4gICAgfTtcbiAgICByZXR1cm4ge1xuICAgICAgICBzdGF0ZSxcbiAgICAgICAgZ2V0LFxuICAgICAgICBzZXQsXG4gICAgICAgIG9uLFxuICAgICAgICBvbkNoYW5nZSxcbiAgICAgICAgdXNlLFxuICAgICAgICBkaXNwb3NlLFxuICAgICAgICByZXNldCxcbiAgICAgICAgZm9yY2VVcGRhdGUsXG4gICAgfTtcbn07XG5jb25zdCByZW1vdmVGcm9tQXJyYXkgPSAoYXJyYXksIGl0ZW0pID0+IHtcbiAgICBjb25zdCBpbmRleCA9IGFycmF5LmluZGV4T2YoaXRlbSk7XG4gICAgaWYgKGluZGV4ID49IDApIHtcbiAgICAgICAgYXJyYXlbaW5kZXhdID0gYXJyYXlbYXJyYXkubGVuZ3RoIC0gMV07XG4gICAgICAgIGFycmF5Lmxlbmd0aC0tO1xuICAgIH1cbn07XG5cbmNvbnN0IGNyZWF0ZVN0b3JlID0gKGRlZmF1bHRTdGF0ZSwgc2hvdWxkVXBkYXRlKSA9PiB7XG4gICAgY29uc3QgbWFwID0gY3JlYXRlT2JzZXJ2YWJsZU1hcChkZWZhdWx0U3RhdGUsIHNob3VsZFVwZGF0ZSk7XG4gICAgbWFwLnVzZShzdGVuY2lsU3Vic2NyaXB0aW9uKCkpO1xuICAgIHJldHVybiBtYXA7XG59O1xuXG5leHBvcnQgeyBjcmVhdGVTdG9yZSBhcyBjIH07XG4iLCIvKiFcbiAqIEFsbCBtYXRlcmlhbCBjb3B5cmlnaHQgRVNSSSwgQWxsIFJpZ2h0cyBSZXNlcnZlZCwgdW5sZXNzIG90aGVyd2lzZSBzcGVjaWZpZWQuXG4gKiB2My4wLjk5XG4gKi9cbmltcG9ydCB7IGMgYXMgY3JlYXRlU3RvcmUgfSBmcm9tICcuL2luZGV4LTgxZDU0OGI3LmpzJztcblxuY29uc3QgcG9wdXBTdG9yZSA9IGNyZWF0ZVN0b3JlKHtcbiAgbGF5ZXI6IG51bGwsXG4gIG1hcFZpZXc6IG51bGwsXG4gIHBvcnRhbDogbnVsbCxcbiAgY29uZmlnOiBudWxsLFxuICBzdHJpbmdzOiBudWxsLFxuICBjdXJyZW50TGFuZ3VhZ2U6IG51bGwsXG4gIGN1cnJlbnRMYW5ndWFnZUludGw6IG51bGwsXG4gIHNlcnZpY2VUeXBlOiBudWxsLFxuICBwb3B1cFRlbXBsYXRlOiBudWxsLFxuICBsYXllckhhc0F0dGFjaG1lbnQ6IG51bGwsXG4gIGxheWVySGFzRVQ6IG51bGwsXG4gIGxheWVySGFzQXR0cmlidXRlczogbnVsbCxcbiAgbGF5ZXJIYXNDaGFydHM6IG51bGwsXG4gIGxheWVySGFzSW1hZ2VzOiBudWxsLFxuICBsYXllckhhc1RleHQ6IG51bGwsXG4gIGxheWVyRGlzcGxheVR5cGU6IG51bGwsXG4gIHN1cHBvcnRzQXJjYWRlOiBudWxsLFxuICBsYXllckhhc1JlbGF0ZWRSZWNvcmRzOiBmYWxzZVxufSk7XG4vLyB3b3JrYXJvdW5kIGZvciBzdGFydGluZyBhIHBhbmVsIHdpdGggYSBjbGVhbiBzdGF0ZVxuZnVuY3Rpb24gY2xlYXJQb3B1cFN0YXRlKHBvcHVwU3RhdGUpIHtcbiAgcG9wdXBTdGF0ZS5sYXllciA9IG51bGw7XG4gIHBvcHVwU3RhdGUubWFwVmlldyA9IG51bGw7XG4gIHBvcHVwU3RhdGUucG9ydGFsID0gbnVsbDtcbiAgcG9wdXBTdGF0ZS5jb25maWcgPSBudWxsO1xuICBwb3B1cFN0YXRlLnN0cmluZ3MgPSBudWxsO1xuICBwb3B1cFN0YXRlLmN1cnJlbnRMYW5ndWFnZSA9IG51bGw7XG4gIHBvcHVwU3RhdGUuY3VycmVudExhbmd1YWdlSW50bCA9IG51bGw7XG4gIHBvcHVwU3RhdGUuc2VydmljZVR5cGUgPSBudWxsO1xuICBwb3B1cFN0YXRlLnBvcHVwVGVtcGxhdGUgPSBudWxsO1xuICBwb3B1cFN0YXRlLmxheWVySGFzQXR0YWNobWVudCA9IG51bGw7XG4gIHBvcHVwU3RhdGUubGF5ZXJIYXNFVCA9IG51bGw7XG4gIHBvcHVwU3RhdGUubGF5ZXJIYXNBdHRyaWJ1dGVzID0gbnVsbDtcbiAgcG9wdXBTdGF0ZS5sYXllckhhc0NoYXJ0cyA9IG51bGw7XG4gIHBvcHVwU3RhdGUubGF5ZXJIYXNJbWFnZXMgPSBudWxsO1xuICBwb3B1cFN0YXRlLmxheWVySGFzVGV4dCA9IG51bGw7XG4gIHBvcHVwU3RhdGUubGF5ZXJEaXNwbGF5VHlwZSA9IG51bGw7XG4gIHBvcHVwU3RhdGUuc3VwcG9ydHNBcmNhZGUgPSBudWxsO1xuICBwb3B1cFN0YXRlLmxheWVySGFzUmVsYXRlZFJlY29yZHMgPSBmYWxzZTtcbn1cbmNvbnN0IHBvcHVwU3RhdGUgPSBwb3B1cFN0b3JlLnN0YXRlO1xuXG5leHBvcnQgeyBjbGVhclBvcHVwU3RhdGUgYXMgYywgcG9wdXBTdGF0ZSBhcyBwIH07XG4iXSwibmFtZXMiOltdLCJzb3VyY2VSb290IjoiIn0=
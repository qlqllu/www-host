"use strict";
(self["webpackChunkexb_client"] = self["webpackChunkexb_client"] || []).push([["vendors-extensions_widgets_arcgis_analysis_node_modules_arcgis_app-components_dist_esm_arcgis-aa2602"],{

/***/ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/arcgis-aggregation_8.entry.js":
/*!***********************************************************************************************************************!*\
  !*** ./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/arcgis-aggregation_8.entry.js ***!
  \***********************************************************************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   arcgis_aggregation: () => (/* binding */ ArcgisAggregation),
/* harmony export */   arcgis_aggregation_binning: () => (/* binding */ ArcgisAggregationBinning),
/* harmony export */   arcgis_aggregation_clustering: () => (/* binding */ ArcgisAggregationClustering),
/* harmony export */   arcgis_aggregation_field: () => (/* binding */ ArcgisAggregationField),
/* harmony export */   arcgis_aggregation_fields: () => (/* binding */ ArcgisAggregationFields),
/* harmony export */   arcgis_aggregation_info_popover: () => (/* binding */ ArcgisAggregationInfoPopover),
/* harmony export */   arcgis_aggregation_symbol_styler_popover: () => (/* binding */ ArcgisAggregationSymbolStylerPopover),
/* harmony export */   arcgis_aggregation_tile: () => (/* binding */ ArcgisAggregationTile)
/* harmony export */ });
/* harmony import */ var _index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./index-92ebb396.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/index-92ebb396.js");
/* harmony import */ var _languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./languageUtil-22258c90.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/languageUtil-22258c90.js");
/* harmony import */ var _locale_13e00a75_js__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./locale-13e00a75.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/locale-13e00a75.js");
/* harmony import */ var _loadModules_aaf30bd6_js__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ./loadModules-aaf30bd6.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/loadModules-aaf30bd6.js");
/* harmony import */ var _commonFunctions_5262b094_js__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ./commonFunctions-5262b094.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/commonFunctions-5262b094.js");
/* harmony import */ var _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! ./commonEnums-f98a323c.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/commonEnums-f98a323c.js");
/* harmony import */ var _functional_c82f5ab9_js__WEBPACK_IMPORTED_MODULE_6__ = __webpack_require__(/*! ./functional-c82f5ab9.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/functional-c82f5ab9.js");
/* harmony import */ var _dom_13f5b00c_js__WEBPACK_IMPORTED_MODULE_7__ = __webpack_require__(/*! ./dom-13f5b00c.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/dom-13f5b00c.js");
/*!
 * All material copyright ESRI, All Rights Reserved, unless otherwise specified.
 * v3.0.99
 */









// clustering
const clusteringRadiusMinVal = 9; // 12px
const clusteringRadiusMaxVal = 90; // 120px
const clusteringRadiusInitialVal = 37.5; // 50px
const clusteringSizeMinVal = 9; // 12px
const clusteringSizeMaxVal = 90; // 120px
const clusteringSizeMaxInitialVal = 37.5; // 50px
var AggregationType;
(function (AggregationType) {
  AggregationType["CLUSTERING"] = "clustering";
  AggregationType["CHART_CLUSTERING"] = "chartClustering";
  AggregationType["BINNING"] = "binning";
})(AggregationType || (AggregationType = {}));
/**
 * Returns a parent element with that tag name or class name
 * @param node - starting node
 * @param tagName - tag name to find up the tree
 * @param className - class name to find up the tree
 */
function findParentNode(node, tagName, className) {
  if ((tagName && (node === null || node === void 0 ? void 0 : node.tagName) === tagName.toUpperCase()) || (className && (node === null || node === void 0 ? void 0 : node.classList.contains(className)))) {
    return node;
  }
  else {
    let parentNode = node === null || node === void 0 ? void 0 : node.parentElement;
    while (parentNode) {
      if ((tagName && parentNode.tagName === tagName.toUpperCase()) ||
        (className && parentNode.classList.contains(className))) {
        return parentNode;
      }
      else if (parentNode.tagName === "BODY") {
        break;
      }
      else {
        parentNode = parentNode.parentElement;
      }
    }
  }
  return;
}
function getStatsTypeString(statisticType, strings) {
  switch (statisticType) {
    case "sum":
      return strings.fields.sum;
    case "avg":
      return strings.fields.mean;
    case "min":
      return strings.fields.min;
    case "max":
      return strings.fields.max;
    case "stddev":
      return strings.fields.stdDev;
    case "mode":
      return strings.fields.mode;
    case "var":
      return strings.fields.var;
    case "count":
      return strings.fields.count;
    default:
      return "";
  }
}
function getAggregationType(layer) {
  const featureReduction = layer.featureReduction;
  if (!featureReduction) {
    return undefined;
  }
  else if (featureReduction.type === "binning") {
    return "binning";
  }
  else if (featureReduction.type === "cluster") {
    if (isPieChartRenderer(layer)) {
      return "pie-chart";
    }
    return "cluster";
  }
}
function isRendererAutoGenerated(layer) {
  var _a, _b;
  const featureReduction = layer.featureReduction;
  return !(featureReduction === null || featureReduction === void 0 ? void 0 : featureReduction.renderer) || ((_b = (_a = featureReduction === null || featureReduction === void 0 ? void 0 : featureReduction.renderer) === null || _a === void 0 ? void 0 : _a.authoringInfo) === null || _b === void 0 ? void 0 : _b.isAutoGenerated);
}
function isPieChartRenderer(layer) {
  var _a, _b;
  const featureReduction = layer.featureReduction;
  return (featureReduction.renderer &&
    featureReduction.renderer.type === "pie-chart" &&
    !((_b = (_a = featureReduction === null || featureReduction === void 0 ? void 0 : featureReduction.renderer) === null || _a === void 0 ? void 0 : _a.authoringInfo) === null || _b === void 0 ? void 0 : _b.isAutoGenerated));
}

function isSupportedSymbol(sym) {
  return ["simple-fill", "simple-marker", "simple-line", "picture-marker", "cim"].indexOf(sym.type) > -1;
}
function getDefaultSymbol(modules) {
  /*
  "symbol":{
    "type":"esriSMS",
    "color":[227,139,79,255],
    "angle":0,
    "xoffset":0,
    "yoffset":0,
    "size":9,
    "style":"esriSMSCircle",
    "outline":{
      "type":"esriSLS",
      "color":[92,92,92,64],
      "width":0.75,
      "style":"esriSLSSolid"
    }
  }
  */
  const { SimpleLineSymbol, SimpleMarkerSymbol, Color } = modules;
  const outlineSym = new SimpleLineSymbol({
    style: "solid",
    color: new Color([92, 92, 92, 64]),
    width: 1
  });
  const symbol = new SimpleMarkerSymbol({
    style: "circle",
    size: 6.75,
    outline: outlineSym,
    color: new Color([227, 139, 79, 255])
  });
  return symbol;
}
function hasSymbolOutline(sym) {
  var _a;
  return sym.type === "picture-marker" ? false : sym.type === "cim" ? false : !!((_a = sym.outline) === null || _a === void 0 ? void 0 : _a.color);
}
function isPictureMarker(sym, modules) {
  if (sym.type === "picture-marker") {
    return true;
  }
  else if (sym.type === "cim" && !isFillOnlyCIM(sym, modules)) {
    return true;
  }
  return false;
}
function isFillOnlyCIM(sym, modules) {
  const { cimSymbolUtils } = modules;
  return !!cimSymbolUtils.getCIMSymbolColor(sym);
}
function getSymbolColor(symbol, modules) {
  var _a, _b;
  const { cimSymbolUtils, Color } = modules;
  return (symbol === null || symbol === void 0 ? void 0 : symbol.type) === "cim"
    ? Color.fromJSON((_a = cimSymbolUtils.getCIMSymbolColor(symbol)) === null || _a === void 0 ? void 0 : _a.toJSON())
    : (symbol === null || symbol === void 0 ? void 0 : symbol.type) === "simple-marker" && ["x", "cross"].indexOf(symbol === null || symbol === void 0 ? void 0 : symbol.style) > -1
      ? (_b = symbol === null || symbol === void 0 ? void 0 : symbol.outline) === null || _b === void 0 ? void 0 : _b.color
      : symbol === null || symbol === void 0 ? void 0 : symbol.color;
}
function getSymbolSize(sym, modules) {
  const { cimSymbolUtils } = modules;
  if (sym.type === "cim") {
    return cimSymbolUtils.getCIMSymbolSize(sym);
  }
  else if (sym.size) {
    return sym.size;
  }
  return sym.width;
}
function adjustAlpha(color, alpha) {
  color.a = alpha;
  return color;
}

function getLayerNumberOrStringFields(layer) {
  return layer.fields.filter((field) => ["small-integer", "big-integer", "integer", "single", "double", "long", "number", "string"].indexOf(field.type) > -1);
}
function getLayerField(layer, fieldName) {
  return fieldName && layer.fields.find((field) => field.name === fieldName);
}
function hasFieldAlready(layer, fieldName, statisticType) {
  var _a;
  const featureReduction = layer.featureReduction; //__esri.FeatureReductionCluster;
  return !!((_a = featureReduction.fields) === null || _a === void 0 ? void 0 : _a.find((fi /* __esri.AggregateField */) => fi.onStatisticField === fieldName && fi.statisticType === statisticType));
}
/*
 * no more stats options available for this field
 */
function isFieldDone(layer, fieldName) {
  const field = getLayerField(layer, fieldName);
  const types = getStatsTypes(field);
  return !types.find((type) => !hasFieldAlready(layer, fieldName, type));
}
function getStatsTypes(field) {
  return field.type === "string" ? ["mode"] : ["sum", "avg", "min", "max", /* "var", "stddev", */ "mode"];
}
function addPopupField(aggregateField, layer, modules) {
  // don't know where to store the alias for this field otherwise
  /* if (aggregateField.isAutoGenerated && aggregateField.statisticType === "mode") {
    // don't add this field generated for the renderer
    return;
  } */
  const { FieldInfo } = modules;
  const featureReduction = layer.featureReduction; //__esri.FeatureReductionCluster;
  const { popupTemplate } = featureReduction;
  popupTemplate.fieldInfos = popupTemplate.fieldInfos || [];
  const fieldInfo = popupTemplate.fieldInfos.find((fieldInfo) => fieldInfo.fieldName === aggregateField.name);
  if (!fieldInfo) {
    popupTemplate.fieldInfos.push(new FieldInfo({
      fieldName: aggregateField.name,
      label: aggregateField.alias,
      isEditable: false,
      visible: true,
      format: getFormat(aggregateField, layer)
    }));
  } // else fieldInfo is already there
}
function getPopupFieldInfo(layer, fieldName) {
  const featureReduction = layer.featureReduction;
  return featureReduction.popupTemplate.fieldInfos.find((fieldInfo) => fieldInfo.fieldName === fieldName);
}
function getFormat(aggregateField, layer) {
  const statsField = aggregateField.onStatisticField;
  const statsExpr = aggregateField.onStatisticExpression;
  const isSum = aggregateField.statisticType === "sum";
  const isCount = aggregateField.statisticType === "count";
  const field = getLayerField(layer, statsField);
  const isInt = isCount ||
    (statsExpr && isSum) ||
    (field && ["small-integer", "big-integer", "integer", "long", "number"].indexOf(field.type) > -1);
  const isDouble = field && ["single", "double"].indexOf(field.type) > -1;
  return isDouble
    ? {
      digitSeparator: true,
      places: 1
    }
    : isInt
      ? {
        digitSeparator: true
      }
      : undefined;
}

const arcgisAggregationCss = ":host{height:100%}.flow{height:100%}.panel{height:100%}.toggle{background-color:white;padding:15px 10px 5px 10px}";

const ArcgisAggregation = class {
  constructor(hostRef) {
    (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.r)(this, hostRef);
    this.arcgisAggregationStyleClick = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "arcgisAggregationStyleClick", 7);
    this.arcgisAggregationClose = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "arcgisAggregationClose", 7);
    this.arcgisAggregationChanged = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "arcgisAggregationChanged", 7);
    this.arcgisAggregationError = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "arcgisAggregationError", 7);
    this.tileNodes = [];
    this.lastFeatureReduction = [];
    this.view = undefined;
    this.layer = undefined;
    this.portal = undefined;
    this.config = undefined;
    this.hideLayerTitle = false;
    this.options = undefined;
  }
  //--------------------------------------------------------------------------
  //
  //  Public Methods
  //
  //--------------------------------------------------------------------------
  /**
   * Set focus on component
   */
  async setFocus() {
    var _a;
    (_a = this.flowItemNode) === null || _a === void 0 ? void 0 : _a.setFocus();
  }
  //--------------------------------------------------------------------------
  //
  //  Lifecycle
  //
  //--------------------------------------------------------------------------
  async componentWillLoad() {
    const [strings, currentLanguage] = await (0,_locale_13e00a75_js__WEBPACK_IMPORTED_MODULE_2__.g)(this.hostElement);
    this.strings = strings;
    this.locale = currentLanguage;
    const [popupClusters, popupUtils, binLevel, clusterLabelCreator, binLabelCreator, AggregateField, FieldInfo, pieChartCreator, colorCreator, SimpleRenderer] = await (0,_loadModules_aaf30bd6_js__WEBPACK_IMPORTED_MODULE_3__.l)([
      "esri/smartMapping/popup/clusters",
      "esri/support/popupUtils",
      "esri/smartMapping/heuristics/binLevel",
      "esri/smartMapping/labels/clusters",
      "esri/smartMapping/labels/bins",
      "esri/layers/support/AggregateField",
      "esri/popup/FieldInfo",
      "esri/smartMapping/renderers/pieChart",
      "esri/smartMapping/renderers/color",
      "esri/renderers/SimpleRenderer"
    ]);
    this.modules = {
      popupClusters,
      popupUtils,
      binLevel,
      clusterLabelCreator,
      binLabelCreator,
      AggregateField,
      FieldInfo,
      pieChartCreator,
      colorCreator,
      SimpleRenderer
    };
    const { view, layer } = this;
    this.props = {
      view,
      layer
    };
  }
  componentDidLoad() {
    var _a;
    const { props, modules } = this;
    const { layer } = props;
    const { AggregateField } = modules;
    const featureReduction = layer.featureReduction;
    if (featureReduction && !((_a = featureReduction.fields) === null || _a === void 0 ? void 0 : _a.length)) {
      // we need at least one field
      const aggregateField = new AggregateField({
        name: "aggregateCount",
        onStatisticField: undefined,
        alias: "aggregateCount",
        statisticType: "count",
        visible: true
      });
      layer.featureReduction.fields = [aggregateField];
    }
    requestAnimationFrame(() => this.flowItemNode.setFocus());
  }
  // --------------------------------------------------------------------------
  //
  //  Render Methods
  //
  //--------------------------------------------------------------------------
  render() {
    const { layer, options } = this;
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)(_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.H, { class: "calcite-match-height" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-flow", { class: "flow", dir: (0,_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_1__.g)(this.hostElement), ref: (node) => (this.flowNode = node) }, layer.featureEffect ? this.renderMsg() : this.renderContent(), (options === AggregationType.CLUSTERING ||
      options === AggregationType.CHART_CLUSTERING) &&
      this.renderClusteringOptions(), options === AggregationType.BINNING && this.renderBinningOptions())));
  }
  renderContent() {
    var _a, _b, _c;
    const { props, hideLayerTitle, config, flowItemNode, tileNodes, strings } = this;
    const { layer } = props;
    const featureReduction = layer.featureReduction;
    const rtl = (0,_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_1__.g)(this.hostElement) === "rtl";
    const generalProps = { flowItemNode, strings, config };
    const { renderer } = layer;
    const isUniqueValue = renderer.type === "unique-value";
    const isMultiFieldTypes = isUniqueValue && !!renderer.field2;
    const isHeatmap = renderer.type === "heatmap";
    const usesArcade = !!renderer.valueExpression;
    const isClassedColor = renderer.type === "class-breaks" && ((_a = renderer.authoringInfo) === null || _a === void 0 ? void 0 : _a.type) === "class-breaks-color";
    const infosCount = isUniqueValue
      ? (_b = renderer.uniqueValueInfos) === null || _b === void 0 ? void 0 : _b.length
      : isClassedColor
        ? (_c = renderer.classBreakInfos) === null || _c === void 0 ? void 0 : _c.length
        : 0;
    const allowClustering = !isHeatmap && !isMultiFieldTypes;
    const allowChart = (isUniqueValue || isClassedColor) && infosCount <= 10 && !isMultiFieldTypes && !usesArcade;
    const aggregationType = getAggregationType(layer);
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-flow-item", { heading: strings.aggregation, description: !hideLayerTitle ? layer.title : undefined, class: {
        panel: true,
        [_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_1__.C.rtl]: rtl
      }, closable: true, onCalciteFlowItemClose: () => {
        this.arcgisAggregationClose.emit();
      }, ref: (node) => {
        this.flowItemNode = node;
      } }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "toggle" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-label", { layout: "inline-space-between" }, strings.enableAggregation, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-switch", { scale: "s", checked: !!featureReduction, label: strings.enableAggregation, onCalciteSwitchChange: (event) => this.handleToggleClustering(event), ref: (node) => (this.switchNode = node) }))), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", null, allowClustering && ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-aggregation-tile", { props: Object.assign({ title: strings.clustering, imagePath: (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.a)(`./assets/arcgis-aggregation-thumbnails/clustering.jpg`), moreInfo: strings.info.clustering, helpId: "120003927" }, generalProps), selected: aggregationType === "cluster", ref: (node) => (tileNodes["cluster"] = node), onArcgisAggregationTileSelect: async () => {
        await this.enableAggregation("cluster");
        (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.hostElement);
      }, onArcgisAggregationTileOptions: () => {
        this.options = AggregationType.CLUSTERING;
        (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.hostElement);
      } })), allowChart && ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-aggregation-tile", { props: Object.assign({ title: strings.chartClustering, imagePath: (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.a)(`./assets/arcgis-aggregation-thumbnails/chartClustering.jpg`), moreInfo: strings.info.chartClustering, helpId: "120003927" }, generalProps), selected: aggregationType === "pie-chart", ref: (node) => (tileNodes["pie-chart"] = node), onArcgisAggregationTileSelect: async () => {
        await this.enableAggregation("pie-chart");
        (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.hostElement);
      }, onArcgisAggregationTileOptions: () => {
        this.options = AggregationType.CHART_CLUSTERING;
        (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.hostElement);
      } })), ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-aggregation-tile", { props: Object.assign({ title: strings.binning, imagePath: (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.a)(`./assets/arcgis-aggregation-thumbnails/binning.jpg`), moreInfo: strings.info.binning, helpId: "120003926" }, generalProps), selected: aggregationType === "binning", ref: (node) => (tileNodes["binning"] = node), onArcgisAggregationTileSelect: async () => {
        await this.enableAggregation("binning");
        (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.hostElement);
      }, onArcgisAggregationTileOptions: () => {
        this.options = AggregationType.BINNING;
        (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.hostElement);
      } })))));
  }
  renderMsg() {
    const { layer, hideLayerTitle, strings } = this;
    const rtl = (0,_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_1__.g)(this.hostElement) === "rtl";
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-flow-item", { heading: strings.aggregation, description: !hideLayerTitle ? layer.title : undefined, class: {
        panel: true,
        [_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_1__.C.rtl]: rtl
      }, closable: true, onCalciteFlowItemClose: () => {
        this.arcgisAggregationClose.emit();
      }, ref: (node) => {
        this.flowItemNode = node;
      } }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-tip", { "non-dismissible": true }, strings.cluster.leNotSupportedMessage)));
  }
  renderClusteringOptions() {
    const { props, hideLayerTitle, portal, config, flowNode, strings, locale } = this;
    const { layer, view } = props;
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-aggregation-clustering", { view: view, layer: layer, portal: portal, config: config, flowNode: flowNode, hideLayerTitle: hideLayerTitle, strings: strings, currentLanguage: locale, onArcgisAggregationClusteringChange: () => {
        this.arcgisAggregationChanged.emit();
      }, onArcgisAggregationClusteringDismissedChange: () => { }, onCalcitePanelBackClick: () => {
        this.options = undefined;
      } }));
  }
  renderBinningOptions() {
    const { props, hideLayerTitle, portal, config, flowNode, strings, locale } = this;
    const { layer, view } = props;
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-aggregation-binning", { view: view, layer: layer, portal: portal, config: config, flowNode: flowNode, hideLayerTitle: hideLayerTitle, strings: strings, currentLanguage: locale, onArcgisAggregationBinningChange: () => this.arcgisAggregationChanged.emit(), onArcgisAggregationBinningStyleClick: () => this.arcgisAggregationStyleClick.emit(), onArcgisAggregationBinningDismissedChange: () => { }, onCalcitePanelBackClick: () => {
        this.options = undefined;
      } }));
  }
  // --------------------------------------------------------------------------
  //
  //  Private methods
  //
  // --------------------------------------------------------------------------
  async handleToggleClustering(event) {
    if (event.currentTarget.checked) {
      await this.enableAggregation("default");
    }
    else {
      this.disableAggregation();
    }
    (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.hostElement);
  }
  async enableAggregation(type) {
    const { props, flowItemNode } = this;
    const { layer } = props;
    const { renderer } = layer;
    const isUniqueValue = renderer.type === "unique-value";
    const isMultiFieldTypes = isUniqueValue && !!renderer.field2;
    const isHeatmap = renderer.type === "heatmap";
    if (type === "default" &&
      this.lastFeatureReductionType &&
      this.lastFeatureReduction[this.lastFeatureReductionType]) {
      layer.featureReduction = this.lastFeatureReduction[this.lastFeatureReductionType];
      layer.featureReduction = layer.featureReduction.clone();
      this.arcgisAggregationChanged.emit();
    }
    else {
      if (type === "default") {
        if (!isHeatmap && !isMultiFieldTypes) {
          type = "cluster";
        }
        else {
          type = "binning";
        }
      }
      // save what we have now
      const currentType = getAggregationType(layer);
      if (currentType) {
        this.lastFeatureReduction[currentType] = layer.featureReduction;
      }
      if (this.lastFeatureReduction[type]) {
        layer.featureReduction = this.lastFeatureReduction[type];
        layer.featureReduction = layer.featureReduction.clone();
        this.arcgisAggregationChanged.emit();
      }
      else {
        try {
          flowItemNode.loading = true;
          if (type === "binning") {
            await this.createBinning();
          }
          else {
            await this.createCluster(type);
          }
          flowItemNode.loading = false;
          layer.featureReduction = layer.featureReduction.clone();
          this.arcgisAggregationChanged.emit();
        }
        catch (e) {
          flowItemNode.loading = false;
          this.arcgisAggregationError.emit({
            message: "Aggregation style could not be changed.",
            type: "warning"
          });
          (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.hostElement);
        }
      }
    }
  }
  async createCluster(type) {
    var _a, _b;
    const { props, switchNode, tileNodes, modules } = this;
    const { layer, view } = props;
    const { popupClusters, clusterLabelCreator, pieChartCreator } = modules;
    const lastFeatureReduction = layer.featureReduction;
    try {
      const labelSchemes = type === "cluster" &&
        (await clusterLabelCreator.getLabelSchemes({
          layer: layer,
          renderer: layer.renderer,
          view: view
        }));
      layer.featureReduction = {
        type: "cluster",
        clusterMinSize: ((_a = labelSchemes === null || labelSchemes === void 0 ? void 0 : labelSchemes.primaryScheme) === null || _a === void 0 ? void 0 : _a.clusterMinSize) || clusteringSizeMinVal,
        clusterMaxSize: clusteringSizeMaxInitialVal,
        clusterRadius: clusteringRadiusInitialVal,
        labelsVisible: type === "cluster",
        labelingInfo: (_b = labelSchemes === null || labelSchemes === void 0 ? void 0 : labelSchemes.primaryScheme) === null || _b === void 0 ? void 0 : _b.labelingInfo
      };
      let result;
      if (type === "pie-chart") {
        // for chart clustering create a pie-chart renderer now
        result = await pieChartCreator.createRendererForClustering({ layer });
        layer.featureReduction.renderer = result.renderer;
        layer.featureReduction.fields = layer.featureReduction.fields.concat(result.fields);
      }
      const template = await popupClusters.getTemplates({
        renderer: layer.renderer,
        layer: layer
      });
      if (type === "cluster") {
        const popupTemplate = template.primaryTemplate.value;
        layer.featureReduction.popupTemplate = popupTemplate;
      }
      else {
        // pie-chart
        const popupTemplate = template.secondaryTemplates[0].value;
        layer.featureReduction.popupTemplate = popupTemplate;
        // add the fields from the renderer to the popup as well
        result.fields.forEach((aggregateField) => addPopupField(aggregateField, layer, modules));
      }
      return Promise.resolve();
    }
    catch (e) {
      layer.featureReduction = lastFeatureReduction;
      if (layer.featureReduction) {
        tileNodes[getAggregationType(layer)].setFocus();
      }
      else {
        switchNode.setFocus();
      }
      return Promise.reject();
    }
  }
  async createBinning() {
    var _a, _b;
    const { props, switchNode, tileNodes, modules } = this;
    const { layer, view } = props;
    const { popupUtils, binLevel, binLabelCreator, AggregateField, colorCreator } = modules;
    const lastFeatureReduction = layer.featureReduction;
    try {
      // create the feature reduction with a transparent renderer
      // so we don't see points flashing on the map
      const _binLevel = binLevel;
      const fixedBinLevel = await _binLevel({ view } /* as __esri.binLevelBinLevelParams */);
      layer.featureReduction = {
        type: "binning",
        fixedBinLevel: fixedBinLevel || 1
      };
      if (!((_a = layer.featureReduction.fields) === null || _a === void 0 ? void 0 : _a.length)) {
        // create count field
        const aggregateField = new AggregateField({
          name: "aggregateCount",
          onStatisticField: undefined,
          alias: "aggregateCount",
          statisticType: "count",
          visible: true
        });
        layer.featureReduction.fields = [aggregateField];
      }
      const result = await colorCreator.createContinuousRenderer({
        layer,
        view: view,
        field: "aggregateCount",
        outlineOptimizationEnabled: true,
        sizeOptimizationEnabled: true,
        defaultSymbolEnabled: false,
        forBinning: true
      });
      layer.featureReduction.renderer = result.renderer;
      // layer needs to have the featureReduction + renderer before this can be called
      const labelSchemes = await binLabelCreator.getLabelSchemes({
        layer: layer
      });
      layer.featureReduction.labelingInfo = (_b = labelSchemes === null || labelSchemes === void 0 ? void 0 : labelSchemes.primaryScheme) === null || _b === void 0 ? void 0 : _b.labelingInfo;
      layer.featureReduction.labelsVisible = true;
      const fieldNames = layer.featureReduction.fields.map((aggregateField) => aggregateField.onStatisticField);
      const popupTemplate = popupUtils.createPopupTemplateForFeatureReduction({
        featureReduction: layer.featureReduction,
        fields: layer.fields.filter((field) => fieldNames.indexOf(field.name) > -1)
      });
      layer.featureReduction.popupTemplate = popupTemplate;
      return Promise.resolve();
    }
    catch (e) {
      layer.featureReduction = lastFeatureReduction;
      if (layer.featureReduction) {
        tileNodes[getAggregationType(layer)].setFocus();
      }
      else {
        switchNode.setFocus();
      }
      return Promise.reject();
    }
  }
  disableAggregation() {
    const { props } = this;
    const { layer } = props;
    const aggregationType = getAggregationType(layer);
    this.lastFeatureReduction[aggregationType] = layer.featureReduction;
    this.lastFeatureReductionType = aggregationType;
    layer.featureReduction = null;
    this.arcgisAggregationChanged.emit();
  }
  static get assetsDirs() { return ["assets"]; }
  get hostElement() { return (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.d)(this); }
};
ArcgisAggregation.style = arcgisAggregationCss;

const arcgisAggregationBinningCss = ".block-section.sc-arcgis-aggregation-binning{padding:0 10px}.block-content.sc-arcgis-aggregation-binning{padding-top:10px}.slider-title-wrapper.sc-arcgis-aggregation-binning{background-color:var(--arcgis-app-background);border-bottom:1px solid var(--arcgis-app-border);padding:var(--arcgis-app-cap-spacing) var(--arcgis-app-side-spacing)}.slider-div.sc-arcgis-aggregation-binning{display:flex;align-items:center;justify-content:space-between;flex-flow:row wrap}.slider-heading.sc-arcgis-aggregation-binning{display:inline-block;padding:var(--arcgis-app-cap-spacing-half) 0;font-size:var(--arcgis-app-font-size-0)}.slider-label.sc-arcgis-aggregation-binning{display:inline-block;padding:var(--arcgis-app-cap-spacing-eighth) 0;font-size:var(--arcgis-app-font-size--1);order:2}.slider-slider.sc-arcgis-aggregation-binning{display:inline-block;width:100%;order:1}.btn-section.sc-arcgis-aggregation-binning{background-color:var(--arcgis-app-background)}.btn.sc-arcgis-aggregation-binning{background:var(--arcgis-app-background-clear);border:none;border-bottom:solid 1px var(--arcgis-app-border);color:var(--arcgis-app-font-color);display:flex;align-items:center;justify-content:space-between;padding:var(--arcgis-app-cap-spacing) var(--arcgis-app-side-spacing);cursor:pointer;width:100%;transition:background-color var(--arcgis-app-animation-time-fast) var(--arcgis-app-easing-function), border-color var(--arcgis-app-animation-time-fast) var(--arcgis-app-easing-function)}.btn.sc-arcgis-aggregation-binning:hover{background-color:var(--arcgis-app-background-hover);border-color:var(--arcgis-app-border-hover)}.btn-text.sc-arcgis-aggregation-binning{font-family:var(--arcgis-app-font-family);font-size:var(--arcgis-app-font-size-0)}.style-button-div.sc-arcgis-aggregation-binning{background-color:white;padding:10px}";

const ArcgisAggregationBinning = class {
  constructor(hostRef) {
    (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.r)(this, hostRef);
    this.arcgisAggregationBinningChange = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "arcgisAggregationBinningChange", 7);
    this.arcgisAggregationBinningDismissedChange = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "arcgisAggregationBinningDismissedChange", 7);
    this.arcgisAggregationBinningStyleClick = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "arcgisAggregationBinningStyleClick", 7);
    this.calcitePanelBackClick = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "calcitePanelBackClick", 7);
    this.internalChange = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "internalChange", 7);
    this.closeLabelPopovers = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "closeLabelPopovers", 7);
    this.closePopupPopovers = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "closePopupPopovers", 7);
    this.closeAttributePopovers = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "closeAttributePopovers", 7);
    this.disableSizeSlider = false;
    this.onBinSizeChange = (0,_functional_c82f5ab9_js__WEBPACK_IMPORTED_MODULE_6__.d)(async (newValue) => {
      const { layer, view, modules } = this;
      const { colorCreator, AggregateField } = modules;
      const featureReduction = layer.featureReduction;
      featureReduction.fixedBinLevel = newValue;
      // new renderer
      const binning = layer.featureReduction;
      let field = binning.fields.find((aggregateField) => aggregateField.statisticType === "count");
      if (!field) {
        field = new AggregateField({
          name: "aggregateCount",
          onStatisticField: undefined,
          alias: "aggregateCount",
          statisticType: "count",
          visible: true
        });
        layer.featureReduction.fields.push(field);
      }
      const result = await colorCreator.createContinuousRenderer({
        layer,
        view: view,
        field: field.name,
        outlineOptimizationEnabled: true,
        sizeOptimizationEnabled: true,
        defaultSymbolEnabled: false,
        forBinning: true
      });
      layer.featureReduction.renderer = result.renderer;
      this.internalChange.emit();
    }, 300);
    this.view = undefined;
    this.layer = undefined;
    this.portal = undefined;
    this.config = undefined;
    this.flowNode = undefined;
    this.strings = undefined;
    this.currentLanguage = undefined;
    this.hideLayerTitle = false;
  }
  // clone featureReduction to update map
  internalChangeHandler() {
    const { layer } = this;
    const featureReduction = layer.featureReduction;
    layer.featureReduction = featureReduction.clone();
    this.arcgisAggregationBinningChange.emit();
  }
  //--------------------------------------------------------------------------
  //
  //  public calls
  //
  //--------------------------------------------------------------------------
  // Public Methods
  async done() {
    this.closePopovers();
  }
  async setFocus() {
    this.flowItemNode.setFocus();
  }
  //--------------------------------------------------------------------------
  //
  //  Lifecycle
  //
  //--------------------------------------------------------------------------
  async componentWillLoad() {
    // only valid for point
    this.layerGeometryType = await (0,_commonFunctions_5262b094_js__WEBPACK_IMPORTED_MODULE_4__.h)(this.layer);
    const [AggregateField, colorCreator] = await (0,_loadModules_aaf30bd6_js__WEBPACK_IMPORTED_MODULE_3__.l)([
      "esri/layers/support/AggregateField",
      "esri/smartMapping/renderers/color"
    ]);
    this.modules = {
      AggregateField,
      colorCreator
    };
  }
  componentDidLoad() {
    setTimeout(() => requestAnimationFrame(() => this.flowItemNode.setFocus()), 200);
  }
  componentDidUpdate() {
    //this.internalChange.emit();
  }
  disconnectedCallback() {
    this.closePopovers();
  }
  // --------------------------------------------------------------------------
  //
  //  Render Methods
  //
  //--------------------------------------------------------------------------
  render() {
    const { layer, strings, hideLayerTitle } = this;
    //const featureReduction = layer.featureReduction as any; //__esri.FeatureReductionCluster;
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)(_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.H, { class: "calcite-match-height" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-flow-item", { heading: strings.binning, description: !hideLayerTitle ? layer.title : undefined, onCalciteFlowItemBack: () => {
        this.calcitePanelBackClick.emit();
        //this.closePopovers();
      }, ref: (node) => (this.flowItemNode = node) }, this.renderBinSize(), this.renderFieldsBtn(), this.renderLabelBtn(), this.renderPopupBtn(), this.renderGoToStyle())));
  }
  renderBinSize() {
    var _a;
    const { layer, strings } = this;
    // need to switch labels back in rtl
    const rtl = (0,_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_1__.g)(this.hostElement) === "rtl";
    const featureReduction = layer.featureReduction;
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "slider-title-wrapper" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("label", { class: "slider-heading" }, strings.bin.binSizeTitle), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "slider-div" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("label", { class: "slider-label" }, rtl ? strings.bin.large : strings.bin.small), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-slider", { class: "slider-slider", min: 1, max: 9, value: 10 - ((_a = featureReduction.fixedBinLevel) !== null && _a !== void 0 ? _a : 3), step: 1, minLabel: strings.bin.binSizeTitle, onCalciteSliderInput: (event) => {
        const slider = event.target;
        this.onBinSizeChange(10 - slider.value);
      } }), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("label", { class: "slider-label" }, rtl ? strings.bin.small : strings.bin.large))));
  }
  renderFieldsBtn() {
    const { strings } = this;
    const rtl = (0,_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_1__.g)(this.hostElement) === "rtl";
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "btn-section" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("button", { class: "btn", onClick: (event) => this.addFieldsPanel(event) }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("span", { class: "btn-text" }, strings.bin.editAttributes), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("span", { class: "btn-icon" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-icon", { scale: "s", icon: rtl ? "chevron-left" : "chevron-right" })))));
  }
  renderLabelBtn() {
    const { strings } = this;
    const rtl = (0,_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_1__.g)(this.hostElement) === "rtl";
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "btn-section" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("button", { class: "btn", onClick: (event) => this.addLabelPanel(event) }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("span", { class: "btn-text" }, strings.bin.editLabel), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("span", { class: "btn-icon" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-icon", { scale: "s", icon: rtl ? "chevron-left" : "chevron-right" })))));
  }
  renderPopupBtn() {
    const { strings } = this;
    const rtl = (0,_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_1__.g)(this.hostElement) === "rtl";
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "btn-section" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("button", { class: "btn", onClick: (event) => this.addPopupPanel(event) }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("span", { class: "btn-text" }, strings.bin.editPopups), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("span", { class: "btn-icon" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-icon", { scale: "s", icon: rtl ? "chevron-left" : "chevron-right" })))));
  }
  renderGoToStyle() {
    const { strings } = this;
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "style-button-div" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { alignment: "center", appearance: "transparent", scale: "m", width: "full", class: "style-button", onClick: () => this.arcgisAggregationBinningStyleClick.emit() }, strings.bin.editBinStyle)));
  }
  // --------------------------------------------------------------------------
  //
  //  Private methods
  //
  // --------------------------------------------------------------------------
  closePopovers() {
    this.closeAttributePopovers.emit();
    this.closeLabelPopovers.emit();
    this.closePopupPopovers.emit();
  }
  addFieldsPanel(event) {
    event.stopPropagation();
    this.closePopovers();
    const { layer, view, currentLanguage, strings, flowNode, hideLayerTitle } = this;
    const fieldsNode = document.createElement("arcgis-aggregation-fields");
    fieldsNode.lang = currentLanguage;
    fieldsNode.layer = layer;
    fieldsNode.mapView = view;
    fieldsNode.strings = strings;
    fieldsNode.currentLanguage = currentLanguage;
    fieldsNode.hideLayerTitle = hideLayerTitle;
    fieldsNode.flowNode = flowNode;
    fieldsNode.addEventListener("arcgisAggregationFieldsChange", () => {
      this.internalChange.emit();
      (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.hostElement);
    });
    flowNode.appendChild(fieldsNode);
  }
  addLabelPanel(event) {
    const { layer, view, portal, config, currentLanguage, strings, flowNode, hideLayerTitle } = this;
    event.stopPropagation();
    this.closePopovers();
    const labelFlowItem = document.createElement("calcite-flow-item");
    //labelFlowItem.id = "labelFlowItem_Id";
    labelFlowItem.heading = strings.bin.labelFeaturesHeading;
    labelFlowItem.description = !hideLayerTitle ? layer.title : undefined;
    const calciteFab = document.createElement("calcite-fab");
    calciteFab.icon = "plus";
    calciteFab.slot = "fab";
    calciteFab.scale = "s";
    calciteFab.appearance = "outline-fill";
    calciteFab.kind = "neutral";
    calciteFab.label = strings.bin.labelFab;
    calciteFab.text = strings.bin.labelFab;
    calciteFab.textEnabled = true;
    labelFlowItem.appendChild(calciteFab);
    const labelComponent = document.createElement("arcgis-label");
    labelComponent.lang = currentLanguage;
    labelComponent.layer = layer;
    labelComponent.mapView = view;
    labelComponent.portal = portal;
    labelComponent.config = config;
    labelComponent.layerDisplayType = _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_5__.l.cluster;
    labelComponent.calciteFlowProps = { calciteFlowItem: labelFlowItem, calciteFab: calciteFab };
    labelComponent.addEventListener("labelUpdated", () => {
      this.internalChange.emit();
      (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.hostElement);
    });
    labelFlowItem.appendChild(labelComponent);
    flowNode.appendChild(labelFlowItem);
    setTimeout(() => requestAnimationFrame(() => labelFlowItem.setFocus()), 200);
  }
  addPopupPanel(event) {
    const { layer, view, portal, config, currentLanguage, strings, flowNode, hideLayerTitle } = this;
    event.stopPropagation();
    this.closePopovers();
    const popupFlowItem = document.createElement("calcite-flow-item");
    popupFlowItem.heading = strings.bin.popupsHeading;
    popupFlowItem.description = !hideLayerTitle ? layer.title : undefined;
    const calciteFab = document.createElement("calcite-fab");
    calciteFab.icon = "plus";
    calciteFab.slot = "fab";
    calciteFab.scale = "s";
    calciteFab.appearance = "outline-fill";
    calciteFab.kind = "neutral";
    calciteFab.label = strings.bin.popupFab;
    calciteFab.text = strings.bin.popupFab;
    calciteFab.textEnabled = true;
    popupFlowItem.appendChild(calciteFab);
    const popupComponent = document.createElement("arcgis-popup");
    popupComponent.lang = currentLanguage;
    popupComponent.layer = layer;
    popupComponent.mapView = view;
    popupComponent.portal = portal;
    popupComponent.config = config;
    popupComponent.layerDisplayType = _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_5__.l.cluster;
    popupComponent.calciteFlowProps = {
      flow: flowNode,
      calciteFab: calciteFab,
      calciteFlowItem: popupFlowItem
    };
    popupComponent.addEventListener("popupUpdated", () => {
      this.internalChange.emit();
      (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.hostElement);
    });
    popupFlowItem.appendChild(popupComponent);
    flowNode.appendChild(popupFlowItem);
    popupFlowItem.setFocus();
    setTimeout(() => requestAnimationFrame(() => popupFlowItem.setFocus()), 200);
  }
  get hostElement() { return (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.d)(this); }
};
ArcgisAggregationBinning.style = arcgisAggregationBinningCss;

const arcgisAggregationClusteringCss = ".block-section.sc-arcgis-aggregation-clustering{padding:0 10px}.block-content.sc-arcgis-aggregation-clustering{padding-top:10px}.symbol-button.sc-arcgis-aggregation-clustering{border:solid 1px var(--arcgis-app-border);display:flex;justify-content:space-between}.symbol-button.selected.sc-arcgis-aggregation-clustering{border-color:var(--calcite-ui-brand);border-width:1px}.symbol-button.sc-arcgis-aggregation-clustering:hover{background-color:var(--arcgis-app-background-hover);border-color:var(--arcgis-app-border-hover)}.symbol-button.sc-arcgis-aggregation-clustering:focus{border-color:var(--calcite-ui-brand);border-width:2px}.symbol.sc-arcgis-aggregation-clustering{padding:5px}.symbol-icon.sc-arcgis-aggregation-clustering{padding:6px}.slider-title-wrapper.sc-arcgis-aggregation-clustering{background-color:var(--arcgis-app-background);border-bottom:1px solid var(--arcgis-app-border);padding:var(--arcgis-app-cap-spacing) var(--arcgis-app-side-spacing)}.slider-div.sc-arcgis-aggregation-clustering{display:flex;align-items:center;justify-content:space-between;flex-flow:row wrap}.slider-heading.sc-arcgis-aggregation-clustering{display:inline-block;padding:var(--arcgis-app-cap-spacing-half) 0;font-size:var(--arcgis-app-font-size-0)}.slider-label.sc-arcgis-aggregation-clustering{display:inline-block;padding:var(--arcgis-app-cap-spacing-eighth) 0;font-size:var(--arcgis-app-font-size--1);order:2}.slider-slider.sc-arcgis-aggregation-clustering{display:inline-block;width:100%;order:1}.cluster-btn-section.sc-arcgis-aggregation-clustering{background-color:var(--arcgis-app-background)}.cluster-btn.sc-arcgis-aggregation-clustering{background:var(--arcgis-app-background-clear);border:none;border-bottom:solid 1px var(--arcgis-app-border);color:var(--arcgis-app-font-color);display:flex;align-items:center;justify-content:space-between;padding:var(--arcgis-app-cap-spacing) var(--arcgis-app-side-spacing);cursor:pointer;width:100%;transition:background-color var(--arcgis-app-animation-time-fast) var(--arcgis-app-easing-function), border-color var(--arcgis-app-animation-time-fast) var(--arcgis-app-easing-function)}.cluster-btn.sc-arcgis-aggregation-clustering:hover{background-color:var(--arcgis-app-background-hover);border-color:var(--arcgis-app-border-hover)}.cluster-btn.sc-arcgis-aggregation-clustering:focus{border:2px solid var(--calcite-ui-brand)}.cluster-btn-text.sc-arcgis-aggregation-clustering{font-family:var(--arcgis-app-font-family);font-size:var(--arcgis-app-font-size-0)}";

const ArcgisAggregationClustering = class {
  constructor(hostRef) {
    (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.r)(this, hostRef);
    this.arcgisAggregationClusteringChange = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "arcgisAggregationClusteringChange", 7);
    this.arcgisAggregationClusteringDismissedChange = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "arcgisAggregationClusteringDismissedChange", 7);
    this.calcitePanelBackClick = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "calcitePanelBackClick", 7);
    this.internalChange = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "internalChange", 7);
    this.closeLabelPopovers = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "closeLabelPopovers", 7);
    this.closePopupPopovers = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "closePopupPopovers", 7);
    this.closeAttributePopovers = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "closeAttributePopovers", 7);
    this.disableSizeSlider = false;
    this.view = undefined;
    this.layer = undefined;
    this.portal = undefined;
    this.config = undefined;
    this.flowNode = undefined;
    this.strings = undefined;
    this.currentLanguage = undefined;
    this.hideLayerTitle = false;
    this.symbolSelected = false;
  }
  // clone featureReduction to update map
  internalChangeHandler() {
    const { layer } = this;
    const featureReduction = layer.featureReduction;
    layer.featureReduction = featureReduction.clone();
    this.arcgisAggregationClusteringChange.emit();
  }
  //--------------------------------------------------------------------------
  //
  //  public calls
  //
  //--------------------------------------------------------------------------
  // Public Methods
  async done() {
    this.closePopovers();
  }
  async setFocus() {
    this.flowItemNode.setFocus();
  }
  //--------------------------------------------------------------------------
  //
  //  Lifecycle
  //
  //--------------------------------------------------------------------------
  async componentWillLoad() {
    // only valid for point
    this.layerGeometryType = await (0,_commonFunctions_5262b094_js__WEBPACK_IMPORTED_MODULE_4__.h)(this.layer);
    const [popupUtils, symbolUtils, cimSymbolUtils, Color, SimpleMarkerSymbol, SimpleLineSymbol] = await (0,_loadModules_aaf30bd6_js__WEBPACK_IMPORTED_MODULE_3__.l)([
      "esri/smartMapping/popup/support/utils",
      "esri/symbols/support/symbolUtils",
      "esri/symbols/support/cimSymbolUtils",
      "esri/Color",
      "esri/symbols/SimpleMarkerSymbol",
      "esri/symbols/SimpleLineSymbol"
    ]);
    this.modules = {
      symbolUtils,
      cimSymbolUtils,
      Color,
      SimpleMarkerSymbol,
      SimpleLineSymbol
    };
    // disable size range slider for "size" renderer. undocumented function.
    const visualVariables = popupUtils.getPrimaryVisualVariables(this.layer.renderer);
    this.disableSizeSlider = visualVariables.some((variable) => {
      return (variable === null || variable === void 0 ? void 0 : variable.type) === "size";
    });
  }
  componentDidLoad() {
    setTimeout(() => requestAnimationFrame(() => this.flowItemNode.setFocus()), 200);
  }
  componentDidUpdate() {
    //this.internalChange.emit();
  }
  disconnectedCallback() {
    this.closePopovers();
  }
  // --------------------------------------------------------------------------
  //
  //  Render Methods
  //
  //--------------------------------------------------------------------------
  render() {
    const { layer, strings, hideLayerTitle } = this;
    //const featureReduction = layer.featureReduction as any; //__esri.FeatureReductionCluster;
    const showSymbol = isRendererAutoGenerated(layer);
    const aggregationType = getAggregationType(layer);
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)(_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.H, { class: "calcite-match-height" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-flow-item", { heading: strings.clustering, description: !hideLayerTitle ? layer.title : undefined, onCalciteFlowItemBack: () => {
        this.calcitePanelBackClick.emit();
        //this.closePopovers();
      }, ref: (node) => (this.flowItemNode = node) }, showSymbol && this.renderSymbol(), aggregationType === "pie-chart" && this.renderShape(), this.renderClusterRadius(), this.renderClusterSize(), this.renderFieldsBtn(), this.renderLabelBtn(), this.renderPopupBtn())));
  }
  renderSymbol() {
    const { layer, strings } = this;
    const featureReduction = layer.featureReduction; //__esri.FeatureReductionCluster;
    const hasSymbol = !!featureReduction.symbol;
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-block-section", { text: strings.cluster.overrideSymbol, open: hasSymbol, "toggle-display": "switch", class: "block-section", onCalciteBlockSectionToggle: (event) => {
        this.handleToggleSymbol(event);
      } }, this.renderSymbolContent()));
  }
  renderSymbolContent() {
    const { layer, symbolSelected, strings } = this;
    const featureReduction = layer.featureReduction; //__esri.FeatureReductionCluster;
    if (!featureReduction.symbol) {
      return;
    }
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "block-content" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-label", null, strings.symbolStyle, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: `symbol-button ${symbolSelected ? `selected` : ``}`, tabindex: "0", role: "button", "aria-label": strings.symbolStyle, onClick: (event) => this.openSymbolStylerPopover(event) }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "symbol", ref: (node) => this.createSymbolPreview(node) }), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-icon", { scale: "s", icon: "pencil", class: "symbol-icon" })))));
  }
  renderShape() {
    var _a;
    const { layer, strings } = this;
    // need to switch labels back in rtl
    const rtl = (0,_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_1__.g)(this.hostElement) === "rtl";
    const featureReduction = layer.featureReduction; //__esri.FeatureReductionCluster;
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "slider-title-wrapper" }, " ", (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-label", null, strings.cluster.shape, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "slider-div" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("label", { class: "slider-label" }, rtl ? strings.cluster.donut : strings.cluster.pie), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-slider", { class: "slider-slider", min: 0, max: Math.max(0.9, featureReduction.renderer.holePercentage), value: (_a = featureReduction.renderer.holePercentage) !== null && _a !== void 0 ? _a : 0, step: 0.1, minLabel: strings.cluster.shape, onCalciteSliderInput: (event) => {
        const featureReduction = layer.featureReduction; //__esri.FeatureReductionCluster;
        const slider = event.target;
        featureReduction.renderer.holePercentage = slider.value;
        this.internalChange.emit();
      } }), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("label", { class: "slider-label" }, rtl ? strings.cluster.pie : strings.cluster.donut)))));
  }
  renderClusterRadius() {
    var _a;
    const { layer, strings } = this;
    // need to switch labels back in rtl
    const rtl = (0,_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_1__.g)(this.hostElement) === "rtl";
    const featureReduction = layer.featureReduction;
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "slider-title-wrapper" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("label", { class: "slider-heading" }, strings.cluster.radiusTitle), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "slider-div" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("label", { class: "slider-label" }, rtl ? strings.cluster.high : strings.cluster.low), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-slider", { class: "slider-slider", min: clusteringRadiusMinVal, max: clusteringRadiusMaxVal, value: (_a = featureReduction.clusterRadius) !== null && _a !== void 0 ? _a : clusteringRadiusInitialVal, step: 1, minLabel: strings.cluster.radiusTitle, onCalciteSliderInput: (event) => {
        const featureReduction = layer.featureReduction;
        const slider = event.target;
        featureReduction.clusterRadius = slider.value;
        this.internalChange.emit();
      } }), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("label", { class: "slider-label" }, rtl ? strings.cluster.low : strings.cluster.high))));
  }
  renderClusterSize() {
    var _a, _b;
    const { layer, strings, disableSizeSlider } = this;
    // need to switch labels back in rtl
    const rtl = (0,_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_1__.g)(this.hostElement) === "rtl";
    const featureReduction = layer.featureReduction;
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "slider-title-wrapper" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("label", { class: "slider-heading" }, strings.cluster.sizeTitle), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "slider-div" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("label", { class: "slider-label" }, rtl ? strings.cluster.max : strings.cluster.min), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-slider", { class: "slider-slider", min: clusteringSizeMinVal, max: clusteringSizeMaxVal, minValue: (_a = featureReduction.clusterMinSize) !== null && _a !== void 0 ? _a : clusteringSizeMinVal, maxValue: (_b = featureReduction.clusterMaxSize) !== null && _b !== void 0 ? _b : clusteringSizeMaxVal, step: 1, disabled: disableSizeSlider, minLabel: `${strings.cluster.min} ${strings.cluster.sizeTitle}`, maxLabel: `${strings.cluster.max} ${strings.cluster.sizeTitle}`, onCalciteSliderInput: (event) => {
        const featureReduction = layer.featureReduction;
        const slider = event.target;
        featureReduction.clusterMinSize = slider.minValue;
        featureReduction.clusterMaxSize = slider.maxValue;
        this.internalChange.emit();
      } }), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("label", { class: "slider-label" }, rtl ? strings.cluster.min : strings.cluster.max))));
  }
  /* renderScaleThreshold(): VNode {
    /
    World
    Continent    1:50,000,000
    Countries - big    1:25,000,000
    Countries - small    1:12,000,000
    States/Provinces    1:6,000,000
    State/Province    1:3,000,000
    Counties    1:1,500,000
    County    1:750,000
    Metropolitan area    1:320,000
    Cities    1:160,000
    City    1:80,000
    Town    1:40,000
    Neighborhood    1:20,000
    Streets    1:10,000
    Street    1:5,000
    /
    const { layer, strings } = this;
    // need to switch labels back in rtl
    const rtl = getElementDir(this.hostElement) === "rtl";
    const featureReduction = layer.featureReduction as any; //__esri.FeatureReductionCluster;
    if (
      featureReduction.visibilityInfo &&
      featureReduction.visibilityInfo.thresholdType !== "scale"
    ) {
      return;
    }
    const worldScale = 295828764;
    const threshold = featureReduction.visibilityInfo?.maxScale || worldScale;
    const scaleStops = [
      worldScale,
      50000000,
      25000000,
      12000000,
      6000000,
      3000000,
      1500000,
      750000,
      320000,
      160000,
      80000,
      40000,
      20000,
      10000,
      5000
    ];
    const findStop = (value: number): number => {
      let index = 0;
      scaleStops.forEach((stop: number, idx: number) => {
        if (idx === 0) {
          if (stop < value) {
            index = 0;
          }
        } else if (idx === scaleStops.length - 1) {
          if (stop >= value) {
            index = scaleStops.length - 1;
          }
        } else {
          if (stop <= value && scaleStops[idx - 1] > value) {
            index = idx - 1 + (scaleStops[idx - 1] - value) / (scaleStops[idx - 1] - stop);
          }
        }
      });
      return index;
    };
    return (
      <div class="slider-title-wrapper">
        <label class="slider-heading">{strings.cluster.scaleThreshold}</label>
        <div class="slider-div">
          <label class="slider-label">
            {rtl ? strings.cluster.streetScaleLabel : <span>&nbsp;</span>}
          </label>
          <calcite-slider
            class="slider-slider"
            min={0}
            max={14}
            value={findStop(threshold)}
            step={0.1}
            minLabel={strings.cluster.scaleThreshold}
            onCalciteSliderInput={(event: CustomEvent) => {
              const slider = event.target as HTMLCalciteSliderElement;
              const value = slider.value as number;
              const stopMin = scaleStops[Math.ceil(value)];
              const stopMax = scaleStops[Math.floor(value)];
              let threshold = Math.round(
                stopMin + (value - Math.floor(value)) * (stopMax - stopMin)
              );
              console.log("TODO: set scale threshold to", threshold);
              const featureReduction = layer.featureReduction as any; //__esri.FeatureReductionCluster;
              featureReduction.visibilityInfo = { maxScale: threshold, thresholdType: "scale" };
              this.internalChange.emit();
            }}
          ></calcite-slider>
          <label class="slider-label">
            {rtl ? <span>&nbsp;</span> : strings.cluster.streetScaleLabel}
          </label>
        </div>
      </div>
    );
  } */
  renderFieldsBtn() {
    const { strings } = this;
    const rtl = (0,_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_1__.g)(this.hostElement) === "rtl";
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "cluster-btn-section" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("button", { class: "cluster-btn", onClick: (event) => this.addFieldsPanel(event), ref: (node) => (this.fieldsButtonNode = node) }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("span", { class: "cluster-btn-text" }, strings.cluster.editClusterAttributes), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("span", { class: "cluster-btn-icon" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-icon", { scale: "s", icon: rtl ? "chevron-left" : "chevron-right" })))));
  }
  renderLabelBtn() {
    const { strings } = this;
    const rtl = (0,_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_1__.g)(this.hostElement) === "rtl";
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "cluster-btn-section" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("button", { class: "cluster-btn", onClick: (event) => this.addLabelPanel(event), ref: (node) => (this.labelsButtonNode = node) }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("span", { class: "cluster-btn-text" }, strings.cluster.editClusterLabel), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("span", { class: "cluster-btn-icon" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-icon", { scale: "s", icon: rtl ? "chevron-left" : "chevron-right" })))));
  }
  renderPopupBtn() {
    const { strings } = this;
    const rtl = (0,_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_1__.g)(this.hostElement) === "rtl";
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "cluster-btn-section" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("button", { class: "cluster-btn", onClick: (event) => this.addPopupPanel(event), ref: (node) => (this.popupButtonNode = node) }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("span", { class: "cluster-btn-text" }, strings.cluster.editClusterPopups), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("span", { class: "cluster-btn-icon" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-icon", { scale: "s", icon: rtl ? "chevron-left" : "chevron-right" })))));
  }
  // --------------------------------------------------------------------------
  //
  //  Private methods
  //
  // --------------------------------------------------------------------------
  closePopovers() {
    var _a, _b;
    this.closeAttributePopovers.emit();
    this.closeLabelPopovers.emit();
    this.closePopupPopovers.emit();
    (_b = (_a = this.stylerPopoverNode) === null || _a === void 0 ? void 0 : _a.parentElement) === null || _b === void 0 ? void 0 : _b.removeChild(this.stylerPopoverNode);
    this.stylerPopoverNode = null;
  }
  handleToggleSymbol(event) {
    const { layer, modules } = this;
    const featureReduction = layer.featureReduction; //__esri.FeatureReductionCluster;
    const section = event.currentTarget;
    if (section.open) {
      if (this.lastSymbol) {
        featureReduction.symbol = this.lastSymbol;
        this.lastSymbol = undefined;
      }
      else {
        featureReduction.symbol = getDefaultSymbol(modules);
      }
    }
    else {
      this.lastSymbol = featureReduction.symbol;
      featureReduction.symbol = undefined;
    }
    this.internalChange.emit();
    (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.hostElement);
  }
  createSymbolPreview(containerNode) {
    const { layer, modules } = this;
    const { symbolUtils } = modules;
    const featureReduction = layer.featureReduction; //__esri.FeatureReductionCluster;
    if (!featureReduction.symbol) {
      return;
    }
    const symbol = featureReduction.symbol;
    const size = symbol.type === "cim" ? 20 : 14;
    symbolUtils
      .renderPreviewHTML(symbol, {
      size,
      symbolConfig: undefined
    })
      .then((node) => {
      containerNode.childNodes.forEach((child) => containerNode.removeChild(child));
      containerNode.appendChild(node);
    });
  }
  async openSymbolStylerPopover(event) {
    const { layer, portal, strings } = this;
    const refElement = findParentNode(event.target, null, "symbol-button");
    if (this.stylerPopoverNode) {
      this.symbolSelected = false;
      this.closePopovers();
      this.stylerPopoverNode = null;
    }
    else {
      this.closePopovers();
      this.symbolSelected = true;
      this.stylerPopoverNode = document.createElement("arcgis-aggregation-symbol-styler-popover");
      this.stylerPopoverNode.props = { layer, portal, strings };
      this.stylerPopoverNode.referenceElement = this.flowItemNode;
      this.stylerPopoverNode.addEventListener("arcgisAggregationSymbolStylerPopoverClose", () => {
        this.closePopovers();
        this.symbolSelected = false;
        // if we do this too early the enter key executes on the focused div
        setTimeout(() => refElement.focus(), 300);
      });
      this.stylerPopoverNode.addEventListener("arcgisAggregationSymbolStylerChange", () => {
        this.internalChange.emit();
        (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.hostElement);
      });
      document.body.appendChild(this.stylerPopoverNode);
      this.stylerPopoverNode.setOpen(true);
    }
  }
  addFieldsPanel(event) {
    event.stopPropagation();
    this.closePopovers();
    const { layer, view, currentLanguage, strings, flowNode, hideLayerTitle } = this;
    const fieldsNode = document.createElement("arcgis-aggregation-fields");
    fieldsNode.lang = currentLanguage;
    fieldsNode.layer = layer;
    fieldsNode.mapView = view;
    fieldsNode.strings = strings;
    fieldsNode.currentLanguage = currentLanguage;
    fieldsNode.hideLayerTitle = hideLayerTitle;
    fieldsNode.flowNode = flowNode;
    fieldsNode.addEventListener("arcgisAggregationFieldsChange", () => {
      this.internalChange.emit();
      (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.hostElement);
    });
    fieldsNode.addEventListener("arcgisAggregationFieldsBackClick", () => {
      flowNode.removeChild(fieldsNode);
      setTimeout(() => this.fieldsButtonNode.focus(), 300);
    });
    flowNode.appendChild(fieldsNode);
  }
  addLabelPanel(event) {
    const { layer, view, portal, config, currentLanguage, strings, flowNode, hideLayerTitle } = this;
    event.stopPropagation();
    this.closePopovers();
    const labelFlowItem = document.createElement("calcite-flow-item");
    //labelFlowItem.id = "labelFlowItem_Id";
    labelFlowItem.heading = strings.cluster.labelFeaturesHeading;
    labelFlowItem.description = !hideLayerTitle ? layer.title : undefined;
    const calciteFab = document.createElement("calcite-fab");
    calciteFab.icon = "plus";
    calciteFab.slot = "fab";
    calciteFab.scale = "s";
    calciteFab.appearance = "outline-fill";
    calciteFab.kind = "neutral";
    calciteFab.label = strings.cluster.labelFab;
    calciteFab.text = strings.cluster.labelFab;
    calciteFab.textEnabled = true;
    labelFlowItem.appendChild(calciteFab);
    const labelComponent = document.createElement("arcgis-label");
    labelComponent.lang = currentLanguage;
    labelComponent.layer = layer;
    labelComponent.mapView = view;
    labelComponent.portal = portal;
    labelComponent.config = config;
    labelComponent.layerDisplayType = _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_5__.l.cluster;
    labelComponent.calciteFlowProps = { calciteFlowItem: labelFlowItem, calciteFab: calciteFab };
    labelComponent.addEventListener("labelUpdated", () => {
      this.internalChange.emit();
      (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.hostElement);
    });
    labelFlowItem.appendChild(labelComponent);
    labelFlowItem.addEventListener("calciteFlowItemBack", () => {
      setTimeout(() => this.labelsButtonNode.focus(), 300);
    });
    flowNode.appendChild(labelFlowItem);
    setTimeout(() => requestAnimationFrame(() => labelFlowItem.setFocus()), 200);
  }
  addPopupPanel(event) {
    const { layer, view, portal, config, currentLanguage, strings, flowNode, hideLayerTitle } = this;
    event.stopPropagation();
    this.closePopovers();
    const popupFlowItem = document.createElement("calcite-flow-item");
    popupFlowItem.heading = strings.cluster.popupsHeading;
    popupFlowItem.description = !hideLayerTitle ? layer.title : undefined;
    const calciteFab = document.createElement("calcite-fab");
    calciteFab.icon = "plus";
    calciteFab.slot = "fab";
    calciteFab.scale = "s";
    calciteFab.appearance = "outline-fill";
    calciteFab.kind = "neutral";
    calciteFab.label = strings.cluster.popupFab;
    calciteFab.text = strings.cluster.popupFab;
    calciteFab.textEnabled = true;
    popupFlowItem.appendChild(calciteFab);
    const popupComponent = document.createElement("arcgis-popup");
    popupComponent.lang = currentLanguage;
    popupComponent.layer = layer;
    popupComponent.mapView = view;
    popupComponent.portal = portal;
    popupComponent.config = config;
    popupComponent.layerDisplayType = _commonEnums_f98a323c_js__WEBPACK_IMPORTED_MODULE_5__.l.cluster;
    popupComponent.calciteFlowProps = {
      flow: flowNode,
      calciteFab: calciteFab,
      calciteFlowItem: popupFlowItem
    };
    popupComponent.addEventListener("popupUpdated", () => {
      this.internalChange.emit();
      (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.hostElement);
    });
    popupFlowItem.appendChild(popupComponent);
    popupFlowItem.addEventListener("calciteFlowItemBack", () => {
      setTimeout(() => this.popupButtonNode.focus(), 300);
    });
    flowNode.appendChild(popupFlowItem);
    setTimeout(() => requestAnimationFrame(() => popupFlowItem.setFocus()), 200);
  }
  get hostElement() { return (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.d)(this); }
};
ArcgisAggregationClustering.style = arcgisAggregationClusteringCss;

const arcgisAggregationFieldCss = ".section.sc-arcgis-aggregation-field{padding-top:15px}.format.sc-arcgis-aggregation-field{padding-top:20px}";

const ArcgisAggregationField = class {
  constructor(hostRef) {
    (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.r)(this, hostRef);
    this.arcgisAggregationFieldChange = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "arcgisAggregationFieldChange", 7);
    this.onFieldSelect = () => {
      // not for autoGenerated fields
      //this.hasFocus = true;
      const { layer, mapView, aggregateField, fieldPickListSortBy, strings } = this;
      //const dir = getElementDir(this.hostElement);
      //this.closeFilterPopoversHandler();
      const flowItemNode = findParentNode(this.hostElement, "calcite-flow-item");
      const nodeWidth = flowItemNode.getBoundingClientRect().width || 215;
      this.arcgisFieldPickList = document.createElement("arcgis-field-pick-list");
      this.arcgisFieldPickList.popoverProps = {
        placement: "auto",
        offsetDistance: -1 * (nodeWidth + 10),
        offsetSkidding: 0,
        pointerDisabled: true,
        popoverWidth: nodeWidth + 30,
        refElement: flowItemNode
      };
      this.arcgisFieldPickList.fields = this.createPickListFields();
      this.arcgisFieldPickList.layer = layer;
      this.arcgisFieldPickList.mapView = mapView;
      this.arcgisFieldPickList.showFieldInfo = true;
      this.arcgisFieldPickList.showFieldName = false;
      this.arcgisFieldPickList.selectedFields = [aggregateField.onStatisticField];
      this.arcgisFieldPickList.sortBy = fieldPickListSortBy;
      this.arcgisFieldPickList.addEventListener("arcgisFieldPickListDismissed", (event) => {
        var _a, _b;
        event.stopPropagation();
        const selectedField = (_b = (_a = event.detail) === null || _a === void 0 ? void 0 : _a.selectedFields) === null || _b === void 0 ? void 0 : _b[0];
        flowItemNode.disabled = false;
        if (this.arcgisFieldPickList) {
          document.body.removeChild(this.arcgisFieldPickList);
          this.arcgisFieldPickList = null;
          setTimeout(() => {
            this.fieldNode.setFocus();
          }, 1);
        }
        if (selectedField) {
          const { aggregateField } = this;
          const field = getLayerField(layer, selectedField);
          // check if we have this field already...
          const types = getStatsTypes(field);
          let idxType = 0;
          let hasAlready = hasFieldAlready(layer, field.name, types[idxType]);
          while (idxType < types.length && hasAlready) {
            idxType++;
            if (types[idxType] === aggregateField.statisticType) {
              // skip the current one
              idxType++;
            }
            if (idxType < types.length) {
              hasAlready = hasFieldAlready(layer, field.name, types[idxType]);
            }
          }
          if (hasAlready) {
            // all statisticTypes already exist for this field; can't change to this field
            return;
          }
          const oldFieldName = aggregateField.name;
          const type = types[idxType];
          aggregateField.name = `${field.name}_${type}`;
          aggregateField.onStatisticField = field.name;
          aggregateField.alias = `${field.alias || field.name} ${getStatsTypeString(type, strings).toLowerCase()}`;
          aggregateField.statisticType = type;
          this.replacePopupField(oldFieldName);
          this.arcgisAggregationFieldChange.emit();
        } // else user hit cancel or close
      });
      this.arcgisFieldPickList.addEventListener("arcgisFieldPickListSortByChange", (event) => (this.fieldPickListSortBy = event.detail));
      document.body.appendChild(this.arcgisFieldPickList);
      flowItemNode.disabled = true;
    };
    this.mapView = undefined;
    this.layer = undefined;
    this.aggregateField = undefined;
    this.open = false;
    this.strings = undefined;
    this.currentLanguage = undefined;
  }
  //--------------------------------------------------------------------------
  //
  //  public calls
  //
  //--------------------------------------------------------------------------
  // Public Methods
  async done() {
    this.closePopovers();
  }
  async setFocus() {
    this.panelNode.setFocus();
  }
  //--------------------------------------------------------------------------
  //
  //  Lifecycle
  //
  //--------------------------------------------------------------------------
  async componentWillLoad() {
    const [FieldInfo, FieldInfoFormat] = await (0,_loadModules_aaf30bd6_js__WEBPACK_IMPORTED_MODULE_3__.l)([
      "esri/popup/FieldInfo",
      "esri/popup/support/FieldInfoFormat"
    ]);
    this.modules = {
      FieldInfo,
      FieldInfoFormat
    };
    // make sure the field exists in the popup
    const { layer, aggregateField, modules } = this;
    let fieldInfo = getPopupFieldInfo(layer, aggregateField.name);
    if (!fieldInfo) {
      addPopupField(aggregateField, layer, modules);
    }
  }
  disconnectedCallback() {
    this.closePopovers();
  }
  // --------------------------------------------------------------------------
  //
  //  Render Methods
  //
  //--------------------------------------------------------------------------
  render() {
    /*
    {
      "name": "FieldName",
      "alias": "The field alias",
      "onStatisticField": "Layer field",
      "onStatisticExpression": {
        "expression": "Arcade expression goes here",
        "returnType": "<string | number>"
      },
      "statisticType": "<count | sum | min | max | mode | avg | stddev | var>",
      "isInferred": <boolean>  // only needed for Online
    }
    */
    const { layer, aggregateField, open } = this;
    const dir = (0,_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_1__.g)(this.hostElement);
    const fieldInfo = getPopupFieldInfo(layer, aggregateField.name);
    const alias = (aggregateField.isAutoGenerated ? fieldInfo.label : aggregateField.alias) ||
      aggregateField.name;
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)(_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.H, { dir: dir }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-block", { heading: alias, open: open, collapsible: true, ref: (node) => (this.blockNode = node), onCalciteBlockToggle: (event) => {
        const node = event.target;
        this.open = node.open;
      } }, this.renderDropdown(), this.renderFieldSelection(), this.renderTypeSelection(), this.renderResultFieldName(), this.renderFieldAlias(), this.renderFormatting())));
  }
  renderDropdown() {
    const { layer, aggregateField, strings } = this;
    const field = getLayerField(layer, aggregateField.onStatisticField);
    if (aggregateField.isAutoGenerated || !field) {
      return null;
    }
    const dir = (0,_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_1__.g)(this.hostElement);
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { slot: "control" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-dropdown", { dir: dir, placement: "bottom-end", scale: "s", overlayPositioning: "fixed" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { ref: (node) => (this.dropdownActionNode = node), slot: "trigger", scale: "m", text: strings.delete }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-icon", { scale: "s", icon: "ellipsis" })), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-dropdown-group", null, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-dropdown-item", { onClick: (event) => {
        event.stopPropagation();
        this.removeField();
      }, onKeyDown: (event) => {
        event.stopPropagation();
        if (event.key === " " || event.key === "Enter") {
          this.removeField();
        }
      } }, strings.delete)))));
  }
  renderFieldSelection() {
    const { aggregateField, strings } = this;
    if (!aggregateField.onStatisticField) {
      // e.g. cluster_count or onStatisticsExpression
      return null;
    }
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)(_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.F, null, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-label", null, strings.fields.field), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { appearance: "outline-fill", kind: "neutral", width: "full", scale: "m", alignment: "icon-end-space-between", iconEnd: "chevron-down", disabled: aggregateField.isAutoGenerated, onClick: () => this.onFieldSelect(), ref: (node) => (this.fieldNode = node) }, aggregateField.onStatisticField)));
  }
  renderTypeSelection() {
    const { layer, aggregateField, strings } = this;
    const field = getLayerField(layer, aggregateField.onStatisticField);
    const isString = (field === null || field === void 0 ? void 0 : field.type) === "string";
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "section" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-label", null, strings.fields.statsType), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-select", { width: "full", scale: "m", label: strings.fields.statsType, disabled: aggregateField.isAutoGenerated || !field, onCalciteSelectChange: (event) => {
        // disabled for autoGenerated fields
        const node = event === null || event === void 0 ? void 0 : event.target;
        const type = node.selectedOption.value;
        const oldFieldName = aggregateField.name;
        aggregateField.name = `${field.name}_${type}`;
        aggregateField.onStatisticField = field.name;
        aggregateField.alias = `${field.alias || field.name} ${getStatsTypeString(type, strings).toLowerCase()}`;
        aggregateField.statisticType = type;
        this.replacePopupField(oldFieldName);
        this.arcgisAggregationFieldChange.emit();
      } }, !isString && this.renderTypeOption("sum"), !isString && this.renderTypeOption("avg"), !isString && this.renderTypeOption("min"), !isString && this.renderTypeOption("max"), this.renderTypeOption("mode"), aggregateField.statisticType === "count" && this.renderTypeOption("count"))));
  }
  renderTypeOption(type) {
    const { layer, aggregateField, strings } = this;
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-option", { value: type, label: getStatsTypeString(type, strings), disabled: aggregateField.statisticType !== type &&
        hasFieldAlready(layer, aggregateField.onStatisticField, type), selected: aggregateField.statisticType === type }));
  }
  renderResultFieldName() {
    const { aggregateField, strings } = this;
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "section" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-label", null, strings.fields.resultFieldName), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-input", { type: "text", disabled: true, value: aggregateField.name, scale: "m", label: strings.fields.resultFieldName })));
  }
  renderFieldAlias() {
    const { layer, aggregateField, strings } = this;
    const fieldInfo = getPopupFieldInfo(layer, aggregateField.name);
    const alias = (aggregateField.isAutoGenerated ? fieldInfo.label : aggregateField.alias) ||
      aggregateField.name;
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "section" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-label", null, strings.fields.fieldAlias), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-input", { type: "text", value: alias, scale: "m", label: strings.fields.fieldAlias, onCalciteInputInput: (event) => {
        const node = event.target;
        let alias = node.value;
        this.blockNode.heading = alias;
        if (!alias) {
          // let's give the user time to fill it in;
          // if not we default to something
          setTimeout(() => {
            const fieldInfo = getPopupFieldInfo(layer, aggregateField.name);
            const curAlias = aggregateField.isAutoGenerated
              ? fieldInfo.label
              : aggregateField.alias;
            if (!curAlias) {
              const field = getLayerField(layer, aggregateField.onStatisticField);
              alias = `${field.alias || field.name} ${getStatsTypeString(aggregateField.statisticType, strings).toLocaleLowerCase()}`;
              this.blockNode.heading = alias;
              node.value = alias;
            }
            this.updateAlias(alias);
          }, 2000);
        }
        else {
          this.updateAlias(alias);
        }
      } })));
  }
  renderFormatting() {
    const { layer, aggregateField, modules, strings } = this;
    const { FieldInfoFormat } = modules;
    const featureReduction = layer.featureReduction;
    const popupTemplate = featureReduction.popupTemplate;
    const layerField = getLayerField(layer, aggregateField.onStatisticField);
    if ((!layerField && aggregateField.statisticType !== "count") ||
      (layerField === null || layerField === void 0 ? void 0 : layerField.type) === "string") {
      return null;
    }
    let fieldInfo = popupTemplate.fieldInfos.find((fieldInfo) => fieldInfo.fieldName === aggregateField.name);
    fieldInfo.format =
      fieldInfo.format ||
        new FieldInfoFormat({ dijitSeparator: true, places: 0 });
    const isInt = !layerField || ["integer", "small-integer", "big-integer"].indexOf(layerField.type) > -1;
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "format" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-label", { scale: "l" }, strings.fields.formatting), !isInt && this.renderSignificantDigits(fieldInfo.format), this.renderThousandSeperator(fieldInfo.format)));
  }
  renderThousandSeperator(format) {
    const { strings } = this;
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("section", null, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-label", { layout: "inline-space-between" }, strings.fields.show1000Separator, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-switch", { scale: "s", checked: format.digitSeparator, onCalciteSwitchChange: (event) => {
        const node = event === null || event === void 0 ? void 0 : event.target;
        format.digitSeparator = node.checked;
        this.arcgisAggregationFieldChange.emit();
      } }))));
  }
  renderSignificantDigits(format) {
    const { strings } = this;
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("section", null, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-label", null, strings.fields.significantDigits, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-select", { label: strings.fields.significantDigits, onCalciteSelectChange: (event) => {
        const node = event.target;
        format.places = Number(node.selectedOption.value) || 0;
        this.arcgisAggregationFieldChange.emit();
      } }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-option", { value: "0", selected: format.places === 0 }, strings.fields.decimalPlaces0), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-option", { value: "1", selected: format.places === 1 }, strings.fields.decimalPlaces1), [2, 3, 4, 5, 6, 7, 8].map((x) => ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-option", { value: x.toString(), selected: format.places === x }, strings.fields.decimalPlacesN.replace("${num}", `${x}`))))))));
  }
  // --------------------------------------------------------------------------
  //
  //  Private methods
  //
  // --------------------------------------------------------------------------
  closePopovers() {
    if (this.arcgisFieldPickList) {
      document.body.removeChild(this.arcgisFieldPickList);
      this.arcgisFieldPickList = null;
    }
  }
  removeField() {
    const { layer, aggregateField } = this;
    const featureReduction = layer.featureReduction;
    const popupTemplate = featureReduction.popupTemplate;
    let idx = popupTemplate.fieldInfos.findIndex((fieldInfo) => fieldInfo.fieldName === aggregateField.name);
    idx >= 0 && popupTemplate.fieldInfos.splice(idx, 1);
    idx = featureReduction.fields.findIndex((af /* __esri.AggregateField */) => af.name === aggregateField.name);
    featureReduction.fields.splice(idx, 1);
    this.arcgisAggregationFieldChange.emit();
  }
  createPickListFields() {
    const { layer, aggregateField } = this;
    const { fields } = layer;
    const layerFields = fields.filter((field) => ["small-integer", "big-integer", "integer", "single", "double", "long", "number", "string"].indexOf(field.type) > -1);
    return layerFields
      .filter((field) => aggregateField.onStatisticField === field.name || !isFieldDone(layer, field.name))
      .map((field) => {
      return {
        name: field.name,
        alias: field.alias,
        type: field.type
      };
    });
  }
  replacePopupField(oldName) {
    // after changing field or stats types
    // not for autoGenerated fields
    const { layer, aggregateField, modules } = this;
    const { FieldInfo } = modules;
    const featureReduction = layer.featureReduction;
    const { popupTemplate } = featureReduction;
    popupTemplate.fieldInfos = popupTemplate.fieldInfos || [];
    const idxPopup = popupTemplate.fieldInfos.findIndex((fieldInfo) => fieldInfo.fieldName === oldName);
    const field = getLayerField(layer, aggregateField.onStatisticField);
    popupTemplate.fieldInfos.splice(idxPopup, 1, new FieldInfo({
      fieldName: aggregateField.name,
      label: aggregateField.alias,
      isEditable: false,
      visible: true,
      format: field.type === "string"
        ? undefined
        : ["small-integer", "big-integer", "integer", "long", "number"].indexOf(field.type) > -1
          ? {
            digitSeparator: true
          }
          : {
            digitSeparator: true,
            places: 1
          }
    }));
  }
  updateAlias(alias) {
    const { layer, aggregateField } = this;
    const fieldInfo = getPopupFieldInfo(layer, aggregateField.name);
    if (aggregateField.isAutoGenerated) {
      // featureReduction.clone() will remove the alias from the aggregation field
      fieldInfo.label = alias;
    }
    else {
      aggregateField.alias = alias;
    }
    this.updatePopupAlias();
    this.arcgisAggregationFieldChange.emit();
  }
  updatePopupAlias() {
    const { layer, aggregateField } = this;
    const featureReduction = layer.featureReduction;
    const fieldInfo = getPopupFieldInfo(layer, aggregateField.name);
    const alias = aggregateField.isAutoGenerated ? fieldInfo.label : aggregateField.alias;
    // main fieldInfos
    if (!aggregateField.isAutoGenerated) {
      fieldInfo.label = alias;
    }
    // search fieldInfos under content
    if (Array.isArray(featureReduction.popupTemplate.content) &&
      featureReduction.popupTemplate.content.length) {
      featureReduction.popupTemplate.content.forEach((content) => {
        if (content.type === "fields" && content.fieldInfos) {
          const fieldInfo = content.fieldInfos.find((fieldInfo) => fieldInfo.fieldName === aggregateField.name);
          if (fieldInfo) {
            fieldInfo.label = alias;
          }
        }
      });
    }
  }
  get hostElement() { return (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.d)(this); }
};
ArcgisAggregationField.style = arcgisAggregationFieldCss;

const arcgisAggregationFieldsCss = ".fields.sc-arcgis-aggregation-fields{background-color:white}.field-icon.sc-arcgis-aggregation-fields{padding:0 var(--arcgis-app-cap-spacing);display:flex;align-items:center}";

const ArcgisAggregationFields = class {
  constructor(hostRef) {
    (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.r)(this, hostRef);
    this.arcgisAggregationFieldsChange = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "arcgisAggregationFieldsChange", 7);
    this.arcgisAggregationFieldsClose = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "arcgisAggregationFieldsClose", 7);
    this.arcgisAggregationFieldsBackClick = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "arcgisAggregationFieldsBackClick", 7);
    this.allFieldsAdded = false;
    this.mapView = undefined;
    this.layer = undefined;
    this.flowNode = undefined;
    this.strings = undefined;
    this.currentLanguage = undefined;
    this.hideLayerTitle = false;
  }
  //--------------------------------------------------------------------------
  //
  //  public calls
  //
  //--------------------------------------------------------------------------
  // Public Methods
  async done() {
    this.closePopovers();
  }
  async setFocus() {
    this.flowItemNode.setFocus();
  }
  //--------------------------------------------------------------------------
  //
  //  Lifecycle
  //
  //--------------------------------------------------------------------------
  async componentWillLoad() {
    const [AggregateField, FieldInfo] = await (0,_loadModules_aaf30bd6_js__WEBPACK_IMPORTED_MODULE_3__.l)([
      "esri/layers/support/AggregateField",
      "esri/popup/FieldInfo"
    ]);
    this.modules = {
      AggregateField,
      FieldInfo
    };
  }
  componentDidLoad() {
    setTimeout(() => requestAnimationFrame(() => this.flowItemNode.setFocus()), 200);
  }
  disconnectedCallback() {
    this.closePopovers();
  }
  // --------------------------------------------------------------------------
  //
  //  Render Methods
  //
  //--------------------------------------------------------------------------
  render() {
    /*
    {
      name: "cluster_count",
      alias: "aggregateCount",
      type: "esriFieldTypeUnsignedInteger", // If this is a valid type...
      statisticType: "count",
      isInferred: true,
    }
    */
    const { layer, strings, hideLayerTitle } = this;
    const featureReduction = layer.featureReduction; //__esri.FeatureReductionCluster;
    const statsFields = featureReduction.fields;
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)(_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.H, { class: "calcite-match-height" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-flow-item", { heading: strings.fields.fields, description: !hideLayerTitle ? layer.title : undefined, onCalciteFlowItemBack: () => {
        this.arcgisAggregationFieldsBackClick.emit();
        this.closePopovers();
      }, ref: (node) => (this.flowItemNode = node) }, this.renderTip(statsFields), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "fields" }, statsFields === null || statsFields === void 0 ? void 0 : statsFields.map((aggregateField) => this.renderStatsField(aggregateField))), this.renderAddField())));
  }
  renderTip(statsFields) {
    const { strings } = this;
    if (statsFields === null || statsFields === void 0 ? void 0 : statsFields.length) {
      return null;
    }
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-tip", { heading: strings.fields.msgTitle, closeDisabled: true }, strings.fields.msg));
  }
  renderStatsField(aggregateField) {
    const { layer, mapView, selectedFieldName, modules, strings } = this;
    // need to have the field in the popup too
    addPopupField(aggregateField, layer, modules);
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-aggregation-field", { layer: layer, mapView: mapView, strings: strings, aggregateField: aggregateField, open: selectedFieldName === aggregateField.name, onArcgisAggregationFieldChange: () => {
        this.selectedFieldName = aggregateField.name;
        this.arcgisAggregationFieldsChange.emit();
        (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.hostElement);
      } }));
  }
  renderAddField() {
    const { allFieldsAdded, strings } = this;
    if (allFieldsAdded) {
      return null;
    }
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-fab", { slot: "fab", appearance: "outline-fill", kind: "neutral", scale: "s", icon: "plus", textEnabled: true, text: strings.fields.addField, onClick: () => this.addStatsField(), ref: (node) => (this.fabNode = node) }));
  }
  // --------------------------------------------------------------------------
  //
  //  Private methods
  //
  // --------------------------------------------------------------------------
  closePopovers() {
    if (this.attributeFormatter) {
      document.body.removeChild(this.attributeFormatter);
      this.attributeFormatter = null;
    }
  }
  addStatsField() {
    const { layer, strings, modules } = this;
    const { AggregateField } = modules;
    const fields = getLayerNumberOrStringFields(layer);
    let idxField = 0;
    let types = getStatsTypes(fields[idxField]);
    let idxType = 0;
    let hasAlready = hasFieldAlready(layer, fields[idxField].name, types[idxType]);
    while (idxField < fields.length && hasAlready) {
      // next types
      while (idxType < types.length && hasAlready) {
        idxType++;
        if (idxType < types.length) {
          hasAlready = hasFieldAlready(layer, fields[idxField].name, types[idxType]);
        }
      }
      if (hasAlready) {
        // next field
        idxField++;
        if (idxField < fields.length) {
          types = getStatsTypes(fields[idxField]);
          idxType = 0;
          hasAlready = hasFieldAlready(layer, fields[idxField].name, types[idxType]);
        }
      }
    }
    if (hasAlready) {
      this.allFieldsAdded = true;
    }
    else {
      const field = fields[idxField];
      const type = types[idxType];
      const aggregateField /* __esri.AggregateField */ = new AggregateField({
        name: `${field.name}_${type}`,
        onStatisticField: field.name,
        alias: `${field.alias || field.name} ${getStatsTypeString(type, strings).toLocaleLowerCase()}`,
        statisticType: type,
        visible: true
      });
      const featureReduction = layer.featureReduction; //__esri.FeatureReductionCluster;
      featureReduction.fields = featureReduction.fields || [];
      featureReduction.fields.push(aggregateField);
      addPopupField(aggregateField, layer, modules);
      this.selectedFieldName = aggregateField.name;
    }
    (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.hostElement);
  }
  get hostElement() { return (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.d)(this); }
};
ArcgisAggregationFields.style = arcgisAggregationFieldsCss;

const arcgisAggregationInfoPopoverCss = ".info{padding:10px;background-color:white}.info-popover{max-width:320px}.info-help{padding-top:10px;justify-content:flex-end;display:flex}.info-help-button{display:flex;flex-flow:row-reverse}";

const ArcgisAggregationInfoPopover = class {
  constructor(hostRef) {
    (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.r)(this, hostRef);
    this.arcgisAggregationInfoPopoverClose = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "arcgisAggregationInfoPopoverClose", 7);
    this.arcgisAggregationInfoPopoverDisconnected = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "arcgisAggregationInfoPopoverDisconnected", 7);
    //--------------------------------------------------------------------------
    //
    //  Private Properties
    //
    //--------------------------------------------------------------------------
    this.documentTabHandler = undefined;
    this.documentClickHandler = undefined;
    this.panelScrollHandler = undefined;
    // --------------------------------------------------------------------------
    //
    //  Private methods
    //
    // --------------------------------------------------------------------------
    this.onOpen = () => {
      setTimeout(() => requestAnimationFrame(() => { var _a; return (_a = this.panelNode) === null || _a === void 0 ? void 0 : _a.setFocus(); }), 1);
    };
    this.props = undefined;
    this.referenceElement = undefined;
    this.open = false;
  }
  //--------------------------------------------------------------------------
  //
  //  public calls
  //
  //--------------------------------------------------------------------------
  async reposition() {
    var _a;
    (_a = this.popoverNode) === null || _a === void 0 ? void 0 : _a.reposition();
  }
  async setFocus() {
    var _a;
    (_a = this.panelNode) === null || _a === void 0 ? void 0 : _a.setFocus();
  }
  async setOpen(open) {
    var _a;
    if (this.popoverNode) {
      this.popoverNode.open = open;
      if (open) {
        (_a = this.panelNode) === null || _a === void 0 ? void 0 : _a.setFocus();
        this.popoverNode.reposition();
      }
    }
  }
  //--------------------------------------------------------------------------
  //
  //  Lifecycle
  //
  //--------------------------------------------------------------------------
  disconnectedCallback() {
    // in case popover got removed by just removing node from DOM
    this.arcgisAggregationInfoPopoverDisconnected.emit();
  }
  // --------------------------------------------------------------------------
  //
  //  Render Methods
  //
  //--------------------------------------------------------------------------
  render() {
    const { props, referenceElement, open } = this;
    const { config, title, moreInfo, helpId, strings } = props;
    const { helpBase, helpMap } = config;
    const header = strings.tile.info.title.replace("${title}", title);
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)(_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.H, { class: "js-app-flyout arcgis-aggregation-popover" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-popover", { open: open, placement: "auto", offsetSkidding: 5, label: "", referenceElement: referenceElement, class: "info-popover", onCalcitePopoverOpen: this.onOpen, ref: (node) => (this.popoverNode = node) }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-panel", { heading: header, closable: true, ref: (node) => (this.panelNode = node), onCalcitePanelClose: () => {
        this.arcgisAggregationInfoPopoverClose.emit();
        // focus on info icon; wait so enter key doesn't re-open it
        setTimeout(() => referenceElement.parentElement.focus(), 300);
      } }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "info" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", null, moreInfo), helpId && helpMap ? ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "info-help" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { appearance: "solid", label: strings.tile.info.learnMore, class: "info-help-button", slot: "footer", onClick: () => {
        window.open(`${helpBase}${helpMap[helpId]}`, "_blank");
      } }, strings.tile.info.learnMore))) : null)))));
  }
  get hostElement() { return (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.d)(this); }
};
ArcgisAggregationInfoPopover.style = arcgisAggregationInfoPopoverCss;

const arcgisAggregationSymbolStylerPopoverCss = ".popover{z-index:100}.symbol-styler-div{width:328px;height:100%;overflow-y:auto;overflow-x:hidden}arcgis-symbol-styler{max-height:calc(90vh - 100px);}";

const ArcgisAggregationSymbolStylerPopover = class {
  constructor(hostRef) {
    (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.r)(this, hostRef);
    this.arcgisAggregationSymbolStylerChange = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "arcgisAggregationSymbolStylerChange", 7);
    this.arcgisAggregationSymbolStylerPopoverClose = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "arcgisAggregationSymbolStylerPopoverClose", 7);
    this.arcgisAggregationSymbolStylerPopoverDisconnected = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "arcgisAggregationSymbolStylerPopoverDisconnected", 7);
    this.documentTabHandler = undefined;
    this.documentClickHandler = undefined;
    this.panelScrollHandler = undefined;
    this.props = undefined;
    this.referenceElement = undefined;
  }
  //--------------------------------------------------------------------------
  //
  //  public calls
  //
  //--------------------------------------------------------------------------
  async reposition() {
    var _a;
    (_a = this.popoverNode) === null || _a === void 0 ? void 0 : _a.reposition();
  }
  async setFocus() {
    var _a;
    (_a = this.closeActionNode) === null || _a === void 0 ? void 0 : _a.setFocus();
  }
  async setOpen(open) {
    if (this.popoverNode) {
      this.popoverNode.open = open;
      if (open) {
        setTimeout(() => this.closeActionNode.setFocus(), 100);
        //this.popoverNode.reposition();
      }
    }
  }
  //--------------------------------------------------------------------------
  //
  //  Lifecycle
  //
  //--------------------------------------------------------------------------
  async componentWillLoad() {
    const [symbolUtils, cimSymbolUtils, Color, SimpleMarkerSymbol, SimpleLineSymbol] = await (0,_loadModules_aaf30bd6_js__WEBPACK_IMPORTED_MODULE_3__.l)([
      "esri/symbols/support/symbolUtils",
      "esri/symbols/support/cimSymbolUtils",
      "esri/Color",
      "esri/symbols/SimpleMarkerSymbol",
      "esri/symbols/SimpleLineSymbol"
    ]);
    this.modules = {
      symbolUtils,
      cimSymbolUtils,
      Color,
      SimpleMarkerSymbol,
      SimpleLineSymbol
    };
  }
  disconnectedCallback() {
    // in case popover got removed by just removing node from DOM
    this.arcgisAggregationSymbolStylerPopoverDisconnected.emit();
  }
  // --------------------------------------------------------------------------
  //
  //  Render Methods
  //
  //--------------------------------------------------------------------------
  render() {
    const { props, referenceElement } = this;
    const { strings } = props;
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)(_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.H, { class: "js-app-flyout arcgis-aggregation-popover" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-popover", { placement: "leading-start", offsetDistance: 0, offsetSkidding: 45, pointerDisabled: true, label: strings.symbolStyle, referenceElement: referenceElement, triggerDisabled: true, class: "popover", open: false,
      //onCalcitePopoverOpen={() => this.onOpen()}
      ref: (node) => (this.popoverNode = node) }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-panel", { heading: strings.symbolStyle, closable: false }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { slot: "header-content" }, strings.symbolStyle), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { slot: "header-actions-end", scale: "s", icon: "x", text: "", onClick: () => this.arcgisAggregationSymbolStylerPopoverClose.emit(), ref: (node) => (this.closeActionNode = node) }), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "symbol-styler-div",
      /* class="-symbol-button__symbol-styler-div" */ ref: (node) => this.buildSymbolStyler(node) })))));
  }
  // --------------------------------------------------------------------------
  //
  //  Private methods
  //
  // --------------------------------------------------------------------------
  async buildSymbolStyler(node) {
    const { props, modules } = this;
    const { layer, portal } = props;
    const { Color } = modules;
    const featureReduction = layer.featureReduction; //__esri.FeatureReductionCluster;
    let symbol = featureReduction.symbol;
    if (!isSupportedSymbol(symbol)) {
      symbol = getDefaultSymbol(modules);
    }
    const fillEnabled = symbol.type === "picture-marker" ? false : !!symbol.color;
    const strokeEnabled = hasSymbolOutline(symbol);
    const isPointCIM = symbol.type === "cim" && symbol.data.symbol.type === "CIMPointSymbol";
    const rtl = (0,_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_1__.g)(this.hostElement) === "rtl";
    let stroke;
    if (symbol.type === "simple-marker") {
      const sym = symbol;
      if (sym.outline) {
        stroke = {
          color: sym.outline.color ? sym.outline.color : new Color([0, 0, 0, 0.5]),
          size: sym.outline.width
        };
      }
      else {
        stroke = {
          color: new Color([0, 0, 0, 0.5]),
          size: 1
        };
      }
    }
    else if (symbol.type === "cim") {
      stroke = undefined;
    }
    else {
      stroke = {
        color: new Color([255, 255, 255, 0.5]),
        size: 1
      };
    }
    const symbolStyler = document.createElement("arcgis-symbol-styler");
    symbolStyler.popoverProps = {
      placement: "bottom-end",
      offsetDistance: 10,
      offsetSkidding: rtl ? 3 : -3,
      pointerDisabled: "true",
      popoverWidth: 315,
      //overlayPositioning: "fixed", -- buggy, offset issue
      refElement: this.closeActionNode
    };
    const edit = symbolStyler.edit(symbol.clone(), {
      portal,
      symbolFilter: undefined,
      sections: {
        marker: isPointCIM || ["simple-marker", "picture-marker"].indexOf(symbol.type) > -1
          ? {
            open: true,
            symbolsOpen: true,
            sizeOpen: true,
            parts: {
              size: false
            },
            markerType: "all"
          }
          : undefined,
        fill: {
          type: "color",
          optional: true,
          open: true,
          suggestedColorsOpen: true,
          transparencyOpen: isPictureMarker(symbol, modules)
        },
        stroke: {
          type: "color",
          optional: true,
          extraParts: {
            style: ["simple-marker", "picture-marker", "cim"].indexOf(symbol.type) === -1,
            width: true
          }
        }
      },
      fill: {
        color: getSymbolColor(symbol, modules) || adjustAlpha(new Color("#ff8200"), 0.85)
      },
      marker: {
        size: getSymbolSize(symbol, modules)
      },
      stroke,
      fillEnabled,
      strokeEnabled
    });
    symbolStyler.addEventListener("arcgisSymbolStylerEdit", (detail) => this.onChangeSymbol(detail));
    node.appendChild(symbolStyler);
    await edit;
  }
  onChangeSymbol({ detail: { symbol } }) {
    const { props } = this;
    const { layer } = props;
    const featureReduction = layer.featureReduction; //__esri.FeatureReductionCluster;
    featureReduction.symbol = symbol;
    this.arcgisAggregationSymbolStylerChange.emit();
  }
  get hostElement() { return (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.d)(this); }
};
ArcgisAggregationSymbolStylerPopover.style = arcgisAggregationSymbolStylerPopoverCss;

const arcgisAggregationTileCss = ".tile{background-color:white;position:relative;margin:6px;cursor:pointer;box-shadow:0 1px 10px 2px rgba(0, 0, 0, 0.05), 0 0 0 1px #e0e0e0;transition:box-shadow 125ms ease-in-out}.tile:hover{z-index:5;box-shadow:0 1px 0 2px rgba(0, 0, 0, 0.05), 0 0 0 1px #e0e0e0}.tile:focus{outline:2px solid var(--calcite-ui-brand)}.tile-selected{box-shadow:0 1px 10px 2px rgba(0, 0, 0, 0.05), 0 0 0 1px var(--calcite-ui-brand)}.tile-selected:hover{z-index:5;box-shadow:0 1px 0 2px rgba(0, 0, 0, 0.05), 0 0 0 1px var(--calcite-ui-brand)}.tile-check{position:absolute;top:10px;right:10px}.tile-check.rtl{right:auto;left:10px}.style-link{padding:9px 9px}.style-link-icon{margin-top:-1px}.style-link-text{margin-right:10px}.style-link-text.rtl{margin-right:0;margin-left:10px}.style-link-title{display:flex;font-weight:bold;padding-bottom:5px}.style-link-options{color:#0079c1;display:flex;flex-direction:row nowrap}.style-link-options svg{fill:#0079c1}.tile-image{height:100px;width:100%;background-size:cover;display:flex;align-items:center;justify-content:center}.tile-image-selected{height:68px;background-size:auto 100px}.style-sub-text{font-size:80%;padding:0 0 6px 0}.style-link-info{height:18px}";

const ArcgisAggregationTile = class {
  constructor(hostRef) {
    (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.r)(this, hostRef);
    this.arcgisAggregationTileSelect = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "arcgisAggregationTileSelect", 7);
    this.arcgisAggregationTileOptions = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "arcgisAggregationTileOptions", 7);
    //--------------------------------------------------------------------------
    //
    //  Private Properties
    //
    //--------------------------------------------------------------------------
    this.documentClickHandler = undefined;
    this.panelScrollHandler = undefined;
    this.keyupEventHandler = (event) => {
      const { selected } = this;
      if (event.key === " " || event.key === "Enter") {
        event.stopPropagation();
        this.removeInfoPopover();
        // use latest handler on props
        selected ? this.arcgisAggregationTileOptions.emit() : this.arcgisAggregationTileSelect.emit();
        event.preventDefault();
      }
    };
    this.keydownEventHandler = (event) => {
      if (event.key === " ") {
        // don't scroll panel
        event.stopPropagation();
        event.preventDefault();
      }
    };
    this.clickEventHandler = (event) => {
      var _a;
      const { selected } = this;
      if (((_a = event === null || event === void 0 ? void 0 : event.target) === null || _a === void 0 ? void 0 : _a.nodeName) === "CALCITE-CHECKBOX") {
        // user clicked on checkbox; we handled this below
        return;
      }
      event.stopPropagation();
      this.removeInfoPopover();
      // use latest handler on props
      selected ? this.arcgisAggregationTileOptions.emit() : this.arcgisAggregationTileSelect.emit();
      event.preventDefault();
    };
    this.checkboxChangeHandler = (event) => {
      const { selected } = this;
      event.preventDefault();
      const node = event.target;
      if (!node.checked) {
        // we don't allow users to uncheck the box
        node.checked = true;
      }
      else {
        this.removeInfoPopover();
        // use latest handler on props
        selected ? this.arcgisAggregationTileOptions.emit() : this.arcgisAggregationTileSelect.emit();
      }
    };
    this.props = undefined;
    this.selected = undefined;
  }
  //--------------------------------------------------------------------------
  //
  //  Public Methods
  //
  //--------------------------------------------------------------------------
  /**
   * Set focus on tile
   */
  async setFocus() {
    var _a;
    (_a = this.tileNode) === null || _a === void 0 ? void 0 : _a.focus();
  }
  //--------------------------------------------------------------------------
  //
  //  Lifecycle
  //
  //--------------------------------------------------------------------------
  disconnectedCallback() {
    this.removeInfoPopover();
  }
  // --------------------------------------------------------------------------
  //
  //  Render Methods
  //
  //--------------------------------------------------------------------------
  render() {
    const { props, selected } = this;
    const { title, imagePath, strings } = props;
    const rtl = (0,_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_1__.g)(this.hostElement) === "rtl";
    const styleTileClasses = {
      tile: true,
      "tile-selected": selected
    };
    const styleTileImageClasses = {
      "tile-image": true,
      "tile-image-selected": selected
    };
    const styleTileCheckClasses = {
      "tile-check": true,
      rtl: rtl
    };
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)(_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.H, null, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: styleTileClasses, role: "button", tabindex: "0", "aria-label": `${title} ${strings.tile.options}`, "aria-selected": selected, ref: (element) => {
        this.tileNode = element;
        this.addTileListeners(element);
      } }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: styleTileImageClasses, style: { backgroundImage: `url(${imagePath})` }, "aria-hidden": "true" }), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: styleTileCheckClasses, "aria-label": "", "aria-hidden": "true" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-checkbox", { name: "style-tile-check-name", checked: selected, tabindex: "-1", ref: (element) => this.addCheckboxListener(element) })), this.renderTileLink())));
  }
  renderTileLink() {
    const { props, selected } = this;
    const { strings } = props;
    const rtl = (0,_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_1__.g)(this.hostElement) === "rtl";
    const styleLinkTextClasses = {
      "style-link-text": true,
      rtl: rtl
    };
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "style-link", "aria-label": props.title }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "style-link-title" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: styleLinkTextClasses, "aria-hidden": "true" }, props.title), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { class: "style-link-info", tabindex: "0", scale: "s", icon: "information", compact: true, onClick: (event) => this.handleInfoClick(event), text: strings.tile.moreInfo, ref: (element) => {
        this.infoIconNode = element;
        element.addEventListener("keyup", (event) => {
          event.stopPropagation();
          if (event.key === " " || (!this.infoPopoverNode && event.key === "Enter")) {
            this.handleInfoClick(event);
          }
        });
        element.addEventListener("keydown", (event) => {
          if (event.key === " ") {
            // prevent panel from scrolling
            event.stopPropagation();
            event.preventDefault();
          }
        });
      } })), selected && this.renderStyleOptions()));
  }
  renderStyleOptions() {
    const { props } = this;
    const { strings } = props;
    // event handling for button click is handled as tile click
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { appearance: "outline-fill", width: "full", scale: "s", label: strings.tile.options }, strings.tile.options));
  }
  // --------------------------------------------------------------------------
  //
  //  Private methods
  //
  // --------------------------------------------------------------------------
  handleInfoClick(event) {
    // don't execute the event on the entire tile
    event.stopPropagation();
    const { props } = this;
    const { config, title, moreInfo, helpId, flowItemNode, strings } = props;
    this.removeInfoPopover();
    this.infoPopoverNode = document.createElement("arcgis-aggregation-info-popover");
    this.infoPopoverNode.props = {
      title,
      moreInfo,
      helpId,
      config,
      flowItemNode,
      strings
    };
    this.infoPopoverNode.referenceElement = this.infoIconNode;
    this.infoPopoverNode.addEventListener("arcgisAggregationInfoPopoverClose", (event) => {
      event.stopPropagation();
      this.removeInfoPopover();
      setTimeout(() => this.infoIconNode.setFocus(), 200);
    });
    this.infoPopoverNode.addEventListener("arcgisAggregationInfoPopoverDisconnected", (event) => {
      event.stopPropagation();
      this.removeInfoPopover();
    });
    document.body.appendChild(this.infoPopoverNode);
    this.infoPopoverNode.setOpen(true);
    // need to wait until it's all visible
    setTimeout(() => this.infoPopoverNode.setFocus(), 100);
    setTimeout(() => {
      // close popover when clicking outside
      this.documentClickHandler = (event) => {
        if (!this.isInsideInfoPopoverNode(event.target)) {
          this.removeInfoPopover();
          setTimeout(() => this.infoIconNode.setFocus(), 200);
        }
      };
      document.addEventListener("click", this.documentClickHandler);
      // click handler is not called when clicking or scrolling panel scrollbars
      this.panelScrollHandler = () => {
        this.removeInfoPopover();
      };
      flowItemNode === null || flowItemNode === void 0 ? void 0 : flowItemNode.addEventListener("calciteFlowItemScroll", this.panelScrollHandler);
    }, 100);
  }
  removeInfoPopover() {
    const { props } = this;
    const { flowItemNode } = props;
    // close popovers
    document.body
      .querySelectorAll(".arcgis-aggregation-popover")
      .forEach((node) => document.body.removeChild(node));
    this.infoPopoverNode = null;
    if (this.documentClickHandler) {
      document.removeEventListener("click", this.documentClickHandler);
      this.documentClickHandler = undefined;
    }
    if (this.panelScrollHandler) {
      flowItemNode === null || flowItemNode === void 0 ? void 0 : flowItemNode.removeEventListener("calciteFlowItemScroll", this.panelScrollHandler);
      this.panelScrollHandler = undefined;
    }
  }
  isInsideInfoPopoverNode(node) {
    if ((node === null || node === void 0 ? void 0 : node.tagName) === "ARCGIS-AGGREGATION-INFO-POPOVER") {
      return true;
    }
    else {
      let parentNode = node === null || node === void 0 ? void 0 : node.parentElement;
      while (parentNode) {
        if (parentNode.tagName === "ARCGIS-AGGREGATION-INFO-POPOVER") {
          return true;
        }
        else {
          parentNode = parentNode.parentElement;
        }
      }
    }
    return false;
  }
  addTileListeners(element) {
    element.addEventListener("keyup", this.keyupEventHandler);
    element.addEventListener("keydown", this.keydownEventHandler);
    element.addEventListener("click", this.clickEventHandler);
  }
  addCheckboxListener(element) {
    element.addEventListener("calciteCheckboxChange", this.checkboxChangeHandler);
  }
  get hostElement() { return (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.d)(this); }
};
ArcgisAggregationTile.style = arcgisAggregationTileCss;




/***/ }),

/***/ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/functional-c82f5ab9.js":
/*!****************************************************************************************************************!*\
  !*** ./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/functional-c82f5ab9.js ***!
  \****************************************************************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   a: () => (/* binding */ arrayToLookupMap),
/* harmony export */   b: () => (/* binding */ unique),
/* harmony export */   c: () => (/* binding */ throttle),
/* harmony export */   d: () => (/* binding */ debounce),
/* harmony export */   e: () => (/* binding */ escapeRegExp),
/* harmony export */   f: () => (/* binding */ arraysAreEquivalent),
/* harmony export */   g: () => (/* binding */ chunk),
/* harmony export */   i: () => (/* binding */ isDefined),
/* harmony export */   m: () => (/* binding */ minDelay),
/* harmony export */   t: () => (/* binding */ timeout),
/* harmony export */   u: () => (/* binding */ uniqueBy)
/* harmony export */ });
/*!
 * All material copyright ESRI, All Rights Reserved, unless otherwise specified.
 * v3.0.99
 */
/**
 * Call a function only after it has not been called for n milliseconds
 * @param fn    - function to call
 * @param delay - delay in milliseconds
 */
const debounce = (fn, delay) => {
  let timeout;
  let status = "idle";
  function flush(...args) {
    status = "flushed";
    return debounced(...args);
  }
  function invoke(...args) {
    status = "invoked";
    return debounced(...args);
  }
  function cancel(...args) {
    status = "cancelled";
    return debounced(...args);
  }
  function getStatus() {
    return status;
  }
  const debounced = (...args) => new Promise((resolve) => {
    switch (status) {
      case "flushed":
        status = "idle";
        if (timeout) {
          clearTimeout(timeout);
          resolve(fn(...args));
        }
        else {
          resolve(null);
        }
        break;
      case "invoked":
        clearTimeout(timeout);
        status = "idle";
        resolve(fn(...args));
        break;
      case "cancelled":
        clearTimeout(timeout);
        status = "idle";
        resolve(null);
        break;
      default:
        if (timeout) {
          clearTimeout(timeout);
        }
        status = "pending";
        timeout = setTimeout(() => {
          status = "idle";
          return resolve(fn(...args));
        }, delay);
        break;
    }
  });
  debounced.flush = flush;
  debounced.invoke = invoke;
  debounced.cancel = cancel;
  debounced.getStatus = getStatus;
  return debounced;
};
/**
 * Call a function only after n milliseconds have elapsed
 * @param fn    - function to call
 * @param delay - delay in milliseconds
 */
const throttle = (fn, delay) => {
  let timeout;
  return (...args) => new Promise((resolve) => {
    if (timeout) {
      return;
    }
    timeout = setTimeout(() => {
      clearTimeout(timeout);
      timeout = undefined;
      resolve(fn(...args));
    }, delay);
  });
};
function escapeRegExp(str) {
  return str.replace(/[.*+?^${}()|[\]\\]/g, "\\$&"); // $& means the whole matched string
}
function isDefined(value) {
  return value !== undefined && value !== null;
}
/**
 * Set a minimum time for a promise to resolve (useful for preventing flash of loaders)
 */
async function minDelay(promise, minDelay) {
  await Promise.all([promise, timeout(minDelay)]);
  return promise;
}
/**
 * Helper method to inline setTimeout as an await in async functions
 */
function timeout(ms) {
  return new Promise((resolve) => setTimeout(resolve, ms));
}
const arrayToLookupMap = (dataArr, getKeyAndItem) => Object.fromEntries((dataArr || []).map((item) => {
  const { key, data } = getKeyAndItem(item);
  return [key, data];
}));
/**
 * Check whether two arrays have the same number of elements
 * and whether they contain the same elements
 * regardless of order
 */
const arraysAreEquivalent = (arr1, arr2) => arr1.length === arr2.length && arr1.reduce((memo, str) => memo && arr2.indexOf(str) > -1, true);
function uniqueBy(myArr, getItemId) {
  const resultArr = [];
  const lookupMap = {};
  myArr.forEach((item) => {
    const id = getItemId(item);
    if (lookupMap[id] == null) {
      lookupMap[id] = item;
      resultArr.push(item);
    }
  });
  return resultArr;
}
function unique(myArr) {
  const primitives = { boolean: {}, number: {}, string: {} };
  const objs = [];
  return myArr.filter((item) => {
    let type = typeof item;
    if (type in primitives) {
      return primitives[type].hasOwnProperty(item) ? false : (primitives[type][item] = true);
    }
    else {
      return objs.indexOf(item) >= 0 ? false : objs.push(item);
    }
  });
}
const chunk = (arr, size) => [...Array(Math.ceil(arr.length / size))].map((_, i) => arr.slice(size * i, size + size * i));




/***/ }),

/***/ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/locale-13e00a75.js":
/*!************************************************************************************************************!*\
  !*** ./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/locale-13e00a75.js ***!
  \************************************************************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   a: () => (/* binding */ getComponentClosestLanguage),
/* harmony export */   g: () => (/* binding */ getLocaleComponentStrings)
/* harmony export */ });
/* harmony import */ var _dom_13f5b00c_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./dom-13f5b00c.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/dom-13f5b00c.js");
/* harmony import */ var _languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./languageUtil-22258c90.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/languageUtil-22258c90.js");
/* harmony import */ var _index_92ebb396_js__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./index-92ebb396.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/index-92ebb396.js");
/*!
 * All material copyright ESRI, All Rights Reserved, unless otherwise specified.
 * v3.0.99
 */




// https://medium.com/stencil-tricks/implementing-internationalisation-i18n-with-stencil-5e6559554117
function getComponentClosestLanguage(element) {
  var _a, _b, _c;
  const closestElement = (_a = (0,_dom_13f5b00c_js__WEBPACK_IMPORTED_MODULE_0__.c)(element, "[lang]")) !== null && _a !== void 0 ? _a : (_c = (_b = element.shadowRoot) === null || _b === void 0 ? void 0 : _b.ownerDocument) === null || _c === void 0 ? void 0 : _c.documentElement;
  // language set by the calling application or browser. defaults to english.
  const lang = ((closestElement === null || closestElement === void 0 ? void 0 : closestElement.lang) || (navigator === null || navigator === void 0 ? void 0 : navigator.language) || "en").toLowerCase();
  if (_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_1__.l.has(lang)) {
    return _languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_1__.l.get(lang);
  }
  else {
    // "ru-RU" maps to "ru" use case
    if (_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_1__.l.has(lang.slice(0, 2))) {
      return _languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_1__.l.get(lang.slice(0, 2));
    }
    else {
      return "en";
    }
  }
}
function getComponentClosestLanguageIntl(element) {
  var _a, _b, _c;
  // it's OK if we don't have the 4 letter language file for it
  // 4 letter language code needed for formatting numbers
  const closestElement = (_a = (0,_dom_13f5b00c_js__WEBPACK_IMPORTED_MODULE_0__.c)(element, "[lang]")) !== null && _a !== void 0 ? _a : (_c = (_b = element.shadowRoot) === null || _b === void 0 ? void 0 : _b.ownerDocument) === null || _c === void 0 ? void 0 : _c.documentElement;
  // language set by the calling application or browser. defaults to english.
  const lang = ((closestElement === null || closestElement === void 0 ? void 0 : closestElement.lang) || (navigator === null || navigator === void 0 ? void 0 : navigator.language) || "en").toLowerCase();
  if (_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_1__.l.has(lang)) {
    return _languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_1__.l.get(lang);
  }
  else {
    if (_languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_1__.l.has(lang.slice(0, 2))) {
      // we support the 2 letter coded language
      // e.g. it-CH vs it
      return lang;
    }
    else {
      return "en";
    }
  }
}
function fetchLocaleStringsForComponent(componentName, locale) {
  return new Promise((resolve, reject) => {
    fetch((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_2__.a)(`../arcgis-app-assets/i18n/${componentName}.i18n.${locale}.json`)).then((result) => {
      if (result.ok)
        resolve(result.json());
      else
        reject();
    }, () => reject());
  });
}
const stringCache = {};
function fetchLocaleStringsFromCache(componentName, locale) {
  const id = `${componentName}${locale}`;
  if (!stringCache[id]) {
    stringCache[id] = fetchLocaleStringsForComponent(componentName, locale);
  }
  return stringCache[id];
}
/**
 * Get strings and language codes.
 * This method returns 2 language codes.
 * The first one returns a code that's also supported as a language file.
 * The second one returns a code where there is support for the first 2 letters of the code as part of a language file,
 * but will return the original 4 letter code from the page.
 * E.g. For "it-ch" it will return "it" as the first language code and "it-ch" as the second.
 * The second one is required for esri.intl.setLocale() to get the correct formatting.
 *
 * If a tagName is provided it will overwite the element's tagName
 *
 *  @return [ strings, first language code, second language code]
 */
async function getLocaleComponentStrings(element, tagName) {
  const componentName = tagName || element.tagName.toLowerCase();
  const componentLanguage = getComponentClosestLanguage(element);
  const componentLanguageIntl = getComponentClosestLanguageIntl(element);
  let strings;
  try {
    strings = await fetchLocaleStringsFromCache(componentName, componentLanguage);
  }
  catch (e) {
    console.warn(`no locale for ${componentName} (${componentLanguage}) loading default locale en.`);
    strings = await fetchLocaleStringsFromCache(componentName, "en");
  }
  return [strings, componentLanguage, componentLanguageIntl];
}




/***/ })

}]);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2lkZ2V0cy9jaHVua3MvYXJjZ2lzX2FuYWx5c2lzX25vZGVfbW9kdWxlc19hcmNnaXNfYXBwLWNvbXBvbmVudHNfZGlzdF9lc21fYXJjZ2lzLWFhMjYwMi5qcyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDaUs7QUFDL0U7QUFDWjtBQUNUO0FBQ2E7QUFDSjtBQUNiO0FBQzlCOztBQUUzQjtBQUNBLGtDQUFrQztBQUNsQyxtQ0FBbUM7QUFDbkMseUNBQXlDO0FBQ3pDLGdDQUFnQztBQUNoQyxpQ0FBaUM7QUFDakMsMENBQTBDO0FBQzFDO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxDQUFDLDBDQUEwQztBQUMzQztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxVQUFVLDhDQUE4QztBQUN4RDtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtB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O0FBQ25CO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxVQUFVLHFEQUFZLDhCQUE4QixjQUFjLFFBQVEsT0FBTztBQUNqRjtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTCxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0EsZ0JBQWdCLGNBQWMsRUFBRSxPQUFPO0FBQ3ZDO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGtDQUFrQyxlQUFlLEdBQUcsa0JBQWtCO0FBQ3RFO0FBQ0E7QUFDQTtBQUNBOztBQUU0RSIsInNvdXJjZXMiOlsid2VicGFjazovL2V4Yi1jbGllbnQvLi9leHRlbnNpb25zL3dpZGdldHMvYXJjZ2lzL2FuYWx5c2lzL25vZGVfbW9kdWxlcy9AYXJjZ2lzL2FwcC1jb21wb25lbnRzL2Rpc3QvZXNtL2FyY2dpcy1hZ2dyZWdhdGlvbl84LmVudHJ5LmpzIiwid2VicGFjazovL2V4Yi1jbGllbnQvLi9leHRlbnNpb25zL3dpZGdldHMvYXJjZ2lzL2FuYWx5c2lzL25vZGVfbW9kdWxlcy9AYXJjZ2lzL2FwcC1jb21wb25lbnRzL2Rpc3QvZXNtL2Z1bmN0aW9uYWwtYzgyZjVhYjkuanMiLCJ3ZWJwYWNrOi8vZXhiLWNsaWVudC8uL2V4dGVuc2lvbnMvd2lkZ2V0cy9hcmNnaXMvYW5hbHlzaXMvbm9kZV9tb2R1bGVzL0BhcmNnaXMvYXBwLWNvbXBvbmVudHMvZGlzdC9lc20vbG9jYWxlLTEzZTAwYTc1LmpzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qIVxuICogQWxsIG1hdGVyaWFsIGNvcHlyaWdodCBFU1JJLCBBbGwgUmlnaHRzIFJlc2VydmVkLCB1bmxlc3Mgb3RoZXJ3aXNlIHNwZWNpZmllZC5cbiAqIHYzLjAuOTlcbiAqL1xuaW1wb3J0IHsgciBhcyByZWdpc3Rlckluc3RhbmNlLCBjIGFzIGNyZWF0ZUV2ZW50LCBoLCBIIGFzIEhvc3QsIGEgYXMgZ2V0QXNzZXRQYXRoLCBmIGFzIGZvcmNlVXBkYXRlLCBkIGFzIGdldEVsZW1lbnQsIEYgYXMgRnJhZ21lbnQgfSBmcm9tICcuL2luZGV4LTkyZWJiMzk2LmpzJztcbmltcG9ydCB7IGcgYXMgZ2V0RWxlbWVudERpciwgQyBhcyBDU1NfVVRJTElUWSB9IGZyb20gJy4vbGFuZ3VhZ2VVdGlsLTIyMjU4YzkwLmpzJztcbmltcG9ydCB7IGcgYXMgZ2V0TG9jYWxlQ29tcG9uZW50U3RyaW5ncyB9IGZyb20gJy4vbG9jYWxlLTEzZTAwYTc1LmpzJztcbmltcG9ydCB7IGwgYXMgbG9hZE1vZHVsZXMgfSBmcm9tICcuL2xvYWRNb2R1bGVzLWFhZjMwYmQ2LmpzJztcbmltcG9ydCB7IGggYXMgZ2V0TGF5ZXJHZW9tZXRyeVR5cGUgfSBmcm9tICcuL2NvbW1vbkZ1bmN0aW9ucy01MjYyYjA5NC5qcyc7XG5pbXBvcnQgeyBsIGFzIGxheWVyRGlzcGxheVR5cGVFbnVtIH0gZnJvbSAnLi9jb21tb25FbnVtcy1mOThhMzIzYy5qcyc7XG5pbXBvcnQgeyBkIGFzIGRlYm91bmNlIH0gZnJvbSAnLi9mdW5jdGlvbmFsLWM4MmY1YWI5LmpzJztcbmltcG9ydCAnLi9kb20tMTNmNWIwMGMuanMnO1xuXG4vLyBjbHVzdGVyaW5nXG5jb25zdCBjbHVzdGVyaW5nUmFkaXVzTWluVmFsID0gOTsgLy8gMTJweFxuY29uc3QgY2x1c3RlcmluZ1JhZGl1c01heFZhbCA9IDkwOyAvLyAxMjBweFxuY29uc3QgY2x1c3RlcmluZ1JhZGl1c0luaXRpYWxWYWwgPSAzNy41OyAvLyA1MHB4XG5jb25zdCBjbHVzdGVyaW5nU2l6ZU1pblZhbCA9IDk7IC8vIDEycHhcbmNvbnN0IGNsdXN0ZXJpbmdTaXplTWF4VmFsID0gOTA7IC8vIDEyMHB4XG5jb25zdCBjbHVzdGVyaW5nU2l6ZU1heEluaXRpYWxWYWwgPSAzNy41OyAvLyA1MHB4XG52YXIgQWdncmVnYXRpb25UeXBlO1xuKGZ1bmN0aW9uIChBZ2dyZWdhdGlvblR5cGUpIHtcbiAgQWdncmVnYXRpb25UeXBlW1wiQ0xVU1RFUklOR1wiXSA9IFwiY2x1c3RlcmluZ1wiO1xuICBBZ2dyZWdhdGlvblR5cGVbXCJDSEFSVF9DTFVTVEVSSU5HXCJdID0gXCJjaGFydENsdXN0ZXJpbmdcIjtcbiAgQWdncmVnYXRpb25UeXBlW1wiQklOTklOR1wiXSA9IFwiYmlubmluZ1wiO1xufSkoQWdncmVnYXRpb25UeXBlIHx8IChBZ2dyZWdhdGlvblR5cGUgPSB7fSkpO1xuLyoqXG4gKiBSZXR1cm5zIGEgcGFyZW50IGVsZW1lbnQgd2l0aCB0aGF0IHRhZyBuYW1lIG9yIGNsYXNzIG5hbWVcbiAqIEBwYXJhbSBub2RlIC0gc3RhcnRpbmcgbm9kZVxuICogQHBhcmFtIHRhZ05hbWUgLSB0YWcgbmFtZSB0byBmaW5kIHVwIHRoZSB0cmVlXG4gKiBAcGFyYW0gY2xhc3NOYW1lIC0gY2xhc3MgbmFtZSB0byBmaW5kIHVwIHRoZSB0cmVlXG4gKi9cbmZ1bmN0aW9uIGZpbmRQYXJlbnROb2RlKG5vZGUsIHRhZ05hbWUsIGNsYXNzTmFtZSkge1xuICBpZiAoKHRhZ05hbWUgJiYgKG5vZGUgPT09IG51bGwgfHwgbm9kZSA9PT0gdm9pZCAwID8gdm9pZCAwIDogbm9kZS50YWdOYW1lKSA9PT0gdGFnTmFtZS50b1VwcGVyQ2FzZSgpKSB8fCAoY2xhc3NOYW1lICYmIChub2RlID09PSBudWxsIHx8IG5vZGUgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG5vZGUuY2xhc3NMaXN0LmNvbnRhaW5zKGNsYXNzTmFtZSkpKSkge1xuICAgIHJldHVybiBub2RlO1xuICB9XG4gIGVsc2Uge1xuICAgIGxldCBwYXJlbnROb2RlID0gbm9kZSA9PT0gbnVsbCB8fCBub2RlID09PSB2b2lkIDAgPyB2b2lkIDAgOiBub2RlLnBhcmVudEVsZW1lbnQ7XG4gICAgd2hpbGUgKHBhcmVudE5vZGUpIHtcbiAgICAgIGlmICgodGFnTmFtZSAmJiBwYXJlbnROb2RlLnRhZ05hbWUgPT09IHRhZ05hbWUudG9VcHBlckNhc2UoKSkgfHxcbiAgICAgICAgKGNsYXNzTmFtZSAmJiBwYXJlbnROb2RlLmNsYXNzTGlzdC5jb250YWlucyhjbGFzc05hbWUpKSkge1xuICAgICAgICByZXR1cm4gcGFyZW50Tm9kZTtcbiAgICAgIH1cbiAgICAgIGVsc2UgaWYgKHBhcmVudE5vZGUudGFnTmFtZSA9PT0gXCJCT0RZXCIpIHtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgICBlbHNlIHtcbiAgICAgICAgcGFyZW50Tm9kZSA9IHBhcmVudE5vZGUucGFyZW50RWxlbWVudDtcbiAgICAgIH1cbiAgICB9XG4gIH1cbiAgcmV0dXJuO1xufVxuZnVuY3Rpb24gZ2V0U3RhdHNUeXBlU3RyaW5nKHN0YXRpc3RpY1R5cGUsIHN0cmluZ3MpIHtcbiAgc3dpdGNoIChzdGF0aXN0aWNUeXBlKSB7XG4gICAgY2FzZSBcInN1bVwiOlxuICAgICAgcmV0dXJuIHN0cmluZ3MuZmllbGRzLnN1bTtcbiAgICBjYXNlIFwiYXZnXCI6XG4gICAgICByZXR1cm4gc3RyaW5ncy5maWVsZHMubWVhbjtcbiAgICBjYXNlIFwibWluXCI6XG4gICAgICByZXR1cm4gc3RyaW5ncy5maWVsZHMubWluO1xuICAgIGNhc2UgXCJtYXhcIjpcbiAgICAgIHJldHVybiBzdHJpbmdzLmZpZWxkcy5tYXg7XG4gICAgY2FzZSBcInN0ZGRldlwiOlxuICAgICAgcmV0dXJuIHN0cmluZ3MuZmllbGRzLnN0ZERldjtcbiAgICBjYXNlIFwibW9kZVwiOlxuICAgICAgcmV0dXJuIHN0cmluZ3MuZmllbGRzLm1vZGU7XG4gICAgY2FzZSBcInZhclwiOlxuICAgICAgcmV0dXJuIHN0cmluZ3MuZmllbGRzLnZhcjtcbiAgICBjYXNlIFwiY291bnRcIjpcbiAgICAgIHJldHVybiBzdHJpbmdzLmZpZWxkcy5jb3VudDtcbiAgICBkZWZhdWx0OlxuICAgICAgcmV0dXJuIFwiXCI7XG4gIH1cbn1cbmZ1bmN0aW9uIGdldEFnZ3JlZ2F0aW9uVHlwZShsYXllcikge1xuICBjb25zdCBmZWF0dXJlUmVkdWN0aW9uID0gbGF5ZXIuZmVhdHVyZVJlZHVjdGlvbjtcbiAgaWYgKCFmZWF0dXJlUmVkdWN0aW9uKSB7XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfVxuICBlbHNlIGlmIChmZWF0dXJlUmVkdWN0aW9uLnR5cGUgPT09IFwiYmlubmluZ1wiKSB7XG4gICAgcmV0dXJuIFwiYmlubmluZ1wiO1xuICB9XG4gIGVsc2UgaWYgKGZlYXR1cmVSZWR1Y3Rpb24udHlwZSA9PT0gXCJjbHVzdGVyXCIpIHtcbiAgICBpZiAoaXNQaWVDaGFydFJlbmRlcmVyKGxheWVyKSkge1xuICAgICAgcmV0dXJuIFwicGllLWNoYXJ0XCI7XG4gICAgfVxuICAgIHJldHVybiBcImNsdXN0ZXJcIjtcbiAgfVxufVxuZnVuY3Rpb24gaXNSZW5kZXJlckF1dG9HZW5lcmF0ZWQobGF5ZXIpIHtcbiAgdmFyIF9hLCBfYjtcbiAgY29uc3QgZmVhdHVyZVJlZHVjdGlvbiA9IGxheWVyLmZlYXR1cmVSZWR1Y3Rpb247XG4gIHJldHVybiAhKGZlYXR1cmVSZWR1Y3Rpb24gPT09IG51bGwgfHwgZmVhdHVyZVJlZHVjdGlvbiA9PT0gdm9pZCAwID8gdm9pZCAwIDogZmVhdHVyZVJlZHVjdGlvbi5yZW5kZXJlcikgfHwgKChfYiA9IChfYSA9IGZlYXR1cmVSZWR1Y3Rpb24gPT09IG51bGwgfHwgZmVhdHVyZVJlZHVjdGlvbiA9PT0gdm9pZCAwID8gdm9pZCAwIDogZmVhdHVyZVJlZHVjdGlvbi5yZW5kZXJlcikgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmF1dGhvcmluZ0luZm8pID09PSBudWxsIHx8IF9iID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYi5pc0F1dG9HZW5lcmF0ZWQpO1xufVxuZnVuY3Rpb24gaXNQaWVDaGFydFJlbmRlcmVyKGxheWVyKSB7XG4gIHZhciBfYSwgX2I7XG4gIGNvbnN0IGZlYXR1cmVSZWR1Y3Rpb24gPSBsYXllci5mZWF0dXJlUmVkdWN0aW9uO1xuICByZXR1cm4gKGZlYXR1cmVSZWR1Y3Rpb24ucmVuZGVyZXIgJiZcbiAgICBmZWF0dXJlUmVkdWN0aW9uLnJlbmRlcmVyLnR5cGUgPT09IFwicGllLWNoYXJ0XCIgJiZcbiAgICAhKChfYiA9IChfYSA9IGZlYXR1cmVSZWR1Y3Rpb24gPT09IG51bGwgfHwgZmVhdHVyZVJlZHVjdGlvbiA9PT0gdm9pZCAwID8gdm9pZCAwIDogZmVhdHVyZVJlZHVjdGlvbi5yZW5kZXJlcikgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmF1dGhvcmluZ0luZm8pID09PSBudWxsIHx8IF9iID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYi5pc0F1dG9HZW5lcmF0ZWQpKTtcbn1cblxuZnVuY3Rpb24gaXNTdXBwb3J0ZWRTeW1ib2woc3ltKSB7XG4gIHJldHVybiBbXCJzaW1wbGUtZmlsbFwiLCBcInNpbXBsZS1tYXJrZXJcIiwgXCJzaW1wbGUtbGluZVwiLCBcInBpY3R1cmUtbWFya2VyXCIsIFwiY2ltXCJdLmluZGV4T2Yoc3ltLnR5cGUpID4gLTE7XG59XG5mdW5jdGlvbiBnZXREZWZhdWx0U3ltYm9sKG1vZHVsZXMpIHtcbiAgLypcbiAgXCJzeW1ib2xcIjp7XG4gICAgXCJ0eXBlXCI6XCJlc3JpU01TXCIsXG4gICAgXCJjb2xvclwiOlsyMjcsMTM5LDc5LDI1NV0sXG4gICAgXCJhbmdsZVwiOjAsXG4gICAgXCJ4b2Zmc2V0XCI6MCxcbiAgICBcInlvZmZzZXRcIjowLFxuICAgIFwic2l6ZVwiOjksXG4gICAgXCJzdHlsZVwiOlwiZXNyaVNNU0NpcmNsZVwiLFxuICAgIFwib3V0bGluZVwiOntcbiAgICAgIFwidHlwZVwiOlwiZXNyaVNMU1wiLFxuICAgICAgXCJjb2xvclwiOls5Miw5Miw5Miw2NF0sXG4gICAgICBcIndpZHRoXCI6MC43NSxcbiAgICAgIFwic3R5bGVcIjpcImVzcmlTTFNTb2xpZFwiXG4gICAgfVxuICB9XG4gICovXG4gIGNvbnN0IHsgU2ltcGxlTGluZVN5bWJvbCwgU2ltcGxlTWFya2VyU3ltYm9sLCBDb2xvciB9ID0gbW9kdWxlcztcbiAgY29uc3Qgb3V0bGluZVN5bSA9IG5ldyBTaW1wbGVMaW5lU3ltYm9sKHtcbiAgICBzdHlsZTogXCJzb2xpZFwiLFxuICAgIGNvbG9yOiBuZXcgQ29sb3IoWzkyLCA5MiwgOTIsIDY0XSksXG4gICAgd2lkdGg6IDFcbiAgfSk7XG4gIGNvbnN0IHN5bWJvbCA9IG5ldyBTaW1wbGVNYXJrZXJTeW1ib2woe1xuICAgIHN0eWxlOiBcImNpcmNsZVwiLFxuICAgIHNpemU6IDYuNzUsXG4gICAgb3V0bGluZTogb3V0bGluZVN5bSxcbiAgICBjb2xvcjogbmV3IENvbG9yKFsyMjcsIDEzOSwgNzksIDI1NV0pXG4gIH0pO1xuICByZXR1cm4gc3ltYm9sO1xufVxuZnVuY3Rpb24gaGFzU3ltYm9sT3V0bGluZShzeW0pIHtcbiAgdmFyIF9hO1xuICByZXR1cm4gc3ltLnR5cGUgPT09IFwicGljdHVyZS1tYXJrZXJcIiA/IGZhbHNlIDogc3ltLnR5cGUgPT09IFwiY2ltXCIgPyBmYWxzZSA6ICEhKChfYSA9IHN5bS5vdXRsaW5lKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EuY29sb3IpO1xufVxuZnVuY3Rpb24gaXNQaWN0dXJlTWFya2VyKHN5bSwgbW9kdWxlcykge1xuICBpZiAoc3ltLnR5cGUgPT09IFwicGljdHVyZS1tYXJrZXJcIikge1xuICAgIHJldHVybiB0cnVlO1xuICB9XG4gIGVsc2UgaWYgKHN5bS50eXBlID09PSBcImNpbVwiICYmICFpc0ZpbGxPbmx5Q0lNKHN5bSwgbW9kdWxlcykpIHtcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuICByZXR1cm4gZmFsc2U7XG59XG5mdW5jdGlvbiBpc0ZpbGxPbmx5Q0lNKHN5bSwgbW9kdWxlcykge1xuICBjb25zdCB7IGNpbVN5bWJvbFV0aWxzIH0gPSBtb2R1bGVzO1xuICByZXR1cm4gISFjaW1TeW1ib2xVdGlscy5nZXRDSU1TeW1ib2xDb2xvcihzeW0pO1xufVxuZnVuY3Rpb24gZ2V0U3ltYm9sQ29sb3Ioc3ltYm9sLCBtb2R1bGVzKSB7XG4gIHZhciBfYSwgX2I7XG4gIGNvbnN0IHsgY2ltU3ltYm9sVXRpbHMsIENvbG9yIH0gPSBtb2R1bGVzO1xuICByZXR1cm4gKHN5bWJvbCA9PT0gbnVsbCB8fCBzeW1ib2wgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHN5bWJvbC50eXBlKSA9PT0gXCJjaW1cIlxuICAgID8gQ29sb3IuZnJvbUpTT04oKF9hID0gY2ltU3ltYm9sVXRpbHMuZ2V0Q0lNU3ltYm9sQ29sb3Ioc3ltYm9sKSkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLnRvSlNPTigpKVxuICAgIDogKHN5bWJvbCA9PT0gbnVsbCB8fCBzeW1ib2wgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHN5bWJvbC50eXBlKSA9PT0gXCJzaW1wbGUtbWFya2VyXCIgJiYgW1wieFwiLCBcImNyb3NzXCJdLmluZGV4T2Yoc3ltYm9sID09PSBudWxsIHx8IHN5bWJvbCA9PT0gdm9pZCAwID8gdm9pZCAwIDogc3ltYm9sLnN0eWxlKSA+IC0xXG4gICAgICA/IChfYiA9IHN5bWJvbCA9PT0gbnVsbCB8fCBzeW1ib2wgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHN5bWJvbC5vdXRsaW5lKSA9PT0gbnVsbCB8fCBfYiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2IuY29sb3JcbiAgICAgIDogc3ltYm9sID09PSBudWxsIHx8IHN5bWJvbCA9PT0gdm9pZCAwID8gdm9pZCAwIDogc3ltYm9sLmNvbG9yO1xufVxuZnVuY3Rpb24gZ2V0U3ltYm9sU2l6ZShzeW0sIG1vZHVsZXMpIHtcbiAgY29uc3QgeyBjaW1TeW1ib2xVdGlscyB9ID0gbW9kdWxlcztcbiAgaWYgKHN5bS50eXBlID09PSBcImNpbVwiKSB7XG4gICAgcmV0dXJuIGNpbVN5bWJvbFV0aWxzLmdldENJTVN5bWJvbFNpemUoc3ltKTtcbiAgfVxuICBlbHNlIGlmIChzeW0uc2l6ZSkge1xuICAgIHJldHVybiBzeW0uc2l6ZTtcbiAgfVxuICByZXR1cm4gc3ltLndpZHRoO1xufVxuZnVuY3Rpb24gYWRqdXN0QWxwaGEoY29sb3IsIGFscGhhKSB7XG4gIGNvbG9yLmEgPSBhbHBoYTtcbiAgcmV0dXJuIGNvbG9yO1xufVxuXG5mdW5jdGlvbiBnZXRMYXllck51bWJlck9yU3RyaW5nRmllbGRzKGxheWVyKSB7XG4gIHJldHVybiBsYXllci5maWVsZHMuZmlsdGVyKChmaWVsZCkgPT4gW1wic21hbGwtaW50ZWdlclwiLCBcImJpZy1pbnRlZ2VyXCIsIFwiaW50ZWdlclwiLCBcInNpbmdsZVwiLCBcImRvdWJsZVwiLCBcImxvbmdcIiwgXCJudW1iZXJcIiwgXCJzdHJpbmdcIl0uaW5kZXhPZihmaWVsZC50eXBlKSA+IC0xKTtcbn1cbmZ1bmN0aW9uIGdldExheWVyRmllbGQobGF5ZXIsIGZpZWxkTmFtZSkge1xuICByZXR1cm4gZmllbGROYW1lICYmIGxheWVyLmZpZWxkcy5maW5kKChmaWVsZCkgPT4gZmllbGQubmFtZSA9PT0gZmllbGROYW1lKTtcbn1cbmZ1bmN0aW9uIGhhc0ZpZWxkQWxyZWFkeShsYXllciwgZmllbGROYW1lLCBzdGF0aXN0aWNUeXBlKSB7XG4gIHZhciBfYTtcbiAgY29uc3QgZmVhdHVyZVJlZHVjdGlvbiA9IGxheWVyLmZlYXR1cmVSZWR1Y3Rpb247IC8vX19lc3JpLkZlYXR1cmVSZWR1Y3Rpb25DbHVzdGVyO1xuICByZXR1cm4gISEoKF9hID0gZmVhdHVyZVJlZHVjdGlvbi5maWVsZHMpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5maW5kKChmaSAvKiBfX2VzcmkuQWdncmVnYXRlRmllbGQgKi8pID0+IGZpLm9uU3RhdGlzdGljRmllbGQgPT09IGZpZWxkTmFtZSAmJiBmaS5zdGF0aXN0aWNUeXBlID09PSBzdGF0aXN0aWNUeXBlKSk7XG59XG4vKlxuICogbm8gbW9yZSBzdGF0cyBvcHRpb25zIGF2YWlsYWJsZSBmb3IgdGhpcyBmaWVsZFxuICovXG5mdW5jdGlvbiBpc0ZpZWxkRG9uZShsYXllciwgZmllbGROYW1lKSB7XG4gIGNvbnN0IGZpZWxkID0gZ2V0TGF5ZXJGaWVsZChsYXllciwgZmllbGROYW1lKTtcbiAgY29uc3QgdHlwZXMgPSBnZXRTdGF0c1R5cGVzKGZpZWxkKTtcbiAgcmV0dXJuICF0eXBlcy5maW5kKCh0eXBlKSA9PiAhaGFzRmllbGRBbHJlYWR5KGxheWVyLCBmaWVsZE5hbWUsIHR5cGUpKTtcbn1cbmZ1bmN0aW9uIGdldFN0YXRzVHlwZXMoZmllbGQpIHtcbiAgcmV0dXJuIGZpZWxkLnR5cGUgPT09IFwic3RyaW5nXCIgPyBbXCJtb2RlXCJdIDogW1wic3VtXCIsIFwiYXZnXCIsIFwibWluXCIsIFwibWF4XCIsIC8qIFwidmFyXCIsIFwic3RkZGV2XCIsICovIFwibW9kZVwiXTtcbn1cbmZ1bmN0aW9uIGFkZFBvcHVwRmllbGQoYWdncmVnYXRlRmllbGQsIGxheWVyLCBtb2R1bGVzKSB7XG4gIC8vIGRvbid0IGtub3cgd2hlcmUgdG8gc3RvcmUgdGhlIGFsaWFzIGZvciB0aGlzIGZpZWxkIG90aGVyd2lzZVxuICAvKiBpZiAoYWdncmVnYXRlRmllbGQuaXNBdXRvR2VuZXJhdGVkICYmIGFnZ3JlZ2F0ZUZpZWxkLnN0YXRpc3RpY1R5cGUgPT09IFwibW9kZVwiKSB7XG4gICAgLy8gZG9uJ3QgYWRkIHRoaXMgZmllbGQgZ2VuZXJhdGVkIGZvciB0aGUgcmVuZGVyZXJcbiAgICByZXR1cm47XG4gIH0gKi9cbiAgY29uc3QgeyBGaWVsZEluZm8gfSA9IG1vZHVsZXM7XG4gIGNvbnN0IGZlYXR1cmVSZWR1Y3Rpb24gPSBsYXllci5mZWF0dXJlUmVkdWN0aW9uOyAvL19fZXNyaS5GZWF0dXJlUmVkdWN0aW9uQ2x1c3RlcjtcbiAgY29uc3QgeyBwb3B1cFRlbXBsYXRlIH0gPSBmZWF0dXJlUmVkdWN0aW9uO1xuICBwb3B1cFRlbXBsYXRlLmZpZWxkSW5mb3MgPSBwb3B1cFRlbXBsYXRlLmZpZWxkSW5mb3MgfHwgW107XG4gIGNvbnN0IGZpZWxkSW5mbyA9IHBvcHVwVGVtcGxhdGUuZmllbGRJbmZvcy5maW5kKChmaWVsZEluZm8pID0+IGZpZWxkSW5mby5maWVsZE5hbWUgPT09IGFnZ3JlZ2F0ZUZpZWxkLm5hbWUpO1xuICBpZiAoIWZpZWxkSW5mbykge1xuICAgIHBvcHVwVGVtcGxhdGUuZmllbGRJbmZvcy5wdXNoKG5ldyBGaWVsZEluZm8oe1xuICAgICAgZmllbGROYW1lOiBhZ2dyZWdhdGVGaWVsZC5uYW1lLFxuICAgICAgbGFiZWw6IGFnZ3JlZ2F0ZUZpZWxkLmFsaWFzLFxuICAgICAgaXNFZGl0YWJsZTogZmFsc2UsXG4gICAgICB2aXNpYmxlOiB0cnVlLFxuICAgICAgZm9ybWF0OiBnZXRGb3JtYXQoYWdncmVnYXRlRmllbGQsIGxheWVyKVxuICAgIH0pKTtcbiAgfSAvLyBlbHNlIGZpZWxkSW5mbyBpcyBhbHJlYWR5IHRoZXJlXG59XG5mdW5jdGlvbiBnZXRQb3B1cEZpZWxkSW5mbyhsYXllciwgZmllbGROYW1lKSB7XG4gIGNvbnN0IGZlYXR1cmVSZWR1Y3Rpb24gPSBsYXllci5mZWF0dXJlUmVkdWN0aW9uO1xuICByZXR1cm4gZmVhdHVyZVJlZHVjdGlvbi5wb3B1cFRlbXBsYXRlLmZpZWxkSW5mb3MuZmluZCgoZmllbGRJbmZvKSA9PiBmaWVsZEluZm8uZmllbGROYW1lID09PSBmaWVsZE5hbWUpO1xufVxuZnVuY3Rpb24gZ2V0Rm9ybWF0KGFnZ3JlZ2F0ZUZpZWxkLCBsYXllcikge1xuICBjb25zdCBzdGF0c0ZpZWxkID0gYWdncmVnYXRlRmllbGQub25TdGF0aXN0aWNGaWVsZDtcbiAgY29uc3Qgc3RhdHNFeHByID0gYWdncmVnYXRlRmllbGQub25TdGF0aXN0aWNFeHByZXNzaW9uO1xuICBjb25zdCBpc1N1bSA9IGFnZ3JlZ2F0ZUZpZWxkLnN0YXRpc3RpY1R5cGUgPT09IFwic3VtXCI7XG4gIGNvbnN0IGlzQ291bnQgPSBhZ2dyZWdhdGVGaWVsZC5zdGF0aXN0aWNUeXBlID09PSBcImNvdW50XCI7XG4gIGNvbnN0IGZpZWxkID0gZ2V0TGF5ZXJGaWVsZChsYXllciwgc3RhdHNGaWVsZCk7XG4gIGNvbnN0IGlzSW50ID0gaXNDb3VudCB8fFxuICAgIChzdGF0c0V4cHIgJiYgaXNTdW0pIHx8XG4gICAgKGZpZWxkICYmIFtcInNtYWxsLWludGVnZXJcIiwgXCJiaWctaW50ZWdlclwiLCBcImludGVnZXJcIiwgXCJsb25nXCIsIFwibnVtYmVyXCJdLmluZGV4T2YoZmllbGQudHlwZSkgPiAtMSk7XG4gIGNvbnN0IGlzRG91YmxlID0gZmllbGQgJiYgW1wic2luZ2xlXCIsIFwiZG91YmxlXCJdLmluZGV4T2YoZmllbGQudHlwZSkgPiAtMTtcbiAgcmV0dXJuIGlzRG91YmxlXG4gICAgPyB7XG4gICAgICBkaWdpdFNlcGFyYXRvcjogdHJ1ZSxcbiAgICAgIHBsYWNlczogMVxuICAgIH1cbiAgICA6IGlzSW50XG4gICAgICA/IHtcbiAgICAgICAgZGlnaXRTZXBhcmF0b3I6IHRydWVcbiAgICAgIH1cbiAgICAgIDogdW5kZWZpbmVkO1xufVxuXG5jb25zdCBhcmNnaXNBZ2dyZWdhdGlvbkNzcyA9IFwiOmhvc3R7aGVpZ2h0OjEwMCV9LmZsb3d7aGVpZ2h0OjEwMCV9LnBhbmVse2hlaWdodDoxMDAlfS50b2dnbGV7YmFja2dyb3VuZC1jb2xvcjp3aGl0ZTtwYWRkaW5nOjE1cHggMTBweCA1cHggMTBweH1cIjtcblxuY29uc3QgQXJjZ2lzQWdncmVnYXRpb24gPSBjbGFzcyB7XG4gIGNvbnN0cnVjdG9yKGhvc3RSZWYpIHtcbiAgICByZWdpc3Rlckluc3RhbmNlKHRoaXMsIGhvc3RSZWYpO1xuICAgIHRoaXMuYXJjZ2lzQWdncmVnYXRpb25TdHlsZUNsaWNrID0gY3JlYXRlRXZlbnQodGhpcywgXCJhcmNnaXNBZ2dyZWdhdGlvblN0eWxlQ2xpY2tcIiwgNyk7XG4gICAgdGhpcy5hcmNnaXNBZ2dyZWdhdGlvbkNsb3NlID0gY3JlYXRlRXZlbnQodGhpcywgXCJhcmNnaXNBZ2dyZWdhdGlvbkNsb3NlXCIsIDcpO1xuICAgIHRoaXMuYXJjZ2lzQWdncmVnYXRpb25DaGFuZ2VkID0gY3JlYXRlRXZlbnQodGhpcywgXCJhcmNnaXNBZ2dyZWdhdGlvbkNoYW5nZWRcIiwgNyk7XG4gICAgdGhpcy5hcmNnaXNBZ2dyZWdhdGlvbkVycm9yID0gY3JlYXRlRXZlbnQodGhpcywgXCJhcmNnaXNBZ2dyZWdhdGlvbkVycm9yXCIsIDcpO1xuICAgIHRoaXMudGlsZU5vZGVzID0gW107XG4gICAgdGhpcy5sYXN0RmVhdHVyZVJlZHVjdGlvbiA9IFtdO1xuICAgIHRoaXMudmlldyA9IHVuZGVmaW5lZDtcbiAgICB0aGlzLmxheWVyID0gdW5kZWZpbmVkO1xuICAgIHRoaXMucG9ydGFsID0gdW5kZWZpbmVkO1xuICAgIHRoaXMuY29uZmlnID0gdW5kZWZpbmVkO1xuICAgIHRoaXMuaGlkZUxheWVyVGl0bGUgPSBmYWxzZTtcbiAgICB0aGlzLm9wdGlvbnMgPSB1bmRlZmluZWQ7XG4gIH1cbiAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAvL1xuICAvLyAgUHVibGljIE1ldGhvZHNcbiAgLy9cbiAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAvKipcbiAgICogU2V0IGZvY3VzIG9uIGNvbXBvbmVudFxuICAgKi9cbiAgYXN5bmMgc2V0Rm9jdXMoKSB7XG4gICAgdmFyIF9hO1xuICAgIChfYSA9IHRoaXMuZmxvd0l0ZW1Ob2RlKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2Euc2V0Rm9jdXMoKTtcbiAgfVxuICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIC8vXG4gIC8vICBMaWZlY3ljbGVcbiAgLy9cbiAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICBhc3luYyBjb21wb25lbnRXaWxsTG9hZCgpIHtcbiAgICBjb25zdCBbc3RyaW5ncywgY3VycmVudExhbmd1YWdlXSA9IGF3YWl0IGdldExvY2FsZUNvbXBvbmVudFN0cmluZ3ModGhpcy5ob3N0RWxlbWVudCk7XG4gICAgdGhpcy5zdHJpbmdzID0gc3RyaW5ncztcbiAgICB0aGlzLmxvY2FsZSA9IGN1cnJlbnRMYW5ndWFnZTtcbiAgICBjb25zdCBbcG9wdXBDbHVzdGVycywgcG9wdXBVdGlscywgYmluTGV2ZWwsIGNsdXN0ZXJMYWJlbENyZWF0b3IsIGJpbkxhYmVsQ3JlYXRvciwgQWdncmVnYXRlRmllbGQsIEZpZWxkSW5mbywgcGllQ2hhcnRDcmVhdG9yLCBjb2xvckNyZWF0b3IsIFNpbXBsZVJlbmRlcmVyXSA9IGF3YWl0IGxvYWRNb2R1bGVzKFtcbiAgICAgIFwiZXNyaS9zbWFydE1hcHBpbmcvcG9wdXAvY2x1c3RlcnNcIixcbiAgICAgIFwiZXNyaS9zdXBwb3J0L3BvcHVwVXRpbHNcIixcbiAgICAgIFwiZXNyaS9zbWFydE1hcHBpbmcvaGV1cmlzdGljcy9iaW5MZXZlbFwiLFxuICAgICAgXCJlc3JpL3NtYXJ0TWFwcGluZy9sYWJlbHMvY2x1c3RlcnNcIixcbiAgICAgIFwiZXNyaS9zbWFydE1hcHBpbmcvbGFiZWxzL2JpbnNcIixcbiAgICAgIFwiZXNyaS9sYXllcnMvc3VwcG9ydC9BZ2dyZWdhdGVGaWVsZFwiLFxuICAgICAgXCJlc3JpL3BvcHVwL0ZpZWxkSW5mb1wiLFxuICAgICAgXCJlc3JpL3NtYXJ0TWFwcGluZy9yZW5kZXJlcnMvcGllQ2hhcnRcIixcbiAgICAgIFwiZXNyaS9zbWFydE1hcHBpbmcvcmVuZGVyZXJzL2NvbG9yXCIsXG4gICAgICBcImVzcmkvcmVuZGVyZXJzL1NpbXBsZVJlbmRlcmVyXCJcbiAgICBdKTtcbiAgICB0aGlzLm1vZHVsZXMgPSB7XG4gICAgICBwb3B1cENsdXN0ZXJzLFxuICAgICAgcG9wdXBVdGlscyxcbiAgICAgIGJpbkxldmVsLFxuICAgICAgY2x1c3RlckxhYmVsQ3JlYXRvcixcbiAgICAgIGJpbkxhYmVsQ3JlYXRvcixcbiAgICAgIEFnZ3JlZ2F0ZUZpZWxkLFxuICAgICAgRmllbGRJbmZvLFxuICAgICAgcGllQ2hhcnRDcmVhdG9yLFxuICAgICAgY29sb3JDcmVhdG9yLFxuICAgICAgU2ltcGxlUmVuZGVyZXJcbiAgICB9O1xuICAgIGNvbnN0IHsgdmlldywgbGF5ZXIgfSA9IHRoaXM7XG4gICAgdGhpcy5wcm9wcyA9IHtcbiAgICAgIHZpZXcsXG4gICAgICBsYXllclxuICAgIH07XG4gIH1cbiAgY29tcG9uZW50RGlkTG9hZCgpIHtcbiAgICB2YXIgX2E7XG4gICAgY29uc3QgeyBwcm9wcywgbW9kdWxlcyB9ID0gdGhpcztcbiAgICBjb25zdCB7IGxheWVyIH0gPSBwcm9wcztcbiAgICBjb25zdCB7IEFnZ3JlZ2F0ZUZpZWxkIH0gPSBtb2R1bGVzO1xuICAgIGNvbnN0IGZlYXR1cmVSZWR1Y3Rpb24gPSBsYXllci5mZWF0dXJlUmVkdWN0aW9uO1xuICAgIGlmIChmZWF0dXJlUmVkdWN0aW9uICYmICEoKF9hID0gZmVhdHVyZVJlZHVjdGlvbi5maWVsZHMpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5sZW5ndGgpKSB7XG4gICAgICAvLyB3ZSBuZWVkIGF0IGxlYXN0IG9uZSBmaWVsZFxuICAgICAgY29uc3QgYWdncmVnYXRlRmllbGQgPSBuZXcgQWdncmVnYXRlRmllbGQoe1xuICAgICAgICBuYW1lOiBcImFnZ3JlZ2F0ZUNvdW50XCIsXG4gICAgICAgIG9uU3RhdGlzdGljRmllbGQ6IHVuZGVmaW5lZCxcbiAgICAgICAgYWxpYXM6IFwiYWdncmVnYXRlQ291bnRcIixcbiAgICAgICAgc3RhdGlzdGljVHlwZTogXCJjb3VudFwiLFxuICAgICAgICB2aXNpYmxlOiB0cnVlXG4gICAgICB9KTtcbiAgICAgIGxheWVyLmZlYXR1cmVSZWR1Y3Rpb24uZmllbGRzID0gW2FnZ3JlZ2F0ZUZpZWxkXTtcbiAgICB9XG4gICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKCgpID0+IHRoaXMuZmxvd0l0ZW1Ob2RlLnNldEZvY3VzKCkpO1xuICB9XG4gIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIC8vXG4gIC8vICBSZW5kZXIgTWV0aG9kc1xuICAvL1xuICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIHJlbmRlcigpIHtcbiAgICBjb25zdCB7IGxheWVyLCBvcHRpb25zIH0gPSB0aGlzO1xuICAgIHJldHVybiAoaChIb3N0LCB7IGNsYXNzOiBcImNhbGNpdGUtbWF0Y2gtaGVpZ2h0XCIgfSwgaChcImNhbGNpdGUtZmxvd1wiLCB7IGNsYXNzOiBcImZsb3dcIiwgZGlyOiBnZXRFbGVtZW50RGlyKHRoaXMuaG9zdEVsZW1lbnQpLCByZWY6IChub2RlKSA9PiAodGhpcy5mbG93Tm9kZSA9IG5vZGUpIH0sIGxheWVyLmZlYXR1cmVFZmZlY3QgPyB0aGlzLnJlbmRlck1zZygpIDogdGhpcy5yZW5kZXJDb250ZW50KCksIChvcHRpb25zID09PSBBZ2dyZWdhdGlvblR5cGUuQ0xVU1RFUklORyB8fFxuICAgICAgb3B0aW9ucyA9PT0gQWdncmVnYXRpb25UeXBlLkNIQVJUX0NMVVNURVJJTkcpICYmXG4gICAgICB0aGlzLnJlbmRlckNsdXN0ZXJpbmdPcHRpb25zKCksIG9wdGlvbnMgPT09IEFnZ3JlZ2F0aW9uVHlwZS5CSU5OSU5HICYmIHRoaXMucmVuZGVyQmlubmluZ09wdGlvbnMoKSkpKTtcbiAgfVxuICByZW5kZXJDb250ZW50KCkge1xuICAgIHZhciBfYSwgX2IsIF9jO1xuICAgIGNvbnN0IHsgcHJvcHMsIGhpZGVMYXllclRpdGxlLCBjb25maWcsIGZsb3dJdGVtTm9kZSwgdGlsZU5vZGVzLCBzdHJpbmdzIH0gPSB0aGlzO1xuICAgIGNvbnN0IHsgbGF5ZXIgfSA9IHByb3BzO1xuICAgIGNvbnN0IGZlYXR1cmVSZWR1Y3Rpb24gPSBsYXllci5mZWF0dXJlUmVkdWN0aW9uO1xuICAgIGNvbnN0IHJ0bCA9IGdldEVsZW1lbnREaXIodGhpcy5ob3N0RWxlbWVudCkgPT09IFwicnRsXCI7XG4gICAgY29uc3QgZ2VuZXJhbFByb3BzID0geyBmbG93SXRlbU5vZGUsIHN0cmluZ3MsIGNvbmZpZyB9O1xuICAgIGNvbnN0IHsgcmVuZGVyZXIgfSA9IGxheWVyO1xuICAgIGNvbnN0IGlzVW5pcXVlVmFsdWUgPSByZW5kZXJlci50eXBlID09PSBcInVuaXF1ZS12YWx1ZVwiO1xuICAgIGNvbnN0IGlzTXVsdGlGaWVsZFR5cGVzID0gaXNVbmlxdWVWYWx1ZSAmJiAhIXJlbmRlcmVyLmZpZWxkMjtcbiAgICBjb25zdCBpc0hlYXRtYXAgPSByZW5kZXJlci50eXBlID09PSBcImhlYXRtYXBcIjtcbiAgICBjb25zdCB1c2VzQXJjYWRlID0gISFyZW5kZXJlci52YWx1ZUV4cHJlc3Npb247XG4gICAgY29uc3QgaXNDbGFzc2VkQ29sb3IgPSByZW5kZXJlci50eXBlID09PSBcImNsYXNzLWJyZWFrc1wiICYmICgoX2EgPSByZW5kZXJlci5hdXRob3JpbmdJbmZvKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EudHlwZSkgPT09IFwiY2xhc3MtYnJlYWtzLWNvbG9yXCI7XG4gICAgY29uc3QgaW5mb3NDb3VudCA9IGlzVW5pcXVlVmFsdWVcbiAgICAgID8gKF9iID0gcmVuZGVyZXIudW5pcXVlVmFsdWVJbmZvcykgPT09IG51bGwgfHwgX2IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9iLmxlbmd0aFxuICAgICAgOiBpc0NsYXNzZWRDb2xvclxuICAgICAgICA/IChfYyA9IHJlbmRlcmVyLmNsYXNzQnJlYWtJbmZvcykgPT09IG51bGwgfHwgX2MgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9jLmxlbmd0aFxuICAgICAgICA6IDA7XG4gICAgY29uc3QgYWxsb3dDbHVzdGVyaW5nID0gIWlzSGVhdG1hcCAmJiAhaXNNdWx0aUZpZWxkVHlwZXM7XG4gICAgY29uc3QgYWxsb3dDaGFydCA9IChpc1VuaXF1ZVZhbHVlIHx8IGlzQ2xhc3NlZENvbG9yKSAmJiBpbmZvc0NvdW50IDw9IDEwICYmICFpc011bHRpRmllbGRUeXBlcyAmJiAhdXNlc0FyY2FkZTtcbiAgICBjb25zdCBhZ2dyZWdhdGlvblR5cGUgPSBnZXRBZ2dyZWdhdGlvblR5cGUobGF5ZXIpO1xuICAgIHJldHVybiAoaChcImNhbGNpdGUtZmxvdy1pdGVtXCIsIHsgaGVhZGluZzogc3RyaW5ncy5hZ2dyZWdhdGlvbiwgZGVzY3JpcHRpb246ICFoaWRlTGF5ZXJUaXRsZSA/IGxheWVyLnRpdGxlIDogdW5kZWZpbmVkLCBjbGFzczoge1xuICAgICAgICBwYW5lbDogdHJ1ZSxcbiAgICAgICAgW0NTU19VVElMSVRZLnJ0bF06IHJ0bFxuICAgICAgfSwgY2xvc2FibGU6IHRydWUsIG9uQ2FsY2l0ZUZsb3dJdGVtQ2xvc2U6ICgpID0+IHtcbiAgICAgICAgdGhpcy5hcmNnaXNBZ2dyZWdhdGlvbkNsb3NlLmVtaXQoKTtcbiAgICAgIH0sIHJlZjogKG5vZGUpID0+IHtcbiAgICAgICAgdGhpcy5mbG93SXRlbU5vZGUgPSBub2RlO1xuICAgICAgfSB9LCBoKFwiZGl2XCIsIHsgY2xhc3M6IFwidG9nZ2xlXCIgfSwgaChcImNhbGNpdGUtbGFiZWxcIiwgeyBsYXlvdXQ6IFwiaW5saW5lLXNwYWNlLWJldHdlZW5cIiB9LCBzdHJpbmdzLmVuYWJsZUFnZ3JlZ2F0aW9uLCBoKFwiY2FsY2l0ZS1zd2l0Y2hcIiwgeyBzY2FsZTogXCJzXCIsIGNoZWNrZWQ6ICEhZmVhdHVyZVJlZHVjdGlvbiwgbGFiZWw6IHN0cmluZ3MuZW5hYmxlQWdncmVnYXRpb24sIG9uQ2FsY2l0ZVN3aXRjaENoYW5nZTogKGV2ZW50KSA9PiB0aGlzLmhhbmRsZVRvZ2dsZUNsdXN0ZXJpbmcoZXZlbnQpLCByZWY6IChub2RlKSA9PiAodGhpcy5zd2l0Y2hOb2RlID0gbm9kZSkgfSkpKSwgaChcImRpdlwiLCBudWxsLCBhbGxvd0NsdXN0ZXJpbmcgJiYgKGgoXCJhcmNnaXMtYWdncmVnYXRpb24tdGlsZVwiLCB7IHByb3BzOiBPYmplY3QuYXNzaWduKHsgdGl0bGU6IHN0cmluZ3MuY2x1c3RlcmluZywgaW1hZ2VQYXRoOiBnZXRBc3NldFBhdGgoYC4vYXNzZXRzL2FyY2dpcy1hZ2dyZWdhdGlvbi10aHVtYm5haWxzL2NsdXN0ZXJpbmcuanBnYCksIG1vcmVJbmZvOiBzdHJpbmdzLmluZm8uY2x1c3RlcmluZywgaGVscElkOiBcIjEyMDAwMzkyN1wiIH0sIGdlbmVyYWxQcm9wcyksIHNlbGVjdGVkOiBhZ2dyZWdhdGlvblR5cGUgPT09IFwiY2x1c3RlclwiLCByZWY6IChub2RlKSA9PiAodGlsZU5vZGVzW1wiY2x1c3RlclwiXSA9IG5vZGUpLCBvbkFyY2dpc0FnZ3JlZ2F0aW9uVGlsZVNlbGVjdDogYXN5bmMgKCkgPT4ge1xuICAgICAgICBhd2FpdCB0aGlzLmVuYWJsZUFnZ3JlZ2F0aW9uKFwiY2x1c3RlclwiKTtcbiAgICAgICAgZm9yY2VVcGRhdGUodGhpcy5ob3N0RWxlbWVudCk7XG4gICAgICB9LCBvbkFyY2dpc0FnZ3JlZ2F0aW9uVGlsZU9wdGlvbnM6ICgpID0+IHtcbiAgICAgICAgdGhpcy5vcHRpb25zID0gQWdncmVnYXRpb25UeXBlLkNMVVNURVJJTkc7XG4gICAgICAgIGZvcmNlVXBkYXRlKHRoaXMuaG9zdEVsZW1lbnQpO1xuICAgICAgfSB9KSksIGFsbG93Q2hhcnQgJiYgKGgoXCJhcmNnaXMtYWdncmVnYXRpb24tdGlsZVwiLCB7IHByb3BzOiBPYmplY3QuYXNzaWduKHsgdGl0bGU6IHN0cmluZ3MuY2hhcnRDbHVzdGVyaW5nLCBpbWFnZVBhdGg6IGdldEFzc2V0UGF0aChgLi9hc3NldHMvYXJjZ2lzLWFnZ3JlZ2F0aW9uLXRodW1ibmFpbHMvY2hhcnRDbHVzdGVyaW5nLmpwZ2ApLCBtb3JlSW5mbzogc3RyaW5ncy5pbmZvLmNoYXJ0Q2x1c3RlcmluZywgaGVscElkOiBcIjEyMDAwMzkyN1wiIH0sIGdlbmVyYWxQcm9wcyksIHNlbGVjdGVkOiBhZ2dyZWdhdGlvblR5cGUgPT09IFwicGllLWNoYXJ0XCIsIHJlZjogKG5vZGUpID0+ICh0aWxlTm9kZXNbXCJwaWUtY2hhcnRcIl0gPSBub2RlKSwgb25BcmNnaXNBZ2dyZWdhdGlvblRpbGVTZWxlY3Q6IGFzeW5jICgpID0+IHtcbiAgICAgICAgYXdhaXQgdGhpcy5lbmFibGVBZ2dyZWdhdGlvbihcInBpZS1jaGFydFwiKTtcbiAgICAgICAgZm9yY2VVcGRhdGUodGhpcy5ob3N0RWxlbWVudCk7XG4gICAgICB9LCBvbkFyY2dpc0FnZ3JlZ2F0aW9uVGlsZU9wdGlvbnM6ICgpID0+IHtcbiAgICAgICAgdGhpcy5vcHRpb25zID0gQWdncmVnYXRpb25UeXBlLkNIQVJUX0NMVVNURVJJTkc7XG4gICAgICAgIGZvcmNlVXBkYXRlKHRoaXMuaG9zdEVsZW1lbnQpO1xuICAgICAgfSB9KSksIChoKFwiYXJjZ2lzLWFnZ3JlZ2F0aW9uLXRpbGVcIiwgeyBwcm9wczogT2JqZWN0LmFzc2lnbih7IHRpdGxlOiBzdHJpbmdzLmJpbm5pbmcsIGltYWdlUGF0aDogZ2V0QXNzZXRQYXRoKGAuL2Fzc2V0cy9hcmNnaXMtYWdncmVnYXRpb24tdGh1bWJuYWlscy9iaW5uaW5nLmpwZ2ApLCBtb3JlSW5mbzogc3RyaW5ncy5pbmZvLmJpbm5pbmcsIGhlbHBJZDogXCIxMjAwMDM5MjZcIiB9LCBnZW5lcmFsUHJvcHMpLCBzZWxlY3RlZDogYWdncmVnYXRpb25UeXBlID09PSBcImJpbm5pbmdcIiwgcmVmOiAobm9kZSkgPT4gKHRpbGVOb2Rlc1tcImJpbm5pbmdcIl0gPSBub2RlKSwgb25BcmNnaXNBZ2dyZWdhdGlvblRpbGVTZWxlY3Q6IGFzeW5jICgpID0+IHtcbiAgICAgICAgYXdhaXQgdGhpcy5lbmFibGVBZ2dyZWdhdGlvbihcImJpbm5pbmdcIik7XG4gICAgICAgIGZvcmNlVXBkYXRlKHRoaXMuaG9zdEVsZW1lbnQpO1xuICAgICAgfSwgb25BcmNnaXNBZ2dyZWdhdGlvblRpbGVPcHRpb25zOiAoKSA9PiB7XG4gICAgICAgIHRoaXMub3B0aW9ucyA9IEFnZ3JlZ2F0aW9uVHlwZS5CSU5OSU5HO1xuICAgICAgICBmb3JjZVVwZGF0ZSh0aGlzLmhvc3RFbGVtZW50KTtcbiAgICAgIH0gfSkpKSkpO1xuICB9XG4gIHJlbmRlck1zZygpIHtcbiAgICBjb25zdCB7IGxheWVyLCBoaWRlTGF5ZXJUaXRsZSwgc3RyaW5ncyB9ID0gdGhpcztcbiAgICBjb25zdCBydGwgPSBnZXRFbGVtZW50RGlyKHRoaXMuaG9zdEVsZW1lbnQpID09PSBcInJ0bFwiO1xuICAgIHJldHVybiAoaChcImNhbGNpdGUtZmxvdy1pdGVtXCIsIHsgaGVhZGluZzogc3RyaW5ncy5hZ2dyZWdhdGlvbiwgZGVzY3JpcHRpb246ICFoaWRlTGF5ZXJUaXRsZSA/IGxheWVyLnRpdGxlIDogdW5kZWZpbmVkLCBjbGFzczoge1xuICAgICAgICBwYW5lbDogdHJ1ZSxcbiAgICAgICAgW0NTU19VVElMSVRZLnJ0bF06IHJ0bFxuICAgICAgfSwgY2xvc2FibGU6IHRydWUsIG9uQ2FsY2l0ZUZsb3dJdGVtQ2xvc2U6ICgpID0+IHtcbiAgICAgICAgdGhpcy5hcmNnaXNBZ2dyZWdhdGlvbkNsb3NlLmVtaXQoKTtcbiAgICAgIH0sIHJlZjogKG5vZGUpID0+IHtcbiAgICAgICAgdGhpcy5mbG93SXRlbU5vZGUgPSBub2RlO1xuICAgICAgfSB9LCBoKFwiY2FsY2l0ZS10aXBcIiwgeyBcIm5vbi1kaXNtaXNzaWJsZVwiOiB0cnVlIH0sIHN0cmluZ3MuY2x1c3Rlci5sZU5vdFN1cHBvcnRlZE1lc3NhZ2UpKSk7XG4gIH1cbiAgcmVuZGVyQ2x1c3RlcmluZ09wdGlvbnMoKSB7XG4gICAgY29uc3QgeyBwcm9wcywgaGlkZUxheWVyVGl0bGUsIHBvcnRhbCwgY29uZmlnLCBmbG93Tm9kZSwgc3RyaW5ncywgbG9jYWxlIH0gPSB0aGlzO1xuICAgIGNvbnN0IHsgbGF5ZXIsIHZpZXcgfSA9IHByb3BzO1xuICAgIHJldHVybiAoaChcImFyY2dpcy1hZ2dyZWdhdGlvbi1jbHVzdGVyaW5nXCIsIHsgdmlldzogdmlldywgbGF5ZXI6IGxheWVyLCBwb3J0YWw6IHBvcnRhbCwgY29uZmlnOiBjb25maWcsIGZsb3dOb2RlOiBmbG93Tm9kZSwgaGlkZUxheWVyVGl0bGU6IGhpZGVMYXllclRpdGxlLCBzdHJpbmdzOiBzdHJpbmdzLCBjdXJyZW50TGFuZ3VhZ2U6IGxvY2FsZSwgb25BcmNnaXNBZ2dyZWdhdGlvbkNsdXN0ZXJpbmdDaGFuZ2U6ICgpID0+IHtcbiAgICAgICAgdGhpcy5hcmNnaXNBZ2dyZWdhdGlvbkNoYW5nZWQuZW1pdCgpO1xuICAgICAgfSwgb25BcmNnaXNBZ2dyZWdhdGlvbkNsdXN0ZXJpbmdEaXNtaXNzZWRDaGFuZ2U6ICgpID0+IHsgfSwgb25DYWxjaXRlUGFuZWxCYWNrQ2xpY2s6ICgpID0+IHtcbiAgICAgICAgdGhpcy5vcHRpb25zID0gdW5kZWZpbmVkO1xuICAgICAgfSB9KSk7XG4gIH1cbiAgcmVuZGVyQmlubmluZ09wdGlvbnMoKSB7XG4gICAgY29uc3QgeyBwcm9wcywgaGlkZUxheWVyVGl0bGUsIHBvcnRhbCwgY29uZmlnLCBmbG93Tm9kZSwgc3RyaW5ncywgbG9jYWxlIH0gPSB0aGlzO1xuICAgIGNvbnN0IHsgbGF5ZXIsIHZpZXcgfSA9IHByb3BzO1xuICAgIHJldHVybiAoaChcImFyY2dpcy1hZ2dyZWdhdGlvbi1iaW5uaW5nXCIsIHsgdmlldzogdmlldywgbGF5ZXI6IGxheWVyLCBwb3J0YWw6IHBvcnRhbCwgY29uZmlnOiBjb25maWcsIGZsb3dOb2RlOiBmbG93Tm9kZSwgaGlkZUxheWVyVGl0bGU6IGhpZGVMYXllclRpdGxlLCBzdHJpbmdzOiBzdHJpbmdzLCBjdXJyZW50TGFuZ3VhZ2U6IGxvY2FsZSwgb25BcmNnaXNBZ2dyZWdhdGlvbkJpbm5pbmdDaGFuZ2U6ICgpID0+IHRoaXMuYXJjZ2lzQWdncmVnYXRpb25DaGFuZ2VkLmVtaXQoKSwgb25BcmNnaXNBZ2dyZWdhdGlvbkJpbm5pbmdTdHlsZUNsaWNrOiAoKSA9PiB0aGlzLmFyY2dpc0FnZ3JlZ2F0aW9uU3R5bGVDbGljay5lbWl0KCksIG9uQXJjZ2lzQWdncmVnYXRpb25CaW5uaW5nRGlzbWlzc2VkQ2hhbmdlOiAoKSA9PiB7IH0sIG9uQ2FsY2l0ZVBhbmVsQmFja0NsaWNrOiAoKSA9PiB7XG4gICAgICAgIHRoaXMub3B0aW9ucyA9IHVuZGVmaW5lZDtcbiAgICAgIH0gfSkpO1xuICB9XG4gIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIC8vXG4gIC8vICBQcml2YXRlIG1ldGhvZHNcbiAgLy9cbiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgYXN5bmMgaGFuZGxlVG9nZ2xlQ2x1c3RlcmluZyhldmVudCkge1xuICAgIGlmIChldmVudC5jdXJyZW50VGFyZ2V0LmNoZWNrZWQpIHtcbiAgICAgIGF3YWl0IHRoaXMuZW5hYmxlQWdncmVnYXRpb24oXCJkZWZhdWx0XCIpO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgIHRoaXMuZGlzYWJsZUFnZ3JlZ2F0aW9uKCk7XG4gICAgfVxuICAgIGZvcmNlVXBkYXRlKHRoaXMuaG9zdEVsZW1lbnQpO1xuICB9XG4gIGFzeW5jIGVuYWJsZUFnZ3JlZ2F0aW9uKHR5cGUpIHtcbiAgICBjb25zdCB7IHByb3BzLCBmbG93SXRlbU5vZGUgfSA9IHRoaXM7XG4gICAgY29uc3QgeyBsYXllciB9ID0gcHJvcHM7XG4gICAgY29uc3QgeyByZW5kZXJlciB9ID0gbGF5ZXI7XG4gICAgY29uc3QgaXNVbmlxdWVWYWx1ZSA9IHJlbmRlcmVyLnR5cGUgPT09IFwidW5pcXVlLXZhbHVlXCI7XG4gICAgY29uc3QgaXNNdWx0aUZpZWxkVHlwZXMgPSBpc1VuaXF1ZVZhbHVlICYmICEhcmVuZGVyZXIuZmllbGQyO1xuICAgIGNvbnN0IGlzSGVhdG1hcCA9IHJlbmRlcmVyLnR5cGUgPT09IFwiaGVhdG1hcFwiO1xuICAgIGlmICh0eXBlID09PSBcImRlZmF1bHRcIiAmJlxuICAgICAgdGhpcy5sYXN0RmVhdHVyZVJlZHVjdGlvblR5cGUgJiZcbiAgICAgIHRoaXMubGFzdEZlYXR1cmVSZWR1Y3Rpb25bdGhpcy5sYXN0RmVhdHVyZVJlZHVjdGlvblR5cGVdKSB7XG4gICAgICBsYXllci5mZWF0dXJlUmVkdWN0aW9uID0gdGhpcy5sYXN0RmVhdHVyZVJlZHVjdGlvblt0aGlzLmxhc3RGZWF0dXJlUmVkdWN0aW9uVHlwZV07XG4gICAgICBsYXllci5mZWF0dXJlUmVkdWN0aW9uID0gbGF5ZXIuZmVhdHVyZVJlZHVjdGlvbi5jbG9uZSgpO1xuICAgICAgdGhpcy5hcmNnaXNBZ2dyZWdhdGlvbkNoYW5nZWQuZW1pdCgpO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgIGlmICh0eXBlID09PSBcImRlZmF1bHRcIikge1xuICAgICAgICBpZiAoIWlzSGVhdG1hcCAmJiAhaXNNdWx0aUZpZWxkVHlwZXMpIHtcbiAgICAgICAgICB0eXBlID0gXCJjbHVzdGVyXCI7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgdHlwZSA9IFwiYmlubmluZ1wiO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICAvLyBzYXZlIHdoYXQgd2UgaGF2ZSBub3dcbiAgICAgIGNvbnN0IGN1cnJlbnRUeXBlID0gZ2V0QWdncmVnYXRpb25UeXBlKGxheWVyKTtcbiAgICAgIGlmIChjdXJyZW50VHlwZSkge1xuICAgICAgICB0aGlzLmxhc3RGZWF0dXJlUmVkdWN0aW9uW2N1cnJlbnRUeXBlXSA9IGxheWVyLmZlYXR1cmVSZWR1Y3Rpb247XG4gICAgICB9XG4gICAgICBpZiAodGhpcy5sYXN0RmVhdHVyZVJlZHVjdGlvblt0eXBlXSkge1xuICAgICAgICBsYXllci5mZWF0dXJlUmVkdWN0aW9uID0gdGhpcy5sYXN0RmVhdHVyZVJlZHVjdGlvblt0eXBlXTtcbiAgICAgICAgbGF5ZXIuZmVhdHVyZVJlZHVjdGlvbiA9IGxheWVyLmZlYXR1cmVSZWR1Y3Rpb24uY2xvbmUoKTtcbiAgICAgICAgdGhpcy5hcmNnaXNBZ2dyZWdhdGlvbkNoYW5nZWQuZW1pdCgpO1xuICAgICAgfVxuICAgICAgZWxzZSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgZmxvd0l0ZW1Ob2RlLmxvYWRpbmcgPSB0cnVlO1xuICAgICAgICAgIGlmICh0eXBlID09PSBcImJpbm5pbmdcIikge1xuICAgICAgICAgICAgYXdhaXQgdGhpcy5jcmVhdGVCaW5uaW5nKCk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgYXdhaXQgdGhpcy5jcmVhdGVDbHVzdGVyKHR5cGUpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBmbG93SXRlbU5vZGUubG9hZGluZyA9IGZhbHNlO1xuICAgICAgICAgIGxheWVyLmZlYXR1cmVSZWR1Y3Rpb24gPSBsYXllci5mZWF0dXJlUmVkdWN0aW9uLmNsb25lKCk7XG4gICAgICAgICAgdGhpcy5hcmNnaXNBZ2dyZWdhdGlvbkNoYW5nZWQuZW1pdCgpO1xuICAgICAgICB9XG4gICAgICAgIGNhdGNoIChlKSB7XG4gICAgICAgICAgZmxvd0l0ZW1Ob2RlLmxvYWRpbmcgPSBmYWxzZTtcbiAgICAgICAgICB0aGlzLmFyY2dpc0FnZ3JlZ2F0aW9uRXJyb3IuZW1pdCh7XG4gICAgICAgICAgICBtZXNzYWdlOiBcIkFnZ3JlZ2F0aW9uIHN0eWxlIGNvdWxkIG5vdCBiZSBjaGFuZ2VkLlwiLFxuICAgICAgICAgICAgdHlwZTogXCJ3YXJuaW5nXCJcbiAgICAgICAgICB9KTtcbiAgICAgICAgICBmb3JjZVVwZGF0ZSh0aGlzLmhvc3RFbGVtZW50KTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfVxuICBhc3luYyBjcmVhdGVDbHVzdGVyKHR5cGUpIHtcbiAgICB2YXIgX2EsIF9iO1xuICAgIGNvbnN0IHsgcHJvcHMsIHN3aXRjaE5vZGUsIHRpbGVOb2RlcywgbW9kdWxlcyB9ID0gdGhpcztcbiAgICBjb25zdCB7IGxheWVyLCB2aWV3IH0gPSBwcm9wcztcbiAgICBjb25zdCB7IHBvcHVwQ2x1c3RlcnMsIGNsdXN0ZXJMYWJlbENyZWF0b3IsIHBpZUNoYXJ0Q3JlYXRvciB9ID0gbW9kdWxlcztcbiAgICBjb25zdCBsYXN0RmVhdHVyZVJlZHVjdGlvbiA9IGxheWVyLmZlYXR1cmVSZWR1Y3Rpb247XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGxhYmVsU2NoZW1lcyA9IHR5cGUgPT09IFwiY2x1c3RlclwiICYmXG4gICAgICAgIChhd2FpdCBjbHVzdGVyTGFiZWxDcmVhdG9yLmdldExhYmVsU2NoZW1lcyh7XG4gICAgICAgICAgbGF5ZXI6IGxheWVyLFxuICAgICAgICAgIHJlbmRlcmVyOiBsYXllci5yZW5kZXJlcixcbiAgICAgICAgICB2aWV3OiB2aWV3XG4gICAgICAgIH0pKTtcbiAgICAgIGxheWVyLmZlYXR1cmVSZWR1Y3Rpb24gPSB7XG4gICAgICAgIHR5cGU6IFwiY2x1c3RlclwiLFxuICAgICAgICBjbHVzdGVyTWluU2l6ZTogKChfYSA9IGxhYmVsU2NoZW1lcyA9PT0gbnVsbCB8fCBsYWJlbFNjaGVtZXMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGxhYmVsU2NoZW1lcy5wcmltYXJ5U2NoZW1lKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EuY2x1c3Rlck1pblNpemUpIHx8IGNsdXN0ZXJpbmdTaXplTWluVmFsLFxuICAgICAgICBjbHVzdGVyTWF4U2l6ZTogY2x1c3RlcmluZ1NpemVNYXhJbml0aWFsVmFsLFxuICAgICAgICBjbHVzdGVyUmFkaXVzOiBjbHVzdGVyaW5nUmFkaXVzSW5pdGlhbFZhbCxcbiAgICAgICAgbGFiZWxzVmlzaWJsZTogdHlwZSA9PT0gXCJjbHVzdGVyXCIsXG4gICAgICAgIGxhYmVsaW5nSW5mbzogKF9iID0gbGFiZWxTY2hlbWVzID09PSBudWxsIHx8IGxhYmVsU2NoZW1lcyA9PT0gdm9pZCAwID8gdm9pZCAwIDogbGFiZWxTY2hlbWVzLnByaW1hcnlTY2hlbWUpID09PSBudWxsIHx8IF9iID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYi5sYWJlbGluZ0luZm9cbiAgICAgIH07XG4gICAgICBsZXQgcmVzdWx0O1xuICAgICAgaWYgKHR5cGUgPT09IFwicGllLWNoYXJ0XCIpIHtcbiAgICAgICAgLy8gZm9yIGNoYXJ0IGNsdXN0ZXJpbmcgY3JlYXRlIGEgcGllLWNoYXJ0IHJlbmRlcmVyIG5vd1xuICAgICAgICByZXN1bHQgPSBhd2FpdCBwaWVDaGFydENyZWF0b3IuY3JlYXRlUmVuZGVyZXJGb3JDbHVzdGVyaW5nKHsgbGF5ZXIgfSk7XG4gICAgICAgIGxheWVyLmZlYXR1cmVSZWR1Y3Rpb24ucmVuZGVyZXIgPSByZXN1bHQucmVuZGVyZXI7XG4gICAgICAgIGxheWVyLmZlYXR1cmVSZWR1Y3Rpb24uZmllbGRzID0gbGF5ZXIuZmVhdHVyZVJlZHVjdGlvbi5maWVsZHMuY29uY2F0KHJlc3VsdC5maWVsZHMpO1xuICAgICAgfVxuICAgICAgY29uc3QgdGVtcGxhdGUgPSBhd2FpdCBwb3B1cENsdXN0ZXJzLmdldFRlbXBsYXRlcyh7XG4gICAgICAgIHJlbmRlcmVyOiBsYXllci5yZW5kZXJlcixcbiAgICAgICAgbGF5ZXI6IGxheWVyXG4gICAgICB9KTtcbiAgICAgIGlmICh0eXBlID09PSBcImNsdXN0ZXJcIikge1xuICAgICAgICBjb25zdCBwb3B1cFRlbXBsYXRlID0gdGVtcGxhdGUucHJpbWFyeVRlbXBsYXRlLnZhbHVlO1xuICAgICAgICBsYXllci5mZWF0dXJlUmVkdWN0aW9uLnBvcHVwVGVtcGxhdGUgPSBwb3B1cFRlbXBsYXRlO1xuICAgICAgfVxuICAgICAgZWxzZSB7XG4gICAgICAgIC8vIHBpZS1jaGFydFxuICAgICAgICBjb25zdCBwb3B1cFRlbXBsYXRlID0gdGVtcGxhdGUuc2Vjb25kYXJ5VGVtcGxhdGVzWzBdLnZhbHVlO1xuICAgICAgICBsYXllci5mZWF0dXJlUmVkdWN0aW9uLnBvcHVwVGVtcGxhdGUgPSBwb3B1cFRlbXBsYXRlO1xuICAgICAgICAvLyBhZGQgdGhlIGZpZWxkcyBmcm9tIHRoZSByZW5kZXJlciB0byB0aGUgcG9wdXAgYXMgd2VsbFxuICAgICAgICByZXN1bHQuZmllbGRzLmZvckVhY2goKGFnZ3JlZ2F0ZUZpZWxkKSA9PiBhZGRQb3B1cEZpZWxkKGFnZ3JlZ2F0ZUZpZWxkLCBsYXllciwgbW9kdWxlcykpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xuICAgIH1cbiAgICBjYXRjaCAoZSkge1xuICAgICAgbGF5ZXIuZmVhdHVyZVJlZHVjdGlvbiA9IGxhc3RGZWF0dXJlUmVkdWN0aW9uO1xuICAgICAgaWYgKGxheWVyLmZlYXR1cmVSZWR1Y3Rpb24pIHtcbiAgICAgICAgdGlsZU5vZGVzW2dldEFnZ3JlZ2F0aW9uVHlwZShsYXllcildLnNldEZvY3VzKCk7XG4gICAgICB9XG4gICAgICBlbHNlIHtcbiAgICAgICAgc3dpdGNoTm9kZS5zZXRGb2N1cygpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KCk7XG4gICAgfVxuICB9XG4gIGFzeW5jIGNyZWF0ZUJpbm5pbmcoKSB7XG4gICAgdmFyIF9hLCBfYjtcbiAgICBjb25zdCB7IHByb3BzLCBzd2l0Y2hOb2RlLCB0aWxlTm9kZXMsIG1vZHVsZXMgfSA9IHRoaXM7XG4gICAgY29uc3QgeyBsYXllciwgdmlldyB9ID0gcHJvcHM7XG4gICAgY29uc3QgeyBwb3B1cFV0aWxzLCBiaW5MZXZlbCwgYmluTGFiZWxDcmVhdG9yLCBBZ2dyZWdhdGVGaWVsZCwgY29sb3JDcmVhdG9yIH0gPSBtb2R1bGVzO1xuICAgIGNvbnN0IGxhc3RGZWF0dXJlUmVkdWN0aW9uID0gbGF5ZXIuZmVhdHVyZVJlZHVjdGlvbjtcbiAgICB0cnkge1xuICAgICAgLy8gY3JlYXRlIHRoZSBmZWF0dXJlIHJlZHVjdGlvbiB3aXRoIGEgdHJhbnNwYXJlbnQgcmVuZGVyZXJcbiAgICAgIC8vIHNvIHdlIGRvbid0IHNlZSBwb2ludHMgZmxhc2hpbmcgb24gdGhlIG1hcFxuICAgICAgY29uc3QgX2JpbkxldmVsID0gYmluTGV2ZWw7XG4gICAgICBjb25zdCBmaXhlZEJpbkxldmVsID0gYXdhaXQgX2JpbkxldmVsKHsgdmlldyB9IC8qIGFzIF9fZXNyaS5iaW5MZXZlbEJpbkxldmVsUGFyYW1zICovKTtcbiAgICAgIGxheWVyLmZlYXR1cmVSZWR1Y3Rpb24gPSB7XG4gICAgICAgIHR5cGU6IFwiYmlubmluZ1wiLFxuICAgICAgICBmaXhlZEJpbkxldmVsOiBmaXhlZEJpbkxldmVsIHx8IDFcbiAgICAgIH07XG4gICAgICBpZiAoISgoX2EgPSBsYXllci5mZWF0dXJlUmVkdWN0aW9uLmZpZWxkcykgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmxlbmd0aCkpIHtcbiAgICAgICAgLy8gY3JlYXRlIGNvdW50IGZpZWxkXG4gICAgICAgIGNvbnN0IGFnZ3JlZ2F0ZUZpZWxkID0gbmV3IEFnZ3JlZ2F0ZUZpZWxkKHtcbiAgICAgICAgICBuYW1lOiBcImFnZ3JlZ2F0ZUNvdW50XCIsXG4gICAgICAgICAgb25TdGF0aXN0aWNGaWVsZDogdW5kZWZpbmVkLFxuICAgICAgICAgIGFsaWFzOiBcImFnZ3JlZ2F0ZUNvdW50XCIsXG4gICAgICAgICAgc3RhdGlzdGljVHlwZTogXCJjb3VudFwiLFxuICAgICAgICAgIHZpc2libGU6IHRydWVcbiAgICAgICAgfSk7XG4gICAgICAgIGxheWVyLmZlYXR1cmVSZWR1Y3Rpb24uZmllbGRzID0gW2FnZ3JlZ2F0ZUZpZWxkXTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGNvbG9yQ3JlYXRvci5jcmVhdGVDb250aW51b3VzUmVuZGVyZXIoe1xuICAgICAgICBsYXllcixcbiAgICAgICAgdmlldzogdmlldyxcbiAgICAgICAgZmllbGQ6IFwiYWdncmVnYXRlQ291bnRcIixcbiAgICAgICAgb3V0bGluZU9wdGltaXphdGlvbkVuYWJsZWQ6IHRydWUsXG4gICAgICAgIHNpemVPcHRpbWl6YXRpb25FbmFibGVkOiB0cnVlLFxuICAgICAgICBkZWZhdWx0U3ltYm9sRW5hYmxlZDogZmFsc2UsXG4gICAgICAgIGZvckJpbm5pbmc6IHRydWVcbiAgICAgIH0pO1xuICAgICAgbGF5ZXIuZmVhdHVyZVJlZHVjdGlvbi5yZW5kZXJlciA9IHJlc3VsdC5yZW5kZXJlcjtcbiAgICAgIC8vIGxheWVyIG5lZWRzIHRvIGhhdmUgdGhlIGZlYXR1cmVSZWR1Y3Rpb24gKyByZW5kZXJlciBiZWZvcmUgdGhpcyBjYW4gYmUgY2FsbGVkXG4gICAgICBjb25zdCBsYWJlbFNjaGVtZXMgPSBhd2FpdCBiaW5MYWJlbENyZWF0b3IuZ2V0TGFiZWxTY2hlbWVzKHtcbiAgICAgICAgbGF5ZXI6IGxheWVyXG4gICAgICB9KTtcbiAgICAgIGxheWVyLmZlYXR1cmVSZWR1Y3Rpb24ubGFiZWxpbmdJbmZvID0gKF9iID0gbGFiZWxTY2hlbWVzID09PSBudWxsIHx8IGxhYmVsU2NoZW1lcyA9PT0gdm9pZCAwID8gdm9pZCAwIDogbGFiZWxTY2hlbWVzLnByaW1hcnlTY2hlbWUpID09PSBudWxsIHx8IF9iID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYi5sYWJlbGluZ0luZm87XG4gICAgICBsYXllci5mZWF0dXJlUmVkdWN0aW9uLmxhYmVsc1Zpc2libGUgPSB0cnVlO1xuICAgICAgY29uc3QgZmllbGROYW1lcyA9IGxheWVyLmZlYXR1cmVSZWR1Y3Rpb24uZmllbGRzLm1hcCgoYWdncmVnYXRlRmllbGQpID0+IGFnZ3JlZ2F0ZUZpZWxkLm9uU3RhdGlzdGljRmllbGQpO1xuICAgICAgY29uc3QgcG9wdXBUZW1wbGF0ZSA9IHBvcHVwVXRpbHMuY3JlYXRlUG9wdXBUZW1wbGF0ZUZvckZlYXR1cmVSZWR1Y3Rpb24oe1xuICAgICAgICBmZWF0dXJlUmVkdWN0aW9uOiBsYXllci5mZWF0dXJlUmVkdWN0aW9uLFxuICAgICAgICBmaWVsZHM6IGxheWVyLmZpZWxkcy5maWx0ZXIoKGZpZWxkKSA9PiBmaWVsZE5hbWVzLmluZGV4T2YoZmllbGQubmFtZSkgPiAtMSlcbiAgICAgIH0pO1xuICAgICAgbGF5ZXIuZmVhdHVyZVJlZHVjdGlvbi5wb3B1cFRlbXBsYXRlID0gcG9wdXBUZW1wbGF0ZTtcbiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKTtcbiAgICB9XG4gICAgY2F0Y2ggKGUpIHtcbiAgICAgIGxheWVyLmZlYXR1cmVSZWR1Y3Rpb24gPSBsYXN0RmVhdHVyZVJlZHVjdGlvbjtcbiAgICAgIGlmIChsYXllci5mZWF0dXJlUmVkdWN0aW9uKSB7XG4gICAgICAgIHRpbGVOb2Rlc1tnZXRBZ2dyZWdhdGlvblR5cGUobGF5ZXIpXS5zZXRGb2N1cygpO1xuICAgICAgfVxuICAgICAgZWxzZSB7XG4gICAgICAgIHN3aXRjaE5vZGUuc2V0Rm9jdXMoKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdCgpO1xuICAgIH1cbiAgfVxuICBkaXNhYmxlQWdncmVnYXRpb24oKSB7XG4gICAgY29uc3QgeyBwcm9wcyB9ID0gdGhpcztcbiAgICBjb25zdCB7IGxheWVyIH0gPSBwcm9wcztcbiAgICBjb25zdCBhZ2dyZWdhdGlvblR5cGUgPSBnZXRBZ2dyZWdhdGlvblR5cGUobGF5ZXIpO1xuICAgIHRoaXMubGFzdEZlYXR1cmVSZWR1Y3Rpb25bYWdncmVnYXRpb25UeXBlXSA9IGxheWVyLmZlYXR1cmVSZWR1Y3Rpb247XG4gICAgdGhpcy5sYXN0RmVhdHVyZVJlZHVjdGlvblR5cGUgPSBhZ2dyZWdhdGlvblR5cGU7XG4gICAgbGF5ZXIuZmVhdHVyZVJlZHVjdGlvbiA9IG51bGw7XG4gICAgdGhpcy5hcmNnaXNBZ2dyZWdhdGlvbkNoYW5nZWQuZW1pdCgpO1xuICB9XG4gIHN0YXRpYyBnZXQgYXNzZXRzRGlycygpIHsgcmV0dXJuIFtcImFzc2V0c1wiXTsgfVxuICBnZXQgaG9zdEVsZW1lbnQoKSB7IHJldHVybiBnZXRFbGVtZW50KHRoaXMpOyB9XG59O1xuQXJjZ2lzQWdncmVnYXRpb24uc3R5bGUgPSBhcmNnaXNBZ2dyZWdhdGlvbkNzcztcblxuY29uc3QgYXJjZ2lzQWdncmVnYXRpb25CaW5uaW5nQ3NzID0gXCIuYmxvY2stc2VjdGlvbi5zYy1hcmNnaXMtYWdncmVnYXRpb24tYmlubmluZ3twYWRkaW5nOjAgMTBweH0uYmxvY2stY29udGVudC5zYy1hcmNnaXMtYWdncmVnYXRpb24tYmlubmluZ3twYWRkaW5nLXRvcDoxMHB4fS5zbGlkZXItdGl0bGUtd3JhcHBlci5zYy1hcmNnaXMtYWdncmVnYXRpb24tYmlubmluZ3tiYWNrZ3JvdW5kLWNvbG9yOnZhcigtLWFyY2dpcy1hcHAtYmFja2dyb3VuZCk7Ym9yZGVyLWJvdHRvbToxcHggc29saWQgdmFyKC0tYXJjZ2lzLWFwcC1ib3JkZXIpO3BhZGRpbmc6dmFyKC0tYXJjZ2lzLWFwcC1jYXAtc3BhY2luZykgdmFyKC0tYXJjZ2lzLWFwcC1zaWRlLXNwYWNpbmcpfS5zbGlkZXItZGl2LnNjLWFyY2dpcy1hZ2dyZWdhdGlvbi1iaW5uaW5ne2Rpc3BsYXk6ZmxleDthbGlnbi1pdGVtczpjZW50ZXI7anVzdGlmeS1jb250ZW50OnNwYWNlLWJldHdlZW47ZmxleC1mbG93OnJvdyB3cmFwfS5zbGlkZXItaGVhZGluZy5zYy1hcmNnaXMtYWdncmVnYXRpb24tYmlubmluZ3tkaXNwbGF5OmlubGluZS1ibG9jaztwYWRkaW5nOnZhcigtLWFyY2dpcy1hcHAtY2FwLXNwYWNpbmctaGFsZikgMDtmb250LXNpemU6dmFyKC0tYXJjZ2lzLWFwcC1mb250LXNpemUtMCl9LnNsaWRlci1sYWJlbC5zYy1hcmNnaXMtYWdncmVnYXRpb24tYmlubmluZ3tkaXNwbGF5OmlubGluZS1ibG9jaztwYWRkaW5nOnZhcigtLWFyY2dpcy1hcHAtY2FwLXNwYWNpbmctZWlnaHRoKSAwO2ZvbnQtc2l6ZTp2YXIoLS1hcmNnaXMtYXBwLWZvbnQtc2l6ZS0tMSk7b3JkZXI6Mn0uc2xpZGVyLXNsaWRlci5zYy1hcmNnaXMtYWdncmVnYXRpb24tYmlubmluZ3tkaXNwbGF5OmlubGluZS1ibG9jazt3aWR0aDoxMDAlO29yZGVyOjF9LmJ0bi1zZWN0aW9uLnNjLWFyY2dpcy1hZ2dyZWdhdGlvbi1iaW5uaW5ne2JhY2tncm91bmQtY29sb3I6dmFyKC0tYXJjZ2lzLWFwcC1iYWNrZ3JvdW5kKX0uYnRuLnNjLWFyY2dpcy1hZ2dyZWdhdGlvbi1iaW5uaW5ne2JhY2tncm91bmQ6dmFyKC0tYXJjZ2lzLWFwcC1iYWNrZ3JvdW5kLWNsZWFyKTtib3JkZXI6bm9uZTtib3JkZXItYm90dG9tOnNvbGlkIDFweCB2YXIoLS1hcmNnaXMtYXBwLWJvcmRlcik7Y29sb3I6dmFyKC0tYXJjZ2lzLWFwcC1mb250LWNvbG9yKTtkaXNwbGF5OmZsZXg7YWxpZ24taXRlbXM6Y2VudGVyO2p1c3RpZnktY29udGVudDpzcGFjZS1iZXR3ZWVuO3BhZGRpbmc6dmFyKC0tYXJjZ2lzLWFwcC1jYXAtc3BhY2luZykgdmFyKC0tYXJjZ2lzLWFwcC1zaWRlLXNwYWNpbmcpO2N1cnNvcjpwb2ludGVyO3dpZHRoOjEwMCU7dHJhbnNpdGlvbjpiYWNrZ3JvdW5kLWNvbG9yIHZhcigtLWFyY2dpcy1hcHAtYW5pbWF0aW9uLXRpbWUtZmFzdCkgdmFyKC0tYXJjZ2lzLWFwcC1lYXNpbmctZnVuY3Rpb24pLCBib3JkZXItY29sb3IgdmFyKC0tYXJjZ2lzLWFwcC1hbmltYXRpb24tdGltZS1mYXN0KSB2YXIoLS1hcmNnaXMtYXBwLWVhc2luZy1mdW5jdGlvbil9LmJ0bi5zYy1hcmNnaXMtYWdncmVnYXRpb24tYmlubmluZzpob3ZlcntiYWNrZ3JvdW5kLWNvbG9yOnZhcigtLWFyY2dpcy1hcHAtYmFja2dyb3VuZC1ob3Zlcik7Ym9yZGVyLWNvbG9yOnZhcigtLWFyY2dpcy1hcHAtYm9yZGVyLWhvdmVyKX0uYnRuLXRleHQuc2MtYXJjZ2lzLWFnZ3JlZ2F0aW9uLWJpbm5pbmd7Zm9udC1mYW1pbHk6dmFyKC0tYXJjZ2lzLWFwcC1mb250LWZhbWlseSk7Zm9udC1zaXplOnZhcigtLWFyY2dpcy1hcHAtZm9udC1zaXplLTApfS5zdHlsZS1idXR0b24tZGl2LnNjLWFyY2dpcy1hZ2dyZWdhdGlvbi1iaW5uaW5ne2JhY2tncm91bmQtY29sb3I6d2hpdGU7cGFkZGluZzoxMHB4fVwiO1xuXG5jb25zdCBBcmNnaXNBZ2dyZWdhdGlvbkJpbm5pbmcgPSBjbGFzcyB7XG4gIGNvbnN0cnVjdG9yKGhvc3RSZWYpIHtcbiAgICByZWdpc3Rlckluc3RhbmNlKHRoaXMsIGhvc3RSZWYpO1xuICAgIHRoaXMuYXJjZ2lzQWdncmVnYXRpb25CaW5uaW5nQ2hhbmdlID0gY3JlYXRlRXZlbnQodGhpcywgXCJhcmNnaXNBZ2dyZWdhdGlvbkJpbm5pbmdDaGFuZ2VcIiwgNyk7XG4gICAgdGhpcy5hcmNnaXNBZ2dyZWdhdGlvbkJpbm5pbmdEaXNtaXNzZWRDaGFuZ2UgPSBjcmVhdGVFdmVudCh0aGlzLCBcImFyY2dpc0FnZ3JlZ2F0aW9uQmlubmluZ0Rpc21pc3NlZENoYW5nZVwiLCA3KTtcbiAgICB0aGlzLmFyY2dpc0FnZ3JlZ2F0aW9uQmlubmluZ1N0eWxlQ2xpY2sgPSBjcmVhdGVFdmVudCh0aGlzLCBcImFyY2dpc0FnZ3JlZ2F0aW9uQmlubmluZ1N0eWxlQ2xpY2tcIiwgNyk7XG4gICAgdGhpcy5jYWxjaXRlUGFuZWxCYWNrQ2xpY2sgPSBjcmVhdGVFdmVudCh0aGlzLCBcImNhbGNpdGVQYW5lbEJhY2tDbGlja1wiLCA3KTtcbiAgICB0aGlzLmludGVybmFsQ2hhbmdlID0gY3JlYXRlRXZlbnQodGhpcywgXCJpbnRlcm5hbENoYW5nZVwiLCA3KTtcbiAgICB0aGlzLmNsb3NlTGFiZWxQb3BvdmVycyA9IGNyZWF0ZUV2ZW50KHRoaXMsIFwiY2xvc2VMYWJlbFBvcG92ZXJzXCIsIDcpO1xuICAgIHRoaXMuY2xvc2VQb3B1cFBvcG92ZXJzID0gY3JlYXRlRXZlbnQodGhpcywgXCJjbG9zZVBvcHVwUG9wb3ZlcnNcIiwgNyk7XG4gICAgdGhpcy5jbG9zZUF0dHJpYnV0ZVBvcG92ZXJzID0gY3JlYXRlRXZlbnQodGhpcywgXCJjbG9zZUF0dHJpYnV0ZVBvcG92ZXJzXCIsIDcpO1xuICAgIHRoaXMuZGlzYWJsZVNpemVTbGlkZXIgPSBmYWxzZTtcbiAgICB0aGlzLm9uQmluU2l6ZUNoYW5nZSA9IGRlYm91bmNlKGFzeW5jIChuZXdWYWx1ZSkgPT4ge1xuICAgICAgY29uc3QgeyBsYXllciwgdmlldywgbW9kdWxlcyB9ID0gdGhpcztcbiAgICAgIGNvbnN0IHsgY29sb3JDcmVhdG9yLCBBZ2dyZWdhdGVGaWVsZCB9ID0gbW9kdWxlcztcbiAgICAgIGNvbnN0IGZlYXR1cmVSZWR1Y3Rpb24gPSBsYXllci5mZWF0dXJlUmVkdWN0aW9uO1xuICAgICAgZmVhdHVyZVJlZHVjdGlvbi5maXhlZEJpbkxldmVsID0gbmV3VmFsdWU7XG4gICAgICAvLyBuZXcgcmVuZGVyZXJcbiAgICAgIGNvbnN0IGJpbm5pbmcgPSBsYXllci5mZWF0dXJlUmVkdWN0aW9uO1xuICAgICAgbGV0IGZpZWxkID0gYmlubmluZy5maWVsZHMuZmluZCgoYWdncmVnYXRlRmllbGQpID0+IGFnZ3JlZ2F0ZUZpZWxkLnN0YXRpc3RpY1R5cGUgPT09IFwiY291bnRcIik7XG4gICAgICBpZiAoIWZpZWxkKSB7XG4gICAgICAgIGZpZWxkID0gbmV3IEFnZ3JlZ2F0ZUZpZWxkKHtcbiAgICAgICAgICBuYW1lOiBcImFnZ3JlZ2F0ZUNvdW50XCIsXG4gICAgICAgICAgb25TdGF0aXN0aWNGaWVsZDogdW5kZWZpbmVkLFxuICAgICAgICAgIGFsaWFzOiBcImFnZ3JlZ2F0ZUNvdW50XCIsXG4gICAgICAgICAgc3RhdGlzdGljVHlwZTogXCJjb3VudFwiLFxuICAgICAgICAgIHZpc2libGU6IHRydWVcbiAgICAgICAgfSk7XG4gICAgICAgIGxheWVyLmZlYXR1cmVSZWR1Y3Rpb24uZmllbGRzLnB1c2goZmllbGQpO1xuICAgICAgfVxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgY29sb3JDcmVhdG9yLmNyZWF0ZUNvbnRpbnVvdXNSZW5kZXJlcih7XG4gICAgICAgIGxheWVyLFxuICAgICAgICB2aWV3OiB2aWV3LFxuICAgICAgICBmaWVsZDogZmllbGQubmFtZSxcbiAgICAgICAgb3V0bGluZU9wdGltaXphdGlvbkVuYWJsZWQ6IHRydWUsXG4gICAgICAgIHNpemVPcHRpbWl6YXRpb25FbmFibGVkOiB0cnVlLFxuICAgICAgICBkZWZhdWx0U3ltYm9sRW5hYmxlZDogZmFsc2UsXG4gICAgICAgIGZvckJpbm5pbmc6IHRydWVcbiAgICAgIH0pO1xuICAgICAgbGF5ZXIuZmVhdHVyZVJlZHVjdGlvbi5yZW5kZXJlciA9IHJlc3VsdC5yZW5kZXJlcjtcbiAgICAgIHRoaXMuaW50ZXJuYWxDaGFuZ2UuZW1pdCgpO1xuICAgIH0sIDMwMCk7XG4gICAgdGhpcy52aWV3ID0gdW5kZWZpbmVkO1xuICAgIHRoaXMubGF5ZXIgPSB1bmRlZmluZWQ7XG4gICAgdGhpcy5wb3J0YWwgPSB1bmRlZmluZWQ7XG4gICAgdGhpcy5jb25maWcgPSB1bmRlZmluZWQ7XG4gICAgdGhpcy5mbG93Tm9kZSA9IHVuZGVmaW5lZDtcbiAgICB0aGlzLnN0cmluZ3MgPSB1bmRlZmluZWQ7XG4gICAgdGhpcy5jdXJyZW50TGFuZ3VhZ2UgPSB1bmRlZmluZWQ7XG4gICAgdGhpcy5oaWRlTGF5ZXJUaXRsZSA9IGZhbHNlO1xuICB9XG4gIC8vIGNsb25lIGZlYXR1cmVSZWR1Y3Rpb24gdG8gdXBkYXRlIG1hcFxuICBpbnRlcm5hbENoYW5nZUhhbmRsZXIoKSB7XG4gICAgY29uc3QgeyBsYXllciB9ID0gdGhpcztcbiAgICBjb25zdCBmZWF0dXJlUmVkdWN0aW9uID0gbGF5ZXIuZmVhdHVyZVJlZHVjdGlvbjtcbiAgICBsYXllci5mZWF0dXJlUmVkdWN0aW9uID0gZmVhdHVyZVJlZHVjdGlvbi5jbG9uZSgpO1xuICAgIHRoaXMuYXJjZ2lzQWdncmVnYXRpb25CaW5uaW5nQ2hhbmdlLmVtaXQoKTtcbiAgfVxuICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIC8vXG4gIC8vICBwdWJsaWMgY2FsbHNcbiAgLy9cbiAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAvLyBQdWJsaWMgTWV0aG9kc1xuICBhc3luYyBkb25lKCkge1xuICAgIHRoaXMuY2xvc2VQb3BvdmVycygpO1xuICB9XG4gIGFzeW5jIHNldEZvY3VzKCkge1xuICAgIHRoaXMuZmxvd0l0ZW1Ob2RlLnNldEZvY3VzKCk7XG4gIH1cbiAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAvL1xuICAvLyAgTGlmZWN5Y2xlXG4gIC8vXG4gIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgYXN5bmMgY29tcG9uZW50V2lsbExvYWQoKSB7XG4gICAgLy8gb25seSB2YWxpZCBmb3IgcG9pbnRcbiAgICB0aGlzLmxheWVyR2VvbWV0cnlUeXBlID0gYXdhaXQgZ2V0TGF5ZXJHZW9tZXRyeVR5cGUodGhpcy5sYXllcik7XG4gICAgY29uc3QgW0FnZ3JlZ2F0ZUZpZWxkLCBjb2xvckNyZWF0b3JdID0gYXdhaXQgbG9hZE1vZHVsZXMoW1xuICAgICAgXCJlc3JpL2xheWVycy9zdXBwb3J0L0FnZ3JlZ2F0ZUZpZWxkXCIsXG4gICAgICBcImVzcmkvc21hcnRNYXBwaW5nL3JlbmRlcmVycy9jb2xvclwiXG4gICAgXSk7XG4gICAgdGhpcy5tb2R1bGVzID0ge1xuICAgICAgQWdncmVnYXRlRmllbGQsXG4gICAgICBjb2xvckNyZWF0b3JcbiAgICB9O1xuICB9XG4gIGNvbXBvbmVudERpZExvYWQoKSB7XG4gICAgc2V0VGltZW91dCgoKSA9PiByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKCkgPT4gdGhpcy5mbG93SXRlbU5vZGUuc2V0Rm9jdXMoKSksIDIwMCk7XG4gIH1cbiAgY29tcG9uZW50RGlkVXBkYXRlKCkge1xuICAgIC8vdGhpcy5pbnRlcm5hbENoYW5nZS5lbWl0KCk7XG4gIH1cbiAgZGlzY29ubmVjdGVkQ2FsbGJhY2soKSB7XG4gICAgdGhpcy5jbG9zZVBvcG92ZXJzKCk7XG4gIH1cbiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgLy9cbiAgLy8gIFJlbmRlciBNZXRob2RzXG4gIC8vXG4gIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgcmVuZGVyKCkge1xuICAgIGNvbnN0IHsgbGF5ZXIsIHN0cmluZ3MsIGhpZGVMYXllclRpdGxlIH0gPSB0aGlzO1xuICAgIC8vY29uc3QgZmVhdHVyZVJlZHVjdGlvbiA9IGxheWVyLmZlYXR1cmVSZWR1Y3Rpb24gYXMgYW55OyAvL19fZXNyaS5GZWF0dXJlUmVkdWN0aW9uQ2x1c3RlcjtcbiAgICByZXR1cm4gKGgoSG9zdCwgeyBjbGFzczogXCJjYWxjaXRlLW1hdGNoLWhlaWdodFwiIH0sIGgoXCJjYWxjaXRlLWZsb3ctaXRlbVwiLCB7IGhlYWRpbmc6IHN0cmluZ3MuYmlubmluZywgZGVzY3JpcHRpb246ICFoaWRlTGF5ZXJUaXRsZSA/IGxheWVyLnRpdGxlIDogdW5kZWZpbmVkLCBvbkNhbGNpdGVGbG93SXRlbUJhY2s6ICgpID0+IHtcbiAgICAgICAgdGhpcy5jYWxjaXRlUGFuZWxCYWNrQ2xpY2suZW1pdCgpO1xuICAgICAgICAvL3RoaXMuY2xvc2VQb3BvdmVycygpO1xuICAgICAgfSwgcmVmOiAobm9kZSkgPT4gKHRoaXMuZmxvd0l0ZW1Ob2RlID0gbm9kZSkgfSwgdGhpcy5yZW5kZXJCaW5TaXplKCksIHRoaXMucmVuZGVyRmllbGRzQnRuKCksIHRoaXMucmVuZGVyTGFiZWxCdG4oKSwgdGhpcy5yZW5kZXJQb3B1cEJ0bigpLCB0aGlzLnJlbmRlckdvVG9TdHlsZSgpKSkpO1xuICB9XG4gIHJlbmRlckJpblNpemUoKSB7XG4gICAgdmFyIF9hO1xuICAgIGNvbnN0IHsgbGF5ZXIsIHN0cmluZ3MgfSA9IHRoaXM7XG4gICAgLy8gbmVlZCB0byBzd2l0Y2ggbGFiZWxzIGJhY2sgaW4gcnRsXG4gICAgY29uc3QgcnRsID0gZ2V0RWxlbWVudERpcih0aGlzLmhvc3RFbGVtZW50KSA9PT0gXCJydGxcIjtcbiAgICBjb25zdCBmZWF0dXJlUmVkdWN0aW9uID0gbGF5ZXIuZmVhdHVyZVJlZHVjdGlvbjtcbiAgICByZXR1cm4gKGgoXCJkaXZcIiwgeyBjbGFzczogXCJzbGlkZXItdGl0bGUtd3JhcHBlclwiIH0sIGgoXCJsYWJlbFwiLCB7IGNsYXNzOiBcInNsaWRlci1oZWFkaW5nXCIgfSwgc3RyaW5ncy5iaW4uYmluU2l6ZVRpdGxlKSwgaChcImRpdlwiLCB7IGNsYXNzOiBcInNsaWRlci1kaXZcIiB9LCBoKFwibGFiZWxcIiwgeyBjbGFzczogXCJzbGlkZXItbGFiZWxcIiB9LCBydGwgPyBzdHJpbmdzLmJpbi5sYXJnZSA6IHN0cmluZ3MuYmluLnNtYWxsKSwgaChcImNhbGNpdGUtc2xpZGVyXCIsIHsgY2xhc3M6IFwic2xpZGVyLXNsaWRlclwiLCBtaW46IDEsIG1heDogOSwgdmFsdWU6IDEwIC0gKChfYSA9IGZlYXR1cmVSZWR1Y3Rpb24uZml4ZWRCaW5MZXZlbCkgIT09IG51bGwgJiYgX2EgIT09IHZvaWQgMCA/IF9hIDogMyksIHN0ZXA6IDEsIG1pbkxhYmVsOiBzdHJpbmdzLmJpbi5iaW5TaXplVGl0bGUsIG9uQ2FsY2l0ZVNsaWRlcklucHV0OiAoZXZlbnQpID0+IHtcbiAgICAgICAgY29uc3Qgc2xpZGVyID0gZXZlbnQudGFyZ2V0O1xuICAgICAgICB0aGlzLm9uQmluU2l6ZUNoYW5nZSgxMCAtIHNsaWRlci52YWx1ZSk7XG4gICAgICB9IH0pLCBoKFwibGFiZWxcIiwgeyBjbGFzczogXCJzbGlkZXItbGFiZWxcIiB9LCBydGwgPyBzdHJpbmdzLmJpbi5zbWFsbCA6IHN0cmluZ3MuYmluLmxhcmdlKSkpKTtcbiAgfVxuICByZW5kZXJGaWVsZHNCdG4oKSB7XG4gICAgY29uc3QgeyBzdHJpbmdzIH0gPSB0aGlzO1xuICAgIGNvbnN0IHJ0bCA9IGdldEVsZW1lbnREaXIodGhpcy5ob3N0RWxlbWVudCkgPT09IFwicnRsXCI7XG4gICAgcmV0dXJuIChoKFwiZGl2XCIsIHsgY2xhc3M6IFwiYnRuLXNlY3Rpb25cIiB9LCBoKFwiYnV0dG9uXCIsIHsgY2xhc3M6IFwiYnRuXCIsIG9uQ2xpY2s6IChldmVudCkgPT4gdGhpcy5hZGRGaWVsZHNQYW5lbChldmVudCkgfSwgaChcInNwYW5cIiwgeyBjbGFzczogXCJidG4tdGV4dFwiIH0sIHN0cmluZ3MuYmluLmVkaXRBdHRyaWJ1dGVzKSwgaChcInNwYW5cIiwgeyBjbGFzczogXCJidG4taWNvblwiIH0sIGgoXCJjYWxjaXRlLWljb25cIiwgeyBzY2FsZTogXCJzXCIsIGljb246IHJ0bCA/IFwiY2hldnJvbi1sZWZ0XCIgOiBcImNoZXZyb24tcmlnaHRcIiB9KSkpKSk7XG4gIH1cbiAgcmVuZGVyTGFiZWxCdG4oKSB7XG4gICAgY29uc3QgeyBzdHJpbmdzIH0gPSB0aGlzO1xuICAgIGNvbnN0IHJ0bCA9IGdldEVsZW1lbnREaXIodGhpcy5ob3N0RWxlbWVudCkgPT09IFwicnRsXCI7XG4gICAgcmV0dXJuIChoKFwiZGl2XCIsIHsgY2xhc3M6IFwiYnRuLXNlY3Rpb25cIiB9LCBoKFwiYnV0dG9uXCIsIHsgY2xhc3M6IFwiYnRuXCIsIG9uQ2xpY2s6IChldmVudCkgPT4gdGhpcy5hZGRMYWJlbFBhbmVsKGV2ZW50KSB9LCBoKFwic3BhblwiLCB7IGNsYXNzOiBcImJ0bi10ZXh0XCIgfSwgc3RyaW5ncy5iaW4uZWRpdExhYmVsKSwgaChcInNwYW5cIiwgeyBjbGFzczogXCJidG4taWNvblwiIH0sIGgoXCJjYWxjaXRlLWljb25cIiwgeyBzY2FsZTogXCJzXCIsIGljb246IHJ0bCA/IFwiY2hldnJvbi1sZWZ0XCIgOiBcImNoZXZyb24tcmlnaHRcIiB9KSkpKSk7XG4gIH1cbiAgcmVuZGVyUG9wdXBCdG4oKSB7XG4gICAgY29uc3QgeyBzdHJpbmdzIH0gPSB0aGlzO1xuICAgIGNvbnN0IHJ0bCA9IGdldEVsZW1lbnREaXIodGhpcy5ob3N0RWxlbWVudCkgPT09IFwicnRsXCI7XG4gICAgcmV0dXJuIChoKFwiZGl2XCIsIHsgY2xhc3M6IFwiYnRuLXNlY3Rpb25cIiB9LCBoKFwiYnV0dG9uXCIsIHsgY2xhc3M6IFwiYnRuXCIsIG9uQ2xpY2s6IChldmVudCkgPT4gdGhpcy5hZGRQb3B1cFBhbmVsKGV2ZW50KSB9LCBoKFwic3BhblwiLCB7IGNsYXNzOiBcImJ0bi10ZXh0XCIgfSwgc3RyaW5ncy5iaW4uZWRpdFBvcHVwcyksIGgoXCJzcGFuXCIsIHsgY2xhc3M6IFwiYnRuLWljb25cIiB9LCBoKFwiY2FsY2l0ZS1pY29uXCIsIHsgc2NhbGU6IFwic1wiLCBpY29uOiBydGwgPyBcImNoZXZyb24tbGVmdFwiIDogXCJjaGV2cm9uLXJpZ2h0XCIgfSkpKSkpO1xuICB9XG4gIHJlbmRlckdvVG9TdHlsZSgpIHtcbiAgICBjb25zdCB7IHN0cmluZ3MgfSA9IHRoaXM7XG4gICAgcmV0dXJuIChoKFwiZGl2XCIsIHsgY2xhc3M6IFwic3R5bGUtYnV0dG9uLWRpdlwiIH0sIGgoXCJjYWxjaXRlLWJ1dHRvblwiLCB7IGFsaWdubWVudDogXCJjZW50ZXJcIiwgYXBwZWFyYW5jZTogXCJ0cmFuc3BhcmVudFwiLCBzY2FsZTogXCJtXCIsIHdpZHRoOiBcImZ1bGxcIiwgY2xhc3M6IFwic3R5bGUtYnV0dG9uXCIsIG9uQ2xpY2s6ICgpID0+IHRoaXMuYXJjZ2lzQWdncmVnYXRpb25CaW5uaW5nU3R5bGVDbGljay5lbWl0KCkgfSwgc3RyaW5ncy5iaW4uZWRpdEJpblN0eWxlKSkpO1xuICB9XG4gIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIC8vXG4gIC8vICBQcml2YXRlIG1ldGhvZHNcbiAgLy9cbiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgY2xvc2VQb3BvdmVycygpIHtcbiAgICB0aGlzLmNsb3NlQXR0cmlidXRlUG9wb3ZlcnMuZW1pdCgpO1xuICAgIHRoaXMuY2xvc2VMYWJlbFBvcG92ZXJzLmVtaXQoKTtcbiAgICB0aGlzLmNsb3NlUG9wdXBQb3BvdmVycy5lbWl0KCk7XG4gIH1cbiAgYWRkRmllbGRzUGFuZWwoZXZlbnQpIHtcbiAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICB0aGlzLmNsb3NlUG9wb3ZlcnMoKTtcbiAgICBjb25zdCB7IGxheWVyLCB2aWV3LCBjdXJyZW50TGFuZ3VhZ2UsIHN0cmluZ3MsIGZsb3dOb2RlLCBoaWRlTGF5ZXJUaXRsZSB9ID0gdGhpcztcbiAgICBjb25zdCBmaWVsZHNOb2RlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImFyY2dpcy1hZ2dyZWdhdGlvbi1maWVsZHNcIik7XG4gICAgZmllbGRzTm9kZS5sYW5nID0gY3VycmVudExhbmd1YWdlO1xuICAgIGZpZWxkc05vZGUubGF5ZXIgPSBsYXllcjtcbiAgICBmaWVsZHNOb2RlLm1hcFZpZXcgPSB2aWV3O1xuICAgIGZpZWxkc05vZGUuc3RyaW5ncyA9IHN0cmluZ3M7XG4gICAgZmllbGRzTm9kZS5jdXJyZW50TGFuZ3VhZ2UgPSBjdXJyZW50TGFuZ3VhZ2U7XG4gICAgZmllbGRzTm9kZS5oaWRlTGF5ZXJUaXRsZSA9IGhpZGVMYXllclRpdGxlO1xuICAgIGZpZWxkc05vZGUuZmxvd05vZGUgPSBmbG93Tm9kZTtcbiAgICBmaWVsZHNOb2RlLmFkZEV2ZW50TGlzdGVuZXIoXCJhcmNnaXNBZ2dyZWdhdGlvbkZpZWxkc0NoYW5nZVwiLCAoKSA9PiB7XG4gICAgICB0aGlzLmludGVybmFsQ2hhbmdlLmVtaXQoKTtcbiAgICAgIGZvcmNlVXBkYXRlKHRoaXMuaG9zdEVsZW1lbnQpO1xuICAgIH0pO1xuICAgIGZsb3dOb2RlLmFwcGVuZENoaWxkKGZpZWxkc05vZGUpO1xuICB9XG4gIGFkZExhYmVsUGFuZWwoZXZlbnQpIHtcbiAgICBjb25zdCB7IGxheWVyLCB2aWV3LCBwb3J0YWwsIGNvbmZpZywgY3VycmVudExhbmd1YWdlLCBzdHJpbmdzLCBmbG93Tm9kZSwgaGlkZUxheWVyVGl0bGUgfSA9IHRoaXM7XG4gICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgdGhpcy5jbG9zZVBvcG92ZXJzKCk7XG4gICAgY29uc3QgbGFiZWxGbG93SXRlbSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJjYWxjaXRlLWZsb3ctaXRlbVwiKTtcbiAgICAvL2xhYmVsRmxvd0l0ZW0uaWQgPSBcImxhYmVsRmxvd0l0ZW1fSWRcIjtcbiAgICBsYWJlbEZsb3dJdGVtLmhlYWRpbmcgPSBzdHJpbmdzLmJpbi5sYWJlbEZlYXR1cmVzSGVhZGluZztcbiAgICBsYWJlbEZsb3dJdGVtLmRlc2NyaXB0aW9uID0gIWhpZGVMYXllclRpdGxlID8gbGF5ZXIudGl0bGUgOiB1bmRlZmluZWQ7XG4gICAgY29uc3QgY2FsY2l0ZUZhYiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJjYWxjaXRlLWZhYlwiKTtcbiAgICBjYWxjaXRlRmFiLmljb24gPSBcInBsdXNcIjtcbiAgICBjYWxjaXRlRmFiLnNsb3QgPSBcImZhYlwiO1xuICAgIGNhbGNpdGVGYWIuc2NhbGUgPSBcInNcIjtcbiAgICBjYWxjaXRlRmFiLmFwcGVhcmFuY2UgPSBcIm91dGxpbmUtZmlsbFwiO1xuICAgIGNhbGNpdGVGYWIua2luZCA9IFwibmV1dHJhbFwiO1xuICAgIGNhbGNpdGVGYWIubGFiZWwgPSBzdHJpbmdzLmJpbi5sYWJlbEZhYjtcbiAgICBjYWxjaXRlRmFiLnRleHQgPSBzdHJpbmdzLmJpbi5sYWJlbEZhYjtcbiAgICBjYWxjaXRlRmFiLnRleHRFbmFibGVkID0gdHJ1ZTtcbiAgICBsYWJlbEZsb3dJdGVtLmFwcGVuZENoaWxkKGNhbGNpdGVGYWIpO1xuICAgIGNvbnN0IGxhYmVsQ29tcG9uZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImFyY2dpcy1sYWJlbFwiKTtcbiAgICBsYWJlbENvbXBvbmVudC5sYW5nID0gY3VycmVudExhbmd1YWdlO1xuICAgIGxhYmVsQ29tcG9uZW50LmxheWVyID0gbGF5ZXI7XG4gICAgbGFiZWxDb21wb25lbnQubWFwVmlldyA9IHZpZXc7XG4gICAgbGFiZWxDb21wb25lbnQucG9ydGFsID0gcG9ydGFsO1xuICAgIGxhYmVsQ29tcG9uZW50LmNvbmZpZyA9IGNvbmZpZztcbiAgICBsYWJlbENvbXBvbmVudC5sYXllckRpc3BsYXlUeXBlID0gbGF5ZXJEaXNwbGF5VHlwZUVudW0uY2x1c3RlcjtcbiAgICBsYWJlbENvbXBvbmVudC5jYWxjaXRlRmxvd1Byb3BzID0geyBjYWxjaXRlRmxvd0l0ZW06IGxhYmVsRmxvd0l0ZW0sIGNhbGNpdGVGYWI6IGNhbGNpdGVGYWIgfTtcbiAgICBsYWJlbENvbXBvbmVudC5hZGRFdmVudExpc3RlbmVyKFwibGFiZWxVcGRhdGVkXCIsICgpID0+IHtcbiAgICAgIHRoaXMuaW50ZXJuYWxDaGFuZ2UuZW1pdCgpO1xuICAgICAgZm9yY2VVcGRhdGUodGhpcy5ob3N0RWxlbWVudCk7XG4gICAgfSk7XG4gICAgbGFiZWxGbG93SXRlbS5hcHBlbmRDaGlsZChsYWJlbENvbXBvbmVudCk7XG4gICAgZmxvd05vZGUuYXBwZW5kQ2hpbGQobGFiZWxGbG93SXRlbSk7XG4gICAgc2V0VGltZW91dCgoKSA9PiByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKCkgPT4gbGFiZWxGbG93SXRlbS5zZXRGb2N1cygpKSwgMjAwKTtcbiAgfVxuICBhZGRQb3B1cFBhbmVsKGV2ZW50KSB7XG4gICAgY29uc3QgeyBsYXllciwgdmlldywgcG9ydGFsLCBjb25maWcsIGN1cnJlbnRMYW5ndWFnZSwgc3RyaW5ncywgZmxvd05vZGUsIGhpZGVMYXllclRpdGxlIH0gPSB0aGlzO1xuICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgIHRoaXMuY2xvc2VQb3BvdmVycygpO1xuICAgIGNvbnN0IHBvcHVwRmxvd0l0ZW0gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiY2FsY2l0ZS1mbG93LWl0ZW1cIik7XG4gICAgcG9wdXBGbG93SXRlbS5oZWFkaW5nID0gc3RyaW5ncy5iaW4ucG9wdXBzSGVhZGluZztcbiAgICBwb3B1cEZsb3dJdGVtLmRlc2NyaXB0aW9uID0gIWhpZGVMYXllclRpdGxlID8gbGF5ZXIudGl0bGUgOiB1bmRlZmluZWQ7XG4gICAgY29uc3QgY2FsY2l0ZUZhYiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJjYWxjaXRlLWZhYlwiKTtcbiAgICBjYWxjaXRlRmFiLmljb24gPSBcInBsdXNcIjtcbiAgICBjYWxjaXRlRmFiLnNsb3QgPSBcImZhYlwiO1xuICAgIGNhbGNpdGVGYWIuc2NhbGUgPSBcInNcIjtcbiAgICBjYWxjaXRlRmFiLmFwcGVhcmFuY2UgPSBcIm91dGxpbmUtZmlsbFwiO1xuICAgIGNhbGNpdGVGYWIua2luZCA9IFwibmV1dHJhbFwiO1xuICAgIGNhbGNpdGVGYWIubGFiZWwgPSBzdHJpbmdzLmJpbi5wb3B1cEZhYjtcbiAgICBjYWxjaXRlRmFiLnRleHQgPSBzdHJpbmdzLmJpbi5wb3B1cEZhYjtcbiAgICBjYWxjaXRlRmFiLnRleHRFbmFibGVkID0gdHJ1ZTtcbiAgICBwb3B1cEZsb3dJdGVtLmFwcGVuZENoaWxkKGNhbGNpdGVGYWIpO1xuICAgIGNvbnN0IHBvcHVwQ29tcG9uZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImFyY2dpcy1wb3B1cFwiKTtcbiAgICBwb3B1cENvbXBvbmVudC5sYW5nID0gY3VycmVudExhbmd1YWdlO1xuICAgIHBvcHVwQ29tcG9uZW50LmxheWVyID0gbGF5ZXI7XG4gICAgcG9wdXBDb21wb25lbnQubWFwVmlldyA9IHZpZXc7XG4gICAgcG9wdXBDb21wb25lbnQucG9ydGFsID0gcG9ydGFsO1xuICAgIHBvcHVwQ29tcG9uZW50LmNvbmZpZyA9IGNvbmZpZztcbiAgICBwb3B1cENvbXBvbmVudC5sYXllckRpc3BsYXlUeXBlID0gbGF5ZXJEaXNwbGF5VHlwZUVudW0uY2x1c3RlcjtcbiAgICBwb3B1cENvbXBvbmVudC5jYWxjaXRlRmxvd1Byb3BzID0ge1xuICAgICAgZmxvdzogZmxvd05vZGUsXG4gICAgICBjYWxjaXRlRmFiOiBjYWxjaXRlRmFiLFxuICAgICAgY2FsY2l0ZUZsb3dJdGVtOiBwb3B1cEZsb3dJdGVtXG4gICAgfTtcbiAgICBwb3B1cENvbXBvbmVudC5hZGRFdmVudExpc3RlbmVyKFwicG9wdXBVcGRhdGVkXCIsICgpID0+IHtcbiAgICAgIHRoaXMuaW50ZXJuYWxDaGFuZ2UuZW1pdCgpO1xuICAgICAgZm9yY2VVcGRhdGUodGhpcy5ob3N0RWxlbWVudCk7XG4gICAgfSk7XG4gICAgcG9wdXBGbG93SXRlbS5hcHBlbmRDaGlsZChwb3B1cENvbXBvbmVudCk7XG4gICAgZmxvd05vZGUuYXBwZW5kQ2hpbGQocG9wdXBGbG93SXRlbSk7XG4gICAgcG9wdXBGbG93SXRlbS5zZXRGb2N1cygpO1xuICAgIHNldFRpbWVvdXQoKCkgPT4gcmVxdWVzdEFuaW1hdGlvbkZyYW1lKCgpID0+IHBvcHVwRmxvd0l0ZW0uc2V0Rm9jdXMoKSksIDIwMCk7XG4gIH1cbiAgZ2V0IGhvc3RFbGVtZW50KCkgeyByZXR1cm4gZ2V0RWxlbWVudCh0aGlzKTsgfVxufTtcbkFyY2dpc0FnZ3JlZ2F0aW9uQmlubmluZy5zdHlsZSA9IGFyY2dpc0FnZ3JlZ2F0aW9uQmlubmluZ0NzcztcblxuY29uc3QgYXJjZ2lzQWdncmVnYXRpb25DbHVzdGVyaW5nQ3NzID0gXCIuYmxvY2stc2VjdGlvbi5zYy1hcmNnaXMtYWdncmVnYXRpb24tY2x1c3RlcmluZ3twYWRkaW5nOjAgMTBweH0uYmxvY2stY29udGVudC5zYy1hcmNnaXMtYWdncmVnYXRpb24tY2x1c3RlcmluZ3twYWRkaW5nLXRvcDoxMHB4fS5zeW1ib2wtYnV0dG9uLnNjLWFyY2dpcy1hZ2dyZWdhdGlvbi1jbHVzdGVyaW5ne2JvcmRlcjpzb2xpZCAxcHggdmFyKC0tYXJjZ2lzLWFwcC1ib3JkZXIpO2Rpc3BsYXk6ZmxleDtqdXN0aWZ5LWNvbnRlbnQ6c3BhY2UtYmV0d2Vlbn0uc3ltYm9sLWJ1dHRvbi5zZWxlY3RlZC5zYy1hcmNnaXMtYWdncmVnYXRpb24tY2x1c3RlcmluZ3tib3JkZXItY29sb3I6dmFyKC0tY2FsY2l0ZS11aS1icmFuZCk7Ym9yZGVyLXdpZHRoOjFweH0uc3ltYm9sLWJ1dHRvbi5zYy1hcmNnaXMtYWdncmVnYXRpb24tY2x1c3RlcmluZzpob3ZlcntiYWNrZ3JvdW5kLWNvbG9yOnZhcigtLWFyY2dpcy1hcHAtYmFja2dyb3VuZC1ob3Zlcik7Ym9yZGVyLWNvbG9yOnZhcigtLWFyY2dpcy1hcHAtYm9yZGVyLWhvdmVyKX0uc3ltYm9sLWJ1dHRvbi5zYy1hcmNnaXMtYWdncmVnYXRpb24tY2x1c3RlcmluZzpmb2N1c3tib3JkZXItY29sb3I6dmFyKC0tY2FsY2l0ZS11aS1icmFuZCk7Ym9yZGVyLXdpZHRoOjJweH0uc3ltYm9sLnNjLWFyY2dpcy1hZ2dyZWdhdGlvbi1jbHVzdGVyaW5ne3BhZGRpbmc6NXB4fS5zeW1ib2wtaWNvbi5zYy1hcmNnaXMtYWdncmVnYXRpb24tY2x1c3RlcmluZ3twYWRkaW5nOjZweH0uc2xpZGVyLXRpdGxlLXdyYXBwZXIuc2MtYXJjZ2lzLWFnZ3JlZ2F0aW9uLWNsdXN0ZXJpbmd7YmFja2dyb3VuZC1jb2xvcjp2YXIoLS1hcmNnaXMtYXBwLWJhY2tncm91bmQpO2JvcmRlci1ib3R0b206MXB4IHNvbGlkIHZhcigtLWFyY2dpcy1hcHAtYm9yZGVyKTtwYWRkaW5nOnZhcigtLWFyY2dpcy1hcHAtY2FwLXNwYWNpbmcpIHZhcigtLWFyY2dpcy1hcHAtc2lkZS1zcGFjaW5nKX0uc2xpZGVyLWRpdi5zYy1hcmNnaXMtYWdncmVnYXRpb24tY2x1c3RlcmluZ3tkaXNwbGF5OmZsZXg7YWxpZ24taXRlbXM6Y2VudGVyO2p1c3RpZnktY29udGVudDpzcGFjZS1iZXR3ZWVuO2ZsZXgtZmxvdzpyb3cgd3JhcH0uc2xpZGVyLWhlYWRpbmcuc2MtYXJjZ2lzLWFnZ3JlZ2F0aW9uLWNsdXN0ZXJpbmd7ZGlzcGxheTppbmxpbmUtYmxvY2s7cGFkZGluZzp2YXIoLS1hcmNnaXMtYXBwLWNhcC1zcGFjaW5nLWhhbGYpIDA7Zm9udC1zaXplOnZhcigtLWFyY2dpcy1hcHAtZm9udC1zaXplLTApfS5zbGlkZXItbGFiZWwuc2MtYXJjZ2lzLWFnZ3JlZ2F0aW9uLWNsdXN0ZXJpbmd7ZGlzcGxheTppbmxpbmUtYmxvY2s7cGFkZGluZzp2YXIoLS1hcmNnaXMtYXBwLWNhcC1zcGFjaW5nLWVpZ2h0aCkgMDtmb250LXNpemU6dmFyKC0tYXJjZ2lzLWFwcC1mb250LXNpemUtLTEpO29yZGVyOjJ9LnNsaWRlci1zbGlkZXIuc2MtYXJjZ2lzLWFnZ3JlZ2F0aW9uLWNsdXN0ZXJpbmd7ZGlzcGxheTppbmxpbmUtYmxvY2s7d2lkdGg6MTAwJTtvcmRlcjoxfS5jbHVzdGVyLWJ0bi1zZWN0aW9uLnNjLWFyY2dpcy1hZ2dyZWdhdGlvbi1jbHVzdGVyaW5ne2JhY2tncm91bmQtY29sb3I6dmFyKC0tYXJjZ2lzLWFwcC1iYWNrZ3JvdW5kKX0uY2x1c3Rlci1idG4uc2MtYXJjZ2lzLWFnZ3JlZ2F0aW9uLWNsdXN0ZXJpbmd7YmFja2dyb3VuZDp2YXIoLS1hcmNnaXMtYXBwLWJhY2tncm91bmQtY2xlYXIpO2JvcmRlcjpub25lO2JvcmRlci1ib3R0b206c29saWQgMXB4IHZhcigtLWFyY2dpcy1hcHAtYm9yZGVyKTtjb2xvcjp2YXIoLS1hcmNnaXMtYXBwLWZvbnQtY29sb3IpO2Rpc3BsYXk6ZmxleDthbGlnbi1pdGVtczpjZW50ZXI7anVzdGlmeS1jb250ZW50OnNwYWNlLWJldHdlZW47cGFkZGluZzp2YXIoLS1hcmNnaXMtYXBwLWNhcC1zcGFjaW5nKSB2YXIoLS1hcmNnaXMtYXBwLXNpZGUtc3BhY2luZyk7Y3Vyc29yOnBvaW50ZXI7d2lkdGg6MTAwJTt0cmFuc2l0aW9uOmJhY2tncm91bmQtY29sb3IgdmFyKC0tYXJjZ2lzLWFwcC1hbmltYXRpb24tdGltZS1mYXN0KSB2YXIoLS1hcmNnaXMtYXBwLWVhc2luZy1mdW5jdGlvbiksIGJvcmRlci1jb2xvciB2YXIoLS1hcmNnaXMtYXBwLWFuaW1hdGlvbi10aW1lLWZhc3QpIHZhcigtLWFyY2dpcy1hcHAtZWFzaW5nLWZ1bmN0aW9uKX0uY2x1c3Rlci1idG4uc2MtYXJjZ2lzLWFnZ3JlZ2F0aW9uLWNsdXN0ZXJpbmc6aG92ZXJ7YmFja2dyb3VuZC1jb2xvcjp2YXIoLS1hcmNnaXMtYXBwLWJhY2tncm91bmQtaG92ZXIpO2JvcmRlci1jb2xvcjp2YXIoLS1hcmNnaXMtYXBwLWJvcmRlci1ob3Zlcil9LmNsdXN0ZXItYnRuLnNjLWFyY2dpcy1hZ2dyZWdhdGlvbi1jbHVzdGVyaW5nOmZvY3Vze2JvcmRlcjoycHggc29saWQgdmFyKC0tY2FsY2l0ZS11aS1icmFuZCl9LmNsdXN0ZXItYnRuLXRleHQuc2MtYXJjZ2lzLWFnZ3JlZ2F0aW9uLWNsdXN0ZXJpbmd7Zm9udC1mYW1pbHk6dmFyKC0tYXJjZ2lzLWFwcC1mb250LWZhbWlseSk7Zm9udC1zaXplOnZhcigtLWFyY2dpcy1hcHAtZm9udC1zaXplLTApfVwiO1xuXG5jb25zdCBBcmNnaXNBZ2dyZWdhdGlvbkNsdXN0ZXJpbmcgPSBjbGFzcyB7XG4gIGNvbnN0cnVjdG9yKGhvc3RSZWYpIHtcbiAgICByZWdpc3Rlckluc3RhbmNlKHRoaXMsIGhvc3RSZWYpO1xuICAgIHRoaXMuYXJjZ2lzQWdncmVnYXRpb25DbHVzdGVyaW5nQ2hhbmdlID0gY3JlYXRlRXZlbnQodGhpcywgXCJhcmNnaXNBZ2dyZWdhdGlvbkNsdXN0ZXJpbmdDaGFuZ2VcIiwgNyk7XG4gICAgdGhpcy5hcmNnaXNBZ2dyZWdhdGlvbkNsdXN0ZXJpbmdEaXNtaXNzZWRDaGFuZ2UgPSBjcmVhdGVFdmVudCh0aGlzLCBcImFyY2dpc0FnZ3JlZ2F0aW9uQ2x1c3RlcmluZ0Rpc21pc3NlZENoYW5nZVwiLCA3KTtcbiAgICB0aGlzLmNhbGNpdGVQYW5lbEJhY2tDbGljayA9IGNyZWF0ZUV2ZW50KHRoaXMsIFwiY2FsY2l0ZVBhbmVsQmFja0NsaWNrXCIsIDcpO1xuICAgIHRoaXMuaW50ZXJuYWxDaGFuZ2UgPSBjcmVhdGVFdmVudCh0aGlzLCBcImludGVybmFsQ2hhbmdlXCIsIDcpO1xuICAgIHRoaXMuY2xvc2VMYWJlbFBvcG92ZXJzID0gY3JlYXRlRXZlbnQodGhpcywgXCJjbG9zZUxhYmVsUG9wb3ZlcnNcIiwgNyk7XG4gICAgdGhpcy5jbG9zZVBvcHVwUG9wb3ZlcnMgPSBjcmVhdGVFdmVudCh0aGlzLCBcImNsb3NlUG9wdXBQb3BvdmVyc1wiLCA3KTtcbiAgICB0aGlzLmNsb3NlQXR0cmlidXRlUG9wb3ZlcnMgPSBjcmVhdGVFdmVudCh0aGlzLCBcImNsb3NlQXR0cmlidXRlUG9wb3ZlcnNcIiwgNyk7XG4gICAgdGhpcy5kaXNhYmxlU2l6ZVNsaWRlciA9IGZhbHNlO1xuICAgIHRoaXMudmlldyA9IHVuZGVmaW5lZDtcbiAgICB0aGlzLmxheWVyID0gdW5kZWZpbmVkO1xuICAgIHRoaXMucG9ydGFsID0gdW5kZWZpbmVkO1xuICAgIHRoaXMuY29uZmlnID0gdW5kZWZpbmVkO1xuICAgIHRoaXMuZmxvd05vZGUgPSB1bmRlZmluZWQ7XG4gICAgdGhpcy5zdHJpbmdzID0gdW5kZWZpbmVkO1xuICAgIHRoaXMuY3VycmVudExhbmd1YWdlID0gdW5kZWZpbmVkO1xuICAgIHRoaXMuaGlkZUxheWVyVGl0bGUgPSBmYWxzZTtcbiAgICB0aGlzLnN5bWJvbFNlbGVjdGVkID0gZmFsc2U7XG4gIH1cbiAgLy8gY2xvbmUgZmVhdHVyZVJlZHVjdGlvbiB0byB1cGRhdGUgbWFwXG4gIGludGVybmFsQ2hhbmdlSGFuZGxlcigpIHtcbiAgICBjb25zdCB7IGxheWVyIH0gPSB0aGlzO1xuICAgIGNvbnN0IGZlYXR1cmVSZWR1Y3Rpb24gPSBsYXllci5mZWF0dXJlUmVkdWN0aW9uO1xuICAgIGxheWVyLmZlYXR1cmVSZWR1Y3Rpb24gPSBmZWF0dXJlUmVkdWN0aW9uLmNsb25lKCk7XG4gICAgdGhpcy5hcmNnaXNBZ2dyZWdhdGlvbkNsdXN0ZXJpbmdDaGFuZ2UuZW1pdCgpO1xuICB9XG4gIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgLy9cbiAgLy8gIHB1YmxpYyBjYWxsc1xuICAvL1xuICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIC8vIFB1YmxpYyBNZXRob2RzXG4gIGFzeW5jIGRvbmUoKSB7XG4gICAgdGhpcy5jbG9zZVBvcG92ZXJzKCk7XG4gIH1cbiAgYXN5bmMgc2V0Rm9jdXMoKSB7XG4gICAgdGhpcy5mbG93SXRlbU5vZGUuc2V0Rm9jdXMoKTtcbiAgfVxuICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIC8vXG4gIC8vICBMaWZlY3ljbGVcbiAgLy9cbiAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICBhc3luYyBjb21wb25lbnRXaWxsTG9hZCgpIHtcbiAgICAvLyBvbmx5IHZhbGlkIGZvciBwb2ludFxuICAgIHRoaXMubGF5ZXJHZW9tZXRyeVR5cGUgPSBhd2FpdCBnZXRMYXllckdlb21ldHJ5VHlwZSh0aGlzLmxheWVyKTtcbiAgICBjb25zdCBbcG9wdXBVdGlscywgc3ltYm9sVXRpbHMsIGNpbVN5bWJvbFV0aWxzLCBDb2xvciwgU2ltcGxlTWFya2VyU3ltYm9sLCBTaW1wbGVMaW5lU3ltYm9sXSA9IGF3YWl0IGxvYWRNb2R1bGVzKFtcbiAgICAgIFwiZXNyaS9zbWFydE1hcHBpbmcvcG9wdXAvc3VwcG9ydC91dGlsc1wiLFxuICAgICAgXCJlc3JpL3N5bWJvbHMvc3VwcG9ydC9zeW1ib2xVdGlsc1wiLFxuICAgICAgXCJlc3JpL3N5bWJvbHMvc3VwcG9ydC9jaW1TeW1ib2xVdGlsc1wiLFxuICAgICAgXCJlc3JpL0NvbG9yXCIsXG4gICAgICBcImVzcmkvc3ltYm9scy9TaW1wbGVNYXJrZXJTeW1ib2xcIixcbiAgICAgIFwiZXNyaS9zeW1ib2xzL1NpbXBsZUxpbmVTeW1ib2xcIlxuICAgIF0pO1xuICAgIHRoaXMubW9kdWxlcyA9IHtcbiAgICAgIHN5bWJvbFV0aWxzLFxuICAgICAgY2ltU3ltYm9sVXRpbHMsXG4gICAgICBDb2xvcixcbiAgICAgIFNpbXBsZU1hcmtlclN5bWJvbCxcbiAgICAgIFNpbXBsZUxpbmVTeW1ib2xcbiAgICB9O1xuICAgIC8vIGRpc2FibGUgc2l6ZSByYW5nZSBzbGlkZXIgZm9yIFwic2l6ZVwiIHJlbmRlcmVyLiB1bmRvY3VtZW50ZWQgZnVuY3Rpb24uXG4gICAgY29uc3QgdmlzdWFsVmFyaWFibGVzID0gcG9wdXBVdGlscy5nZXRQcmltYXJ5VmlzdWFsVmFyaWFibGVzKHRoaXMubGF5ZXIucmVuZGVyZXIpO1xuICAgIHRoaXMuZGlzYWJsZVNpemVTbGlkZXIgPSB2aXN1YWxWYXJpYWJsZXMuc29tZSgodmFyaWFibGUpID0+IHtcbiAgICAgIHJldHVybiAodmFyaWFibGUgPT09IG51bGwgfHwgdmFyaWFibGUgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHZhcmlhYmxlLnR5cGUpID09PSBcInNpemVcIjtcbiAgICB9KTtcbiAgfVxuICBjb21wb25lbnREaWRMb2FkKCkge1xuICAgIHNldFRpbWVvdXQoKCkgPT4gcmVxdWVzdEFuaW1hdGlvbkZyYW1lKCgpID0+IHRoaXMuZmxvd0l0ZW1Ob2RlLnNldEZvY3VzKCkpLCAyMDApO1xuICB9XG4gIGNvbXBvbmVudERpZFVwZGF0ZSgpIHtcbiAgICAvL3RoaXMuaW50ZXJuYWxDaGFuZ2UuZW1pdCgpO1xuICB9XG4gIGRpc2Nvbm5lY3RlZENhbGxiYWNrKCkge1xuICAgIHRoaXMuY2xvc2VQb3BvdmVycygpO1xuICB9XG4gIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIC8vXG4gIC8vICBSZW5kZXIgTWV0aG9kc1xuICAvL1xuICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIHJlbmRlcigpIHtcbiAgICBjb25zdCB7IGxheWVyLCBzdHJpbmdzLCBoaWRlTGF5ZXJUaXRsZSB9ID0gdGhpcztcbiAgICAvL2NvbnN0IGZlYXR1cmVSZWR1Y3Rpb24gPSBsYXllci5mZWF0dXJlUmVkdWN0aW9uIGFzIGFueTsgLy9fX2VzcmkuRmVhdHVyZVJlZHVjdGlvbkNsdXN0ZXI7XG4gICAgY29uc3Qgc2hvd1N5bWJvbCA9IGlzUmVuZGVyZXJBdXRvR2VuZXJhdGVkKGxheWVyKTtcbiAgICBjb25zdCBhZ2dyZWdhdGlvblR5cGUgPSBnZXRBZ2dyZWdhdGlvblR5cGUobGF5ZXIpO1xuICAgIHJldHVybiAoaChIb3N0LCB7IGNsYXNzOiBcImNhbGNpdGUtbWF0Y2gtaGVpZ2h0XCIgfSwgaChcImNhbGNpdGUtZmxvdy1pdGVtXCIsIHsgaGVhZGluZzogc3RyaW5ncy5jbHVzdGVyaW5nLCBkZXNjcmlwdGlvbjogIWhpZGVMYXllclRpdGxlID8gbGF5ZXIudGl0bGUgOiB1bmRlZmluZWQsIG9uQ2FsY2l0ZUZsb3dJdGVtQmFjazogKCkgPT4ge1xuICAgICAgICB0aGlzLmNhbGNpdGVQYW5lbEJhY2tDbGljay5lbWl0KCk7XG4gICAgICAgIC8vdGhpcy5jbG9zZVBvcG92ZXJzKCk7XG4gICAgICB9LCByZWY6IChub2RlKSA9PiAodGhpcy5mbG93SXRlbU5vZGUgPSBub2RlKSB9LCBzaG93U3ltYm9sICYmIHRoaXMucmVuZGVyU3ltYm9sKCksIGFnZ3JlZ2F0aW9uVHlwZSA9PT0gXCJwaWUtY2hhcnRcIiAmJiB0aGlzLnJlbmRlclNoYXBlKCksIHRoaXMucmVuZGVyQ2x1c3RlclJhZGl1cygpLCB0aGlzLnJlbmRlckNsdXN0ZXJTaXplKCksIHRoaXMucmVuZGVyRmllbGRzQnRuKCksIHRoaXMucmVuZGVyTGFiZWxCdG4oKSwgdGhpcy5yZW5kZXJQb3B1cEJ0bigpKSkpO1xuICB9XG4gIHJlbmRlclN5bWJvbCgpIHtcbiAgICBjb25zdCB7IGxheWVyLCBzdHJpbmdzIH0gPSB0aGlzO1xuICAgIGNvbnN0IGZlYXR1cmVSZWR1Y3Rpb24gPSBsYXllci5mZWF0dXJlUmVkdWN0aW9uOyAvL19fZXNyaS5GZWF0dXJlUmVkdWN0aW9uQ2x1c3RlcjtcbiAgICBjb25zdCBoYXNTeW1ib2wgPSAhIWZlYXR1cmVSZWR1Y3Rpb24uc3ltYm9sO1xuICAgIHJldHVybiAoaChcImNhbGNpdGUtYmxvY2stc2VjdGlvblwiLCB7IHRleHQ6IHN0cmluZ3MuY2x1c3Rlci5vdmVycmlkZVN5bWJvbCwgb3BlbjogaGFzU3ltYm9sLCBcInRvZ2dsZS1kaXNwbGF5XCI6IFwic3dpdGNoXCIsIGNsYXNzOiBcImJsb2NrLXNlY3Rpb25cIiwgb25DYWxjaXRlQmxvY2tTZWN0aW9uVG9nZ2xlOiAoZXZlbnQpID0+IHtcbiAgICAgICAgdGhpcy5oYW5kbGVUb2dnbGVTeW1ib2woZXZlbnQpO1xuICAgICAgfSB9LCB0aGlzLnJlbmRlclN5bWJvbENvbnRlbnQoKSkpO1xuICB9XG4gIHJlbmRlclN5bWJvbENvbnRlbnQoKSB7XG4gICAgY29uc3QgeyBsYXllciwgc3ltYm9sU2VsZWN0ZWQsIHN0cmluZ3MgfSA9IHRoaXM7XG4gICAgY29uc3QgZmVhdHVyZVJlZHVjdGlvbiA9IGxheWVyLmZlYXR1cmVSZWR1Y3Rpb247IC8vX19lc3JpLkZlYXR1cmVSZWR1Y3Rpb25DbHVzdGVyO1xuICAgIGlmICghZmVhdHVyZVJlZHVjdGlvbi5zeW1ib2wpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgcmV0dXJuIChoKFwiZGl2XCIsIHsgY2xhc3M6IFwiYmxvY2stY29udGVudFwiIH0sIGgoXCJjYWxjaXRlLWxhYmVsXCIsIG51bGwsIHN0cmluZ3Muc3ltYm9sU3R5bGUsIGgoXCJkaXZcIiwgeyBjbGFzczogYHN5bWJvbC1idXR0b24gJHtzeW1ib2xTZWxlY3RlZCA/IGBzZWxlY3RlZGAgOiBgYH1gLCB0YWJpbmRleDogXCIwXCIsIHJvbGU6IFwiYnV0dG9uXCIsIFwiYXJpYS1sYWJlbFwiOiBzdHJpbmdzLnN5bWJvbFN0eWxlLCBvbkNsaWNrOiAoZXZlbnQpID0+IHRoaXMub3BlblN5bWJvbFN0eWxlclBvcG92ZXIoZXZlbnQpIH0sIGgoXCJkaXZcIiwgeyBjbGFzczogXCJzeW1ib2xcIiwgcmVmOiAobm9kZSkgPT4gdGhpcy5jcmVhdGVTeW1ib2xQcmV2aWV3KG5vZGUpIH0pLCBoKFwiY2FsY2l0ZS1pY29uXCIsIHsgc2NhbGU6IFwic1wiLCBpY29uOiBcInBlbmNpbFwiLCBjbGFzczogXCJzeW1ib2wtaWNvblwiIH0pKSkpKTtcbiAgfVxuICByZW5kZXJTaGFwZSgpIHtcbiAgICB2YXIgX2E7XG4gICAgY29uc3QgeyBsYXllciwgc3RyaW5ncyB9ID0gdGhpcztcbiAgICAvLyBuZWVkIHRvIHN3aXRjaCBsYWJlbHMgYmFjayBpbiBydGxcbiAgICBjb25zdCBydGwgPSBnZXRFbGVtZW50RGlyKHRoaXMuaG9zdEVsZW1lbnQpID09PSBcInJ0bFwiO1xuICAgIGNvbnN0IGZlYXR1cmVSZWR1Y3Rpb24gPSBsYXllci5mZWF0dXJlUmVkdWN0aW9uOyAvL19fZXNyaS5GZWF0dXJlUmVkdWN0aW9uQ2x1c3RlcjtcbiAgICByZXR1cm4gKGgoXCJkaXZcIiwgeyBjbGFzczogXCJzbGlkZXItdGl0bGUtd3JhcHBlclwiIH0sIFwiIFwiLCBoKFwiY2FsY2l0ZS1sYWJlbFwiLCBudWxsLCBzdHJpbmdzLmNsdXN0ZXIuc2hhcGUsIGgoXCJkaXZcIiwgeyBjbGFzczogXCJzbGlkZXItZGl2XCIgfSwgaChcImxhYmVsXCIsIHsgY2xhc3M6IFwic2xpZGVyLWxhYmVsXCIgfSwgcnRsID8gc3RyaW5ncy5jbHVzdGVyLmRvbnV0IDogc3RyaW5ncy5jbHVzdGVyLnBpZSksIGgoXCJjYWxjaXRlLXNsaWRlclwiLCB7IGNsYXNzOiBcInNsaWRlci1zbGlkZXJcIiwgbWluOiAwLCBtYXg6IE1hdGgubWF4KDAuOSwgZmVhdHVyZVJlZHVjdGlvbi5yZW5kZXJlci5ob2xlUGVyY2VudGFnZSksIHZhbHVlOiAoX2EgPSBmZWF0dXJlUmVkdWN0aW9uLnJlbmRlcmVyLmhvbGVQZXJjZW50YWdlKSAhPT0gbnVsbCAmJiBfYSAhPT0gdm9pZCAwID8gX2EgOiAwLCBzdGVwOiAwLjEsIG1pbkxhYmVsOiBzdHJpbmdzLmNsdXN0ZXIuc2hhcGUsIG9uQ2FsY2l0ZVNsaWRlcklucHV0OiAoZXZlbnQpID0+IHtcbiAgICAgICAgY29uc3QgZmVhdHVyZVJlZHVjdGlvbiA9IGxheWVyLmZlYXR1cmVSZWR1Y3Rpb247IC8vX19lc3JpLkZlYXR1cmVSZWR1Y3Rpb25DbHVzdGVyO1xuICAgICAgICBjb25zdCBzbGlkZXIgPSBldmVudC50YXJnZXQ7XG4gICAgICAgIGZlYXR1cmVSZWR1Y3Rpb24ucmVuZGVyZXIuaG9sZVBlcmNlbnRhZ2UgPSBzbGlkZXIudmFsdWU7XG4gICAgICAgIHRoaXMuaW50ZXJuYWxDaGFuZ2UuZW1pdCgpO1xuICAgICAgfSB9KSwgaChcImxhYmVsXCIsIHsgY2xhc3M6IFwic2xpZGVyLWxhYmVsXCIgfSwgcnRsID8gc3RyaW5ncy5jbHVzdGVyLnBpZSA6IHN0cmluZ3MuY2x1c3Rlci5kb251dCkpKSkpO1xuICB9XG4gIHJlbmRlckNsdXN0ZXJSYWRpdXMoKSB7XG4gICAgdmFyIF9hO1xuICAgIGNvbnN0IHsgbGF5ZXIsIHN0cmluZ3MgfSA9IHRoaXM7XG4gICAgLy8gbmVlZCB0byBzd2l0Y2ggbGFiZWxzIGJhY2sgaW4gcnRsXG4gICAgY29uc3QgcnRsID0gZ2V0RWxlbWVudERpcih0aGlzLmhvc3RFbGVtZW50KSA9PT0gXCJydGxcIjtcbiAgICBjb25zdCBmZWF0dXJlUmVkdWN0aW9uID0gbGF5ZXIuZmVhdHVyZVJlZHVjdGlvbjtcbiAgICByZXR1cm4gKGgoXCJkaXZcIiwgeyBjbGFzczogXCJzbGlkZXItdGl0bGUtd3JhcHBlclwiIH0sIGgoXCJsYWJlbFwiLCB7IGNsYXNzOiBcInNsaWRlci1oZWFkaW5nXCIgfSwgc3RyaW5ncy5jbHVzdGVyLnJhZGl1c1RpdGxlKSwgaChcImRpdlwiLCB7IGNsYXNzOiBcInNsaWRlci1kaXZcIiB9LCBoKFwibGFiZWxcIiwgeyBjbGFzczogXCJzbGlkZXItbGFiZWxcIiB9LCBydGwgPyBzdHJpbmdzLmNsdXN0ZXIuaGlnaCA6IHN0cmluZ3MuY2x1c3Rlci5sb3cpLCBoKFwiY2FsY2l0ZS1zbGlkZXJcIiwgeyBjbGFzczogXCJzbGlkZXItc2xpZGVyXCIsIG1pbjogY2x1c3RlcmluZ1JhZGl1c01pblZhbCwgbWF4OiBjbHVzdGVyaW5nUmFkaXVzTWF4VmFsLCB2YWx1ZTogKF9hID0gZmVhdHVyZVJlZHVjdGlvbi5jbHVzdGVyUmFkaXVzKSAhPT0gbnVsbCAmJiBfYSAhPT0gdm9pZCAwID8gX2EgOiBjbHVzdGVyaW5nUmFkaXVzSW5pdGlhbFZhbCwgc3RlcDogMSwgbWluTGFiZWw6IHN0cmluZ3MuY2x1c3Rlci5yYWRpdXNUaXRsZSwgb25DYWxjaXRlU2xpZGVySW5wdXQ6IChldmVudCkgPT4ge1xuICAgICAgICBjb25zdCBmZWF0dXJlUmVkdWN0aW9uID0gbGF5ZXIuZmVhdHVyZVJlZHVjdGlvbjtcbiAgICAgICAgY29uc3Qgc2xpZGVyID0gZXZlbnQudGFyZ2V0O1xuICAgICAgICBmZWF0dXJlUmVkdWN0aW9uLmNsdXN0ZXJSYWRpdXMgPSBzbGlkZXIudmFsdWU7XG4gICAgICAgIHRoaXMuaW50ZXJuYWxDaGFuZ2UuZW1pdCgpO1xuICAgICAgfSB9KSwgaChcImxhYmVsXCIsIHsgY2xhc3M6IFwic2xpZGVyLWxhYmVsXCIgfSwgcnRsID8gc3RyaW5ncy5jbHVzdGVyLmxvdyA6IHN0cmluZ3MuY2x1c3Rlci5oaWdoKSkpKTtcbiAgfVxuICByZW5kZXJDbHVzdGVyU2l6ZSgpIHtcbiAgICB2YXIgX2EsIF9iO1xuICAgIGNvbnN0IHsgbGF5ZXIsIHN0cmluZ3MsIGRpc2FibGVTaXplU2xpZGVyIH0gPSB0aGlzO1xuICAgIC8vIG5lZWQgdG8gc3dpdGNoIGxhYmVscyBiYWNrIGluIHJ0bFxuICAgIGNvbnN0IHJ0bCA9IGdldEVsZW1lbnREaXIodGhpcy5ob3N0RWxlbWVudCkgPT09IFwicnRsXCI7XG4gICAgY29uc3QgZmVhdHVyZVJlZHVjdGlvbiA9IGxheWVyLmZlYXR1cmVSZWR1Y3Rpb247XG4gICAgcmV0dXJuIChoKFwiZGl2XCIsIHsgY2xhc3M6IFwic2xpZGVyLXRpdGxlLXdyYXBwZXJcIiB9LCBoKFwibGFiZWxcIiwgeyBjbGFzczogXCJzbGlkZXItaGVhZGluZ1wiIH0sIHN0cmluZ3MuY2x1c3Rlci5zaXplVGl0bGUpLCBoKFwiZGl2XCIsIHsgY2xhc3M6IFwic2xpZGVyLWRpdlwiIH0sIGgoXCJsYWJlbFwiLCB7IGNsYXNzOiBcInNsaWRlci1sYWJlbFwiIH0sIHJ0bCA/IHN0cmluZ3MuY2x1c3Rlci5tYXggOiBzdHJpbmdzLmNsdXN0ZXIubWluKSwgaChcImNhbGNpdGUtc2xpZGVyXCIsIHsgY2xhc3M6IFwic2xpZGVyLXNsaWRlclwiLCBtaW46IGNsdXN0ZXJpbmdTaXplTWluVmFsLCBtYXg6IGNsdXN0ZXJpbmdTaXplTWF4VmFsLCBtaW5WYWx1ZTogKF9hID0gZmVhdHVyZVJlZHVjdGlvbi5jbHVzdGVyTWluU2l6ZSkgIT09IG51bGwgJiYgX2EgIT09IHZvaWQgMCA/IF9hIDogY2x1c3RlcmluZ1NpemVNaW5WYWwsIG1heFZhbHVlOiAoX2IgPSBmZWF0dXJlUmVkdWN0aW9uLmNsdXN0ZXJNYXhTaXplKSAhPT0gbnVsbCAmJiBfYiAhPT0gdm9pZCAwID8gX2IgOiBjbHVzdGVyaW5nU2l6ZU1heFZhbCwgc3RlcDogMSwgZGlzYWJsZWQ6IGRpc2FibGVTaXplU2xpZGVyLCBtaW5MYWJlbDogYCR7c3RyaW5ncy5jbHVzdGVyLm1pbn0gJHtzdHJpbmdzLmNsdXN0ZXIuc2l6ZVRpdGxlfWAsIG1heExhYmVsOiBgJHtzdHJpbmdzLmNsdXN0ZXIubWF4fSAke3N0cmluZ3MuY2x1c3Rlci5zaXplVGl0bGV9YCwgb25DYWxjaXRlU2xpZGVySW5wdXQ6IChldmVudCkgPT4ge1xuICAgICAgICBjb25zdCBmZWF0dXJlUmVkdWN0aW9uID0gbGF5ZXIuZmVhdHVyZVJlZHVjdGlvbjtcbiAgICAgICAgY29uc3Qgc2xpZGVyID0gZXZlbnQudGFyZ2V0O1xuICAgICAgICBmZWF0dXJlUmVkdWN0aW9uLmNsdXN0ZXJNaW5TaXplID0gc2xpZGVyLm1pblZhbHVlO1xuICAgICAgICBmZWF0dXJlUmVkdWN0aW9uLmNsdXN0ZXJNYXhTaXplID0gc2xpZGVyLm1heFZhbHVlO1xuICAgICAgICB0aGlzLmludGVybmFsQ2hhbmdlLmVtaXQoKTtcbiAgICAgIH0gfSksIGgoXCJsYWJlbFwiLCB7IGNsYXNzOiBcInNsaWRlci1sYWJlbFwiIH0sIHJ0bCA/IHN0cmluZ3MuY2x1c3Rlci5taW4gOiBzdHJpbmdzLmNsdXN0ZXIubWF4KSkpKTtcbiAgfVxuICAvKiByZW5kZXJTY2FsZVRocmVzaG9sZCgpOiBWTm9kZSB7XG4gICAgL1xuICAgIFdvcmxkXG4gICAgQ29udGluZW50ICAgIDE6NTAsMDAwLDAwMFxuICAgIENvdW50cmllcyAtIGJpZyAgICAxOjI1LDAwMCwwMDBcbiAgICBDb3VudHJpZXMgLSBzbWFsbCAgICAxOjEyLDAwMCwwMDBcbiAgICBTdGF0ZXMvUHJvdmluY2VzICAgIDE6NiwwMDAsMDAwXG4gICAgU3RhdGUvUHJvdmluY2UgICAgMTozLDAwMCwwMDBcbiAgICBDb3VudGllcyAgICAxOjEsNTAwLDAwMFxuICAgIENvdW50eSAgICAxOjc1MCwwMDBcbiAgICBNZXRyb3BvbGl0YW4gYXJlYSAgICAxOjMyMCwwMDBcbiAgICBDaXRpZXMgICAgMToxNjAsMDAwXG4gICAgQ2l0eSAgICAxOjgwLDAwMFxuICAgIFRvd24gICAgMTo0MCwwMDBcbiAgICBOZWlnaGJvcmhvb2QgICAgMToyMCwwMDBcbiAgICBTdHJlZXRzICAgIDE6MTAsMDAwXG4gICAgU3RyZWV0ICAgIDE6NSwwMDBcbiAgICAvXG4gICAgY29uc3QgeyBsYXllciwgc3RyaW5ncyB9ID0gdGhpcztcbiAgICAvLyBuZWVkIHRvIHN3aXRjaCBsYWJlbHMgYmFjayBpbiBydGxcbiAgICBjb25zdCBydGwgPSBnZXRFbGVtZW50RGlyKHRoaXMuaG9zdEVsZW1lbnQpID09PSBcInJ0bFwiO1xuICAgIGNvbnN0IGZlYXR1cmVSZWR1Y3Rpb24gPSBsYXllci5mZWF0dXJlUmVkdWN0aW9uIGFzIGFueTsgLy9fX2VzcmkuRmVhdHVyZVJlZHVjdGlvbkNsdXN0ZXI7XG4gICAgaWYgKFxuICAgICAgZmVhdHVyZVJlZHVjdGlvbi52aXNpYmlsaXR5SW5mbyAmJlxuICAgICAgZmVhdHVyZVJlZHVjdGlvbi52aXNpYmlsaXR5SW5mby50aHJlc2hvbGRUeXBlICE9PSBcInNjYWxlXCJcbiAgICApIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgY29uc3Qgd29ybGRTY2FsZSA9IDI5NTgyODc2NDtcbiAgICBjb25zdCB0aHJlc2hvbGQgPSBmZWF0dXJlUmVkdWN0aW9uLnZpc2liaWxpdHlJbmZvPy5tYXhTY2FsZSB8fCB3b3JsZFNjYWxlO1xuICAgIGNvbnN0IHNjYWxlU3RvcHMgPSBbXG4gICAgICB3b3JsZFNjYWxlLFxuICAgICAgNTAwMDAwMDAsXG4gICAgICAyNTAwMDAwMCxcbiAgICAgIDEyMDAwMDAwLFxuICAgICAgNjAwMDAwMCxcbiAgICAgIDMwMDAwMDAsXG4gICAgICAxNTAwMDAwLFxuICAgICAgNzUwMDAwLFxuICAgICAgMzIwMDAwLFxuICAgICAgMTYwMDAwLFxuICAgICAgODAwMDAsXG4gICAgICA0MDAwMCxcbiAgICAgIDIwMDAwLFxuICAgICAgMTAwMDAsXG4gICAgICA1MDAwXG4gICAgXTtcbiAgICBjb25zdCBmaW5kU3RvcCA9ICh2YWx1ZTogbnVtYmVyKTogbnVtYmVyID0+IHtcbiAgICAgIGxldCBpbmRleCA9IDA7XG4gICAgICBzY2FsZVN0b3BzLmZvckVhY2goKHN0b3A6IG51bWJlciwgaWR4OiBudW1iZXIpID0+IHtcbiAgICAgICAgaWYgKGlkeCA9PT0gMCkge1xuICAgICAgICAgIGlmIChzdG9wIDwgdmFsdWUpIHtcbiAgICAgICAgICAgIGluZGV4ID0gMDtcbiAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSBpZiAoaWR4ID09PSBzY2FsZVN0b3BzLmxlbmd0aCAtIDEpIHtcbiAgICAgICAgICBpZiAoc3RvcCA+PSB2YWx1ZSkge1xuICAgICAgICAgICAgaW5kZXggPSBzY2FsZVN0b3BzLmxlbmd0aCAtIDE7XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGlmIChzdG9wIDw9IHZhbHVlICYmIHNjYWxlU3RvcHNbaWR4IC0gMV0gPiB2YWx1ZSkge1xuICAgICAgICAgICAgaW5kZXggPSBpZHggLSAxICsgKHNjYWxlU3RvcHNbaWR4IC0gMV0gLSB2YWx1ZSkgLyAoc2NhbGVTdG9wc1tpZHggLSAxXSAtIHN0b3ApO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgICByZXR1cm4gaW5kZXg7XG4gICAgfTtcbiAgICByZXR1cm4gKFxuICAgICAgPGRpdiBjbGFzcz1cInNsaWRlci10aXRsZS13cmFwcGVyXCI+XG4gICAgICAgIDxsYWJlbCBjbGFzcz1cInNsaWRlci1oZWFkaW5nXCI+e3N0cmluZ3MuY2x1c3Rlci5zY2FsZVRocmVzaG9sZH08L2xhYmVsPlxuICAgICAgICA8ZGl2IGNsYXNzPVwic2xpZGVyLWRpdlwiPlxuICAgICAgICAgIDxsYWJlbCBjbGFzcz1cInNsaWRlci1sYWJlbFwiPlxuICAgICAgICAgICAge3J0bCA/IHN0cmluZ3MuY2x1c3Rlci5zdHJlZXRTY2FsZUxhYmVsIDogPHNwYW4+Jm5ic3A7PC9zcGFuPn1cbiAgICAgICAgICA8L2xhYmVsPlxuICAgICAgICAgIDxjYWxjaXRlLXNsaWRlclxuICAgICAgICAgICAgY2xhc3M9XCJzbGlkZXItc2xpZGVyXCJcbiAgICAgICAgICAgIG1pbj17MH1cbiAgICAgICAgICAgIG1heD17MTR9XG4gICAgICAgICAgICB2YWx1ZT17ZmluZFN0b3AodGhyZXNob2xkKX1cbiAgICAgICAgICAgIHN0ZXA9ezAuMX1cbiAgICAgICAgICAgIG1pbkxhYmVsPXtzdHJpbmdzLmNsdXN0ZXIuc2NhbGVUaHJlc2hvbGR9XG4gICAgICAgICAgICBvbkNhbGNpdGVTbGlkZXJJbnB1dD17KGV2ZW50OiBDdXN0b21FdmVudCkgPT4ge1xuICAgICAgICAgICAgICBjb25zdCBzbGlkZXIgPSBldmVudC50YXJnZXQgYXMgSFRNTENhbGNpdGVTbGlkZXJFbGVtZW50O1xuICAgICAgICAgICAgICBjb25zdCB2YWx1ZSA9IHNsaWRlci52YWx1ZSBhcyBudW1iZXI7XG4gICAgICAgICAgICAgIGNvbnN0IHN0b3BNaW4gPSBzY2FsZVN0b3BzW01hdGguY2VpbCh2YWx1ZSldO1xuICAgICAgICAgICAgICBjb25zdCBzdG9wTWF4ID0gc2NhbGVTdG9wc1tNYXRoLmZsb29yKHZhbHVlKV07XG4gICAgICAgICAgICAgIGxldCB0aHJlc2hvbGQgPSBNYXRoLnJvdW5kKFxuICAgICAgICAgICAgICAgIHN0b3BNaW4gKyAodmFsdWUgLSBNYXRoLmZsb29yKHZhbHVlKSkgKiAoc3RvcE1heCAtIHN0b3BNaW4pXG4gICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiVE9ETzogc2V0IHNjYWxlIHRocmVzaG9sZCB0b1wiLCB0aHJlc2hvbGQpO1xuICAgICAgICAgICAgICBjb25zdCBmZWF0dXJlUmVkdWN0aW9uID0gbGF5ZXIuZmVhdHVyZVJlZHVjdGlvbiBhcyBhbnk7IC8vX19lc3JpLkZlYXR1cmVSZWR1Y3Rpb25DbHVzdGVyO1xuICAgICAgICAgICAgICBmZWF0dXJlUmVkdWN0aW9uLnZpc2liaWxpdHlJbmZvID0geyBtYXhTY2FsZTogdGhyZXNob2xkLCB0aHJlc2hvbGRUeXBlOiBcInNjYWxlXCIgfTtcbiAgICAgICAgICAgICAgdGhpcy5pbnRlcm5hbENoYW5nZS5lbWl0KCk7XG4gICAgICAgICAgICB9fVxuICAgICAgICAgID48L2NhbGNpdGUtc2xpZGVyPlxuICAgICAgICAgIDxsYWJlbCBjbGFzcz1cInNsaWRlci1sYWJlbFwiPlxuICAgICAgICAgICAge3J0bCA/IDxzcGFuPiZuYnNwOzwvc3Bhbj4gOiBzdHJpbmdzLmNsdXN0ZXIuc3RyZWV0U2NhbGVMYWJlbH1cbiAgICAgICAgICA8L2xhYmVsPlxuICAgICAgICA8L2Rpdj5cbiAgICAgIDwvZGl2PlxuICAgICk7XG4gIH0gKi9cbiAgcmVuZGVyRmllbGRzQnRuKCkge1xuICAgIGNvbnN0IHsgc3RyaW5ncyB9ID0gdGhpcztcbiAgICBjb25zdCBydGwgPSBnZXRFbGVtZW50RGlyKHRoaXMuaG9zdEVsZW1lbnQpID09PSBcInJ0bFwiO1xuICAgIHJldHVybiAoaChcImRpdlwiLCB7IGNsYXNzOiBcImNsdXN0ZXItYnRuLXNlY3Rpb25cIiB9LCBoKFwiYnV0dG9uXCIsIHsgY2xhc3M6IFwiY2x1c3Rlci1idG5cIiwgb25DbGljazogKGV2ZW50KSA9PiB0aGlzLmFkZEZpZWxkc1BhbmVsKGV2ZW50KSwgcmVmOiAobm9kZSkgPT4gKHRoaXMuZmllbGRzQnV0dG9uTm9kZSA9IG5vZGUpIH0sIGgoXCJzcGFuXCIsIHsgY2xhc3M6IFwiY2x1c3Rlci1idG4tdGV4dFwiIH0sIHN0cmluZ3MuY2x1c3Rlci5lZGl0Q2x1c3RlckF0dHJpYnV0ZXMpLCBoKFwic3BhblwiLCB7IGNsYXNzOiBcImNsdXN0ZXItYnRuLWljb25cIiB9LCBoKFwiY2FsY2l0ZS1pY29uXCIsIHsgc2NhbGU6IFwic1wiLCBpY29uOiBydGwgPyBcImNoZXZyb24tbGVmdFwiIDogXCJjaGV2cm9uLXJpZ2h0XCIgfSkpKSkpO1xuICB9XG4gIHJlbmRlckxhYmVsQnRuKCkge1xuICAgIGNvbnN0IHsgc3RyaW5ncyB9ID0gdGhpcztcbiAgICBjb25zdCBydGwgPSBnZXRFbGVtZW50RGlyKHRoaXMuaG9zdEVsZW1lbnQpID09PSBcInJ0bFwiO1xuICAgIHJldHVybiAoaChcImRpdlwiLCB7IGNsYXNzOiBcImNsdXN0ZXItYnRuLXNlY3Rpb25cIiB9LCBoKFwiYnV0dG9uXCIsIHsgY2xhc3M6IFwiY2x1c3Rlci1idG5cIiwgb25DbGljazogKGV2ZW50KSA9PiB0aGlzLmFkZExhYmVsUGFuZWwoZXZlbnQpLCByZWY6IChub2RlKSA9PiAodGhpcy5sYWJlbHNCdXR0b25Ob2RlID0gbm9kZSkgfSwgaChcInNwYW5cIiwgeyBjbGFzczogXCJjbHVzdGVyLWJ0bi10ZXh0XCIgfSwgc3RyaW5ncy5jbHVzdGVyLmVkaXRDbHVzdGVyTGFiZWwpLCBoKFwic3BhblwiLCB7IGNsYXNzOiBcImNsdXN0ZXItYnRuLWljb25cIiB9LCBoKFwiY2FsY2l0ZS1pY29uXCIsIHsgc2NhbGU6IFwic1wiLCBpY29uOiBydGwgPyBcImNoZXZyb24tbGVmdFwiIDogXCJjaGV2cm9uLXJpZ2h0XCIgfSkpKSkpO1xuICB9XG4gIHJlbmRlclBvcHVwQnRuKCkge1xuICAgIGNvbnN0IHsgc3RyaW5ncyB9ID0gdGhpcztcbiAgICBjb25zdCBydGwgPSBnZXRFbGVtZW50RGlyKHRoaXMuaG9zdEVsZW1lbnQpID09PSBcInJ0bFwiO1xuICAgIHJldHVybiAoaChcImRpdlwiLCB7IGNsYXNzOiBcImNsdXN0ZXItYnRuLXNlY3Rpb25cIiB9LCBoKFwiYnV0dG9uXCIsIHsgY2xhc3M6IFwiY2x1c3Rlci1idG5cIiwgb25DbGljazogKGV2ZW50KSA9PiB0aGlzLmFkZFBvcHVwUGFuZWwoZXZlbnQpLCByZWY6IChub2RlKSA9PiAodGhpcy5wb3B1cEJ1dHRvbk5vZGUgPSBub2RlKSB9LCBoKFwic3BhblwiLCB7IGNsYXNzOiBcImNsdXN0ZXItYnRuLXRleHRcIiB9LCBzdHJpbmdzLmNsdXN0ZXIuZWRpdENsdXN0ZXJQb3B1cHMpLCBoKFwic3BhblwiLCB7IGNsYXNzOiBcImNsdXN0ZXItYnRuLWljb25cIiB9LCBoKFwiY2FsY2l0ZS1pY29uXCIsIHsgc2NhbGU6IFwic1wiLCBpY29uOiBydGwgPyBcImNoZXZyb24tbGVmdFwiIDogXCJjaGV2cm9uLXJpZ2h0XCIgfSkpKSkpO1xuICB9XG4gIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIC8vXG4gIC8vICBQcml2YXRlIG1ldGhvZHNcbiAgLy9cbiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgY2xvc2VQb3BvdmVycygpIHtcbiAgICB2YXIgX2EsIF9iO1xuICAgIHRoaXMuY2xvc2VBdHRyaWJ1dGVQb3BvdmVycy5lbWl0KCk7XG4gICAgdGhpcy5jbG9zZUxhYmVsUG9wb3ZlcnMuZW1pdCgpO1xuICAgIHRoaXMuY2xvc2VQb3B1cFBvcG92ZXJzLmVtaXQoKTtcbiAgICAoX2IgPSAoX2EgPSB0aGlzLnN0eWxlclBvcG92ZXJOb2RlKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EucGFyZW50RWxlbWVudCkgPT09IG51bGwgfHwgX2IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9iLnJlbW92ZUNoaWxkKHRoaXMuc3R5bGVyUG9wb3Zlck5vZGUpO1xuICAgIHRoaXMuc3R5bGVyUG9wb3Zlck5vZGUgPSBudWxsO1xuICB9XG4gIGhhbmRsZVRvZ2dsZVN5bWJvbChldmVudCkge1xuICAgIGNvbnN0IHsgbGF5ZXIsIG1vZHVsZXMgfSA9IHRoaXM7XG4gICAgY29uc3QgZmVhdHVyZVJlZHVjdGlvbiA9IGxheWVyLmZlYXR1cmVSZWR1Y3Rpb247IC8vX19lc3JpLkZlYXR1cmVSZWR1Y3Rpb25DbHVzdGVyO1xuICAgIGNvbnN0IHNlY3Rpb24gPSBldmVudC5jdXJyZW50VGFyZ2V0O1xuICAgIGlmIChzZWN0aW9uLm9wZW4pIHtcbiAgICAgIGlmICh0aGlzLmxhc3RTeW1ib2wpIHtcbiAgICAgICAgZmVhdHVyZVJlZHVjdGlvbi5zeW1ib2wgPSB0aGlzLmxhc3RTeW1ib2w7XG4gICAgICAgIHRoaXMubGFzdFN5bWJvbCA9IHVuZGVmaW5lZDtcbiAgICAgIH1cbiAgICAgIGVsc2Uge1xuICAgICAgICBmZWF0dXJlUmVkdWN0aW9uLnN5bWJvbCA9IGdldERlZmF1bHRTeW1ib2wobW9kdWxlcyk7XG4gICAgICB9XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgdGhpcy5sYXN0U3ltYm9sID0gZmVhdHVyZVJlZHVjdGlvbi5zeW1ib2w7XG4gICAgICBmZWF0dXJlUmVkdWN0aW9uLnN5bWJvbCA9IHVuZGVmaW5lZDtcbiAgICB9XG4gICAgdGhpcy5pbnRlcm5hbENoYW5nZS5lbWl0KCk7XG4gICAgZm9yY2VVcGRhdGUodGhpcy5ob3N0RWxlbWVudCk7XG4gIH1cbiAgY3JlYXRlU3ltYm9sUHJldmlldyhjb250YWluZXJOb2RlKSB7XG4gICAgY29uc3QgeyBsYXllciwgbW9kdWxlcyB9ID0gdGhpcztcbiAgICBjb25zdCB7IHN5bWJvbFV0aWxzIH0gPSBtb2R1bGVzO1xuICAgIGNvbnN0IGZlYXR1cmVSZWR1Y3Rpb24gPSBsYXllci5mZWF0dXJlUmVkdWN0aW9uOyAvL19fZXNyaS5GZWF0dXJlUmVkdWN0aW9uQ2x1c3RlcjtcbiAgICBpZiAoIWZlYXR1cmVSZWR1Y3Rpb24uc3ltYm9sKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGNvbnN0IHN5bWJvbCA9IGZlYXR1cmVSZWR1Y3Rpb24uc3ltYm9sO1xuICAgIGNvbnN0IHNpemUgPSBzeW1ib2wudHlwZSA9PT0gXCJjaW1cIiA/IDIwIDogMTQ7XG4gICAgc3ltYm9sVXRpbHNcbiAgICAgIC5yZW5kZXJQcmV2aWV3SFRNTChzeW1ib2wsIHtcbiAgICAgIHNpemUsXG4gICAgICBzeW1ib2xDb25maWc6IHVuZGVmaW5lZFxuICAgIH0pXG4gICAgICAudGhlbigobm9kZSkgPT4ge1xuICAgICAgY29udGFpbmVyTm9kZS5jaGlsZE5vZGVzLmZvckVhY2goKGNoaWxkKSA9PiBjb250YWluZXJOb2RlLnJlbW92ZUNoaWxkKGNoaWxkKSk7XG4gICAgICBjb250YWluZXJOb2RlLmFwcGVuZENoaWxkKG5vZGUpO1xuICAgIH0pO1xuICB9XG4gIGFzeW5jIG9wZW5TeW1ib2xTdHlsZXJQb3BvdmVyKGV2ZW50KSB7XG4gICAgY29uc3QgeyBsYXllciwgcG9ydGFsLCBzdHJpbmdzIH0gPSB0aGlzO1xuICAgIGNvbnN0IHJlZkVsZW1lbnQgPSBmaW5kUGFyZW50Tm9kZShldmVudC50YXJnZXQsIG51bGwsIFwic3ltYm9sLWJ1dHRvblwiKTtcbiAgICBpZiAodGhpcy5zdHlsZXJQb3BvdmVyTm9kZSkge1xuICAgICAgdGhpcy5zeW1ib2xTZWxlY3RlZCA9IGZhbHNlO1xuICAgICAgdGhpcy5jbG9zZVBvcG92ZXJzKCk7XG4gICAgICB0aGlzLnN0eWxlclBvcG92ZXJOb2RlID0gbnVsbDtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICB0aGlzLmNsb3NlUG9wb3ZlcnMoKTtcbiAgICAgIHRoaXMuc3ltYm9sU2VsZWN0ZWQgPSB0cnVlO1xuICAgICAgdGhpcy5zdHlsZXJQb3BvdmVyTm9kZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJhcmNnaXMtYWdncmVnYXRpb24tc3ltYm9sLXN0eWxlci1wb3BvdmVyXCIpO1xuICAgICAgdGhpcy5zdHlsZXJQb3BvdmVyTm9kZS5wcm9wcyA9IHsgbGF5ZXIsIHBvcnRhbCwgc3RyaW5ncyB9O1xuICAgICAgdGhpcy5zdHlsZXJQb3BvdmVyTm9kZS5yZWZlcmVuY2VFbGVtZW50ID0gdGhpcy5mbG93SXRlbU5vZGU7XG4gICAgICB0aGlzLnN0eWxlclBvcG92ZXJOb2RlLmFkZEV2ZW50TGlzdGVuZXIoXCJhcmNnaXNBZ2dyZWdhdGlvblN5bWJvbFN0eWxlclBvcG92ZXJDbG9zZVwiLCAoKSA9PiB7XG4gICAgICAgIHRoaXMuY2xvc2VQb3BvdmVycygpO1xuICAgICAgICB0aGlzLnN5bWJvbFNlbGVjdGVkID0gZmFsc2U7XG4gICAgICAgIC8vIGlmIHdlIGRvIHRoaXMgdG9vIGVhcmx5IHRoZSBlbnRlciBrZXkgZXhlY3V0ZXMgb24gdGhlIGZvY3VzZWQgZGl2XG4gICAgICAgIHNldFRpbWVvdXQoKCkgPT4gcmVmRWxlbWVudC5mb2N1cygpLCAzMDApO1xuICAgICAgfSk7XG4gICAgICB0aGlzLnN0eWxlclBvcG92ZXJOb2RlLmFkZEV2ZW50TGlzdGVuZXIoXCJhcmNnaXNBZ2dyZWdhdGlvblN5bWJvbFN0eWxlckNoYW5nZVwiLCAoKSA9PiB7XG4gICAgICAgIHRoaXMuaW50ZXJuYWxDaGFuZ2UuZW1pdCgpO1xuICAgICAgICBmb3JjZVVwZGF0ZSh0aGlzLmhvc3RFbGVtZW50KTtcbiAgICAgIH0pO1xuICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZCh0aGlzLnN0eWxlclBvcG92ZXJOb2RlKTtcbiAgICAgIHRoaXMuc3R5bGVyUG9wb3Zlck5vZGUuc2V0T3Blbih0cnVlKTtcbiAgICB9XG4gIH1cbiAgYWRkRmllbGRzUGFuZWwoZXZlbnQpIHtcbiAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICB0aGlzLmNsb3NlUG9wb3ZlcnMoKTtcbiAgICBjb25zdCB7IGxheWVyLCB2aWV3LCBjdXJyZW50TGFuZ3VhZ2UsIHN0cmluZ3MsIGZsb3dOb2RlLCBoaWRlTGF5ZXJUaXRsZSB9ID0gdGhpcztcbiAgICBjb25zdCBmaWVsZHNOb2RlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImFyY2dpcy1hZ2dyZWdhdGlvbi1maWVsZHNcIik7XG4gICAgZmllbGRzTm9kZS5sYW5nID0gY3VycmVudExhbmd1YWdlO1xuICAgIGZpZWxkc05vZGUubGF5ZXIgPSBsYXllcjtcbiAgICBmaWVsZHNOb2RlLm1hcFZpZXcgPSB2aWV3O1xuICAgIGZpZWxkc05vZGUuc3RyaW5ncyA9IHN0cmluZ3M7XG4gICAgZmllbGRzTm9kZS5jdXJyZW50TGFuZ3VhZ2UgPSBjdXJyZW50TGFuZ3VhZ2U7XG4gICAgZmllbGRzTm9kZS5oaWRlTGF5ZXJUaXRsZSA9IGhpZGVMYXllclRpdGxlO1xuICAgIGZpZWxkc05vZGUuZmxvd05vZGUgPSBmbG93Tm9kZTtcbiAgICBmaWVsZHNOb2RlLmFkZEV2ZW50TGlzdGVuZXIoXCJhcmNnaXNBZ2dyZWdhdGlvbkZpZWxkc0NoYW5nZVwiLCAoKSA9PiB7XG4gICAgICB0aGlzLmludGVybmFsQ2hhbmdlLmVtaXQoKTtcbiAgICAgIGZvcmNlVXBkYXRlKHRoaXMuaG9zdEVsZW1lbnQpO1xuICAgIH0pO1xuICAgIGZpZWxkc05vZGUuYWRkRXZlbnRMaXN0ZW5lcihcImFyY2dpc0FnZ3JlZ2F0aW9uRmllbGRzQmFja0NsaWNrXCIsICgpID0+IHtcbiAgICAgIGZsb3dOb2RlLnJlbW92ZUNoaWxkKGZpZWxkc05vZGUpO1xuICAgICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLmZpZWxkc0J1dHRvbk5vZGUuZm9jdXMoKSwgMzAwKTtcbiAgICB9KTtcbiAgICBmbG93Tm9kZS5hcHBlbmRDaGlsZChmaWVsZHNOb2RlKTtcbiAgfVxuICBhZGRMYWJlbFBhbmVsKGV2ZW50KSB7XG4gICAgY29uc3QgeyBsYXllciwgdmlldywgcG9ydGFsLCBjb25maWcsIGN1cnJlbnRMYW5ndWFnZSwgc3RyaW5ncywgZmxvd05vZGUsIGhpZGVMYXllclRpdGxlIH0gPSB0aGlzO1xuICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgIHRoaXMuY2xvc2VQb3BvdmVycygpO1xuICAgIGNvbnN0IGxhYmVsRmxvd0l0ZW0gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiY2FsY2l0ZS1mbG93LWl0ZW1cIik7XG4gICAgLy9sYWJlbEZsb3dJdGVtLmlkID0gXCJsYWJlbEZsb3dJdGVtX0lkXCI7XG4gICAgbGFiZWxGbG93SXRlbS5oZWFkaW5nID0gc3RyaW5ncy5jbHVzdGVyLmxhYmVsRmVhdHVyZXNIZWFkaW5nO1xuICAgIGxhYmVsRmxvd0l0ZW0uZGVzY3JpcHRpb24gPSAhaGlkZUxheWVyVGl0bGUgPyBsYXllci50aXRsZSA6IHVuZGVmaW5lZDtcbiAgICBjb25zdCBjYWxjaXRlRmFiID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImNhbGNpdGUtZmFiXCIpO1xuICAgIGNhbGNpdGVGYWIuaWNvbiA9IFwicGx1c1wiO1xuICAgIGNhbGNpdGVGYWIuc2xvdCA9IFwiZmFiXCI7XG4gICAgY2FsY2l0ZUZhYi5zY2FsZSA9IFwic1wiO1xuICAgIGNhbGNpdGVGYWIuYXBwZWFyYW5jZSA9IFwib3V0bGluZS1maWxsXCI7XG4gICAgY2FsY2l0ZUZhYi5raW5kID0gXCJuZXV0cmFsXCI7XG4gICAgY2FsY2l0ZUZhYi5sYWJlbCA9IHN0cmluZ3MuY2x1c3Rlci5sYWJlbEZhYjtcbiAgICBjYWxjaXRlRmFiLnRleHQgPSBzdHJpbmdzLmNsdXN0ZXIubGFiZWxGYWI7XG4gICAgY2FsY2l0ZUZhYi50ZXh0RW5hYmxlZCA9IHRydWU7XG4gICAgbGFiZWxGbG93SXRlbS5hcHBlbmRDaGlsZChjYWxjaXRlRmFiKTtcbiAgICBjb25zdCBsYWJlbENvbXBvbmVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJhcmNnaXMtbGFiZWxcIik7XG4gICAgbGFiZWxDb21wb25lbnQubGFuZyA9IGN1cnJlbnRMYW5ndWFnZTtcbiAgICBsYWJlbENvbXBvbmVudC5sYXllciA9IGxheWVyO1xuICAgIGxhYmVsQ29tcG9uZW50Lm1hcFZpZXcgPSB2aWV3O1xuICAgIGxhYmVsQ29tcG9uZW50LnBvcnRhbCA9IHBvcnRhbDtcbiAgICBsYWJlbENvbXBvbmVudC5jb25maWcgPSBjb25maWc7XG4gICAgbGFiZWxDb21wb25lbnQubGF5ZXJEaXNwbGF5VHlwZSA9IGxheWVyRGlzcGxheVR5cGVFbnVtLmNsdXN0ZXI7XG4gICAgbGFiZWxDb21wb25lbnQuY2FsY2l0ZUZsb3dQcm9wcyA9IHsgY2FsY2l0ZUZsb3dJdGVtOiBsYWJlbEZsb3dJdGVtLCBjYWxjaXRlRmFiOiBjYWxjaXRlRmFiIH07XG4gICAgbGFiZWxDb21wb25lbnQuYWRkRXZlbnRMaXN0ZW5lcihcImxhYmVsVXBkYXRlZFwiLCAoKSA9PiB7XG4gICAgICB0aGlzLmludGVybmFsQ2hhbmdlLmVtaXQoKTtcbiAgICAgIGZvcmNlVXBkYXRlKHRoaXMuaG9zdEVsZW1lbnQpO1xuICAgIH0pO1xuICAgIGxhYmVsRmxvd0l0ZW0uYXBwZW5kQ2hpbGQobGFiZWxDb21wb25lbnQpO1xuICAgIGxhYmVsRmxvd0l0ZW0uYWRkRXZlbnRMaXN0ZW5lcihcImNhbGNpdGVGbG93SXRlbUJhY2tcIiwgKCkgPT4ge1xuICAgICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLmxhYmVsc0J1dHRvbk5vZGUuZm9jdXMoKSwgMzAwKTtcbiAgICB9KTtcbiAgICBmbG93Tm9kZS5hcHBlbmRDaGlsZChsYWJlbEZsb3dJdGVtKTtcbiAgICBzZXRUaW1lb3V0KCgpID0+IHJlcXVlc3RBbmltYXRpb25GcmFtZSgoKSA9PiBsYWJlbEZsb3dJdGVtLnNldEZvY3VzKCkpLCAyMDApO1xuICB9XG4gIGFkZFBvcHVwUGFuZWwoZXZlbnQpIHtcbiAgICBjb25zdCB7IGxheWVyLCB2aWV3LCBwb3J0YWwsIGNvbmZpZywgY3VycmVudExhbmd1YWdlLCBzdHJpbmdzLCBmbG93Tm9kZSwgaGlkZUxheWVyVGl0bGUgfSA9IHRoaXM7XG4gICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgdGhpcy5jbG9zZVBvcG92ZXJzKCk7XG4gICAgY29uc3QgcG9wdXBGbG93SXRlbSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJjYWxjaXRlLWZsb3ctaXRlbVwiKTtcbiAgICBwb3B1cEZsb3dJdGVtLmhlYWRpbmcgPSBzdHJpbmdzLmNsdXN0ZXIucG9wdXBzSGVhZGluZztcbiAgICBwb3B1cEZsb3dJdGVtLmRlc2NyaXB0aW9uID0gIWhpZGVMYXllclRpdGxlID8gbGF5ZXIudGl0bGUgOiB1bmRlZmluZWQ7XG4gICAgY29uc3QgY2FsY2l0ZUZhYiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJjYWxjaXRlLWZhYlwiKTtcbiAgICBjYWxjaXRlRmFiLmljb24gPSBcInBsdXNcIjtcbiAgICBjYWxjaXRlRmFiLnNsb3QgPSBcImZhYlwiO1xuICAgIGNhbGNpdGVGYWIuc2NhbGUgPSBcInNcIjtcbiAgICBjYWxjaXRlRmFiLmFwcGVhcmFuY2UgPSBcIm91dGxpbmUtZmlsbFwiO1xuICAgIGNhbGNpdGVGYWIua2luZCA9IFwibmV1dHJhbFwiO1xuICAgIGNhbGNpdGVGYWIubGFiZWwgPSBzdHJpbmdzLmNsdXN0ZXIucG9wdXBGYWI7XG4gICAgY2FsY2l0ZUZhYi50ZXh0ID0gc3RyaW5ncy5jbHVzdGVyLnBvcHVwRmFiO1xuICAgIGNhbGNpdGVGYWIudGV4dEVuYWJsZWQgPSB0cnVlO1xuICAgIHBvcHVwRmxvd0l0ZW0uYXBwZW5kQ2hpbGQoY2FsY2l0ZUZhYik7XG4gICAgY29uc3QgcG9wdXBDb21wb25lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiYXJjZ2lzLXBvcHVwXCIpO1xuICAgIHBvcHVwQ29tcG9uZW50LmxhbmcgPSBjdXJyZW50TGFuZ3VhZ2U7XG4gICAgcG9wdXBDb21wb25lbnQubGF5ZXIgPSBsYXllcjtcbiAgICBwb3B1cENvbXBvbmVudC5tYXBWaWV3ID0gdmlldztcbiAgICBwb3B1cENvbXBvbmVudC5wb3J0YWwgPSBwb3J0YWw7XG4gICAgcG9wdXBDb21wb25lbnQuY29uZmlnID0gY29uZmlnO1xuICAgIHBvcHVwQ29tcG9uZW50LmxheWVyRGlzcGxheVR5cGUgPSBsYXllckRpc3BsYXlUeXBlRW51bS5jbHVzdGVyO1xuICAgIHBvcHVwQ29tcG9uZW50LmNhbGNpdGVGbG93UHJvcHMgPSB7XG4gICAgICBmbG93OiBmbG93Tm9kZSxcbiAgICAgIGNhbGNpdGVGYWI6IGNhbGNpdGVGYWIsXG4gICAgICBjYWxjaXRlRmxvd0l0ZW06IHBvcHVwRmxvd0l0ZW1cbiAgICB9O1xuICAgIHBvcHVwQ29tcG9uZW50LmFkZEV2ZW50TGlzdGVuZXIoXCJwb3B1cFVwZGF0ZWRcIiwgKCkgPT4ge1xuICAgICAgdGhpcy5pbnRlcm5hbENoYW5nZS5lbWl0KCk7XG4gICAgICBmb3JjZVVwZGF0ZSh0aGlzLmhvc3RFbGVtZW50KTtcbiAgICB9KTtcbiAgICBwb3B1cEZsb3dJdGVtLmFwcGVuZENoaWxkKHBvcHVwQ29tcG9uZW50KTtcbiAgICBwb3B1cEZsb3dJdGVtLmFkZEV2ZW50TGlzdGVuZXIoXCJjYWxjaXRlRmxvd0l0ZW1CYWNrXCIsICgpID0+IHtcbiAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5wb3B1cEJ1dHRvbk5vZGUuZm9jdXMoKSwgMzAwKTtcbiAgICB9KTtcbiAgICBmbG93Tm9kZS5hcHBlbmRDaGlsZChwb3B1cEZsb3dJdGVtKTtcbiAgICBzZXRUaW1lb3V0KCgpID0+IHJlcXVlc3RBbmltYXRpb25GcmFtZSgoKSA9PiBwb3B1cEZsb3dJdGVtLnNldEZvY3VzKCkpLCAyMDApO1xuICB9XG4gIGdldCBob3N0RWxlbWVudCgpIHsgcmV0dXJuIGdldEVsZW1lbnQodGhpcyk7IH1cbn07XG5BcmNnaXNBZ2dyZWdhdGlvbkNsdXN0ZXJpbmcuc3R5bGUgPSBhcmNnaXNBZ2dyZWdhdGlvbkNsdXN0ZXJpbmdDc3M7XG5cbmNvbnN0IGFyY2dpc0FnZ3JlZ2F0aW9uRmllbGRDc3MgPSBcIi5zZWN0aW9uLnNjLWFyY2dpcy1hZ2dyZWdhdGlvbi1maWVsZHtwYWRkaW5nLXRvcDoxNXB4fS5mb3JtYXQuc2MtYXJjZ2lzLWFnZ3JlZ2F0aW9uLWZpZWxke3BhZGRpbmctdG9wOjIwcHh9XCI7XG5cbmNvbnN0IEFyY2dpc0FnZ3JlZ2F0aW9uRmllbGQgPSBjbGFzcyB7XG4gIGNvbnN0cnVjdG9yKGhvc3RSZWYpIHtcbiAgICByZWdpc3Rlckluc3RhbmNlKHRoaXMsIGhvc3RSZWYpO1xuICAgIHRoaXMuYXJjZ2lzQWdncmVnYXRpb25GaWVsZENoYW5nZSA9IGNyZWF0ZUV2ZW50KHRoaXMsIFwiYXJjZ2lzQWdncmVnYXRpb25GaWVsZENoYW5nZVwiLCA3KTtcbiAgICB0aGlzLm9uRmllbGRTZWxlY3QgPSAoKSA9PiB7XG4gICAgICAvLyBub3QgZm9yIGF1dG9HZW5lcmF0ZWQgZmllbGRzXG4gICAgICAvL3RoaXMuaGFzRm9jdXMgPSB0cnVlO1xuICAgICAgY29uc3QgeyBsYXllciwgbWFwVmlldywgYWdncmVnYXRlRmllbGQsIGZpZWxkUGlja0xpc3RTb3J0QnksIHN0cmluZ3MgfSA9IHRoaXM7XG4gICAgICAvL2NvbnN0IGRpciA9IGdldEVsZW1lbnREaXIodGhpcy5ob3N0RWxlbWVudCk7XG4gICAgICAvL3RoaXMuY2xvc2VGaWx0ZXJQb3BvdmVyc0hhbmRsZXIoKTtcbiAgICAgIGNvbnN0IGZsb3dJdGVtTm9kZSA9IGZpbmRQYXJlbnROb2RlKHRoaXMuaG9zdEVsZW1lbnQsIFwiY2FsY2l0ZS1mbG93LWl0ZW1cIik7XG4gICAgICBjb25zdCBub2RlV2lkdGggPSBmbG93SXRlbU5vZGUuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkud2lkdGggfHwgMjE1O1xuICAgICAgdGhpcy5hcmNnaXNGaWVsZFBpY2tMaXN0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImFyY2dpcy1maWVsZC1waWNrLWxpc3RcIik7XG4gICAgICB0aGlzLmFyY2dpc0ZpZWxkUGlja0xpc3QucG9wb3ZlclByb3BzID0ge1xuICAgICAgICBwbGFjZW1lbnQ6IFwiYXV0b1wiLFxuICAgICAgICBvZmZzZXREaXN0YW5jZTogLTEgKiAobm9kZVdpZHRoICsgMTApLFxuICAgICAgICBvZmZzZXRTa2lkZGluZzogMCxcbiAgICAgICAgcG9pbnRlckRpc2FibGVkOiB0cnVlLFxuICAgICAgICBwb3BvdmVyV2lkdGg6IG5vZGVXaWR0aCArIDMwLFxuICAgICAgICByZWZFbGVtZW50OiBmbG93SXRlbU5vZGVcbiAgICAgIH07XG4gICAgICB0aGlzLmFyY2dpc0ZpZWxkUGlja0xpc3QuZmllbGRzID0gdGhpcy5jcmVhdGVQaWNrTGlzdEZpZWxkcygpO1xuICAgICAgdGhpcy5hcmNnaXNGaWVsZFBpY2tMaXN0LmxheWVyID0gbGF5ZXI7XG4gICAgICB0aGlzLmFyY2dpc0ZpZWxkUGlja0xpc3QubWFwVmlldyA9IG1hcFZpZXc7XG4gICAgICB0aGlzLmFyY2dpc0ZpZWxkUGlja0xpc3Quc2hvd0ZpZWxkSW5mbyA9IHRydWU7XG4gICAgICB0aGlzLmFyY2dpc0ZpZWxkUGlja0xpc3Quc2hvd0ZpZWxkTmFtZSA9IGZhbHNlO1xuICAgICAgdGhpcy5hcmNnaXNGaWVsZFBpY2tMaXN0LnNlbGVjdGVkRmllbGRzID0gW2FnZ3JlZ2F0ZUZpZWxkLm9uU3RhdGlzdGljRmllbGRdO1xuICAgICAgdGhpcy5hcmNnaXNGaWVsZFBpY2tMaXN0LnNvcnRCeSA9IGZpZWxkUGlja0xpc3RTb3J0Qnk7XG4gICAgICB0aGlzLmFyY2dpc0ZpZWxkUGlja0xpc3QuYWRkRXZlbnRMaXN0ZW5lcihcImFyY2dpc0ZpZWxkUGlja0xpc3REaXNtaXNzZWRcIiwgKGV2ZW50KSA9PiB7XG4gICAgICAgIHZhciBfYSwgX2I7XG4gICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICBjb25zdCBzZWxlY3RlZEZpZWxkID0gKF9iID0gKF9hID0gZXZlbnQuZGV0YWlsKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2Euc2VsZWN0ZWRGaWVsZHMpID09PSBudWxsIHx8IF9iID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYlswXTtcbiAgICAgICAgZmxvd0l0ZW1Ob2RlLmRpc2FibGVkID0gZmFsc2U7XG4gICAgICAgIGlmICh0aGlzLmFyY2dpc0ZpZWxkUGlja0xpc3QpIHtcbiAgICAgICAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKHRoaXMuYXJjZ2lzRmllbGRQaWNrTGlzdCk7XG4gICAgICAgICAgdGhpcy5hcmNnaXNGaWVsZFBpY2tMaXN0ID0gbnVsbDtcbiAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgIHRoaXMuZmllbGROb2RlLnNldEZvY3VzKCk7XG4gICAgICAgICAgfSwgMSk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHNlbGVjdGVkRmllbGQpIHtcbiAgICAgICAgICBjb25zdCB7IGFnZ3JlZ2F0ZUZpZWxkIH0gPSB0aGlzO1xuICAgICAgICAgIGNvbnN0IGZpZWxkID0gZ2V0TGF5ZXJGaWVsZChsYXllciwgc2VsZWN0ZWRGaWVsZCk7XG4gICAgICAgICAgLy8gY2hlY2sgaWYgd2UgaGF2ZSB0aGlzIGZpZWxkIGFscmVhZHkuLi5cbiAgICAgICAgICBjb25zdCB0eXBlcyA9IGdldFN0YXRzVHlwZXMoZmllbGQpO1xuICAgICAgICAgIGxldCBpZHhUeXBlID0gMDtcbiAgICAgICAgICBsZXQgaGFzQWxyZWFkeSA9IGhhc0ZpZWxkQWxyZWFkeShsYXllciwgZmllbGQubmFtZSwgdHlwZXNbaWR4VHlwZV0pO1xuICAgICAgICAgIHdoaWxlIChpZHhUeXBlIDwgdHlwZXMubGVuZ3RoICYmIGhhc0FscmVhZHkpIHtcbiAgICAgICAgICAgIGlkeFR5cGUrKztcbiAgICAgICAgICAgIGlmICh0eXBlc1tpZHhUeXBlXSA9PT0gYWdncmVnYXRlRmllbGQuc3RhdGlzdGljVHlwZSkge1xuICAgICAgICAgICAgICAvLyBza2lwIHRoZSBjdXJyZW50IG9uZVxuICAgICAgICAgICAgICBpZHhUeXBlKys7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoaWR4VHlwZSA8IHR5cGVzLmxlbmd0aCkge1xuICAgICAgICAgICAgICBoYXNBbHJlYWR5ID0gaGFzRmllbGRBbHJlYWR5KGxheWVyLCBmaWVsZC5uYW1lLCB0eXBlc1tpZHhUeXBlXSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChoYXNBbHJlYWR5KSB7XG4gICAgICAgICAgICAvLyBhbGwgc3RhdGlzdGljVHlwZXMgYWxyZWFkeSBleGlzdCBmb3IgdGhpcyBmaWVsZDsgY2FuJ3QgY2hhbmdlIHRvIHRoaXMgZmllbGRcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICB9XG4gICAgICAgICAgY29uc3Qgb2xkRmllbGROYW1lID0gYWdncmVnYXRlRmllbGQubmFtZTtcbiAgICAgICAgICBjb25zdCB0eXBlID0gdHlwZXNbaWR4VHlwZV07XG4gICAgICAgICAgYWdncmVnYXRlRmllbGQubmFtZSA9IGAke2ZpZWxkLm5hbWV9XyR7dHlwZX1gO1xuICAgICAgICAgIGFnZ3JlZ2F0ZUZpZWxkLm9uU3RhdGlzdGljRmllbGQgPSBmaWVsZC5uYW1lO1xuICAgICAgICAgIGFnZ3JlZ2F0ZUZpZWxkLmFsaWFzID0gYCR7ZmllbGQuYWxpYXMgfHwgZmllbGQubmFtZX0gJHtnZXRTdGF0c1R5cGVTdHJpbmcodHlwZSwgc3RyaW5ncykudG9Mb3dlckNhc2UoKX1gO1xuICAgICAgICAgIGFnZ3JlZ2F0ZUZpZWxkLnN0YXRpc3RpY1R5cGUgPSB0eXBlO1xuICAgICAgICAgIHRoaXMucmVwbGFjZVBvcHVwRmllbGQob2xkRmllbGROYW1lKTtcbiAgICAgICAgICB0aGlzLmFyY2dpc0FnZ3JlZ2F0aW9uRmllbGRDaGFuZ2UuZW1pdCgpO1xuICAgICAgICB9IC8vIGVsc2UgdXNlciBoaXQgY2FuY2VsIG9yIGNsb3NlXG4gICAgICB9KTtcbiAgICAgIHRoaXMuYXJjZ2lzRmllbGRQaWNrTGlzdC5hZGRFdmVudExpc3RlbmVyKFwiYXJjZ2lzRmllbGRQaWNrTGlzdFNvcnRCeUNoYW5nZVwiLCAoZXZlbnQpID0+ICh0aGlzLmZpZWxkUGlja0xpc3RTb3J0QnkgPSBldmVudC5kZXRhaWwpKTtcbiAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQodGhpcy5hcmNnaXNGaWVsZFBpY2tMaXN0KTtcbiAgICAgIGZsb3dJdGVtTm9kZS5kaXNhYmxlZCA9IHRydWU7XG4gICAgfTtcbiAgICB0aGlzLm1hcFZpZXcgPSB1bmRlZmluZWQ7XG4gICAgdGhpcy5sYXllciA9IHVuZGVmaW5lZDtcbiAgICB0aGlzLmFnZ3JlZ2F0ZUZpZWxkID0gdW5kZWZpbmVkO1xuICAgIHRoaXMub3BlbiA9IGZhbHNlO1xuICAgIHRoaXMuc3RyaW5ncyA9IHVuZGVmaW5lZDtcbiAgICB0aGlzLmN1cnJlbnRMYW5ndWFnZSA9IHVuZGVmaW5lZDtcbiAgfVxuICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIC8vXG4gIC8vICBwdWJsaWMgY2FsbHNcbiAgLy9cbiAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAvLyBQdWJsaWMgTWV0aG9kc1xuICBhc3luYyBkb25lKCkge1xuICAgIHRoaXMuY2xvc2VQb3BvdmVycygpO1xuICB9XG4gIGFzeW5jIHNldEZvY3VzKCkge1xuICAgIHRoaXMucGFuZWxOb2RlLnNldEZvY3VzKCk7XG4gIH1cbiAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAvL1xuICAvLyAgTGlmZWN5Y2xlXG4gIC8vXG4gIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgYXN5bmMgY29tcG9uZW50V2lsbExvYWQoKSB7XG4gICAgY29uc3QgW0ZpZWxkSW5mbywgRmllbGRJbmZvRm9ybWF0XSA9IGF3YWl0IGxvYWRNb2R1bGVzKFtcbiAgICAgIFwiZXNyaS9wb3B1cC9GaWVsZEluZm9cIixcbiAgICAgIFwiZXNyaS9wb3B1cC9zdXBwb3J0L0ZpZWxkSW5mb0Zvcm1hdFwiXG4gICAgXSk7XG4gICAgdGhpcy5tb2R1bGVzID0ge1xuICAgICAgRmllbGRJbmZvLFxuICAgICAgRmllbGRJbmZvRm9ybWF0XG4gICAgfTtcbiAgICAvLyBtYWtlIHN1cmUgdGhlIGZpZWxkIGV4aXN0cyBpbiB0aGUgcG9wdXBcbiAgICBjb25zdCB7IGxheWVyLCBhZ2dyZWdhdGVGaWVsZCwgbW9kdWxlcyB9ID0gdGhpcztcbiAgICBsZXQgZmllbGRJbmZvID0gZ2V0UG9wdXBGaWVsZEluZm8obGF5ZXIsIGFnZ3JlZ2F0ZUZpZWxkLm5hbWUpO1xuICAgIGlmICghZmllbGRJbmZvKSB7XG4gICAgICBhZGRQb3B1cEZpZWxkKGFnZ3JlZ2F0ZUZpZWxkLCBsYXllciwgbW9kdWxlcyk7XG4gICAgfVxuICB9XG4gIGRpc2Nvbm5lY3RlZENhbGxiYWNrKCkge1xuICAgIHRoaXMuY2xvc2VQb3BvdmVycygpO1xuICB9XG4gIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIC8vXG4gIC8vICBSZW5kZXIgTWV0aG9kc1xuICAvL1xuICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIHJlbmRlcigpIHtcbiAgICAvKlxuICAgIHtcbiAgICAgIFwibmFtZVwiOiBcIkZpZWxkTmFtZVwiLFxuICAgICAgXCJhbGlhc1wiOiBcIlRoZSBmaWVsZCBhbGlhc1wiLFxuICAgICAgXCJvblN0YXRpc3RpY0ZpZWxkXCI6IFwiTGF5ZXIgZmllbGRcIixcbiAgICAgIFwib25TdGF0aXN0aWNFeHByZXNzaW9uXCI6IHtcbiAgICAgICAgXCJleHByZXNzaW9uXCI6IFwiQXJjYWRlIGV4cHJlc3Npb24gZ29lcyBoZXJlXCIsXG4gICAgICAgIFwicmV0dXJuVHlwZVwiOiBcIjxzdHJpbmcgfCBudW1iZXI+XCJcbiAgICAgIH0sXG4gICAgICBcInN0YXRpc3RpY1R5cGVcIjogXCI8Y291bnQgfCBzdW0gfCBtaW4gfCBtYXggfCBtb2RlIHwgYXZnIHwgc3RkZGV2IHwgdmFyPlwiLFxuICAgICAgXCJpc0luZmVycmVkXCI6IDxib29sZWFuPiAgLy8gb25seSBuZWVkZWQgZm9yIE9ubGluZVxuICAgIH1cbiAgICAqL1xuICAgIGNvbnN0IHsgbGF5ZXIsIGFnZ3JlZ2F0ZUZpZWxkLCBvcGVuIH0gPSB0aGlzO1xuICAgIGNvbnN0IGRpciA9IGdldEVsZW1lbnREaXIodGhpcy5ob3N0RWxlbWVudCk7XG4gICAgY29uc3QgZmllbGRJbmZvID0gZ2V0UG9wdXBGaWVsZEluZm8obGF5ZXIsIGFnZ3JlZ2F0ZUZpZWxkLm5hbWUpO1xuICAgIGNvbnN0IGFsaWFzID0gKGFnZ3JlZ2F0ZUZpZWxkLmlzQXV0b0dlbmVyYXRlZCA/IGZpZWxkSW5mby5sYWJlbCA6IGFnZ3JlZ2F0ZUZpZWxkLmFsaWFzKSB8fFxuICAgICAgYWdncmVnYXRlRmllbGQubmFtZTtcbiAgICByZXR1cm4gKGgoSG9zdCwgeyBkaXI6IGRpciB9LCBoKFwiY2FsY2l0ZS1ibG9ja1wiLCB7IGhlYWRpbmc6IGFsaWFzLCBvcGVuOiBvcGVuLCBjb2xsYXBzaWJsZTogdHJ1ZSwgcmVmOiAobm9kZSkgPT4gKHRoaXMuYmxvY2tOb2RlID0gbm9kZSksIG9uQ2FsY2l0ZUJsb2NrVG9nZ2xlOiAoZXZlbnQpID0+IHtcbiAgICAgICAgY29uc3Qgbm9kZSA9IGV2ZW50LnRhcmdldDtcbiAgICAgICAgdGhpcy5vcGVuID0gbm9kZS5vcGVuO1xuICAgICAgfSB9LCB0aGlzLnJlbmRlckRyb3Bkb3duKCksIHRoaXMucmVuZGVyRmllbGRTZWxlY3Rpb24oKSwgdGhpcy5yZW5kZXJUeXBlU2VsZWN0aW9uKCksIHRoaXMucmVuZGVyUmVzdWx0RmllbGROYW1lKCksIHRoaXMucmVuZGVyRmllbGRBbGlhcygpLCB0aGlzLnJlbmRlckZvcm1hdHRpbmcoKSkpKTtcbiAgfVxuICByZW5kZXJEcm9wZG93bigpIHtcbiAgICBjb25zdCB7IGxheWVyLCBhZ2dyZWdhdGVGaWVsZCwgc3RyaW5ncyB9ID0gdGhpcztcbiAgICBjb25zdCBmaWVsZCA9IGdldExheWVyRmllbGQobGF5ZXIsIGFnZ3JlZ2F0ZUZpZWxkLm9uU3RhdGlzdGljRmllbGQpO1xuICAgIGlmIChhZ2dyZWdhdGVGaWVsZC5pc0F1dG9HZW5lcmF0ZWQgfHwgIWZpZWxkKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gICAgY29uc3QgZGlyID0gZ2V0RWxlbWVudERpcih0aGlzLmhvc3RFbGVtZW50KTtcbiAgICByZXR1cm4gKGgoXCJkaXZcIiwgeyBzbG90OiBcImNvbnRyb2xcIiB9LCBoKFwiY2FsY2l0ZS1kcm9wZG93blwiLCB7IGRpcjogZGlyLCBwbGFjZW1lbnQ6IFwiYm90dG9tLWVuZFwiLCBzY2FsZTogXCJzXCIsIG92ZXJsYXlQb3NpdGlvbmluZzogXCJmaXhlZFwiIH0sIGgoXCJjYWxjaXRlLWFjdGlvblwiLCB7IHJlZjogKG5vZGUpID0+ICh0aGlzLmRyb3Bkb3duQWN0aW9uTm9kZSA9IG5vZGUpLCBzbG90OiBcInRyaWdnZXJcIiwgc2NhbGU6IFwibVwiLCB0ZXh0OiBzdHJpbmdzLmRlbGV0ZSB9LCBoKFwiY2FsY2l0ZS1pY29uXCIsIHsgc2NhbGU6IFwic1wiLCBpY29uOiBcImVsbGlwc2lzXCIgfSkpLCBoKFwiY2FsY2l0ZS1kcm9wZG93bi1ncm91cFwiLCBudWxsLCBoKFwiY2FsY2l0ZS1kcm9wZG93bi1pdGVtXCIsIHsgb25DbGljazogKGV2ZW50KSA9PiB7XG4gICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICB0aGlzLnJlbW92ZUZpZWxkKCk7XG4gICAgICB9LCBvbktleURvd246IChldmVudCkgPT4ge1xuICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgaWYgKGV2ZW50LmtleSA9PT0gXCIgXCIgfHwgZXZlbnQua2V5ID09PSBcIkVudGVyXCIpIHtcbiAgICAgICAgICB0aGlzLnJlbW92ZUZpZWxkKCk7XG4gICAgICAgIH1cbiAgICAgIH0gfSwgc3RyaW5ncy5kZWxldGUpKSkpKTtcbiAgfVxuICByZW5kZXJGaWVsZFNlbGVjdGlvbigpIHtcbiAgICBjb25zdCB7IGFnZ3JlZ2F0ZUZpZWxkLCBzdHJpbmdzIH0gPSB0aGlzO1xuICAgIGlmICghYWdncmVnYXRlRmllbGQub25TdGF0aXN0aWNGaWVsZCkge1xuICAgICAgLy8gZS5nLiBjbHVzdGVyX2NvdW50IG9yIG9uU3RhdGlzdGljc0V4cHJlc3Npb25cbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgICByZXR1cm4gKGgoRnJhZ21lbnQsIG51bGwsIGgoXCJjYWxjaXRlLWxhYmVsXCIsIG51bGwsIHN0cmluZ3MuZmllbGRzLmZpZWxkKSwgaChcImNhbGNpdGUtYnV0dG9uXCIsIHsgYXBwZWFyYW5jZTogXCJvdXRsaW5lLWZpbGxcIiwga2luZDogXCJuZXV0cmFsXCIsIHdpZHRoOiBcImZ1bGxcIiwgc2NhbGU6IFwibVwiLCBhbGlnbm1lbnQ6IFwiaWNvbi1lbmQtc3BhY2UtYmV0d2VlblwiLCBpY29uRW5kOiBcImNoZXZyb24tZG93blwiLCBkaXNhYmxlZDogYWdncmVnYXRlRmllbGQuaXNBdXRvR2VuZXJhdGVkLCBvbkNsaWNrOiAoKSA9PiB0aGlzLm9uRmllbGRTZWxlY3QoKSwgcmVmOiAobm9kZSkgPT4gKHRoaXMuZmllbGROb2RlID0gbm9kZSkgfSwgYWdncmVnYXRlRmllbGQub25TdGF0aXN0aWNGaWVsZCkpKTtcbiAgfVxuICByZW5kZXJUeXBlU2VsZWN0aW9uKCkge1xuICAgIGNvbnN0IHsgbGF5ZXIsIGFnZ3JlZ2F0ZUZpZWxkLCBzdHJpbmdzIH0gPSB0aGlzO1xuICAgIGNvbnN0IGZpZWxkID0gZ2V0TGF5ZXJGaWVsZChsYXllciwgYWdncmVnYXRlRmllbGQub25TdGF0aXN0aWNGaWVsZCk7XG4gICAgY29uc3QgaXNTdHJpbmcgPSAoZmllbGQgPT09IG51bGwgfHwgZmllbGQgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGZpZWxkLnR5cGUpID09PSBcInN0cmluZ1wiO1xuICAgIHJldHVybiAoaChcImRpdlwiLCB7IGNsYXNzOiBcInNlY3Rpb25cIiB9LCBoKFwiY2FsY2l0ZS1sYWJlbFwiLCBudWxsLCBzdHJpbmdzLmZpZWxkcy5zdGF0c1R5cGUpLCBoKFwiY2FsY2l0ZS1zZWxlY3RcIiwgeyB3aWR0aDogXCJmdWxsXCIsIHNjYWxlOiBcIm1cIiwgbGFiZWw6IHN0cmluZ3MuZmllbGRzLnN0YXRzVHlwZSwgZGlzYWJsZWQ6IGFnZ3JlZ2F0ZUZpZWxkLmlzQXV0b0dlbmVyYXRlZCB8fCAhZmllbGQsIG9uQ2FsY2l0ZVNlbGVjdENoYW5nZTogKGV2ZW50KSA9PiB7XG4gICAgICAgIC8vIGRpc2FibGVkIGZvciBhdXRvR2VuZXJhdGVkIGZpZWxkc1xuICAgICAgICBjb25zdCBub2RlID0gZXZlbnQgPT09IG51bGwgfHwgZXZlbnQgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGV2ZW50LnRhcmdldDtcbiAgICAgICAgY29uc3QgdHlwZSA9IG5vZGUuc2VsZWN0ZWRPcHRpb24udmFsdWU7XG4gICAgICAgIGNvbnN0IG9sZEZpZWxkTmFtZSA9IGFnZ3JlZ2F0ZUZpZWxkLm5hbWU7XG4gICAgICAgIGFnZ3JlZ2F0ZUZpZWxkLm5hbWUgPSBgJHtmaWVsZC5uYW1lfV8ke3R5cGV9YDtcbiAgICAgICAgYWdncmVnYXRlRmllbGQub25TdGF0aXN0aWNGaWVsZCA9IGZpZWxkLm5hbWU7XG4gICAgICAgIGFnZ3JlZ2F0ZUZpZWxkLmFsaWFzID0gYCR7ZmllbGQuYWxpYXMgfHwgZmllbGQubmFtZX0gJHtnZXRTdGF0c1R5cGVTdHJpbmcodHlwZSwgc3RyaW5ncykudG9Mb3dlckNhc2UoKX1gO1xuICAgICAgICBhZ2dyZWdhdGVGaWVsZC5zdGF0aXN0aWNUeXBlID0gdHlwZTtcbiAgICAgICAgdGhpcy5yZXBsYWNlUG9wdXBGaWVsZChvbGRGaWVsZE5hbWUpO1xuICAgICAgICB0aGlzLmFyY2dpc0FnZ3JlZ2F0aW9uRmllbGRDaGFuZ2UuZW1pdCgpO1xuICAgICAgfSB9LCAhaXNTdHJpbmcgJiYgdGhpcy5yZW5kZXJUeXBlT3B0aW9uKFwic3VtXCIpLCAhaXNTdHJpbmcgJiYgdGhpcy5yZW5kZXJUeXBlT3B0aW9uKFwiYXZnXCIpLCAhaXNTdHJpbmcgJiYgdGhpcy5yZW5kZXJUeXBlT3B0aW9uKFwibWluXCIpLCAhaXNTdHJpbmcgJiYgdGhpcy5yZW5kZXJUeXBlT3B0aW9uKFwibWF4XCIpLCB0aGlzLnJlbmRlclR5cGVPcHRpb24oXCJtb2RlXCIpLCBhZ2dyZWdhdGVGaWVsZC5zdGF0aXN0aWNUeXBlID09PSBcImNvdW50XCIgJiYgdGhpcy5yZW5kZXJUeXBlT3B0aW9uKFwiY291bnRcIikpKSk7XG4gIH1cbiAgcmVuZGVyVHlwZU9wdGlvbih0eXBlKSB7XG4gICAgY29uc3QgeyBsYXllciwgYWdncmVnYXRlRmllbGQsIHN0cmluZ3MgfSA9IHRoaXM7XG4gICAgcmV0dXJuIChoKFwiY2FsY2l0ZS1vcHRpb25cIiwgeyB2YWx1ZTogdHlwZSwgbGFiZWw6IGdldFN0YXRzVHlwZVN0cmluZyh0eXBlLCBzdHJpbmdzKSwgZGlzYWJsZWQ6IGFnZ3JlZ2F0ZUZpZWxkLnN0YXRpc3RpY1R5cGUgIT09IHR5cGUgJiZcbiAgICAgICAgaGFzRmllbGRBbHJlYWR5KGxheWVyLCBhZ2dyZWdhdGVGaWVsZC5vblN0YXRpc3RpY0ZpZWxkLCB0eXBlKSwgc2VsZWN0ZWQ6IGFnZ3JlZ2F0ZUZpZWxkLnN0YXRpc3RpY1R5cGUgPT09IHR5cGUgfSkpO1xuICB9XG4gIHJlbmRlclJlc3VsdEZpZWxkTmFtZSgpIHtcbiAgICBjb25zdCB7IGFnZ3JlZ2F0ZUZpZWxkLCBzdHJpbmdzIH0gPSB0aGlzO1xuICAgIHJldHVybiAoaChcImRpdlwiLCB7IGNsYXNzOiBcInNlY3Rpb25cIiB9LCBoKFwiY2FsY2l0ZS1sYWJlbFwiLCBudWxsLCBzdHJpbmdzLmZpZWxkcy5yZXN1bHRGaWVsZE5hbWUpLCBoKFwiY2FsY2l0ZS1pbnB1dFwiLCB7IHR5cGU6IFwidGV4dFwiLCBkaXNhYmxlZDogdHJ1ZSwgdmFsdWU6IGFnZ3JlZ2F0ZUZpZWxkLm5hbWUsIHNjYWxlOiBcIm1cIiwgbGFiZWw6IHN0cmluZ3MuZmllbGRzLnJlc3VsdEZpZWxkTmFtZSB9KSkpO1xuICB9XG4gIHJlbmRlckZpZWxkQWxpYXMoKSB7XG4gICAgY29uc3QgeyBsYXllciwgYWdncmVnYXRlRmllbGQsIHN0cmluZ3MgfSA9IHRoaXM7XG4gICAgY29uc3QgZmllbGRJbmZvID0gZ2V0UG9wdXBGaWVsZEluZm8obGF5ZXIsIGFnZ3JlZ2F0ZUZpZWxkLm5hbWUpO1xuICAgIGNvbnN0IGFsaWFzID0gKGFnZ3JlZ2F0ZUZpZWxkLmlzQXV0b0dlbmVyYXRlZCA/IGZpZWxkSW5mby5sYWJlbCA6IGFnZ3JlZ2F0ZUZpZWxkLmFsaWFzKSB8fFxuICAgICAgYWdncmVnYXRlRmllbGQubmFtZTtcbiAgICByZXR1cm4gKGgoXCJkaXZcIiwgeyBjbGFzczogXCJzZWN0aW9uXCIgfSwgaChcImNhbGNpdGUtbGFiZWxcIiwgbnVsbCwgc3RyaW5ncy5maWVsZHMuZmllbGRBbGlhcyksIGgoXCJjYWxjaXRlLWlucHV0XCIsIHsgdHlwZTogXCJ0ZXh0XCIsIHZhbHVlOiBhbGlhcywgc2NhbGU6IFwibVwiLCBsYWJlbDogc3RyaW5ncy5maWVsZHMuZmllbGRBbGlhcywgb25DYWxjaXRlSW5wdXRJbnB1dDogKGV2ZW50KSA9PiB7XG4gICAgICAgIGNvbnN0IG5vZGUgPSBldmVudC50YXJnZXQ7XG4gICAgICAgIGxldCBhbGlhcyA9IG5vZGUudmFsdWU7XG4gICAgICAgIHRoaXMuYmxvY2tOb2RlLmhlYWRpbmcgPSBhbGlhcztcbiAgICAgICAgaWYgKCFhbGlhcykge1xuICAgICAgICAgIC8vIGxldCdzIGdpdmUgdGhlIHVzZXIgdGltZSB0byBmaWxsIGl0IGluO1xuICAgICAgICAgIC8vIGlmIG5vdCB3ZSBkZWZhdWx0IHRvIHNvbWV0aGluZ1xuICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgZmllbGRJbmZvID0gZ2V0UG9wdXBGaWVsZEluZm8obGF5ZXIsIGFnZ3JlZ2F0ZUZpZWxkLm5hbWUpO1xuICAgICAgICAgICAgY29uc3QgY3VyQWxpYXMgPSBhZ2dyZWdhdGVGaWVsZC5pc0F1dG9HZW5lcmF0ZWRcbiAgICAgICAgICAgICAgPyBmaWVsZEluZm8ubGFiZWxcbiAgICAgICAgICAgICAgOiBhZ2dyZWdhdGVGaWVsZC5hbGlhcztcbiAgICAgICAgICAgIGlmICghY3VyQWxpYXMpIHtcbiAgICAgICAgICAgICAgY29uc3QgZmllbGQgPSBnZXRMYXllckZpZWxkKGxheWVyLCBhZ2dyZWdhdGVGaWVsZC5vblN0YXRpc3RpY0ZpZWxkKTtcbiAgICAgICAgICAgICAgYWxpYXMgPSBgJHtmaWVsZC5hbGlhcyB8fCBmaWVsZC5uYW1lfSAke2dldFN0YXRzVHlwZVN0cmluZyhhZ2dyZWdhdGVGaWVsZC5zdGF0aXN0aWNUeXBlLCBzdHJpbmdzKS50b0xvY2FsZUxvd2VyQ2FzZSgpfWA7XG4gICAgICAgICAgICAgIHRoaXMuYmxvY2tOb2RlLmhlYWRpbmcgPSBhbGlhcztcbiAgICAgICAgICAgICAgbm9kZS52YWx1ZSA9IGFsaWFzO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy51cGRhdGVBbGlhcyhhbGlhcyk7XG4gICAgICAgICAgfSwgMjAwMCk7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgdGhpcy51cGRhdGVBbGlhcyhhbGlhcyk7XG4gICAgICAgIH1cbiAgICAgIH0gfSkpKTtcbiAgfVxuICByZW5kZXJGb3JtYXR0aW5nKCkge1xuICAgIGNvbnN0IHsgbGF5ZXIsIGFnZ3JlZ2F0ZUZpZWxkLCBtb2R1bGVzLCBzdHJpbmdzIH0gPSB0aGlzO1xuICAgIGNvbnN0IHsgRmllbGRJbmZvRm9ybWF0IH0gPSBtb2R1bGVzO1xuICAgIGNvbnN0IGZlYXR1cmVSZWR1Y3Rpb24gPSBsYXllci5mZWF0dXJlUmVkdWN0aW9uO1xuICAgIGNvbnN0IHBvcHVwVGVtcGxhdGUgPSBmZWF0dXJlUmVkdWN0aW9uLnBvcHVwVGVtcGxhdGU7XG4gICAgY29uc3QgbGF5ZXJGaWVsZCA9IGdldExheWVyRmllbGQobGF5ZXIsIGFnZ3JlZ2F0ZUZpZWxkLm9uU3RhdGlzdGljRmllbGQpO1xuICAgIGlmICgoIWxheWVyRmllbGQgJiYgYWdncmVnYXRlRmllbGQuc3RhdGlzdGljVHlwZSAhPT0gXCJjb3VudFwiKSB8fFxuICAgICAgKGxheWVyRmllbGQgPT09IG51bGwgfHwgbGF5ZXJGaWVsZCA9PT0gdm9pZCAwID8gdm9pZCAwIDogbGF5ZXJGaWVsZC50eXBlKSA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICAgIGxldCBmaWVsZEluZm8gPSBwb3B1cFRlbXBsYXRlLmZpZWxkSW5mb3MuZmluZCgoZmllbGRJbmZvKSA9PiBmaWVsZEluZm8uZmllbGROYW1lID09PSBhZ2dyZWdhdGVGaWVsZC5uYW1lKTtcbiAgICBmaWVsZEluZm8uZm9ybWF0ID1cbiAgICAgIGZpZWxkSW5mby5mb3JtYXQgfHxcbiAgICAgICAgbmV3IEZpZWxkSW5mb0Zvcm1hdCh7IGRpaml0U2VwYXJhdG9yOiB0cnVlLCBwbGFjZXM6IDAgfSk7XG4gICAgY29uc3QgaXNJbnQgPSAhbGF5ZXJGaWVsZCB8fCBbXCJpbnRlZ2VyXCIsIFwic21hbGwtaW50ZWdlclwiLCBcImJpZy1pbnRlZ2VyXCJdLmluZGV4T2YobGF5ZXJGaWVsZC50eXBlKSA+IC0xO1xuICAgIHJldHVybiAoaChcImRpdlwiLCB7IGNsYXNzOiBcImZvcm1hdFwiIH0sIGgoXCJjYWxjaXRlLWxhYmVsXCIsIHsgc2NhbGU6IFwibFwiIH0sIHN0cmluZ3MuZmllbGRzLmZvcm1hdHRpbmcpLCAhaXNJbnQgJiYgdGhpcy5yZW5kZXJTaWduaWZpY2FudERpZ2l0cyhmaWVsZEluZm8uZm9ybWF0KSwgdGhpcy5yZW5kZXJUaG91c2FuZFNlcGVyYXRvcihmaWVsZEluZm8uZm9ybWF0KSkpO1xuICB9XG4gIHJlbmRlclRob3VzYW5kU2VwZXJhdG9yKGZvcm1hdCkge1xuICAgIGNvbnN0IHsgc3RyaW5ncyB9ID0gdGhpcztcbiAgICByZXR1cm4gKGgoXCJzZWN0aW9uXCIsIG51bGwsIGgoXCJjYWxjaXRlLWxhYmVsXCIsIHsgbGF5b3V0OiBcImlubGluZS1zcGFjZS1iZXR3ZWVuXCIgfSwgc3RyaW5ncy5maWVsZHMuc2hvdzEwMDBTZXBhcmF0b3IsIGgoXCJjYWxjaXRlLXN3aXRjaFwiLCB7IHNjYWxlOiBcInNcIiwgY2hlY2tlZDogZm9ybWF0LmRpZ2l0U2VwYXJhdG9yLCBvbkNhbGNpdGVTd2l0Y2hDaGFuZ2U6IChldmVudCkgPT4ge1xuICAgICAgICBjb25zdCBub2RlID0gZXZlbnQgPT09IG51bGwgfHwgZXZlbnQgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGV2ZW50LnRhcmdldDtcbiAgICAgICAgZm9ybWF0LmRpZ2l0U2VwYXJhdG9yID0gbm9kZS5jaGVja2VkO1xuICAgICAgICB0aGlzLmFyY2dpc0FnZ3JlZ2F0aW9uRmllbGRDaGFuZ2UuZW1pdCgpO1xuICAgICAgfSB9KSkpKTtcbiAgfVxuICByZW5kZXJTaWduaWZpY2FudERpZ2l0cyhmb3JtYXQpIHtcbiAgICBjb25zdCB7IHN0cmluZ3MgfSA9IHRoaXM7XG4gICAgcmV0dXJuIChoKFwic2VjdGlvblwiLCBudWxsLCBoKFwiY2FsY2l0ZS1sYWJlbFwiLCBudWxsLCBzdHJpbmdzLmZpZWxkcy5zaWduaWZpY2FudERpZ2l0cywgaChcImNhbGNpdGUtc2VsZWN0XCIsIHsgbGFiZWw6IHN0cmluZ3MuZmllbGRzLnNpZ25pZmljYW50RGlnaXRzLCBvbkNhbGNpdGVTZWxlY3RDaGFuZ2U6IChldmVudCkgPT4ge1xuICAgICAgICBjb25zdCBub2RlID0gZXZlbnQudGFyZ2V0O1xuICAgICAgICBmb3JtYXQucGxhY2VzID0gTnVtYmVyKG5vZGUuc2VsZWN0ZWRPcHRpb24udmFsdWUpIHx8IDA7XG4gICAgICAgIHRoaXMuYXJjZ2lzQWdncmVnYXRpb25GaWVsZENoYW5nZS5lbWl0KCk7XG4gICAgICB9IH0sIGgoXCJjYWxjaXRlLW9wdGlvblwiLCB7IHZhbHVlOiBcIjBcIiwgc2VsZWN0ZWQ6IGZvcm1hdC5wbGFjZXMgPT09IDAgfSwgc3RyaW5ncy5maWVsZHMuZGVjaW1hbFBsYWNlczApLCBoKFwiY2FsY2l0ZS1vcHRpb25cIiwgeyB2YWx1ZTogXCIxXCIsIHNlbGVjdGVkOiBmb3JtYXQucGxhY2VzID09PSAxIH0sIHN0cmluZ3MuZmllbGRzLmRlY2ltYWxQbGFjZXMxKSwgWzIsIDMsIDQsIDUsIDYsIDcsIDhdLm1hcCgoeCkgPT4gKGgoXCJjYWxjaXRlLW9wdGlvblwiLCB7IHZhbHVlOiB4LnRvU3RyaW5nKCksIHNlbGVjdGVkOiBmb3JtYXQucGxhY2VzID09PSB4IH0sIHN0cmluZ3MuZmllbGRzLmRlY2ltYWxQbGFjZXNOLnJlcGxhY2UoXCIke251bX1cIiwgYCR7eH1gKSkpKSkpKSk7XG4gIH1cbiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgLy9cbiAgLy8gIFByaXZhdGUgbWV0aG9kc1xuICAvL1xuICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICBjbG9zZVBvcG92ZXJzKCkge1xuICAgIGlmICh0aGlzLmFyY2dpc0ZpZWxkUGlja0xpc3QpIHtcbiAgICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQodGhpcy5hcmNnaXNGaWVsZFBpY2tMaXN0KTtcbiAgICAgIHRoaXMuYXJjZ2lzRmllbGRQaWNrTGlzdCA9IG51bGw7XG4gICAgfVxuICB9XG4gIHJlbW92ZUZpZWxkKCkge1xuICAgIGNvbnN0IHsgbGF5ZXIsIGFnZ3JlZ2F0ZUZpZWxkIH0gPSB0aGlzO1xuICAgIGNvbnN0IGZlYXR1cmVSZWR1Y3Rpb24gPSBsYXllci5mZWF0dXJlUmVkdWN0aW9uO1xuICAgIGNvbnN0IHBvcHVwVGVtcGxhdGUgPSBmZWF0dXJlUmVkdWN0aW9uLnBvcHVwVGVtcGxhdGU7XG4gICAgbGV0IGlkeCA9IHBvcHVwVGVtcGxhdGUuZmllbGRJbmZvcy5maW5kSW5kZXgoKGZpZWxkSW5mbykgPT4gZmllbGRJbmZvLmZpZWxkTmFtZSA9PT0gYWdncmVnYXRlRmllbGQubmFtZSk7XG4gICAgaWR4ID49IDAgJiYgcG9wdXBUZW1wbGF0ZS5maWVsZEluZm9zLnNwbGljZShpZHgsIDEpO1xuICAgIGlkeCA9IGZlYXR1cmVSZWR1Y3Rpb24uZmllbGRzLmZpbmRJbmRleCgoYWYgLyogX19lc3JpLkFnZ3JlZ2F0ZUZpZWxkICovKSA9PiBhZi5uYW1lID09PSBhZ2dyZWdhdGVGaWVsZC5uYW1lKTtcbiAgICBmZWF0dXJlUmVkdWN0aW9uLmZpZWxkcy5zcGxpY2UoaWR4LCAxKTtcbiAgICB0aGlzLmFyY2dpc0FnZ3JlZ2F0aW9uRmllbGRDaGFuZ2UuZW1pdCgpO1xuICB9XG4gIGNyZWF0ZVBpY2tMaXN0RmllbGRzKCkge1xuICAgIGNvbnN0IHsgbGF5ZXIsIGFnZ3JlZ2F0ZUZpZWxkIH0gPSB0aGlzO1xuICAgIGNvbnN0IHsgZmllbGRzIH0gPSBsYXllcjtcbiAgICBjb25zdCBsYXllckZpZWxkcyA9IGZpZWxkcy5maWx0ZXIoKGZpZWxkKSA9PiBbXCJzbWFsbC1pbnRlZ2VyXCIsIFwiYmlnLWludGVnZXJcIiwgXCJpbnRlZ2VyXCIsIFwic2luZ2xlXCIsIFwiZG91YmxlXCIsIFwibG9uZ1wiLCBcIm51bWJlclwiLCBcInN0cmluZ1wiXS5pbmRleE9mKGZpZWxkLnR5cGUpID4gLTEpO1xuICAgIHJldHVybiBsYXllckZpZWxkc1xuICAgICAgLmZpbHRlcigoZmllbGQpID0+IGFnZ3JlZ2F0ZUZpZWxkLm9uU3RhdGlzdGljRmllbGQgPT09IGZpZWxkLm5hbWUgfHwgIWlzRmllbGREb25lKGxheWVyLCBmaWVsZC5uYW1lKSlcbiAgICAgIC5tYXAoKGZpZWxkKSA9PiB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBuYW1lOiBmaWVsZC5uYW1lLFxuICAgICAgICBhbGlhczogZmllbGQuYWxpYXMsXG4gICAgICAgIHR5cGU6IGZpZWxkLnR5cGVcbiAgICAgIH07XG4gICAgfSk7XG4gIH1cbiAgcmVwbGFjZVBvcHVwRmllbGQob2xkTmFtZSkge1xuICAgIC8vIGFmdGVyIGNoYW5naW5nIGZpZWxkIG9yIHN0YXRzIHR5cGVzXG4gICAgLy8gbm90IGZvciBhdXRvR2VuZXJhdGVkIGZpZWxkc1xuICAgIGNvbnN0IHsgbGF5ZXIsIGFnZ3JlZ2F0ZUZpZWxkLCBtb2R1bGVzIH0gPSB0aGlzO1xuICAgIGNvbnN0IHsgRmllbGRJbmZvIH0gPSBtb2R1bGVzO1xuICAgIGNvbnN0IGZlYXR1cmVSZWR1Y3Rpb24gPSBsYXllci5mZWF0dXJlUmVkdWN0aW9uO1xuICAgIGNvbnN0IHsgcG9wdXBUZW1wbGF0ZSB9ID0gZmVhdHVyZVJlZHVjdGlvbjtcbiAgICBwb3B1cFRlbXBsYXRlLmZpZWxkSW5mb3MgPSBwb3B1cFRlbXBsYXRlLmZpZWxkSW5mb3MgfHwgW107XG4gICAgY29uc3QgaWR4UG9wdXAgPSBwb3B1cFRlbXBsYXRlLmZpZWxkSW5mb3MuZmluZEluZGV4KChmaWVsZEluZm8pID0+IGZpZWxkSW5mby5maWVsZE5hbWUgPT09IG9sZE5hbWUpO1xuICAgIGNvbnN0IGZpZWxkID0gZ2V0TGF5ZXJGaWVsZChsYXllciwgYWdncmVnYXRlRmllbGQub25TdGF0aXN0aWNGaWVsZCk7XG4gICAgcG9wdXBUZW1wbGF0ZS5maWVsZEluZm9zLnNwbGljZShpZHhQb3B1cCwgMSwgbmV3IEZpZWxkSW5mbyh7XG4gICAgICBmaWVsZE5hbWU6IGFnZ3JlZ2F0ZUZpZWxkLm5hbWUsXG4gICAgICBsYWJlbDogYWdncmVnYXRlRmllbGQuYWxpYXMsXG4gICAgICBpc0VkaXRhYmxlOiBmYWxzZSxcbiAgICAgIHZpc2libGU6IHRydWUsXG4gICAgICBmb3JtYXQ6IGZpZWxkLnR5cGUgPT09IFwic3RyaW5nXCJcbiAgICAgICAgPyB1bmRlZmluZWRcbiAgICAgICAgOiBbXCJzbWFsbC1pbnRlZ2VyXCIsIFwiYmlnLWludGVnZXJcIiwgXCJpbnRlZ2VyXCIsIFwibG9uZ1wiLCBcIm51bWJlclwiXS5pbmRleE9mKGZpZWxkLnR5cGUpID4gLTFcbiAgICAgICAgICA/IHtcbiAgICAgICAgICAgIGRpZ2l0U2VwYXJhdG9yOiB0cnVlXG4gICAgICAgICAgfVxuICAgICAgICAgIDoge1xuICAgICAgICAgICAgZGlnaXRTZXBhcmF0b3I6IHRydWUsXG4gICAgICAgICAgICBwbGFjZXM6IDFcbiAgICAgICAgICB9XG4gICAgfSkpO1xuICB9XG4gIHVwZGF0ZUFsaWFzKGFsaWFzKSB7XG4gICAgY29uc3QgeyBsYXllciwgYWdncmVnYXRlRmllbGQgfSA9IHRoaXM7XG4gICAgY29uc3QgZmllbGRJbmZvID0gZ2V0UG9wdXBGaWVsZEluZm8obGF5ZXIsIGFnZ3JlZ2F0ZUZpZWxkLm5hbWUpO1xuICAgIGlmIChhZ2dyZWdhdGVGaWVsZC5pc0F1dG9HZW5lcmF0ZWQpIHtcbiAgICAgIC8vIGZlYXR1cmVSZWR1Y3Rpb24uY2xvbmUoKSB3aWxsIHJlbW92ZSB0aGUgYWxpYXMgZnJvbSB0aGUgYWdncmVnYXRpb24gZmllbGRcbiAgICAgIGZpZWxkSW5mby5sYWJlbCA9IGFsaWFzO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgIGFnZ3JlZ2F0ZUZpZWxkLmFsaWFzID0gYWxpYXM7XG4gICAgfVxuICAgIHRoaXMudXBkYXRlUG9wdXBBbGlhcygpO1xuICAgIHRoaXMuYXJjZ2lzQWdncmVnYXRpb25GaWVsZENoYW5nZS5lbWl0KCk7XG4gIH1cbiAgdXBkYXRlUG9wdXBBbGlhcygpIHtcbiAgICBjb25zdCB7IGxheWVyLCBhZ2dyZWdhdGVGaWVsZCB9ID0gdGhpcztcbiAgICBjb25zdCBmZWF0dXJlUmVkdWN0aW9uID0gbGF5ZXIuZmVhdHVyZVJlZHVjdGlvbjtcbiAgICBjb25zdCBmaWVsZEluZm8gPSBnZXRQb3B1cEZpZWxkSW5mbyhsYXllciwgYWdncmVnYXRlRmllbGQubmFtZSk7XG4gICAgY29uc3QgYWxpYXMgPSBhZ2dyZWdhdGVGaWVsZC5pc0F1dG9HZW5lcmF0ZWQgPyBmaWVsZEluZm8ubGFiZWwgOiBhZ2dyZWdhdGVGaWVsZC5hbGlhcztcbiAgICAvLyBtYWluIGZpZWxkSW5mb3NcbiAgICBpZiAoIWFnZ3JlZ2F0ZUZpZWxkLmlzQXV0b0dlbmVyYXRlZCkge1xuICAgICAgZmllbGRJbmZvLmxhYmVsID0gYWxpYXM7XG4gICAgfVxuICAgIC8vIHNlYXJjaCBmaWVsZEluZm9zIHVuZGVyIGNvbnRlbnRcbiAgICBpZiAoQXJyYXkuaXNBcnJheShmZWF0dXJlUmVkdWN0aW9uLnBvcHVwVGVtcGxhdGUuY29udGVudCkgJiZcbiAgICAgIGZlYXR1cmVSZWR1Y3Rpb24ucG9wdXBUZW1wbGF0ZS5jb250ZW50Lmxlbmd0aCkge1xuICAgICAgZmVhdHVyZVJlZHVjdGlvbi5wb3B1cFRlbXBsYXRlLmNvbnRlbnQuZm9yRWFjaCgoY29udGVudCkgPT4ge1xuICAgICAgICBpZiAoY29udGVudC50eXBlID09PSBcImZpZWxkc1wiICYmIGNvbnRlbnQuZmllbGRJbmZvcykge1xuICAgICAgICAgIGNvbnN0IGZpZWxkSW5mbyA9IGNvbnRlbnQuZmllbGRJbmZvcy5maW5kKChmaWVsZEluZm8pID0+IGZpZWxkSW5mby5maWVsZE5hbWUgPT09IGFnZ3JlZ2F0ZUZpZWxkLm5hbWUpO1xuICAgICAgICAgIGlmIChmaWVsZEluZm8pIHtcbiAgICAgICAgICAgIGZpZWxkSW5mby5sYWJlbCA9IGFsaWFzO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuICB9XG4gIGdldCBob3N0RWxlbWVudCgpIHsgcmV0dXJuIGdldEVsZW1lbnQodGhpcyk7IH1cbn07XG5BcmNnaXNBZ2dyZWdhdGlvbkZpZWxkLnN0eWxlID0gYXJjZ2lzQWdncmVnYXRpb25GaWVsZENzcztcblxuY29uc3QgYXJjZ2lzQWdncmVnYXRpb25GaWVsZHNDc3MgPSBcIi5maWVsZHMuc2MtYXJjZ2lzLWFnZ3JlZ2F0aW9uLWZpZWxkc3tiYWNrZ3JvdW5kLWNvbG9yOndoaXRlfS5maWVsZC1pY29uLnNjLWFyY2dpcy1hZ2dyZWdhdGlvbi1maWVsZHN7cGFkZGluZzowIHZhcigtLWFyY2dpcy1hcHAtY2FwLXNwYWNpbmcpO2Rpc3BsYXk6ZmxleDthbGlnbi1pdGVtczpjZW50ZXJ9XCI7XG5cbmNvbnN0IEFyY2dpc0FnZ3JlZ2F0aW9uRmllbGRzID0gY2xhc3Mge1xuICBjb25zdHJ1Y3Rvcihob3N0UmVmKSB7XG4gICAgcmVnaXN0ZXJJbnN0YW5jZSh0aGlzLCBob3N0UmVmKTtcbiAgICB0aGlzLmFyY2dpc0FnZ3JlZ2F0aW9uRmllbGRzQ2hhbmdlID0gY3JlYXRlRXZlbnQodGhpcywgXCJhcmNnaXNBZ2dyZWdhdGlvbkZpZWxkc0NoYW5nZVwiLCA3KTtcbiAgICB0aGlzLmFyY2dpc0FnZ3JlZ2F0aW9uRmllbGRzQ2xvc2UgPSBjcmVhdGVFdmVudCh0aGlzLCBcImFyY2dpc0FnZ3JlZ2F0aW9uRmllbGRzQ2xvc2VcIiwgNyk7XG4gICAgdGhpcy5hcmNnaXNBZ2dyZWdhdGlvbkZpZWxkc0JhY2tDbGljayA9IGNyZWF0ZUV2ZW50KHRoaXMsIFwiYXJjZ2lzQWdncmVnYXRpb25GaWVsZHNCYWNrQ2xpY2tcIiwgNyk7XG4gICAgdGhpcy5hbGxGaWVsZHNBZGRlZCA9IGZhbHNlO1xuICAgIHRoaXMubWFwVmlldyA9IHVuZGVmaW5lZDtcbiAgICB0aGlzLmxheWVyID0gdW5kZWZpbmVkO1xuICAgIHRoaXMuZmxvd05vZGUgPSB1bmRlZmluZWQ7XG4gICAgdGhpcy5zdHJpbmdzID0gdW5kZWZpbmVkO1xuICAgIHRoaXMuY3VycmVudExhbmd1YWdlID0gdW5kZWZpbmVkO1xuICAgIHRoaXMuaGlkZUxheWVyVGl0bGUgPSBmYWxzZTtcbiAgfVxuICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIC8vXG4gIC8vICBwdWJsaWMgY2FsbHNcbiAgLy9cbiAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAvLyBQdWJsaWMgTWV0aG9kc1xuICBhc3luYyBkb25lKCkge1xuICAgIHRoaXMuY2xvc2VQb3BvdmVycygpO1xuICB9XG4gIGFzeW5jIHNldEZvY3VzKCkge1xuICAgIHRoaXMuZmxvd0l0ZW1Ob2RlLnNldEZvY3VzKCk7XG4gIH1cbiAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAvL1xuICAvLyAgTGlmZWN5Y2xlXG4gIC8vXG4gIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgYXN5bmMgY29tcG9uZW50V2lsbExvYWQoKSB7XG4gICAgY29uc3QgW0FnZ3JlZ2F0ZUZpZWxkLCBGaWVsZEluZm9dID0gYXdhaXQgbG9hZE1vZHVsZXMoW1xuICAgICAgXCJlc3JpL2xheWVycy9zdXBwb3J0L0FnZ3JlZ2F0ZUZpZWxkXCIsXG4gICAgICBcImVzcmkvcG9wdXAvRmllbGRJbmZvXCJcbiAgICBdKTtcbiAgICB0aGlzLm1vZHVsZXMgPSB7XG4gICAgICBBZ2dyZWdhdGVGaWVsZCxcbiAgICAgIEZpZWxkSW5mb1xuICAgIH07XG4gIH1cbiAgY29tcG9uZW50RGlkTG9hZCgpIHtcbiAgICBzZXRUaW1lb3V0KCgpID0+IHJlcXVlc3RBbmltYXRpb25GcmFtZSgoKSA9PiB0aGlzLmZsb3dJdGVtTm9kZS5zZXRGb2N1cygpKSwgMjAwKTtcbiAgfVxuICBkaXNjb25uZWN0ZWRDYWxsYmFjaygpIHtcbiAgICB0aGlzLmNsb3NlUG9wb3ZlcnMoKTtcbiAgfVxuICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAvL1xuICAvLyAgUmVuZGVyIE1ldGhvZHNcbiAgLy9cbiAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICByZW5kZXIoKSB7XG4gICAgLypcbiAgICB7XG4gICAgICBuYW1lOiBcImNsdXN0ZXJfY291bnRcIixcbiAgICAgIGFsaWFzOiBcImFnZ3JlZ2F0ZUNvdW50XCIsXG4gICAgICB0eXBlOiBcImVzcmlGaWVsZFR5cGVVbnNpZ25lZEludGVnZXJcIiwgLy8gSWYgdGhpcyBpcyBhIHZhbGlkIHR5cGUuLi5cbiAgICAgIHN0YXRpc3RpY1R5cGU6IFwiY291bnRcIixcbiAgICAgIGlzSW5mZXJyZWQ6IHRydWUsXG4gICAgfVxuICAgICovXG4gICAgY29uc3QgeyBsYXllciwgc3RyaW5ncywgaGlkZUxheWVyVGl0bGUgfSA9IHRoaXM7XG4gICAgY29uc3QgZmVhdHVyZVJlZHVjdGlvbiA9IGxheWVyLmZlYXR1cmVSZWR1Y3Rpb247IC8vX19lc3JpLkZlYXR1cmVSZWR1Y3Rpb25DbHVzdGVyO1xuICAgIGNvbnN0IHN0YXRzRmllbGRzID0gZmVhdHVyZVJlZHVjdGlvbi5maWVsZHM7XG4gICAgcmV0dXJuIChoKEhvc3QsIHsgY2xhc3M6IFwiY2FsY2l0ZS1tYXRjaC1oZWlnaHRcIiB9LCBoKFwiY2FsY2l0ZS1mbG93LWl0ZW1cIiwgeyBoZWFkaW5nOiBzdHJpbmdzLmZpZWxkcy5maWVsZHMsIGRlc2NyaXB0aW9uOiAhaGlkZUxheWVyVGl0bGUgPyBsYXllci50aXRsZSA6IHVuZGVmaW5lZCwgb25DYWxjaXRlRmxvd0l0ZW1CYWNrOiAoKSA9PiB7XG4gICAgICAgIHRoaXMuYXJjZ2lzQWdncmVnYXRpb25GaWVsZHNCYWNrQ2xpY2suZW1pdCgpO1xuICAgICAgICB0aGlzLmNsb3NlUG9wb3ZlcnMoKTtcbiAgICAgIH0sIHJlZjogKG5vZGUpID0+ICh0aGlzLmZsb3dJdGVtTm9kZSA9IG5vZGUpIH0sIHRoaXMucmVuZGVyVGlwKHN0YXRzRmllbGRzKSwgaChcImRpdlwiLCB7IGNsYXNzOiBcImZpZWxkc1wiIH0sIHN0YXRzRmllbGRzID09PSBudWxsIHx8IHN0YXRzRmllbGRzID09PSB2b2lkIDAgPyB2b2lkIDAgOiBzdGF0c0ZpZWxkcy5tYXAoKGFnZ3JlZ2F0ZUZpZWxkKSA9PiB0aGlzLnJlbmRlclN0YXRzRmllbGQoYWdncmVnYXRlRmllbGQpKSksIHRoaXMucmVuZGVyQWRkRmllbGQoKSkpKTtcbiAgfVxuICByZW5kZXJUaXAoc3RhdHNGaWVsZHMpIHtcbiAgICBjb25zdCB7IHN0cmluZ3MgfSA9IHRoaXM7XG4gICAgaWYgKHN0YXRzRmllbGRzID09PSBudWxsIHx8IHN0YXRzRmllbGRzID09PSB2b2lkIDAgPyB2b2lkIDAgOiBzdGF0c0ZpZWxkcy5sZW5ndGgpIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgICByZXR1cm4gKGgoXCJjYWxjaXRlLXRpcFwiLCB7IGhlYWRpbmc6IHN0cmluZ3MuZmllbGRzLm1zZ1RpdGxlLCBjbG9zZURpc2FibGVkOiB0cnVlIH0sIHN0cmluZ3MuZmllbGRzLm1zZykpO1xuICB9XG4gIHJlbmRlclN0YXRzRmllbGQoYWdncmVnYXRlRmllbGQpIHtcbiAgICBjb25zdCB7IGxheWVyLCBtYXBWaWV3LCBzZWxlY3RlZEZpZWxkTmFtZSwgbW9kdWxlcywgc3RyaW5ncyB9ID0gdGhpcztcbiAgICAvLyBuZWVkIHRvIGhhdmUgdGhlIGZpZWxkIGluIHRoZSBwb3B1cCB0b29cbiAgICBhZGRQb3B1cEZpZWxkKGFnZ3JlZ2F0ZUZpZWxkLCBsYXllciwgbW9kdWxlcyk7XG4gICAgcmV0dXJuIChoKFwiYXJjZ2lzLWFnZ3JlZ2F0aW9uLWZpZWxkXCIsIHsgbGF5ZXI6IGxheWVyLCBtYXBWaWV3OiBtYXBWaWV3LCBzdHJpbmdzOiBzdHJpbmdzLCBhZ2dyZWdhdGVGaWVsZDogYWdncmVnYXRlRmllbGQsIG9wZW46IHNlbGVjdGVkRmllbGROYW1lID09PSBhZ2dyZWdhdGVGaWVsZC5uYW1lLCBvbkFyY2dpc0FnZ3JlZ2F0aW9uRmllbGRDaGFuZ2U6ICgpID0+IHtcbiAgICAgICAgdGhpcy5zZWxlY3RlZEZpZWxkTmFtZSA9IGFnZ3JlZ2F0ZUZpZWxkLm5hbWU7XG4gICAgICAgIHRoaXMuYXJjZ2lzQWdncmVnYXRpb25GaWVsZHNDaGFuZ2UuZW1pdCgpO1xuICAgICAgICBmb3JjZVVwZGF0ZSh0aGlzLmhvc3RFbGVtZW50KTtcbiAgICAgIH0gfSkpO1xuICB9XG4gIHJlbmRlckFkZEZpZWxkKCkge1xuICAgIGNvbnN0IHsgYWxsRmllbGRzQWRkZWQsIHN0cmluZ3MgfSA9IHRoaXM7XG4gICAgaWYgKGFsbEZpZWxkc0FkZGVkKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gICAgcmV0dXJuIChoKFwiY2FsY2l0ZS1mYWJcIiwgeyBzbG90OiBcImZhYlwiLCBhcHBlYXJhbmNlOiBcIm91dGxpbmUtZmlsbFwiLCBraW5kOiBcIm5ldXRyYWxcIiwgc2NhbGU6IFwic1wiLCBpY29uOiBcInBsdXNcIiwgdGV4dEVuYWJsZWQ6IHRydWUsIHRleHQ6IHN0cmluZ3MuZmllbGRzLmFkZEZpZWxkLCBvbkNsaWNrOiAoKSA9PiB0aGlzLmFkZFN0YXRzRmllbGQoKSwgcmVmOiAobm9kZSkgPT4gKHRoaXMuZmFiTm9kZSA9IG5vZGUpIH0pKTtcbiAgfVxuICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAvL1xuICAvLyAgUHJpdmF0ZSBtZXRob2RzXG4gIC8vXG4gIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIGNsb3NlUG9wb3ZlcnMoKSB7XG4gICAgaWYgKHRoaXMuYXR0cmlidXRlRm9ybWF0dGVyKSB7XG4gICAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKHRoaXMuYXR0cmlidXRlRm9ybWF0dGVyKTtcbiAgICAgIHRoaXMuYXR0cmlidXRlRm9ybWF0dGVyID0gbnVsbDtcbiAgICB9XG4gIH1cbiAgYWRkU3RhdHNGaWVsZCgpIHtcbiAgICBjb25zdCB7IGxheWVyLCBzdHJpbmdzLCBtb2R1bGVzIH0gPSB0aGlzO1xuICAgIGNvbnN0IHsgQWdncmVnYXRlRmllbGQgfSA9IG1vZHVsZXM7XG4gICAgY29uc3QgZmllbGRzID0gZ2V0TGF5ZXJOdW1iZXJPclN0cmluZ0ZpZWxkcyhsYXllcik7XG4gICAgbGV0IGlkeEZpZWxkID0gMDtcbiAgICBsZXQgdHlwZXMgPSBnZXRTdGF0c1R5cGVzKGZpZWxkc1tpZHhGaWVsZF0pO1xuICAgIGxldCBpZHhUeXBlID0gMDtcbiAgICBsZXQgaGFzQWxyZWFkeSA9IGhhc0ZpZWxkQWxyZWFkeShsYXllciwgZmllbGRzW2lkeEZpZWxkXS5uYW1lLCB0eXBlc1tpZHhUeXBlXSk7XG4gICAgd2hpbGUgKGlkeEZpZWxkIDwgZmllbGRzLmxlbmd0aCAmJiBoYXNBbHJlYWR5KSB7XG4gICAgICAvLyBuZXh0IHR5cGVzXG4gICAgICB3aGlsZSAoaWR4VHlwZSA8IHR5cGVzLmxlbmd0aCAmJiBoYXNBbHJlYWR5KSB7XG4gICAgICAgIGlkeFR5cGUrKztcbiAgICAgICAgaWYgKGlkeFR5cGUgPCB0eXBlcy5sZW5ndGgpIHtcbiAgICAgICAgICBoYXNBbHJlYWR5ID0gaGFzRmllbGRBbHJlYWR5KGxheWVyLCBmaWVsZHNbaWR4RmllbGRdLm5hbWUsIHR5cGVzW2lkeFR5cGVdKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgaWYgKGhhc0FscmVhZHkpIHtcbiAgICAgICAgLy8gbmV4dCBmaWVsZFxuICAgICAgICBpZHhGaWVsZCsrO1xuICAgICAgICBpZiAoaWR4RmllbGQgPCBmaWVsZHMubGVuZ3RoKSB7XG4gICAgICAgICAgdHlwZXMgPSBnZXRTdGF0c1R5cGVzKGZpZWxkc1tpZHhGaWVsZF0pO1xuICAgICAgICAgIGlkeFR5cGUgPSAwO1xuICAgICAgICAgIGhhc0FscmVhZHkgPSBoYXNGaWVsZEFscmVhZHkobGF5ZXIsIGZpZWxkc1tpZHhGaWVsZF0ubmFtZSwgdHlwZXNbaWR4VHlwZV0pO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIGlmIChoYXNBbHJlYWR5KSB7XG4gICAgICB0aGlzLmFsbEZpZWxkc0FkZGVkID0gdHJ1ZTtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICBjb25zdCBmaWVsZCA9IGZpZWxkc1tpZHhGaWVsZF07XG4gICAgICBjb25zdCB0eXBlID0gdHlwZXNbaWR4VHlwZV07XG4gICAgICBjb25zdCBhZ2dyZWdhdGVGaWVsZCAvKiBfX2VzcmkuQWdncmVnYXRlRmllbGQgKi8gPSBuZXcgQWdncmVnYXRlRmllbGQoe1xuICAgICAgICBuYW1lOiBgJHtmaWVsZC5uYW1lfV8ke3R5cGV9YCxcbiAgICAgICAgb25TdGF0aXN0aWNGaWVsZDogZmllbGQubmFtZSxcbiAgICAgICAgYWxpYXM6IGAke2ZpZWxkLmFsaWFzIHx8IGZpZWxkLm5hbWV9ICR7Z2V0U3RhdHNUeXBlU3RyaW5nKHR5cGUsIHN0cmluZ3MpLnRvTG9jYWxlTG93ZXJDYXNlKCl9YCxcbiAgICAgICAgc3RhdGlzdGljVHlwZTogdHlwZSxcbiAgICAgICAgdmlzaWJsZTogdHJ1ZVxuICAgICAgfSk7XG4gICAgICBjb25zdCBmZWF0dXJlUmVkdWN0aW9uID0gbGF5ZXIuZmVhdHVyZVJlZHVjdGlvbjsgLy9fX2VzcmkuRmVhdHVyZVJlZHVjdGlvbkNsdXN0ZXI7XG4gICAgICBmZWF0dXJlUmVkdWN0aW9uLmZpZWxkcyA9IGZlYXR1cmVSZWR1Y3Rpb24uZmllbGRzIHx8IFtdO1xuICAgICAgZmVhdHVyZVJlZHVjdGlvbi5maWVsZHMucHVzaChhZ2dyZWdhdGVGaWVsZCk7XG4gICAgICBhZGRQb3B1cEZpZWxkKGFnZ3JlZ2F0ZUZpZWxkLCBsYXllciwgbW9kdWxlcyk7XG4gICAgICB0aGlzLnNlbGVjdGVkRmllbGROYW1lID0gYWdncmVnYXRlRmllbGQubmFtZTtcbiAgICB9XG4gICAgZm9yY2VVcGRhdGUodGhpcy5ob3N0RWxlbWVudCk7XG4gIH1cbiAgZ2V0IGhvc3RFbGVtZW50KCkgeyByZXR1cm4gZ2V0RWxlbWVudCh0aGlzKTsgfVxufTtcbkFyY2dpc0FnZ3JlZ2F0aW9uRmllbGRzLnN0eWxlID0gYXJjZ2lzQWdncmVnYXRpb25GaWVsZHNDc3M7XG5cbmNvbnN0IGFyY2dpc0FnZ3JlZ2F0aW9uSW5mb1BvcG92ZXJDc3MgPSBcIi5pbmZve3BhZGRpbmc6MTBweDtiYWNrZ3JvdW5kLWNvbG9yOndoaXRlfS5pbmZvLXBvcG92ZXJ7bWF4LXdpZHRoOjMyMHB4fS5pbmZvLWhlbHB7cGFkZGluZy10b3A6MTBweDtqdXN0aWZ5LWNvbnRlbnQ6ZmxleC1lbmQ7ZGlzcGxheTpmbGV4fS5pbmZvLWhlbHAtYnV0dG9ue2Rpc3BsYXk6ZmxleDtmbGV4LWZsb3c6cm93LXJldmVyc2V9XCI7XG5cbmNvbnN0IEFyY2dpc0FnZ3JlZ2F0aW9uSW5mb1BvcG92ZXIgPSBjbGFzcyB7XG4gIGNvbnN0cnVjdG9yKGhvc3RSZWYpIHtcbiAgICByZWdpc3Rlckluc3RhbmNlKHRoaXMsIGhvc3RSZWYpO1xuICAgIHRoaXMuYXJjZ2lzQWdncmVnYXRpb25JbmZvUG9wb3ZlckNsb3NlID0gY3JlYXRlRXZlbnQodGhpcywgXCJhcmNnaXNBZ2dyZWdhdGlvbkluZm9Qb3BvdmVyQ2xvc2VcIiwgNyk7XG4gICAgdGhpcy5hcmNnaXNBZ2dyZWdhdGlvbkluZm9Qb3BvdmVyRGlzY29ubmVjdGVkID0gY3JlYXRlRXZlbnQodGhpcywgXCJhcmNnaXNBZ2dyZWdhdGlvbkluZm9Qb3BvdmVyRGlzY29ubmVjdGVkXCIsIDcpO1xuICAgIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICAvL1xuICAgIC8vICBQcml2YXRlIFByb3BlcnRpZXNcbiAgICAvL1xuICAgIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICB0aGlzLmRvY3VtZW50VGFiSGFuZGxlciA9IHVuZGVmaW5lZDtcbiAgICB0aGlzLmRvY3VtZW50Q2xpY2tIYW5kbGVyID0gdW5kZWZpbmVkO1xuICAgIHRoaXMucGFuZWxTY3JvbGxIYW5kbGVyID0gdW5kZWZpbmVkO1xuICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgLy9cbiAgICAvLyAgUHJpdmF0ZSBtZXRob2RzXG4gICAgLy9cbiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAgIHRoaXMub25PcGVuID0gKCkgPT4ge1xuICAgICAgc2V0VGltZW91dCgoKSA9PiByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKCkgPT4geyB2YXIgX2E7IHJldHVybiAoX2EgPSB0aGlzLnBhbmVsTm9kZSkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLnNldEZvY3VzKCk7IH0pLCAxKTtcbiAgICB9O1xuICAgIHRoaXMucHJvcHMgPSB1bmRlZmluZWQ7XG4gICAgdGhpcy5yZWZlcmVuY2VFbGVtZW50ID0gdW5kZWZpbmVkO1xuICAgIHRoaXMub3BlbiA9IGZhbHNlO1xuICB9XG4gIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgLy9cbiAgLy8gIHB1YmxpYyBjYWxsc1xuICAvL1xuICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIGFzeW5jIHJlcG9zaXRpb24oKSB7XG4gICAgdmFyIF9hO1xuICAgIChfYSA9IHRoaXMucG9wb3Zlck5vZGUpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5yZXBvc2l0aW9uKCk7XG4gIH1cbiAgYXN5bmMgc2V0Rm9jdXMoKSB7XG4gICAgdmFyIF9hO1xuICAgIChfYSA9IHRoaXMucGFuZWxOb2RlKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2Euc2V0Rm9jdXMoKTtcbiAgfVxuICBhc3luYyBzZXRPcGVuKG9wZW4pIHtcbiAgICB2YXIgX2E7XG4gICAgaWYgKHRoaXMucG9wb3Zlck5vZGUpIHtcbiAgICAgIHRoaXMucG9wb3Zlck5vZGUub3BlbiA9IG9wZW47XG4gICAgICBpZiAob3Blbikge1xuICAgICAgICAoX2EgPSB0aGlzLnBhbmVsTm9kZSkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLnNldEZvY3VzKCk7XG4gICAgICAgIHRoaXMucG9wb3Zlck5vZGUucmVwb3NpdGlvbigpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIC8vXG4gIC8vICBMaWZlY3ljbGVcbiAgLy9cbiAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICBkaXNjb25uZWN0ZWRDYWxsYmFjaygpIHtcbiAgICAvLyBpbiBjYXNlIHBvcG92ZXIgZ290IHJlbW92ZWQgYnkganVzdCByZW1vdmluZyBub2RlIGZyb20gRE9NXG4gICAgdGhpcy5hcmNnaXNBZ2dyZWdhdGlvbkluZm9Qb3BvdmVyRGlzY29ubmVjdGVkLmVtaXQoKTtcbiAgfVxuICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAvL1xuICAvLyAgUmVuZGVyIE1ldGhvZHNcbiAgLy9cbiAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICByZW5kZXIoKSB7XG4gICAgY29uc3QgeyBwcm9wcywgcmVmZXJlbmNlRWxlbWVudCwgb3BlbiB9ID0gdGhpcztcbiAgICBjb25zdCB7IGNvbmZpZywgdGl0bGUsIG1vcmVJbmZvLCBoZWxwSWQsIHN0cmluZ3MgfSA9IHByb3BzO1xuICAgIGNvbnN0IHsgaGVscEJhc2UsIGhlbHBNYXAgfSA9IGNvbmZpZztcbiAgICBjb25zdCBoZWFkZXIgPSBzdHJpbmdzLnRpbGUuaW5mby50aXRsZS5yZXBsYWNlKFwiJHt0aXRsZX1cIiwgdGl0bGUpO1xuICAgIHJldHVybiAoaChIb3N0LCB7IGNsYXNzOiBcImpzLWFwcC1mbHlvdXQgYXJjZ2lzLWFnZ3JlZ2F0aW9uLXBvcG92ZXJcIiB9LCBoKFwiY2FsY2l0ZS1wb3BvdmVyXCIsIHsgb3Blbjogb3BlbiwgcGxhY2VtZW50OiBcImF1dG9cIiwgb2Zmc2V0U2tpZGRpbmc6IDUsIGxhYmVsOiBcIlwiLCByZWZlcmVuY2VFbGVtZW50OiByZWZlcmVuY2VFbGVtZW50LCBjbGFzczogXCJpbmZvLXBvcG92ZXJcIiwgb25DYWxjaXRlUG9wb3Zlck9wZW46IHRoaXMub25PcGVuLCByZWY6IChub2RlKSA9PiAodGhpcy5wb3BvdmVyTm9kZSA9IG5vZGUpIH0sIGgoXCJjYWxjaXRlLXBhbmVsXCIsIHsgaGVhZGluZzogaGVhZGVyLCBjbG9zYWJsZTogdHJ1ZSwgcmVmOiAobm9kZSkgPT4gKHRoaXMucGFuZWxOb2RlID0gbm9kZSksIG9uQ2FsY2l0ZVBhbmVsQ2xvc2U6ICgpID0+IHtcbiAgICAgICAgdGhpcy5hcmNnaXNBZ2dyZWdhdGlvbkluZm9Qb3BvdmVyQ2xvc2UuZW1pdCgpO1xuICAgICAgICAvLyBmb2N1cyBvbiBpbmZvIGljb247IHdhaXQgc28gZW50ZXIga2V5IGRvZXNuJ3QgcmUtb3BlbiBpdFxuICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHJlZmVyZW5jZUVsZW1lbnQucGFyZW50RWxlbWVudC5mb2N1cygpLCAzMDApO1xuICAgICAgfSB9LCBoKFwiZGl2XCIsIHsgY2xhc3M6IFwiaW5mb1wiIH0sIGgoXCJkaXZcIiwgbnVsbCwgbW9yZUluZm8pLCBoZWxwSWQgJiYgaGVscE1hcCA/IChoKFwiZGl2XCIsIHsgY2xhc3M6IFwiaW5mby1oZWxwXCIgfSwgaChcImNhbGNpdGUtYnV0dG9uXCIsIHsgYXBwZWFyYW5jZTogXCJzb2xpZFwiLCBsYWJlbDogc3RyaW5ncy50aWxlLmluZm8ubGVhcm5Nb3JlLCBjbGFzczogXCJpbmZvLWhlbHAtYnV0dG9uXCIsIHNsb3Q6IFwiZm9vdGVyXCIsIG9uQ2xpY2s6ICgpID0+IHtcbiAgICAgICAgd2luZG93Lm9wZW4oYCR7aGVscEJhc2V9JHtoZWxwTWFwW2hlbHBJZF19YCwgXCJfYmxhbmtcIik7XG4gICAgICB9IH0sIHN0cmluZ3MudGlsZS5pbmZvLmxlYXJuTW9yZSkpKSA6IG51bGwpKSkpKTtcbiAgfVxuICBnZXQgaG9zdEVsZW1lbnQoKSB7IHJldHVybiBnZXRFbGVtZW50KHRoaXMpOyB9XG59O1xuQXJjZ2lzQWdncmVnYXRpb25JbmZvUG9wb3Zlci5zdHlsZSA9IGFyY2dpc0FnZ3JlZ2F0aW9uSW5mb1BvcG92ZXJDc3M7XG5cbmNvbnN0IGFyY2dpc0FnZ3JlZ2F0aW9uU3ltYm9sU3R5bGVyUG9wb3ZlckNzcyA9IFwiLnBvcG92ZXJ7ei1pbmRleDoxMDB9LnN5bWJvbC1zdHlsZXItZGl2e3dpZHRoOjMyOHB4O2hlaWdodDoxMDAlO292ZXJmbG93LXk6YXV0bztvdmVyZmxvdy14OmhpZGRlbn1hcmNnaXMtc3ltYm9sLXN0eWxlcnttYXgtaGVpZ2h0OmNhbGMoOTB2aCAtIDEwMHB4KTt9XCI7XG5cbmNvbnN0IEFyY2dpc0FnZ3JlZ2F0aW9uU3ltYm9sU3R5bGVyUG9wb3ZlciA9IGNsYXNzIHtcbiAgY29uc3RydWN0b3IoaG9zdFJlZikge1xuICAgIHJlZ2lzdGVySW5zdGFuY2UodGhpcywgaG9zdFJlZik7XG4gICAgdGhpcy5hcmNnaXNBZ2dyZWdhdGlvblN5bWJvbFN0eWxlckNoYW5nZSA9IGNyZWF0ZUV2ZW50KHRoaXMsIFwiYXJjZ2lzQWdncmVnYXRpb25TeW1ib2xTdHlsZXJDaGFuZ2VcIiwgNyk7XG4gICAgdGhpcy5hcmNnaXNBZ2dyZWdhdGlvblN5bWJvbFN0eWxlclBvcG92ZXJDbG9zZSA9IGNyZWF0ZUV2ZW50KHRoaXMsIFwiYXJjZ2lzQWdncmVnYXRpb25TeW1ib2xTdHlsZXJQb3BvdmVyQ2xvc2VcIiwgNyk7XG4gICAgdGhpcy5hcmNnaXNBZ2dyZWdhdGlvblN5bWJvbFN0eWxlclBvcG92ZXJEaXNjb25uZWN0ZWQgPSBjcmVhdGVFdmVudCh0aGlzLCBcImFyY2dpc0FnZ3JlZ2F0aW9uU3ltYm9sU3R5bGVyUG9wb3ZlckRpc2Nvbm5lY3RlZFwiLCA3KTtcbiAgICB0aGlzLmRvY3VtZW50VGFiSGFuZGxlciA9IHVuZGVmaW5lZDtcbiAgICB0aGlzLmRvY3VtZW50Q2xpY2tIYW5kbGVyID0gdW5kZWZpbmVkO1xuICAgIHRoaXMucGFuZWxTY3JvbGxIYW5kbGVyID0gdW5kZWZpbmVkO1xuICAgIHRoaXMucHJvcHMgPSB1bmRlZmluZWQ7XG4gICAgdGhpcy5yZWZlcmVuY2VFbGVtZW50ID0gdW5kZWZpbmVkO1xuICB9XG4gIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgLy9cbiAgLy8gIHB1YmxpYyBjYWxsc1xuICAvL1xuICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIGFzeW5jIHJlcG9zaXRpb24oKSB7XG4gICAgdmFyIF9hO1xuICAgIChfYSA9IHRoaXMucG9wb3Zlck5vZGUpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5yZXBvc2l0aW9uKCk7XG4gIH1cbiAgYXN5bmMgc2V0Rm9jdXMoKSB7XG4gICAgdmFyIF9hO1xuICAgIChfYSA9IHRoaXMuY2xvc2VBY3Rpb25Ob2RlKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2Euc2V0Rm9jdXMoKTtcbiAgfVxuICBhc3luYyBzZXRPcGVuKG9wZW4pIHtcbiAgICBpZiAodGhpcy5wb3BvdmVyTm9kZSkge1xuICAgICAgdGhpcy5wb3BvdmVyTm9kZS5vcGVuID0gb3BlbjtcbiAgICAgIGlmIChvcGVuKSB7XG4gICAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5jbG9zZUFjdGlvbk5vZGUuc2V0Rm9jdXMoKSwgMTAwKTtcbiAgICAgICAgLy90aGlzLnBvcG92ZXJOb2RlLnJlcG9zaXRpb24oKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbiAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAvL1xuICAvLyAgTGlmZWN5Y2xlXG4gIC8vXG4gIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgYXN5bmMgY29tcG9uZW50V2lsbExvYWQoKSB7XG4gICAgY29uc3QgW3N5bWJvbFV0aWxzLCBjaW1TeW1ib2xVdGlscywgQ29sb3IsIFNpbXBsZU1hcmtlclN5bWJvbCwgU2ltcGxlTGluZVN5bWJvbF0gPSBhd2FpdCBsb2FkTW9kdWxlcyhbXG4gICAgICBcImVzcmkvc3ltYm9scy9zdXBwb3J0L3N5bWJvbFV0aWxzXCIsXG4gICAgICBcImVzcmkvc3ltYm9scy9zdXBwb3J0L2NpbVN5bWJvbFV0aWxzXCIsXG4gICAgICBcImVzcmkvQ29sb3JcIixcbiAgICAgIFwiZXNyaS9zeW1ib2xzL1NpbXBsZU1hcmtlclN5bWJvbFwiLFxuICAgICAgXCJlc3JpL3N5bWJvbHMvU2ltcGxlTGluZVN5bWJvbFwiXG4gICAgXSk7XG4gICAgdGhpcy5tb2R1bGVzID0ge1xuICAgICAgc3ltYm9sVXRpbHMsXG4gICAgICBjaW1TeW1ib2xVdGlscyxcbiAgICAgIENvbG9yLFxuICAgICAgU2ltcGxlTWFya2VyU3ltYm9sLFxuICAgICAgU2ltcGxlTGluZVN5bWJvbFxuICAgIH07XG4gIH1cbiAgZGlzY29ubmVjdGVkQ2FsbGJhY2soKSB7XG4gICAgLy8gaW4gY2FzZSBwb3BvdmVyIGdvdCByZW1vdmVkIGJ5IGp1c3QgcmVtb3Zpbmcgbm9kZSBmcm9tIERPTVxuICAgIHRoaXMuYXJjZ2lzQWdncmVnYXRpb25TeW1ib2xTdHlsZXJQb3BvdmVyRGlzY29ubmVjdGVkLmVtaXQoKTtcbiAgfVxuICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAvL1xuICAvLyAgUmVuZGVyIE1ldGhvZHNcbiAgLy9cbiAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICByZW5kZXIoKSB7XG4gICAgY29uc3QgeyBwcm9wcywgcmVmZXJlbmNlRWxlbWVudCB9ID0gdGhpcztcbiAgICBjb25zdCB7IHN0cmluZ3MgfSA9IHByb3BzO1xuICAgIHJldHVybiAoaChIb3N0LCB7IGNsYXNzOiBcImpzLWFwcC1mbHlvdXQgYXJjZ2lzLWFnZ3JlZ2F0aW9uLXBvcG92ZXJcIiB9LCBoKFwiY2FsY2l0ZS1wb3BvdmVyXCIsIHsgcGxhY2VtZW50OiBcImxlYWRpbmctc3RhcnRcIiwgb2Zmc2V0RGlzdGFuY2U6IDAsIG9mZnNldFNraWRkaW5nOiA0NSwgcG9pbnRlckRpc2FibGVkOiB0cnVlLCBsYWJlbDogc3RyaW5ncy5zeW1ib2xTdHlsZSwgcmVmZXJlbmNlRWxlbWVudDogcmVmZXJlbmNlRWxlbWVudCwgdHJpZ2dlckRpc2FibGVkOiB0cnVlLCBjbGFzczogXCJwb3BvdmVyXCIsIG9wZW46IGZhbHNlLFxuICAgICAgLy9vbkNhbGNpdGVQb3BvdmVyT3Blbj17KCkgPT4gdGhpcy5vbk9wZW4oKX1cbiAgICAgIHJlZjogKG5vZGUpID0+ICh0aGlzLnBvcG92ZXJOb2RlID0gbm9kZSkgfSwgaChcImNhbGNpdGUtcGFuZWxcIiwgeyBoZWFkaW5nOiBzdHJpbmdzLnN5bWJvbFN0eWxlLCBjbG9zYWJsZTogZmFsc2UgfSwgaChcImRpdlwiLCB7IHNsb3Q6IFwiaGVhZGVyLWNvbnRlbnRcIiB9LCBzdHJpbmdzLnN5bWJvbFN0eWxlKSwgaChcImNhbGNpdGUtYWN0aW9uXCIsIHsgc2xvdDogXCJoZWFkZXItYWN0aW9ucy1lbmRcIiwgc2NhbGU6IFwic1wiLCBpY29uOiBcInhcIiwgdGV4dDogXCJcIiwgb25DbGljazogKCkgPT4gdGhpcy5hcmNnaXNBZ2dyZWdhdGlvblN5bWJvbFN0eWxlclBvcG92ZXJDbG9zZS5lbWl0KCksIHJlZjogKG5vZGUpID0+ICh0aGlzLmNsb3NlQWN0aW9uTm9kZSA9IG5vZGUpIH0pLCBoKFwiZGl2XCIsIHsgY2xhc3M6IFwic3ltYm9sLXN0eWxlci1kaXZcIixcbiAgICAgIC8qIGNsYXNzPVwiLXN5bWJvbC1idXR0b25fX3N5bWJvbC1zdHlsZXItZGl2XCIgKi8gcmVmOiAobm9kZSkgPT4gdGhpcy5idWlsZFN5bWJvbFN0eWxlcihub2RlKSB9KSkpKSk7XG4gIH1cbiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgLy9cbiAgLy8gIFByaXZhdGUgbWV0aG9kc1xuICAvL1xuICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICBhc3luYyBidWlsZFN5bWJvbFN0eWxlcihub2RlKSB7XG4gICAgY29uc3QgeyBwcm9wcywgbW9kdWxlcyB9ID0gdGhpcztcbiAgICBjb25zdCB7IGxheWVyLCBwb3J0YWwgfSA9IHByb3BzO1xuICAgIGNvbnN0IHsgQ29sb3IgfSA9IG1vZHVsZXM7XG4gICAgY29uc3QgZmVhdHVyZVJlZHVjdGlvbiA9IGxheWVyLmZlYXR1cmVSZWR1Y3Rpb247IC8vX19lc3JpLkZlYXR1cmVSZWR1Y3Rpb25DbHVzdGVyO1xuICAgIGxldCBzeW1ib2wgPSBmZWF0dXJlUmVkdWN0aW9uLnN5bWJvbDtcbiAgICBpZiAoIWlzU3VwcG9ydGVkU3ltYm9sKHN5bWJvbCkpIHtcbiAgICAgIHN5bWJvbCA9IGdldERlZmF1bHRTeW1ib2wobW9kdWxlcyk7XG4gICAgfVxuICAgIGNvbnN0IGZpbGxFbmFibGVkID0gc3ltYm9sLnR5cGUgPT09IFwicGljdHVyZS1tYXJrZXJcIiA/IGZhbHNlIDogISFzeW1ib2wuY29sb3I7XG4gICAgY29uc3Qgc3Ryb2tlRW5hYmxlZCA9IGhhc1N5bWJvbE91dGxpbmUoc3ltYm9sKTtcbiAgICBjb25zdCBpc1BvaW50Q0lNID0gc3ltYm9sLnR5cGUgPT09IFwiY2ltXCIgJiYgc3ltYm9sLmRhdGEuc3ltYm9sLnR5cGUgPT09IFwiQ0lNUG9pbnRTeW1ib2xcIjtcbiAgICBjb25zdCBydGwgPSBnZXRFbGVtZW50RGlyKHRoaXMuaG9zdEVsZW1lbnQpID09PSBcInJ0bFwiO1xuICAgIGxldCBzdHJva2U7XG4gICAgaWYgKHN5bWJvbC50eXBlID09PSBcInNpbXBsZS1tYXJrZXJcIikge1xuICAgICAgY29uc3Qgc3ltID0gc3ltYm9sO1xuICAgICAgaWYgKHN5bS5vdXRsaW5lKSB7XG4gICAgICAgIHN0cm9rZSA9IHtcbiAgICAgICAgICBjb2xvcjogc3ltLm91dGxpbmUuY29sb3IgPyBzeW0ub3V0bGluZS5jb2xvciA6IG5ldyBDb2xvcihbMCwgMCwgMCwgMC41XSksXG4gICAgICAgICAgc2l6ZTogc3ltLm91dGxpbmUud2lkdGhcbiAgICAgICAgfTtcbiAgICAgIH1cbiAgICAgIGVsc2Uge1xuICAgICAgICBzdHJva2UgPSB7XG4gICAgICAgICAgY29sb3I6IG5ldyBDb2xvcihbMCwgMCwgMCwgMC41XSksXG4gICAgICAgICAgc2l6ZTogMVxuICAgICAgICB9O1xuICAgICAgfVxuICAgIH1cbiAgICBlbHNlIGlmIChzeW1ib2wudHlwZSA9PT0gXCJjaW1cIikge1xuICAgICAgc3Ryb2tlID0gdW5kZWZpbmVkO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgIHN0cm9rZSA9IHtcbiAgICAgICAgY29sb3I6IG5ldyBDb2xvcihbMjU1LCAyNTUsIDI1NSwgMC41XSksXG4gICAgICAgIHNpemU6IDFcbiAgICAgIH07XG4gICAgfVxuICAgIGNvbnN0IHN5bWJvbFN0eWxlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJhcmNnaXMtc3ltYm9sLXN0eWxlclwiKTtcbiAgICBzeW1ib2xTdHlsZXIucG9wb3ZlclByb3BzID0ge1xuICAgICAgcGxhY2VtZW50OiBcImJvdHRvbS1lbmRcIixcbiAgICAgIG9mZnNldERpc3RhbmNlOiAxMCxcbiAgICAgIG9mZnNldFNraWRkaW5nOiBydGwgPyAzIDogLTMsXG4gICAgICBwb2ludGVyRGlzYWJsZWQ6IFwidHJ1ZVwiLFxuICAgICAgcG9wb3ZlcldpZHRoOiAzMTUsXG4gICAgICAvL292ZXJsYXlQb3NpdGlvbmluZzogXCJmaXhlZFwiLCAtLSBidWdneSwgb2Zmc2V0IGlzc3VlXG4gICAgICByZWZFbGVtZW50OiB0aGlzLmNsb3NlQWN0aW9uTm9kZVxuICAgIH07XG4gICAgY29uc3QgZWRpdCA9IHN5bWJvbFN0eWxlci5lZGl0KHN5bWJvbC5jbG9uZSgpLCB7XG4gICAgICBwb3J0YWwsXG4gICAgICBzeW1ib2xGaWx0ZXI6IHVuZGVmaW5lZCxcbiAgICAgIHNlY3Rpb25zOiB7XG4gICAgICAgIG1hcmtlcjogaXNQb2ludENJTSB8fCBbXCJzaW1wbGUtbWFya2VyXCIsIFwicGljdHVyZS1tYXJrZXJcIl0uaW5kZXhPZihzeW1ib2wudHlwZSkgPiAtMVxuICAgICAgICAgID8ge1xuICAgICAgICAgICAgb3BlbjogdHJ1ZSxcbiAgICAgICAgICAgIHN5bWJvbHNPcGVuOiB0cnVlLFxuICAgICAgICAgICAgc2l6ZU9wZW46IHRydWUsXG4gICAgICAgICAgICBwYXJ0czoge1xuICAgICAgICAgICAgICBzaXplOiBmYWxzZVxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIG1hcmtlclR5cGU6IFwiYWxsXCJcbiAgICAgICAgICB9XG4gICAgICAgICAgOiB1bmRlZmluZWQsXG4gICAgICAgIGZpbGw6IHtcbiAgICAgICAgICB0eXBlOiBcImNvbG9yXCIsXG4gICAgICAgICAgb3B0aW9uYWw6IHRydWUsXG4gICAgICAgICAgb3BlbjogdHJ1ZSxcbiAgICAgICAgICBzdWdnZXN0ZWRDb2xvcnNPcGVuOiB0cnVlLFxuICAgICAgICAgIHRyYW5zcGFyZW5jeU9wZW46IGlzUGljdHVyZU1hcmtlcihzeW1ib2wsIG1vZHVsZXMpXG4gICAgICAgIH0sXG4gICAgICAgIHN0cm9rZToge1xuICAgICAgICAgIHR5cGU6IFwiY29sb3JcIixcbiAgICAgICAgICBvcHRpb25hbDogdHJ1ZSxcbiAgICAgICAgICBleHRyYVBhcnRzOiB7XG4gICAgICAgICAgICBzdHlsZTogW1wic2ltcGxlLW1hcmtlclwiLCBcInBpY3R1cmUtbWFya2VyXCIsIFwiY2ltXCJdLmluZGV4T2Yoc3ltYm9sLnR5cGUpID09PSAtMSxcbiAgICAgICAgICAgIHdpZHRoOiB0cnVlXG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9LFxuICAgICAgZmlsbDoge1xuICAgICAgICBjb2xvcjogZ2V0U3ltYm9sQ29sb3Ioc3ltYm9sLCBtb2R1bGVzKSB8fCBhZGp1c3RBbHBoYShuZXcgQ29sb3IoXCIjZmY4MjAwXCIpLCAwLjg1KVxuICAgICAgfSxcbiAgICAgIG1hcmtlcjoge1xuICAgICAgICBzaXplOiBnZXRTeW1ib2xTaXplKHN5bWJvbCwgbW9kdWxlcylcbiAgICAgIH0sXG4gICAgICBzdHJva2UsXG4gICAgICBmaWxsRW5hYmxlZCxcbiAgICAgIHN0cm9rZUVuYWJsZWRcbiAgICB9KTtcbiAgICBzeW1ib2xTdHlsZXIuYWRkRXZlbnRMaXN0ZW5lcihcImFyY2dpc1N5bWJvbFN0eWxlckVkaXRcIiwgKGRldGFpbCkgPT4gdGhpcy5vbkNoYW5nZVN5bWJvbChkZXRhaWwpKTtcbiAgICBub2RlLmFwcGVuZENoaWxkKHN5bWJvbFN0eWxlcik7XG4gICAgYXdhaXQgZWRpdDtcbiAgfVxuICBvbkNoYW5nZVN5bWJvbCh7IGRldGFpbDogeyBzeW1ib2wgfSB9KSB7XG4gICAgY29uc3QgeyBwcm9wcyB9ID0gdGhpcztcbiAgICBjb25zdCB7IGxheWVyIH0gPSBwcm9wcztcbiAgICBjb25zdCBmZWF0dXJlUmVkdWN0aW9uID0gbGF5ZXIuZmVhdHVyZVJlZHVjdGlvbjsgLy9fX2VzcmkuRmVhdHVyZVJlZHVjdGlvbkNsdXN0ZXI7XG4gICAgZmVhdHVyZVJlZHVjdGlvbi5zeW1ib2wgPSBzeW1ib2w7XG4gICAgdGhpcy5hcmNnaXNBZ2dyZWdhdGlvblN5bWJvbFN0eWxlckNoYW5nZS5lbWl0KCk7XG4gIH1cbiAgZ2V0IGhvc3RFbGVtZW50KCkgeyByZXR1cm4gZ2V0RWxlbWVudCh0aGlzKTsgfVxufTtcbkFyY2dpc0FnZ3JlZ2F0aW9uU3ltYm9sU3R5bGVyUG9wb3Zlci5zdHlsZSA9IGFyY2dpc0FnZ3JlZ2F0aW9uU3ltYm9sU3R5bGVyUG9wb3ZlckNzcztcblxuY29uc3QgYXJjZ2lzQWdncmVnYXRpb25UaWxlQ3NzID0gXCIudGlsZXtiYWNrZ3JvdW5kLWNvbG9yOndoaXRlO3Bvc2l0aW9uOnJlbGF0aXZlO21hcmdpbjo2cHg7Y3Vyc29yOnBvaW50ZXI7Ym94LXNoYWRvdzowIDFweCAxMHB4IDJweCByZ2JhKDAsIDAsIDAsIDAuMDUpLCAwIDAgMCAxcHggI2UwZTBlMDt0cmFuc2l0aW9uOmJveC1zaGFkb3cgMTI1bXMgZWFzZS1pbi1vdXR9LnRpbGU6aG92ZXJ7ei1pbmRleDo1O2JveC1zaGFkb3c6MCAxcHggMCAycHggcmdiYSgwLCAwLCAwLCAwLjA1KSwgMCAwIDAgMXB4ICNlMGUwZTB9LnRpbGU6Zm9jdXN7b3V0bGluZToycHggc29saWQgdmFyKC0tY2FsY2l0ZS11aS1icmFuZCl9LnRpbGUtc2VsZWN0ZWR7Ym94LXNoYWRvdzowIDFweCAxMHB4IDJweCByZ2JhKDAsIDAsIDAsIDAuMDUpLCAwIDAgMCAxcHggdmFyKC0tY2FsY2l0ZS11aS1icmFuZCl9LnRpbGUtc2VsZWN0ZWQ6aG92ZXJ7ei1pbmRleDo1O2JveC1zaGFkb3c6MCAxcHggMCAycHggcmdiYSgwLCAwLCAwLCAwLjA1KSwgMCAwIDAgMXB4IHZhcigtLWNhbGNpdGUtdWktYnJhbmQpfS50aWxlLWNoZWNre3Bvc2l0aW9uOmFic29sdXRlO3RvcDoxMHB4O3JpZ2h0OjEwcHh9LnRpbGUtY2hlY2sucnRse3JpZ2h0OmF1dG87bGVmdDoxMHB4fS5zdHlsZS1saW5re3BhZGRpbmc6OXB4IDlweH0uc3R5bGUtbGluay1pY29ue21hcmdpbi10b3A6LTFweH0uc3R5bGUtbGluay10ZXh0e21hcmdpbi1yaWdodDoxMHB4fS5zdHlsZS1saW5rLXRleHQucnRse21hcmdpbi1yaWdodDowO21hcmdpbi1sZWZ0OjEwcHh9LnN0eWxlLWxpbmstdGl0bGV7ZGlzcGxheTpmbGV4O2ZvbnQtd2VpZ2h0OmJvbGQ7cGFkZGluZy1ib3R0b206NXB4fS5zdHlsZS1saW5rLW9wdGlvbnN7Y29sb3I6IzAwNzljMTtkaXNwbGF5OmZsZXg7ZmxleC1kaXJlY3Rpb246cm93IG5vd3JhcH0uc3R5bGUtbGluay1vcHRpb25zIHN2Z3tmaWxsOiMwMDc5YzF9LnRpbGUtaW1hZ2V7aGVpZ2h0OjEwMHB4O3dpZHRoOjEwMCU7YmFja2dyb3VuZC1zaXplOmNvdmVyO2Rpc3BsYXk6ZmxleDthbGlnbi1pdGVtczpjZW50ZXI7anVzdGlmeS1jb250ZW50OmNlbnRlcn0udGlsZS1pbWFnZS1zZWxlY3RlZHtoZWlnaHQ6NjhweDtiYWNrZ3JvdW5kLXNpemU6YXV0byAxMDBweH0uc3R5bGUtc3ViLXRleHR7Zm9udC1zaXplOjgwJTtwYWRkaW5nOjAgMCA2cHggMH0uc3R5bGUtbGluay1pbmZve2hlaWdodDoxOHB4fVwiO1xuXG5jb25zdCBBcmNnaXNBZ2dyZWdhdGlvblRpbGUgPSBjbGFzcyB7XG4gIGNvbnN0cnVjdG9yKGhvc3RSZWYpIHtcbiAgICByZWdpc3Rlckluc3RhbmNlKHRoaXMsIGhvc3RSZWYpO1xuICAgIHRoaXMuYXJjZ2lzQWdncmVnYXRpb25UaWxlU2VsZWN0ID0gY3JlYXRlRXZlbnQodGhpcywgXCJhcmNnaXNBZ2dyZWdhdGlvblRpbGVTZWxlY3RcIiwgNyk7XG4gICAgdGhpcy5hcmNnaXNBZ2dyZWdhdGlvblRpbGVPcHRpb25zID0gY3JlYXRlRXZlbnQodGhpcywgXCJhcmNnaXNBZ2dyZWdhdGlvblRpbGVPcHRpb25zXCIsIDcpO1xuICAgIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICAvL1xuICAgIC8vICBQcml2YXRlIFByb3BlcnRpZXNcbiAgICAvL1xuICAgIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICB0aGlzLmRvY3VtZW50Q2xpY2tIYW5kbGVyID0gdW5kZWZpbmVkO1xuICAgIHRoaXMucGFuZWxTY3JvbGxIYW5kbGVyID0gdW5kZWZpbmVkO1xuICAgIHRoaXMua2V5dXBFdmVudEhhbmRsZXIgPSAoZXZlbnQpID0+IHtcbiAgICAgIGNvbnN0IHsgc2VsZWN0ZWQgfSA9IHRoaXM7XG4gICAgICBpZiAoZXZlbnQua2V5ID09PSBcIiBcIiB8fCBldmVudC5rZXkgPT09IFwiRW50ZXJcIikge1xuICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgdGhpcy5yZW1vdmVJbmZvUG9wb3ZlcigpO1xuICAgICAgICAvLyB1c2UgbGF0ZXN0IGhhbmRsZXIgb24gcHJvcHNcbiAgICAgICAgc2VsZWN0ZWQgPyB0aGlzLmFyY2dpc0FnZ3JlZ2F0aW9uVGlsZU9wdGlvbnMuZW1pdCgpIDogdGhpcy5hcmNnaXNBZ2dyZWdhdGlvblRpbGVTZWxlY3QuZW1pdCgpO1xuICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgfVxuICAgIH07XG4gICAgdGhpcy5rZXlkb3duRXZlbnRIYW5kbGVyID0gKGV2ZW50KSA9PiB7XG4gICAgICBpZiAoZXZlbnQua2V5ID09PSBcIiBcIikge1xuICAgICAgICAvLyBkb24ndCBzY3JvbGwgcGFuZWxcbiAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICB9XG4gICAgfTtcbiAgICB0aGlzLmNsaWNrRXZlbnRIYW5kbGVyID0gKGV2ZW50KSA9PiB7XG4gICAgICB2YXIgX2E7XG4gICAgICBjb25zdCB7IHNlbGVjdGVkIH0gPSB0aGlzO1xuICAgICAgaWYgKCgoX2EgPSBldmVudCA9PT0gbnVsbCB8fCBldmVudCA9PT0gdm9pZCAwID8gdm9pZCAwIDogZXZlbnQudGFyZ2V0KSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2Eubm9kZU5hbWUpID09PSBcIkNBTENJVEUtQ0hFQ0tCT1hcIikge1xuICAgICAgICAvLyB1c2VyIGNsaWNrZWQgb24gY2hlY2tib3g7IHdlIGhhbmRsZWQgdGhpcyBiZWxvd1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgIHRoaXMucmVtb3ZlSW5mb1BvcG92ZXIoKTtcbiAgICAgIC8vIHVzZSBsYXRlc3QgaGFuZGxlciBvbiBwcm9wc1xuICAgICAgc2VsZWN0ZWQgPyB0aGlzLmFyY2dpc0FnZ3JlZ2F0aW9uVGlsZU9wdGlvbnMuZW1pdCgpIDogdGhpcy5hcmNnaXNBZ2dyZWdhdGlvblRpbGVTZWxlY3QuZW1pdCgpO1xuICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICB9O1xuICAgIHRoaXMuY2hlY2tib3hDaGFuZ2VIYW5kbGVyID0gKGV2ZW50KSA9PiB7XG4gICAgICBjb25zdCB7IHNlbGVjdGVkIH0gPSB0aGlzO1xuICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICAgIGNvbnN0IG5vZGUgPSBldmVudC50YXJnZXQ7XG4gICAgICBpZiAoIW5vZGUuY2hlY2tlZCkge1xuICAgICAgICAvLyB3ZSBkb24ndCBhbGxvdyB1c2VycyB0byB1bmNoZWNrIHRoZSBib3hcbiAgICAgICAgbm9kZS5jaGVja2VkID0gdHJ1ZTtcbiAgICAgIH1cbiAgICAgIGVsc2Uge1xuICAgICAgICB0aGlzLnJlbW92ZUluZm9Qb3BvdmVyKCk7XG4gICAgICAgIC8vIHVzZSBsYXRlc3QgaGFuZGxlciBvbiBwcm9wc1xuICAgICAgICBzZWxlY3RlZCA/IHRoaXMuYXJjZ2lzQWdncmVnYXRpb25UaWxlT3B0aW9ucy5lbWl0KCkgOiB0aGlzLmFyY2dpc0FnZ3JlZ2F0aW9uVGlsZVNlbGVjdC5lbWl0KCk7XG4gICAgICB9XG4gICAgfTtcbiAgICB0aGlzLnByb3BzID0gdW5kZWZpbmVkO1xuICAgIHRoaXMuc2VsZWN0ZWQgPSB1bmRlZmluZWQ7XG4gIH1cbiAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAvL1xuICAvLyAgUHVibGljIE1ldGhvZHNcbiAgLy9cbiAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAvKipcbiAgICogU2V0IGZvY3VzIG9uIHRpbGVcbiAgICovXG4gIGFzeW5jIHNldEZvY3VzKCkge1xuICAgIHZhciBfYTtcbiAgICAoX2EgPSB0aGlzLnRpbGVOb2RlKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EuZm9jdXMoKTtcbiAgfVxuICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIC8vXG4gIC8vICBMaWZlY3ljbGVcbiAgLy9cbiAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICBkaXNjb25uZWN0ZWRDYWxsYmFjaygpIHtcbiAgICB0aGlzLnJlbW92ZUluZm9Qb3BvdmVyKCk7XG4gIH1cbiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgLy9cbiAgLy8gIFJlbmRlciBNZXRob2RzXG4gIC8vXG4gIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgcmVuZGVyKCkge1xuICAgIGNvbnN0IHsgcHJvcHMsIHNlbGVjdGVkIH0gPSB0aGlzO1xuICAgIGNvbnN0IHsgdGl0bGUsIGltYWdlUGF0aCwgc3RyaW5ncyB9ID0gcHJvcHM7XG4gICAgY29uc3QgcnRsID0gZ2V0RWxlbWVudERpcih0aGlzLmhvc3RFbGVtZW50KSA9PT0gXCJydGxcIjtcbiAgICBjb25zdCBzdHlsZVRpbGVDbGFzc2VzID0ge1xuICAgICAgdGlsZTogdHJ1ZSxcbiAgICAgIFwidGlsZS1zZWxlY3RlZFwiOiBzZWxlY3RlZFxuICAgIH07XG4gICAgY29uc3Qgc3R5bGVUaWxlSW1hZ2VDbGFzc2VzID0ge1xuICAgICAgXCJ0aWxlLWltYWdlXCI6IHRydWUsXG4gICAgICBcInRpbGUtaW1hZ2Utc2VsZWN0ZWRcIjogc2VsZWN0ZWRcbiAgICB9O1xuICAgIGNvbnN0IHN0eWxlVGlsZUNoZWNrQ2xhc3NlcyA9IHtcbiAgICAgIFwidGlsZS1jaGVja1wiOiB0cnVlLFxuICAgICAgcnRsOiBydGxcbiAgICB9O1xuICAgIHJldHVybiAoaChIb3N0LCBudWxsLCBoKFwiZGl2XCIsIHsgY2xhc3M6IHN0eWxlVGlsZUNsYXNzZXMsIHJvbGU6IFwiYnV0dG9uXCIsIHRhYmluZGV4OiBcIjBcIiwgXCJhcmlhLWxhYmVsXCI6IGAke3RpdGxlfSAke3N0cmluZ3MudGlsZS5vcHRpb25zfWAsIFwiYXJpYS1zZWxlY3RlZFwiOiBzZWxlY3RlZCwgcmVmOiAoZWxlbWVudCkgPT4ge1xuICAgICAgICB0aGlzLnRpbGVOb2RlID0gZWxlbWVudDtcbiAgICAgICAgdGhpcy5hZGRUaWxlTGlzdGVuZXJzKGVsZW1lbnQpO1xuICAgICAgfSB9LCBoKFwiZGl2XCIsIHsgY2xhc3M6IHN0eWxlVGlsZUltYWdlQ2xhc3Nlcywgc3R5bGU6IHsgYmFja2dyb3VuZEltYWdlOiBgdXJsKCR7aW1hZ2VQYXRofSlgIH0sIFwiYXJpYS1oaWRkZW5cIjogXCJ0cnVlXCIgfSksIGgoXCJkaXZcIiwgeyBjbGFzczogc3R5bGVUaWxlQ2hlY2tDbGFzc2VzLCBcImFyaWEtbGFiZWxcIjogXCJcIiwgXCJhcmlhLWhpZGRlblwiOiBcInRydWVcIiB9LCBoKFwiY2FsY2l0ZS1jaGVja2JveFwiLCB7IG5hbWU6IFwic3R5bGUtdGlsZS1jaGVjay1uYW1lXCIsIGNoZWNrZWQ6IHNlbGVjdGVkLCB0YWJpbmRleDogXCItMVwiLCByZWY6IChlbGVtZW50KSA9PiB0aGlzLmFkZENoZWNrYm94TGlzdGVuZXIoZWxlbWVudCkgfSkpLCB0aGlzLnJlbmRlclRpbGVMaW5rKCkpKSk7XG4gIH1cbiAgcmVuZGVyVGlsZUxpbmsoKSB7XG4gICAgY29uc3QgeyBwcm9wcywgc2VsZWN0ZWQgfSA9IHRoaXM7XG4gICAgY29uc3QgeyBzdHJpbmdzIH0gPSBwcm9wcztcbiAgICBjb25zdCBydGwgPSBnZXRFbGVtZW50RGlyKHRoaXMuaG9zdEVsZW1lbnQpID09PSBcInJ0bFwiO1xuICAgIGNvbnN0IHN0eWxlTGlua1RleHRDbGFzc2VzID0ge1xuICAgICAgXCJzdHlsZS1saW5rLXRleHRcIjogdHJ1ZSxcbiAgICAgIHJ0bDogcnRsXG4gICAgfTtcbiAgICByZXR1cm4gKGgoXCJkaXZcIiwgeyBjbGFzczogXCJzdHlsZS1saW5rXCIsIFwiYXJpYS1sYWJlbFwiOiBwcm9wcy50aXRsZSB9LCBoKFwiZGl2XCIsIHsgY2xhc3M6IFwic3R5bGUtbGluay10aXRsZVwiIH0sIGgoXCJkaXZcIiwgeyBjbGFzczogc3R5bGVMaW5rVGV4dENsYXNzZXMsIFwiYXJpYS1oaWRkZW5cIjogXCJ0cnVlXCIgfSwgcHJvcHMudGl0bGUpLCBoKFwiY2FsY2l0ZS1hY3Rpb25cIiwgeyBjbGFzczogXCJzdHlsZS1saW5rLWluZm9cIiwgdGFiaW5kZXg6IFwiMFwiLCBzY2FsZTogXCJzXCIsIGljb246IFwiaW5mb3JtYXRpb25cIiwgY29tcGFjdDogdHJ1ZSwgb25DbGljazogKGV2ZW50KSA9PiB0aGlzLmhhbmRsZUluZm9DbGljayhldmVudCksIHRleHQ6IHN0cmluZ3MudGlsZS5tb3JlSW5mbywgcmVmOiAoZWxlbWVudCkgPT4ge1xuICAgICAgICB0aGlzLmluZm9JY29uTm9kZSA9IGVsZW1lbnQ7XG4gICAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihcImtleXVwXCIsIChldmVudCkgPT4ge1xuICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICAgIGlmIChldmVudC5rZXkgPT09IFwiIFwiIHx8ICghdGhpcy5pbmZvUG9wb3Zlck5vZGUgJiYgZXZlbnQua2V5ID09PSBcIkVudGVyXCIpKSB7XG4gICAgICAgICAgICB0aGlzLmhhbmRsZUluZm9DbGljayhldmVudCk7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKFwia2V5ZG93blwiLCAoZXZlbnQpID0+IHtcbiAgICAgICAgICBpZiAoZXZlbnQua2V5ID09PSBcIiBcIikge1xuICAgICAgICAgICAgLy8gcHJldmVudCBwYW5lbCBmcm9tIHNjcm9sbGluZ1xuICAgICAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICB9IH0pKSwgc2VsZWN0ZWQgJiYgdGhpcy5yZW5kZXJTdHlsZU9wdGlvbnMoKSkpO1xuICB9XG4gIHJlbmRlclN0eWxlT3B0aW9ucygpIHtcbiAgICBjb25zdCB7IHByb3BzIH0gPSB0aGlzO1xuICAgIGNvbnN0IHsgc3RyaW5ncyB9ID0gcHJvcHM7XG4gICAgLy8gZXZlbnQgaGFuZGxpbmcgZm9yIGJ1dHRvbiBjbGljayBpcyBoYW5kbGVkIGFzIHRpbGUgY2xpY2tcbiAgICByZXR1cm4gKGgoXCJjYWxjaXRlLWJ1dHRvblwiLCB7IGFwcGVhcmFuY2U6IFwib3V0bGluZS1maWxsXCIsIHdpZHRoOiBcImZ1bGxcIiwgc2NhbGU6IFwic1wiLCBsYWJlbDogc3RyaW5ncy50aWxlLm9wdGlvbnMgfSwgc3RyaW5ncy50aWxlLm9wdGlvbnMpKTtcbiAgfVxuICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAvL1xuICAvLyAgUHJpdmF0ZSBtZXRob2RzXG4gIC8vXG4gIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIGhhbmRsZUluZm9DbGljayhldmVudCkge1xuICAgIC8vIGRvbid0IGV4ZWN1dGUgdGhlIGV2ZW50IG9uIHRoZSBlbnRpcmUgdGlsZVxuICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgIGNvbnN0IHsgcHJvcHMgfSA9IHRoaXM7XG4gICAgY29uc3QgeyBjb25maWcsIHRpdGxlLCBtb3JlSW5mbywgaGVscElkLCBmbG93SXRlbU5vZGUsIHN0cmluZ3MgfSA9IHByb3BzO1xuICAgIHRoaXMucmVtb3ZlSW5mb1BvcG92ZXIoKTtcbiAgICB0aGlzLmluZm9Qb3BvdmVyTm9kZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJhcmNnaXMtYWdncmVnYXRpb24taW5mby1wb3BvdmVyXCIpO1xuICAgIHRoaXMuaW5mb1BvcG92ZXJOb2RlLnByb3BzID0ge1xuICAgICAgdGl0bGUsXG4gICAgICBtb3JlSW5mbyxcbiAgICAgIGhlbHBJZCxcbiAgICAgIGNvbmZpZyxcbiAgICAgIGZsb3dJdGVtTm9kZSxcbiAgICAgIHN0cmluZ3NcbiAgICB9O1xuICAgIHRoaXMuaW5mb1BvcG92ZXJOb2RlLnJlZmVyZW5jZUVsZW1lbnQgPSB0aGlzLmluZm9JY29uTm9kZTtcbiAgICB0aGlzLmluZm9Qb3BvdmVyTm9kZS5hZGRFdmVudExpc3RlbmVyKFwiYXJjZ2lzQWdncmVnYXRpb25JbmZvUG9wb3ZlckNsb3NlXCIsIChldmVudCkgPT4ge1xuICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICB0aGlzLnJlbW92ZUluZm9Qb3BvdmVyKCk7XG4gICAgICBzZXRUaW1lb3V0KCgpID0+IHRoaXMuaW5mb0ljb25Ob2RlLnNldEZvY3VzKCksIDIwMCk7XG4gICAgfSk7XG4gICAgdGhpcy5pbmZvUG9wb3Zlck5vZGUuYWRkRXZlbnRMaXN0ZW5lcihcImFyY2dpc0FnZ3JlZ2F0aW9uSW5mb1BvcG92ZXJEaXNjb25uZWN0ZWRcIiwgKGV2ZW50KSA9PiB7XG4gICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgIHRoaXMucmVtb3ZlSW5mb1BvcG92ZXIoKTtcbiAgICB9KTtcbiAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHRoaXMuaW5mb1BvcG92ZXJOb2RlKTtcbiAgICB0aGlzLmluZm9Qb3BvdmVyTm9kZS5zZXRPcGVuKHRydWUpO1xuICAgIC8vIG5lZWQgdG8gd2FpdCB1bnRpbCBpdCdzIGFsbCB2aXNpYmxlXG4gICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLmluZm9Qb3BvdmVyTm9kZS5zZXRGb2N1cygpLCAxMDApO1xuICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgLy8gY2xvc2UgcG9wb3ZlciB3aGVuIGNsaWNraW5nIG91dHNpZGVcbiAgICAgIHRoaXMuZG9jdW1lbnRDbGlja0hhbmRsZXIgPSAoZXZlbnQpID0+IHtcbiAgICAgICAgaWYgKCF0aGlzLmlzSW5zaWRlSW5mb1BvcG92ZXJOb2RlKGV2ZW50LnRhcmdldCkpIHtcbiAgICAgICAgICB0aGlzLnJlbW92ZUluZm9Qb3BvdmVyKCk7XG4gICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLmluZm9JY29uTm9kZS5zZXRGb2N1cygpLCAyMDApO1xuICAgICAgICB9XG4gICAgICB9O1xuICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihcImNsaWNrXCIsIHRoaXMuZG9jdW1lbnRDbGlja0hhbmRsZXIpO1xuICAgICAgLy8gY2xpY2sgaGFuZGxlciBpcyBub3QgY2FsbGVkIHdoZW4gY2xpY2tpbmcgb3Igc2Nyb2xsaW5nIHBhbmVsIHNjcm9sbGJhcnNcbiAgICAgIHRoaXMucGFuZWxTY3JvbGxIYW5kbGVyID0gKCkgPT4ge1xuICAgICAgICB0aGlzLnJlbW92ZUluZm9Qb3BvdmVyKCk7XG4gICAgICB9O1xuICAgICAgZmxvd0l0ZW1Ob2RlID09PSBudWxsIHx8IGZsb3dJdGVtTm9kZSA9PT0gdm9pZCAwID8gdm9pZCAwIDogZmxvd0l0ZW1Ob2RlLmFkZEV2ZW50TGlzdGVuZXIoXCJjYWxjaXRlRmxvd0l0ZW1TY3JvbGxcIiwgdGhpcy5wYW5lbFNjcm9sbEhhbmRsZXIpO1xuICAgIH0sIDEwMCk7XG4gIH1cbiAgcmVtb3ZlSW5mb1BvcG92ZXIoKSB7XG4gICAgY29uc3QgeyBwcm9wcyB9ID0gdGhpcztcbiAgICBjb25zdCB7IGZsb3dJdGVtTm9kZSB9ID0gcHJvcHM7XG4gICAgLy8gY2xvc2UgcG9wb3ZlcnNcbiAgICBkb2N1bWVudC5ib2R5XG4gICAgICAucXVlcnlTZWxlY3RvckFsbChcIi5hcmNnaXMtYWdncmVnYXRpb24tcG9wb3ZlclwiKVxuICAgICAgLmZvckVhY2goKG5vZGUpID0+IGRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQobm9kZSkpO1xuICAgIHRoaXMuaW5mb1BvcG92ZXJOb2RlID0gbnVsbDtcbiAgICBpZiAodGhpcy5kb2N1bWVudENsaWNrSGFuZGxlcikge1xuICAgICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcihcImNsaWNrXCIsIHRoaXMuZG9jdW1lbnRDbGlja0hhbmRsZXIpO1xuICAgICAgdGhpcy5kb2N1bWVudENsaWNrSGFuZGxlciA9IHVuZGVmaW5lZDtcbiAgICB9XG4gICAgaWYgKHRoaXMucGFuZWxTY3JvbGxIYW5kbGVyKSB7XG4gICAgICBmbG93SXRlbU5vZGUgPT09IG51bGwgfHwgZmxvd0l0ZW1Ob2RlID09PSB2b2lkIDAgPyB2b2lkIDAgOiBmbG93SXRlbU5vZGUucmVtb3ZlRXZlbnRMaXN0ZW5lcihcImNhbGNpdGVGbG93SXRlbVNjcm9sbFwiLCB0aGlzLnBhbmVsU2Nyb2xsSGFuZGxlcik7XG4gICAgICB0aGlzLnBhbmVsU2Nyb2xsSGFuZGxlciA9IHVuZGVmaW5lZDtcbiAgICB9XG4gIH1cbiAgaXNJbnNpZGVJbmZvUG9wb3Zlck5vZGUobm9kZSkge1xuICAgIGlmICgobm9kZSA9PT0gbnVsbCB8fCBub2RlID09PSB2b2lkIDAgPyB2b2lkIDAgOiBub2RlLnRhZ05hbWUpID09PSBcIkFSQ0dJUy1BR0dSRUdBVElPTi1JTkZPLVBPUE9WRVJcIikge1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgbGV0IHBhcmVudE5vZGUgPSBub2RlID09PSBudWxsIHx8IG5vZGUgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG5vZGUucGFyZW50RWxlbWVudDtcbiAgICAgIHdoaWxlIChwYXJlbnROb2RlKSB7XG4gICAgICAgIGlmIChwYXJlbnROb2RlLnRhZ05hbWUgPT09IFwiQVJDR0lTLUFHR1JFR0FUSU9OLUlORk8tUE9QT1ZFUlwiKSB7XG4gICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgcGFyZW50Tm9kZSA9IHBhcmVudE5vZGUucGFyZW50RWxlbWVudDtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cbiAgYWRkVGlsZUxpc3RlbmVycyhlbGVtZW50KSB7XG4gICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKFwia2V5dXBcIiwgdGhpcy5rZXl1cEV2ZW50SGFuZGxlcik7XG4gICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKFwia2V5ZG93blwiLCB0aGlzLmtleWRvd25FdmVudEhhbmRsZXIpO1xuICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihcImNsaWNrXCIsIHRoaXMuY2xpY2tFdmVudEhhbmRsZXIpO1xuICB9XG4gIGFkZENoZWNrYm94TGlzdGVuZXIoZWxlbWVudCkge1xuICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihcImNhbGNpdGVDaGVja2JveENoYW5nZVwiLCB0aGlzLmNoZWNrYm94Q2hhbmdlSGFuZGxlcik7XG4gIH1cbiAgZ2V0IGhvc3RFbGVtZW50KCkgeyByZXR1cm4gZ2V0RWxlbWVudCh0aGlzKTsgfVxufTtcbkFyY2dpc0FnZ3JlZ2F0aW9uVGlsZS5zdHlsZSA9IGFyY2dpc0FnZ3JlZ2F0aW9uVGlsZUNzcztcblxuZXhwb3J0IHsgQXJjZ2lzQWdncmVnYXRpb24gYXMgYXJjZ2lzX2FnZ3JlZ2F0aW9uLCBBcmNnaXNBZ2dyZWdhdGlvbkJpbm5pbmcgYXMgYXJjZ2lzX2FnZ3JlZ2F0aW9uX2Jpbm5pbmcsIEFyY2dpc0FnZ3JlZ2F0aW9uQ2x1c3RlcmluZyBhcyBhcmNnaXNfYWdncmVnYXRpb25fY2x1c3RlcmluZywgQXJjZ2lzQWdncmVnYXRpb25GaWVsZCBhcyBhcmNnaXNfYWdncmVnYXRpb25fZmllbGQsIEFyY2dpc0FnZ3JlZ2F0aW9uRmllbGRzIGFzIGFyY2dpc19hZ2dyZWdhdGlvbl9maWVsZHMsIEFyY2dpc0FnZ3JlZ2F0aW9uSW5mb1BvcG92ZXIgYXMgYXJjZ2lzX2FnZ3JlZ2F0aW9uX2luZm9fcG9wb3ZlciwgQXJjZ2lzQWdncmVnYXRpb25TeW1ib2xTdHlsZXJQb3BvdmVyIGFzIGFyY2dpc19hZ2dyZWdhdGlvbl9zeW1ib2xfc3R5bGVyX3BvcG92ZXIsIEFyY2dpc0FnZ3JlZ2F0aW9uVGlsZSBhcyBhcmNnaXNfYWdncmVnYXRpb25fdGlsZSB9O1xuIiwiLyohXG4gKiBBbGwgbWF0ZXJpYWwgY29weXJpZ2h0IEVTUkksIEFsbCBSaWdodHMgUmVzZXJ2ZWQsIHVubGVzcyBvdGhlcndpc2Ugc3BlY2lmaWVkLlxuICogdjMuMC45OVxuICovXG4vKipcbiAqIENhbGwgYSBmdW5jdGlvbiBvbmx5IGFmdGVyIGl0IGhhcyBub3QgYmVlbiBjYWxsZWQgZm9yIG4gbWlsbGlzZWNvbmRzXG4gKiBAcGFyYW0gZm4gICAgLSBmdW5jdGlvbiB0byBjYWxsXG4gKiBAcGFyYW0gZGVsYXkgLSBkZWxheSBpbiBtaWxsaXNlY29uZHNcbiAqL1xuY29uc3QgZGVib3VuY2UgPSAoZm4sIGRlbGF5KSA9PiB7XG4gIGxldCB0aW1lb3V0O1xuICBsZXQgc3RhdHVzID0gXCJpZGxlXCI7XG4gIGZ1bmN0aW9uIGZsdXNoKC4uLmFyZ3MpIHtcbiAgICBzdGF0dXMgPSBcImZsdXNoZWRcIjtcbiAgICByZXR1cm4gZGVib3VuY2VkKC4uLmFyZ3MpO1xuICB9XG4gIGZ1bmN0aW9uIGludm9rZSguLi5hcmdzKSB7XG4gICAgc3RhdHVzID0gXCJpbnZva2VkXCI7XG4gICAgcmV0dXJuIGRlYm91bmNlZCguLi5hcmdzKTtcbiAgfVxuICBmdW5jdGlvbiBjYW5jZWwoLi4uYXJncykge1xuICAgIHN0YXR1cyA9IFwiY2FuY2VsbGVkXCI7XG4gICAgcmV0dXJuIGRlYm91bmNlZCguLi5hcmdzKTtcbiAgfVxuICBmdW5jdGlvbiBnZXRTdGF0dXMoKSB7XG4gICAgcmV0dXJuIHN0YXR1cztcbiAgfVxuICBjb25zdCBkZWJvdW5jZWQgPSAoLi4uYXJncykgPT4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcbiAgICBzd2l0Y2ggKHN0YXR1cykge1xuICAgICAgY2FzZSBcImZsdXNoZWRcIjpcbiAgICAgICAgc3RhdHVzID0gXCJpZGxlXCI7XG4gICAgICAgIGlmICh0aW1lb3V0KSB7XG4gICAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXQpO1xuICAgICAgICAgIHJlc29sdmUoZm4oLi4uYXJncykpO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgIHJlc29sdmUobnVsbCk7XG4gICAgICAgIH1cbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIFwiaW52b2tlZFwiOlxuICAgICAgICBjbGVhclRpbWVvdXQodGltZW91dCk7XG4gICAgICAgIHN0YXR1cyA9IFwiaWRsZVwiO1xuICAgICAgICByZXNvbHZlKGZuKC4uLmFyZ3MpKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIFwiY2FuY2VsbGVkXCI6XG4gICAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0KTtcbiAgICAgICAgc3RhdHVzID0gXCJpZGxlXCI7XG4gICAgICAgIHJlc29sdmUobnVsbCk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgaWYgKHRpbWVvdXQpIHtcbiAgICAgICAgICBjbGVhclRpbWVvdXQodGltZW91dCk7XG4gICAgICAgIH1cbiAgICAgICAgc3RhdHVzID0gXCJwZW5kaW5nXCI7XG4gICAgICAgIHRpbWVvdXQgPSBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICBzdGF0dXMgPSBcImlkbGVcIjtcbiAgICAgICAgICByZXR1cm4gcmVzb2x2ZShmbiguLi5hcmdzKSk7XG4gICAgICAgIH0sIGRlbGF5KTtcbiAgICAgICAgYnJlYWs7XG4gICAgfVxuICB9KTtcbiAgZGVib3VuY2VkLmZsdXNoID0gZmx1c2g7XG4gIGRlYm91bmNlZC5pbnZva2UgPSBpbnZva2U7XG4gIGRlYm91bmNlZC5jYW5jZWwgPSBjYW5jZWw7XG4gIGRlYm91bmNlZC5nZXRTdGF0dXMgPSBnZXRTdGF0dXM7XG4gIHJldHVybiBkZWJvdW5jZWQ7XG59O1xuLyoqXG4gKiBDYWxsIGEgZnVuY3Rpb24gb25seSBhZnRlciBuIG1pbGxpc2Vjb25kcyBoYXZlIGVsYXBzZWRcbiAqIEBwYXJhbSBmbiAgICAtIGZ1bmN0aW9uIHRvIGNhbGxcbiAqIEBwYXJhbSBkZWxheSAtIGRlbGF5IGluIG1pbGxpc2Vjb25kc1xuICovXG5jb25zdCB0aHJvdHRsZSA9IChmbiwgZGVsYXkpID0+IHtcbiAgbGV0IHRpbWVvdXQ7XG4gIHJldHVybiAoLi4uYXJncykgPT4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcbiAgICBpZiAodGltZW91dCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aW1lb3V0ID0gc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICBjbGVhclRpbWVvdXQodGltZW91dCk7XG4gICAgICB0aW1lb3V0ID0gdW5kZWZpbmVkO1xuICAgICAgcmVzb2x2ZShmbiguLi5hcmdzKSk7XG4gICAgfSwgZGVsYXkpO1xuICB9KTtcbn07XG5mdW5jdGlvbiBlc2NhcGVSZWdFeHAoc3RyKSB7XG4gIHJldHVybiBzdHIucmVwbGFjZSgvWy4qKz9eJHt9KCl8W1xcXVxcXFxdL2csIFwiXFxcXCQmXCIpOyAvLyAkJiBtZWFucyB0aGUgd2hvbGUgbWF0Y2hlZCBzdHJpbmdcbn1cbmZ1bmN0aW9uIGlzRGVmaW5lZCh2YWx1ZSkge1xuICByZXR1cm4gdmFsdWUgIT09IHVuZGVmaW5lZCAmJiB2YWx1ZSAhPT0gbnVsbDtcbn1cbi8qKlxuICogU2V0IGEgbWluaW11bSB0aW1lIGZvciBhIHByb21pc2UgdG8gcmVzb2x2ZSAodXNlZnVsIGZvciBwcmV2ZW50aW5nIGZsYXNoIG9mIGxvYWRlcnMpXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIG1pbkRlbGF5KHByb21pc2UsIG1pbkRlbGF5KSB7XG4gIGF3YWl0IFByb21pc2UuYWxsKFtwcm9taXNlLCB0aW1lb3V0KG1pbkRlbGF5KV0pO1xuICByZXR1cm4gcHJvbWlzZTtcbn1cbi8qKlxuICogSGVscGVyIG1ldGhvZCB0byBpbmxpbmUgc2V0VGltZW91dCBhcyBhbiBhd2FpdCBpbiBhc3luYyBmdW5jdGlvbnNcbiAqL1xuZnVuY3Rpb24gdGltZW91dChtcykge1xuICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgbXMpKTtcbn1cbmNvbnN0IGFycmF5VG9Mb29rdXBNYXAgPSAoZGF0YUFyciwgZ2V0S2V5QW5kSXRlbSkgPT4gT2JqZWN0LmZyb21FbnRyaWVzKChkYXRhQXJyIHx8IFtdKS5tYXAoKGl0ZW0pID0+IHtcbiAgY29uc3QgeyBrZXksIGRhdGEgfSA9IGdldEtleUFuZEl0ZW0oaXRlbSk7XG4gIHJldHVybiBba2V5LCBkYXRhXTtcbn0pKTtcbi8qKlxuICogQ2hlY2sgd2hldGhlciB0d28gYXJyYXlzIGhhdmUgdGhlIHNhbWUgbnVtYmVyIG9mIGVsZW1lbnRzXG4gKiBhbmQgd2hldGhlciB0aGV5IGNvbnRhaW4gdGhlIHNhbWUgZWxlbWVudHNcbiAqIHJlZ2FyZGxlc3Mgb2Ygb3JkZXJcbiAqL1xuY29uc3QgYXJyYXlzQXJlRXF1aXZhbGVudCA9IChhcnIxLCBhcnIyKSA9PiBhcnIxLmxlbmd0aCA9PT0gYXJyMi5sZW5ndGggJiYgYXJyMS5yZWR1Y2UoKG1lbW8sIHN0cikgPT4gbWVtbyAmJiBhcnIyLmluZGV4T2Yoc3RyKSA+IC0xLCB0cnVlKTtcbmZ1bmN0aW9uIHVuaXF1ZUJ5KG15QXJyLCBnZXRJdGVtSWQpIHtcbiAgY29uc3QgcmVzdWx0QXJyID0gW107XG4gIGNvbnN0IGxvb2t1cE1hcCA9IHt9O1xuICBteUFyci5mb3JFYWNoKChpdGVtKSA9PiB7XG4gICAgY29uc3QgaWQgPSBnZXRJdGVtSWQoaXRlbSk7XG4gICAgaWYgKGxvb2t1cE1hcFtpZF0gPT0gbnVsbCkge1xuICAgICAgbG9va3VwTWFwW2lkXSA9IGl0ZW07XG4gICAgICByZXN1bHRBcnIucHVzaChpdGVtKTtcbiAgICB9XG4gIH0pO1xuICByZXR1cm4gcmVzdWx0QXJyO1xufVxuZnVuY3Rpb24gdW5pcXVlKG15QXJyKSB7XG4gIGNvbnN0IHByaW1pdGl2ZXMgPSB7IGJvb2xlYW46IHt9LCBudW1iZXI6IHt9LCBzdHJpbmc6IHt9IH07XG4gIGNvbnN0IG9ianMgPSBbXTtcbiAgcmV0dXJuIG15QXJyLmZpbHRlcigoaXRlbSkgPT4ge1xuICAgIGxldCB0eXBlID0gdHlwZW9mIGl0ZW07XG4gICAgaWYgKHR5cGUgaW4gcHJpbWl0aXZlcykge1xuICAgICAgcmV0dXJuIHByaW1pdGl2ZXNbdHlwZV0uaGFzT3duUHJvcGVydHkoaXRlbSkgPyBmYWxzZSA6IChwcmltaXRpdmVzW3R5cGVdW2l0ZW1dID0gdHJ1ZSk7XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgcmV0dXJuIG9ianMuaW5kZXhPZihpdGVtKSA+PSAwID8gZmFsc2UgOiBvYmpzLnB1c2goaXRlbSk7XG4gICAgfVxuICB9KTtcbn1cbmNvbnN0IGNodW5rID0gKGFyciwgc2l6ZSkgPT4gWy4uLkFycmF5KE1hdGguY2VpbChhcnIubGVuZ3RoIC8gc2l6ZSkpXS5tYXAoKF8sIGkpID0+IGFyci5zbGljZShzaXplICogaSwgc2l6ZSArIHNpemUgKiBpKSk7XG5cbmV4cG9ydCB7IGFycmF5VG9Mb29rdXBNYXAgYXMgYSwgdW5pcXVlIGFzIGIsIHRocm90dGxlIGFzIGMsIGRlYm91bmNlIGFzIGQsIGVzY2FwZVJlZ0V4cCBhcyBlLCBhcnJheXNBcmVFcXVpdmFsZW50IGFzIGYsIGNodW5rIGFzIGcsIGlzRGVmaW5lZCBhcyBpLCBtaW5EZWxheSBhcyBtLCB0aW1lb3V0IGFzIHQsIHVuaXF1ZUJ5IGFzIHUgfTtcbiIsIi8qIVxuICogQWxsIG1hdGVyaWFsIGNvcHlyaWdodCBFU1JJLCBBbGwgUmlnaHRzIFJlc2VydmVkLCB1bmxlc3Mgb3RoZXJ3aXNlIHNwZWNpZmllZC5cbiAqIHYzLjAuOTlcbiAqL1xuaW1wb3J0IHsgYyBhcyBjbG9zZXN0RWxlbWVudENyb3NzU2hhZG93Qm91bmRhcnkgfSBmcm9tICcuL2RvbS0xM2Y1YjAwYy5qcyc7XG5pbXBvcnQgeyBsIGFzIGxhbmd1YWdlTWFwIH0gZnJvbSAnLi9sYW5ndWFnZVV0aWwtMjIyNThjOTAuanMnO1xuaW1wb3J0IHsgYSBhcyBnZXRBc3NldFBhdGggfSBmcm9tICcuL2luZGV4LTkyZWJiMzk2LmpzJztcblxuLy8gaHR0cHM6Ly9tZWRpdW0uY29tL3N0ZW5jaWwtdHJpY2tzL2ltcGxlbWVudGluZy1pbnRlcm5hdGlvbmFsaXNhdGlvbi1pMThuLXdpdGgtc3RlbmNpbC01ZTY1NTk1NTQxMTdcbmZ1bmN0aW9uIGdldENvbXBvbmVudENsb3Nlc3RMYW5ndWFnZShlbGVtZW50KSB7XG4gIHZhciBfYSwgX2IsIF9jO1xuICBjb25zdCBjbG9zZXN0RWxlbWVudCA9IChfYSA9IGNsb3Nlc3RFbGVtZW50Q3Jvc3NTaGFkb3dCb3VuZGFyeShlbGVtZW50LCBcIltsYW5nXVwiKSkgIT09IG51bGwgJiYgX2EgIT09IHZvaWQgMCA/IF9hIDogKF9jID0gKF9iID0gZWxlbWVudC5zaGFkb3dSb290KSA9PT0gbnVsbCB8fCBfYiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2Iub3duZXJEb2N1bWVudCkgPT09IG51bGwgfHwgX2MgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9jLmRvY3VtZW50RWxlbWVudDtcbiAgLy8gbGFuZ3VhZ2Ugc2V0IGJ5IHRoZSBjYWxsaW5nIGFwcGxpY2F0aW9uIG9yIGJyb3dzZXIuIGRlZmF1bHRzIHRvIGVuZ2xpc2guXG4gIGNvbnN0IGxhbmcgPSAoKGNsb3Nlc3RFbGVtZW50ID09PSBudWxsIHx8IGNsb3Nlc3RFbGVtZW50ID09PSB2b2lkIDAgPyB2b2lkIDAgOiBjbG9zZXN0RWxlbWVudC5sYW5nKSB8fCAobmF2aWdhdG9yID09PSBudWxsIHx8IG5hdmlnYXRvciA9PT0gdm9pZCAwID8gdm9pZCAwIDogbmF2aWdhdG9yLmxhbmd1YWdlKSB8fCBcImVuXCIpLnRvTG93ZXJDYXNlKCk7XG4gIGlmIChsYW5ndWFnZU1hcC5oYXMobGFuZykpIHtcbiAgICByZXR1cm4gbGFuZ3VhZ2VNYXAuZ2V0KGxhbmcpO1xuICB9XG4gIGVsc2Uge1xuICAgIC8vIFwicnUtUlVcIiBtYXBzIHRvIFwicnVcIiB1c2UgY2FzZVxuICAgIGlmIChsYW5ndWFnZU1hcC5oYXMobGFuZy5zbGljZSgwLCAyKSkpIHtcbiAgICAgIHJldHVybiBsYW5ndWFnZU1hcC5nZXQobGFuZy5zbGljZSgwLCAyKSk7XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgcmV0dXJuIFwiZW5cIjtcbiAgICB9XG4gIH1cbn1cbmZ1bmN0aW9uIGdldENvbXBvbmVudENsb3Nlc3RMYW5ndWFnZUludGwoZWxlbWVudCkge1xuICB2YXIgX2EsIF9iLCBfYztcbiAgLy8gaXQncyBPSyBpZiB3ZSBkb24ndCBoYXZlIHRoZSA0IGxldHRlciBsYW5ndWFnZSBmaWxlIGZvciBpdFxuICAvLyA0IGxldHRlciBsYW5ndWFnZSBjb2RlIG5lZWRlZCBmb3IgZm9ybWF0dGluZyBudW1iZXJzXG4gIGNvbnN0IGNsb3Nlc3RFbGVtZW50ID0gKF9hID0gY2xvc2VzdEVsZW1lbnRDcm9zc1NoYWRvd0JvdW5kYXJ5KGVsZW1lbnQsIFwiW2xhbmddXCIpKSAhPT0gbnVsbCAmJiBfYSAhPT0gdm9pZCAwID8gX2EgOiAoX2MgPSAoX2IgPSBlbGVtZW50LnNoYWRvd1Jvb3QpID09PSBudWxsIHx8IF9iID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYi5vd25lckRvY3VtZW50KSA9PT0gbnVsbCB8fCBfYyA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2MuZG9jdW1lbnRFbGVtZW50O1xuICAvLyBsYW5ndWFnZSBzZXQgYnkgdGhlIGNhbGxpbmcgYXBwbGljYXRpb24gb3IgYnJvd3Nlci4gZGVmYXVsdHMgdG8gZW5nbGlzaC5cbiAgY29uc3QgbGFuZyA9ICgoY2xvc2VzdEVsZW1lbnQgPT09IG51bGwgfHwgY2xvc2VzdEVsZW1lbnQgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGNsb3Nlc3RFbGVtZW50LmxhbmcpIHx8IChuYXZpZ2F0b3IgPT09IG51bGwgfHwgbmF2aWdhdG9yID09PSB2b2lkIDAgPyB2b2lkIDAgOiBuYXZpZ2F0b3IubGFuZ3VhZ2UpIHx8IFwiZW5cIikudG9Mb3dlckNhc2UoKTtcbiAgaWYgKGxhbmd1YWdlTWFwLmhhcyhsYW5nKSkge1xuICAgIHJldHVybiBsYW5ndWFnZU1hcC5nZXQobGFuZyk7XG4gIH1cbiAgZWxzZSB7XG4gICAgaWYgKGxhbmd1YWdlTWFwLmhhcyhsYW5nLnNsaWNlKDAsIDIpKSkge1xuICAgICAgLy8gd2Ugc3VwcG9ydCB0aGUgMiBsZXR0ZXIgY29kZWQgbGFuZ3VhZ2VcbiAgICAgIC8vIGUuZy4gaXQtQ0ggdnMgaXRcbiAgICAgIHJldHVybiBsYW5nO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgIHJldHVybiBcImVuXCI7XG4gICAgfVxuICB9XG59XG5mdW5jdGlvbiBmZXRjaExvY2FsZVN0cmluZ3NGb3JDb21wb25lbnQoY29tcG9uZW50TmFtZSwgbG9jYWxlKSB7XG4gIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgZmV0Y2goZ2V0QXNzZXRQYXRoKGAuLi9hcmNnaXMtYXBwLWFzc2V0cy9pMThuLyR7Y29tcG9uZW50TmFtZX0uaTE4bi4ke2xvY2FsZX0uanNvbmApKS50aGVuKChyZXN1bHQpID0+IHtcbiAgICAgIGlmIChyZXN1bHQub2spXG4gICAgICAgIHJlc29sdmUocmVzdWx0Lmpzb24oKSk7XG4gICAgICBlbHNlXG4gICAgICAgIHJlamVjdCgpO1xuICAgIH0sICgpID0+IHJlamVjdCgpKTtcbiAgfSk7XG59XG5jb25zdCBzdHJpbmdDYWNoZSA9IHt9O1xuZnVuY3Rpb24gZmV0Y2hMb2NhbGVTdHJpbmdzRnJvbUNhY2hlKGNvbXBvbmVudE5hbWUsIGxvY2FsZSkge1xuICBjb25zdCBpZCA9IGAke2NvbXBvbmVudE5hbWV9JHtsb2NhbGV9YDtcbiAgaWYgKCFzdHJpbmdDYWNoZVtpZF0pIHtcbiAgICBzdHJpbmdDYWNoZVtpZF0gPSBmZXRjaExvY2FsZVN0cmluZ3NGb3JDb21wb25lbnQoY29tcG9uZW50TmFtZSwgbG9jYWxlKTtcbiAgfVxuICByZXR1cm4gc3RyaW5nQ2FjaGVbaWRdO1xufVxuLyoqXG4gKiBHZXQgc3RyaW5ncyBhbmQgbGFuZ3VhZ2UgY29kZXMuXG4gKiBUaGlzIG1ldGhvZCByZXR1cm5zIDIgbGFuZ3VhZ2UgY29kZXMuXG4gKiBUaGUgZmlyc3Qgb25lIHJldHVybnMgYSBjb2RlIHRoYXQncyBhbHNvIHN1cHBvcnRlZCBhcyBhIGxhbmd1YWdlIGZpbGUuXG4gKiBUaGUgc2Vjb25kIG9uZSByZXR1cm5zIGEgY29kZSB3aGVyZSB0aGVyZSBpcyBzdXBwb3J0IGZvciB0aGUgZmlyc3QgMiBsZXR0ZXJzIG9mIHRoZSBjb2RlIGFzIHBhcnQgb2YgYSBsYW5ndWFnZSBmaWxlLFxuICogYnV0IHdpbGwgcmV0dXJuIHRoZSBvcmlnaW5hbCA0IGxldHRlciBjb2RlIGZyb20gdGhlIHBhZ2UuXG4gKiBFLmcuIEZvciBcIml0LWNoXCIgaXQgd2lsbCByZXR1cm4gXCJpdFwiIGFzIHRoZSBmaXJzdCBsYW5ndWFnZSBjb2RlIGFuZCBcIml0LWNoXCIgYXMgdGhlIHNlY29uZC5cbiAqIFRoZSBzZWNvbmQgb25lIGlzIHJlcXVpcmVkIGZvciBlc3JpLmludGwuc2V0TG9jYWxlKCkgdG8gZ2V0IHRoZSBjb3JyZWN0IGZvcm1hdHRpbmcuXG4gKlxuICogSWYgYSB0YWdOYW1lIGlzIHByb3ZpZGVkIGl0IHdpbGwgb3ZlcndpdGUgdGhlIGVsZW1lbnQncyB0YWdOYW1lXG4gKlxuICogIEByZXR1cm4gWyBzdHJpbmdzLCBmaXJzdCBsYW5ndWFnZSBjb2RlLCBzZWNvbmQgbGFuZ3VhZ2UgY29kZV1cbiAqL1xuYXN5bmMgZnVuY3Rpb24gZ2V0TG9jYWxlQ29tcG9uZW50U3RyaW5ncyhlbGVtZW50LCB0YWdOYW1lKSB7XG4gIGNvbnN0IGNvbXBvbmVudE5hbWUgPSB0YWdOYW1lIHx8IGVsZW1lbnQudGFnTmFtZS50b0xvd2VyQ2FzZSgpO1xuICBjb25zdCBjb21wb25lbnRMYW5ndWFnZSA9IGdldENvbXBvbmVudENsb3Nlc3RMYW5ndWFnZShlbGVtZW50KTtcbiAgY29uc3QgY29tcG9uZW50TGFuZ3VhZ2VJbnRsID0gZ2V0Q29tcG9uZW50Q2xvc2VzdExhbmd1YWdlSW50bChlbGVtZW50KTtcbiAgbGV0IHN0cmluZ3M7XG4gIHRyeSB7XG4gICAgc3RyaW5ncyA9IGF3YWl0IGZldGNoTG9jYWxlU3RyaW5nc0Zyb21DYWNoZShjb21wb25lbnROYW1lLCBjb21wb25lbnRMYW5ndWFnZSk7XG4gIH1cbiAgY2F0Y2ggKGUpIHtcbiAgICBjb25zb2xlLndhcm4oYG5vIGxvY2FsZSBmb3IgJHtjb21wb25lbnROYW1lfSAoJHtjb21wb25lbnRMYW5ndWFnZX0pIGxvYWRpbmcgZGVmYXVsdCBsb2NhbGUgZW4uYCk7XG4gICAgc3RyaW5ncyA9IGF3YWl0IGZldGNoTG9jYWxlU3RyaW5nc0Zyb21DYWNoZShjb21wb25lbnROYW1lLCBcImVuXCIpO1xuICB9XG4gIHJldHVybiBbc3RyaW5ncywgY29tcG9uZW50TGFuZ3VhZ2UsIGNvbXBvbmVudExhbmd1YWdlSW50bF07XG59XG5cbmV4cG9ydCB7IGdldENvbXBvbmVudENsb3Nlc3RMYW5ndWFnZSBhcyBhLCBnZXRMb2NhbGVDb21wb25lbnRTdHJpbmdzIGFzIGcgfTtcbiJdLCJuYW1lcyI6W10sInNvdXJjZVJvb3QiOiIifQ==
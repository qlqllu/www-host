"use strict";
(self["webpackChunkexb_client"] = self["webpackChunkexb_client"] || []).push([["vendors-extensions_widgets_arcgis_analysis_node_modules_arcgis_app-components_dist_esm_arcgis-98bdc7"],{

/***/ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/arcgis-item-share.entry.js":
/*!********************************************************************************************************************!*\
  !*** ./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/arcgis-item-share.entry.js ***!
  \********************************************************************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   arcgis_item_share: () => (/* binding */ ArcgisItemShare)
/* harmony export */ });
/* harmony import */ var _index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./index-92ebb396.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/index-92ebb396.js");
/* harmony import */ var _services_adddeef9_js__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./services-adddeef9.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/services-adddeef9.js");
/* harmony import */ var _config_eb5f7dc2_js__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./config-eb5f7dc2.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/config-eb5f7dc2.js");
/* harmony import */ var _functional_c82f5ab9_js__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ./functional-c82f5ab9.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/functional-c82f5ab9.js");
/* harmony import */ var _locale_13e00a75_js__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ./locale-13e00a75.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/locale-13e00a75.js");
/* harmony import */ var _privileges_ccd5f37d_js__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! ./privileges-ccd5f37d.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/privileges-ccd5f37d.js");
/* harmony import */ var _item_d9d70416_js__WEBPACK_IMPORTED_MODULE_6__ = __webpack_require__(/*! ./item-d9d70416.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/item-d9d70416.js");
/* harmony import */ var _utils_fba8960d_js__WEBPACK_IMPORTED_MODULE_7__ = __webpack_require__(/*! ./utils-fba8960d.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/utils-fba8960d.js");
/* harmony import */ var _server_item_f12153e6_js__WEBPACK_IMPORTED_MODULE_8__ = __webpack_require__(/*! ./server-item-f12153e6.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/server-item-f12153e6.js");
/* harmony import */ var _portal_79caaeff_js__WEBPACK_IMPORTED_MODULE_9__ = __webpack_require__(/*! ./portal-79caaeff.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/portal-79caaeff.js");
/* harmony import */ var _loadModules_aaf30bd6_js__WEBPACK_IMPORTED_MODULE_10__ = __webpack_require__(/*! ./loadModules-aaf30bd6.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/loadModules-aaf30bd6.js");
/* harmony import */ var _item_properties_e6412a9a_js__WEBPACK_IMPORTED_MODULE_11__ = __webpack_require__(/*! ./item-properties-e6412a9a.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/item-properties-e6412a9a.js");
/* harmony import */ var _index_81d548b7_js__WEBPACK_IMPORTED_MODULE_12__ = __webpack_require__(/*! ./index-81d548b7.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/index-81d548b7.js");
/* harmony import */ var _add_item_97d577a9_js__WEBPACK_IMPORTED_MODULE_13__ = __webpack_require__(/*! ./add-item-97d577a9.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/add-item-97d577a9.js");
/* harmony import */ var _ui_ecf86bba_js__WEBPACK_IMPORTED_MODULE_14__ = __webpack_require__(/*! ./ui-ecf86bba.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/ui-ecf86bba.js");
/* harmony import */ var _functional_9f648bee_js__WEBPACK_IMPORTED_MODULE_15__ = __webpack_require__(/*! ./functional-9f648bee.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/functional-9f648bee.js");
/* harmony import */ var _item_types_b4fe86ad_js__WEBPACK_IMPORTED_MODULE_16__ = __webpack_require__(/*! ./item-types-b4fe86ad.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/item-types-b4fe86ad.js");
/* harmony import */ var _dom_13f5b00c_js__WEBPACK_IMPORTED_MODULE_17__ = __webpack_require__(/*! ./dom-13f5b00c.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/dom-13f5b00c.js");
/* harmony import */ var _languageUtil_22258c90_js__WEBPACK_IMPORTED_MODULE_18__ = __webpack_require__(/*! ./languageUtil-22258c90.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/languageUtil-22258c90.js");
/*!
 * All material copyright ESRI, All Rights Reserved, unless otherwise specified.
 * v3.0.99
 */




















const arcgisItemShareCss = ".stage{height:100%}.group-browser-modal{--calcite-modal-width:1080px;--calcite-modal-content-padding:0}arcgis-group-browser{height:min(700px, 60vh)}.hidden{display:none}.section:not(:last-child){margin-bottom:2rem}calcite-flow{height:100%}.content-container{margin-top:0.5rem}.active-but-not-selected{position:relative;z-index:2}.tile-select-wrapper{position:relative}.share-hint{display:flex;align-items:center;position:absolute;font-size:0.875rem;inset-inline-end:0.5rem;top:0.5rem;z-index:3}.share-hint>p{margin-top:0;margin-bottom:0;-webkit-margin-start:0.5rem;margin-inline-start:0.5rem;margin-top:2px}.information-text{font-weight:500;margin-top:0;margin-bottom:0;margin-top:0.5rem;font-size:0.875rem}.group-item-counter{font-size:0.875rem;margin-top:0;margin-bottom:0}.revert-single-group-cta:first-child,.group-item-counter:first-child{-webkit-margin-start:0.5rem;margin-inline-start:0.5rem}";

const ArcgisItemShare = class {
  constructor(hostRef) {
    (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.r)(this, hostRef);
    this.workflowCancel = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "workflowCancel", 7);
    this.workflowComplete = (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "workflowComplete", 7);
    this.initialShareLevels = [];
    this.initialSelectedGroupData = [];
    /**
     * Selected by all items, some items or no items
     *
     * Used to determine if we should show the revert button on each group card
     *  */
    this.initialSelectedGroupDataLookup = {};
    this.showOptions = false;
    this.shareLevelOptions = ["private", "org", "public"];
    this.possibleShareLevelOptions = [
      "private",
      "org",
      "public"
    ];
    this.shareLevelIcon = {
      private: "user",
      org: "organization",
      public: "globe"
    };
    this.isPublicUser = false;
    this.hasItemBlockedFromPublic = false;
    this.hasPrivateItem = false;
    this.shareMode = "default";
    this.hasIndoorsSpaces = false;
    this.sharingDetailToEmit = null;
    this.didUpdateSharingDetail = false;
    this.shareItemResult = null;
    this.handleNewShareResult = async () => {
      const { items, portal, shareItemResult: { newShareLevel, newGroupShared }, 
      // This should already have the latest update
      selectedGroupData } = this;
      // * Reset item to get ready for the review sharing state
      let newItems = [...items];
      if (newShareLevel != null) {
        newItems = items.map((item) => {
          if (newShareLevel !== "private") {
            return Object.assign(Object.assign({}, item), { access: newShareLevel });
          }
          // If the new level is private but the item is currently shared to a group,
          //  we need to make sure it's marked as "shared" instead of "private"
          const isItemCurrentlySharedToGroups = selectedGroupData === null || selectedGroupData === void 0 ? void 0 : selectedGroupData.some(({ selectedByItemIds }) => selectedByItemIds.includes(item.id));
          return Object.assign(Object.assign({}, item), { access: isItemCurrentlySharedToGroups ? "shared" : "private" });
        });
      }
      // If we're not sharing to any group, we need to make sure every "shared" item is marked as "private"
      if (!(selectedGroupData === null || selectedGroupData === void 0 ? void 0 : selectedGroupData.length)) {
        newItems = newItems.map((item) => item.access === "shared" ? Object.assign(Object.assign({}, item), { access: "private" }) : item);
      }
      // And vice versa if we're (fully) sharing to at least one new group
      if (newGroupShared.length) {
        newItems = newItems.map((item) => item.access === "private" ? Object.assign(Object.assign({}, item), { access: "shared" }) : item);
      }
      this.items = newItems;
      // * Analyze and decide whether we should show the dep check dialog
      const analyzeResults = await Promise.all(newItems.map((item) => (0,_services_adddeef9_js__WEBPACK_IMPORTED_MODULE_1__.a)(item, portal)));
      const newShareDetail = analyzeResults.reduce((acc, { result }) => {
        if (result) {
          Object.keys(result).forEach((key) => {
            acc[key] = [...acc[key], ...result[key]];
          });
        }
        return acc;
      }, Object.assign({}, _utils_fba8960d_js__WEBPACK_IMPORTED_MODULE_7__.D));
      this.sharingDetail = newShareDetail;
      // The watch for `hasSharingIssue` will be automatically triggered next
    };
    // * Other utils and renders
    this.updateSharing = async () => {
      var _a;
      this.loadingText = this.i18n.updatingInfo;
      this.isLoading = true;
      const { items, selectedShareLevels, initialSelectedGroupData, selectedGroupData, portal, user, isShareLevelDirty, checkItemPDCIssue, confirmedPDC } = this;
      const { shareGroupIds, unshareGroupIds } = (0,_utils_fba8960d_js__WEBPACK_IMPORTED_MODULE_7__.g)(initialSelectedGroupData, selectedGroupData);
      if (!confirmedPDC && !(await checkItemPDCIssue())) {
        return;
      }
      // ! This assume that all items have the same share level once the user choose something
      const newShareLevel = isShareLevelDirty || items.length === 1 ? selectedShareLevels[0] : null;
      // Need to unshare first in case the user is public
      // (public user can only share to group if the share level is public)
      const unsharePromise = unshareGroupIds.length
        ? (0,_services_adddeef9_js__WEBPACK_IMPORTED_MODULE_1__.u)(items.map((item) => item.id), unshareGroupIds, { portal, user })
        : undefined;
      const sharePromise = shareGroupIds.length || isShareLevelDirty
        ? (0,_services_adddeef9_js__WEBPACK_IMPORTED_MODULE_1__.b)(items, newShareLevel, shareGroupIds, { portal, user })
        : undefined;
      const [shareResult] = await Promise.all([sharePromise, unsharePromise]);
      // ! We don't set loading to false in case the consumers want to keep loading
      // They can remove the modal completely
      // * ---
      const shareItemResult = {
        // TODO: hair splitting this since different items can lead to different results
        newGroupShared: shareGroupIds.filter((id) => !(shareResult === null || shareResult === void 0 ? void 0 : shareResult.result.some(({ notSharedWith }) => notSharedWith.includes(id)))),
        newGroupUnshared: unshareGroupIds,
        newShareLevel,
        shareErrors: (_a = shareResult === null || shareResult === void 0 ? void 0 : shareResult.result.filter(({ error }) => error).map(({ itemId }) => {
          return { item: items.find((curItem) => curItem.id === itemId), code: "notSharedWith" };
        })) !== null && _a !== void 0 ? _a : []
      };
      this.shareItemResult = shareItemResult;
      this.handleNewShareResult();
    };
    this.checkItemPDCIssue = async () => {
      const { items, portal, isShareLevelDirty, selectedShareLevels } = this;
      const hostedItems = items.filter((item) => (0,_item_d9d70416_js__WEBPACK_IMPORTED_MODULE_6__.i)(item.typeKeywords, item.type));
      // ! If the share level is dirty, this means the share level is selected to something else
      //  meaning all the share level is converged to the same level since that's the only use case
      const publicOptionSelected = isShareLevelDirty && selectedShareLevels[0] === "public";
      /**
       * if we have hosted services and we're sharing publicly, check for editable layers and warn user
       * WebGIS/arcgis-portal-app#27002, WebGIS/arcgis-portal-app#26285
       */
      if (hostedItems.length > 0 && publicOptionSelected) {
        this.isLoading = true;
        const editableCheck = await Promise.all(hostedItems.map((item) => (0,_item_d9d70416_js__WEBPACK_IMPORTED_MODULE_6__.e)(item, portal)));
        this.isLoading = false;
        const editableItems = hostedItems.filter((_, index) => editableCheck[index]);
        if (editableItems.length) {
          const publicDataCollectionDisabled = !editableItems.every((item) => item.typeKeywords.includes("Public Data Collection"));
          this.confirmationDialogType = publicDataCollectionDisabled
            ? "publicDataCollectionDisabled"
            : "publicDataCollectionEnabled";
          return false;
        }
      }
      return true;
    };
    this.handleNewPendingSelectedGroups = (newGroups) => {
      const { items, pendingGroupBrowserData, selectedGroupData } = this;
      const curSelectedGroupLookup = (0,_functional_c82f5ab9_js__WEBPACK_IMPORTED_MODULE_3__.a)(pendingGroupBrowserData.groupData, (groupData) => ({
        key: groupData.group.id,
        data: groupData
      }));
      const allItemIds = items.map((item) => item.id);
      const newSelectedGroupData = newGroups.map((group) => {
        // If the group was previously selected, use the previous data
        //  else set selectedByItemIds to all items' ids
        const prevGroupData = curSelectedGroupLookup[group.id];
        if (prevGroupData) {
          return prevGroupData;
        }
        return { group, selectedByItemIds: allItemIds };
      });
      this.pendingGroupBrowserData = {
        groupData: newSelectedGroupData,
        groupDataLookup: (0,_functional_c82f5ab9_js__WEBPACK_IMPORTED_MODULE_3__.a)(newSelectedGroupData, (groupData) => ({
          key: groupData.group.id,
          data: true
        })),
        groupCount: newSelectedGroupData.reduce((acc, cur) => {
          acc[cur.group.id] = cur.selectedByItemIds.length;
          return acc;
        }, {}),
        isDirty: (0,_utils_fba8960d_js__WEBPACK_IMPORTED_MODULE_7__.i)(newSelectedGroupData, selectedGroupData)
      };
    };
    this.revertShareLevel = () => {
      this.selectedShareLevels = [...this.initialShareLevels];
    };
    this.setShareLevel = (newShareLevel) => {
      this.selectedShareLevels = this.selectedShareLevels.map(() => newShareLevel);
    };
    this.revertGroupData = () => {
      this.selectedGroupData = [...this.initialSelectedGroupData];
    };
    this.revertPendingGroupData = (groupId) => {
      const { initialSelectedGroupData, pendingGroupBrowserData, handleNewPendingSelectedGroups } = this;
      const initialGroupData = initialSelectedGroupData.find(({ group }) => group.id === groupId);
      const curGroupData = pendingGroupBrowserData.groupData;
      const curSelectedGroupData = curGroupData.find(({ group }) => group.id === groupId);
      let newGroupData = [];
      if (!initialGroupData) {
        // This means initially we don't have this group
        newGroupData = curGroupData.filter(({ group }) => group.id !== groupId);
      }
      else if (!curSelectedGroupData) {
        // This means we removed the group
        newGroupData = [...curGroupData, initialGroupData];
      }
      else {
        newGroupData = curGroupData.map((groupData) => {
          if (groupData.group.id !== groupId) {
            return groupData;
          }
          return initialGroupData;
        });
      }
      handleNewPendingSelectedGroups(newGroupData.map(({ group }) => group));
    };
    this.applyPendingGroupData = () => {
      this.selectedGroupData = [...this.pendingGroupBrowserData.groupData];
      this.unBrowseGroups();
    };
    this.closeDialog = (event) => {
      var _a, _b;
      // Stop the close event from arcgis-dependency-check from propagating
      event === null || event === void 0 ? void 0 : event.stopPropagation();
      const { workflowCancel, currentStep } = this;
      if (currentStep !== "finish") {
        workflowCancel.emit({
          newShareLevel: (_b = (_a = this.shareItemResult) === null || _a === void 0 ? void 0 : _a.newShareLevel) !== null && _b !== void 0 ? _b : null,
          cancelAtStep: currentStep
        });
      }
    };
    this.unBrowseGroups = () => {
      this.isBrowsingGroups = false;
    };
    this.renderGroupBrowser = () => {
      const { api, i18n, user, portal, config, pendingGroupBrowserData, browserPagination, browserGroups, handleNewPendingSelectedGroups, isBrowsingGroups, isPublicUser, items, shareMode, groupBrowserQ, initialSelectedGroupDataLookup, revertPendingGroupData, hasIndoorsSpaces, groupBrowserAllUsers, groupBrowserSearchUsername, hasPrivateItem } = this;
      const totalItemCount = items.length;
      const showFilterByUsers = shareMode === "admin" && !hasPrivateItem && groupBrowserAllUsers.length > 1;
      return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-group-browser", { view: "compact", class: { hidden: !isBrowsingGroups }, config: config, user: user, api: api, portal: portal, selection: "multiple", searchUser: groupBrowserSearchUsername, selectedGroups: pendingGroupBrowserData.groupData.map((data) => data.group), hasIndoorsSpaces: hasIndoorsSpaces, q: groupBrowserQ, onArcgisGroupBrowserUpdate: (e) => {
          const { results, num, start, total } = e.detail;
          // TODO: remove this assert
          this.browserGroups = results;
          this.browserPagination = { start, num, total };
        }, onArcgisGroupBrowserLoading: () => {
          this.browserGroups = [];
        }, onArcgisGroupBrowserSelect: (e) => handleNewPendingSelectedGroups(e.detail) }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-group-browser-top-bar", { slot: "top-bar", "filter-toggle": true }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-group-browser-search", { slot: "search", term: "" })), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-group-browser-sort", { slot: "sort" }), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-group-browser-filters", { slot: "filters" }, showFilterByUsers && ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-group-browser-filter-groups-by-user", { searchUsernames: groupBrowserAllUsers.map((user) => user.username), searchUsername: groupBrowserSearchUsername, onArcgisGroupBrowserUsernamesFilter: (event) => {
          this.groupBrowserSearchUsername = event.detail;
        } })), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-group-browser-filter-owner", { searchUsername: groupBrowserSearchUsername }), !isPublicUser && ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)(_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.F, null, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-group-browser-filter-membership", null), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-group-browser-filter-member-org", null), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-group-browser-filter-special-groups", null))), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-group-browser-filter-date", { property: "modified" }), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-group-browser-filter-date", { property: "created" })), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-group-browser-content", { slot: "content", class: "js-content" }, (browserGroups || []).map((group) => {
        const groupId = group.id;
        return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-item-share-group-card", { key: groupId, user: user, portal: portal, i18n: i18n, group: group, groupCount: pendingGroupBrowserData.groupCount, initialSelectedGroupDataLookup: initialSelectedGroupDataLookup, selectedGroupDataLookup: pendingGroupBrowserData.groupDataLookup, totalItemCount: totalItemCount, onRevertClick: () => {
            // By opening the group browser, the public user already have
            //  to switch the share to PUBLIC already so there is no need
            //  to spin up the confirmation modal
            revertPendingGroupData(groupId);
          } }));
      })), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-group-browser-pagination", { slot: "pagination", class: "js-pagination", total: browserPagination === null || browserPagination === void 0 ? void 0 : browserPagination.total, start: browserPagination === null || browserPagination === void 0 ? void 0 : browserPagination.start, num: browserPagination === null || browserPagination === void 0 ? void 0 : browserPagination.num })));
    };
    this.renderShareSelectGroup = () => {
      const { config, hasItemBlockedFromPublic, hasSingleShareLevel, i18n, initialSelectedGroupData, isBrowsingGroups, isLoading, isPublicUser, isShareLevelDirty, items, loadingText, portal, possibleShareLevelOptions, revertGroupData, revertShareLevel, selectedGroupData, selectedShareLevels, setShareLevel, shareLevelCount, shareLevelIcon, shareLevelOptions, shareMode, showOptions, user, hasPrivateItem } = this;
      const totalItemCount = items.length;
      const totalItemCountStr = totalItemCount.toString();
      const disabledText = hasItemBlockedFromPublic
        ? i18n.sharingLimitedItemDisclaimer
        : i18n.cannotShareToLevelDisclaimer;
      return (
      // ! Hidden instead of unmount to prevent data refetch
      (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: { hidden: isBrowsingGroups } }, isLoading && (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-new-item-loader", { active: isLoading, text: loadingText }), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "section" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-new-item-description", { header: i18n.shareLevel.title, headerSideContent: isShareLevelDirty && ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { appearance: "transparent", iconStart: "reset", disabled: isLoading, onClick: () => {
            // if a public user tries to revert item levels
            // and the initial share level includes at least one private item
            // and those items have also been shared to groups
            // display a warning modal
            if ((0,_utils_fba8960d_js__WEBPACK_IMPORTED_MODULE_7__.c)(user, items, selectedGroupData)) {
              this.confirmationDialogType = "publicAccountRevertShareLevel";
              return;
            }
            revertShareLevel();
          } }, i18n.revert)) }), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "content-container" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-tile-select-group", { layout: "vertical", class: "tile-select" }, showOptions &&
        _utils_fba8960d_js__WEBPACK_IMPORTED_MODULE_7__.d.map((option) => {
          const cannotSelect = !possibleShareLevelOptions.includes(option);
          if (cannotSelect && isPublicUser) {
            // We only want to hide the option for public user
            //  in other cases, we just want to disable them
            return null;
          }
          const itemCount = shareLevelCount[option] + (option === "private" ? shareLevelCount.shared : 0);
          const hasItemInCategory = itemCount > 0;
          const itemCountStr = itemCount.toString();
          const title = i18n.shareLevel.level[option].title;
          return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "tile-select-wrapper", key: option }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-tile-select", { checked: hasSingleShareLevel && hasItemInCategory, heading: title, "aria-label": cannotSelect ? disabledText : undefined, description: i18n.shareLevel.level[option][
            // public users have a different text description for the "everyone" share level (WebGIS/arcgis-portal-app#26405)
            isPublicUser && option === "public"
              ? "descriptionPublicUser"
              : "description"], name: "dev-cred-create-mode", inputEnabled: true, width: "full", type: "radio", value: option, icon: shareLevelIcon[option], disabled: isLoading || cannotSelect, class: {
              "active-but-not-selected": hasItemInCategory && !hasSingleShareLevel
            }, onCalciteTileSelectChange: (e) => {
              const newShareLevel = e.target.value;
              // if a public user tries to set item(s) to private
              // and the items are shared to groups
              // display a warning modal
              if ((0,_utils_fba8960d_js__WEBPACK_IMPORTED_MODULE_7__.e)(user, newShareLevel, selectedGroupData)) {
                this.confirmationDialogType = "publicAccountSetShareToPrivate";
                return;
              }
              setShareLevel(newShareLevel);
            } }), !hasSingleShareLevel && hasItemInCategory && ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "share-hint" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-information", { label: i18n.shareCountLabel, paddedContent: true, placement: "bottom-end", overlayPositioning: "fixed" }, i18n.shareCountTooltip
            .replace("${shareLevel}", title)
            .replace("${numItem}", itemCountStr)
            .replace("${totalItem}", totalItemCountStr)), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("p", null, i18n.shareCountHint
            .replace("${numItem}", itemCountStr)
            .replace("${totalItem}", totalItemCountStr))))));
        })), showOptions && possibleShareLevelOptions.length < shareLevelOptions.length && ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("p", { class: "information-text" }, i18n.sharingLimitedDisclaimer)), (!showOptions || !possibleShareLevelOptions.length) && ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("p", { class: "information-text" }, i18n.noShareDisclaimer)))), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "section" }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-item-share-group", { items: items, user: user, portal: portal, config: config, shareMode: shareMode, i18n: i18n.shareGroup, isLoading: isLoading, onEditGroupClick: () => {
          // Public account needs to share item to public before sharing to groups
          if ((0,_utils_fba8960d_js__WEBPACK_IMPORTED_MODULE_7__.s)(user, selectedShareLevels)) {
            this.confirmationDialogType = "publicAccountOpenGroupBrowser";
            return;
          }
          this.isBrowsingGroups = true;
        }, onAnalyzeUserGroupComplete: (e) => {
          const { initialSelectedGroups: selectedGroupData, userGroupLookup, allUsers, searchUsername } = e.detail;
          this.initialSelectedGroupData = selectedGroupData;
          this.selectedGroupData = selectedGroupData;
          this.initialSelectedGroupDataLookup = (0,_functional_c82f5ab9_js__WEBPACK_IMPORTED_MODULE_3__.a)(selectedGroupData, ({ group, selectedByItemIds }) => ({
            key: group.id,
            data: selectedByItemIds.length === 0
              ? "none"
              : selectedByItemIds.length === totalItemCount
                ? "all"
                : "indeterminate"
          }));
          this.groupBrowserSearchUsername = searchUsername;
          this.groupBrowserAllUsers = allUsers;
          this.groupBrowserQ = (0,_utils_fba8960d_js__WEBPACK_IMPORTED_MODULE_7__.a)({
            shareMode,
            currentUsername: searchUsername,
            user,
            userGroupLookup,
            isPrivate: hasPrivateItem
          });
        }, onDirtyChange: (e) => (this.isSelectedGroupsDirty = e.detail), onRemoveClick: () => (this.selectedGroupData = []), onRevertClick: () => {
          if ((0,_utils_fba8960d_js__WEBPACK_IMPORTED_MODULE_7__.b)(user, selectedShareLevels, initialSelectedGroupData)) {
            this.confirmationDialogType = "publicAccountRevertGroup";
            return;
          }
          revertGroupData();
        }, selectedGroupData: selectedGroupData }))));
    };
    this.renderShareModal = () => {
      const { closeDialog, i18n, isLoading, updateSharing, isShareLevelDirty, isSelectedGroupsDirty, isBrowsingGroups, applyPendingGroupData, unBrowseGroups, renderShareSelectGroup, renderGroupBrowser, currentStep, hasSharingIssue, pendingGroupBrowserData } = this;
      const hasChanges = isShareLevelDirty || isSelectedGroupsDirty;
      return ((currentStep === "share" || hasSharingIssue === null) && ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-modal", { onCalciteModalClose: closeDialog,
        // ! Don't use the condition directly here or the `onCalciteModalClose` will be triggered
        open: true, width: isBrowsingGroups ? "m" : "s", outsideCloseDisabled: true, escapeDisabled: true, class: { "group-browser-modal": isBrowsingGroups } }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { slot: "header" }, i18n[isBrowsingGroups ? "titleGroup" : "title"]), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { slot: "content", class: "stage" }, renderGroupBrowser(), renderShareSelectGroup()), !isBrowsingGroups ? ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)(_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.F, null, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { slot: "primary", appearance: "outline", kind: "brand", "data-id": "cancelButton", onClick: () => closeDialog(), width: "full" }, i18n.cancel), hasChanges && ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { slot: "secondary", appearance: "solid", kind: "brand", "data-id": "nextButton", onClick: updateSharing, width: "full", disabled: isLoading }, i18n.save)))) : ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)(_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.F, null, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { slot: "primary", appearance: "outline", kind: "brand", "data-id": "cancelButton", onClick: unBrowseGroups, width: "full" }, i18n.cancel), pendingGroupBrowserData.isDirty && ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { slot: "secondary", appearance: "solid", kind: "brand", onClick: applyPendingGroupData, width: "full" }, i18n.apply)))))));
    };
    this.renderDepCheckModal = () => {
      const { api, config, portal, user, items, closeDialog, hasSharingIssue, sharingDetail } = this;
      return (hasSharingIssue && ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-dependency-check", { api: api, items: items.map((item) => ({ item })), portal: portal, user: user, config: config,
        // ! Don't use the condition directly here or the `onCalciteModalClose` will be triggered
        isActive: true, preProcessedSharingDetail: sharingDetail, onWorkflowCancel: closeDialog, onWorkflowComplete: (event) => {
          event.stopPropagation();
          this.didUpdateSharingDetail = true;
          // We don't call this since we just want to close the modal
          //  but if we want to show any underlying issue after recheck, we can enable it
          // checkSharingIssue(selectedItems);
          // Revert sharing detail to trigger the end state
          this.sharingDetailToEmit = Object.assign({}, sharingDetail);
          this.sharingDetail = Object.assign({}, _utils_fba8960d_js__WEBPACK_IMPORTED_MODULE_7__.D);
        } })));
    };
    this.renderConfirmationDialog = () => {
      const { confirmationDialogType } = this;
      if (!confirmationDialogType) {
        return null;
      }
      const { i18n, isLoading, revertShareLevel, setShareLevel, revertGroupData } = this;
      const { title, description } = i18n.shareWarning[confirmationDialogType];
      const isPDCDisabledError = confirmationDialogType === "publicDataCollectionDisabled";
      return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-modal", { onCalciteModalClose: (event) => {
          event.stopPropagation();
          this.confirmationDialogType = null;
        }, open: !!this.confirmationDialogType, width: "s", outsideCloseDisabled: true, escapeDisabled: true }, (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { slot: "header", class: "header" }, title), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { slot: "content" }, description), (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { slot: "primary", appearance: isPDCDisabledError ? "solid" : "outline", kind: "brand", "data-id": "cancelButton", onClick: () => (this.confirmationDialogType = null), width: "full" }, i18n[isPDCDisabledError ? "ok" : "cancel"]), !isPDCDisabledError && ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { slot: "secondary", appearance: "solid", kind: "brand", "data-id": "nextButton", onClick: () => {
          switch (confirmationDialogType) {
            case "publicAccountOpenGroupBrowser":
              setShareLevel("public");
              this.isBrowsingGroups = true;
              break;
            case "publicAccountSetShareToPrivate":
              setShareLevel("private");
              this.selectedGroupData = [];
              break;
            case "publicAccountRevertShareLevel":
              revertShareLevel();
              this.selectedGroupData = [];
              break;
            case "publicAccountRevertGroup":
              setShareLevel("public");
              revertGroupData();
              break;
            case "publicDataCollectionEnabled":
              this.confirmedPDC = true;
              this.updateSharing();
              break;
          }
          this.confirmationDialogType = null;
        }, width: "full", disabled: isLoading }, i18n.update))));
    };
    this.api = undefined;
    this.user = undefined;
    this.portal = undefined;
    this.config = undefined;
    this.items = undefined;
    this.hasTrustedOrgs = false;
    this.isLoading = undefined;
    this.selectedShareLevels = [];
    this.isShareLevelDirty = false;
    this.shareLevelCount = {
      private: 0,
      shared: 0,
      org: 0,
      public: 0
    };
    this.hasSingleShareLevel = false;
    this.selectedGroupData = [];
    this.isSelectedGroupsDirty = false;
    this.loadingText = null;
    this.isBrowsingGroups = false;
    this.confirmationDialogType = null;
    this.confirmedPDC = false;
    this.browserPagination = undefined;
    this.browserGroups = [];
    this.pendingGroupBrowserData = {
      groupData: [],
      groupDataLookup: {},
      groupCount: {},
      isDirty: false
    };
    this.groupBrowserQ = "";
    this.groupBrowserSearchUsername = "";
    this.groupBrowserAllUsers = [];
    this.currentStep = "share";
    this.sharingDetail = null;
    this.hasSharingIssue = null;
  }
  handleIsBrowsingGroupsChange() {
    if (this.isBrowsingGroups) {
      this.handleNewPendingSelectedGroups(this.selectedGroupData.map(({ group }) => group));
    }
  }
  handleShareLevelChange() {
    const { selectedShareLevels, initialShareLevels, selectedGroupData, items } = this;
    this.isShareLevelDirty = (0,_utils_fba8960d_js__WEBPACK_IMPORTED_MODULE_7__.f)(selectedShareLevels, initialShareLevels, items, selectedGroupData);
    this.shareLevelCount = selectedShareLevels.reduce((acc, cur) => {
      acc[cur]++;
      return acc;
    }, { private: 0, shared: 0, org: 0, public: 0 });
    this.hasSingleShareLevel = selectedShareLevels.every((cur) => cur === selectedShareLevels[0]);
  }
  async componentWillLoad() {
    var _a;
    this.items = this.items.map((item) => { var _a; return (_a = item.sourceJSON) !== null && _a !== void 0 ? _a : item; });
    const { items, portal, user, el } = this;
    const locale = await (0,_locale_13e00a75_js__WEBPACK_IMPORTED_MODULE_4__.g)(el);
    this.i18n = locale[0];
    // This assume that once the loading text changes to updatingInfo,
    //  it will not change back to retrievingInfo
    this.loadingText = this.i18n.retrievingInfo;
    _config_eb5f7dc2_js__WEBPACK_IMPORTED_MODULE_2__.c.api = this.api;
    this.isPublicUser = (0,_privileges_ccd5f37d_js__WEBPACK_IMPORTED_MODULE_5__.n)(user);
    this.initialShareLevels = items.map((item) => item.access);
    this.selectedShareLevels = [...this.initialShareLevels];
    this.possibleShareLevelOptions = (0,_utils_fba8960d_js__WEBPACK_IMPORTED_MODULE_7__.h)(user, items, portal);
    const shareMode = (0,_utils_fba8960d_js__WEBPACK_IMPORTED_MODULE_7__.j)(items, user, portal);
    this.showOptions = shareMode !== "group";
    this.shareMode = shareMode;
    this.hasPrivateItem = items.some((item) => item.access === "private");
    const subscriptionInfo = (portal === null || portal === void 0 ? void 0 : portal.subscriptionInfo) || ((_a = portal === null || portal === void 0 ? void 0 : portal.sourceJSON) === null || _a === void 0 ? void 0 : _a.subscriptionInfo);
    this.hasItemBlockedFromPublic =
      items.some(_services_adddeef9_js__WEBPACK_IMPORTED_MODULE_1__.c) ||
        ((0,_privileges_ccd5f37d_js__WEBPACK_IMPORTED_MODULE_5__.c)(subscriptionInfo) && items.some(_services_adddeef9_js__WEBPACK_IMPORTED_MODULE_1__.d));
    this.hasIndoorsSpaces = items.some((item) => { var _a; return (_a = item.typeKeywords) === null || _a === void 0 ? void 0 : _a.includes("EditExtensionIndoorsSpaces"); });
  }
  handleSharingDetailChange() {
    const { sharingDetail } = this;
    this.hasSharingIssue =
      sharingDetail !== null
        ? Object.keys(sharingDetail).some((detailType) => sharingDetail[detailType].length > 0)
        : null;
  }
  handleHasSharingIssueChange() {
    const { hasSharingIssue } = this;
    if (hasSharingIssue) {
      this.currentStep = "review-sharing";
    }
    else if (hasSharingIssue === false) {
      this.currentStep = "finish";
    }
  }
  handleCurrentStepChange() {
    var _a, _b;
    const { currentStep, didUpdateSharingDetail, workflowComplete, sharingDetailToEmit, shareItemResult } = this;
    if (currentStep !== "finish") {
      return;
    }
    const didUpdateDependentLayersSharing = didUpdateSharingDetail;
    workflowComplete.emit({
      // No point in updating dep layers if the users didn't go through review sharing flow
      dependentLayersWithSourceItems: didUpdateDependentLayersSharing && sharingDetailToEmit
        ? Object.values(sharingDetailToEmit).reduce((acc, itemSharingDetailResults) => {
          acc.push(...itemSharingDetailResults.map(({ layer, sourceItem }) => ({
            layer,
            sourceItem
          })));
          return acc;
        }, [])
        : [],
      newShareLevel: (_a = shareItemResult === null || shareItemResult === void 0 ? void 0 : shareItemResult.newShareLevel) !== null && _a !== void 0 ? _a : null,
      shareErrors: (_b = shareItemResult === null || shareItemResult === void 0 ? void 0 : shareItemResult.shareErrors) !== null && _b !== void 0 ? _b : [],
      didUpdateDependentLayersSharing
    });
  }
  render() {
    const { renderShareModal, renderDepCheckModal, renderConfirmationDialog } = this;
    return ((0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.h)(_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.F, null, renderShareModal(), renderDepCheckModal(), renderConfirmationDialog()));
  }
  get el() { return (0,_index_92ebb396_js__WEBPACK_IMPORTED_MODULE_0__.d)(this); }
  static get watchers() { return {
    "isBrowsingGroups": ["handleIsBrowsingGroupsChange"],
    "selectedShareLevels": ["handleShareLevelChange"],
    "sharingDetail": ["handleSharingDetailChange"],
    "hasSharingIssue": ["handleHasSharingIssueChange"],
    "currentStep": ["handleCurrentStepChange"]
  }; }
};
ArcgisItemShare.style = arcgisItemShareCss;




/***/ })

}]);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2lkZ2V0cy9jaHVua3MvYXJjZ2lzX2FuYWx5c2lzX25vZGVfbW9kdWxlc19hcmNnaXNfYXBwLWNvbXBvbmVudHNfZGlzdF9lc21fYXJjZ2lzLTk4YmRjNy5qcyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ2lIO0FBQ3FFO0FBQzlIO0FBQ1M7QUFDSztBQUNTO0FBQ0E7QUFDNFM7QUFDeFY7QUFDTDtBQUNLO0FBQ0k7QUFDVjtBQUNHO0FBQ047QUFDUTtBQUNBO0FBQ1A7QUFDUzs7QUFFcEMsbUNBQW1DLFlBQVkscUJBQXFCLDZCQUE2QixrQ0FBa0MscUJBQXFCLHdCQUF3QixRQUFRLGFBQWEsMEJBQTBCLG1CQUFtQixhQUFhLFlBQVksbUJBQW1CLGtCQUFrQix5QkFBeUIsa0JBQWtCLFVBQVUscUJBQXFCLGtCQUFrQixZQUFZLGFBQWEsbUJBQW1CLGtCQUFrQixtQkFBbUIsd0JBQXdCLFdBQVcsVUFBVSxjQUFjLGFBQWEsZ0JBQWdCLDRCQUE0QiwyQkFBMkIsZUFBZSxrQkFBa0IsZ0JBQWdCLGFBQWEsZ0JBQWdCLGtCQUFrQixtQkFBbUIsb0JBQW9CLG1CQUFtQixhQUFhLGdCQUFnQixxRUFBcUUsNEJBQTRCLDJCQUEyQjs7QUFFLzVCO0FBQ0E7QUFDQSxJQUFJLHFEQUFnQjtBQUNwQiwwQkFBMEIscURBQVc7QUFDckMsNEJBQTRCLHFEQUFXO0FBQ3ZDO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxjQUFjLGtDQUFrQywrQkFBK0I7QUFDL0U7QUFDQSwwQkFBMEI7QUFDMUI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGlEQUFpRCxXQUFXLHVCQUF1QjtBQUNuRjtBQUNB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QUFZLDhGQUE4RjtBQUMxRztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0Esc0RBQXNELG1CQUFtQjtBQUN6RTtBQUNBO0FBQ0EsV0FBVztBQUNYO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQSxZQUFZLGtFQUFrRTtBQUM5RSxZQUFZLHFEQUFDLENBQUMsaURBQVE7QUFDdEI7QUFDQSxhQUFhLE9BQU8scURBQVU7QUFDOUIsMEJBQTBCO0FBQzFCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRWdEIiwic291cmNlcyI6WyJ3ZWJwYWNrOi8vZXhiLWNsaWVudC8uL2V4dGVuc2lvbnMvd2lkZ2V0cy9hcmNnaXMvYW5hbHlzaXMvbm9kZV9tb2R1bGVzL0BhcmNnaXMvYXBwLWNvbXBvbmVudHMvZGlzdC9lc20vYXJjZ2lzLWl0ZW0tc2hhcmUuZW50cnkuanMiXSwic291cmNlc0NvbnRlbnQiOlsiLyohXG4gKiBBbGwgbWF0ZXJpYWwgY29weXJpZ2h0IEVTUkksIEFsbCBSaWdodHMgUmVzZXJ2ZWQsIHVubGVzcyBvdGhlcndpc2Ugc3BlY2lmaWVkLlxuICogdjMuMC45OVxuICovXG5pbXBvcnQgeyByIGFzIHJlZ2lzdGVySW5zdGFuY2UsIGMgYXMgY3JlYXRlRXZlbnQsIGgsIEYgYXMgRnJhZ21lbnQsIGQgYXMgZ2V0RWxlbWVudCB9IGZyb20gJy4vaW5kZXgtOTJlYmIzOTYuanMnO1xuaW1wb3J0IHsgYSBhcyBhbmFseXplU2hhcmluZ0RldGFpbCwgdSBhcyB1bnNoYXJlSXRlbXMsIGIgYXMgc2hhcmVJdGVtcywgYyBhcyBpc0Jsb2NrZWRGcm9tU2hhcmluZ1RvUHVibGljLCBkIGFzIGlzQmxvY2tlZEZyb21EZXZlbG9wZXJTaGFyaW5nVG9QdWJsaWMgfSBmcm9tICcuL3NlcnZpY2VzLWFkZGRlZWY5LmpzJztcbmltcG9ydCB7IGMgYXMgY29uZmlnU3RhdGUgfSBmcm9tICcuL2NvbmZpZy1lYjVmN2RjMi5qcyc7XG5pbXBvcnQgeyBhIGFzIGFycmF5VG9Mb29rdXBNYXAgfSBmcm9tICcuL2Z1bmN0aW9uYWwtYzgyZjVhYjkuanMnO1xuaW1wb3J0IHsgZyBhcyBnZXRMb2NhbGVDb21wb25lbnRTdHJpbmdzIH0gZnJvbSAnLi9sb2NhbGUtMTNlMDBhNzUuanMnO1xuaW1wb3J0IHsgbiBhcyBpc1B1YmxpY1VzZXIsIGMgYXMgaXNEZXZlbG9wZXIgfSBmcm9tICcuL3ByaXZpbGVnZXMtY2NkNWYzN2QuanMnO1xuaW1wb3J0IHsgaSBhcyBpc0hvc3RlZFNlcnZpY2UsIGUgYXMgaXNFZGl0YWJsZUl0ZW0gfSBmcm9tICcuL2l0ZW0tZDlkNzA0MTYuanMnO1xuaW1wb3J0IHsgRCBhcyBERUZBVUxUX1NIQVJJTkdfREVUQUlMLCBnIGFzIGdldEl0ZW1zQW5kR3JvdXBzVG9VcGRhdGVTaGFyZSwgaSBhcyBpc1NlbGVjdGVkR3JvdXBEYXRhRGlydHksIHMgYXMgc2hvd0VkaXRHcm91cFdhcm5pbmcsIGEgYXMgZ2V0VXNlcm5hbWVRdWVyeSwgYiBhcyBzaG93UmV2ZXJ0R3JvdXBXYXJuaW5nLCBjIGFzIHNob3dSZXZlcnRTaGFyZUxldmVsV2FybmluZywgZCBhcyBERUZBVUxUX1NIQVJFX0xFVkVMUywgZSBhcyBzaG93U2hhcmVMZXZlbENoYW5nZVdhcm5pbmcsIGYgYXMgaXNTaGFyZUxldmVsRGlydHksIGggYXMgZ2V0UG9zc2libGVTaGFyZUxldmVsLCBqIGFzIGdldFNoYXJlTW9kZSB9IGZyb20gJy4vdXRpbHMtZmJhODk2MGQuanMnO1xuaW1wb3J0ICcuL3NlcnZlci1pdGVtLWYxMjE1M2U2LmpzJztcbmltcG9ydCAnLi9wb3J0YWwtNzljYWFlZmYuanMnO1xuaW1wb3J0ICcuL2xvYWRNb2R1bGVzLWFhZjMwYmQ2LmpzJztcbmltcG9ydCAnLi9pdGVtLXByb3BlcnRpZXMtZTY0MTJhOWEuanMnO1xuaW1wb3J0ICcuL2luZGV4LTgxZDU0OGI3LmpzJztcbmltcG9ydCAnLi9hZGQtaXRlbS05N2Q1NzdhOS5qcyc7XG5pbXBvcnQgJy4vdWktZWNmODZiYmEuanMnO1xuaW1wb3J0ICcuL2Z1bmN0aW9uYWwtOWY2NDhiZWUuanMnO1xuaW1wb3J0ICcuL2l0ZW0tdHlwZXMtYjRmZTg2YWQuanMnO1xuaW1wb3J0ICcuL2RvbS0xM2Y1YjAwYy5qcyc7XG5pbXBvcnQgJy4vbGFuZ3VhZ2VVdGlsLTIyMjU4YzkwLmpzJztcblxuY29uc3QgYXJjZ2lzSXRlbVNoYXJlQ3NzID0gXCIuc3RhZ2V7aGVpZ2h0OjEwMCV9Lmdyb3VwLWJyb3dzZXItbW9kYWx7LS1jYWxjaXRlLW1vZGFsLXdpZHRoOjEwODBweDstLWNhbGNpdGUtbW9kYWwtY29udGVudC1wYWRkaW5nOjB9YXJjZ2lzLWdyb3VwLWJyb3dzZXJ7aGVpZ2h0Om1pbig3MDBweCwgNjB2aCl9LmhpZGRlbntkaXNwbGF5Om5vbmV9LnNlY3Rpb246bm90KDpsYXN0LWNoaWxkKXttYXJnaW4tYm90dG9tOjJyZW19Y2FsY2l0ZS1mbG93e2hlaWdodDoxMDAlfS5jb250ZW50LWNvbnRhaW5lcnttYXJnaW4tdG9wOjAuNXJlbX0uYWN0aXZlLWJ1dC1ub3Qtc2VsZWN0ZWR7cG9zaXRpb246cmVsYXRpdmU7ei1pbmRleDoyfS50aWxlLXNlbGVjdC13cmFwcGVye3Bvc2l0aW9uOnJlbGF0aXZlfS5zaGFyZS1oaW50e2Rpc3BsYXk6ZmxleDthbGlnbi1pdGVtczpjZW50ZXI7cG9zaXRpb246YWJzb2x1dGU7Zm9udC1zaXplOjAuODc1cmVtO2luc2V0LWlubGluZS1lbmQ6MC41cmVtO3RvcDowLjVyZW07ei1pbmRleDozfS5zaGFyZS1oaW50PnB7bWFyZ2luLXRvcDowO21hcmdpbi1ib3R0b206MDstd2Via2l0LW1hcmdpbi1zdGFydDowLjVyZW07bWFyZ2luLWlubGluZS1zdGFydDowLjVyZW07bWFyZ2luLXRvcDoycHh9LmluZm9ybWF0aW9uLXRleHR7Zm9udC13ZWlnaHQ6NTAwO21hcmdpbi10b3A6MDttYXJnaW4tYm90dG9tOjA7bWFyZ2luLXRvcDowLjVyZW07Zm9udC1zaXplOjAuODc1cmVtfS5ncm91cC1pdGVtLWNvdW50ZXJ7Zm9udC1zaXplOjAuODc1cmVtO21hcmdpbi10b3A6MDttYXJnaW4tYm90dG9tOjB9LnJldmVydC1zaW5nbGUtZ3JvdXAtY3RhOmZpcnN0LWNoaWxkLC5ncm91cC1pdGVtLWNvdW50ZXI6Zmlyc3QtY2hpbGR7LXdlYmtpdC1tYXJnaW4tc3RhcnQ6MC41cmVtO21hcmdpbi1pbmxpbmUtc3RhcnQ6MC41cmVtfVwiO1xuXG5jb25zdCBBcmNnaXNJdGVtU2hhcmUgPSBjbGFzcyB7XG4gIGNvbnN0cnVjdG9yKGhvc3RSZWYpIHtcbiAgICByZWdpc3Rlckluc3RhbmNlKHRoaXMsIGhvc3RSZWYpO1xuICAgIHRoaXMud29ya2Zsb3dDYW5jZWwgPSBjcmVhdGVFdmVudCh0aGlzLCBcIndvcmtmbG93Q2FuY2VsXCIsIDcpO1xuICAgIHRoaXMud29ya2Zsb3dDb21wbGV0ZSA9IGNyZWF0ZUV2ZW50KHRoaXMsIFwid29ya2Zsb3dDb21wbGV0ZVwiLCA3KTtcbiAgICB0aGlzLmluaXRpYWxTaGFyZUxldmVscyA9IFtdO1xuICAgIHRoaXMuaW5pdGlhbFNlbGVjdGVkR3JvdXBEYXRhID0gW107XG4gICAgLyoqXG4gICAgICogU2VsZWN0ZWQgYnkgYWxsIGl0ZW1zLCBzb21lIGl0ZW1zIG9yIG5vIGl0ZW1zXG4gICAgICpcbiAgICAgKiBVc2VkIHRvIGRldGVybWluZSBpZiB3ZSBzaG91bGQgc2hvdyB0aGUgcmV2ZXJ0IGJ1dHRvbiBvbiBlYWNoIGdyb3VwIGNhcmRcbiAgICAgKiAgKi9cbiAgICB0aGlzLmluaXRpYWxTZWxlY3RlZEdyb3VwRGF0YUxvb2t1cCA9IHt9O1xuICAgIHRoaXMuc2hvd09wdGlvbnMgPSBmYWxzZTtcbiAgICB0aGlzLnNoYXJlTGV2ZWxPcHRpb25zID0gW1wicHJpdmF0ZVwiLCBcIm9yZ1wiLCBcInB1YmxpY1wiXTtcbiAgICB0aGlzLnBvc3NpYmxlU2hhcmVMZXZlbE9wdGlvbnMgPSBbXG4gICAgICBcInByaXZhdGVcIixcbiAgICAgIFwib3JnXCIsXG4gICAgICBcInB1YmxpY1wiXG4gICAgXTtcbiAgICB0aGlzLnNoYXJlTGV2ZWxJY29uID0ge1xuICAgICAgcHJpdmF0ZTogXCJ1c2VyXCIsXG4gICAgICBvcmc6IFwib3JnYW5pemF0aW9uXCIsXG4gICAgICBwdWJsaWM6IFwiZ2xvYmVcIlxuICAgIH07XG4gICAgdGhpcy5pc1B1YmxpY1VzZXIgPSBmYWxzZTtcbiAgICB0aGlzLmhhc0l0ZW1CbG9ja2VkRnJvbVB1YmxpYyA9IGZhbHNlO1xuICAgIHRoaXMuaGFzUHJpdmF0ZUl0ZW0gPSBmYWxzZTtcbiAgICB0aGlzLnNoYXJlTW9kZSA9IFwiZGVmYXVsdFwiO1xuICAgIHRoaXMuaGFzSW5kb29yc1NwYWNlcyA9IGZhbHNlO1xuICAgIHRoaXMuc2hhcmluZ0RldGFpbFRvRW1pdCA9IG51bGw7XG4gICAgdGhpcy5kaWRVcGRhdGVTaGFyaW5nRGV0YWlsID0gZmFsc2U7XG4gICAgdGhpcy5zaGFyZUl0ZW1SZXN1bHQgPSBudWxsO1xuICAgIHRoaXMuaGFuZGxlTmV3U2hhcmVSZXN1bHQgPSBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCB7IGl0ZW1zLCBwb3J0YWwsIHNoYXJlSXRlbVJlc3VsdDogeyBuZXdTaGFyZUxldmVsLCBuZXdHcm91cFNoYXJlZCB9LCBcbiAgICAgIC8vIFRoaXMgc2hvdWxkIGFscmVhZHkgaGF2ZSB0aGUgbGF0ZXN0IHVwZGF0ZVxuICAgICAgc2VsZWN0ZWRHcm91cERhdGEgfSA9IHRoaXM7XG4gICAgICAvLyAqIFJlc2V0IGl0ZW0gdG8gZ2V0IHJlYWR5IGZvciB0aGUgcmV2aWV3IHNoYXJpbmcgc3RhdGVcbiAgICAgIGxldCBuZXdJdGVtcyA9IFsuLi5pdGVtc107XG4gICAgICBpZiAobmV3U2hhcmVMZXZlbCAhPSBudWxsKSB7XG4gICAgICAgIG5ld0l0ZW1zID0gaXRlbXMubWFwKChpdGVtKSA9PiB7XG4gICAgICAgICAgaWYgKG5ld1NoYXJlTGV2ZWwgIT09IFwicHJpdmF0ZVwiKSB7XG4gICAgICAgICAgICByZXR1cm4gT2JqZWN0LmFzc2lnbihPYmplY3QuYXNzaWduKHt9LCBpdGVtKSwgeyBhY2Nlc3M6IG5ld1NoYXJlTGV2ZWwgfSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIC8vIElmIHRoZSBuZXcgbGV2ZWwgaXMgcHJpdmF0ZSBidXQgdGhlIGl0ZW0gaXMgY3VycmVudGx5IHNoYXJlZCB0byBhIGdyb3VwLFxuICAgICAgICAgIC8vICB3ZSBuZWVkIHRvIG1ha2Ugc3VyZSBpdCdzIG1hcmtlZCBhcyBcInNoYXJlZFwiIGluc3RlYWQgb2YgXCJwcml2YXRlXCJcbiAgICAgICAgICBjb25zdCBpc0l0ZW1DdXJyZW50bHlTaGFyZWRUb0dyb3VwcyA9IHNlbGVjdGVkR3JvdXBEYXRhID09PSBudWxsIHx8IHNlbGVjdGVkR3JvdXBEYXRhID09PSB2b2lkIDAgPyB2b2lkIDAgOiBzZWxlY3RlZEdyb3VwRGF0YS5zb21lKCh7IHNlbGVjdGVkQnlJdGVtSWRzIH0pID0+IHNlbGVjdGVkQnlJdGVtSWRzLmluY2x1ZGVzKGl0ZW0uaWQpKTtcbiAgICAgICAgICByZXR1cm4gT2JqZWN0LmFzc2lnbihPYmplY3QuYXNzaWduKHt9LCBpdGVtKSwgeyBhY2Nlc3M6IGlzSXRlbUN1cnJlbnRseVNoYXJlZFRvR3JvdXBzID8gXCJzaGFyZWRcIiA6IFwicHJpdmF0ZVwiIH0pO1xuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICAgIC8vIElmIHdlJ3JlIG5vdCBzaGFyaW5nIHRvIGFueSBncm91cCwgd2UgbmVlZCB0byBtYWtlIHN1cmUgZXZlcnkgXCJzaGFyZWRcIiBpdGVtIGlzIG1hcmtlZCBhcyBcInByaXZhdGVcIlxuICAgICAgaWYgKCEoc2VsZWN0ZWRHcm91cERhdGEgPT09IG51bGwgfHwgc2VsZWN0ZWRHcm91cERhdGEgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHNlbGVjdGVkR3JvdXBEYXRhLmxlbmd0aCkpIHtcbiAgICAgICAgbmV3SXRlbXMgPSBuZXdJdGVtcy5tYXAoKGl0ZW0pID0+IGl0ZW0uYWNjZXNzID09PSBcInNoYXJlZFwiID8gT2JqZWN0LmFzc2lnbihPYmplY3QuYXNzaWduKHt9LCBpdGVtKSwgeyBhY2Nlc3M6IFwicHJpdmF0ZVwiIH0pIDogaXRlbSk7XG4gICAgICB9XG4gICAgICAvLyBBbmQgdmljZSB2ZXJzYSBpZiB3ZSdyZSAoZnVsbHkpIHNoYXJpbmcgdG8gYXQgbGVhc3Qgb25lIG5ldyBncm91cFxuICAgICAgaWYgKG5ld0dyb3VwU2hhcmVkLmxlbmd0aCkge1xuICAgICAgICBuZXdJdGVtcyA9IG5ld0l0ZW1zLm1hcCgoaXRlbSkgPT4gaXRlbS5hY2Nlc3MgPT09IFwicHJpdmF0ZVwiID8gT2JqZWN0LmFzc2lnbihPYmplY3QuYXNzaWduKHt9LCBpdGVtKSwgeyBhY2Nlc3M6IFwic2hhcmVkXCIgfSkgOiBpdGVtKTtcbiAgICAgIH1cbiAgICAgIHRoaXMuaXRlbXMgPSBuZXdJdGVtcztcbiAgICAgIC8vICogQW5hbHl6ZSBhbmQgZGVjaWRlIHdoZXRoZXIgd2Ugc2hvdWxkIHNob3cgdGhlIGRlcCBjaGVjayBkaWFsb2dcbiAgICAgIGNvbnN0IGFuYWx5emVSZXN1bHRzID0gYXdhaXQgUHJvbWlzZS5hbGwobmV3SXRlbXMubWFwKChpdGVtKSA9PiBhbmFseXplU2hhcmluZ0RldGFpbChpdGVtLCBwb3J0YWwpKSk7XG4gICAgICBjb25zdCBuZXdTaGFyZURldGFpbCA9IGFuYWx5emVSZXN1bHRzLnJlZHVjZSgoYWNjLCB7IHJlc3VsdCB9KSA9PiB7XG4gICAgICAgIGlmIChyZXN1bHQpIHtcbiAgICAgICAgICBPYmplY3Qua2V5cyhyZXN1bHQpLmZvckVhY2goKGtleSkgPT4ge1xuICAgICAgICAgICAgYWNjW2tleV0gPSBbLi4uYWNjW2tleV0sIC4uLnJlc3VsdFtrZXldXTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gYWNjO1xuICAgICAgfSwgT2JqZWN0LmFzc2lnbih7fSwgREVGQVVMVF9TSEFSSU5HX0RFVEFJTCkpO1xuICAgICAgdGhpcy5zaGFyaW5nRGV0YWlsID0gbmV3U2hhcmVEZXRhaWw7XG4gICAgICAvLyBUaGUgd2F0Y2ggZm9yIGBoYXNTaGFyaW5nSXNzdWVgIHdpbGwgYmUgYXV0b21hdGljYWxseSB0cmlnZ2VyZWQgbmV4dFxuICAgIH07XG4gICAgLy8gKiBPdGhlciB1dGlscyBhbmQgcmVuZGVyc1xuICAgIHRoaXMudXBkYXRlU2hhcmluZyA9IGFzeW5jICgpID0+IHtcbiAgICAgIHZhciBfYTtcbiAgICAgIHRoaXMubG9hZGluZ1RleHQgPSB0aGlzLmkxOG4udXBkYXRpbmdJbmZvO1xuICAgICAgdGhpcy5pc0xvYWRpbmcgPSB0cnVlO1xuICAgICAgY29uc3QgeyBpdGVtcywgc2VsZWN0ZWRTaGFyZUxldmVscywgaW5pdGlhbFNlbGVjdGVkR3JvdXBEYXRhLCBzZWxlY3RlZEdyb3VwRGF0YSwgcG9ydGFsLCB1c2VyLCBpc1NoYXJlTGV2ZWxEaXJ0eSwgY2hlY2tJdGVtUERDSXNzdWUsIGNvbmZpcm1lZFBEQyB9ID0gdGhpcztcbiAgICAgIGNvbnN0IHsgc2hhcmVHcm91cElkcywgdW5zaGFyZUdyb3VwSWRzIH0gPSBnZXRJdGVtc0FuZEdyb3Vwc1RvVXBkYXRlU2hhcmUoaW5pdGlhbFNlbGVjdGVkR3JvdXBEYXRhLCBzZWxlY3RlZEdyb3VwRGF0YSk7XG4gICAgICBpZiAoIWNvbmZpcm1lZFBEQyAmJiAhKGF3YWl0IGNoZWNrSXRlbVBEQ0lzc3VlKCkpKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIC8vICEgVGhpcyBhc3N1bWUgdGhhdCBhbGwgaXRlbXMgaGF2ZSB0aGUgc2FtZSBzaGFyZSBsZXZlbCBvbmNlIHRoZSB1c2VyIGNob29zZSBzb21ldGhpbmdcbiAgICAgIGNvbnN0IG5ld1NoYXJlTGV2ZWwgPSBpc1NoYXJlTGV2ZWxEaXJ0eSB8fCBpdGVtcy5sZW5ndGggPT09IDEgPyBzZWxlY3RlZFNoYXJlTGV2ZWxzWzBdIDogbnVsbDtcbiAgICAgIC8vIE5lZWQgdG8gdW5zaGFyZSBmaXJzdCBpbiBjYXNlIHRoZSB1c2VyIGlzIHB1YmxpY1xuICAgICAgLy8gKHB1YmxpYyB1c2VyIGNhbiBvbmx5IHNoYXJlIHRvIGdyb3VwIGlmIHRoZSBzaGFyZSBsZXZlbCBpcyBwdWJsaWMpXG4gICAgICBjb25zdCB1bnNoYXJlUHJvbWlzZSA9IHVuc2hhcmVHcm91cElkcy5sZW5ndGhcbiAgICAgICAgPyB1bnNoYXJlSXRlbXMoaXRlbXMubWFwKChpdGVtKSA9PiBpdGVtLmlkKSwgdW5zaGFyZUdyb3VwSWRzLCB7IHBvcnRhbCwgdXNlciB9KVxuICAgICAgICA6IHVuZGVmaW5lZDtcbiAgICAgIGNvbnN0IHNoYXJlUHJvbWlzZSA9IHNoYXJlR3JvdXBJZHMubGVuZ3RoIHx8IGlzU2hhcmVMZXZlbERpcnR5XG4gICAgICAgID8gc2hhcmVJdGVtcyhpdGVtcywgbmV3U2hhcmVMZXZlbCwgc2hhcmVHcm91cElkcywgeyBwb3J0YWwsIHVzZXIgfSlcbiAgICAgICAgOiB1bmRlZmluZWQ7XG4gICAgICBjb25zdCBbc2hhcmVSZXN1bHRdID0gYXdhaXQgUHJvbWlzZS5hbGwoW3NoYXJlUHJvbWlzZSwgdW5zaGFyZVByb21pc2VdKTtcbiAgICAgIC8vICEgV2UgZG9uJ3Qgc2V0IGxvYWRpbmcgdG8gZmFsc2UgaW4gY2FzZSB0aGUgY29uc3VtZXJzIHdhbnQgdG8ga2VlcCBsb2FkaW5nXG4gICAgICAvLyBUaGV5IGNhbiByZW1vdmUgdGhlIG1vZGFsIGNvbXBsZXRlbHlcbiAgICAgIC8vICogLS0tXG4gICAgICBjb25zdCBzaGFyZUl0ZW1SZXN1bHQgPSB7XG4gICAgICAgIC8vIFRPRE86IGhhaXIgc3BsaXR0aW5nIHRoaXMgc2luY2UgZGlmZmVyZW50IGl0ZW1zIGNhbiBsZWFkIHRvIGRpZmZlcmVudCByZXN1bHRzXG4gICAgICAgIG5ld0dyb3VwU2hhcmVkOiBzaGFyZUdyb3VwSWRzLmZpbHRlcigoaWQpID0+ICEoc2hhcmVSZXN1bHQgPT09IG51bGwgfHwgc2hhcmVSZXN1bHQgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHNoYXJlUmVzdWx0LnJlc3VsdC5zb21lKCh7IG5vdFNoYXJlZFdpdGggfSkgPT4gbm90U2hhcmVkV2l0aC5pbmNsdWRlcyhpZCkpKSksXG4gICAgICAgIG5ld0dyb3VwVW5zaGFyZWQ6IHVuc2hhcmVHcm91cElkcyxcbiAgICAgICAgbmV3U2hhcmVMZXZlbCxcbiAgICAgICAgc2hhcmVFcnJvcnM6IChfYSA9IHNoYXJlUmVzdWx0ID09PSBudWxsIHx8IHNoYXJlUmVzdWx0ID09PSB2b2lkIDAgPyB2b2lkIDAgOiBzaGFyZVJlc3VsdC5yZXN1bHQuZmlsdGVyKCh7IGVycm9yIH0pID0+IGVycm9yKS5tYXAoKHsgaXRlbUlkIH0pID0+IHtcbiAgICAgICAgICByZXR1cm4geyBpdGVtOiBpdGVtcy5maW5kKChjdXJJdGVtKSA9PiBjdXJJdGVtLmlkID09PSBpdGVtSWQpLCBjb2RlOiBcIm5vdFNoYXJlZFdpdGhcIiB9O1xuICAgICAgICB9KSkgIT09IG51bGwgJiYgX2EgIT09IHZvaWQgMCA/IF9hIDogW11cbiAgICAgIH07XG4gICAgICB0aGlzLnNoYXJlSXRlbVJlc3VsdCA9IHNoYXJlSXRlbVJlc3VsdDtcbiAgICAgIHRoaXMuaGFuZGxlTmV3U2hhcmVSZXN1bHQoKTtcbiAgICB9O1xuICAgIHRoaXMuY2hlY2tJdGVtUERDSXNzdWUgPSBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCB7IGl0ZW1zLCBwb3J0YWwsIGlzU2hhcmVMZXZlbERpcnR5LCBzZWxlY3RlZFNoYXJlTGV2ZWxzIH0gPSB0aGlzO1xuICAgICAgY29uc3QgaG9zdGVkSXRlbXMgPSBpdGVtcy5maWx0ZXIoKGl0ZW0pID0+IGlzSG9zdGVkU2VydmljZShpdGVtLnR5cGVLZXl3b3JkcywgaXRlbS50eXBlKSk7XG4gICAgICAvLyAhIElmIHRoZSBzaGFyZSBsZXZlbCBpcyBkaXJ0eSwgdGhpcyBtZWFucyB0aGUgc2hhcmUgbGV2ZWwgaXMgc2VsZWN0ZWQgdG8gc29tZXRoaW5nIGVsc2VcbiAgICAgIC8vICBtZWFuaW5nIGFsbCB0aGUgc2hhcmUgbGV2ZWwgaXMgY29udmVyZ2VkIHRvIHRoZSBzYW1lIGxldmVsIHNpbmNlIHRoYXQncyB0aGUgb25seSB1c2UgY2FzZVxuICAgICAgY29uc3QgcHVibGljT3B0aW9uU2VsZWN0ZWQgPSBpc1NoYXJlTGV2ZWxEaXJ0eSAmJiBzZWxlY3RlZFNoYXJlTGV2ZWxzWzBdID09PSBcInB1YmxpY1wiO1xuICAgICAgLyoqXG4gICAgICAgKiBpZiB3ZSBoYXZlIGhvc3RlZCBzZXJ2aWNlcyBhbmQgd2UncmUgc2hhcmluZyBwdWJsaWNseSwgY2hlY2sgZm9yIGVkaXRhYmxlIGxheWVycyBhbmQgd2FybiB1c2VyXG4gICAgICAgKiBXZWJHSVMvYXJjZ2lzLXBvcnRhbC1hcHAjMjcwMDIsIFdlYkdJUy9hcmNnaXMtcG9ydGFsLWFwcCMyNjI4NVxuICAgICAgICovXG4gICAgICBpZiAoaG9zdGVkSXRlbXMubGVuZ3RoID4gMCAmJiBwdWJsaWNPcHRpb25TZWxlY3RlZCkge1xuICAgICAgICB0aGlzLmlzTG9hZGluZyA9IHRydWU7XG4gICAgICAgIGNvbnN0IGVkaXRhYmxlQ2hlY2sgPSBhd2FpdCBQcm9taXNlLmFsbChob3N0ZWRJdGVtcy5tYXAoKGl0ZW0pID0+IGlzRWRpdGFibGVJdGVtKGl0ZW0sIHBvcnRhbCkpKTtcbiAgICAgICAgdGhpcy5pc0xvYWRpbmcgPSBmYWxzZTtcbiAgICAgICAgY29uc3QgZWRpdGFibGVJdGVtcyA9IGhvc3RlZEl0ZW1zLmZpbHRlcigoXywgaW5kZXgpID0+IGVkaXRhYmxlQ2hlY2tbaW5kZXhdKTtcbiAgICAgICAgaWYgKGVkaXRhYmxlSXRlbXMubGVuZ3RoKSB7XG4gICAgICAgICAgY29uc3QgcHVibGljRGF0YUNvbGxlY3Rpb25EaXNhYmxlZCA9ICFlZGl0YWJsZUl0ZW1zLmV2ZXJ5KChpdGVtKSA9PiBpdGVtLnR5cGVLZXl3b3Jkcy5pbmNsdWRlcyhcIlB1YmxpYyBEYXRhIENvbGxlY3Rpb25cIikpO1xuICAgICAgICAgIHRoaXMuY29uZmlybWF0aW9uRGlhbG9nVHlwZSA9IHB1YmxpY0RhdGFDb2xsZWN0aW9uRGlzYWJsZWRcbiAgICAgICAgICAgID8gXCJwdWJsaWNEYXRhQ29sbGVjdGlvbkRpc2FibGVkXCJcbiAgICAgICAgICAgIDogXCJwdWJsaWNEYXRhQ29sbGVjdGlvbkVuYWJsZWRcIjtcbiAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH07XG4gICAgdGhpcy5oYW5kbGVOZXdQZW5kaW5nU2VsZWN0ZWRHcm91cHMgPSAobmV3R3JvdXBzKSA9PiB7XG4gICAgICBjb25zdCB7IGl0ZW1zLCBwZW5kaW5nR3JvdXBCcm93c2VyRGF0YSwgc2VsZWN0ZWRHcm91cERhdGEgfSA9IHRoaXM7XG4gICAgICBjb25zdCBjdXJTZWxlY3RlZEdyb3VwTG9va3VwID0gYXJyYXlUb0xvb2t1cE1hcChwZW5kaW5nR3JvdXBCcm93c2VyRGF0YS5ncm91cERhdGEsIChncm91cERhdGEpID0+ICh7XG4gICAgICAgIGtleTogZ3JvdXBEYXRhLmdyb3VwLmlkLFxuICAgICAgICBkYXRhOiBncm91cERhdGFcbiAgICAgIH0pKTtcbiAgICAgIGNvbnN0IGFsbEl0ZW1JZHMgPSBpdGVtcy5tYXAoKGl0ZW0pID0+IGl0ZW0uaWQpO1xuICAgICAgY29uc3QgbmV3U2VsZWN0ZWRHcm91cERhdGEgPSBuZXdHcm91cHMubWFwKChncm91cCkgPT4ge1xuICAgICAgICAvLyBJZiB0aGUgZ3JvdXAgd2FzIHByZXZpb3VzbHkgc2VsZWN0ZWQsIHVzZSB0aGUgcHJldmlvdXMgZGF0YVxuICAgICAgICAvLyAgZWxzZSBzZXQgc2VsZWN0ZWRCeUl0ZW1JZHMgdG8gYWxsIGl0ZW1zJyBpZHNcbiAgICAgICAgY29uc3QgcHJldkdyb3VwRGF0YSA9IGN1clNlbGVjdGVkR3JvdXBMb29rdXBbZ3JvdXAuaWRdO1xuICAgICAgICBpZiAocHJldkdyb3VwRGF0YSkge1xuICAgICAgICAgIHJldHVybiBwcmV2R3JvdXBEYXRhO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB7IGdyb3VwLCBzZWxlY3RlZEJ5SXRlbUlkczogYWxsSXRlbUlkcyB9O1xuICAgICAgfSk7XG4gICAgICB0aGlzLnBlbmRpbmdHcm91cEJyb3dzZXJEYXRhID0ge1xuICAgICAgICBncm91cERhdGE6IG5ld1NlbGVjdGVkR3JvdXBEYXRhLFxuICAgICAgICBncm91cERhdGFMb29rdXA6IGFycmF5VG9Mb29rdXBNYXAobmV3U2VsZWN0ZWRHcm91cERhdGEsIChncm91cERhdGEpID0+ICh7XG4gICAgICAgICAga2V5OiBncm91cERhdGEuZ3JvdXAuaWQsXG4gICAgICAgICAgZGF0YTogdHJ1ZVxuICAgICAgICB9KSksXG4gICAgICAgIGdyb3VwQ291bnQ6IG5ld1NlbGVjdGVkR3JvdXBEYXRhLnJlZHVjZSgoYWNjLCBjdXIpID0+IHtcbiAgICAgICAgICBhY2NbY3VyLmdyb3VwLmlkXSA9IGN1ci5zZWxlY3RlZEJ5SXRlbUlkcy5sZW5ndGg7XG4gICAgICAgICAgcmV0dXJuIGFjYztcbiAgICAgICAgfSwge30pLFxuICAgICAgICBpc0RpcnR5OiBpc1NlbGVjdGVkR3JvdXBEYXRhRGlydHkobmV3U2VsZWN0ZWRHcm91cERhdGEsIHNlbGVjdGVkR3JvdXBEYXRhKVxuICAgICAgfTtcbiAgICB9O1xuICAgIHRoaXMucmV2ZXJ0U2hhcmVMZXZlbCA9ICgpID0+IHtcbiAgICAgIHRoaXMuc2VsZWN0ZWRTaGFyZUxldmVscyA9IFsuLi50aGlzLmluaXRpYWxTaGFyZUxldmVsc107XG4gICAgfTtcbiAgICB0aGlzLnNldFNoYXJlTGV2ZWwgPSAobmV3U2hhcmVMZXZlbCkgPT4ge1xuICAgICAgdGhpcy5zZWxlY3RlZFNoYXJlTGV2ZWxzID0gdGhpcy5zZWxlY3RlZFNoYXJlTGV2ZWxzLm1hcCgoKSA9PiBuZXdTaGFyZUxldmVsKTtcbiAgICB9O1xuICAgIHRoaXMucmV2ZXJ0R3JvdXBEYXRhID0gKCkgPT4ge1xuICAgICAgdGhpcy5zZWxlY3RlZEdyb3VwRGF0YSA9IFsuLi50aGlzLmluaXRpYWxTZWxlY3RlZEdyb3VwRGF0YV07XG4gICAgfTtcbiAgICB0aGlzLnJldmVydFBlbmRpbmdHcm91cERhdGEgPSAoZ3JvdXBJZCkgPT4ge1xuICAgICAgY29uc3QgeyBpbml0aWFsU2VsZWN0ZWRHcm91cERhdGEsIHBlbmRpbmdHcm91cEJyb3dzZXJEYXRhLCBoYW5kbGVOZXdQZW5kaW5nU2VsZWN0ZWRHcm91cHMgfSA9IHRoaXM7XG4gICAgICBjb25zdCBpbml0aWFsR3JvdXBEYXRhID0gaW5pdGlhbFNlbGVjdGVkR3JvdXBEYXRhLmZpbmQoKHsgZ3JvdXAgfSkgPT4gZ3JvdXAuaWQgPT09IGdyb3VwSWQpO1xuICAgICAgY29uc3QgY3VyR3JvdXBEYXRhID0gcGVuZGluZ0dyb3VwQnJvd3NlckRhdGEuZ3JvdXBEYXRhO1xuICAgICAgY29uc3QgY3VyU2VsZWN0ZWRHcm91cERhdGEgPSBjdXJHcm91cERhdGEuZmluZCgoeyBncm91cCB9KSA9PiBncm91cC5pZCA9PT0gZ3JvdXBJZCk7XG4gICAgICBsZXQgbmV3R3JvdXBEYXRhID0gW107XG4gICAgICBpZiAoIWluaXRpYWxHcm91cERhdGEpIHtcbiAgICAgICAgLy8gVGhpcyBtZWFucyBpbml0aWFsbHkgd2UgZG9uJ3QgaGF2ZSB0aGlzIGdyb3VwXG4gICAgICAgIG5ld0dyb3VwRGF0YSA9IGN1ckdyb3VwRGF0YS5maWx0ZXIoKHsgZ3JvdXAgfSkgPT4gZ3JvdXAuaWQgIT09IGdyb3VwSWQpO1xuICAgICAgfVxuICAgICAgZWxzZSBpZiAoIWN1clNlbGVjdGVkR3JvdXBEYXRhKSB7XG4gICAgICAgIC8vIFRoaXMgbWVhbnMgd2UgcmVtb3ZlZCB0aGUgZ3JvdXBcbiAgICAgICAgbmV3R3JvdXBEYXRhID0gWy4uLmN1ckdyb3VwRGF0YSwgaW5pdGlhbEdyb3VwRGF0YV07XG4gICAgICB9XG4gICAgICBlbHNlIHtcbiAgICAgICAgbmV3R3JvdXBEYXRhID0gY3VyR3JvdXBEYXRhLm1hcCgoZ3JvdXBEYXRhKSA9PiB7XG4gICAgICAgICAgaWYgKGdyb3VwRGF0YS5ncm91cC5pZCAhPT0gZ3JvdXBJZCkge1xuICAgICAgICAgICAgcmV0dXJuIGdyb3VwRGF0YTtcbiAgICAgICAgICB9XG4gICAgICAgICAgcmV0dXJuIGluaXRpYWxHcm91cERhdGE7XG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgICAgaGFuZGxlTmV3UGVuZGluZ1NlbGVjdGVkR3JvdXBzKG5ld0dyb3VwRGF0YS5tYXAoKHsgZ3JvdXAgfSkgPT4gZ3JvdXApKTtcbiAgICB9O1xuICAgIHRoaXMuYXBwbHlQZW5kaW5nR3JvdXBEYXRhID0gKCkgPT4ge1xuICAgICAgdGhpcy5zZWxlY3RlZEdyb3VwRGF0YSA9IFsuLi50aGlzLnBlbmRpbmdHcm91cEJyb3dzZXJEYXRhLmdyb3VwRGF0YV07XG4gICAgICB0aGlzLnVuQnJvd3NlR3JvdXBzKCk7XG4gICAgfTtcbiAgICB0aGlzLmNsb3NlRGlhbG9nID0gKGV2ZW50KSA9PiB7XG4gICAgICB2YXIgX2EsIF9iO1xuICAgICAgLy8gU3RvcCB0aGUgY2xvc2UgZXZlbnQgZnJvbSBhcmNnaXMtZGVwZW5kZW5jeS1jaGVjayBmcm9tIHByb3BhZ2F0aW5nXG4gICAgICBldmVudCA9PT0gbnVsbCB8fCBldmVudCA9PT0gdm9pZCAwID8gdm9pZCAwIDogZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICBjb25zdCB7IHdvcmtmbG93Q2FuY2VsLCBjdXJyZW50U3RlcCB9ID0gdGhpcztcbiAgICAgIGlmIChjdXJyZW50U3RlcCAhPT0gXCJmaW5pc2hcIikge1xuICAgICAgICB3b3JrZmxvd0NhbmNlbC5lbWl0KHtcbiAgICAgICAgICBuZXdTaGFyZUxldmVsOiAoX2IgPSAoX2EgPSB0aGlzLnNoYXJlSXRlbVJlc3VsdCkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLm5ld1NoYXJlTGV2ZWwpICE9PSBudWxsICYmIF9iICE9PSB2b2lkIDAgPyBfYiA6IG51bGwsXG4gICAgICAgICAgY2FuY2VsQXRTdGVwOiBjdXJyZW50U3RlcFxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9O1xuICAgIHRoaXMudW5Ccm93c2VHcm91cHMgPSAoKSA9PiB7XG4gICAgICB0aGlzLmlzQnJvd3NpbmdHcm91cHMgPSBmYWxzZTtcbiAgICB9O1xuICAgIHRoaXMucmVuZGVyR3JvdXBCcm93c2VyID0gKCkgPT4ge1xuICAgICAgY29uc3QgeyBhcGksIGkxOG4sIHVzZXIsIHBvcnRhbCwgY29uZmlnLCBwZW5kaW5nR3JvdXBCcm93c2VyRGF0YSwgYnJvd3NlclBhZ2luYXRpb24sIGJyb3dzZXJHcm91cHMsIGhhbmRsZU5ld1BlbmRpbmdTZWxlY3RlZEdyb3VwcywgaXNCcm93c2luZ0dyb3VwcywgaXNQdWJsaWNVc2VyLCBpdGVtcywgc2hhcmVNb2RlLCBncm91cEJyb3dzZXJRLCBpbml0aWFsU2VsZWN0ZWRHcm91cERhdGFMb29rdXAsIHJldmVydFBlbmRpbmdHcm91cERhdGEsIGhhc0luZG9vcnNTcGFjZXMsIGdyb3VwQnJvd3NlckFsbFVzZXJzLCBncm91cEJyb3dzZXJTZWFyY2hVc2VybmFtZSwgaGFzUHJpdmF0ZUl0ZW0gfSA9IHRoaXM7XG4gICAgICBjb25zdCB0b3RhbEl0ZW1Db3VudCA9IGl0ZW1zLmxlbmd0aDtcbiAgICAgIGNvbnN0IHNob3dGaWx0ZXJCeVVzZXJzID0gc2hhcmVNb2RlID09PSBcImFkbWluXCIgJiYgIWhhc1ByaXZhdGVJdGVtICYmIGdyb3VwQnJvd3NlckFsbFVzZXJzLmxlbmd0aCA+IDE7XG4gICAgICByZXR1cm4gKGgoXCJhcmNnaXMtZ3JvdXAtYnJvd3NlclwiLCB7IHZpZXc6IFwiY29tcGFjdFwiLCBjbGFzczogeyBoaWRkZW46ICFpc0Jyb3dzaW5nR3JvdXBzIH0sIGNvbmZpZzogY29uZmlnLCB1c2VyOiB1c2VyLCBhcGk6IGFwaSwgcG9ydGFsOiBwb3J0YWwsIHNlbGVjdGlvbjogXCJtdWx0aXBsZVwiLCBzZWFyY2hVc2VyOiBncm91cEJyb3dzZXJTZWFyY2hVc2VybmFtZSwgc2VsZWN0ZWRHcm91cHM6IHBlbmRpbmdHcm91cEJyb3dzZXJEYXRhLmdyb3VwRGF0YS5tYXAoKGRhdGEpID0+IGRhdGEuZ3JvdXApLCBoYXNJbmRvb3JzU3BhY2VzOiBoYXNJbmRvb3JzU3BhY2VzLCBxOiBncm91cEJyb3dzZXJRLCBvbkFyY2dpc0dyb3VwQnJvd3NlclVwZGF0ZTogKGUpID0+IHtcbiAgICAgICAgICBjb25zdCB7IHJlc3VsdHMsIG51bSwgc3RhcnQsIHRvdGFsIH0gPSBlLmRldGFpbDtcbiAgICAgICAgICAvLyBUT0RPOiByZW1vdmUgdGhpcyBhc3NlcnRcbiAgICAgICAgICB0aGlzLmJyb3dzZXJHcm91cHMgPSByZXN1bHRzO1xuICAgICAgICAgIHRoaXMuYnJvd3NlclBhZ2luYXRpb24gPSB7IHN0YXJ0LCBudW0sIHRvdGFsIH07XG4gICAgICAgIH0sIG9uQXJjZ2lzR3JvdXBCcm93c2VyTG9hZGluZzogKCkgPT4ge1xuICAgICAgICAgIHRoaXMuYnJvd3Nlckdyb3VwcyA9IFtdO1xuICAgICAgICB9LCBvbkFyY2dpc0dyb3VwQnJvd3NlclNlbGVjdDogKGUpID0+IGhhbmRsZU5ld1BlbmRpbmdTZWxlY3RlZEdyb3VwcyhlLmRldGFpbCkgfSwgaChcImFyY2dpcy1ncm91cC1icm93c2VyLXRvcC1iYXJcIiwgeyBzbG90OiBcInRvcC1iYXJcIiwgXCJmaWx0ZXItdG9nZ2xlXCI6IHRydWUgfSwgaChcImFyY2dpcy1ncm91cC1icm93c2VyLXNlYXJjaFwiLCB7IHNsb3Q6IFwic2VhcmNoXCIsIHRlcm06IFwiXCIgfSkpLCBoKFwiYXJjZ2lzLWdyb3VwLWJyb3dzZXItc29ydFwiLCB7IHNsb3Q6IFwic29ydFwiIH0pLCBoKFwiYXJjZ2lzLWdyb3VwLWJyb3dzZXItZmlsdGVyc1wiLCB7IHNsb3Q6IFwiZmlsdGVyc1wiIH0sIHNob3dGaWx0ZXJCeVVzZXJzICYmIChoKFwiYXJjZ2lzLWdyb3VwLWJyb3dzZXItZmlsdGVyLWdyb3Vwcy1ieS11c2VyXCIsIHsgc2VhcmNoVXNlcm5hbWVzOiBncm91cEJyb3dzZXJBbGxVc2Vycy5tYXAoKHVzZXIpID0+IHVzZXIudXNlcm5hbWUpLCBzZWFyY2hVc2VybmFtZTogZ3JvdXBCcm93c2VyU2VhcmNoVXNlcm5hbWUsIG9uQXJjZ2lzR3JvdXBCcm93c2VyVXNlcm5hbWVzRmlsdGVyOiAoZXZlbnQpID0+IHtcbiAgICAgICAgICB0aGlzLmdyb3VwQnJvd3NlclNlYXJjaFVzZXJuYW1lID0gZXZlbnQuZGV0YWlsO1xuICAgICAgICB9IH0pKSwgaChcImFyY2dpcy1ncm91cC1icm93c2VyLWZpbHRlci1vd25lclwiLCB7IHNlYXJjaFVzZXJuYW1lOiBncm91cEJyb3dzZXJTZWFyY2hVc2VybmFtZSB9KSwgIWlzUHVibGljVXNlciAmJiAoaChGcmFnbWVudCwgbnVsbCwgaChcImFyY2dpcy1ncm91cC1icm93c2VyLWZpbHRlci1tZW1iZXJzaGlwXCIsIG51bGwpLCBoKFwiYXJjZ2lzLWdyb3VwLWJyb3dzZXItZmlsdGVyLW1lbWJlci1vcmdcIiwgbnVsbCksIGgoXCJhcmNnaXMtZ3JvdXAtYnJvd3Nlci1maWx0ZXItc3BlY2lhbC1ncm91cHNcIiwgbnVsbCkpKSwgaChcImFyY2dpcy1ncm91cC1icm93c2VyLWZpbHRlci1kYXRlXCIsIHsgcHJvcGVydHk6IFwibW9kaWZpZWRcIiB9KSwgaChcImFyY2dpcy1ncm91cC1icm93c2VyLWZpbHRlci1kYXRlXCIsIHsgcHJvcGVydHk6IFwiY3JlYXRlZFwiIH0pKSwgaChcImFyY2dpcy1ncm91cC1icm93c2VyLWNvbnRlbnRcIiwgeyBzbG90OiBcImNvbnRlbnRcIiwgY2xhc3M6IFwianMtY29udGVudFwiIH0sIChicm93c2VyR3JvdXBzIHx8IFtdKS5tYXAoKGdyb3VwKSA9PiB7XG4gICAgICAgIGNvbnN0IGdyb3VwSWQgPSBncm91cC5pZDtcbiAgICAgICAgcmV0dXJuIChoKFwiYXJjZ2lzLWl0ZW0tc2hhcmUtZ3JvdXAtY2FyZFwiLCB7IGtleTogZ3JvdXBJZCwgdXNlcjogdXNlciwgcG9ydGFsOiBwb3J0YWwsIGkxOG46IGkxOG4sIGdyb3VwOiBncm91cCwgZ3JvdXBDb3VudDogcGVuZGluZ0dyb3VwQnJvd3NlckRhdGEuZ3JvdXBDb3VudCwgaW5pdGlhbFNlbGVjdGVkR3JvdXBEYXRhTG9va3VwOiBpbml0aWFsU2VsZWN0ZWRHcm91cERhdGFMb29rdXAsIHNlbGVjdGVkR3JvdXBEYXRhTG9va3VwOiBwZW5kaW5nR3JvdXBCcm93c2VyRGF0YS5ncm91cERhdGFMb29rdXAsIHRvdGFsSXRlbUNvdW50OiB0b3RhbEl0ZW1Db3VudCwgb25SZXZlcnRDbGljazogKCkgPT4ge1xuICAgICAgICAgICAgLy8gQnkgb3BlbmluZyB0aGUgZ3JvdXAgYnJvd3NlciwgdGhlIHB1YmxpYyB1c2VyIGFscmVhZHkgaGF2ZVxuICAgICAgICAgICAgLy8gIHRvIHN3aXRjaCB0aGUgc2hhcmUgdG8gUFVCTElDIGFscmVhZHkgc28gdGhlcmUgaXMgbm8gbmVlZFxuICAgICAgICAgICAgLy8gIHRvIHNwaW4gdXAgdGhlIGNvbmZpcm1hdGlvbiBtb2RhbFxuICAgICAgICAgICAgcmV2ZXJ0UGVuZGluZ0dyb3VwRGF0YShncm91cElkKTtcbiAgICAgICAgICB9IH0pKTtcbiAgICAgIH0pKSwgaChcImFyY2dpcy1ncm91cC1icm93c2VyLXBhZ2luYXRpb25cIiwgeyBzbG90OiBcInBhZ2luYXRpb25cIiwgY2xhc3M6IFwianMtcGFnaW5hdGlvblwiLCB0b3RhbDogYnJvd3NlclBhZ2luYXRpb24gPT09IG51bGwgfHwgYnJvd3NlclBhZ2luYXRpb24gPT09IHZvaWQgMCA/IHZvaWQgMCA6IGJyb3dzZXJQYWdpbmF0aW9uLnRvdGFsLCBzdGFydDogYnJvd3NlclBhZ2luYXRpb24gPT09IG51bGwgfHwgYnJvd3NlclBhZ2luYXRpb24gPT09IHZvaWQgMCA/IHZvaWQgMCA6IGJyb3dzZXJQYWdpbmF0aW9uLnN0YXJ0LCBudW06IGJyb3dzZXJQYWdpbmF0aW9uID09PSBudWxsIHx8IGJyb3dzZXJQYWdpbmF0aW9uID09PSB2b2lkIDAgPyB2b2lkIDAgOiBicm93c2VyUGFnaW5hdGlvbi5udW0gfSkpKTtcbiAgICB9O1xuICAgIHRoaXMucmVuZGVyU2hhcmVTZWxlY3RHcm91cCA9ICgpID0+IHtcbiAgICAgIGNvbnN0IHsgY29uZmlnLCBoYXNJdGVtQmxvY2tlZEZyb21QdWJsaWMsIGhhc1NpbmdsZVNoYXJlTGV2ZWwsIGkxOG4sIGluaXRpYWxTZWxlY3RlZEdyb3VwRGF0YSwgaXNCcm93c2luZ0dyb3VwcywgaXNMb2FkaW5nLCBpc1B1YmxpY1VzZXIsIGlzU2hhcmVMZXZlbERpcnR5LCBpdGVtcywgbG9hZGluZ1RleHQsIHBvcnRhbCwgcG9zc2libGVTaGFyZUxldmVsT3B0aW9ucywgcmV2ZXJ0R3JvdXBEYXRhLCByZXZlcnRTaGFyZUxldmVsLCBzZWxlY3RlZEdyb3VwRGF0YSwgc2VsZWN0ZWRTaGFyZUxldmVscywgc2V0U2hhcmVMZXZlbCwgc2hhcmVMZXZlbENvdW50LCBzaGFyZUxldmVsSWNvbiwgc2hhcmVMZXZlbE9wdGlvbnMsIHNoYXJlTW9kZSwgc2hvd09wdGlvbnMsIHVzZXIsIGhhc1ByaXZhdGVJdGVtIH0gPSB0aGlzO1xuICAgICAgY29uc3QgdG90YWxJdGVtQ291bnQgPSBpdGVtcy5sZW5ndGg7XG4gICAgICBjb25zdCB0b3RhbEl0ZW1Db3VudFN0ciA9IHRvdGFsSXRlbUNvdW50LnRvU3RyaW5nKCk7XG4gICAgICBjb25zdCBkaXNhYmxlZFRleHQgPSBoYXNJdGVtQmxvY2tlZEZyb21QdWJsaWNcbiAgICAgICAgPyBpMThuLnNoYXJpbmdMaW1pdGVkSXRlbURpc2NsYWltZXJcbiAgICAgICAgOiBpMThuLmNhbm5vdFNoYXJlVG9MZXZlbERpc2NsYWltZXI7XG4gICAgICByZXR1cm4gKFxuICAgICAgLy8gISBIaWRkZW4gaW5zdGVhZCBvZiB1bm1vdW50IHRvIHByZXZlbnQgZGF0YSByZWZldGNoXG4gICAgICBoKFwiZGl2XCIsIHsgY2xhc3M6IHsgaGlkZGVuOiBpc0Jyb3dzaW5nR3JvdXBzIH0gfSwgaXNMb2FkaW5nICYmIGgoXCJhcmNnaXMtbmV3LWl0ZW0tbG9hZGVyXCIsIHsgYWN0aXZlOiBpc0xvYWRpbmcsIHRleHQ6IGxvYWRpbmdUZXh0IH0pLCBoKFwiZGl2XCIsIHsgY2xhc3M6IFwic2VjdGlvblwiIH0sIGgoXCJhcmNnaXMtbmV3LWl0ZW0tZGVzY3JpcHRpb25cIiwgeyBoZWFkZXI6IGkxOG4uc2hhcmVMZXZlbC50aXRsZSwgaGVhZGVyU2lkZUNvbnRlbnQ6IGlzU2hhcmVMZXZlbERpcnR5ICYmIChoKFwiY2FsY2l0ZS1idXR0b25cIiwgeyBhcHBlYXJhbmNlOiBcInRyYW5zcGFyZW50XCIsIGljb25TdGFydDogXCJyZXNldFwiLCBkaXNhYmxlZDogaXNMb2FkaW5nLCBvbkNsaWNrOiAoKSA9PiB7XG4gICAgICAgICAgICAvLyBpZiBhIHB1YmxpYyB1c2VyIHRyaWVzIHRvIHJldmVydCBpdGVtIGxldmVsc1xuICAgICAgICAgICAgLy8gYW5kIHRoZSBpbml0aWFsIHNoYXJlIGxldmVsIGluY2x1ZGVzIGF0IGxlYXN0IG9uZSBwcml2YXRlIGl0ZW1cbiAgICAgICAgICAgIC8vIGFuZCB0aG9zZSBpdGVtcyBoYXZlIGFsc28gYmVlbiBzaGFyZWQgdG8gZ3JvdXBzXG4gICAgICAgICAgICAvLyBkaXNwbGF5IGEgd2FybmluZyBtb2RhbFxuICAgICAgICAgICAgaWYgKHNob3dSZXZlcnRTaGFyZUxldmVsV2FybmluZyh1c2VyLCBpdGVtcywgc2VsZWN0ZWRHcm91cERhdGEpKSB7XG4gICAgICAgICAgICAgIHRoaXMuY29uZmlybWF0aW9uRGlhbG9nVHlwZSA9IFwicHVibGljQWNjb3VudFJldmVydFNoYXJlTGV2ZWxcIjtcbiAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV2ZXJ0U2hhcmVMZXZlbCgpO1xuICAgICAgICAgIH0gfSwgaTE4bi5yZXZlcnQpKSB9KSwgaChcImRpdlwiLCB7IGNsYXNzOiBcImNvbnRlbnQtY29udGFpbmVyXCIgfSwgaChcImNhbGNpdGUtdGlsZS1zZWxlY3QtZ3JvdXBcIiwgeyBsYXlvdXQ6IFwidmVydGljYWxcIiwgY2xhc3M6IFwidGlsZS1zZWxlY3RcIiB9LCBzaG93T3B0aW9ucyAmJlxuICAgICAgICBERUZBVUxUX1NIQVJFX0xFVkVMUy5tYXAoKG9wdGlvbikgPT4ge1xuICAgICAgICAgIGNvbnN0IGNhbm5vdFNlbGVjdCA9ICFwb3NzaWJsZVNoYXJlTGV2ZWxPcHRpb25zLmluY2x1ZGVzKG9wdGlvbik7XG4gICAgICAgICAgaWYgKGNhbm5vdFNlbGVjdCAmJiBpc1B1YmxpY1VzZXIpIHtcbiAgICAgICAgICAgIC8vIFdlIG9ubHkgd2FudCB0byBoaWRlIHRoZSBvcHRpb24gZm9yIHB1YmxpYyB1c2VyXG4gICAgICAgICAgICAvLyAgaW4gb3RoZXIgY2FzZXMsIHdlIGp1c3Qgd2FudCB0byBkaXNhYmxlIHRoZW1cbiAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICAgIH1cbiAgICAgICAgICBjb25zdCBpdGVtQ291bnQgPSBzaGFyZUxldmVsQ291bnRbb3B0aW9uXSArIChvcHRpb24gPT09IFwicHJpdmF0ZVwiID8gc2hhcmVMZXZlbENvdW50LnNoYXJlZCA6IDApO1xuICAgICAgICAgIGNvbnN0IGhhc0l0ZW1JbkNhdGVnb3J5ID0gaXRlbUNvdW50ID4gMDtcbiAgICAgICAgICBjb25zdCBpdGVtQ291bnRTdHIgPSBpdGVtQ291bnQudG9TdHJpbmcoKTtcbiAgICAgICAgICBjb25zdCB0aXRsZSA9IGkxOG4uc2hhcmVMZXZlbC5sZXZlbFtvcHRpb25dLnRpdGxlO1xuICAgICAgICAgIHJldHVybiAoaChcImRpdlwiLCB7IGNsYXNzOiBcInRpbGUtc2VsZWN0LXdyYXBwZXJcIiwga2V5OiBvcHRpb24gfSwgaChcImNhbGNpdGUtdGlsZS1zZWxlY3RcIiwgeyBjaGVja2VkOiBoYXNTaW5nbGVTaGFyZUxldmVsICYmIGhhc0l0ZW1JbkNhdGVnb3J5LCBoZWFkaW5nOiB0aXRsZSwgXCJhcmlhLWxhYmVsXCI6IGNhbm5vdFNlbGVjdCA/IGRpc2FibGVkVGV4dCA6IHVuZGVmaW5lZCwgZGVzY3JpcHRpb246IGkxOG4uc2hhcmVMZXZlbC5sZXZlbFtvcHRpb25dW1xuICAgICAgICAgICAgLy8gcHVibGljIHVzZXJzIGhhdmUgYSBkaWZmZXJlbnQgdGV4dCBkZXNjcmlwdGlvbiBmb3IgdGhlIFwiZXZlcnlvbmVcIiBzaGFyZSBsZXZlbCAoV2ViR0lTL2FyY2dpcy1wb3J0YWwtYXBwIzI2NDA1KVxuICAgICAgICAgICAgaXNQdWJsaWNVc2VyICYmIG9wdGlvbiA9PT0gXCJwdWJsaWNcIlxuICAgICAgICAgICAgICA/IFwiZGVzY3JpcHRpb25QdWJsaWNVc2VyXCJcbiAgICAgICAgICAgICAgOiBcImRlc2NyaXB0aW9uXCJdLCBuYW1lOiBcImRldi1jcmVkLWNyZWF0ZS1tb2RlXCIsIGlucHV0RW5hYmxlZDogdHJ1ZSwgd2lkdGg6IFwiZnVsbFwiLCB0eXBlOiBcInJhZGlvXCIsIHZhbHVlOiBvcHRpb24sIGljb246IHNoYXJlTGV2ZWxJY29uW29wdGlvbl0sIGRpc2FibGVkOiBpc0xvYWRpbmcgfHwgY2Fubm90U2VsZWN0LCBjbGFzczoge1xuICAgICAgICAgICAgICBcImFjdGl2ZS1idXQtbm90LXNlbGVjdGVkXCI6IGhhc0l0ZW1JbkNhdGVnb3J5ICYmICFoYXNTaW5nbGVTaGFyZUxldmVsXG4gICAgICAgICAgICB9LCBvbkNhbGNpdGVUaWxlU2VsZWN0Q2hhbmdlOiAoZSkgPT4ge1xuICAgICAgICAgICAgICBjb25zdCBuZXdTaGFyZUxldmVsID0gZS50YXJnZXQudmFsdWU7XG4gICAgICAgICAgICAgIC8vIGlmIGEgcHVibGljIHVzZXIgdHJpZXMgdG8gc2V0IGl0ZW0ocykgdG8gcHJpdmF0ZVxuICAgICAgICAgICAgICAvLyBhbmQgdGhlIGl0ZW1zIGFyZSBzaGFyZWQgdG8gZ3JvdXBzXG4gICAgICAgICAgICAgIC8vIGRpc3BsYXkgYSB3YXJuaW5nIG1vZGFsXG4gICAgICAgICAgICAgIGlmIChzaG93U2hhcmVMZXZlbENoYW5nZVdhcm5pbmcodXNlciwgbmV3U2hhcmVMZXZlbCwgc2VsZWN0ZWRHcm91cERhdGEpKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5jb25maXJtYXRpb25EaWFsb2dUeXBlID0gXCJwdWJsaWNBY2NvdW50U2V0U2hhcmVUb1ByaXZhdGVcIjtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgc2V0U2hhcmVMZXZlbChuZXdTaGFyZUxldmVsKTtcbiAgICAgICAgICAgIH0gfSksICFoYXNTaW5nbGVTaGFyZUxldmVsICYmIGhhc0l0ZW1JbkNhdGVnb3J5ICYmIChoKFwiZGl2XCIsIHsgY2xhc3M6IFwic2hhcmUtaGludFwiIH0sIGgoXCJhcmNnaXMtaW5mb3JtYXRpb25cIiwgeyBsYWJlbDogaTE4bi5zaGFyZUNvdW50TGFiZWwsIHBhZGRlZENvbnRlbnQ6IHRydWUsIHBsYWNlbWVudDogXCJib3R0b20tZW5kXCIsIG92ZXJsYXlQb3NpdGlvbmluZzogXCJmaXhlZFwiIH0sIGkxOG4uc2hhcmVDb3VudFRvb2x0aXBcbiAgICAgICAgICAgIC5yZXBsYWNlKFwiJHtzaGFyZUxldmVsfVwiLCB0aXRsZSlcbiAgICAgICAgICAgIC5yZXBsYWNlKFwiJHtudW1JdGVtfVwiLCBpdGVtQ291bnRTdHIpXG4gICAgICAgICAgICAucmVwbGFjZShcIiR7dG90YWxJdGVtfVwiLCB0b3RhbEl0ZW1Db3VudFN0cikpLCBoKFwicFwiLCBudWxsLCBpMThuLnNoYXJlQ291bnRIaW50XG4gICAgICAgICAgICAucmVwbGFjZShcIiR7bnVtSXRlbX1cIiwgaXRlbUNvdW50U3RyKVxuICAgICAgICAgICAgLnJlcGxhY2UoXCIke3RvdGFsSXRlbX1cIiwgdG90YWxJdGVtQ291bnRTdHIpKSkpKSk7XG4gICAgICAgIH0pKSwgc2hvd09wdGlvbnMgJiYgcG9zc2libGVTaGFyZUxldmVsT3B0aW9ucy5sZW5ndGggPCBzaGFyZUxldmVsT3B0aW9ucy5sZW5ndGggJiYgKGgoXCJwXCIsIHsgY2xhc3M6IFwiaW5mb3JtYXRpb24tdGV4dFwiIH0sIGkxOG4uc2hhcmluZ0xpbWl0ZWREaXNjbGFpbWVyKSksICghc2hvd09wdGlvbnMgfHwgIXBvc3NpYmxlU2hhcmVMZXZlbE9wdGlvbnMubGVuZ3RoKSAmJiAoaChcInBcIiwgeyBjbGFzczogXCJpbmZvcm1hdGlvbi10ZXh0XCIgfSwgaTE4bi5ub1NoYXJlRGlzY2xhaW1lcikpKSksIGgoXCJkaXZcIiwgeyBjbGFzczogXCJzZWN0aW9uXCIgfSwgaChcImFyY2dpcy1pdGVtLXNoYXJlLWdyb3VwXCIsIHsgaXRlbXM6IGl0ZW1zLCB1c2VyOiB1c2VyLCBwb3J0YWw6IHBvcnRhbCwgY29uZmlnOiBjb25maWcsIHNoYXJlTW9kZTogc2hhcmVNb2RlLCBpMThuOiBpMThuLnNoYXJlR3JvdXAsIGlzTG9hZGluZzogaXNMb2FkaW5nLCBvbkVkaXRHcm91cENsaWNrOiAoKSA9PiB7XG4gICAgICAgICAgLy8gUHVibGljIGFjY291bnQgbmVlZHMgdG8gc2hhcmUgaXRlbSB0byBwdWJsaWMgYmVmb3JlIHNoYXJpbmcgdG8gZ3JvdXBzXG4gICAgICAgICAgaWYgKHNob3dFZGl0R3JvdXBXYXJuaW5nKHVzZXIsIHNlbGVjdGVkU2hhcmVMZXZlbHMpKSB7XG4gICAgICAgICAgICB0aGlzLmNvbmZpcm1hdGlvbkRpYWxvZ1R5cGUgPSBcInB1YmxpY0FjY291bnRPcGVuR3JvdXBCcm93c2VyXCI7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgfVxuICAgICAgICAgIHRoaXMuaXNCcm93c2luZ0dyb3VwcyA9IHRydWU7XG4gICAgICAgIH0sIG9uQW5hbHl6ZVVzZXJHcm91cENvbXBsZXRlOiAoZSkgPT4ge1xuICAgICAgICAgIGNvbnN0IHsgaW5pdGlhbFNlbGVjdGVkR3JvdXBzOiBzZWxlY3RlZEdyb3VwRGF0YSwgdXNlckdyb3VwTG9va3VwLCBhbGxVc2Vycywgc2VhcmNoVXNlcm5hbWUgfSA9IGUuZGV0YWlsO1xuICAgICAgICAgIHRoaXMuaW5pdGlhbFNlbGVjdGVkR3JvdXBEYXRhID0gc2VsZWN0ZWRHcm91cERhdGE7XG4gICAgICAgICAgdGhpcy5zZWxlY3RlZEdyb3VwRGF0YSA9IHNlbGVjdGVkR3JvdXBEYXRhO1xuICAgICAgICAgIHRoaXMuaW5pdGlhbFNlbGVjdGVkR3JvdXBEYXRhTG9va3VwID0gYXJyYXlUb0xvb2t1cE1hcChzZWxlY3RlZEdyb3VwRGF0YSwgKHsgZ3JvdXAsIHNlbGVjdGVkQnlJdGVtSWRzIH0pID0+ICh7XG4gICAgICAgICAgICBrZXk6IGdyb3VwLmlkLFxuICAgICAgICAgICAgZGF0YTogc2VsZWN0ZWRCeUl0ZW1JZHMubGVuZ3RoID09PSAwXG4gICAgICAgICAgICAgID8gXCJub25lXCJcbiAgICAgICAgICAgICAgOiBzZWxlY3RlZEJ5SXRlbUlkcy5sZW5ndGggPT09IHRvdGFsSXRlbUNvdW50XG4gICAgICAgICAgICAgICAgPyBcImFsbFwiXG4gICAgICAgICAgICAgICAgOiBcImluZGV0ZXJtaW5hdGVcIlxuICAgICAgICAgIH0pKTtcbiAgICAgICAgICB0aGlzLmdyb3VwQnJvd3NlclNlYXJjaFVzZXJuYW1lID0gc2VhcmNoVXNlcm5hbWU7XG4gICAgICAgICAgdGhpcy5ncm91cEJyb3dzZXJBbGxVc2VycyA9IGFsbFVzZXJzO1xuICAgICAgICAgIHRoaXMuZ3JvdXBCcm93c2VyUSA9IGdldFVzZXJuYW1lUXVlcnkoe1xuICAgICAgICAgICAgc2hhcmVNb2RlLFxuICAgICAgICAgICAgY3VycmVudFVzZXJuYW1lOiBzZWFyY2hVc2VybmFtZSxcbiAgICAgICAgICAgIHVzZXIsXG4gICAgICAgICAgICB1c2VyR3JvdXBMb29rdXAsXG4gICAgICAgICAgICBpc1ByaXZhdGU6IGhhc1ByaXZhdGVJdGVtXG4gICAgICAgICAgfSk7XG4gICAgICAgIH0sIG9uRGlydHlDaGFuZ2U6IChlKSA9PiAodGhpcy5pc1NlbGVjdGVkR3JvdXBzRGlydHkgPSBlLmRldGFpbCksIG9uUmVtb3ZlQ2xpY2s6ICgpID0+ICh0aGlzLnNlbGVjdGVkR3JvdXBEYXRhID0gW10pLCBvblJldmVydENsaWNrOiAoKSA9PiB7XG4gICAgICAgICAgaWYgKHNob3dSZXZlcnRHcm91cFdhcm5pbmcodXNlciwgc2VsZWN0ZWRTaGFyZUxldmVscywgaW5pdGlhbFNlbGVjdGVkR3JvdXBEYXRhKSkge1xuICAgICAgICAgICAgdGhpcy5jb25maXJtYXRpb25EaWFsb2dUeXBlID0gXCJwdWJsaWNBY2NvdW50UmV2ZXJ0R3JvdXBcIjtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICB9XG4gICAgICAgICAgcmV2ZXJ0R3JvdXBEYXRhKCk7XG4gICAgICAgIH0sIHNlbGVjdGVkR3JvdXBEYXRhOiBzZWxlY3RlZEdyb3VwRGF0YSB9KSkpKTtcbiAgICB9O1xuICAgIHRoaXMucmVuZGVyU2hhcmVNb2RhbCA9ICgpID0+IHtcbiAgICAgIGNvbnN0IHsgY2xvc2VEaWFsb2csIGkxOG4sIGlzTG9hZGluZywgdXBkYXRlU2hhcmluZywgaXNTaGFyZUxldmVsRGlydHksIGlzU2VsZWN0ZWRHcm91cHNEaXJ0eSwgaXNCcm93c2luZ0dyb3VwcywgYXBwbHlQZW5kaW5nR3JvdXBEYXRhLCB1bkJyb3dzZUdyb3VwcywgcmVuZGVyU2hhcmVTZWxlY3RHcm91cCwgcmVuZGVyR3JvdXBCcm93c2VyLCBjdXJyZW50U3RlcCwgaGFzU2hhcmluZ0lzc3VlLCBwZW5kaW5nR3JvdXBCcm93c2VyRGF0YSB9ID0gdGhpcztcbiAgICAgIGNvbnN0IGhhc0NoYW5nZXMgPSBpc1NoYXJlTGV2ZWxEaXJ0eSB8fCBpc1NlbGVjdGVkR3JvdXBzRGlydHk7XG4gICAgICByZXR1cm4gKChjdXJyZW50U3RlcCA9PT0gXCJzaGFyZVwiIHx8IGhhc1NoYXJpbmdJc3N1ZSA9PT0gbnVsbCkgJiYgKGgoXCJjYWxjaXRlLW1vZGFsXCIsIHsgb25DYWxjaXRlTW9kYWxDbG9zZTogY2xvc2VEaWFsb2csXG4gICAgICAgIC8vICEgRG9uJ3QgdXNlIHRoZSBjb25kaXRpb24gZGlyZWN0bHkgaGVyZSBvciB0aGUgYG9uQ2FsY2l0ZU1vZGFsQ2xvc2VgIHdpbGwgYmUgdHJpZ2dlcmVkXG4gICAgICAgIG9wZW46IHRydWUsIHdpZHRoOiBpc0Jyb3dzaW5nR3JvdXBzID8gXCJtXCIgOiBcInNcIiwgb3V0c2lkZUNsb3NlRGlzYWJsZWQ6IHRydWUsIGVzY2FwZURpc2FibGVkOiB0cnVlLCBjbGFzczogeyBcImdyb3VwLWJyb3dzZXItbW9kYWxcIjogaXNCcm93c2luZ0dyb3VwcyB9IH0sIGgoXCJkaXZcIiwgeyBzbG90OiBcImhlYWRlclwiIH0sIGkxOG5baXNCcm93c2luZ0dyb3VwcyA/IFwidGl0bGVHcm91cFwiIDogXCJ0aXRsZVwiXSksIGgoXCJkaXZcIiwgeyBzbG90OiBcImNvbnRlbnRcIiwgY2xhc3M6IFwic3RhZ2VcIiB9LCByZW5kZXJHcm91cEJyb3dzZXIoKSwgcmVuZGVyU2hhcmVTZWxlY3RHcm91cCgpKSwgIWlzQnJvd3NpbmdHcm91cHMgPyAoaChGcmFnbWVudCwgbnVsbCwgaChcImNhbGNpdGUtYnV0dG9uXCIsIHsgc2xvdDogXCJwcmltYXJ5XCIsIGFwcGVhcmFuY2U6IFwib3V0bGluZVwiLCBraW5kOiBcImJyYW5kXCIsIFwiZGF0YS1pZFwiOiBcImNhbmNlbEJ1dHRvblwiLCBvbkNsaWNrOiAoKSA9PiBjbG9zZURpYWxvZygpLCB3aWR0aDogXCJmdWxsXCIgfSwgaTE4bi5jYW5jZWwpLCBoYXNDaGFuZ2VzICYmIChoKFwiY2FsY2l0ZS1idXR0b25cIiwgeyBzbG90OiBcInNlY29uZGFyeVwiLCBhcHBlYXJhbmNlOiBcInNvbGlkXCIsIGtpbmQ6IFwiYnJhbmRcIiwgXCJkYXRhLWlkXCI6IFwibmV4dEJ1dHRvblwiLCBvbkNsaWNrOiB1cGRhdGVTaGFyaW5nLCB3aWR0aDogXCJmdWxsXCIsIGRpc2FibGVkOiBpc0xvYWRpbmcgfSwgaTE4bi5zYXZlKSkpKSA6IChoKEZyYWdtZW50LCBudWxsLCBoKFwiY2FsY2l0ZS1idXR0b25cIiwgeyBzbG90OiBcInByaW1hcnlcIiwgYXBwZWFyYW5jZTogXCJvdXRsaW5lXCIsIGtpbmQ6IFwiYnJhbmRcIiwgXCJkYXRhLWlkXCI6IFwiY2FuY2VsQnV0dG9uXCIsIG9uQ2xpY2s6IHVuQnJvd3NlR3JvdXBzLCB3aWR0aDogXCJmdWxsXCIgfSwgaTE4bi5jYW5jZWwpLCBwZW5kaW5nR3JvdXBCcm93c2VyRGF0YS5pc0RpcnR5ICYmIChoKFwiY2FsY2l0ZS1idXR0b25cIiwgeyBzbG90OiBcInNlY29uZGFyeVwiLCBhcHBlYXJhbmNlOiBcInNvbGlkXCIsIGtpbmQ6IFwiYnJhbmRcIiwgb25DbGljazogYXBwbHlQZW5kaW5nR3JvdXBEYXRhLCB3aWR0aDogXCJmdWxsXCIgfSwgaTE4bi5hcHBseSkpKSkpKSk7XG4gICAgfTtcbiAgICB0aGlzLnJlbmRlckRlcENoZWNrTW9kYWwgPSAoKSA9PiB7XG4gICAgICBjb25zdCB7IGFwaSwgY29uZmlnLCBwb3J0YWwsIHVzZXIsIGl0ZW1zLCBjbG9zZURpYWxvZywgaGFzU2hhcmluZ0lzc3VlLCBzaGFyaW5nRGV0YWlsIH0gPSB0aGlzO1xuICAgICAgcmV0dXJuIChoYXNTaGFyaW5nSXNzdWUgJiYgKGgoXCJhcmNnaXMtZGVwZW5kZW5jeS1jaGVja1wiLCB7IGFwaTogYXBpLCBpdGVtczogaXRlbXMubWFwKChpdGVtKSA9PiAoeyBpdGVtIH0pKSwgcG9ydGFsOiBwb3J0YWwsIHVzZXI6IHVzZXIsIGNvbmZpZzogY29uZmlnLFxuICAgICAgICAvLyAhIERvbid0IHVzZSB0aGUgY29uZGl0aW9uIGRpcmVjdGx5IGhlcmUgb3IgdGhlIGBvbkNhbGNpdGVNb2RhbENsb3NlYCB3aWxsIGJlIHRyaWdnZXJlZFxuICAgICAgICBpc0FjdGl2ZTogdHJ1ZSwgcHJlUHJvY2Vzc2VkU2hhcmluZ0RldGFpbDogc2hhcmluZ0RldGFpbCwgb25Xb3JrZmxvd0NhbmNlbDogY2xvc2VEaWFsb2csIG9uV29ya2Zsb3dDb21wbGV0ZTogKGV2ZW50KSA9PiB7XG4gICAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgICAgdGhpcy5kaWRVcGRhdGVTaGFyaW5nRGV0YWlsID0gdHJ1ZTtcbiAgICAgICAgICAvLyBXZSBkb24ndCBjYWxsIHRoaXMgc2luY2Ugd2UganVzdCB3YW50IHRvIGNsb3NlIHRoZSBtb2RhbFxuICAgICAgICAgIC8vICBidXQgaWYgd2Ugd2FudCB0byBzaG93IGFueSB1bmRlcmx5aW5nIGlzc3VlIGFmdGVyIHJlY2hlY2ssIHdlIGNhbiBlbmFibGUgaXRcbiAgICAgICAgICAvLyBjaGVja1NoYXJpbmdJc3N1ZShzZWxlY3RlZEl0ZW1zKTtcbiAgICAgICAgICAvLyBSZXZlcnQgc2hhcmluZyBkZXRhaWwgdG8gdHJpZ2dlciB0aGUgZW5kIHN0YXRlXG4gICAgICAgICAgdGhpcy5zaGFyaW5nRGV0YWlsVG9FbWl0ID0gT2JqZWN0LmFzc2lnbih7fSwgc2hhcmluZ0RldGFpbCk7XG4gICAgICAgICAgdGhpcy5zaGFyaW5nRGV0YWlsID0gT2JqZWN0LmFzc2lnbih7fSwgREVGQVVMVF9TSEFSSU5HX0RFVEFJTCk7XG4gICAgICAgIH0gfSkpKTtcbiAgICB9O1xuICAgIHRoaXMucmVuZGVyQ29uZmlybWF0aW9uRGlhbG9nID0gKCkgPT4ge1xuICAgICAgY29uc3QgeyBjb25maXJtYXRpb25EaWFsb2dUeXBlIH0gPSB0aGlzO1xuICAgICAgaWYgKCFjb25maXJtYXRpb25EaWFsb2dUeXBlKSB7XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgICAgfVxuICAgICAgY29uc3QgeyBpMThuLCBpc0xvYWRpbmcsIHJldmVydFNoYXJlTGV2ZWwsIHNldFNoYXJlTGV2ZWwsIHJldmVydEdyb3VwRGF0YSB9ID0gdGhpcztcbiAgICAgIGNvbnN0IHsgdGl0bGUsIGRlc2NyaXB0aW9uIH0gPSBpMThuLnNoYXJlV2FybmluZ1tjb25maXJtYXRpb25EaWFsb2dUeXBlXTtcbiAgICAgIGNvbnN0IGlzUERDRGlzYWJsZWRFcnJvciA9IGNvbmZpcm1hdGlvbkRpYWxvZ1R5cGUgPT09IFwicHVibGljRGF0YUNvbGxlY3Rpb25EaXNhYmxlZFwiO1xuICAgICAgcmV0dXJuIChoKFwiY2FsY2l0ZS1tb2RhbFwiLCB7IG9uQ2FsY2l0ZU1vZGFsQ2xvc2U6IChldmVudCkgPT4ge1xuICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICAgIHRoaXMuY29uZmlybWF0aW9uRGlhbG9nVHlwZSA9IG51bGw7XG4gICAgICAgIH0sIG9wZW46ICEhdGhpcy5jb25maXJtYXRpb25EaWFsb2dUeXBlLCB3aWR0aDogXCJzXCIsIG91dHNpZGVDbG9zZURpc2FibGVkOiB0cnVlLCBlc2NhcGVEaXNhYmxlZDogdHJ1ZSB9LCBoKFwiZGl2XCIsIHsgc2xvdDogXCJoZWFkZXJcIiwgY2xhc3M6IFwiaGVhZGVyXCIgfSwgdGl0bGUpLCBoKFwiZGl2XCIsIHsgc2xvdDogXCJjb250ZW50XCIgfSwgZGVzY3JpcHRpb24pLCBoKFwiY2FsY2l0ZS1idXR0b25cIiwgeyBzbG90OiBcInByaW1hcnlcIiwgYXBwZWFyYW5jZTogaXNQRENEaXNhYmxlZEVycm9yID8gXCJzb2xpZFwiIDogXCJvdXRsaW5lXCIsIGtpbmQ6IFwiYnJhbmRcIiwgXCJkYXRhLWlkXCI6IFwiY2FuY2VsQnV0dG9uXCIsIG9uQ2xpY2s6ICgpID0+ICh0aGlzLmNvbmZpcm1hdGlvbkRpYWxvZ1R5cGUgPSBudWxsKSwgd2lkdGg6IFwiZnVsbFwiIH0sIGkxOG5baXNQRENEaXNhYmxlZEVycm9yID8gXCJva1wiIDogXCJjYW5jZWxcIl0pLCAhaXNQRENEaXNhYmxlZEVycm9yICYmIChoKFwiY2FsY2l0ZS1idXR0b25cIiwgeyBzbG90OiBcInNlY29uZGFyeVwiLCBhcHBlYXJhbmNlOiBcInNvbGlkXCIsIGtpbmQ6IFwiYnJhbmRcIiwgXCJkYXRhLWlkXCI6IFwibmV4dEJ1dHRvblwiLCBvbkNsaWNrOiAoKSA9PiB7XG4gICAgICAgICAgc3dpdGNoIChjb25maXJtYXRpb25EaWFsb2dUeXBlKSB7XG4gICAgICAgICAgICBjYXNlIFwicHVibGljQWNjb3VudE9wZW5Hcm91cEJyb3dzZXJcIjpcbiAgICAgICAgICAgICAgc2V0U2hhcmVMZXZlbChcInB1YmxpY1wiKTtcbiAgICAgICAgICAgICAgdGhpcy5pc0Jyb3dzaW5nR3JvdXBzID0gdHJ1ZTtcbiAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlIFwicHVibGljQWNjb3VudFNldFNoYXJlVG9Qcml2YXRlXCI6XG4gICAgICAgICAgICAgIHNldFNoYXJlTGV2ZWwoXCJwcml2YXRlXCIpO1xuICAgICAgICAgICAgICB0aGlzLnNlbGVjdGVkR3JvdXBEYXRhID0gW107XG4gICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSBcInB1YmxpY0FjY291bnRSZXZlcnRTaGFyZUxldmVsXCI6XG4gICAgICAgICAgICAgIHJldmVydFNoYXJlTGV2ZWwoKTtcbiAgICAgICAgICAgICAgdGhpcy5zZWxlY3RlZEdyb3VwRGF0YSA9IFtdO1xuICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgXCJwdWJsaWNBY2NvdW50UmV2ZXJ0R3JvdXBcIjpcbiAgICAgICAgICAgICAgc2V0U2hhcmVMZXZlbChcInB1YmxpY1wiKTtcbiAgICAgICAgICAgICAgcmV2ZXJ0R3JvdXBEYXRhKCk7XG4gICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSBcInB1YmxpY0RhdGFDb2xsZWN0aW9uRW5hYmxlZFwiOlxuICAgICAgICAgICAgICB0aGlzLmNvbmZpcm1lZFBEQyA9IHRydWU7XG4gICAgICAgICAgICAgIHRoaXMudXBkYXRlU2hhcmluZygpO1xuICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICB9XG4gICAgICAgICAgdGhpcy5jb25maXJtYXRpb25EaWFsb2dUeXBlID0gbnVsbDtcbiAgICAgICAgfSwgd2lkdGg6IFwiZnVsbFwiLCBkaXNhYmxlZDogaXNMb2FkaW5nIH0sIGkxOG4udXBkYXRlKSkpKTtcbiAgICB9O1xuICAgIHRoaXMuYXBpID0gdW5kZWZpbmVkO1xuICAgIHRoaXMudXNlciA9IHVuZGVmaW5lZDtcbiAgICB0aGlzLnBvcnRhbCA9IHVuZGVmaW5lZDtcbiAgICB0aGlzLmNvbmZpZyA9IHVuZGVmaW5lZDtcbiAgICB0aGlzLml0ZW1zID0gdW5kZWZpbmVkO1xuICAgIHRoaXMuaGFzVHJ1c3RlZE9yZ3MgPSBmYWxzZTtcbiAgICB0aGlzLmlzTG9hZGluZyA9IHVuZGVmaW5lZDtcbiAgICB0aGlzLnNlbGVjdGVkU2hhcmVMZXZlbHMgPSBbXTtcbiAgICB0aGlzLmlzU2hhcmVMZXZlbERpcnR5ID0gZmFsc2U7XG4gICAgdGhpcy5zaGFyZUxldmVsQ291bnQgPSB7XG4gICAgICBwcml2YXRlOiAwLFxuICAgICAgc2hhcmVkOiAwLFxuICAgICAgb3JnOiAwLFxuICAgICAgcHVibGljOiAwXG4gICAgfTtcbiAgICB0aGlzLmhhc1NpbmdsZVNoYXJlTGV2ZWwgPSBmYWxzZTtcbiAgICB0aGlzLnNlbGVjdGVkR3JvdXBEYXRhID0gW107XG4gICAgdGhpcy5pc1NlbGVjdGVkR3JvdXBzRGlydHkgPSBmYWxzZTtcbiAgICB0aGlzLmxvYWRpbmdUZXh0ID0gbnVsbDtcbiAgICB0aGlzLmlzQnJvd3NpbmdHcm91cHMgPSBmYWxzZTtcbiAgICB0aGlzLmNvbmZpcm1hdGlvbkRpYWxvZ1R5cGUgPSBudWxsO1xuICAgIHRoaXMuY29uZmlybWVkUERDID0gZmFsc2U7XG4gICAgdGhpcy5icm93c2VyUGFnaW5hdGlvbiA9IHVuZGVmaW5lZDtcbiAgICB0aGlzLmJyb3dzZXJHcm91cHMgPSBbXTtcbiAgICB0aGlzLnBlbmRpbmdHcm91cEJyb3dzZXJEYXRhID0ge1xuICAgICAgZ3JvdXBEYXRhOiBbXSxcbiAgICAgIGdyb3VwRGF0YUxvb2t1cDoge30sXG4gICAgICBncm91cENvdW50OiB7fSxcbiAgICAgIGlzRGlydHk6IGZhbHNlXG4gICAgfTtcbiAgICB0aGlzLmdyb3VwQnJvd3NlclEgPSBcIlwiO1xuICAgIHRoaXMuZ3JvdXBCcm93c2VyU2VhcmNoVXNlcm5hbWUgPSBcIlwiO1xuICAgIHRoaXMuZ3JvdXBCcm93c2VyQWxsVXNlcnMgPSBbXTtcbiAgICB0aGlzLmN1cnJlbnRTdGVwID0gXCJzaGFyZVwiO1xuICAgIHRoaXMuc2hhcmluZ0RldGFpbCA9IG51bGw7XG4gICAgdGhpcy5oYXNTaGFyaW5nSXNzdWUgPSBudWxsO1xuICB9XG4gIGhhbmRsZUlzQnJvd3NpbmdHcm91cHNDaGFuZ2UoKSB7XG4gICAgaWYgKHRoaXMuaXNCcm93c2luZ0dyb3Vwcykge1xuICAgICAgdGhpcy5oYW5kbGVOZXdQZW5kaW5nU2VsZWN0ZWRHcm91cHModGhpcy5zZWxlY3RlZEdyb3VwRGF0YS5tYXAoKHsgZ3JvdXAgfSkgPT4gZ3JvdXApKTtcbiAgICB9XG4gIH1cbiAgaGFuZGxlU2hhcmVMZXZlbENoYW5nZSgpIHtcbiAgICBjb25zdCB7IHNlbGVjdGVkU2hhcmVMZXZlbHMsIGluaXRpYWxTaGFyZUxldmVscywgc2VsZWN0ZWRHcm91cERhdGEsIGl0ZW1zIH0gPSB0aGlzO1xuICAgIHRoaXMuaXNTaGFyZUxldmVsRGlydHkgPSBpc1NoYXJlTGV2ZWxEaXJ0eShzZWxlY3RlZFNoYXJlTGV2ZWxzLCBpbml0aWFsU2hhcmVMZXZlbHMsIGl0ZW1zLCBzZWxlY3RlZEdyb3VwRGF0YSk7XG4gICAgdGhpcy5zaGFyZUxldmVsQ291bnQgPSBzZWxlY3RlZFNoYXJlTGV2ZWxzLnJlZHVjZSgoYWNjLCBjdXIpID0+IHtcbiAgICAgIGFjY1tjdXJdKys7XG4gICAgICByZXR1cm4gYWNjO1xuICAgIH0sIHsgcHJpdmF0ZTogMCwgc2hhcmVkOiAwLCBvcmc6IDAsIHB1YmxpYzogMCB9KTtcbiAgICB0aGlzLmhhc1NpbmdsZVNoYXJlTGV2ZWwgPSBzZWxlY3RlZFNoYXJlTGV2ZWxzLmV2ZXJ5KChjdXIpID0+IGN1ciA9PT0gc2VsZWN0ZWRTaGFyZUxldmVsc1swXSk7XG4gIH1cbiAgYXN5bmMgY29tcG9uZW50V2lsbExvYWQoKSB7XG4gICAgdmFyIF9hO1xuICAgIHRoaXMuaXRlbXMgPSB0aGlzLml0ZW1zLm1hcCgoaXRlbSkgPT4geyB2YXIgX2E7IHJldHVybiAoX2EgPSBpdGVtLnNvdXJjZUpTT04pICE9PSBudWxsICYmIF9hICE9PSB2b2lkIDAgPyBfYSA6IGl0ZW07IH0pO1xuICAgIGNvbnN0IHsgaXRlbXMsIHBvcnRhbCwgdXNlciwgZWwgfSA9IHRoaXM7XG4gICAgY29uc3QgbG9jYWxlID0gYXdhaXQgZ2V0TG9jYWxlQ29tcG9uZW50U3RyaW5ncyhlbCk7XG4gICAgdGhpcy5pMThuID0gbG9jYWxlWzBdO1xuICAgIC8vIFRoaXMgYXNzdW1lIHRoYXQgb25jZSB0aGUgbG9hZGluZyB0ZXh0IGNoYW5nZXMgdG8gdXBkYXRpbmdJbmZvLFxuICAgIC8vICBpdCB3aWxsIG5vdCBjaGFuZ2UgYmFjayB0byByZXRyaWV2aW5nSW5mb1xuICAgIHRoaXMubG9hZGluZ1RleHQgPSB0aGlzLmkxOG4ucmV0cmlldmluZ0luZm87XG4gICAgY29uZmlnU3RhdGUuYXBpID0gdGhpcy5hcGk7XG4gICAgdGhpcy5pc1B1YmxpY1VzZXIgPSBpc1B1YmxpY1VzZXIodXNlcik7XG4gICAgdGhpcy5pbml0aWFsU2hhcmVMZXZlbHMgPSBpdGVtcy5tYXAoKGl0ZW0pID0+IGl0ZW0uYWNjZXNzKTtcbiAgICB0aGlzLnNlbGVjdGVkU2hhcmVMZXZlbHMgPSBbLi4udGhpcy5pbml0aWFsU2hhcmVMZXZlbHNdO1xuICAgIHRoaXMucG9zc2libGVTaGFyZUxldmVsT3B0aW9ucyA9IGdldFBvc3NpYmxlU2hhcmVMZXZlbCh1c2VyLCBpdGVtcywgcG9ydGFsKTtcbiAgICBjb25zdCBzaGFyZU1vZGUgPSBnZXRTaGFyZU1vZGUoaXRlbXMsIHVzZXIsIHBvcnRhbCk7XG4gICAgdGhpcy5zaG93T3B0aW9ucyA9IHNoYXJlTW9kZSAhPT0gXCJncm91cFwiO1xuICAgIHRoaXMuc2hhcmVNb2RlID0gc2hhcmVNb2RlO1xuICAgIHRoaXMuaGFzUHJpdmF0ZUl0ZW0gPSBpdGVtcy5zb21lKChpdGVtKSA9PiBpdGVtLmFjY2VzcyA9PT0gXCJwcml2YXRlXCIpO1xuICAgIGNvbnN0IHN1YnNjcmlwdGlvbkluZm8gPSAocG9ydGFsID09PSBudWxsIHx8IHBvcnRhbCA9PT0gdm9pZCAwID8gdm9pZCAwIDogcG9ydGFsLnN1YnNjcmlwdGlvbkluZm8pIHx8ICgoX2EgPSBwb3J0YWwgPT09IG51bGwgfHwgcG9ydGFsID09PSB2b2lkIDAgPyB2b2lkIDAgOiBwb3J0YWwuc291cmNlSlNPTikgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLnN1YnNjcmlwdGlvbkluZm8pO1xuICAgIHRoaXMuaGFzSXRlbUJsb2NrZWRGcm9tUHVibGljID1cbiAgICAgIGl0ZW1zLnNvbWUoaXNCbG9ja2VkRnJvbVNoYXJpbmdUb1B1YmxpYykgfHxcbiAgICAgICAgKGlzRGV2ZWxvcGVyKHN1YnNjcmlwdGlvbkluZm8pICYmIGl0ZW1zLnNvbWUoaXNCbG9ja2VkRnJvbURldmVsb3BlclNoYXJpbmdUb1B1YmxpYykpO1xuICAgIHRoaXMuaGFzSW5kb29yc1NwYWNlcyA9IGl0ZW1zLnNvbWUoKGl0ZW0pID0+IHsgdmFyIF9hOyByZXR1cm4gKF9hID0gaXRlbS50eXBlS2V5d29yZHMpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5pbmNsdWRlcyhcIkVkaXRFeHRlbnNpb25JbmRvb3JzU3BhY2VzXCIpOyB9KTtcbiAgfVxuICBoYW5kbGVTaGFyaW5nRGV0YWlsQ2hhbmdlKCkge1xuICAgIGNvbnN0IHsgc2hhcmluZ0RldGFpbCB9ID0gdGhpcztcbiAgICB0aGlzLmhhc1NoYXJpbmdJc3N1ZSA9XG4gICAgICBzaGFyaW5nRGV0YWlsICE9PSBudWxsXG4gICAgICAgID8gT2JqZWN0LmtleXMoc2hhcmluZ0RldGFpbCkuc29tZSgoZGV0YWlsVHlwZSkgPT4gc2hhcmluZ0RldGFpbFtkZXRhaWxUeXBlXS5sZW5ndGggPiAwKVxuICAgICAgICA6IG51bGw7XG4gIH1cbiAgaGFuZGxlSGFzU2hhcmluZ0lzc3VlQ2hhbmdlKCkge1xuICAgIGNvbnN0IHsgaGFzU2hhcmluZ0lzc3VlIH0gPSB0aGlzO1xuICAgIGlmIChoYXNTaGFyaW5nSXNzdWUpIHtcbiAgICAgIHRoaXMuY3VycmVudFN0ZXAgPSBcInJldmlldy1zaGFyaW5nXCI7XG4gICAgfVxuICAgIGVsc2UgaWYgKGhhc1NoYXJpbmdJc3N1ZSA9PT0gZmFsc2UpIHtcbiAgICAgIHRoaXMuY3VycmVudFN0ZXAgPSBcImZpbmlzaFwiO1xuICAgIH1cbiAgfVxuICBoYW5kbGVDdXJyZW50U3RlcENoYW5nZSgpIHtcbiAgICB2YXIgX2EsIF9iO1xuICAgIGNvbnN0IHsgY3VycmVudFN0ZXAsIGRpZFVwZGF0ZVNoYXJpbmdEZXRhaWwsIHdvcmtmbG93Q29tcGxldGUsIHNoYXJpbmdEZXRhaWxUb0VtaXQsIHNoYXJlSXRlbVJlc3VsdCB9ID0gdGhpcztcbiAgICBpZiAoY3VycmVudFN0ZXAgIT09IFwiZmluaXNoXCIpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgY29uc3QgZGlkVXBkYXRlRGVwZW5kZW50TGF5ZXJzU2hhcmluZyA9IGRpZFVwZGF0ZVNoYXJpbmdEZXRhaWw7XG4gICAgd29ya2Zsb3dDb21wbGV0ZS5lbWl0KHtcbiAgICAgIC8vIE5vIHBvaW50IGluIHVwZGF0aW5nIGRlcCBsYXllcnMgaWYgdGhlIHVzZXJzIGRpZG4ndCBnbyB0aHJvdWdoIHJldmlldyBzaGFyaW5nIGZsb3dcbiAgICAgIGRlcGVuZGVudExheWVyc1dpdGhTb3VyY2VJdGVtczogZGlkVXBkYXRlRGVwZW5kZW50TGF5ZXJzU2hhcmluZyAmJiBzaGFyaW5nRGV0YWlsVG9FbWl0XG4gICAgICAgID8gT2JqZWN0LnZhbHVlcyhzaGFyaW5nRGV0YWlsVG9FbWl0KS5yZWR1Y2UoKGFjYywgaXRlbVNoYXJpbmdEZXRhaWxSZXN1bHRzKSA9PiB7XG4gICAgICAgICAgYWNjLnB1c2goLi4uaXRlbVNoYXJpbmdEZXRhaWxSZXN1bHRzLm1hcCgoeyBsYXllciwgc291cmNlSXRlbSB9KSA9PiAoe1xuICAgICAgICAgICAgbGF5ZXIsXG4gICAgICAgICAgICBzb3VyY2VJdGVtXG4gICAgICAgICAgfSkpKTtcbiAgICAgICAgICByZXR1cm4gYWNjO1xuICAgICAgICB9LCBbXSlcbiAgICAgICAgOiBbXSxcbiAgICAgIG5ld1NoYXJlTGV2ZWw6IChfYSA9IHNoYXJlSXRlbVJlc3VsdCA9PT0gbnVsbCB8fCBzaGFyZUl0ZW1SZXN1bHQgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHNoYXJlSXRlbVJlc3VsdC5uZXdTaGFyZUxldmVsKSAhPT0gbnVsbCAmJiBfYSAhPT0gdm9pZCAwID8gX2EgOiBudWxsLFxuICAgICAgc2hhcmVFcnJvcnM6IChfYiA9IHNoYXJlSXRlbVJlc3VsdCA9PT0gbnVsbCB8fCBzaGFyZUl0ZW1SZXN1bHQgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHNoYXJlSXRlbVJlc3VsdC5zaGFyZUVycm9ycykgIT09IG51bGwgJiYgX2IgIT09IHZvaWQgMCA/IF9iIDogW10sXG4gICAgICBkaWRVcGRhdGVEZXBlbmRlbnRMYXllcnNTaGFyaW5nXG4gICAgfSk7XG4gIH1cbiAgcmVuZGVyKCkge1xuICAgIGNvbnN0IHsgcmVuZGVyU2hhcmVNb2RhbCwgcmVuZGVyRGVwQ2hlY2tNb2RhbCwgcmVuZGVyQ29uZmlybWF0aW9uRGlhbG9nIH0gPSB0aGlzO1xuICAgIHJldHVybiAoaChGcmFnbWVudCwgbnVsbCwgcmVuZGVyU2hhcmVNb2RhbCgpLCByZW5kZXJEZXBDaGVja01vZGFsKCksIHJlbmRlckNvbmZpcm1hdGlvbkRpYWxvZygpKSk7XG4gIH1cbiAgZ2V0IGVsKCkgeyByZXR1cm4gZ2V0RWxlbWVudCh0aGlzKTsgfVxuICBzdGF0aWMgZ2V0IHdhdGNoZXJzKCkgeyByZXR1cm4ge1xuICAgIFwiaXNCcm93c2luZ0dyb3Vwc1wiOiBbXCJoYW5kbGVJc0Jyb3dzaW5nR3JvdXBzQ2hhbmdlXCJdLFxuICAgIFwic2VsZWN0ZWRTaGFyZUxldmVsc1wiOiBbXCJoYW5kbGVTaGFyZUxldmVsQ2hhbmdlXCJdLFxuICAgIFwic2hhcmluZ0RldGFpbFwiOiBbXCJoYW5kbGVTaGFyaW5nRGV0YWlsQ2hhbmdlXCJdLFxuICAgIFwiaGFzU2hhcmluZ0lzc3VlXCI6IFtcImhhbmRsZUhhc1NoYXJpbmdJc3N1ZUNoYW5nZVwiXSxcbiAgICBcImN1cnJlbnRTdGVwXCI6IFtcImhhbmRsZUN1cnJlbnRTdGVwQ2hhbmdlXCJdXG4gIH07IH1cbn07XG5BcmNnaXNJdGVtU2hhcmUuc3R5bGUgPSBhcmNnaXNJdGVtU2hhcmVDc3M7XG5cbmV4cG9ydCB7IEFyY2dpc0l0ZW1TaGFyZSBhcyBhcmNnaXNfaXRlbV9zaGFyZSB9O1xuIl0sIm5hbWVzIjpbXSwic291cmNlUm9vdCI6IiJ9
"use strict";
(self["webpackChunkexb_client"] = self["webpackChunkexb_client"] || []).push([["vendors-extensions_widgets_arcgis_analysis_node_modules_arcgis_app-components_dist_esm_data-s-2d22c0"],{

/***/ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/data-store-f509564d.js":
/*!****************************************************************************************************************!*\
  !*** ./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/data-store-f509564d.js ***!
  \****************************************************************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   a: () => (/* binding */ addDataStore),
/* harmony export */   b: () => (/* binding */ requestCloudStoreList),
/* harmony export */   c: () => (/* binding */ validateDatastoreForServers),
/* harmony export */   d: () => (/* binding */ checkServersType),
/* harmony export */   e: () => (/* binding */ validateDatastoreServer),
/* harmony export */   f: () => (/* binding */ fetchCloudStorageRegionInfo),
/* harmony export */   g: () => (/* binding */ getDatastoreContents),
/* harmony export */   h: () => (/* binding */ handleDatabaseFileDrop),
/* harmony export */   p: () => (/* binding */ publishFromDataStore),
/* harmony export */   r: () => (/* binding */ requestCloudStoreInfo),
/* harmony export */   v: () => (/* binding */ validateDatastoreForOnline)
/* harmony export */ });
/* harmony import */ var _portal_79caaeff_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./portal-79caaeff.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/portal-79caaeff.js");
/* harmony import */ var _item_d9d70416_js__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./item-d9d70416.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/item-d9d70416.js");
/* harmony import */ var _config_eb5f7dc2_js__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./config-eb5f7dc2.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/config-eb5f7dc2.js");
/* harmony import */ var _functional_c82f5ab9_js__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ./functional-c82f5ab9.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/functional-c82f5ab9.js");
/* harmony import */ var _data_store_e8b5ce2f_js__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ./data-store-e8b5ce2f.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/data-store-e8b5ce2f.js");
/* harmony import */ var _feature_layer_38cdae87_js__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! ./feature-layer-38cdae87.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/feature-layer-38cdae87.js");
/* harmony import */ var _server_item_f12153e6_js__WEBPACK_IMPORTED_MODULE_6__ = __webpack_require__(/*! ./server-item-f12153e6.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/server-item-f12153e6.js");
/*!
 * All material copyright ESRI, All Rights Reserved, unless otherwise specified.
 * v3.0.99
 */








const pollForDataStoreJob = async (jobId, jobKey) => {
  var _a, _b;
  const portal = _config_eb5f7dc2_js__WEBPACK_IMPORTED_MODULE_2__.c.portal;
  const restBaseUrl = `${(_a = portal.restUrl) !== null && _a !== void 0 ? _a : portal.portalUrl}portals/${portal.id}`;
  const jobDetailsApiUrl = `${restBaseUrl}/jobs/${encodeURIComponent(jobId)}/?key=${encodeURIComponent(jobKey)}`;
  try {
    return {
      result: await (0,_portal_79caaeff_js__WEBPACK_IMPORTED_MODULE_0__.p)(jobDetailsApiUrl, {
        pendingStatuses: ["processing", "submitted"],
        successStatuses: ["succeeded"]
      }, "post")
    };
  }
  catch (error) {
    console.error(error);
    const errMessage = (_b = error.messages) === null || _b === void 0 ? void 0 : _b[0];
    if (errMessage === null || errMessage === void 0 ? void 0 : errMessage.includes("ERROR 000623")) {
      return { error: { code: "invalidDataStorePublishType" } };
    }
    return { error: { code: "unhandledError", message: JSON.stringify(error) } };
  }
};
const publishFromDataStore = async (dataStoreInfo, portal, 
/**
 * There is a tricky case where ImageServer needs to be use for cacheDataset instead of MapServer
 *
 * Currently, making another call to backend to check would be really long so we use retry as a faster workaround
 */
useRetryWorkaround) => {
  var _a;
  try {
    const { folder, type, cacheStoreId, serviceName, pathInCachedStore, description, serverId, tags } = dataStoreInfo;
    let configType;
    switch (type) {
      case "i3sRestCache":
      case "extractedScenePackage":
        configType = "SceneServer";
        break;
      case "vectorCacheDataset":
        configType = "VectorTileServer";
        break;
      case "cacheDataset":
        configType = useRetryWorkaround ? "ImageServer" : "MapServer";
        break;
    }
    // https://developers.arcgis.com/rest/users-groups-and-items/publish-datasets-to-datastore.htm
    const serviceConfiguration = JSON.stringify({
      type: configType,
      serviceName,
      properties: { pathInCachedStore, cacheStoreId }
    });
    const requestData = {
      serviceConfiguration,
      serverId,
      tags,
      f: "json"
    };
    const url = `${(0,_portal_79caaeff_js__WEBPACK_IMPORTED_MODULE_0__.g)()}portals/self/datastores/publish`;
    const { jobId, key } = await (0,_portal_79caaeff_js__WEBPACK_IMPORTED_MODULE_0__.r)(url, requestData, {}, "post");
    const { error, result } = await pollForDataStoreJob(jobId, key);
    if ((error === null || error === void 0 ? void 0 : error.code) === "invalidDataStorePublishType") {
      // Workaround as explain above
      return dataStoreInfo.type === "cacheDataset"
        ? publishFromDataStore(dataStoreInfo, portal, true)
        : { error: { code: "invalidDataStorePublishType", message: JSON.stringify(error.message) } };
    }
    else if (error) {
      return { error: { code: "failToPublishFromDataStore", message: JSON.stringify(error.message) } };
    }
    const resultService = (_a = result === null || result === void 0 ? void 0 : result.result) === null || _a === void 0 ? void 0 : _a.services[0];
    if (!(0,_feature_layer_38cdae87_js__WEBPACK_IMPORTED_MODULE_5__.q)(folder)) {
      await (0,_server_item_f12153e6_js__WEBPACK_IMPORTED_MODULE_6__.m)(resultService.serviceItemId, folder.id);
    }
    // publish API doesn't support changing the summary / snippet, so we make a separate call for it
    // https://developers.arcgis.com/rest/users-groups-and-items/update-item.htm
    const itemUpdateData = {
      snippet: description,
      f: "json"
    };
    await (0,_server_item_f12153e6_js__WEBPACK_IMPORTED_MODULE_6__.e)(resultService.serviceItemId, itemUpdateData);
    return { result: resultService };
  }
  catch (error) {
    console.error(error);
    return { error: { code: "failToPublishFromDataStore", message: JSON.stringify(error) } };
  }
};
const getDatastoreContents = async (datastoreId, path, type, serverId) => {
  var _a;
  // https://developers.arcgis.com/rest/users-groups-and-items/describe-datastore.htm
  const portal = _config_eb5f7dc2_js__WEBPACK_IMPORTED_MODULE_2__.c.portal;
  const restBaseUrl = `${(_a = portal.restUrl) !== null && _a !== void 0 ? _a : portal.portalUrl}portals/${portal.id}`;
  const datastoreDescriptionApiUrl = `${restBaseUrl}/datastores/describe`;
  const datastoreDescriptionApiPayload = { datastoreId, serverId, path, type, f: "json" };
  try {
    const { jobId, key } = await (0,_portal_79caaeff_js__WEBPACK_IMPORTED_MODULE_0__.r)(datastoreDescriptionApiUrl, datastoreDescriptionApiPayload, {}, "post");
    const { result } = await pollForDataStoreJob(jobId, key);
    return { result: result.result };
  }
  catch (error) {
    console.error(error);
    return { error: { code: "failToListDataStoreContents", message: JSON.stringify(error) } };
  }
};
const validateDatastoreServer = async (server, datastoreId) => {
  var _a;
  // https://developers.arcgis.com/rest/users-groups-and-items/validate-datastore.htm
  const portal = _config_eb5f7dc2_js__WEBPACK_IMPORTED_MODULE_2__.c.portal;
  const restBaseUrl = `${(_a = portal.restUrl) !== null && _a !== void 0 ? _a : portal.portalUrl}portals/${portal.id}`;
  const validateServerUrl = `${restBaseUrl}/datastores/validate`;
  const validateServerPayload = { datastoreId: datastoreId, serverId: server.id, f: "json" };
  try {
    const { status } = await (0,_portal_79caaeff_js__WEBPACK_IMPORTED_MODULE_0__.r)(validateServerUrl, validateServerPayload, {}, "post");
    return { result: status };
  }
  catch (error) {
    console.error(error);
    return { error: { code: "unhandledError", message: JSON.stringify(error) } };
  }
};
const handleDatabaseFileDrop = async (url, data, hostingServerAdminUrl) => {
  let itemName;
  try {
    const { result } = await (0,_portal_79caaeff_js__WEBPACK_IMPORTED_MODULE_0__.e)(url, data, {}, "post").then((response) => {
      if (response.status === "success") {
        itemName = response.item.itemName;
        return submitDatabaseFileJob(response.item, hostingServerAdminUrl);
      }
    });
    const connString = Object.assign(Object.assign({}, result), { itemName: itemName });
    return { result: connString };
  }
  catch (error) {
    console.error(error);
    return { error: { code: "unhandledError", message: JSON.stringify(error) } };
  }
};
const submitDatabaseFileJob = async (item, hostingServerAdminUrl) => {
  const publishingToolsUrl = (0,_data_store_e8b5ce2f_js__WEBPACK_IMPORTED_MODULE_4__.k)(hostingServerAdminUrl);
  const url = `${publishingToolsUrl}/Get%20Database%20Connection%20String/submitJob`;
  const data = { in_inputData: item.itemID, in_connDataType: "UPLOADED_CONNECTION_FILE_ID" };
  try {
    const { jobId, jobStatus } = await (0,_portal_79caaeff_js__WEBPACK_IMPORTED_MODULE_0__.r)(url, data, {}, "post");
    if ((jobStatus || "") === "esriJobSubmitted") {
      const url = `${publishingToolsUrl}/Get%20Database%20Connection%20String/jobs/${jobId}`;
      const result = await (0,_portal_79caaeff_js__WEBPACK_IMPORTED_MODULE_0__.p)(url, {
        requestParams: { jobId: jobId, jobStatus: jobStatus },
        pendingStatuses: ["esriJobNew", "esriJobSubmitted", "esriJobWaiting", "esriJobExecuting"],
        successStatuses: ["esriJobSucceeded"]
      });
      const connectionString = await (0,_data_store_e8b5ce2f_js__WEBPACK_IMPORTED_MODULE_4__.g)(result, publishingToolsUrl);
      return { result: connectionString };
    }
    return { result: null };
  }
  catch (error) {
    console.error(error);
    return { error: { code: "unhandledError", message: JSON.stringify(error) } };
  }
};
const fetchCloudStorageRegionInfo = async (provider) => {
  const regionInfoURL = "https://esriresources.s3.amazonaws.com/1120/regionsforcloudstorage.dat";
  try {
    const response = await (0,_portal_79caaeff_js__WEBPACK_IMPORTED_MODULE_0__.r)(regionInfoURL);
    let result;
    if (provider === "amazon") {
      result = response.Amazon.regions;
    }
    else if (provider === "azure" || provider === "azuredatalakegen2store") {
      result = response.environments;
    }
    else if (provider === "alibaba") {
      result = response.Alibaba.regions;
    }
    else if (provider === "google") {
      result = response.Google.regions;
    }
    return { result: result };
  }
  catch (error) {
    console.error(error);
    return { error: { code: "unhandledError", message: JSON.stringify(error) } };
  }
};
const validateDatastoreForOnline = async (orgId, portal, payload) => {
  const url = `${portal.user.portal.helperServices.datastoreManagement.url}/${orgId}/data/validateDataItem`;
  const item = JSON.stringify(payload);
  try {
    const validateResponse = await (0,_item_d9d70416_js__WEBPACK_IMPORTED_MODULE_1__.r)(url, portal, {
      body: { item, f: "json" },
      usePost: true
    });
    return { result: validateResponse };
  }
  catch (error) {
    const errorMessage = String(error).toLowerCase() || "";
    switch (true) {
      case errorMessage.includes("incorrect username or password was specified."):
        return { error: { code: "invalidUsernameOrPassword" } };
      default:
        return { error: { code: "unhandledError" } };
    }
  }
};
const validateDatastoreForServers = async (item, serverList, datastoreType) => {
  let servers = serverList;
  await Promise.all(servers.map((server) => validateServerForAddDataStore(item, server, datastoreType))).then((responses) => {
    servers = servers.map((server) => {
      let updatedServer = server;
      responses.forEach((response) => {
        var _a, _b, _c, _d, _e, _f, _g, _h, _j, _k, _l, _m;
        if (response.status === "success" ||
          ((_a = response.machines) === null || _a === void 0 ? void 0 : _a[0].machine.toLowerCase()) === server.name.toLowerCase().split(":")[0]) {
          updatedServer = Object.assign(Object.assign({}, server), { serverStatus: response.status || response.machines[0].status, errorMsg: (((_b = response.machines) === null || _b === void 0 ? void 0 : _b[0].status) === "error" &&
              ((_c = response === null || response === void 0 ? void 0 : response.error) === null || _c === void 0 ? void 0 : _c.message) &&
              JSON.parse(response.error.message).message) ||
              (((_e = (_d = response.machines) === null || _d === void 0 ? void 0 : _d[0].dataItems) === null || _e === void 0 ? void 0 : _e[0]) && ((_g = (_f = response.machines) === null || _f === void 0 ? void 0 : _f[0].dataItems) === null || _g === void 0 ? void 0 : _g[0].message)) });
        }
        else {
          updatedServer = Object.assign(Object.assign({}, server), { serverStatus: "error", errorMsg: (((_h = response === null || response === void 0 ? void 0 : response.error) === null || _h === void 0 ? void 0 : _h.message) && JSON.parse(response.error.message).message) ||
              (((_k = (_j = response.machines) === null || _j === void 0 ? void 0 : _j[0].dataItems) === null || _k === void 0 ? void 0 : _k[0]) && ((_m = (_l = response.machines) === null || _l === void 0 ? void 0 : _l[0].dataItems) === null || _m === void 0 ? void 0 : _m[0].message)) });
        }
      });
      return updatedServer;
    });
  });
  return servers;
};
const validateServerForAddDataStore = async (item, server, datastoreType) => {
  var _a;
  let datastorePayload;
  const bdfsType = item.bdfsType;
  let validateServerPayload = null;
  if (datastoreType === "bdfs") {
    if (bdfsType === "fileshare") {
      datastorePayload = (0,_data_store_e8b5ce2f_js__WEBPACK_IMPORTED_MODULE_4__.c)(item);
    }
    else if (bdfsType === "hdfs") {
      datastorePayload = (0,_data_store_e8b5ce2f_js__WEBPACK_IMPORTED_MODULE_4__.a)(item);
    }
    else if (bdfsType === "hive") {
      datastorePayload = (0,_data_store_e8b5ce2f_js__WEBPACK_IMPORTED_MODULE_4__.b)(item);
    }
    else if (bdfsType === "cloud") {
      if (item.bdfsCloudType === "new") {
        datastorePayload = (0,_data_store_e8b5ce2f_js__WEBPACK_IMPORTED_MODULE_4__.d)(item);
        datastorePayload.info.isManaged = false;
      }
      // validating against existing cloud data store
      else {
        validateServerPayload = {
          serverId: server.id,
          datastoreId: item.bdfsExistingDatastore.id,
          f: "json"
        };
      }
    }
  }
  else {
    if (datastoreType === "folder") {
      datastorePayload = (0,_data_store_e8b5ce2f_js__WEBPACK_IMPORTED_MODULE_4__.e)(item);
    }
    else if (datastoreType === "database") {
      datastorePayload = (0,_data_store_e8b5ce2f_js__WEBPACK_IMPORTED_MODULE_4__.f)(item);
    }
    else if (datastoreType === "cloud") {
      datastorePayload = (0,_data_store_e8b5ce2f_js__WEBPACK_IMPORTED_MODULE_4__.d)(item);
    }
    else if (datastoreType === "nosql") {
      datastorePayload = (0,_data_store_e8b5ce2f_js__WEBPACK_IMPORTED_MODULE_4__.h)(item);
    }
    datastorePayload.info.isManaged = false;
  }
  // https://developers.arcgis.com/rest/users-groups-and-items/validate-datastore.htm
  const portal = _config_eb5f7dc2_js__WEBPACK_IMPORTED_MODULE_2__.c.portal;
  const restBaseUrl = `${(_a = portal.restUrl) !== null && _a !== void 0 ? _a : portal.portalUrl}portals/${portal.id}`;
  const validateServerUrl = `${restBaseUrl}/datastores/validate`;
  if (!validateServerPayload) {
    validateServerPayload = {
      datastore: JSON.stringify(datastorePayload),
      serverId: server.id,
      f: "json"
    };
  }
  try {
    const { status, machines } = await (0,_portal_79caaeff_js__WEBPACK_IMPORTED_MODULE_0__.r)(validateServerUrl, validateServerPayload, {}, "post");
    return { status: status, machines: machines };
  }
  catch (error) {
    console.error(error);
    return { error: { code: "unhandledError", message: JSON.stringify(error) } };
  }
};
const checkServersType = async (serverList) => {
  let serverTypes = [];
  let servers = serverList;
  if ((0,_data_store_e8b5ce2f_js__WEBPACK_IMPORTED_MODULE_4__.i)()) {
    const serversToValidate = [];
    servers.forEach((federatedServer) => {
      if (federatedServer.isHosted) {
        const serverItem = { name: federatedServer.adminUrl, type: "Linux" };
        serverTypes.push(serverItem);
      }
      else if (federatedServer.serverRole === "FEDERATED_SERVER") {
        serversToValidate.push(federatedServer);
      }
    });
    const responses = await Promise.allSettled(serversToValidate.map((server) => {
      const url = `${server.adminUrl}/admin/machines?f=json`;
      return (0,_portal_79caaeff_js__WEBPACK_IMPORTED_MODULE_0__.r)(url, {}, {}, "post");
    }));
    await Promise.allSettled(responses.map((response) => {
      var _a;
      return validateServerTypeKubernetes((_a = response === null || response === void 0 ? void 0 : response.value) === null || _a === void 0 ? void 0 : _a.machines, servers).then((validatedServerTypes) => {
        serverTypes = [...serverTypes, ...validatedServerTypes];
      });
    }));
  }
  else {
    // 1. Retrieve the Federated machines
    const responses = await Promise.allSettled(servers.map((server) => {
      const url = `${server.adminUrl}/admin/machines?f=json`;
      return (0,_portal_79caaeff_js__WEBPACK_IMPORTED_MODULE_0__.r)(url, {}, {}, "post");
    }));
    await Promise.allSettled(responses.map((response) => {
      var _a;
      return validateServerType((_a = response === null || response === void 0 ? void 0 : response.value) === null || _a === void 0 ? void 0 : _a.machines, servers).then((result) => {
        servers = [...result.serverList];
        serverTypes = result.serverTypes;
      });
    }));
  }
  return { servers: servers, serverTypes: serverTypes };
};
const validateServerType = async (machines, serverList) => {
  let serverTypes = [];
  // 2. Validate server type
  serverList.map((server, index) => {
    if (machines === null || machines === void 0 ? void 0 : machines[index]) {
      server.shouldFilter = false;
    }
    else {
      server.shouldFilter = true;
    }
  });
  serverList.filter((server) => {
    return !server.shouldFilter;
  });
  for (let index = 0; index < serverList.length; index++) {
    const machine = machines[0].machineName;
    const url = `${machines[0].adminURL}/machines/${machine}?f=json`;
    await (0,_portal_79caaeff_js__WEBPACK_IMPORTED_MODULE_0__.r)(url, {}, {}, "post").then((result) => {
      if (result) {
        const serverItem = {
          name: serverList[index].adminUrl,
          type: result.platform.indexOf("Windows") > -1 ? "Windows" : "Linux"
        };
        serverTypes.push(serverItem);
      }
    });
  }
  return { serverTypes: serverTypes, serverList: serverList };
};
const requestCloudStoreList = async () => {
  const orgId = _config_eb5f7dc2_js__WEBPACK_IMPORTED_MODULE_2__.c.user.orgId;
  const type = "Data Store";
  const q = `orgid:${orgId} type:"${type}"`;
  const num = 10000;
  const content = { q, num };
  const url = `${(0,_portal_79caaeff_js__WEBPACK_IMPORTED_MODULE_0__.g)()}search`;
  const supportedCloudStores = [
    "cloudStore_amazon",
    "cloudStore_azure",
    "cloudStore_azuredatalakegen2store",
    "cloudStore_azureDataLakeStore"
  ];
  try {
    const existingCloudStoreIds = [];
    const { results } = await (0,_portal_79caaeff_js__WEBPACK_IMPORTED_MODULE_0__.r)(url, content);
    results === null || results === void 0 ? void 0 : results.forEach(({ id, title, type, typeKeywords }) => {
      // Exclude Big Data File Share items
      if (!typeKeywords.includes("bigDataFileShare") &&
        typeKeywords.some((keyword) => supportedCloudStores.includes(keyword))) {
        existingCloudStoreIds.push({ id, title, type, typeKeywords });
      }
    });
    return { result: existingCloudStoreIds };
  }
  catch (error) {
    console.error(error);
    return { error: { code: "unhandledError", message: JSON.stringify(error) } };
  }
};
const requestCloudStoreInfo = async (selectedCloudStoreId) => {
  const url = `${(0,_portal_79caaeff_js__WEBPACK_IMPORTED_MODULE_0__.g)()}content/items/${selectedCloudStoreId}/data`;
  try {
    const { id, path, provider } = await (0,_portal_79caaeff_js__WEBPACK_IMPORTED_MODULE_0__.r)(url);
    return { id: id, path: path, provider: provider };
  }
  catch (error) {
    console.error(error);
    return { error: { code: "unhandledError", message: JSON.stringify(error) } };
  }
};
const validateServerTypeKubernetes = async (machines, serverList) => {
  let serverTypes = [];
  await Promise.all(serverList.map((federatedServer, index) => {
    if (!federatedServer.isHosted) {
      const machine = machines[0].machineName;
      const url = `${machines[0].adminURL}/machines/${machine}?f=json`;
      return (0,_portal_79caaeff_js__WEBPACK_IMPORTED_MODULE_0__.r)(url, {}, {}, "post").then((result) => {
        if (!result.isHosted) {
          const serverItem = {
            name: serverList[index].adminUrl,
            type: result.platform.indexOf("Windows") > -1 ? "Windows" : "Linux"
          };
          serverTypes.push(serverItem);
        }
      });
    }
  }));
  return serverTypes;
};
const registerDataStoreWithServers = async (addItemInfo, item, title, tags, categories, snippet) => {
  var _a;
  const { portal } = _config_eb5f7dc2_js__WEBPACK_IMPORTED_MODULE_2__.c;
  const restBaseUrl = `${(_a = portal.restUrl) !== null && _a !== void 0 ? _a : portal.portalUrl}portals/${portal.id}`;
  const servers = item.dataStoreSelectedServers;
  const addResults = await Promise.all(servers.map((serverId) => {
    const content = {
      serverId,
      datastoreId: addItemInfo.id
    };
    if ((0,_data_store_e8b5ce2f_js__WEBPACK_IMPORTED_MODULE_4__.i)() && item.addDataStoreType === "folder" && item.allowServicesRestart) {
      content.options = JSON.stringify({ allowServicesRestart: true });
    }
    const addToServerUrl = `${restBaseUrl}/datastores/addToServer`;
    return (0,_portal_79caaeff_js__WEBPACK_IMPORTED_MODULE_0__.r)(addToServerUrl, content, {}, "post");
  }));
  let result = { success: false, id: null, folder: null };
  for (const addResult of addResults) {
    // TODO: error checking for the servers
    // const errors = [];
    // if (!addResult || !(addResult.result[1] || {}).success) {
    //   errors.push(addResult.result[1]);
    // }
    if (addResult.success) {
      if (item.addDataStoreType === "bdfs" && item.bdfsType === "cloud" && item.bdfsCloudType === "new") {
        result = await addBdfsDataStoreItem(item, title, tags, categories, snippet, addItemInfo.id);
        return result;
      }
      else {
        if (["folder", "database", "nosql", "cloud"].includes(item.addDataStoreType)) {
          result = { success: true, id: addItemInfo.id, folder: addItemInfo.id };
        }
        else {
          // For BDFS Data Store: get Catalog Service item id
          const getCatalog = async () => {
            const itemUrl = `${(0,_portal_79caaeff_js__WEBPACK_IMPORTED_MODULE_0__.g)()}content/items/${addItemInfo.id}/relatedItems`;
            const response = await (0,_portal_79caaeff_js__WEBPACK_IMPORTED_MODULE_0__.r)(itemUrl, {
              relationshipType: "BDFSDataStore2BDFSCatalogService",
              direction: "forward"
            });
            if (response.total) {
              result = { success: true, id: response.relatedItems[0].id, folder: addItemInfo.id };
              return result;
            }
            else {
              await (0,_functional_c82f5ab9_js__WEBPACK_IMPORTED_MODULE_3__.t)(10000);
              return getCatalog();
            }
          };
          result = getCatalog();
        }
      }
    }
  }
  return result;
};
//for adding BDFS cloud data store
const addBdfsDataStoreItem = async (item, title, tags, categories, snippet, cloudId, cloudPath) => {
  const url = `${(0,_portal_79caaeff_js__WEBPACK_IMPORTED_MODULE_0__.g)()}content/items/${cloudId}/data`;
  const response = await (0,_portal_79caaeff_js__WEBPACK_IMPORTED_MODULE_0__.r)(url);
  const path = cloudPath || response.path;
  const datastoreTitle = path.split("/")[2].split("_")[0];
  const data = {
    type: "Data Store",
    title: title || datastoreTitle,
    tags: tags,
    categories: categories,
    snippet: snippet,
    text: ""
  };
  data.text = (0,_data_store_e8b5ce2f_js__WEBPACK_IMPORTED_MODULE_4__.j)(data.title, path);
  item.addDataStoreType = "bdfsDataStore";
  let addItemResponse = await (0,_feature_layer_38cdae87_js__WEBPACK_IMPORTED_MODULE_5__.t)(data, null);
  if (addItemResponse.success && _config_eb5f7dc2_js__WEBPACK_IMPORTED_MODULE_2__.c.portal.isPortal) {
    addItemResponse = await registerDataStoreWithServers(addItemResponse, item);
  }
  return addItemResponse;
};
const addDataStore = async (item, title, tags, categories, snippet) => {
  const datastoreType = item.addDataStoreType;
  const data = {
    type: "Data Store",
    title: title,
    tags: tags,
    categories: categories,
    snippet: snippet,
    text: "",
    typeKeywords: item.typeKeywords
  };
  let text;
  const bdfsType = item.bdfsType;
  if (datastoreType === "bdfs") {
    if (bdfsType === "fileshare") {
      text = (0,_data_store_e8b5ce2f_js__WEBPACK_IMPORTED_MODULE_4__.c)(item, title);
    }
    else if (bdfsType === "hdfs") {
      text = (0,_data_store_e8b5ce2f_js__WEBPACK_IMPORTED_MODULE_4__.a)(item, title);
    }
    else if (bdfsType === "hive") {
      text = (0,_data_store_e8b5ce2f_js__WEBPACK_IMPORTED_MODULE_4__.b)(item, title);
    }
    else if (bdfsType === "cloud") {
      if (item.bdfsCloudType === "new") {
        text = (0,_data_store_e8b5ce2f_js__WEBPACK_IMPORTED_MODULE_4__.d)(item, title);
        text.info.isManaged = false;
      }
      else {
        return await addBdfsDataStoreItem(item, title, tags, categories, snippet, item.bdfsExistingDatastore.id, item.bdfsExistingDatastore.path);
      }
    }
  }
  else {
    if (datastoreType === "folder") {
      text = (0,_data_store_e8b5ce2f_js__WEBPACK_IMPORTED_MODULE_4__.e)(item, title);
    }
    else if (datastoreType === "database") {
      text = (0,_data_store_e8b5ce2f_js__WEBPACK_IMPORTED_MODULE_4__.f)(item, title);
    }
    else if (datastoreType === "cloud") {
      text = (0,_data_store_e8b5ce2f_js__WEBPACK_IMPORTED_MODULE_4__.d)(item, title);
    }
    else if (datastoreType === "nosql") {
      text = (0,_data_store_e8b5ce2f_js__WEBPACK_IMPORTED_MODULE_4__.h)(item, title);
    }
    text.info.isManaged = false;
  }
  data.text = JSON.stringify(text);
  let response = await (0,_feature_layer_38cdae87_js__WEBPACK_IMPORTED_MODULE_5__.t)(data, null);
  if (response.success && _config_eb5f7dc2_js__WEBPACK_IMPORTED_MODULE_2__.c.portal.isPortal) {
    response = await registerDataStoreWithServers(response, item, title, tags, categories, snippet);
  }
  return response;
};




/***/ })

}]);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2lkZ2V0cy9jaHVua3MvYXJjZ2lzX2FuYWx5c2lzX25vZGVfbW9kdWxlc19hcmNnaXNfYXBwLWNvbXBvbmVudHNfZGlzdF9lc21fZGF0YS1zLTJkMjJjMC5qcyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUMrRztBQUN4RDtBQUNDO0FBQ0E7QUFDa1Y7QUFDNVQ7QUFDSDs7QUFFM0U7QUFDQTtBQUNBLGlCQUFpQixrREFBVztBQUM1Qix5QkFBeUIsd0VBQXdFLFVBQVUsVUFBVTtBQUNySCw4QkFBOEIsWUFBWSxRQUFRLDBCQUEwQixRQUFRLDJCQUEyQjtBQUMvRztBQUNBO0FBQ0Esb0JBQW9CLHNEQUFhO0FBQ2pDO0FBQ0E7QUFDQSxPQUFPO0FBQ1A7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsZUFBZSxTQUFTO0FBQ3hCO0FBQ0EsYUFBYSxTQUFTO0FBQ3RCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxZQUFZLDBGQUEwRjtBQUN0RztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0Esb0JBQW9CO0FBQ3BCLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxtQkFBbUIsc0RBQWMsR0FBRztBQUNwQyxZQUFZLGFBQWEsUUFBUSxzREFBTyxxQkFBcUI7QUFDN0QsWUFBWSxnQkFBZ0I7QUFDNUI7QUFDQTtBQUNBO0FBQ0E7QUFDQSxZQUFZLFNBQVM7QUFDckI7QUFDQTtBQUNBLGVBQWUsU0FBUztBQUN4QjtBQUNBO0FBQ0EsU0FBUyw2REFBWTtBQUNyQixZQUFZLDJEQUFRO0FBQ3BCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsVUFBVSwyREFBVTtBQUNwQixhQUFhO0FBQ2I7QUFDQTtB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QUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGNBQWMsMERBQW9CO0FBQ2xDO0FBQ0EsOEJBQThCLDZEQUFPO0FBQ3JDLGlDQUFpQyxrREFBVztBQUM1QztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGFBQWEsMERBQWlDO0FBQzlDO0FBQ0E7QUFDQSxhQUFhLDBEQUE0QjtBQUN6QztBQUNBO0FBQ0EsYUFBYSwwREFBNEI7QUFDekM7QUFDQTtBQUNBO0FBQ0EsZUFBZSwwREFBNkI7QUFDNUM7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsYUFBYSwwREFBc0I7QUFDbkM7QUFDQTtBQUNBLGFBQWEsMERBQXdCO0FBQ3JDO0FBQ0E7QUFDQSxhQUFhLDBEQUE2QjtBQUMxQztBQUNBO0FBQ0EsYUFBYSwwREFBcUI7QUFDbEM7QUFDQTtBQUNBO0FBQ0E7QUFDQSx1QkFBdUIsNkRBQU87QUFDOUIsMEJBQTBCLGtEQUFXO0FBQ3JDO0FBQ0E7QUFDQTtBQUNBOztBQUVrVSIsInNvdXJjZXMiOlsid2VicGFjazovL2V4Yi1jbGllbnQvLi9leHRlbnNpb25zL3dpZGdldHMvYXJjZ2lzL2FuYWx5c2lzL25vZGVfbW9kdWxlcy9AYXJjZ2lzL2FwcC1jb21wb25lbnRzL2Rpc3QvZXNtL2RhdGEtc3RvcmUtZjUwOTU2NGQuanMiXSwic291cmNlc0NvbnRlbnQiOlsiLyohXG4gKiBBbGwgbWF0ZXJpYWwgY29weXJpZ2h0IEVTUkksIEFsbCBSaWdodHMgUmVzZXJ2ZWQsIHVubGVzcyBvdGhlcndpc2Ugc3BlY2lmaWVkLlxuICogdjMuMC45OVxuICovXG5pbXBvcnQgeyBnIGFzIGdldFJlc3RCYXNlVXJsLCByIGFzIHJlcXVlc3QsIGUgYXMgZm9ybVJlcXVlc3QsIHAgYXMgcG9sbEZvclN0YXR1cyB9IGZyb20gJy4vcG9ydGFsLTc5Y2FhZWZmLmpzJztcbmltcG9ydCB7IHIgYXMgcmVxdWVzdEZldGNoIH0gZnJvbSAnLi9pdGVtLWQ5ZDcwNDE2LmpzJztcbmltcG9ydCB7IGMgYXMgY29uZmlnU3RhdGUgfSBmcm9tICcuL2NvbmZpZy1lYjVmN2RjMi5qcyc7XG5pbXBvcnQgeyB0IGFzIHRpbWVvdXQgfSBmcm9tICcuL2Z1bmN0aW9uYWwtYzgyZjVhYjkuanMnO1xuaW1wb3J0IHsgZyBhcyBnZXRDb25uZWN0aW9uU3RyaW5nLCBjIGFzIGNyZWF0ZUZpbGVTaGFyZVByb3ZpZGVyRGF0YU9iamVjdCwgYSBhcyBjcmVhdGVIZGZzUHJvdmlkZXJEYXRhT2JqZWN0LCBiIGFzIGNyZWF0ZUhpdmVQcm92aWRlckRhdGFPYmplY3QsIGQgYXMgY3JlYXRlQ2xvdWRQcm92aWRlckRhdGFPYmplY3QsIGUgYXMgY3JlYXRlRm9sZGVyRGF0YU9iamVjdCwgZiBhcyBjcmVhdGVEYXRhYmFzZURhdGFPYmplY3QsIGggYXMgY3JlYXRlTm9TcWxEYXRhT2JqZWN0LCBpIGFzIGlzQXJjR0lTRW50ZXJwcmlzZU9uS3ViZXJuZXRlcywgaiBhcyBnZXRCZGZzUGFyYW1ldGVySXRlbSwgayBhcyBnZXRQdWJsaXNoaW5nVG9vbHNVcmwgfSBmcm9tICcuL2RhdGEtc3RvcmUtZThiNWNlMmYuanMnO1xuaW1wb3J0IHsgcSBhcyBpc0ZvbGRlclJvb3QsIHQgYXMgYWRkSXRlbSB9IGZyb20gJy4vZmVhdHVyZS1sYXllci0zOGNkYWU4Ny5qcyc7XG5pbXBvcnQgeyBtIGFzIG1vdmVJdGVtLCBlIGFzIHVwZGF0ZUl0ZW0gfSBmcm9tICcuL3NlcnZlci1pdGVtLWYxMjE1M2U2LmpzJztcblxuY29uc3QgcG9sbEZvckRhdGFTdG9yZUpvYiA9IGFzeW5jIChqb2JJZCwgam9iS2V5KSA9PiB7XG4gIHZhciBfYSwgX2I7XG4gIGNvbnN0IHBvcnRhbCA9IGNvbmZpZ1N0YXRlLnBvcnRhbDtcbiAgY29uc3QgcmVzdEJhc2VVcmwgPSBgJHsoX2EgPSBwb3J0YWwucmVzdFVybCkgIT09IG51bGwgJiYgX2EgIT09IHZvaWQgMCA/IF9hIDogcG9ydGFsLnBvcnRhbFVybH1wb3J0YWxzLyR7cG9ydGFsLmlkfWA7XG4gIGNvbnN0IGpvYkRldGFpbHNBcGlVcmwgPSBgJHtyZXN0QmFzZVVybH0vam9icy8ke2VuY29kZVVSSUNvbXBvbmVudChqb2JJZCl9Lz9rZXk9JHtlbmNvZGVVUklDb21wb25lbnQoam9iS2V5KX1gO1xuICB0cnkge1xuICAgIHJldHVybiB7XG4gICAgICByZXN1bHQ6IGF3YWl0IHBvbGxGb3JTdGF0dXMoam9iRGV0YWlsc0FwaVVybCwge1xuICAgICAgICBwZW5kaW5nU3RhdHVzZXM6IFtcInByb2Nlc3NpbmdcIiwgXCJzdWJtaXR0ZWRcIl0sXG4gICAgICAgIHN1Y2Nlc3NTdGF0dXNlczogW1wic3VjY2VlZGVkXCJdXG4gICAgICB9LCBcInBvc3RcIilcbiAgICB9O1xuICB9XG4gIGNhdGNoIChlcnJvcikge1xuICAgIGNvbnNvbGUuZXJyb3IoZXJyb3IpO1xuICAgIGNvbnN0IGVyck1lc3NhZ2UgPSAoX2IgPSBlcnJvci5tZXNzYWdlcykgPT09IG51bGwgfHwgX2IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9iWzBdO1xuICAgIGlmIChlcnJNZXNzYWdlID09PSBudWxsIHx8IGVyck1lc3NhZ2UgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGVyck1lc3NhZ2UuaW5jbHVkZXMoXCJFUlJPUiAwMDA2MjNcIikpIHtcbiAgICAgIHJldHVybiB7IGVycm9yOiB7IGNvZGU6IFwiaW52YWxpZERhdGFTdG9yZVB1Ymxpc2hUeXBlXCIgfSB9O1xuICAgIH1cbiAgICByZXR1cm4geyBlcnJvcjogeyBjb2RlOiBcInVuaGFuZGxlZEVycm9yXCIsIG1lc3NhZ2U6IEpTT04uc3RyaW5naWZ5KGVycm9yKSB9IH07XG4gIH1cbn07XG5jb25zdCBwdWJsaXNoRnJvbURhdGFTdG9yZSA9IGFzeW5jIChkYXRhU3RvcmVJbmZvLCBwb3J0YWwsIFxuLyoqXG4gKiBUaGVyZSBpcyBhIHRyaWNreSBjYXNlIHdoZXJlIEltYWdlU2VydmVyIG5lZWRzIHRvIGJlIHVzZSBmb3IgY2FjaGVEYXRhc2V0IGluc3RlYWQgb2YgTWFwU2VydmVyXG4gKlxuICogQ3VycmVudGx5LCBtYWtpbmcgYW5vdGhlciBjYWxsIHRvIGJhY2tlbmQgdG8gY2hlY2sgd291bGQgYmUgcmVhbGx5IGxvbmcgc28gd2UgdXNlIHJldHJ5IGFzIGEgZmFzdGVyIHdvcmthcm91bmRcbiAqL1xudXNlUmV0cnlXb3JrYXJvdW5kKSA9PiB7XG4gIHZhciBfYTtcbiAgdHJ5IHtcbiAgICBjb25zdCB7IGZvbGRlciwgdHlwZSwgY2FjaGVTdG9yZUlkLCBzZXJ2aWNlTmFtZSwgcGF0aEluQ2FjaGVkU3RvcmUsIGRlc2NyaXB0aW9uLCBzZXJ2ZXJJZCwgdGFncyB9ID0gZGF0YVN0b3JlSW5mbztcbiAgICBsZXQgY29uZmlnVHlwZTtcbiAgICBzd2l0Y2ggKHR5cGUpIHtcbiAgICAgIGNhc2UgXCJpM3NSZXN0Q2FjaGVcIjpcbiAgICAgIGNhc2UgXCJleHRyYWN0ZWRTY2VuZVBhY2thZ2VcIjpcbiAgICAgICAgY29uZmlnVHlwZSA9IFwiU2NlbmVTZXJ2ZXJcIjtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIFwidmVjdG9yQ2FjaGVEYXRhc2V0XCI6XG4gICAgICAgIGNvbmZpZ1R5cGUgPSBcIlZlY3RvclRpbGVTZXJ2ZXJcIjtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIFwiY2FjaGVEYXRhc2V0XCI6XG4gICAgICAgIGNvbmZpZ1R5cGUgPSB1c2VSZXRyeVdvcmthcm91bmQgPyBcIkltYWdlU2VydmVyXCIgOiBcIk1hcFNlcnZlclwiO1xuICAgICAgICBicmVhaztcbiAgICB9XG4gICAgLy8gaHR0cHM6Ly9kZXZlbG9wZXJzLmFyY2dpcy5jb20vcmVzdC91c2Vycy1ncm91cHMtYW5kLWl0ZW1zL3B1Ymxpc2gtZGF0YXNldHMtdG8tZGF0YXN0b3JlLmh0bVxuICAgIGNvbnN0IHNlcnZpY2VDb25maWd1cmF0aW9uID0gSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgdHlwZTogY29uZmlnVHlwZSxcbiAgICAgIHNlcnZpY2VOYW1lLFxuICAgICAgcHJvcGVydGllczogeyBwYXRoSW5DYWNoZWRTdG9yZSwgY2FjaGVTdG9yZUlkIH1cbiAgICB9KTtcbiAgICBjb25zdCByZXF1ZXN0RGF0YSA9IHtcbiAgICAgIHNlcnZpY2VDb25maWd1cmF0aW9uLFxuICAgICAgc2VydmVySWQsXG4gICAgICB0YWdzLFxuICAgICAgZjogXCJqc29uXCJcbiAgICB9O1xuICAgIGNvbnN0IHVybCA9IGAke2dldFJlc3RCYXNlVXJsKCl9cG9ydGFscy9zZWxmL2RhdGFzdG9yZXMvcHVibGlzaGA7XG4gICAgY29uc3QgeyBqb2JJZCwga2V5IH0gPSBhd2FpdCByZXF1ZXN0KHVybCwgcmVxdWVzdERhdGEsIHt9LCBcInBvc3RcIik7XG4gICAgY29uc3QgeyBlcnJvciwgcmVzdWx0IH0gPSBhd2FpdCBwb2xsRm9yRGF0YVN0b3JlSm9iKGpvYklkLCBrZXkpO1xuICAgIGlmICgoZXJyb3IgPT09IG51bGwgfHwgZXJyb3IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGVycm9yLmNvZGUpID09PSBcImludmFsaWREYXRhU3RvcmVQdWJsaXNoVHlwZVwiKSB7XG4gICAgICAvLyBXb3JrYXJvdW5kIGFzIGV4cGxhaW4gYWJvdmVcbiAgICAgIHJldHVybiBkYXRhU3RvcmVJbmZvLnR5cGUgPT09IFwiY2FjaGVEYXRhc2V0XCJcbiAgICAgICAgPyBwdWJsaXNoRnJvbURhdGFTdG9yZShkYXRhU3RvcmVJbmZvLCBwb3J0YWwsIHRydWUpXG4gICAgICAgIDogeyBlcnJvcjogeyBjb2RlOiBcImludmFsaWREYXRhU3RvcmVQdWJsaXNoVHlwZVwiLCBtZXNzYWdlOiBKU09OLnN0cmluZ2lmeShlcnJvci5tZXNzYWdlKSB9IH07XG4gICAgfVxuICAgIGVsc2UgaWYgKGVycm9yKSB7XG4gICAgICByZXR1cm4geyBlcnJvcjogeyBjb2RlOiBcImZhaWxUb1B1Ymxpc2hGcm9tRGF0YVN0b3JlXCIsIG1lc3NhZ2U6IEpTT04uc3RyaW5naWZ5KGVycm9yLm1lc3NhZ2UpIH0gfTtcbiAgICB9XG4gICAgY29uc3QgcmVzdWx0U2VydmljZSA9IChfYSA9IHJlc3VsdCA9PT0gbnVsbCB8fCByZXN1bHQgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHJlc3VsdC5yZXN1bHQpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5zZXJ2aWNlc1swXTtcbiAgICBpZiAoIWlzRm9sZGVyUm9vdChmb2xkZXIpKSB7XG4gICAgICBhd2FpdCBtb3ZlSXRlbShyZXN1bHRTZXJ2aWNlLnNlcnZpY2VJdGVtSWQsIGZvbGRlci5pZCk7XG4gICAgfVxuICAgIC8vIHB1Ymxpc2ggQVBJIGRvZXNuJ3Qgc3VwcG9ydCBjaGFuZ2luZyB0aGUgc3VtbWFyeSAvIHNuaXBwZXQsIHNvIHdlIG1ha2UgYSBzZXBhcmF0ZSBjYWxsIGZvciBpdFxuICAgIC8vIGh0dHBzOi8vZGV2ZWxvcGVycy5hcmNnaXMuY29tL3Jlc3QvdXNlcnMtZ3JvdXBzLWFuZC1pdGVtcy91cGRhdGUtaXRlbS5odG1cbiAgICBjb25zdCBpdGVtVXBkYXRlRGF0YSA9IHtcbiAgICAgIHNuaXBwZXQ6IGRlc2NyaXB0aW9uLFxuICAgICAgZjogXCJqc29uXCJcbiAgICB9O1xuICAgIGF3YWl0IHVwZGF0ZUl0ZW0ocmVzdWx0U2VydmljZS5zZXJ2aWNlSXRlbUlkLCBpdGVtVXBkYXRlRGF0YSk7XG4gICAgcmV0dXJuIHsgcmVzdWx0OiByZXN1bHRTZXJ2aWNlIH07XG4gIH1cbiAgY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcihlcnJvcik7XG4gICAgcmV0dXJuIHsgZXJyb3I6IHsgY29kZTogXCJmYWlsVG9QdWJsaXNoRnJvbURhdGFTdG9yZVwiLCBtZXNzYWdlOiBKU09OLnN0cmluZ2lmeShlcnJvcikgfSB9O1xuICB9XG59O1xuY29uc3QgZ2V0RGF0YXN0b3JlQ29udGVudHMgPSBhc3luYyAoZGF0YXN0b3JlSWQsIHBhdGgsIHR5cGUsIHNlcnZlcklkKSA9PiB7XG4gIHZhciBfYTtcbiAgLy8gaHR0cHM6Ly9kZXZlbG9wZXJzLmFyY2dpcy5jb20vcmVzdC91c2Vycy1ncm91cHMtYW5kLWl0ZW1zL2Rlc2NyaWJlLWRhdGFzdG9yZS5odG1cbiAgY29uc3QgcG9ydGFsID0gY29uZmlnU3RhdGUucG9ydGFsO1xuICBjb25zdCByZXN0QmFzZVVybCA9IGAkeyhfYSA9IHBvcnRhbC5yZXN0VXJsKSAhPT0gbnVsbCAmJiBfYSAhPT0gdm9pZCAwID8gX2EgOiBwb3J0YWwucG9ydGFsVXJsfXBvcnRhbHMvJHtwb3J0YWwuaWR9YDtcbiAgY29uc3QgZGF0YXN0b3JlRGVzY3JpcHRpb25BcGlVcmwgPSBgJHtyZXN0QmFzZVVybH0vZGF0YXN0b3Jlcy9kZXNjcmliZWA7XG4gIGNvbnN0IGRhdGFzdG9yZURlc2NyaXB0aW9uQXBpUGF5bG9hZCA9IHsgZGF0YXN0b3JlSWQsIHNlcnZlcklkLCBwYXRoLCB0eXBlLCBmOiBcImpzb25cIiB9O1xuICB0cnkge1xuICAgIGNvbnN0IHsgam9iSWQsIGtleSB9ID0gYXdhaXQgcmVxdWVzdChkYXRhc3RvcmVEZXNjcmlwdGlvbkFwaVVybCwgZGF0YXN0b3JlRGVzY3JpcHRpb25BcGlQYXlsb2FkLCB7fSwgXCJwb3N0XCIpO1xuICAgIGNvbnN0IHsgcmVzdWx0IH0gPSBhd2FpdCBwb2xsRm9yRGF0YVN0b3JlSm9iKGpvYklkLCBrZXkpO1xuICAgIHJldHVybiB7IHJlc3VsdDogcmVzdWx0LnJlc3VsdCB9O1xuICB9XG4gIGNhdGNoIChlcnJvcikge1xuICAgIGNvbnNvbGUuZXJyb3IoZXJyb3IpO1xuICAgIHJldHVybiB7IGVycm9yOiB7IGNvZGU6IFwiZmFpbFRvTGlzdERhdGFTdG9yZUNvbnRlbnRzXCIsIG1lc3NhZ2U6IEpTT04uc3RyaW5naWZ5KGVycm9yKSB9IH07XG4gIH1cbn07XG5jb25zdCB2YWxpZGF0ZURhdGFzdG9yZVNlcnZlciA9IGFzeW5jIChzZXJ2ZXIsIGRhdGFzdG9yZUlkKSA9PiB7XG4gIHZhciBfYTtcbiAgLy8gaHR0cHM6Ly9kZXZlbG9wZXJzLmFyY2dpcy5jb20vcmVzdC91c2Vycy1ncm91cHMtYW5kLWl0ZW1zL3ZhbGlkYXRlLWRhdGFzdG9yZS5odG1cbiAgY29uc3QgcG9ydGFsID0gY29uZmlnU3RhdGUucG9ydGFsO1xuICBjb25zdCByZXN0QmFzZVVybCA9IGAkeyhfYSA9IHBvcnRhbC5yZXN0VXJsKSAhPT0gbnVsbCAmJiBfYSAhPT0gdm9pZCAwID8gX2EgOiBwb3J0YWwucG9ydGFsVXJsfXBvcnRhbHMvJHtwb3J0YWwuaWR9YDtcbiAgY29uc3QgdmFsaWRhdGVTZXJ2ZXJVcmwgPSBgJHtyZXN0QmFzZVVybH0vZGF0YXN0b3Jlcy92YWxpZGF0ZWA7XG4gIGNvbnN0IHZhbGlkYXRlU2VydmVyUGF5bG9hZCA9IHsgZGF0YXN0b3JlSWQ6IGRhdGFzdG9yZUlkLCBzZXJ2ZXJJZDogc2VydmVyLmlkLCBmOiBcImpzb25cIiB9O1xuICB0cnkge1xuICAgIGNvbnN0IHsgc3RhdHVzIH0gPSBhd2FpdCByZXF1ZXN0KHZhbGlkYXRlU2VydmVyVXJsLCB2YWxpZGF0ZVNlcnZlclBheWxvYWQsIHt9LCBcInBvc3RcIik7XG4gICAgcmV0dXJuIHsgcmVzdWx0OiBzdGF0dXMgfTtcbiAgfVxuICBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zb2xlLmVycm9yKGVycm9yKTtcbiAgICByZXR1cm4geyBlcnJvcjogeyBjb2RlOiBcInVuaGFuZGxlZEVycm9yXCIsIG1lc3NhZ2U6IEpTT04uc3RyaW5naWZ5KGVycm9yKSB9IH07XG4gIH1cbn07XG5jb25zdCBoYW5kbGVEYXRhYmFzZUZpbGVEcm9wID0gYXN5bmMgKHVybCwgZGF0YSwgaG9zdGluZ1NlcnZlckFkbWluVXJsKSA9PiB7XG4gIGxldCBpdGVtTmFtZTtcbiAgdHJ5IHtcbiAgICBjb25zdCB7IHJlc3VsdCB9ID0gYXdhaXQgZm9ybVJlcXVlc3QodXJsLCBkYXRhLCB7fSwgXCJwb3N0XCIpLnRoZW4oKHJlc3BvbnNlKSA9PiB7XG4gICAgICBpZiAocmVzcG9uc2Uuc3RhdHVzID09PSBcInN1Y2Nlc3NcIikge1xuICAgICAgICBpdGVtTmFtZSA9IHJlc3BvbnNlLml0ZW0uaXRlbU5hbWU7XG4gICAgICAgIHJldHVybiBzdWJtaXREYXRhYmFzZUZpbGVKb2IocmVzcG9uc2UuaXRlbSwgaG9zdGluZ1NlcnZlckFkbWluVXJsKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICBjb25zdCBjb25uU3RyaW5nID0gT2JqZWN0LmFzc2lnbihPYmplY3QuYXNzaWduKHt9LCByZXN1bHQpLCB7IGl0ZW1OYW1lOiBpdGVtTmFtZSB9KTtcbiAgICByZXR1cm4geyByZXN1bHQ6IGNvbm5TdHJpbmcgfTtcbiAgfVxuICBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zb2xlLmVycm9yKGVycm9yKTtcbiAgICByZXR1cm4geyBlcnJvcjogeyBjb2RlOiBcInVuaGFuZGxlZEVycm9yXCIsIG1lc3NhZ2U6IEpTT04uc3RyaW5naWZ5KGVycm9yKSB9IH07XG4gIH1cbn07XG5jb25zdCBzdWJtaXREYXRhYmFzZUZpbGVKb2IgPSBhc3luYyAoaXRlbSwgaG9zdGluZ1NlcnZlckFkbWluVXJsKSA9PiB7XG4gIGNvbnN0IHB1Ymxpc2hpbmdUb29sc1VybCA9IGdldFB1Ymxpc2hpbmdUb29sc1VybChob3N0aW5nU2VydmVyQWRtaW5VcmwpO1xuICBjb25zdCB1cmwgPSBgJHtwdWJsaXNoaW5nVG9vbHNVcmx9L0dldCUyMERhdGFiYXNlJTIwQ29ubmVjdGlvbiUyMFN0cmluZy9zdWJtaXRKb2JgO1xuICBjb25zdCBkYXRhID0geyBpbl9pbnB1dERhdGE6IGl0ZW0uaXRlbUlELCBpbl9jb25uRGF0YVR5cGU6IFwiVVBMT0FERURfQ09OTkVDVElPTl9GSUxFX0lEXCIgfTtcbiAgdHJ5IHtcbiAgICBjb25zdCB7IGpvYklkLCBqb2JTdGF0dXMgfSA9IGF3YWl0IHJlcXVlc3QodXJsLCBkYXRhLCB7fSwgXCJwb3N0XCIpO1xuICAgIGlmICgoam9iU3RhdHVzIHx8IFwiXCIpID09PSBcImVzcmlKb2JTdWJtaXR0ZWRcIikge1xuICAgICAgY29uc3QgdXJsID0gYCR7cHVibGlzaGluZ1Rvb2xzVXJsfS9HZXQlMjBEYXRhYmFzZSUyMENvbm5lY3Rpb24lMjBTdHJpbmcvam9icy8ke2pvYklkfWA7XG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBwb2xsRm9yU3RhdHVzKHVybCwge1xuICAgICAgICByZXF1ZXN0UGFyYW1zOiB7IGpvYklkOiBqb2JJZCwgam9iU3RhdHVzOiBqb2JTdGF0dXMgfSxcbiAgICAgICAgcGVuZGluZ1N0YXR1c2VzOiBbXCJlc3JpSm9iTmV3XCIsIFwiZXNyaUpvYlN1Ym1pdHRlZFwiLCBcImVzcmlKb2JXYWl0aW5nXCIsIFwiZXNyaUpvYkV4ZWN1dGluZ1wiXSxcbiAgICAgICAgc3VjY2Vzc1N0YXR1c2VzOiBbXCJlc3JpSm9iU3VjY2VlZGVkXCJdXG4gICAgICB9KTtcbiAgICAgIGNvbnN0IGNvbm5lY3Rpb25TdHJpbmcgPSBhd2FpdCBnZXRDb25uZWN0aW9uU3RyaW5nKHJlc3VsdCwgcHVibGlzaGluZ1Rvb2xzVXJsKTtcbiAgICAgIHJldHVybiB7IHJlc3VsdDogY29ubmVjdGlvblN0cmluZyB9O1xuICAgIH1cbiAgICByZXR1cm4geyByZXN1bHQ6IG51bGwgfTtcbiAgfVxuICBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zb2xlLmVycm9yKGVycm9yKTtcbiAgICByZXR1cm4geyBlcnJvcjogeyBjb2RlOiBcInVuaGFuZGxlZEVycm9yXCIsIG1lc3NhZ2U6IEpTT04uc3RyaW5naWZ5KGVycm9yKSB9IH07XG4gIH1cbn07XG5jb25zdCBmZXRjaENsb3VkU3RvcmFnZVJlZ2lvbkluZm8gPSBhc3luYyAocHJvdmlkZXIpID0+IHtcbiAgY29uc3QgcmVnaW9uSW5mb1VSTCA9IFwiaHR0cHM6Ly9lc3JpcmVzb3VyY2VzLnMzLmFtYXpvbmF3cy5jb20vMTEyMC9yZWdpb25zZm9yY2xvdWRzdG9yYWdlLmRhdFwiO1xuICB0cnkge1xuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgcmVxdWVzdChyZWdpb25JbmZvVVJMKTtcbiAgICBsZXQgcmVzdWx0O1xuICAgIGlmIChwcm92aWRlciA9PT0gXCJhbWF6b25cIikge1xuICAgICAgcmVzdWx0ID0gcmVzcG9uc2UuQW1hem9uLnJlZ2lvbnM7XG4gICAgfVxuICAgIGVsc2UgaWYgKHByb3ZpZGVyID09PSBcImF6dXJlXCIgfHwgcHJvdmlkZXIgPT09IFwiYXp1cmVkYXRhbGFrZWdlbjJzdG9yZVwiKSB7XG4gICAgICByZXN1bHQgPSByZXNwb25zZS5lbnZpcm9ubWVudHM7XG4gICAgfVxuICAgIGVsc2UgaWYgKHByb3ZpZGVyID09PSBcImFsaWJhYmFcIikge1xuICAgICAgcmVzdWx0ID0gcmVzcG9uc2UuQWxpYmFiYS5yZWdpb25zO1xuICAgIH1cbiAgICBlbHNlIGlmIChwcm92aWRlciA9PT0gXCJnb29nbGVcIikge1xuICAgICAgcmVzdWx0ID0gcmVzcG9uc2UuR29vZ2xlLnJlZ2lvbnM7XG4gICAgfVxuICAgIHJldHVybiB7IHJlc3VsdDogcmVzdWx0IH07XG4gIH1cbiAgY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcihlcnJvcik7XG4gICAgcmV0dXJuIHsgZXJyb3I6IHsgY29kZTogXCJ1bmhhbmRsZWRFcnJvclwiLCBtZXNzYWdlOiBKU09OLnN0cmluZ2lmeShlcnJvcikgfSB9O1xuICB9XG59O1xuY29uc3QgdmFsaWRhdGVEYXRhc3RvcmVGb3JPbmxpbmUgPSBhc3luYyAob3JnSWQsIHBvcnRhbCwgcGF5bG9hZCkgPT4ge1xuICBjb25zdCB1cmwgPSBgJHtwb3J0YWwudXNlci5wb3J0YWwuaGVscGVyU2VydmljZXMuZGF0YXN0b3JlTWFuYWdlbWVudC51cmx9LyR7b3JnSWR9L2RhdGEvdmFsaWRhdGVEYXRhSXRlbWA7XG4gIGNvbnN0IGl0ZW0gPSBKU09OLnN0cmluZ2lmeShwYXlsb2FkKTtcbiAgdHJ5IHtcbiAgICBjb25zdCB2YWxpZGF0ZVJlc3BvbnNlID0gYXdhaXQgcmVxdWVzdEZldGNoKHVybCwgcG9ydGFsLCB7XG4gICAgICBib2R5OiB7IGl0ZW0sIGY6IFwianNvblwiIH0sXG4gICAgICB1c2VQb3N0OiB0cnVlXG4gICAgfSk7XG4gICAgcmV0dXJuIHsgcmVzdWx0OiB2YWxpZGF0ZVJlc3BvbnNlIH07XG4gIH1cbiAgY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc3QgZXJyb3JNZXNzYWdlID0gU3RyaW5nKGVycm9yKS50b0xvd2VyQ2FzZSgpIHx8IFwiXCI7XG4gICAgc3dpdGNoICh0cnVlKSB7XG4gICAgICBjYXNlIGVycm9yTWVzc2FnZS5pbmNsdWRlcyhcImluY29ycmVjdCB1c2VybmFtZSBvciBwYXNzd29yZCB3YXMgc3BlY2lmaWVkLlwiKTpcbiAgICAgICAgcmV0dXJuIHsgZXJyb3I6IHsgY29kZTogXCJpbnZhbGlkVXNlcm5hbWVPclBhc3N3b3JkXCIgfSB9O1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgcmV0dXJuIHsgZXJyb3I6IHsgY29kZTogXCJ1bmhhbmRsZWRFcnJvclwiIH0gfTtcbiAgICB9XG4gIH1cbn07XG5jb25zdCB2YWxpZGF0ZURhdGFzdG9yZUZvclNlcnZlcnMgPSBhc3luYyAoaXRlbSwgc2VydmVyTGlzdCwgZGF0YXN0b3JlVHlwZSkgPT4ge1xuICBsZXQgc2VydmVycyA9IHNlcnZlckxpc3Q7XG4gIGF3YWl0IFByb21pc2UuYWxsKHNlcnZlcnMubWFwKChzZXJ2ZXIpID0+IHZhbGlkYXRlU2VydmVyRm9yQWRkRGF0YVN0b3JlKGl0ZW0sIHNlcnZlciwgZGF0YXN0b3JlVHlwZSkpKS50aGVuKChyZXNwb25zZXMpID0+IHtcbiAgICBzZXJ2ZXJzID0gc2VydmVycy5tYXAoKHNlcnZlcikgPT4ge1xuICAgICAgbGV0IHVwZGF0ZWRTZXJ2ZXIgPSBzZXJ2ZXI7XG4gICAgICByZXNwb25zZXMuZm9yRWFjaCgocmVzcG9uc2UpID0+IHtcbiAgICAgICAgdmFyIF9hLCBfYiwgX2MsIF9kLCBfZSwgX2YsIF9nLCBfaCwgX2osIF9rLCBfbCwgX207XG4gICAgICAgIGlmIChyZXNwb25zZS5zdGF0dXMgPT09IFwic3VjY2Vzc1wiIHx8XG4gICAgICAgICAgKChfYSA9IHJlc3BvbnNlLm1hY2hpbmVzKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2FbMF0ubWFjaGluZS50b0xvd2VyQ2FzZSgpKSA9PT0gc2VydmVyLm5hbWUudG9Mb3dlckNhc2UoKS5zcGxpdChcIjpcIilbMF0pIHtcbiAgICAgICAgICB1cGRhdGVkU2VydmVyID0gT2JqZWN0LmFzc2lnbihPYmplY3QuYXNzaWduKHt9LCBzZXJ2ZXIpLCB7IHNlcnZlclN0YXR1czogcmVzcG9uc2Uuc3RhdHVzIHx8IHJlc3BvbnNlLm1hY2hpbmVzWzBdLnN0YXR1cywgZXJyb3JNc2c6ICgoKF9iID0gcmVzcG9uc2UubWFjaGluZXMpID09PSBudWxsIHx8IF9iID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYlswXS5zdGF0dXMpID09PSBcImVycm9yXCIgJiZcbiAgICAgICAgICAgICAgKChfYyA9IHJlc3BvbnNlID09PSBudWxsIHx8IHJlc3BvbnNlID09PSB2b2lkIDAgPyB2b2lkIDAgOiByZXNwb25zZS5lcnJvcikgPT09IG51bGwgfHwgX2MgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9jLm1lc3NhZ2UpICYmXG4gICAgICAgICAgICAgIEpTT04ucGFyc2UocmVzcG9uc2UuZXJyb3IubWVzc2FnZSkubWVzc2FnZSkgfHxcbiAgICAgICAgICAgICAgKCgoX2UgPSAoX2QgPSByZXNwb25zZS5tYWNoaW5lcykgPT09IG51bGwgfHwgX2QgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9kWzBdLmRhdGFJdGVtcykgPT09IG51bGwgfHwgX2UgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9lWzBdKSAmJiAoKF9nID0gKF9mID0gcmVzcG9uc2UubWFjaGluZXMpID09PSBudWxsIHx8IF9mID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfZlswXS5kYXRhSXRlbXMpID09PSBudWxsIHx8IF9nID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfZ1swXS5tZXNzYWdlKSkgfSk7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgdXBkYXRlZFNlcnZlciA9IE9iamVjdC5hc3NpZ24oT2JqZWN0LmFzc2lnbih7fSwgc2VydmVyKSwgeyBzZXJ2ZXJTdGF0dXM6IFwiZXJyb3JcIiwgZXJyb3JNc2c6ICgoKF9oID0gcmVzcG9uc2UgPT09IG51bGwgfHwgcmVzcG9uc2UgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHJlc3BvbnNlLmVycm9yKSA9PT0gbnVsbCB8fCBfaCA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2gubWVzc2FnZSkgJiYgSlNPTi5wYXJzZShyZXNwb25zZS5lcnJvci5tZXNzYWdlKS5tZXNzYWdlKSB8fFxuICAgICAgICAgICAgICAoKChfayA9IChfaiA9IHJlc3BvbnNlLm1hY2hpbmVzKSA9PT0gbnVsbCB8fCBfaiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2pbMF0uZGF0YUl0ZW1zKSA9PT0gbnVsbCB8fCBfayA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2tbMF0pICYmICgoX20gPSAoX2wgPSByZXNwb25zZS5tYWNoaW5lcykgPT09IG51bGwgfHwgX2wgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9sWzBdLmRhdGFJdGVtcykgPT09IG51bGwgfHwgX20gPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9tWzBdLm1lc3NhZ2UpKSB9KTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgICByZXR1cm4gdXBkYXRlZFNlcnZlcjtcbiAgICB9KTtcbiAgfSk7XG4gIHJldHVybiBzZXJ2ZXJzO1xufTtcbmNvbnN0IHZhbGlkYXRlU2VydmVyRm9yQWRkRGF0YVN0b3JlID0gYXN5bmMgKGl0ZW0sIHNlcnZlciwgZGF0YXN0b3JlVHlwZSkgPT4ge1xuICB2YXIgX2E7XG4gIGxldCBkYXRhc3RvcmVQYXlsb2FkO1xuICBjb25zdCBiZGZzVHlwZSA9IGl0ZW0uYmRmc1R5cGU7XG4gIGxldCB2YWxpZGF0ZVNlcnZlclBheWxvYWQgPSBudWxsO1xuICBpZiAoZGF0YXN0b3JlVHlwZSA9PT0gXCJiZGZzXCIpIHtcbiAgICBpZiAoYmRmc1R5cGUgPT09IFwiZmlsZXNoYXJlXCIpIHtcbiAgICAgIGRhdGFzdG9yZVBheWxvYWQgPSBjcmVhdGVGaWxlU2hhcmVQcm92aWRlckRhdGFPYmplY3QoaXRlbSk7XG4gICAgfVxuICAgIGVsc2UgaWYgKGJkZnNUeXBlID09PSBcImhkZnNcIikge1xuICAgICAgZGF0YXN0b3JlUGF5bG9hZCA9IGNyZWF0ZUhkZnNQcm92aWRlckRhdGFPYmplY3QoaXRlbSk7XG4gICAgfVxuICAgIGVsc2UgaWYgKGJkZnNUeXBlID09PSBcImhpdmVcIikge1xuICAgICAgZGF0YXN0b3JlUGF5bG9hZCA9IGNyZWF0ZUhpdmVQcm92aWRlckRhdGFPYmplY3QoaXRlbSk7XG4gICAgfVxuICAgIGVsc2UgaWYgKGJkZnNUeXBlID09PSBcImNsb3VkXCIpIHtcbiAgICAgIGlmIChpdGVtLmJkZnNDbG91ZFR5cGUgPT09IFwibmV3XCIpIHtcbiAgICAgICAgZGF0YXN0b3JlUGF5bG9hZCA9IGNyZWF0ZUNsb3VkUHJvdmlkZXJEYXRhT2JqZWN0KGl0ZW0pO1xuICAgICAgICBkYXRhc3RvcmVQYXlsb2FkLmluZm8uaXNNYW5hZ2VkID0gZmFsc2U7XG4gICAgICB9XG4gICAgICAvLyB2YWxpZGF0aW5nIGFnYWluc3QgZXhpc3RpbmcgY2xvdWQgZGF0YSBzdG9yZVxuICAgICAgZWxzZSB7XG4gICAgICAgIHZhbGlkYXRlU2VydmVyUGF5bG9hZCA9IHtcbiAgICAgICAgICBzZXJ2ZXJJZDogc2VydmVyLmlkLFxuICAgICAgICAgIGRhdGFzdG9yZUlkOiBpdGVtLmJkZnNFeGlzdGluZ0RhdGFzdG9yZS5pZCxcbiAgICAgICAgICBmOiBcImpzb25cIlxuICAgICAgICB9O1xuICAgICAgfVxuICAgIH1cbiAgfVxuICBlbHNlIHtcbiAgICBpZiAoZGF0YXN0b3JlVHlwZSA9PT0gXCJmb2xkZXJcIikge1xuICAgICAgZGF0YXN0b3JlUGF5bG9hZCA9IGNyZWF0ZUZvbGRlckRhdGFPYmplY3QoaXRlbSk7XG4gICAgfVxuICAgIGVsc2UgaWYgKGRhdGFzdG9yZVR5cGUgPT09IFwiZGF0YWJhc2VcIikge1xuICAgICAgZGF0YXN0b3JlUGF5bG9hZCA9IGNyZWF0ZURhdGFiYXNlRGF0YU9iamVjdChpdGVtKTtcbiAgICB9XG4gICAgZWxzZSBpZiAoZGF0YXN0b3JlVHlwZSA9PT0gXCJjbG91ZFwiKSB7XG4gICAgICBkYXRhc3RvcmVQYXlsb2FkID0gY3JlYXRlQ2xvdWRQcm92aWRlckRhdGFPYmplY3QoaXRlbSk7XG4gICAgfVxuICAgIGVsc2UgaWYgKGRhdGFzdG9yZVR5cGUgPT09IFwibm9zcWxcIikge1xuICAgICAgZGF0YXN0b3JlUGF5bG9hZCA9IGNyZWF0ZU5vU3FsRGF0YU9iamVjdChpdGVtKTtcbiAgICB9XG4gICAgZGF0YXN0b3JlUGF5bG9hZC5pbmZvLmlzTWFuYWdlZCA9IGZhbHNlO1xuICB9XG4gIC8vIGh0dHBzOi8vZGV2ZWxvcGVycy5hcmNnaXMuY29tL3Jlc3QvdXNlcnMtZ3JvdXBzLWFuZC1pdGVtcy92YWxpZGF0ZS1kYXRhc3RvcmUuaHRtXG4gIGNvbnN0IHBvcnRhbCA9IGNvbmZpZ1N0YXRlLnBvcnRhbDtcbiAgY29uc3QgcmVzdEJhc2VVcmwgPSBgJHsoX2EgPSBwb3J0YWwucmVzdFVybCkgIT09IG51bGwgJiYgX2EgIT09IHZvaWQgMCA/IF9hIDogcG9ydGFsLnBvcnRhbFVybH1wb3J0YWxzLyR7cG9ydGFsLmlkfWA7XG4gIGNvbnN0IHZhbGlkYXRlU2VydmVyVXJsID0gYCR7cmVzdEJhc2VVcmx9L2RhdGFzdG9yZXMvdmFsaWRhdGVgO1xuICBpZiAoIXZhbGlkYXRlU2VydmVyUGF5bG9hZCkge1xuICAgIHZhbGlkYXRlU2VydmVyUGF5bG9hZCA9IHtcbiAgICAgIGRhdGFzdG9yZTogSlNPTi5zdHJpbmdpZnkoZGF0YXN0b3JlUGF5bG9hZCksXG4gICAgICBzZXJ2ZXJJZDogc2VydmVyLmlkLFxuICAgICAgZjogXCJqc29uXCJcbiAgICB9O1xuICB9XG4gIHRyeSB7XG4gICAgY29uc3QgeyBzdGF0dXMsIG1hY2hpbmVzIH0gPSBhd2FpdCByZXF1ZXN0KHZhbGlkYXRlU2VydmVyVXJsLCB2YWxpZGF0ZVNlcnZlclBheWxvYWQsIHt9LCBcInBvc3RcIik7XG4gICAgcmV0dXJuIHsgc3RhdHVzOiBzdGF0dXMsIG1hY2hpbmVzOiBtYWNoaW5lcyB9O1xuICB9XG4gIGNhdGNoIChlcnJvcikge1xuICAgIGNvbnNvbGUuZXJyb3IoZXJyb3IpO1xuICAgIHJldHVybiB7IGVycm9yOiB7IGNvZGU6IFwidW5oYW5kbGVkRXJyb3JcIiwgbWVzc2FnZTogSlNPTi5zdHJpbmdpZnkoZXJyb3IpIH0gfTtcbiAgfVxufTtcbmNvbnN0IGNoZWNrU2VydmVyc1R5cGUgPSBhc3luYyAoc2VydmVyTGlzdCkgPT4ge1xuICBsZXQgc2VydmVyVHlwZXMgPSBbXTtcbiAgbGV0IHNlcnZlcnMgPSBzZXJ2ZXJMaXN0O1xuICBpZiAoaXNBcmNHSVNFbnRlcnByaXNlT25LdWJlcm5ldGVzKCkpIHtcbiAgICBjb25zdCBzZXJ2ZXJzVG9WYWxpZGF0ZSA9IFtdO1xuICAgIHNlcnZlcnMuZm9yRWFjaCgoZmVkZXJhdGVkU2VydmVyKSA9PiB7XG4gICAgICBpZiAoZmVkZXJhdGVkU2VydmVyLmlzSG9zdGVkKSB7XG4gICAgICAgIGNvbnN0IHNlcnZlckl0ZW0gPSB7IG5hbWU6IGZlZGVyYXRlZFNlcnZlci5hZG1pblVybCwgdHlwZTogXCJMaW51eFwiIH07XG4gICAgICAgIHNlcnZlclR5cGVzLnB1c2goc2VydmVySXRlbSk7XG4gICAgICB9XG4gICAgICBlbHNlIGlmIChmZWRlcmF0ZWRTZXJ2ZXIuc2VydmVyUm9sZSA9PT0gXCJGRURFUkFURURfU0VSVkVSXCIpIHtcbiAgICAgICAgc2VydmVyc1RvVmFsaWRhdGUucHVzaChmZWRlcmF0ZWRTZXJ2ZXIpO1xuICAgICAgfVxuICAgIH0pO1xuICAgIGNvbnN0IHJlc3BvbnNlcyA9IGF3YWl0IFByb21pc2UuYWxsU2V0dGxlZChzZXJ2ZXJzVG9WYWxpZGF0ZS5tYXAoKHNlcnZlcikgPT4ge1xuICAgICAgY29uc3QgdXJsID0gYCR7c2VydmVyLmFkbWluVXJsfS9hZG1pbi9tYWNoaW5lcz9mPWpzb25gO1xuICAgICAgcmV0dXJuIHJlcXVlc3QodXJsLCB7fSwge30sIFwicG9zdFwiKTtcbiAgICB9KSk7XG4gICAgYXdhaXQgUHJvbWlzZS5hbGxTZXR0bGVkKHJlc3BvbnNlcy5tYXAoKHJlc3BvbnNlKSA9PiB7XG4gICAgICB2YXIgX2E7XG4gICAgICByZXR1cm4gdmFsaWRhdGVTZXJ2ZXJUeXBlS3ViZXJuZXRlcygoX2EgPSByZXNwb25zZSA9PT0gbnVsbCB8fCByZXNwb25zZSA9PT0gdm9pZCAwID8gdm9pZCAwIDogcmVzcG9uc2UudmFsdWUpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5tYWNoaW5lcywgc2VydmVycykudGhlbigodmFsaWRhdGVkU2VydmVyVHlwZXMpID0+IHtcbiAgICAgICAgc2VydmVyVHlwZXMgPSBbLi4uc2VydmVyVHlwZXMsIC4uLnZhbGlkYXRlZFNlcnZlclR5cGVzXTtcbiAgICAgIH0pO1xuICAgIH0pKTtcbiAgfVxuICBlbHNlIHtcbiAgICAvLyAxLiBSZXRyaWV2ZSB0aGUgRmVkZXJhdGVkIG1hY2hpbmVzXG4gICAgY29uc3QgcmVzcG9uc2VzID0gYXdhaXQgUHJvbWlzZS5hbGxTZXR0bGVkKHNlcnZlcnMubWFwKChzZXJ2ZXIpID0+IHtcbiAgICAgIGNvbnN0IHVybCA9IGAke3NlcnZlci5hZG1pblVybH0vYWRtaW4vbWFjaGluZXM/Zj1qc29uYDtcbiAgICAgIHJldHVybiByZXF1ZXN0KHVybCwge30sIHt9LCBcInBvc3RcIik7XG4gICAgfSkpO1xuICAgIGF3YWl0IFByb21pc2UuYWxsU2V0dGxlZChyZXNwb25zZXMubWFwKChyZXNwb25zZSkgPT4ge1xuICAgICAgdmFyIF9hO1xuICAgICAgcmV0dXJuIHZhbGlkYXRlU2VydmVyVHlwZSgoX2EgPSByZXNwb25zZSA9PT0gbnVsbCB8fCByZXNwb25zZSA9PT0gdm9pZCAwID8gdm9pZCAwIDogcmVzcG9uc2UudmFsdWUpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5tYWNoaW5lcywgc2VydmVycykudGhlbigocmVzdWx0KSA9PiB7XG4gICAgICAgIHNlcnZlcnMgPSBbLi4ucmVzdWx0LnNlcnZlckxpc3RdO1xuICAgICAgICBzZXJ2ZXJUeXBlcyA9IHJlc3VsdC5zZXJ2ZXJUeXBlcztcbiAgICAgIH0pO1xuICAgIH0pKTtcbiAgfVxuICByZXR1cm4geyBzZXJ2ZXJzOiBzZXJ2ZXJzLCBzZXJ2ZXJUeXBlczogc2VydmVyVHlwZXMgfTtcbn07XG5jb25zdCB2YWxpZGF0ZVNlcnZlclR5cGUgPSBhc3luYyAobWFjaGluZXMsIHNlcnZlckxpc3QpID0+IHtcbiAgbGV0IHNlcnZlclR5cGVzID0gW107XG4gIC8vIDIuIFZhbGlkYXRlIHNlcnZlciB0eXBlXG4gIHNlcnZlckxpc3QubWFwKChzZXJ2ZXIsIGluZGV4KSA9PiB7XG4gICAgaWYgKG1hY2hpbmVzID09PSBudWxsIHx8IG1hY2hpbmVzID09PSB2b2lkIDAgPyB2b2lkIDAgOiBtYWNoaW5lc1tpbmRleF0pIHtcbiAgICAgIHNlcnZlci5zaG91bGRGaWx0ZXIgPSBmYWxzZTtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICBzZXJ2ZXIuc2hvdWxkRmlsdGVyID0gdHJ1ZTtcbiAgICB9XG4gIH0pO1xuICBzZXJ2ZXJMaXN0LmZpbHRlcigoc2VydmVyKSA9PiB7XG4gICAgcmV0dXJuICFzZXJ2ZXIuc2hvdWxkRmlsdGVyO1xuICB9KTtcbiAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IHNlcnZlckxpc3QubGVuZ3RoOyBpbmRleCsrKSB7XG4gICAgY29uc3QgbWFjaGluZSA9IG1hY2hpbmVzWzBdLm1hY2hpbmVOYW1lO1xuICAgIGNvbnN0IHVybCA9IGAke21hY2hpbmVzWzBdLmFkbWluVVJMfS9tYWNoaW5lcy8ke21hY2hpbmV9P2Y9anNvbmA7XG4gICAgYXdhaXQgcmVxdWVzdCh1cmwsIHt9LCB7fSwgXCJwb3N0XCIpLnRoZW4oKHJlc3VsdCkgPT4ge1xuICAgICAgaWYgKHJlc3VsdCkge1xuICAgICAgICBjb25zdCBzZXJ2ZXJJdGVtID0ge1xuICAgICAgICAgIG5hbWU6IHNlcnZlckxpc3RbaW5kZXhdLmFkbWluVXJsLFxuICAgICAgICAgIHR5cGU6IHJlc3VsdC5wbGF0Zm9ybS5pbmRleE9mKFwiV2luZG93c1wiKSA+IC0xID8gXCJXaW5kb3dzXCIgOiBcIkxpbnV4XCJcbiAgICAgICAgfTtcbiAgICAgICAgc2VydmVyVHlwZXMucHVzaChzZXJ2ZXJJdGVtKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuICByZXR1cm4geyBzZXJ2ZXJUeXBlczogc2VydmVyVHlwZXMsIHNlcnZlckxpc3Q6IHNlcnZlckxpc3QgfTtcbn07XG5jb25zdCByZXF1ZXN0Q2xvdWRTdG9yZUxpc3QgPSBhc3luYyAoKSA9PiB7XG4gIGNvbnN0IG9yZ0lkID0gY29uZmlnU3RhdGUudXNlci5vcmdJZDtcbiAgY29uc3QgdHlwZSA9IFwiRGF0YSBTdG9yZVwiO1xuICBjb25zdCBxID0gYG9yZ2lkOiR7b3JnSWR9IHR5cGU6XCIke3R5cGV9XCJgO1xuICBjb25zdCBudW0gPSAxMDAwMDtcbiAgY29uc3QgY29udGVudCA9IHsgcSwgbnVtIH07XG4gIGNvbnN0IHVybCA9IGAke2dldFJlc3RCYXNlVXJsKCl9c2VhcmNoYDtcbiAgY29uc3Qgc3VwcG9ydGVkQ2xvdWRTdG9yZXMgPSBbXG4gICAgXCJjbG91ZFN0b3JlX2FtYXpvblwiLFxuICAgIFwiY2xvdWRTdG9yZV9henVyZVwiLFxuICAgIFwiY2xvdWRTdG9yZV9henVyZWRhdGFsYWtlZ2VuMnN0b3JlXCIsXG4gICAgXCJjbG91ZFN0b3JlX2F6dXJlRGF0YUxha2VTdG9yZVwiXG4gIF07XG4gIHRyeSB7XG4gICAgY29uc3QgZXhpc3RpbmdDbG91ZFN0b3JlSWRzID0gW107XG4gICAgY29uc3QgeyByZXN1bHRzIH0gPSBhd2FpdCByZXF1ZXN0KHVybCwgY29udGVudCk7XG4gICAgcmVzdWx0cyA9PT0gbnVsbCB8fCByZXN1bHRzID09PSB2b2lkIDAgPyB2b2lkIDAgOiByZXN1bHRzLmZvckVhY2goKHsgaWQsIHRpdGxlLCB0eXBlLCB0eXBlS2V5d29yZHMgfSkgPT4ge1xuICAgICAgLy8gRXhjbHVkZSBCaWcgRGF0YSBGaWxlIFNoYXJlIGl0ZW1zXG4gICAgICBpZiAoIXR5cGVLZXl3b3Jkcy5pbmNsdWRlcyhcImJpZ0RhdGFGaWxlU2hhcmVcIikgJiZcbiAgICAgICAgdHlwZUtleXdvcmRzLnNvbWUoKGtleXdvcmQpID0+IHN1cHBvcnRlZENsb3VkU3RvcmVzLmluY2x1ZGVzKGtleXdvcmQpKSkge1xuICAgICAgICBleGlzdGluZ0Nsb3VkU3RvcmVJZHMucHVzaCh7IGlkLCB0aXRsZSwgdHlwZSwgdHlwZUtleXdvcmRzIH0pO1xuICAgICAgfVxuICAgIH0pO1xuICAgIHJldHVybiB7IHJlc3VsdDogZXhpc3RpbmdDbG91ZFN0b3JlSWRzIH07XG4gIH1cbiAgY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcihlcnJvcik7XG4gICAgcmV0dXJuIHsgZXJyb3I6IHsgY29kZTogXCJ1bmhhbmRsZWRFcnJvclwiLCBtZXNzYWdlOiBKU09OLnN0cmluZ2lmeShlcnJvcikgfSB9O1xuICB9XG59O1xuY29uc3QgcmVxdWVzdENsb3VkU3RvcmVJbmZvID0gYXN5bmMgKHNlbGVjdGVkQ2xvdWRTdG9yZUlkKSA9PiB7XG4gIGNvbnN0IHVybCA9IGAke2dldFJlc3RCYXNlVXJsKCl9Y29udGVudC9pdGVtcy8ke3NlbGVjdGVkQ2xvdWRTdG9yZUlkfS9kYXRhYDtcbiAgdHJ5IHtcbiAgICBjb25zdCB7IGlkLCBwYXRoLCBwcm92aWRlciB9ID0gYXdhaXQgcmVxdWVzdCh1cmwpO1xuICAgIHJldHVybiB7IGlkOiBpZCwgcGF0aDogcGF0aCwgcHJvdmlkZXI6IHByb3ZpZGVyIH07XG4gIH1cbiAgY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcihlcnJvcik7XG4gICAgcmV0dXJuIHsgZXJyb3I6IHsgY29kZTogXCJ1bmhhbmRsZWRFcnJvclwiLCBtZXNzYWdlOiBKU09OLnN0cmluZ2lmeShlcnJvcikgfSB9O1xuICB9XG59O1xuY29uc3QgdmFsaWRhdGVTZXJ2ZXJUeXBlS3ViZXJuZXRlcyA9IGFzeW5jIChtYWNoaW5lcywgc2VydmVyTGlzdCkgPT4ge1xuICBsZXQgc2VydmVyVHlwZXMgPSBbXTtcbiAgYXdhaXQgUHJvbWlzZS5hbGwoc2VydmVyTGlzdC5tYXAoKGZlZGVyYXRlZFNlcnZlciwgaW5kZXgpID0+IHtcbiAgICBpZiAoIWZlZGVyYXRlZFNlcnZlci5pc0hvc3RlZCkge1xuICAgICAgY29uc3QgbWFjaGluZSA9IG1hY2hpbmVzWzBdLm1hY2hpbmVOYW1lO1xuICAgICAgY29uc3QgdXJsID0gYCR7bWFjaGluZXNbMF0uYWRtaW5VUkx9L21hY2hpbmVzLyR7bWFjaGluZX0/Zj1qc29uYDtcbiAgICAgIHJldHVybiByZXF1ZXN0KHVybCwge30sIHt9LCBcInBvc3RcIikudGhlbigocmVzdWx0KSA9PiB7XG4gICAgICAgIGlmICghcmVzdWx0LmlzSG9zdGVkKSB7XG4gICAgICAgICAgY29uc3Qgc2VydmVySXRlbSA9IHtcbiAgICAgICAgICAgIG5hbWU6IHNlcnZlckxpc3RbaW5kZXhdLmFkbWluVXJsLFxuICAgICAgICAgICAgdHlwZTogcmVzdWx0LnBsYXRmb3JtLmluZGV4T2YoXCJXaW5kb3dzXCIpID4gLTEgPyBcIldpbmRvd3NcIiA6IFwiTGludXhcIlxuICAgICAgICAgIH07XG4gICAgICAgICAgc2VydmVyVHlwZXMucHVzaChzZXJ2ZXJJdGVtKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuICB9KSk7XG4gIHJldHVybiBzZXJ2ZXJUeXBlcztcbn07XG5jb25zdCByZWdpc3RlckRhdGFTdG9yZVdpdGhTZXJ2ZXJzID0gYXN5bmMgKGFkZEl0ZW1JbmZvLCBpdGVtLCB0aXRsZSwgdGFncywgY2F0ZWdvcmllcywgc25pcHBldCkgPT4ge1xuICB2YXIgX2E7XG4gIGNvbnN0IHsgcG9ydGFsIH0gPSBjb25maWdTdGF0ZTtcbiAgY29uc3QgcmVzdEJhc2VVcmwgPSBgJHsoX2EgPSBwb3J0YWwucmVzdFVybCkgIT09IG51bGwgJiYgX2EgIT09IHZvaWQgMCA/IF9hIDogcG9ydGFsLnBvcnRhbFVybH1wb3J0YWxzLyR7cG9ydGFsLmlkfWA7XG4gIGNvbnN0IHNlcnZlcnMgPSBpdGVtLmRhdGFTdG9yZVNlbGVjdGVkU2VydmVycztcbiAgY29uc3QgYWRkUmVzdWx0cyA9IGF3YWl0IFByb21pc2UuYWxsKHNlcnZlcnMubWFwKChzZXJ2ZXJJZCkgPT4ge1xuICAgIGNvbnN0IGNvbnRlbnQgPSB7XG4gICAgICBzZXJ2ZXJJZCxcbiAgICAgIGRhdGFzdG9yZUlkOiBhZGRJdGVtSW5mby5pZFxuICAgIH07XG4gICAgaWYgKGlzQXJjR0lTRW50ZXJwcmlzZU9uS3ViZXJuZXRlcygpICYmIGl0ZW0uYWRkRGF0YVN0b3JlVHlwZSA9PT0gXCJmb2xkZXJcIiAmJiBpdGVtLmFsbG93U2VydmljZXNSZXN0YXJ0KSB7XG4gICAgICBjb250ZW50Lm9wdGlvbnMgPSBKU09OLnN0cmluZ2lmeSh7IGFsbG93U2VydmljZXNSZXN0YXJ0OiB0cnVlIH0pO1xuICAgIH1cbiAgICBjb25zdCBhZGRUb1NlcnZlclVybCA9IGAke3Jlc3RCYXNlVXJsfS9kYXRhc3RvcmVzL2FkZFRvU2VydmVyYDtcbiAgICByZXR1cm4gcmVxdWVzdChhZGRUb1NlcnZlclVybCwgY29udGVudCwge30sIFwicG9zdFwiKTtcbiAgfSkpO1xuICBsZXQgcmVzdWx0ID0geyBzdWNjZXNzOiBmYWxzZSwgaWQ6IG51bGwsIGZvbGRlcjogbnVsbCB9O1xuICBmb3IgKGNvbnN0IGFkZFJlc3VsdCBvZiBhZGRSZXN1bHRzKSB7XG4gICAgLy8gVE9ETzogZXJyb3IgY2hlY2tpbmcgZm9yIHRoZSBzZXJ2ZXJzXG4gICAgLy8gY29uc3QgZXJyb3JzID0gW107XG4gICAgLy8gaWYgKCFhZGRSZXN1bHQgfHwgIShhZGRSZXN1bHQucmVzdWx0WzFdIHx8IHt9KS5zdWNjZXNzKSB7XG4gICAgLy8gICBlcnJvcnMucHVzaChhZGRSZXN1bHQucmVzdWx0WzFdKTtcbiAgICAvLyB9XG4gICAgaWYgKGFkZFJlc3VsdC5zdWNjZXNzKSB7XG4gICAgICBpZiAoaXRlbS5hZGREYXRhU3RvcmVUeXBlID09PSBcImJkZnNcIiAmJiBpdGVtLmJkZnNUeXBlID09PSBcImNsb3VkXCIgJiYgaXRlbS5iZGZzQ2xvdWRUeXBlID09PSBcIm5ld1wiKSB7XG4gICAgICAgIHJlc3VsdCA9IGF3YWl0IGFkZEJkZnNEYXRhU3RvcmVJdGVtKGl0ZW0sIHRpdGxlLCB0YWdzLCBjYXRlZ29yaWVzLCBzbmlwcGV0LCBhZGRJdGVtSW5mby5pZCk7XG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICB9XG4gICAgICBlbHNlIHtcbiAgICAgICAgaWYgKFtcImZvbGRlclwiLCBcImRhdGFiYXNlXCIsIFwibm9zcWxcIiwgXCJjbG91ZFwiXS5pbmNsdWRlcyhpdGVtLmFkZERhdGFTdG9yZVR5cGUpKSB7XG4gICAgICAgICAgcmVzdWx0ID0geyBzdWNjZXNzOiB0cnVlLCBpZDogYWRkSXRlbUluZm8uaWQsIGZvbGRlcjogYWRkSXRlbUluZm8uaWQgfTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAvLyBGb3IgQkRGUyBEYXRhIFN0b3JlOiBnZXQgQ2F0YWxvZyBTZXJ2aWNlIGl0ZW0gaWRcbiAgICAgICAgICBjb25zdCBnZXRDYXRhbG9nID0gYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgaXRlbVVybCA9IGAke2dldFJlc3RCYXNlVXJsKCl9Y29udGVudC9pdGVtcy8ke2FkZEl0ZW1JbmZvLmlkfS9yZWxhdGVkSXRlbXNgO1xuICAgICAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCByZXF1ZXN0KGl0ZW1VcmwsIHtcbiAgICAgICAgICAgICAgcmVsYXRpb25zaGlwVHlwZTogXCJCREZTRGF0YVN0b3JlMkJERlNDYXRhbG9nU2VydmljZVwiLFxuICAgICAgICAgICAgICBkaXJlY3Rpb246IFwiZm9yd2FyZFwiXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGlmIChyZXNwb25zZS50b3RhbCkge1xuICAgICAgICAgICAgICByZXN1bHQgPSB7IHN1Y2Nlc3M6IHRydWUsIGlkOiByZXNwb25zZS5yZWxhdGVkSXRlbXNbMF0uaWQsIGZvbGRlcjogYWRkSXRlbUluZm8uaWQgfTtcbiAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICBhd2FpdCB0aW1lb3V0KDEwMDAwKTtcbiAgICAgICAgICAgICAgcmV0dXJuIGdldENhdGFsb2coKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9O1xuICAgICAgICAgIHJlc3VsdCA9IGdldENhdGFsb2coKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfVxuICByZXR1cm4gcmVzdWx0O1xufTtcbi8vZm9yIGFkZGluZyBCREZTIGNsb3VkIGRhdGEgc3RvcmVcbmNvbnN0IGFkZEJkZnNEYXRhU3RvcmVJdGVtID0gYXN5bmMgKGl0ZW0sIHRpdGxlLCB0YWdzLCBjYXRlZ29yaWVzLCBzbmlwcGV0LCBjbG91ZElkLCBjbG91ZFBhdGgpID0+IHtcbiAgY29uc3QgdXJsID0gYCR7Z2V0UmVzdEJhc2VVcmwoKX1jb250ZW50L2l0ZW1zLyR7Y2xvdWRJZH0vZGF0YWA7XG4gIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgcmVxdWVzdCh1cmwpO1xuICBjb25zdCBwYXRoID0gY2xvdWRQYXRoIHx8IHJlc3BvbnNlLnBhdGg7XG4gIGNvbnN0IGRhdGFzdG9yZVRpdGxlID0gcGF0aC5zcGxpdChcIi9cIilbMl0uc3BsaXQoXCJfXCIpWzBdO1xuICBjb25zdCBkYXRhID0ge1xuICAgIHR5cGU6IFwiRGF0YSBTdG9yZVwiLFxuICAgIHRpdGxlOiB0aXRsZSB8fCBkYXRhc3RvcmVUaXRsZSxcbiAgICB0YWdzOiB0YWdzLFxuICAgIGNhdGVnb3JpZXM6IGNhdGVnb3JpZXMsXG4gICAgc25pcHBldDogc25pcHBldCxcbiAgICB0ZXh0OiBcIlwiXG4gIH07XG4gIGRhdGEudGV4dCA9IGdldEJkZnNQYXJhbWV0ZXJJdGVtKGRhdGEudGl0bGUsIHBhdGgpO1xuICBpdGVtLmFkZERhdGFTdG9yZVR5cGUgPSBcImJkZnNEYXRhU3RvcmVcIjtcbiAgbGV0IGFkZEl0ZW1SZXNwb25zZSA9IGF3YWl0IGFkZEl0ZW0oZGF0YSwgbnVsbCk7XG4gIGlmIChhZGRJdGVtUmVzcG9uc2Uuc3VjY2VzcyAmJiBjb25maWdTdGF0ZS5wb3J0YWwuaXNQb3J0YWwpIHtcbiAgICBhZGRJdGVtUmVzcG9uc2UgPSBhd2FpdCByZWdpc3RlckRhdGFTdG9yZVdpdGhTZXJ2ZXJzKGFkZEl0ZW1SZXNwb25zZSwgaXRlbSk7XG4gIH1cbiAgcmV0dXJuIGFkZEl0ZW1SZXNwb25zZTtcbn07XG5jb25zdCBhZGREYXRhU3RvcmUgPSBhc3luYyAoaXRlbSwgdGl0bGUsIHRhZ3MsIGNhdGVnb3JpZXMsIHNuaXBwZXQpID0+IHtcbiAgY29uc3QgZGF0YXN0b3JlVHlwZSA9IGl0ZW0uYWRkRGF0YVN0b3JlVHlwZTtcbiAgY29uc3QgZGF0YSA9IHtcbiAgICB0eXBlOiBcIkRhdGEgU3RvcmVcIixcbiAgICB0aXRsZTogdGl0bGUsXG4gICAgdGFnczogdGFncyxcbiAgICBjYXRlZ29yaWVzOiBjYXRlZ29yaWVzLFxuICAgIHNuaXBwZXQ6IHNuaXBwZXQsXG4gICAgdGV4dDogXCJcIixcbiAgICB0eXBlS2V5d29yZHM6IGl0ZW0udHlwZUtleXdvcmRzXG4gIH07XG4gIGxldCB0ZXh0O1xuICBjb25zdCBiZGZzVHlwZSA9IGl0ZW0uYmRmc1R5cGU7XG4gIGlmIChkYXRhc3RvcmVUeXBlID09PSBcImJkZnNcIikge1xuICAgIGlmIChiZGZzVHlwZSA9PT0gXCJmaWxlc2hhcmVcIikge1xuICAgICAgdGV4dCA9IGNyZWF0ZUZpbGVTaGFyZVByb3ZpZGVyRGF0YU9iamVjdChpdGVtLCB0aXRsZSk7XG4gICAgfVxuICAgIGVsc2UgaWYgKGJkZnNUeXBlID09PSBcImhkZnNcIikge1xuICAgICAgdGV4dCA9IGNyZWF0ZUhkZnNQcm92aWRlckRhdGFPYmplY3QoaXRlbSwgdGl0bGUpO1xuICAgIH1cbiAgICBlbHNlIGlmIChiZGZzVHlwZSA9PT0gXCJoaXZlXCIpIHtcbiAgICAgIHRleHQgPSBjcmVhdGVIaXZlUHJvdmlkZXJEYXRhT2JqZWN0KGl0ZW0sIHRpdGxlKTtcbiAgICB9XG4gICAgZWxzZSBpZiAoYmRmc1R5cGUgPT09IFwiY2xvdWRcIikge1xuICAgICAgaWYgKGl0ZW0uYmRmc0Nsb3VkVHlwZSA9PT0gXCJuZXdcIikge1xuICAgICAgICB0ZXh0ID0gY3JlYXRlQ2xvdWRQcm92aWRlckRhdGFPYmplY3QoaXRlbSwgdGl0bGUpO1xuICAgICAgICB0ZXh0LmluZm8uaXNNYW5hZ2VkID0gZmFsc2U7XG4gICAgICB9XG4gICAgICBlbHNlIHtcbiAgICAgICAgcmV0dXJuIGF3YWl0IGFkZEJkZnNEYXRhU3RvcmVJdGVtKGl0ZW0sIHRpdGxlLCB0YWdzLCBjYXRlZ29yaWVzLCBzbmlwcGV0LCBpdGVtLmJkZnNFeGlzdGluZ0RhdGFzdG9yZS5pZCwgaXRlbS5iZGZzRXhpc3RpbmdEYXRhc3RvcmUucGF0aCk7XG4gICAgICB9XG4gICAgfVxuICB9XG4gIGVsc2Uge1xuICAgIGlmIChkYXRhc3RvcmVUeXBlID09PSBcImZvbGRlclwiKSB7XG4gICAgICB0ZXh0ID0gY3JlYXRlRm9sZGVyRGF0YU9iamVjdChpdGVtLCB0aXRsZSk7XG4gICAgfVxuICAgIGVsc2UgaWYgKGRhdGFzdG9yZVR5cGUgPT09IFwiZGF0YWJhc2VcIikge1xuICAgICAgdGV4dCA9IGNyZWF0ZURhdGFiYXNlRGF0YU9iamVjdChpdGVtLCB0aXRsZSk7XG4gICAgfVxuICAgIGVsc2UgaWYgKGRhdGFzdG9yZVR5cGUgPT09IFwiY2xvdWRcIikge1xuICAgICAgdGV4dCA9IGNyZWF0ZUNsb3VkUHJvdmlkZXJEYXRhT2JqZWN0KGl0ZW0sIHRpdGxlKTtcbiAgICB9XG4gICAgZWxzZSBpZiAoZGF0YXN0b3JlVHlwZSA9PT0gXCJub3NxbFwiKSB7XG4gICAgICB0ZXh0ID0gY3JlYXRlTm9TcWxEYXRhT2JqZWN0KGl0ZW0sIHRpdGxlKTtcbiAgICB9XG4gICAgdGV4dC5pbmZvLmlzTWFuYWdlZCA9IGZhbHNlO1xuICB9XG4gIGRhdGEudGV4dCA9IEpTT04uc3RyaW5naWZ5KHRleHQpO1xuICBsZXQgcmVzcG9uc2UgPSBhd2FpdCBhZGRJdGVtKGRhdGEsIG51bGwpO1xuICBpZiAocmVzcG9uc2Uuc3VjY2VzcyAmJiBjb25maWdTdGF0ZS5wb3J0YWwuaXNQb3J0YWwpIHtcbiAgICByZXNwb25zZSA9IGF3YWl0IHJlZ2lzdGVyRGF0YVN0b3JlV2l0aFNlcnZlcnMocmVzcG9uc2UsIGl0ZW0sIHRpdGxlLCB0YWdzLCBjYXRlZ29yaWVzLCBzbmlwcGV0KTtcbiAgfVxuICByZXR1cm4gcmVzcG9uc2U7XG59O1xuXG5leHBvcnQgeyBhZGREYXRhU3RvcmUgYXMgYSwgcmVxdWVzdENsb3VkU3RvcmVMaXN0IGFzIGIsIHZhbGlkYXRlRGF0YXN0b3JlRm9yU2VydmVycyBhcyBjLCBjaGVja1NlcnZlcnNUeXBlIGFzIGQsIHZhbGlkYXRlRGF0YXN0b3JlU2VydmVyIGFzIGUsIGZldGNoQ2xvdWRTdG9yYWdlUmVnaW9uSW5mbyBhcyBmLCBnZXREYXRhc3RvcmVDb250ZW50cyBhcyBnLCBoYW5kbGVEYXRhYmFzZUZpbGVEcm9wIGFzIGgsIHB1Ymxpc2hGcm9tRGF0YVN0b3JlIGFzIHAsIHJlcXVlc3RDbG91ZFN0b3JlSW5mbyBhcyByLCB2YWxpZGF0ZURhdGFzdG9yZUZvck9ubGluZSBhcyB2IH07XG4iXSwibmFtZXMiOltdLCJzb3VyY2VSb290IjoiIn0=
"use strict";
(self["webpackChunkexb_client"] = self["webpackChunkexb_client"] || []).push([["vendors-extensions_widgets_arcgis_analysis_node_modules_arcgis_app-components_dist_esm_data-s-fd83b7"],{

/***/ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/data-store-e8b5ce2f.js":
/*!****************************************************************************************************************!*\
  !*** ./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/data-store-e8b5ce2f.js ***!
  \****************************************************************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   a: () => (/* binding */ createHdfsProviderDataObject),
/* harmony export */   b: () => (/* binding */ createHiveProviderDataObject),
/* harmony export */   c: () => (/* binding */ createFileShareProviderDataObject),
/* harmony export */   d: () => (/* binding */ createCloudProviderDataObject),
/* harmony export */   e: () => (/* binding */ createFolderDataObject),
/* harmony export */   f: () => (/* binding */ createDatabaseDataObject),
/* harmony export */   g: () => (/* binding */ getConnectionString),
/* harmony export */   h: () => (/* binding */ createNoSqlDataObject),
/* harmony export */   i: () => (/* binding */ isArcGISEnterpriseOnKubernetes),
/* harmony export */   j: () => (/* binding */ getBdfsParameterItem),
/* harmony export */   k: () => (/* binding */ getPublishingToolsUrl),
/* harmony export */   l: () => (/* binding */ createBigQueryDataObject),
/* harmony export */   m: () => (/* binding */ createSnowflakeDataObject)
/* harmony export */ });
/* harmony import */ var _portal_79caaeff_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./portal-79caaeff.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/portal-79caaeff.js");
/* harmony import */ var _config_eb5f7dc2_js__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./config-eb5f7dc2.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/config-eb5f7dc2.js");
/*!
 * All material copyright ESRI, All Rights Reserved, unless otherwise specified.
 * v3.0.99
 */



function createFolderDataObject(item, title) {
  const datastorePayload = {
    type: "folder",
    path: `/fileShares/${title}`,
    info: {
      datastoreConnectionType: "shared",
      path: item.publisherFolderPath,
      hostName: item.publisherFolderPathHostname
    }
  };
  if (item.allowServicesRestart) {
    datastorePayload.allowServicesRestart = true;
    datastorePayload.options = JSON.stringify({ allowServicesRestart: true });
  }
  if (item.serverFolderPath === "newPath") {
    datastorePayload.clientPath = item.publisherFolderPath;
    datastorePayload.info.path = item.newServerFolderPath;
    datastorePayload.info.datastoreConnectionType = "replicated";
  }
  else if (item.serverFolderPath === "nfsHostAndPath") {
    datastorePayload.clientPath = item.publisherFolderPath;
    datastorePayload.provider = "UserManaged";
    datastorePayload.info.datastoreConnectionType = "replicated";
    datastorePayload.info.fileServerPath = item.nfsSharePath;
    datastorePayload.info.fileServerHost = item.nfsHostName;
    datastorePayload.info.fileServerType = "nfs";
  }
  return datastorePayload;
}
function createDatabaseDataObject(item, title) {
  const datastorePayload = {
    type: "egdb",
    path: "/enterpriseDatabases/" + title,
    info: {
      dataStoreConnectionType: "shared"
    }
  };
  if (item.serverDatabaseOption === "newConnection") {
    datastorePayload.info.connectionString = item.serverConnectionString;
    datastorePayload.info.clientConnectionString = item.publisherConnectionString;
    datastorePayload.info.dataStoreConnectionType = "replicated";
  }
  else if (item.databaseProvider === "bigQuery" || item.databaseProvider === "snowflake") {
    datastorePayload.info.JDBCConnection = item.jdbcConnection;
  }
  else {
    datastorePayload.info.connectionString = item.publisherConnectionString;
  }
  return datastorePayload;
}
const createBigQueryDataObject = async (projectId, defaultDataset, keyFileContents, refreshToken) => {
  let jdbcConnection, keyFileFormatted;
  if ((keyFileContents === null || keyFileContents === void 0 ? void 0 : keyFileContents.length) > 0) {
    try {
      keyFileFormatted = JSON.parse(keyFileContents);
    }
    catch (_a) {
      return { error: { code: "invalidJSON" } };
    }
    jdbcConnection = createBigQueryDataObjectForServiceAuthentication(projectId, keyFileFormatted);
  }
  else if ((refreshToken === null || refreshToken === void 0 ? void 0 : refreshToken.length) > 0) {
    jdbcConnection = createBigQueryDataObjectForUserAuthentication(projectId, defaultDataset, refreshToken);
  }
  const dataStorePayload = {
    type: "egdb",
    path: "/enterpriseDatabases/bigQuerySvrDevDataJdbc",
    id: null,
    clientPath: null,
    info: {
      JDBCConnection: jdbcConnection
    }
  };
  return { result: dataStorePayload };
};
function createBigQueryDataObjectForUserAuthentication(projectId, defaultDataset, refreshToken) {
  const JDBCConnectionObject = {
    name: "BigqueryArcgisPlatform_RefreshToken",
    className: "com.esri.sds.bigquery.jdbc.GBQDataSource",
    oAuthType: 2,
    projectId,
    defaultDataset,
    url: "jdbc:bigquery://https://www.googleapis.com/bigquery/v2:443",
    oAuthRefreshToken: refreshToken
  };
  return JDBCConnectionObject;
}
function createBigQueryDataObjectForServiceAuthentication(projectId, keyFileContents) {
  const { type, project_id, private_key_id, private_key, client_email, client_id, auth_uri, token_uri, auth_provider_x509_cert_url, client_x509_cert_url } = keyFileContents;
  const JDBCConnectionObject = {
    oAuthType: 0,
    projectId,
    url: "jdbc:bigquery://https://www.googleapis.com/bigquery/v2:443",
    oAuthPvtKeyFile: {
      type,
      project_id,
      private_key_id,
      private_key,
      client_email,
      client_id,
      auth_uri,
      token_uri,
      auth_provider_x509_cert_url,
      client_x509_cert_url
    }
  };
  return JDBCConnectionObject;
}
function createSnowflakeDataObject(args) {
  const { user, password, database, role, server, warehouse, schema } = args;
  const dataStorePayload = {
    path: "/enterpriseDatabases/snowflakeJdbc",
    type: "egdb",
    info: {
      JDBCConnection: {
        user,
        password,
        database,
        role,
        connectionUrl: `jdbc:snowflake://${server}`,
        warehouse,
        schema
      }
    }
  };
  return dataStorePayload;
}
function createNoSqlDataObject(item, title) {
  if (item.noSqlProvider === "Arango") {
    const data = {
      type: "nosql",
      path: "/nosqlDatabases/Arango_enterprise",
      info: {
        systemManaged: false,
        dsFeature: "graphStore",
        isManagedData: false,
        category: "database",
        factory: "nosql",
        provider: "ArangoDB",
        implementation: "ArangoDB",
        purposes: ["knowledge-graph"],
        connectionProperties: {
          hosts: [],
          useSsl: item.useSsl,
          username: item.username,
          password: item.password,
          database: item.database
        }
      }
    };
    if (item.hosts !== "") {
      data.info.connectionProperties.hosts = item.hosts.split(",");
    }
    else {
      delete data.info.connectionProperties.hosts;
    }
    return data;
  }
  const data = {
    type: "nosql",
    path: `/nosqlDatabases/${title}`,
    info: {
      provider: "Neo4J",
      isManaged: false,
      dsFeature: "graphStore",
      factory: "nosql",
      implementation: "Neo4j",
      category: "database",
      systemManaged: false,
      isManagedData: false,
      purposes: ["knowledge-graph"],
      connectionProperties: {
        connectionUri: item.connectionUri,
        username: item.username,
        password: item.password,
        database: item.database,
        fallbackServerAddresses: []
      }
    }
  };
  if (item.fallBackServers !== "") {
    data.info.connectionProperties.fallbackServerAddresses.push(item.fallBackServers.split(","));
  }
  else {
    delete data.info.connectionProperties.fallbackServerAddresses;
  }
  return data;
}
function createCloudProviderDataObject(item, title) {
  const provider = item.addDataStoreType === "bdfs" ? item.bdfsCloudProvider : item.provider;
  const datastorePayload = {
    info: {}
  };
  const datastoreConnection = {};
  datastoreConnection.credentialType = "accesskey";
  if (provider === "amazon") {
    if (item.credentialType === "accessKey") {
      datastoreConnection.accessKeyId = item.accessKey;
      datastoreConnection.secretAccessKey = item.secretKey;
    }
    else {
      datastoreConnection.credentialType = item.credentialType;
    }
    if (item.selectedRegion.id === "custom") {
      datastoreConnection.regionEndpointUrl = item.storageURL;
    }
    else {
      datastoreConnection.regionEndpointUrl = getRegionEndpointURL(item.regions, item.selectedRegion);
      datastoreConnection.region = item.selectedRegion.id;
    }
    datastorePayload.info.objectStore = item.bucketName;
    datastorePayload.provider = "amazon";
  }
  if (provider === "google") {
    datastoreConnection.accessKeyId = item.accessKey;
    datastoreConnection.secretAccessKey = item.secretKey;
    datastoreConnection.regionEndpointUrl = "https://storage.googleapis.com";
    datastorePayload.info.objectStore = item.bucketName;
    datastorePayload.provider = "Google";
  }
  if (provider === "azure") {
    if (item.azureAuthenticationType === "sharedKey") {
      datastoreConnection.credentialType = "accessKey";
      datastoreConnection.accountKey = item.accountKey;
    }
    else if (item.azureAuthenticationType === "activeDirectory") {
      datastoreConnection.credentialType = item.azureIdentityType;
      if (item.azureIdentityType === "servicePrincipal") {
        datastoreConnection.tenantId = item.tenantId;
        datastoreConnection.clientId = item.clientId;
        datastoreConnection.clientSecret = item.clientSecret;
      }
      else if (item.azureIdentityType === "userAssignedIdentity") {
        datastoreConnection.managedIdentityClientId = item.clientId;
      }
    }
    else if (item.azureAuthenticationType === "sasToken") {
      datastoreConnection.credentialType = item.azureAuthenticationType;
      datastoreConnection.sasToken = item.token;
    }
    else if (item.azureAuthenticationType === "anonymous") {
      datastoreConnection.credentialType = item.azureAuthenticationType;
    }
    if (item.environment.id === "other" || item.azureAuthenticationType === "anonymous") {
      datastoreConnection.regionEndpointURL = item.endpoint;
    }
    else {
      datastoreConnection.accountEndpoint = getRegionEndpointURL(item.regions, item.environment);
    }
    datastoreConnection.accountName = item.accountName;
    datastorePayload.info.objectStore = item.containerName;
    datastorePayload.provider = "azure";
  }
  if (provider === "azuredatalakegen2store") {
    if (item.environment.id === "other") {
      datastoreConnection.regionEndpointURL = item.endpoint;
    }
    else {
      datastoreConnection.accountEndpoint = getRegionEndpointURL(item.regions, item.environment);
    }
    datastoreConnection.credentialType = "accessKey";
    datastoreConnection.accountKey = item.accountKey;
    datastorePayload.info.folder = item.cloudFolder ? `${item.containerName}/${item.cloudFolder}` : item.containerName;
    datastoreConnection.accountName = item.accountName;
    datastorePayload.provider = "azureDataLakeStore";
  }
  if (provider === "alibaba") {
    datastoreConnection.accessKeyId = item.accessKey;
    datastoreConnection.secretAccessKey = item.secretKey;
    datastorePayload.info.objectStore = item.bucketName;
    datastorePayload.provider = "Alibaba";
    datastoreConnection.regionEndpointUrl =
      item.selectedRegion.id === "custom" ? item.storageURL : getRegionEndpointURL(item.regions, item.selectedRegion);
  }
  datastoreConnection.defaultEndpointsProtocol = "https";
  if (item.cloudFolder && provider !== "azuredatalakegen2store") {
    datastorePayload.info.objectStore = datastorePayload.info.objectStore + "/" + item.cloudFolder;
  }
  datastorePayload.type = "cloudStore";
  datastorePayload.path = "/cloudStores/" + title;
  datastorePayload.info.connectionString = JSON.stringify(datastoreConnection);
  return datastorePayload;
}
function createFileShareProviderDataObject(item, title) {
  return {
    type: "bigDataFileShare",
    path: `/bigDataFileShares/${title}`,
    info: {
      connectionString: JSON.stringify({ path: item.bdfsFilesharePath }),
      connectionType: "fileShare"
    }
  };
}
function createHdfsProviderDataObject(item, title) {
  return {
    type: "bigDataFileShare",
    path: `/bigDataFileShares/${title}`,
    info: {
      connectionString: JSON.stringify({ path: item.bdfsHdfsPath, username: item.bdfsHdfsUsername }),
      connectionType: "hdfs"
    }
  };
}
function createHiveProviderDataObject(item, title) {
  const datastorePayload = {
    type: "bigDataFileShare",
    path: "/bigDataFileShares/" + title,
    info: {
      connectionString: "",
      connectionType: "hive"
    }
  };
  const useNonDefaultDatabase = item.useNonDefaultDatabase;
  datastorePayload.info.connectionString = JSON.stringify({
    metaStoreUris: item.metastoreUris,
    database: useNonDefaultDatabase ? item.nonDefaultDatabaseName || "default" : "default"
  });
  return datastorePayload;
}
function getBdfsParameterItem(title, path) {
  return JSON.stringify({
    info: {
      connectionString: JSON.stringify({ path: path }),
      connectionType: "dataStore"
    },
    path: `/bigDataFileShares/${title}`,
    type: "bigDataFileShare"
  });
}
function getRegionEndpointURL(regionOptions, regionValue) {
  let resultRegionURL;
  regionOptions.forEach(function (regionItem) {
    if (regionItem.id === regionValue.id) {
      resultRegionURL = regionItem.blobStoreEndpoint || regionItem.storageEndpointSuffix;
    }
  });
  return resultRegionURL;
}
const getConnectionString = async (jobResults, publishingToolsUrl) => {
  const paramUrl = jobResults.results.out_connectionString.paramUrl;
  const jobId = jobResults.jobId;
  const url = `${publishingToolsUrl}/Get%20Database%20Connection%20String/jobs/${jobId}/${paramUrl}`;
  const response = await (0,_portal_79caaeff_js__WEBPACK_IMPORTED_MODULE_0__.r)(url);
  return processConnectionString(response);
};
const processConnectionString = (result) => {
  const string = result.value;
  const connectionStringProps = parseConnectionString(string);
  return { connectionStringProps: connectionStringProps, connectionString: string };
};
const parseConnectionString = (connectionString) => {
  let connectionStringArray = [];
  if (connectionString) {
    connectionString.split(";").forEach((propString) => {
      const pair = propString.split("=");
      if (pair.length === 2 && !doesKeyExist(connectionStringArray, pair[0])) {
        connectionStringArray.push({ key: pair[0], value: pair[1] });
      }
    });
  }
  return connectionStringArray;
};
const doesKeyExist = (connectionStringArray, key) => {
  return connectionStringArray.some((prop) => {
    return prop.key === key;
  });
};
const isArcGISEnterpriseOnKubernetes = () => {
  const portal = _config_eb5f7dc2_js__WEBPACK_IMPORTED_MODULE_1__.c.portal;
  return portal.isPortal && portal.portalDeploymentType === "ArcGISEnterpriseOnKubernetes";
};
const getPublishingToolsUrl = (hostingServerUrl) => {
  if (!hostingServerUrl) {
    return "";
  }
  const publishingToolsEndpoint = "PublishingTools";
  return `${hostingServerUrl}/rest/services/System/${publishingToolsEndpoint}/GPServer`;
};




/***/ })

}]);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2lkZ2V0cy9jaHVua3MvYXJjZ2lzX2FuYWx5c2lzX25vZGVfbW9kdWxlc19hcmNnaXNfYXBwLWNvbXBvbmVudHNfZGlzdF9lc21fZGF0YS1zLWZkODNiNy5qcyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNvRDtBQUNJOztBQUV4RDtBQUNBO0FBQ0E7QUFDQSx5QkFBeUIsTUFBTTtBQUMvQjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsZ0RBQWdELDRCQUE0QjtBQUM1RTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsZUFBZSxTQUFTO0FBQ3hCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFdBQVc7QUFDWDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsVUFBVSxpSkFBaUo7QUFDM0o7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFVBQVUsNERBQTREO0FBQ3RFO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLDJDQUEyQyxPQUFPO0FBQ2xEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsNkJBQTZCLE1BQU07QUFDbkM7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHlEQUF5RCxtQkFBbUIsR0FBRyxpQkFBaUI7QUFDaEc7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGdDQUFnQyxNQUFNO0FBQ3RDO0FBQ0EseUNBQXlDLDhCQUE4QjtBQUN2RTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGdDQUFnQyxNQUFNO0FBQ3RDO0FBQ0EseUNBQXlDLDBEQUEwRDtBQUNuRztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSx5Q0FBeUMsWUFBWTtBQUNyRDtBQUNBLEtBQUs7QUFDTCxnQ0FBZ0MsTUFBTTtBQUN0QztBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsaUJBQWlCLG1CQUFtQiw2Q0FBNkMsTUFBTSxHQUFHLFNBQVM7QUFDbkcseUJBQXlCLHNEQUFPO0FBQ2hDO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxXQUFXO0FBQ1g7QUFDQTtBQUNBO0FBQ0E7QUFDQSw2QkFBNkI7QUFDN0I7QUFDQTtBQUNBLHFDQUFxQyw4QkFBOEI7QUFDbkU7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQSxpQkFBaUIsa0RBQVc7QUFDNUI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxZQUFZLGlCQUFpQix3QkFBd0Isd0JBQXdCO0FBQzdFOztBQUV5YSIsInNvdXJjZXMiOlsid2VicGFjazovL2V4Yi1jbGllbnQvLi9leHRlbnNpb25zL3dpZGdldHMvYXJjZ2lzL2FuYWx5c2lzL25vZGVfbW9kdWxlcy9AYXJjZ2lzL2FwcC1jb21wb25lbnRzL2Rpc3QvZXNtL2RhdGEtc3RvcmUtZThiNWNlMmYuanMiXSwic291cmNlc0NvbnRlbnQiOlsiLyohXG4gKiBBbGwgbWF0ZXJpYWwgY29weXJpZ2h0IEVTUkksIEFsbCBSaWdodHMgUmVzZXJ2ZWQsIHVubGVzcyBvdGhlcndpc2Ugc3BlY2lmaWVkLlxuICogdjMuMC45OVxuICovXG5pbXBvcnQgeyByIGFzIHJlcXVlc3QgfSBmcm9tICcuL3BvcnRhbC03OWNhYWVmZi5qcyc7XG5pbXBvcnQgeyBjIGFzIGNvbmZpZ1N0YXRlIH0gZnJvbSAnLi9jb25maWctZWI1ZjdkYzIuanMnO1xuXG5mdW5jdGlvbiBjcmVhdGVGb2xkZXJEYXRhT2JqZWN0KGl0ZW0sIHRpdGxlKSB7XG4gIGNvbnN0IGRhdGFzdG9yZVBheWxvYWQgPSB7XG4gICAgdHlwZTogXCJmb2xkZXJcIixcbiAgICBwYXRoOiBgL2ZpbGVTaGFyZXMvJHt0aXRsZX1gLFxuICAgIGluZm86IHtcbiAgICAgIGRhdGFzdG9yZUNvbm5lY3Rpb25UeXBlOiBcInNoYXJlZFwiLFxuICAgICAgcGF0aDogaXRlbS5wdWJsaXNoZXJGb2xkZXJQYXRoLFxuICAgICAgaG9zdE5hbWU6IGl0ZW0ucHVibGlzaGVyRm9sZGVyUGF0aEhvc3RuYW1lXG4gICAgfVxuICB9O1xuICBpZiAoaXRlbS5hbGxvd1NlcnZpY2VzUmVzdGFydCkge1xuICAgIGRhdGFzdG9yZVBheWxvYWQuYWxsb3dTZXJ2aWNlc1Jlc3RhcnQgPSB0cnVlO1xuICAgIGRhdGFzdG9yZVBheWxvYWQub3B0aW9ucyA9IEpTT04uc3RyaW5naWZ5KHsgYWxsb3dTZXJ2aWNlc1Jlc3RhcnQ6IHRydWUgfSk7XG4gIH1cbiAgaWYgKGl0ZW0uc2VydmVyRm9sZGVyUGF0aCA9PT0gXCJuZXdQYXRoXCIpIHtcbiAgICBkYXRhc3RvcmVQYXlsb2FkLmNsaWVudFBhdGggPSBpdGVtLnB1Ymxpc2hlckZvbGRlclBhdGg7XG4gICAgZGF0YXN0b3JlUGF5bG9hZC5pbmZvLnBhdGggPSBpdGVtLm5ld1NlcnZlckZvbGRlclBhdGg7XG4gICAgZGF0YXN0b3JlUGF5bG9hZC5pbmZvLmRhdGFzdG9yZUNvbm5lY3Rpb25UeXBlID0gXCJyZXBsaWNhdGVkXCI7XG4gIH1cbiAgZWxzZSBpZiAoaXRlbS5zZXJ2ZXJGb2xkZXJQYXRoID09PSBcIm5mc0hvc3RBbmRQYXRoXCIpIHtcbiAgICBkYXRhc3RvcmVQYXlsb2FkLmNsaWVudFBhdGggPSBpdGVtLnB1Ymxpc2hlckZvbGRlclBhdGg7XG4gICAgZGF0YXN0b3JlUGF5bG9hZC5wcm92aWRlciA9IFwiVXNlck1hbmFnZWRcIjtcbiAgICBkYXRhc3RvcmVQYXlsb2FkLmluZm8uZGF0YXN0b3JlQ29ubmVjdGlvblR5cGUgPSBcInJlcGxpY2F0ZWRcIjtcbiAgICBkYXRhc3RvcmVQYXlsb2FkLmluZm8uZmlsZVNlcnZlclBhdGggPSBpdGVtLm5mc1NoYXJlUGF0aDtcbiAgICBkYXRhc3RvcmVQYXlsb2FkLmluZm8uZmlsZVNlcnZlckhvc3QgPSBpdGVtLm5mc0hvc3ROYW1lO1xuICAgIGRhdGFzdG9yZVBheWxvYWQuaW5mby5maWxlU2VydmVyVHlwZSA9IFwibmZzXCI7XG4gIH1cbiAgcmV0dXJuIGRhdGFzdG9yZVBheWxvYWQ7XG59XG5mdW5jdGlvbiBjcmVhdGVEYXRhYmFzZURhdGFPYmplY3QoaXRlbSwgdGl0bGUpIHtcbiAgY29uc3QgZGF0YXN0b3JlUGF5bG9hZCA9IHtcbiAgICB0eXBlOiBcImVnZGJcIixcbiAgICBwYXRoOiBcIi9lbnRlcnByaXNlRGF0YWJhc2VzL1wiICsgdGl0bGUsXG4gICAgaW5mbzoge1xuICAgICAgZGF0YVN0b3JlQ29ubmVjdGlvblR5cGU6IFwic2hhcmVkXCJcbiAgICB9XG4gIH07XG4gIGlmIChpdGVtLnNlcnZlckRhdGFiYXNlT3B0aW9uID09PSBcIm5ld0Nvbm5lY3Rpb25cIikge1xuICAgIGRhdGFzdG9yZVBheWxvYWQuaW5mby5jb25uZWN0aW9uU3RyaW5nID0gaXRlbS5zZXJ2ZXJDb25uZWN0aW9uU3RyaW5nO1xuICAgIGRhdGFzdG9yZVBheWxvYWQuaW5mby5jbGllbnRDb25uZWN0aW9uU3RyaW5nID0gaXRlbS5wdWJsaXNoZXJDb25uZWN0aW9uU3RyaW5nO1xuICAgIGRhdGFzdG9yZVBheWxvYWQuaW5mby5kYXRhU3RvcmVDb25uZWN0aW9uVHlwZSA9IFwicmVwbGljYXRlZFwiO1xuICB9XG4gIGVsc2UgaWYgKGl0ZW0uZGF0YWJhc2VQcm92aWRlciA9PT0gXCJiaWdRdWVyeVwiIHx8IGl0ZW0uZGF0YWJhc2VQcm92aWRlciA9PT0gXCJzbm93Zmxha2VcIikge1xuICAgIGRhdGFzdG9yZVBheWxvYWQuaW5mby5KREJDQ29ubmVjdGlvbiA9IGl0ZW0uamRiY0Nvbm5lY3Rpb247XG4gIH1cbiAgZWxzZSB7XG4gICAgZGF0YXN0b3JlUGF5bG9hZC5pbmZvLmNvbm5lY3Rpb25TdHJpbmcgPSBpdGVtLnB1Ymxpc2hlckNvbm5lY3Rpb25TdHJpbmc7XG4gIH1cbiAgcmV0dXJuIGRhdGFzdG9yZVBheWxvYWQ7XG59XG5jb25zdCBjcmVhdGVCaWdRdWVyeURhdGFPYmplY3QgPSBhc3luYyAocHJvamVjdElkLCBkZWZhdWx0RGF0YXNldCwga2V5RmlsZUNvbnRlbnRzLCByZWZyZXNoVG9rZW4pID0+IHtcbiAgbGV0IGpkYmNDb25uZWN0aW9uLCBrZXlGaWxlRm9ybWF0dGVkO1xuICBpZiAoKGtleUZpbGVDb250ZW50cyA9PT0gbnVsbCB8fCBrZXlGaWxlQ29udGVudHMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGtleUZpbGVDb250ZW50cy5sZW5ndGgpID4gMCkge1xuICAgIHRyeSB7XG4gICAgICBrZXlGaWxlRm9ybWF0dGVkID0gSlNPTi5wYXJzZShrZXlGaWxlQ29udGVudHMpO1xuICAgIH1cbiAgICBjYXRjaCAoX2EpIHtcbiAgICAgIHJldHVybiB7IGVycm9yOiB7IGNvZGU6IFwiaW52YWxpZEpTT05cIiB9IH07XG4gICAgfVxuICAgIGpkYmNDb25uZWN0aW9uID0gY3JlYXRlQmlnUXVlcnlEYXRhT2JqZWN0Rm9yU2VydmljZUF1dGhlbnRpY2F0aW9uKHByb2plY3RJZCwga2V5RmlsZUZvcm1hdHRlZCk7XG4gIH1cbiAgZWxzZSBpZiAoKHJlZnJlc2hUb2tlbiA9PT0gbnVsbCB8fCByZWZyZXNoVG9rZW4gPT09IHZvaWQgMCA/IHZvaWQgMCA6IHJlZnJlc2hUb2tlbi5sZW5ndGgpID4gMCkge1xuICAgIGpkYmNDb25uZWN0aW9uID0gY3JlYXRlQmlnUXVlcnlEYXRhT2JqZWN0Rm9yVXNlckF1dGhlbnRpY2F0aW9uKHByb2plY3RJZCwgZGVmYXVsdERhdGFzZXQsIHJlZnJlc2hUb2tlbik7XG4gIH1cbiAgY29uc3QgZGF0YVN0b3JlUGF5bG9hZCA9IHtcbiAgICB0eXBlOiBcImVnZGJcIixcbiAgICBwYXRoOiBcIi9lbnRlcnByaXNlRGF0YWJhc2VzL2JpZ1F1ZXJ5U3ZyRGV2RGF0YUpkYmNcIixcbiAgICBpZDogbnVsbCxcbiAgICBjbGllbnRQYXRoOiBudWxsLFxuICAgIGluZm86IHtcbiAgICAgIEpEQkNDb25uZWN0aW9uOiBqZGJjQ29ubmVjdGlvblxuICAgIH1cbiAgfTtcbiAgcmV0dXJuIHsgcmVzdWx0OiBkYXRhU3RvcmVQYXlsb2FkIH07XG59O1xuZnVuY3Rpb24gY3JlYXRlQmlnUXVlcnlEYXRhT2JqZWN0Rm9yVXNlckF1dGhlbnRpY2F0aW9uKHByb2plY3RJZCwgZGVmYXVsdERhdGFzZXQsIHJlZnJlc2hUb2tlbikge1xuICBjb25zdCBKREJDQ29ubmVjdGlvbk9iamVjdCA9IHtcbiAgICBuYW1lOiBcIkJpZ3F1ZXJ5QXJjZ2lzUGxhdGZvcm1fUmVmcmVzaFRva2VuXCIsXG4gICAgY2xhc3NOYW1lOiBcImNvbS5lc3JpLnNkcy5iaWdxdWVyeS5qZGJjLkdCUURhdGFTb3VyY2VcIixcbiAgICBvQXV0aFR5cGU6IDIsXG4gICAgcHJvamVjdElkLFxuICAgIGRlZmF1bHREYXRhc2V0LFxuICAgIHVybDogXCJqZGJjOmJpZ3F1ZXJ5Oi8vaHR0cHM6Ly93d3cuZ29vZ2xlYXBpcy5jb20vYmlncXVlcnkvdjI6NDQzXCIsXG4gICAgb0F1dGhSZWZyZXNoVG9rZW46IHJlZnJlc2hUb2tlblxuICB9O1xuICByZXR1cm4gSkRCQ0Nvbm5lY3Rpb25PYmplY3Q7XG59XG5mdW5jdGlvbiBjcmVhdGVCaWdRdWVyeURhdGFPYmplY3RGb3JTZXJ2aWNlQXV0aGVudGljYXRpb24ocHJvamVjdElkLCBrZXlGaWxlQ29udGVudHMpIHtcbiAgY29uc3QgeyB0eXBlLCBwcm9qZWN0X2lkLCBwcml2YXRlX2tleV9pZCwgcHJpdmF0ZV9rZXksIGNsaWVudF9lbWFpbCwgY2xpZW50X2lkLCBhdXRoX3VyaSwgdG9rZW5fdXJpLCBhdXRoX3Byb3ZpZGVyX3g1MDlfY2VydF91cmwsIGNsaWVudF94NTA5X2NlcnRfdXJsIH0gPSBrZXlGaWxlQ29udGVudHM7XG4gIGNvbnN0IEpEQkNDb25uZWN0aW9uT2JqZWN0ID0ge1xuICAgIG9BdXRoVHlwZTogMCxcbiAgICBwcm9qZWN0SWQsXG4gICAgdXJsOiBcImpkYmM6YmlncXVlcnk6Ly9odHRwczovL3d3dy5nb29nbGVhcGlzLmNvbS9iaWdxdWVyeS92Mjo0NDNcIixcbiAgICBvQXV0aFB2dEtleUZpbGU6IHtcbiAgICAgIHR5cGUsXG4gICAgICBwcm9qZWN0X2lkLFxuICAgICAgcHJpdmF0ZV9rZXlfaWQsXG4gICAgICBwcml2YXRlX2tleSxcbiAgICAgIGNsaWVudF9lbWFpbCxcbiAgICAgIGNsaWVudF9pZCxcbiAgICAgIGF1dGhfdXJpLFxuICAgICAgdG9rZW5fdXJpLFxuICAgICAgYXV0aF9wcm92aWRlcl94NTA5X2NlcnRfdXJsLFxuICAgICAgY2xpZW50X3g1MDlfY2VydF91cmxcbiAgICB9XG4gIH07XG4gIHJldHVybiBKREJDQ29ubmVjdGlvbk9iamVjdDtcbn1cbmZ1bmN0aW9uIGNyZWF0ZVNub3dmbGFrZURhdGFPYmplY3QoYXJncykge1xuICBjb25zdCB7IHVzZXIsIHBhc3N3b3JkLCBkYXRhYmFzZSwgcm9sZSwgc2VydmVyLCB3YXJlaG91c2UsIHNjaGVtYSB9ID0gYXJncztcbiAgY29uc3QgZGF0YVN0b3JlUGF5bG9hZCA9IHtcbiAgICBwYXRoOiBcIi9lbnRlcnByaXNlRGF0YWJhc2VzL3Nub3dmbGFrZUpkYmNcIixcbiAgICB0eXBlOiBcImVnZGJcIixcbiAgICBpbmZvOiB7XG4gICAgICBKREJDQ29ubmVjdGlvbjoge1xuICAgICAgICB1c2VyLFxuICAgICAgICBwYXNzd29yZCxcbiAgICAgICAgZGF0YWJhc2UsXG4gICAgICAgIHJvbGUsXG4gICAgICAgIGNvbm5lY3Rpb25Vcmw6IGBqZGJjOnNub3dmbGFrZTovLyR7c2VydmVyfWAsXG4gICAgICAgIHdhcmVob3VzZSxcbiAgICAgICAgc2NoZW1hXG4gICAgICB9XG4gICAgfVxuICB9O1xuICByZXR1cm4gZGF0YVN0b3JlUGF5bG9hZDtcbn1cbmZ1bmN0aW9uIGNyZWF0ZU5vU3FsRGF0YU9iamVjdChpdGVtLCB0aXRsZSkge1xuICBpZiAoaXRlbS5ub1NxbFByb3ZpZGVyID09PSBcIkFyYW5nb1wiKSB7XG4gICAgY29uc3QgZGF0YSA9IHtcbiAgICAgIHR5cGU6IFwibm9zcWxcIixcbiAgICAgIHBhdGg6IFwiL25vc3FsRGF0YWJhc2VzL0FyYW5nb19lbnRlcnByaXNlXCIsXG4gICAgICBpbmZvOiB7XG4gICAgICAgIHN5c3RlbU1hbmFnZWQ6IGZhbHNlLFxuICAgICAgICBkc0ZlYXR1cmU6IFwiZ3JhcGhTdG9yZVwiLFxuICAgICAgICBpc01hbmFnZWREYXRhOiBmYWxzZSxcbiAgICAgICAgY2F0ZWdvcnk6IFwiZGF0YWJhc2VcIixcbiAgICAgICAgZmFjdG9yeTogXCJub3NxbFwiLFxuICAgICAgICBwcm92aWRlcjogXCJBcmFuZ29EQlwiLFxuICAgICAgICBpbXBsZW1lbnRhdGlvbjogXCJBcmFuZ29EQlwiLFxuICAgICAgICBwdXJwb3NlczogW1wia25vd2xlZGdlLWdyYXBoXCJdLFxuICAgICAgICBjb25uZWN0aW9uUHJvcGVydGllczoge1xuICAgICAgICAgIGhvc3RzOiBbXSxcbiAgICAgICAgICB1c2VTc2w6IGl0ZW0udXNlU3NsLFxuICAgICAgICAgIHVzZXJuYW1lOiBpdGVtLnVzZXJuYW1lLFxuICAgICAgICAgIHBhc3N3b3JkOiBpdGVtLnBhc3N3b3JkLFxuICAgICAgICAgIGRhdGFiYXNlOiBpdGVtLmRhdGFiYXNlXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9O1xuICAgIGlmIChpdGVtLmhvc3RzICE9PSBcIlwiKSB7XG4gICAgICBkYXRhLmluZm8uY29ubmVjdGlvblByb3BlcnRpZXMuaG9zdHMgPSBpdGVtLmhvc3RzLnNwbGl0KFwiLFwiKTtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICBkZWxldGUgZGF0YS5pbmZvLmNvbm5lY3Rpb25Qcm9wZXJ0aWVzLmhvc3RzO1xuICAgIH1cbiAgICByZXR1cm4gZGF0YTtcbiAgfVxuICBjb25zdCBkYXRhID0ge1xuICAgIHR5cGU6IFwibm9zcWxcIixcbiAgICBwYXRoOiBgL25vc3FsRGF0YWJhc2VzLyR7dGl0bGV9YCxcbiAgICBpbmZvOiB7XG4gICAgICBwcm92aWRlcjogXCJOZW80SlwiLFxuICAgICAgaXNNYW5hZ2VkOiBmYWxzZSxcbiAgICAgIGRzRmVhdHVyZTogXCJncmFwaFN0b3JlXCIsXG4gICAgICBmYWN0b3J5OiBcIm5vc3FsXCIsXG4gICAgICBpbXBsZW1lbnRhdGlvbjogXCJOZW80alwiLFxuICAgICAgY2F0ZWdvcnk6IFwiZGF0YWJhc2VcIixcbiAgICAgIHN5c3RlbU1hbmFnZWQ6IGZhbHNlLFxuICAgICAgaXNNYW5hZ2VkRGF0YTogZmFsc2UsXG4gICAgICBwdXJwb3NlczogW1wia25vd2xlZGdlLWdyYXBoXCJdLFxuICAgICAgY29ubmVjdGlvblByb3BlcnRpZXM6IHtcbiAgICAgICAgY29ubmVjdGlvblVyaTogaXRlbS5jb25uZWN0aW9uVXJpLFxuICAgICAgICB1c2VybmFtZTogaXRlbS51c2VybmFtZSxcbiAgICAgICAgcGFzc3dvcmQ6IGl0ZW0ucGFzc3dvcmQsXG4gICAgICAgIGRhdGFiYXNlOiBpdGVtLmRhdGFiYXNlLFxuICAgICAgICBmYWxsYmFja1NlcnZlckFkZHJlc3NlczogW11cbiAgICAgIH1cbiAgICB9XG4gIH07XG4gIGlmIChpdGVtLmZhbGxCYWNrU2VydmVycyAhPT0gXCJcIikge1xuICAgIGRhdGEuaW5mby5jb25uZWN0aW9uUHJvcGVydGllcy5mYWxsYmFja1NlcnZlckFkZHJlc3Nlcy5wdXNoKGl0ZW0uZmFsbEJhY2tTZXJ2ZXJzLnNwbGl0KFwiLFwiKSk7XG4gIH1cbiAgZWxzZSB7XG4gICAgZGVsZXRlIGRhdGEuaW5mby5jb25uZWN0aW9uUHJvcGVydGllcy5mYWxsYmFja1NlcnZlckFkZHJlc3NlcztcbiAgfVxuICByZXR1cm4gZGF0YTtcbn1cbmZ1bmN0aW9uIGNyZWF0ZUNsb3VkUHJvdmlkZXJEYXRhT2JqZWN0KGl0ZW0sIHRpdGxlKSB7XG4gIGNvbnN0IHByb3ZpZGVyID0gaXRlbS5hZGREYXRhU3RvcmVUeXBlID09PSBcImJkZnNcIiA/IGl0ZW0uYmRmc0Nsb3VkUHJvdmlkZXIgOiBpdGVtLnByb3ZpZGVyO1xuICBjb25zdCBkYXRhc3RvcmVQYXlsb2FkID0ge1xuICAgIGluZm86IHt9XG4gIH07XG4gIGNvbnN0IGRhdGFzdG9yZUNvbm5lY3Rpb24gPSB7fTtcbiAgZGF0YXN0b3JlQ29ubmVjdGlvbi5jcmVkZW50aWFsVHlwZSA9IFwiYWNjZXNza2V5XCI7XG4gIGlmIChwcm92aWRlciA9PT0gXCJhbWF6b25cIikge1xuICAgIGlmIChpdGVtLmNyZWRlbnRpYWxUeXBlID09PSBcImFjY2Vzc0tleVwiKSB7XG4gICAgICBkYXRhc3RvcmVDb25uZWN0aW9uLmFjY2Vzc0tleUlkID0gaXRlbS5hY2Nlc3NLZXk7XG4gICAgICBkYXRhc3RvcmVDb25uZWN0aW9uLnNlY3JldEFjY2Vzc0tleSA9IGl0ZW0uc2VjcmV0S2V5O1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgIGRhdGFzdG9yZUNvbm5lY3Rpb24uY3JlZGVudGlhbFR5cGUgPSBpdGVtLmNyZWRlbnRpYWxUeXBlO1xuICAgIH1cbiAgICBpZiAoaXRlbS5zZWxlY3RlZFJlZ2lvbi5pZCA9PT0gXCJjdXN0b21cIikge1xuICAgICAgZGF0YXN0b3JlQ29ubmVjdGlvbi5yZWdpb25FbmRwb2ludFVybCA9IGl0ZW0uc3RvcmFnZVVSTDtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICBkYXRhc3RvcmVDb25uZWN0aW9uLnJlZ2lvbkVuZHBvaW50VXJsID0gZ2V0UmVnaW9uRW5kcG9pbnRVUkwoaXRlbS5yZWdpb25zLCBpdGVtLnNlbGVjdGVkUmVnaW9uKTtcbiAgICAgIGRhdGFzdG9yZUNvbm5lY3Rpb24ucmVnaW9uID0gaXRlbS5zZWxlY3RlZFJlZ2lvbi5pZDtcbiAgICB9XG4gICAgZGF0YXN0b3JlUGF5bG9hZC5pbmZvLm9iamVjdFN0b3JlID0gaXRlbS5idWNrZXROYW1lO1xuICAgIGRhdGFzdG9yZVBheWxvYWQucHJvdmlkZXIgPSBcImFtYXpvblwiO1xuICB9XG4gIGlmIChwcm92aWRlciA9PT0gXCJnb29nbGVcIikge1xuICAgIGRhdGFzdG9yZUNvbm5lY3Rpb24uYWNjZXNzS2V5SWQgPSBpdGVtLmFjY2Vzc0tleTtcbiAgICBkYXRhc3RvcmVDb25uZWN0aW9uLnNlY3JldEFjY2Vzc0tleSA9IGl0ZW0uc2VjcmV0S2V5O1xuICAgIGRhdGFzdG9yZUNvbm5lY3Rpb24ucmVnaW9uRW5kcG9pbnRVcmwgPSBcImh0dHBzOi8vc3RvcmFnZS5nb29nbGVhcGlzLmNvbVwiO1xuICAgIGRhdGFzdG9yZVBheWxvYWQuaW5mby5vYmplY3RTdG9yZSA9IGl0ZW0uYnVja2V0TmFtZTtcbiAgICBkYXRhc3RvcmVQYXlsb2FkLnByb3ZpZGVyID0gXCJHb29nbGVcIjtcbiAgfVxuICBpZiAocHJvdmlkZXIgPT09IFwiYXp1cmVcIikge1xuICAgIGlmIChpdGVtLmF6dXJlQXV0aGVudGljYXRpb25UeXBlID09PSBcInNoYXJlZEtleVwiKSB7XG4gICAgICBkYXRhc3RvcmVDb25uZWN0aW9uLmNyZWRlbnRpYWxUeXBlID0gXCJhY2Nlc3NLZXlcIjtcbiAgICAgIGRhdGFzdG9yZUNvbm5lY3Rpb24uYWNjb3VudEtleSA9IGl0ZW0uYWNjb3VudEtleTtcbiAgICB9XG4gICAgZWxzZSBpZiAoaXRlbS5henVyZUF1dGhlbnRpY2F0aW9uVHlwZSA9PT0gXCJhY3RpdmVEaXJlY3RvcnlcIikge1xuICAgICAgZGF0YXN0b3JlQ29ubmVjdGlvbi5jcmVkZW50aWFsVHlwZSA9IGl0ZW0uYXp1cmVJZGVudGl0eVR5cGU7XG4gICAgICBpZiAoaXRlbS5henVyZUlkZW50aXR5VHlwZSA9PT0gXCJzZXJ2aWNlUHJpbmNpcGFsXCIpIHtcbiAgICAgICAgZGF0YXN0b3JlQ29ubmVjdGlvbi50ZW5hbnRJZCA9IGl0ZW0udGVuYW50SWQ7XG4gICAgICAgIGRhdGFzdG9yZUNvbm5lY3Rpb24uY2xpZW50SWQgPSBpdGVtLmNsaWVudElkO1xuICAgICAgICBkYXRhc3RvcmVDb25uZWN0aW9uLmNsaWVudFNlY3JldCA9IGl0ZW0uY2xpZW50U2VjcmV0O1xuICAgICAgfVxuICAgICAgZWxzZSBpZiAoaXRlbS5henVyZUlkZW50aXR5VHlwZSA9PT0gXCJ1c2VyQXNzaWduZWRJZGVudGl0eVwiKSB7XG4gICAgICAgIGRhdGFzdG9yZUNvbm5lY3Rpb24ubWFuYWdlZElkZW50aXR5Q2xpZW50SWQgPSBpdGVtLmNsaWVudElkO1xuICAgICAgfVxuICAgIH1cbiAgICBlbHNlIGlmIChpdGVtLmF6dXJlQXV0aGVudGljYXRpb25UeXBlID09PSBcInNhc1Rva2VuXCIpIHtcbiAgICAgIGRhdGFzdG9yZUNvbm5lY3Rpb24uY3JlZGVudGlhbFR5cGUgPSBpdGVtLmF6dXJlQXV0aGVudGljYXRpb25UeXBlO1xuICAgICAgZGF0YXN0b3JlQ29ubmVjdGlvbi5zYXNUb2tlbiA9IGl0ZW0udG9rZW47XG4gICAgfVxuICAgIGVsc2UgaWYgKGl0ZW0uYXp1cmVBdXRoZW50aWNhdGlvblR5cGUgPT09IFwiYW5vbnltb3VzXCIpIHtcbiAgICAgIGRhdGFzdG9yZUNvbm5lY3Rpb24uY3JlZGVudGlhbFR5cGUgPSBpdGVtLmF6dXJlQXV0aGVudGljYXRpb25UeXBlO1xuICAgIH1cbiAgICBpZiAoaXRlbS5lbnZpcm9ubWVudC5pZCA9PT0gXCJvdGhlclwiIHx8IGl0ZW0uYXp1cmVBdXRoZW50aWNhdGlvblR5cGUgPT09IFwiYW5vbnltb3VzXCIpIHtcbiAgICAgIGRhdGFzdG9yZUNvbm5lY3Rpb24ucmVnaW9uRW5kcG9pbnRVUkwgPSBpdGVtLmVuZHBvaW50O1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgIGRhdGFzdG9yZUNvbm5lY3Rpb24uYWNjb3VudEVuZHBvaW50ID0gZ2V0UmVnaW9uRW5kcG9pbnRVUkwoaXRlbS5yZWdpb25zLCBpdGVtLmVudmlyb25tZW50KTtcbiAgICB9XG4gICAgZGF0YXN0b3JlQ29ubmVjdGlvbi5hY2NvdW50TmFtZSA9IGl0ZW0uYWNjb3VudE5hbWU7XG4gICAgZGF0YXN0b3JlUGF5bG9hZC5pbmZvLm9iamVjdFN0b3JlID0gaXRlbS5jb250YWluZXJOYW1lO1xuICAgIGRhdGFzdG9yZVBheWxvYWQucHJvdmlkZXIgPSBcImF6dXJlXCI7XG4gIH1cbiAgaWYgKHByb3ZpZGVyID09PSBcImF6dXJlZGF0YWxha2VnZW4yc3RvcmVcIikge1xuICAgIGlmIChpdGVtLmVudmlyb25tZW50LmlkID09PSBcIm90aGVyXCIpIHtcbiAgICAgIGRhdGFzdG9yZUNvbm5lY3Rpb24ucmVnaW9uRW5kcG9pbnRVUkwgPSBpdGVtLmVuZHBvaW50O1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgIGRhdGFzdG9yZUNvbm5lY3Rpb24uYWNjb3VudEVuZHBvaW50ID0gZ2V0UmVnaW9uRW5kcG9pbnRVUkwoaXRlbS5yZWdpb25zLCBpdGVtLmVudmlyb25tZW50KTtcbiAgICB9XG4gICAgZGF0YXN0b3JlQ29ubmVjdGlvbi5jcmVkZW50aWFsVHlwZSA9IFwiYWNjZXNzS2V5XCI7XG4gICAgZGF0YXN0b3JlQ29ubmVjdGlvbi5hY2NvdW50S2V5ID0gaXRlbS5hY2NvdW50S2V5O1xuICAgIGRhdGFzdG9yZVBheWxvYWQuaW5mby5mb2xkZXIgPSBpdGVtLmNsb3VkRm9sZGVyID8gYCR7aXRlbS5jb250YWluZXJOYW1lfS8ke2l0ZW0uY2xvdWRGb2xkZXJ9YCA6IGl0ZW0uY29udGFpbmVyTmFtZTtcbiAgICBkYXRhc3RvcmVDb25uZWN0aW9uLmFjY291bnROYW1lID0gaXRlbS5hY2NvdW50TmFtZTtcbiAgICBkYXRhc3RvcmVQYXlsb2FkLnByb3ZpZGVyID0gXCJhenVyZURhdGFMYWtlU3RvcmVcIjtcbiAgfVxuICBpZiAocHJvdmlkZXIgPT09IFwiYWxpYmFiYVwiKSB7XG4gICAgZGF0YXN0b3JlQ29ubmVjdGlvbi5hY2Nlc3NLZXlJZCA9IGl0ZW0uYWNjZXNzS2V5O1xuICAgIGRhdGFzdG9yZUNvbm5lY3Rpb24uc2VjcmV0QWNjZXNzS2V5ID0gaXRlbS5zZWNyZXRLZXk7XG4gICAgZGF0YXN0b3JlUGF5bG9hZC5pbmZvLm9iamVjdFN0b3JlID0gaXRlbS5idWNrZXROYW1lO1xuICAgIGRhdGFzdG9yZVBheWxvYWQucHJvdmlkZXIgPSBcIkFsaWJhYmFcIjtcbiAgICBkYXRhc3RvcmVDb25uZWN0aW9uLnJlZ2lvbkVuZHBvaW50VXJsID1cbiAgICAgIGl0ZW0uc2VsZWN0ZWRSZWdpb24uaWQgPT09IFwiY3VzdG9tXCIgPyBpdGVtLnN0b3JhZ2VVUkwgOiBnZXRSZWdpb25FbmRwb2ludFVSTChpdGVtLnJlZ2lvbnMsIGl0ZW0uc2VsZWN0ZWRSZWdpb24pO1xuICB9XG4gIGRhdGFzdG9yZUNvbm5lY3Rpb24uZGVmYXVsdEVuZHBvaW50c1Byb3RvY29sID0gXCJodHRwc1wiO1xuICBpZiAoaXRlbS5jbG91ZEZvbGRlciAmJiBwcm92aWRlciAhPT0gXCJhenVyZWRhdGFsYWtlZ2VuMnN0b3JlXCIpIHtcbiAgICBkYXRhc3RvcmVQYXlsb2FkLmluZm8ub2JqZWN0U3RvcmUgPSBkYXRhc3RvcmVQYXlsb2FkLmluZm8ub2JqZWN0U3RvcmUgKyBcIi9cIiArIGl0ZW0uY2xvdWRGb2xkZXI7XG4gIH1cbiAgZGF0YXN0b3JlUGF5bG9hZC50eXBlID0gXCJjbG91ZFN0b3JlXCI7XG4gIGRhdGFzdG9yZVBheWxvYWQucGF0aCA9IFwiL2Nsb3VkU3RvcmVzL1wiICsgdGl0bGU7XG4gIGRhdGFzdG9yZVBheWxvYWQuaW5mby5jb25uZWN0aW9uU3RyaW5nID0gSlNPTi5zdHJpbmdpZnkoZGF0YXN0b3JlQ29ubmVjdGlvbik7XG4gIHJldHVybiBkYXRhc3RvcmVQYXlsb2FkO1xufVxuZnVuY3Rpb24gY3JlYXRlRmlsZVNoYXJlUHJvdmlkZXJEYXRhT2JqZWN0KGl0ZW0sIHRpdGxlKSB7XG4gIHJldHVybiB7XG4gICAgdHlwZTogXCJiaWdEYXRhRmlsZVNoYXJlXCIsXG4gICAgcGF0aDogYC9iaWdEYXRhRmlsZVNoYXJlcy8ke3RpdGxlfWAsXG4gICAgaW5mbzoge1xuICAgICAgY29ubmVjdGlvblN0cmluZzogSlNPTi5zdHJpbmdpZnkoeyBwYXRoOiBpdGVtLmJkZnNGaWxlc2hhcmVQYXRoIH0pLFxuICAgICAgY29ubmVjdGlvblR5cGU6IFwiZmlsZVNoYXJlXCJcbiAgICB9XG4gIH07XG59XG5mdW5jdGlvbiBjcmVhdGVIZGZzUHJvdmlkZXJEYXRhT2JqZWN0KGl0ZW0sIHRpdGxlKSB7XG4gIHJldHVybiB7XG4gICAgdHlwZTogXCJiaWdEYXRhRmlsZVNoYXJlXCIsXG4gICAgcGF0aDogYC9iaWdEYXRhRmlsZVNoYXJlcy8ke3RpdGxlfWAsXG4gICAgaW5mbzoge1xuICAgICAgY29ubmVjdGlvblN0cmluZzogSlNPTi5zdHJpbmdpZnkoeyBwYXRoOiBpdGVtLmJkZnNIZGZzUGF0aCwgdXNlcm5hbWU6IGl0ZW0uYmRmc0hkZnNVc2VybmFtZSB9KSxcbiAgICAgIGNvbm5lY3Rpb25UeXBlOiBcImhkZnNcIlxuICAgIH1cbiAgfTtcbn1cbmZ1bmN0aW9uIGNyZWF0ZUhpdmVQcm92aWRlckRhdGFPYmplY3QoaXRlbSwgdGl0bGUpIHtcbiAgY29uc3QgZGF0YXN0b3JlUGF5bG9hZCA9IHtcbiAgICB0eXBlOiBcImJpZ0RhdGFGaWxlU2hhcmVcIixcbiAgICBwYXRoOiBcIi9iaWdEYXRhRmlsZVNoYXJlcy9cIiArIHRpdGxlLFxuICAgIGluZm86IHtcbiAgICAgIGNvbm5lY3Rpb25TdHJpbmc6IFwiXCIsXG4gICAgICBjb25uZWN0aW9uVHlwZTogXCJoaXZlXCJcbiAgICB9XG4gIH07XG4gIGNvbnN0IHVzZU5vbkRlZmF1bHREYXRhYmFzZSA9IGl0ZW0udXNlTm9uRGVmYXVsdERhdGFiYXNlO1xuICBkYXRhc3RvcmVQYXlsb2FkLmluZm8uY29ubmVjdGlvblN0cmluZyA9IEpTT04uc3RyaW5naWZ5KHtcbiAgICBtZXRhU3RvcmVVcmlzOiBpdGVtLm1ldGFzdG9yZVVyaXMsXG4gICAgZGF0YWJhc2U6IHVzZU5vbkRlZmF1bHREYXRhYmFzZSA/IGl0ZW0ubm9uRGVmYXVsdERhdGFiYXNlTmFtZSB8fCBcImRlZmF1bHRcIiA6IFwiZGVmYXVsdFwiXG4gIH0pO1xuICByZXR1cm4gZGF0YXN0b3JlUGF5bG9hZDtcbn1cbmZ1bmN0aW9uIGdldEJkZnNQYXJhbWV0ZXJJdGVtKHRpdGxlLCBwYXRoKSB7XG4gIHJldHVybiBKU09OLnN0cmluZ2lmeSh7XG4gICAgaW5mbzoge1xuICAgICAgY29ubmVjdGlvblN0cmluZzogSlNPTi5zdHJpbmdpZnkoeyBwYXRoOiBwYXRoIH0pLFxuICAgICAgY29ubmVjdGlvblR5cGU6IFwiZGF0YVN0b3JlXCJcbiAgICB9LFxuICAgIHBhdGg6IGAvYmlnRGF0YUZpbGVTaGFyZXMvJHt0aXRsZX1gLFxuICAgIHR5cGU6IFwiYmlnRGF0YUZpbGVTaGFyZVwiXG4gIH0pO1xufVxuZnVuY3Rpb24gZ2V0UmVnaW9uRW5kcG9pbnRVUkwocmVnaW9uT3B0aW9ucywgcmVnaW9uVmFsdWUpIHtcbiAgbGV0IHJlc3VsdFJlZ2lvblVSTDtcbiAgcmVnaW9uT3B0aW9ucy5mb3JFYWNoKGZ1bmN0aW9uIChyZWdpb25JdGVtKSB7XG4gICAgaWYgKHJlZ2lvbkl0ZW0uaWQgPT09IHJlZ2lvblZhbHVlLmlkKSB7XG4gICAgICByZXN1bHRSZWdpb25VUkwgPSByZWdpb25JdGVtLmJsb2JTdG9yZUVuZHBvaW50IHx8IHJlZ2lvbkl0ZW0uc3RvcmFnZUVuZHBvaW50U3VmZml4O1xuICAgIH1cbiAgfSk7XG4gIHJldHVybiByZXN1bHRSZWdpb25VUkw7XG59XG5jb25zdCBnZXRDb25uZWN0aW9uU3RyaW5nID0gYXN5bmMgKGpvYlJlc3VsdHMsIHB1Ymxpc2hpbmdUb29sc1VybCkgPT4ge1xuICBjb25zdCBwYXJhbVVybCA9IGpvYlJlc3VsdHMucmVzdWx0cy5vdXRfY29ubmVjdGlvblN0cmluZy5wYXJhbVVybDtcbiAgY29uc3Qgam9iSWQgPSBqb2JSZXN1bHRzLmpvYklkO1xuICBjb25zdCB1cmwgPSBgJHtwdWJsaXNoaW5nVG9vbHNVcmx9L0dldCUyMERhdGFiYXNlJTIwQ29ubmVjdGlvbiUyMFN0cmluZy9qb2JzLyR7am9iSWR9LyR7cGFyYW1Vcmx9YDtcbiAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCByZXF1ZXN0KHVybCk7XG4gIHJldHVybiBwcm9jZXNzQ29ubmVjdGlvblN0cmluZyhyZXNwb25zZSk7XG59O1xuY29uc3QgcHJvY2Vzc0Nvbm5lY3Rpb25TdHJpbmcgPSAocmVzdWx0KSA9PiB7XG4gIGNvbnN0IHN0cmluZyA9IHJlc3VsdC52YWx1ZTtcbiAgY29uc3QgY29ubmVjdGlvblN0cmluZ1Byb3BzID0gcGFyc2VDb25uZWN0aW9uU3RyaW5nKHN0cmluZyk7XG4gIHJldHVybiB7IGNvbm5lY3Rpb25TdHJpbmdQcm9wczogY29ubmVjdGlvblN0cmluZ1Byb3BzLCBjb25uZWN0aW9uU3RyaW5nOiBzdHJpbmcgfTtcbn07XG5jb25zdCBwYXJzZUNvbm5lY3Rpb25TdHJpbmcgPSAoY29ubmVjdGlvblN0cmluZykgPT4ge1xuICBsZXQgY29ubmVjdGlvblN0cmluZ0FycmF5ID0gW107XG4gIGlmIChjb25uZWN0aW9uU3RyaW5nKSB7XG4gICAgY29ubmVjdGlvblN0cmluZy5zcGxpdChcIjtcIikuZm9yRWFjaCgocHJvcFN0cmluZykgPT4ge1xuICAgICAgY29uc3QgcGFpciA9IHByb3BTdHJpbmcuc3BsaXQoXCI9XCIpO1xuICAgICAgaWYgKHBhaXIubGVuZ3RoID09PSAyICYmICFkb2VzS2V5RXhpc3QoY29ubmVjdGlvblN0cmluZ0FycmF5LCBwYWlyWzBdKSkge1xuICAgICAgICBjb25uZWN0aW9uU3RyaW5nQXJyYXkucHVzaCh7IGtleTogcGFpclswXSwgdmFsdWU6IHBhaXJbMV0gfSk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cbiAgcmV0dXJuIGNvbm5lY3Rpb25TdHJpbmdBcnJheTtcbn07XG5jb25zdCBkb2VzS2V5RXhpc3QgPSAoY29ubmVjdGlvblN0cmluZ0FycmF5LCBrZXkpID0+IHtcbiAgcmV0dXJuIGNvbm5lY3Rpb25TdHJpbmdBcnJheS5zb21lKChwcm9wKSA9PiB7XG4gICAgcmV0dXJuIHByb3Aua2V5ID09PSBrZXk7XG4gIH0pO1xufTtcbmNvbnN0IGlzQXJjR0lTRW50ZXJwcmlzZU9uS3ViZXJuZXRlcyA9ICgpID0+IHtcbiAgY29uc3QgcG9ydGFsID0gY29uZmlnU3RhdGUucG9ydGFsO1xuICByZXR1cm4gcG9ydGFsLmlzUG9ydGFsICYmIHBvcnRhbC5wb3J0YWxEZXBsb3ltZW50VHlwZSA9PT0gXCJBcmNHSVNFbnRlcnByaXNlT25LdWJlcm5ldGVzXCI7XG59O1xuY29uc3QgZ2V0UHVibGlzaGluZ1Rvb2xzVXJsID0gKGhvc3RpbmdTZXJ2ZXJVcmwpID0+IHtcbiAgaWYgKCFob3N0aW5nU2VydmVyVXJsKSB7XG4gICAgcmV0dXJuIFwiXCI7XG4gIH1cbiAgY29uc3QgcHVibGlzaGluZ1Rvb2xzRW5kcG9pbnQgPSBcIlB1Ymxpc2hpbmdUb29sc1wiO1xuICByZXR1cm4gYCR7aG9zdGluZ1NlcnZlclVybH0vcmVzdC9zZXJ2aWNlcy9TeXN0ZW0vJHtwdWJsaXNoaW5nVG9vbHNFbmRwb2ludH0vR1BTZXJ2ZXJgO1xufTtcblxuZXhwb3J0IHsgY3JlYXRlSGRmc1Byb3ZpZGVyRGF0YU9iamVjdCBhcyBhLCBjcmVhdGVIaXZlUHJvdmlkZXJEYXRhT2JqZWN0IGFzIGIsIGNyZWF0ZUZpbGVTaGFyZVByb3ZpZGVyRGF0YU9iamVjdCBhcyBjLCBjcmVhdGVDbG91ZFByb3ZpZGVyRGF0YU9iamVjdCBhcyBkLCBjcmVhdGVGb2xkZXJEYXRhT2JqZWN0IGFzIGUsIGNyZWF0ZURhdGFiYXNlRGF0YU9iamVjdCBhcyBmLCBnZXRDb25uZWN0aW9uU3RyaW5nIGFzIGcsIGNyZWF0ZU5vU3FsRGF0YU9iamVjdCBhcyBoLCBpc0FyY0dJU0VudGVycHJpc2VPbkt1YmVybmV0ZXMgYXMgaSwgZ2V0QmRmc1BhcmFtZXRlckl0ZW0gYXMgaiwgZ2V0UHVibGlzaGluZ1Rvb2xzVXJsIGFzIGssIGNyZWF0ZUJpZ1F1ZXJ5RGF0YU9iamVjdCBhcyBsLCBjcmVhdGVTbm93Zmxha2VEYXRhT2JqZWN0IGFzIG0gfTtcbiJdLCJuYW1lcyI6W10sInNvdXJjZVJvb3QiOiIifQ==
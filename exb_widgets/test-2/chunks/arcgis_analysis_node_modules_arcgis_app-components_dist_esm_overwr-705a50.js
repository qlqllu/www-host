"use strict";
(self["webpackChunkexb_client"] = self["webpackChunkexb_client"] || []).push([["vendors-extensions_widgets_arcgis_analysis_node_modules_arcgis_app-components_dist_esm_overwr-705a50"],{

/***/ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/overwrite-3049b7af.js":
/*!***************************************************************************************************************!*\
  !*** ./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/overwrite-3049b7af.js ***!
  \***************************************************************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   a: () => (/* binding */ getPublishParameters),
/* harmony export */   b: () => (/* binding */ updateItemOverwrite),
/* harmony export */   c: () => (/* binding */ updateItemResource),
/* harmony export */   f: () => (/* binding */ fetchAndUpdateItem),
/* harmony export */   g: () => (/* binding */ getTokenFromProvider),
/* harmony export */   p: () => (/* binding */ publishForOverwrite),
/* harmony export */   r: () => (/* binding */ resetServiceTitle),
/* harmony export */   u: () => (/* binding */ updateTypeKeywords)
/* harmony export */ });
/* harmony import */ var _feature_layer_38cdae87_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./feature-layer-38cdae87.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/feature-layer-38cdae87.js");
/* harmony import */ var _publish_item_82ffa7f8_js__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./publish-item-82ffa7f8.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/publish-item-82ffa7f8.js");
/* harmony import */ var _server_item_f12153e6_js__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./server-item-f12153e6.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/server-item-f12153e6.js");
/* harmony import */ var _append_58a7e7ab_js__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ./append-58a7e7ab.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/append-58a7e7ab.js");
/* harmony import */ var _portal_79caaeff_js__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ./portal-79caaeff.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/portal-79caaeff.js");
/*!
 * All material copyright ESRI, All Rights Reserved, unless otherwise specified.
 * v3.0.99
 */






const getFormParameters = (item) => {
  const { name, title, tags, type, typeKeywords, accessInformation, licenseInfo, description, snippet, extent } = item;
  return {
    name,
    title,
    tags,
    type,
    typeKeywords,
    accessInformation,
    licenseInfo,
    description,
    snippet,
    extent
  };
};
const getFormData = (item, addItemProps) => {
  //for parameters of updating source data of feature layer.
  const overwriteOn = !!addItemProps.overwrite;
  const formProperties = getFormParameters(item);
  const formData = new FormData();
  Object.keys(formProperties).forEach((property) => {
    var _a;
    if (property === "description" || property === "snippet" || property === "extent") {
      formData.append(property, addItemProps.keepDescription ? formProperties[property] : "");
    }
    else {
      formData.append(property, (_a = formProperties[property]) !== null && _a !== void 0 ? _a : "");
    }
  });
  formData.set("overwrite", "true");
  formData.set("async", "true");
  formData.set("file", addItemProps.file, item.title);
  if (overwriteOn) {
    formData.set("overwriteService", "on");
  }
  formData.set("useDescription", "on");
  return formData;
};
const createOverwritePublishParameters = (serviceInfo, item, newItemId) => {
  var _a, _b, _c, _d, _e;
  const itemPublishParameters = item === null || item === void 0 ? void 0 : item.publishParameters;
  const itemData = (_a = item === null || item === void 0 ? void 0 : item.sourceData) !== null && _a !== void 0 ? _a : item;
  const type = (_c = (_b = item === null || item === void 0 ? void 0 : item.sourceData) === null || _b === void 0 ? void 0 : _b.type) !== null && _c !== void 0 ? _c : _append_58a7e7ab_js__WEBPACK_IMPORTED_MODULE_3__.A[(_d = item === null || item === void 0 ? void 0 : item.cloudProviderInfo) === null || _d === void 0 ? void 0 : _d.mimeType];
  const finalOverwriteParameters = {
    itemId: newItemId !== null && newItemId !== void 0 ? newItemId : itemData.id,
    filetype: _append_58a7e7ab_js__WEBPACK_IMPORTED_MODULE_3__.b[type.toLowerCase()],
    overwrite: true,
    deleteSourceItemUponCompletion: !!newItemId
  };
  let publishParameters;
  switch (type) {
    case "CSV": {
      const layerInfo = Object.assign(Object.assign({}, (_e = serviceInfo.layers) === null || _e === void 0 ? void 0 : _e[0]), { fields: itemPublishParameters.layerInfo.fields });
      publishParameters = Object.assign(Object.assign({ layerInfo, name: itemPublishParameters.name || itemData.title.replace(/ /g, "_") }, itemPublishParameters), serviceInfo);
      break;
    }
    case "Microsoft Excel": {
      publishParameters = generateExcelOverwritePublishParameters(itemPublishParameters, serviceInfo);
      break;
    }
    default:
      publishParameters = Object.assign(Object.assign(Object.assign({}, itemPublishParameters), serviceInfo), { name: itemData.title ? itemData.title.replace(/ /g, "_") : item.title.replace(/ /g, "_") });
      break;
  }
  finalOverwriteParameters.publishParameters = JSON.stringify(publishParameters);
  return finalOverwriteParameters;
};
const generateExcelOverwritePublishParameters = (publishParameters, serviceInfo) => {
  const finalOverwriteParameters = Object.assign({}, serviceInfo);
  //service level properties
  finalOverwriteParameters.name = publishParameters.name;
  finalOverwriteParameters.sourceSR = publishParameters.sourceSR;
  finalOverwriteParameters.targetSR = publishParameters.targetSR;
  //table is not valid in excel publish parameters, so copy to layer
  for (let i = 0; i < finalOverwriteParameters.tables.length; i++) {
    //if excel has Review Table, ignore it
    if (finalOverwriteParameters.tables[i].name != "Review") {
      finalOverwriteParameters.layers[finalOverwriteParameters.layers.length] = finalOverwriteParameters.tables[i];
    }
  }
  for (let layer of finalOverwriteParameters.layers) {
    const { excelSheetId, locationType, latitudeFieldName, longitudeFieldName, geocodeServiceUrl, sourceLocale, sourceCountry, standardizedFieldNames, addressFields, coordinateFieldName, coordinateFieldType, fields, dateFieldsTimeReference } = publishParameters.layers[layer.id];
    const propertiesToUpdate = {
      excelSheetId,
      locationType,
      latitudeFieldName,
      longitudeFieldName,
      geocodeServiceUrl,
      sourceLocale,
      sourceCountry,
      standardizedFieldNames,
      addressFields,
      coordinateFieldName,
      coordinateFieldType,
      fields,
      dateFieldsTimeReference
    };
    finalOverwriteParameters.layers[layer.id] = Object.assign({}, propertiesToUpdate);
  }
  return finalOverwriteParameters;
};

const publishForOverwrite = async (item, title, portal, user) => {
  var _a, _b;
  const params = await getPublishParameters(item, portal, user);
  const publishResponse = await (0,_publish_item_82ffa7f8_js__WEBPACK_IMPORTED_MODULE_1__.p)({ itemId: item.sourceData.id, user, title, itemOwnerUrl: item.itemOwner.userContentUrl }, // ! Use fetchUser if itemOwner is not available
  params);
  const service = (_b = (_a = publishResponse.result) === null || _a === void 0 ? void 0 : _a.services) === null || _b === void 0 ? void 0 : _b[0];
  return {
    id: service === null || service === void 0 ? void 0 : service.serviceItemId,
    jobId: service === null || service === void 0 ? void 0 : service.jobId,
    serviceType: service === null || service === void 0 ? void 0 : service.type,
    serviceUrl: service === null || service === void 0 ? void 0 : service.serviceurl,
    overwriteStatus: ""
  };
};
const getPublishParameters = async (item, portal, user, newItemId) => {
  const { result: serviceInfo } = await fetchFeatureServiceInfoForOverwrite(item, portal, false, user);
  return await createOverwritePublishParameters(serviceInfo, item, newItemId);
};
const fetchAndUpdateItem = async (item, userContentUrl, addItemProps) => {
  const sourceData = item.sourceData;
  try {
    await updateItemOverwrite(sourceData, userContentUrl, {
      file: addItemProps.file,
      overwrite: addItemProps.overwrite,
      keepDescription: addItemProps.keepDescription
    });
    await (0,_publish_item_82ffa7f8_js__WEBPACK_IMPORTED_MODULE_1__.c)({ id: sourceData.id, folder: "", success: true });
    return {};
  }
  catch (error) {
    console.error(error);
    return { error: { code: "unhandledError" } };
  }
};
const updateItemOverwrite = async (item, userContentUrl, addItemProps) => {
  const url = `${userContentUrl}/items/${item.id}/update`;
  const formData = getFormData(item, {
    file: addItemProps.file,
    overwrite: addItemProps.overwrite,
    keepDescription: addItemProps.keepDescription
  });
  return await (0,_portal_79caaeff_js__WEBPACK_IMPORTED_MODULE_4__.e)(url, formData, {}, "post");
};
const fetchFeatureServiceInfoForOverwrite = async (item, portal, isSecure, user) => {
  try {
    const { url } = item;
    const serviceInfo = await (0,_portal_79caaeff_js__WEBPACK_IMPORTED_MODULE_4__.r)(url);
    const serviceLayerInfo = await (0,_portal_79caaeff_js__WEBPACK_IMPORTED_MODULE_4__.r)(url + "/layers");
    const formattedLayers = serviceLayerInfo === null || serviceLayerInfo === void 0 ? void 0 : serviceLayerInfo.layers.map((layer) => {
      delete layer.fields;
      return layer;
    });
    serviceInfo.tables = [...serviceLayerInfo === null || serviceLayerInfo === void 0 ? void 0 : serviceLayerInfo.tables];
    serviceInfo.layers = [...formattedLayers];
    return { result: serviceInfo };
  }
  catch (error) {
    if (!isSecure && (((error === null || error === void 0 ? void 0 : error.code) === 499 && (error === null || error === void 0 ? void 0 : error.message) === "Token Required") || error.code === 403) && user) {
      return fetchFeatureServiceInfoForOverwrite(item, portal, true, user);
    }
    console.error(error);
    return { error: { code: "unhandledError" } };
  }
};
const resetServiceTitle = async (item) => {
  let keywords = item.typeKeywords.toString();
  const updateContent = {
    title: item.title || "",
    tags: item.tags.toString() || ""
  };
  if (item.typeKeywords.indexOf("Involved Lookup") !== -1) {
    keywords += ",showUnmatchedAddresses";
    updateContent["typeKeywords"] = keywords;
  }
  try {
    const response = await (0,_server_item_f12153e6_js__WEBPACK_IMPORTED_MODULE_2__.e)(item.id, updateContent);
    const jobStatus = await (0,_feature_layer_38cdae87_js__WEBPACK_IMPORTED_MODULE_0__.w)(item.id, { success: response === null || response === void 0 ? void 0 : response.success });
    if (jobStatus.status === "failed") {
      return { error: { code: "unhandledError" } };
    }
    return { result: jobStatus };
  }
  catch (error) {
    console.error("error:", error);
    return { error: { code: "unhandledError" } };
  }
};
//for vector tile service case
const updateItemResource = async (item, userContentUrl, addItemProps) => {
  const folderId = item.folderId || item.ownerFolder;
  const url = `${userContentUrl}/${folderId ? folderId : ""}/items/${item.id}/updateResources`;
  const formData = new FormData();
  formData.set("file", addItemProps.file);
  formData.set("resourcesPrefix", "styles");
  formData.set("filename", "root.json");
  try {
    const response = await (0,_portal_79caaeff_js__WEBPACK_IMPORTED_MODULE_4__.e)(url, formData, {}, "post");
    return { result: response };
  }
  catch (error) {
    console.error(error);
    return { error: { code: "unhandledError" } };
  }
};
const updateTypeKeywords = async (publishParametersJSON, item, serviceItemId) => {
  let typeKeywords = ["Cloud Drive"];
  const publishParameters = JSON.parse(publishParametersJSON);
  if (publishParameters.locationType === "address" ||
    (publishParameters.layers[0] && publishParameters.layers[0].locationType === "address")) {
    typeKeywords.push("showUnmatchedAddresses");
    typeKeywords.push("Involved Lookup");
  }
  else if (publishParameters.locationType === "none" ||
    (publishParameters.layers[0] && publishParameters.layers[0].locationType === "none")) {
    typeKeywords.push("Table");
  }
  const finalTypeKeywords = typeKeywords.join(",");
  return await (0,_server_item_f12153e6_js__WEBPACK_IMPORTED_MODULE_2__.e)(item.id, {
    folderId: item === null || item === void 0 ? void 0 : item.folderId,
    id: serviceItemId,
    typeKeywords: finalTypeKeywords
  });
};
async function getTokenFromProvider(provider) {
  try {
    const token = await provider.connect();
    return { result: token };
  }
  catch (error) {
    return { error: { code: "unhandledError" } };
  }
}




/***/ })

}]);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2lkZ2V0cy9jaHVua3MvYXJjZ2lzX2FuYWx5c2lzX25vZGVfbW9kdWxlc19hcmNnaXNfYXBwLWNvbXBvbmVudHNfZGlzdF9lc21fb3ZlcndyLTcwNWE1MC5qcyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDaUU7QUFDcUI7QUFDMUI7QUFDbUQ7QUFDekM7O0FBRXRFO0FBQ0EsVUFBVSxzR0FBc0c7QUFDaEg7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHVLQUF1SyxrREFBZ0M7QUFDdk07QUFDQTtBQUNBLGNBQWMsa0RBQTJCO0FBQ3pDO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHNEQUFzRCwyRUFBMkUsZ0RBQWdEO0FBQ2pMLHdEQUF3RCxrRkFBa0Y7QUFDMUk7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxzRUFBc0UsMENBQTBDLDBGQUEwRjtBQUMxTTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxtREFBbUQ7QUFDbkQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGtCQUFrQiw0Q0FBNEM7QUFDOUQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsWUFBWSxzT0FBc087QUFDbFA7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsZ0VBQWdFO0FBQ2hFO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQSxnQ0FBZ0MsNERBQWMsR0FBRyxzRkFBc0Y7QUFDdkk7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFVBQVUsc0JBQXNCO0FBQ2hDO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTCxVQUFVLDREQUFjLEdBQUcsOENBQThDO0FBQ3pFO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsYUFBYSxTQUFTO0FBQ3RCO0FBQ0E7QUFDQTtBQUNBLGlCQUFpQixlQUFlLFNBQVMsUUFBUTtBQUNqRDtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSCxlQUFlLHNEQUFXLGtCQUFrQjtBQUM1QztBQUNBO0FBQ0E7QUFDQSxZQUFZLE1BQU07QUFDbEIsOEJBQThCLHNEQUFPO0FBQ3JDLG1DQUFtQyxzREFBTztBQUMxQztBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBLGFBQWE7QUFDYjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxhQUFhLFNBQVM7QUFDdEI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSwyQkFBMkIsMkRBQVU7QUFDckMsNEJBQTRCLDZEQUFhLFlBQVksK0VBQStFO0FBQ3BJO0FBQ0EsZUFBZSxTQUFTO0FBQ3hCO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQTtBQUNBLGFBQWEsU0FBUztBQUN0QjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsaUJBQWlCLGVBQWUsR0FBRyx5QkFBeUIsU0FBUyxRQUFRO0FBQzdFO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSwyQkFBMkIsc0RBQVcsa0JBQWtCO0FBQ3hELGFBQWE7QUFDYjtBQUNBO0FBQ0E7QUFDQSxhQUFhLFNBQVM7QUFDdEI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsZUFBZSwyREFBVTtBQUN6QjtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBO0FBQ0E7QUFDQSxhQUFhO0FBQ2I7QUFDQTtBQUNBLGFBQWEsU0FBUztBQUN0QjtBQUNBOztBQUV1TiIsInNvdXJjZXMiOlsid2VicGFjazovL2V4Yi1jbGllbnQvLi9leHRlbnNpb25zL3dpZGdldHMvYXJjZ2lzL2FuYWx5c2lzL25vZGVfbW9kdWxlcy9AYXJjZ2lzL2FwcC1jb21wb25lbnRzL2Rpc3QvZXNtL292ZXJ3cml0ZS0zMDQ5YjdhZi5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKiFcbiAqIEFsbCBtYXRlcmlhbCBjb3B5cmlnaHQgRVNSSSwgQWxsIFJpZ2h0cyBSZXNlcnZlZCwgdW5sZXNzIG90aGVyd2lzZSBzcGVjaWZpZWQuXG4gKiB2My4wLjk5XG4gKi9cbmltcG9ydCB7IHcgYXMgZ2V0SXRlbVN0YXR1cyB9IGZyb20gJy4vZmVhdHVyZS1sYXllci0zOGNkYWU4Ny5qcyc7XG5pbXBvcnQgeyBwIGFzIHB1Ymxpc2hTZXJ2aWNlLCBjIGFzIGNoZWNrSm9iU3RhdHVzIH0gZnJvbSAnLi9wdWJsaXNoLWl0ZW0tODJmZmE3ZjguanMnO1xuaW1wb3J0IHsgZSBhcyB1cGRhdGVJdGVtIH0gZnJvbSAnLi9zZXJ2ZXItaXRlbS1mMTIxNTNlNi5qcyc7XG5pbXBvcnQgeyBiIGFzIEFwcGVuZE92ZXJ3cml0ZVB1Ymxpc2hUeXBlcywgQSBhcyBBcHBlbmRPdmVyd3JpdGVDbG91ZFB1Ymxpc2hUeXBlcyB9IGZyb20gJy4vYXBwZW5kLTU4YTdlN2FiLmpzJztcbmltcG9ydCB7IGUgYXMgZm9ybVJlcXVlc3QsIHIgYXMgcmVxdWVzdCB9IGZyb20gJy4vcG9ydGFsLTc5Y2FhZWZmLmpzJztcblxuY29uc3QgZ2V0Rm9ybVBhcmFtZXRlcnMgPSAoaXRlbSkgPT4ge1xuICBjb25zdCB7IG5hbWUsIHRpdGxlLCB0YWdzLCB0eXBlLCB0eXBlS2V5d29yZHMsIGFjY2Vzc0luZm9ybWF0aW9uLCBsaWNlbnNlSW5mbywgZGVzY3JpcHRpb24sIHNuaXBwZXQsIGV4dGVudCB9ID0gaXRlbTtcbiAgcmV0dXJuIHtcbiAgICBuYW1lLFxuICAgIHRpdGxlLFxuICAgIHRhZ3MsXG4gICAgdHlwZSxcbiAgICB0eXBlS2V5d29yZHMsXG4gICAgYWNjZXNzSW5mb3JtYXRpb24sXG4gICAgbGljZW5zZUluZm8sXG4gICAgZGVzY3JpcHRpb24sXG4gICAgc25pcHBldCxcbiAgICBleHRlbnRcbiAgfTtcbn07XG5jb25zdCBnZXRGb3JtRGF0YSA9IChpdGVtLCBhZGRJdGVtUHJvcHMpID0+IHtcbiAgLy9mb3IgcGFyYW1ldGVycyBvZiB1cGRhdGluZyBzb3VyY2UgZGF0YSBvZiBmZWF0dXJlIGxheWVyLlxuICBjb25zdCBvdmVyd3JpdGVPbiA9ICEhYWRkSXRlbVByb3BzLm92ZXJ3cml0ZTtcbiAgY29uc3QgZm9ybVByb3BlcnRpZXMgPSBnZXRGb3JtUGFyYW1ldGVycyhpdGVtKTtcbiAgY29uc3QgZm9ybURhdGEgPSBuZXcgRm9ybURhdGEoKTtcbiAgT2JqZWN0LmtleXMoZm9ybVByb3BlcnRpZXMpLmZvckVhY2goKHByb3BlcnR5KSA9PiB7XG4gICAgdmFyIF9hO1xuICAgIGlmIChwcm9wZXJ0eSA9PT0gXCJkZXNjcmlwdGlvblwiIHx8IHByb3BlcnR5ID09PSBcInNuaXBwZXRcIiB8fCBwcm9wZXJ0eSA9PT0gXCJleHRlbnRcIikge1xuICAgICAgZm9ybURhdGEuYXBwZW5kKHByb3BlcnR5LCBhZGRJdGVtUHJvcHMua2VlcERlc2NyaXB0aW9uID8gZm9ybVByb3BlcnRpZXNbcHJvcGVydHldIDogXCJcIik7XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgZm9ybURhdGEuYXBwZW5kKHByb3BlcnR5LCAoX2EgPSBmb3JtUHJvcGVydGllc1twcm9wZXJ0eV0pICE9PSBudWxsICYmIF9hICE9PSB2b2lkIDAgPyBfYSA6IFwiXCIpO1xuICAgIH1cbiAgfSk7XG4gIGZvcm1EYXRhLnNldChcIm92ZXJ3cml0ZVwiLCBcInRydWVcIik7XG4gIGZvcm1EYXRhLnNldChcImFzeW5jXCIsIFwidHJ1ZVwiKTtcbiAgZm9ybURhdGEuc2V0KFwiZmlsZVwiLCBhZGRJdGVtUHJvcHMuZmlsZSwgaXRlbS50aXRsZSk7XG4gIGlmIChvdmVyd3JpdGVPbikge1xuICAgIGZvcm1EYXRhLnNldChcIm92ZXJ3cml0ZVNlcnZpY2VcIiwgXCJvblwiKTtcbiAgfVxuICBmb3JtRGF0YS5zZXQoXCJ1c2VEZXNjcmlwdGlvblwiLCBcIm9uXCIpO1xuICByZXR1cm4gZm9ybURhdGE7XG59O1xuY29uc3QgY3JlYXRlT3ZlcndyaXRlUHVibGlzaFBhcmFtZXRlcnMgPSAoc2VydmljZUluZm8sIGl0ZW0sIG5ld0l0ZW1JZCkgPT4ge1xuICB2YXIgX2EsIF9iLCBfYywgX2QsIF9lO1xuICBjb25zdCBpdGVtUHVibGlzaFBhcmFtZXRlcnMgPSBpdGVtID09PSBudWxsIHx8IGl0ZW0gPT09IHZvaWQgMCA/IHZvaWQgMCA6IGl0ZW0ucHVibGlzaFBhcmFtZXRlcnM7XG4gIGNvbnN0IGl0ZW1EYXRhID0gKF9hID0gaXRlbSA9PT0gbnVsbCB8fCBpdGVtID09PSB2b2lkIDAgPyB2b2lkIDAgOiBpdGVtLnNvdXJjZURhdGEpICE9PSBudWxsICYmIF9hICE9PSB2b2lkIDAgPyBfYSA6IGl0ZW07XG4gIGNvbnN0IHR5cGUgPSAoX2MgPSAoX2IgPSBpdGVtID09PSBudWxsIHx8IGl0ZW0gPT09IHZvaWQgMCA/IHZvaWQgMCA6IGl0ZW0uc291cmNlRGF0YSkgPT09IG51bGwgfHwgX2IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9iLnR5cGUpICE9PSBudWxsICYmIF9jICE9PSB2b2lkIDAgPyBfYyA6IEFwcGVuZE92ZXJ3cml0ZUNsb3VkUHVibGlzaFR5cGVzWyhfZCA9IGl0ZW0gPT09IG51bGwgfHwgaXRlbSA9PT0gdm9pZCAwID8gdm9pZCAwIDogaXRlbS5jbG91ZFByb3ZpZGVySW5mbykgPT09IG51bGwgfHwgX2QgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9kLm1pbWVUeXBlXTtcbiAgY29uc3QgZmluYWxPdmVyd3JpdGVQYXJhbWV0ZXJzID0ge1xuICAgIGl0ZW1JZDogbmV3SXRlbUlkICE9PSBudWxsICYmIG5ld0l0ZW1JZCAhPT0gdm9pZCAwID8gbmV3SXRlbUlkIDogaXRlbURhdGEuaWQsXG4gICAgZmlsZXR5cGU6IEFwcGVuZE92ZXJ3cml0ZVB1Ymxpc2hUeXBlc1t0eXBlLnRvTG93ZXJDYXNlKCldLFxuICAgIG92ZXJ3cml0ZTogdHJ1ZSxcbiAgICBkZWxldGVTb3VyY2VJdGVtVXBvbkNvbXBsZXRpb246ICEhbmV3SXRlbUlkXG4gIH07XG4gIGxldCBwdWJsaXNoUGFyYW1ldGVycztcbiAgc3dpdGNoICh0eXBlKSB7XG4gICAgY2FzZSBcIkNTVlwiOiB7XG4gICAgICBjb25zdCBsYXllckluZm8gPSBPYmplY3QuYXNzaWduKE9iamVjdC5hc3NpZ24oe30sIChfZSA9IHNlcnZpY2VJbmZvLmxheWVycykgPT09IG51bGwgfHwgX2UgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9lWzBdKSwgeyBmaWVsZHM6IGl0ZW1QdWJsaXNoUGFyYW1ldGVycy5sYXllckluZm8uZmllbGRzIH0pO1xuICAgICAgcHVibGlzaFBhcmFtZXRlcnMgPSBPYmplY3QuYXNzaWduKE9iamVjdC5hc3NpZ24oeyBsYXllckluZm8sIG5hbWU6IGl0ZW1QdWJsaXNoUGFyYW1ldGVycy5uYW1lIHx8IGl0ZW1EYXRhLnRpdGxlLnJlcGxhY2UoLyAvZywgXCJfXCIpIH0sIGl0ZW1QdWJsaXNoUGFyYW1ldGVycyksIHNlcnZpY2VJbmZvKTtcbiAgICAgIGJyZWFrO1xuICAgIH1cbiAgICBjYXNlIFwiTWljcm9zb2Z0IEV4Y2VsXCI6IHtcbiAgICAgIHB1Ymxpc2hQYXJhbWV0ZXJzID0gZ2VuZXJhdGVFeGNlbE92ZXJ3cml0ZVB1Ymxpc2hQYXJhbWV0ZXJzKGl0ZW1QdWJsaXNoUGFyYW1ldGVycywgc2VydmljZUluZm8pO1xuICAgICAgYnJlYWs7XG4gICAgfVxuICAgIGRlZmF1bHQ6XG4gICAgICBwdWJsaXNoUGFyYW1ldGVycyA9IE9iamVjdC5hc3NpZ24oT2JqZWN0LmFzc2lnbihPYmplY3QuYXNzaWduKHt9LCBpdGVtUHVibGlzaFBhcmFtZXRlcnMpLCBzZXJ2aWNlSW5mbyksIHsgbmFtZTogaXRlbURhdGEudGl0bGUgPyBpdGVtRGF0YS50aXRsZS5yZXBsYWNlKC8gL2csIFwiX1wiKSA6IGl0ZW0udGl0bGUucmVwbGFjZSgvIC9nLCBcIl9cIikgfSk7XG4gICAgICBicmVhaztcbiAgfVxuICBmaW5hbE92ZXJ3cml0ZVBhcmFtZXRlcnMucHVibGlzaFBhcmFtZXRlcnMgPSBKU09OLnN0cmluZ2lmeShwdWJsaXNoUGFyYW1ldGVycyk7XG4gIHJldHVybiBmaW5hbE92ZXJ3cml0ZVBhcmFtZXRlcnM7XG59O1xuY29uc3QgZ2VuZXJhdGVFeGNlbE92ZXJ3cml0ZVB1Ymxpc2hQYXJhbWV0ZXJzID0gKHB1Ymxpc2hQYXJhbWV0ZXJzLCBzZXJ2aWNlSW5mbykgPT4ge1xuICBjb25zdCBmaW5hbE92ZXJ3cml0ZVBhcmFtZXRlcnMgPSBPYmplY3QuYXNzaWduKHt9LCBzZXJ2aWNlSW5mbyk7XG4gIC8vc2VydmljZSBsZXZlbCBwcm9wZXJ0aWVzXG4gIGZpbmFsT3ZlcndyaXRlUGFyYW1ldGVycy5uYW1lID0gcHVibGlzaFBhcmFtZXRlcnMubmFtZTtcbiAgZmluYWxPdmVyd3JpdGVQYXJhbWV0ZXJzLnNvdXJjZVNSID0gcHVibGlzaFBhcmFtZXRlcnMuc291cmNlU1I7XG4gIGZpbmFsT3ZlcndyaXRlUGFyYW1ldGVycy50YXJnZXRTUiA9IHB1Ymxpc2hQYXJhbWV0ZXJzLnRhcmdldFNSO1xuICAvL3RhYmxlIGlzIG5vdCB2YWxpZCBpbiBleGNlbCBwdWJsaXNoIHBhcmFtZXRlcnMsIHNvIGNvcHkgdG8gbGF5ZXJcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBmaW5hbE92ZXJ3cml0ZVBhcmFtZXRlcnMudGFibGVzLmxlbmd0aDsgaSsrKSB7XG4gICAgLy9pZiBleGNlbCBoYXMgUmV2aWV3IFRhYmxlLCBpZ25vcmUgaXRcbiAgICBpZiAoZmluYWxPdmVyd3JpdGVQYXJhbWV0ZXJzLnRhYmxlc1tpXS5uYW1lICE9IFwiUmV2aWV3XCIpIHtcbiAgICAgIGZpbmFsT3ZlcndyaXRlUGFyYW1ldGVycy5sYXllcnNbZmluYWxPdmVyd3JpdGVQYXJhbWV0ZXJzLmxheWVycy5sZW5ndGhdID0gZmluYWxPdmVyd3JpdGVQYXJhbWV0ZXJzLnRhYmxlc1tpXTtcbiAgICB9XG4gIH1cbiAgZm9yIChsZXQgbGF5ZXIgb2YgZmluYWxPdmVyd3JpdGVQYXJhbWV0ZXJzLmxheWVycykge1xuICAgIGNvbnN0IHsgZXhjZWxTaGVldElkLCBsb2NhdGlvblR5cGUsIGxhdGl0dWRlRmllbGROYW1lLCBsb25naXR1ZGVGaWVsZE5hbWUsIGdlb2NvZGVTZXJ2aWNlVXJsLCBzb3VyY2VMb2NhbGUsIHNvdXJjZUNvdW50cnksIHN0YW5kYXJkaXplZEZpZWxkTmFtZXMsIGFkZHJlc3NGaWVsZHMsIGNvb3JkaW5hdGVGaWVsZE5hbWUsIGNvb3JkaW5hdGVGaWVsZFR5cGUsIGZpZWxkcywgZGF0ZUZpZWxkc1RpbWVSZWZlcmVuY2UgfSA9IHB1Ymxpc2hQYXJhbWV0ZXJzLmxheWVyc1tsYXllci5pZF07XG4gICAgY29uc3QgcHJvcGVydGllc1RvVXBkYXRlID0ge1xuICAgICAgZXhjZWxTaGVldElkLFxuICAgICAgbG9jYXRpb25UeXBlLFxuICAgICAgbGF0aXR1ZGVGaWVsZE5hbWUsXG4gICAgICBsb25naXR1ZGVGaWVsZE5hbWUsXG4gICAgICBnZW9jb2RlU2VydmljZVVybCxcbiAgICAgIHNvdXJjZUxvY2FsZSxcbiAgICAgIHNvdXJjZUNvdW50cnksXG4gICAgICBzdGFuZGFyZGl6ZWRGaWVsZE5hbWVzLFxuICAgICAgYWRkcmVzc0ZpZWxkcyxcbiAgICAgIGNvb3JkaW5hdGVGaWVsZE5hbWUsXG4gICAgICBjb29yZGluYXRlRmllbGRUeXBlLFxuICAgICAgZmllbGRzLFxuICAgICAgZGF0ZUZpZWxkc1RpbWVSZWZlcmVuY2VcbiAgICB9O1xuICAgIGZpbmFsT3ZlcndyaXRlUGFyYW1ldGVycy5sYXllcnNbbGF5ZXIuaWRdID0gT2JqZWN0LmFzc2lnbih7fSwgcHJvcGVydGllc1RvVXBkYXRlKTtcbiAgfVxuICByZXR1cm4gZmluYWxPdmVyd3JpdGVQYXJhbWV0ZXJzO1xufTtcblxuY29uc3QgcHVibGlzaEZvck92ZXJ3cml0ZSA9IGFzeW5jIChpdGVtLCB0aXRsZSwgcG9ydGFsLCB1c2VyKSA9PiB7XG4gIHZhciBfYSwgX2I7XG4gIGNvbnN0IHBhcmFtcyA9IGF3YWl0IGdldFB1Ymxpc2hQYXJhbWV0ZXJzKGl0ZW0sIHBvcnRhbCwgdXNlcik7XG4gIGNvbnN0IHB1Ymxpc2hSZXNwb25zZSA9IGF3YWl0IHB1Ymxpc2hTZXJ2aWNlKHsgaXRlbUlkOiBpdGVtLnNvdXJjZURhdGEuaWQsIHVzZXIsIHRpdGxlLCBpdGVtT3duZXJVcmw6IGl0ZW0uaXRlbU93bmVyLnVzZXJDb250ZW50VXJsIH0sIC8vICEgVXNlIGZldGNoVXNlciBpZiBpdGVtT3duZXIgaXMgbm90IGF2YWlsYWJsZVxuICBwYXJhbXMpO1xuICBjb25zdCBzZXJ2aWNlID0gKF9iID0gKF9hID0gcHVibGlzaFJlc3BvbnNlLnJlc3VsdCkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLnNlcnZpY2VzKSA9PT0gbnVsbCB8fCBfYiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2JbMF07XG4gIHJldHVybiB7XG4gICAgaWQ6IHNlcnZpY2UgPT09IG51bGwgfHwgc2VydmljZSA9PT0gdm9pZCAwID8gdm9pZCAwIDogc2VydmljZS5zZXJ2aWNlSXRlbUlkLFxuICAgIGpvYklkOiBzZXJ2aWNlID09PSBudWxsIHx8IHNlcnZpY2UgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHNlcnZpY2Uuam9iSWQsXG4gICAgc2VydmljZVR5cGU6IHNlcnZpY2UgPT09IG51bGwgfHwgc2VydmljZSA9PT0gdm9pZCAwID8gdm9pZCAwIDogc2VydmljZS50eXBlLFxuICAgIHNlcnZpY2VVcmw6IHNlcnZpY2UgPT09IG51bGwgfHwgc2VydmljZSA9PT0gdm9pZCAwID8gdm9pZCAwIDogc2VydmljZS5zZXJ2aWNldXJsLFxuICAgIG92ZXJ3cml0ZVN0YXR1czogXCJcIlxuICB9O1xufTtcbmNvbnN0IGdldFB1Ymxpc2hQYXJhbWV0ZXJzID0gYXN5bmMgKGl0ZW0sIHBvcnRhbCwgdXNlciwgbmV3SXRlbUlkKSA9PiB7XG4gIGNvbnN0IHsgcmVzdWx0OiBzZXJ2aWNlSW5mbyB9ID0gYXdhaXQgZmV0Y2hGZWF0dXJlU2VydmljZUluZm9Gb3JPdmVyd3JpdGUoaXRlbSwgcG9ydGFsLCBmYWxzZSwgdXNlcik7XG4gIHJldHVybiBhd2FpdCBjcmVhdGVPdmVyd3JpdGVQdWJsaXNoUGFyYW1ldGVycyhzZXJ2aWNlSW5mbywgaXRlbSwgbmV3SXRlbUlkKTtcbn07XG5jb25zdCBmZXRjaEFuZFVwZGF0ZUl0ZW0gPSBhc3luYyAoaXRlbSwgdXNlckNvbnRlbnRVcmwsIGFkZEl0ZW1Qcm9wcykgPT4ge1xuICBjb25zdCBzb3VyY2VEYXRhID0gaXRlbS5zb3VyY2VEYXRhO1xuICB0cnkge1xuICAgIGF3YWl0IHVwZGF0ZUl0ZW1PdmVyd3JpdGUoc291cmNlRGF0YSwgdXNlckNvbnRlbnRVcmwsIHtcbiAgICAgIGZpbGU6IGFkZEl0ZW1Qcm9wcy5maWxlLFxuICAgICAgb3ZlcndyaXRlOiBhZGRJdGVtUHJvcHMub3ZlcndyaXRlLFxuICAgICAga2VlcERlc2NyaXB0aW9uOiBhZGRJdGVtUHJvcHMua2VlcERlc2NyaXB0aW9uXG4gICAgfSk7XG4gICAgYXdhaXQgY2hlY2tKb2JTdGF0dXMoeyBpZDogc291cmNlRGF0YS5pZCwgZm9sZGVyOiBcIlwiLCBzdWNjZXNzOiB0cnVlIH0pO1xuICAgIHJldHVybiB7fTtcbiAgfVxuICBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zb2xlLmVycm9yKGVycm9yKTtcbiAgICByZXR1cm4geyBlcnJvcjogeyBjb2RlOiBcInVuaGFuZGxlZEVycm9yXCIgfSB9O1xuICB9XG59O1xuY29uc3QgdXBkYXRlSXRlbU92ZXJ3cml0ZSA9IGFzeW5jIChpdGVtLCB1c2VyQ29udGVudFVybCwgYWRkSXRlbVByb3BzKSA9PiB7XG4gIGNvbnN0IHVybCA9IGAke3VzZXJDb250ZW50VXJsfS9pdGVtcy8ke2l0ZW0uaWR9L3VwZGF0ZWA7XG4gIGNvbnN0IGZvcm1EYXRhID0gZ2V0Rm9ybURhdGEoaXRlbSwge1xuICAgIGZpbGU6IGFkZEl0ZW1Qcm9wcy5maWxlLFxuICAgIG92ZXJ3cml0ZTogYWRkSXRlbVByb3BzLm92ZXJ3cml0ZSxcbiAgICBrZWVwRGVzY3JpcHRpb246IGFkZEl0ZW1Qcm9wcy5rZWVwRGVzY3JpcHRpb25cbiAgfSk7XG4gIHJldHVybiBhd2FpdCBmb3JtUmVxdWVzdCh1cmwsIGZvcm1EYXRhLCB7fSwgXCJwb3N0XCIpO1xufTtcbmNvbnN0IGZldGNoRmVhdHVyZVNlcnZpY2VJbmZvRm9yT3ZlcndyaXRlID0gYXN5bmMgKGl0ZW0sIHBvcnRhbCwgaXNTZWN1cmUsIHVzZXIpID0+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCB7IHVybCB9ID0gaXRlbTtcbiAgICBjb25zdCBzZXJ2aWNlSW5mbyA9IGF3YWl0IHJlcXVlc3QodXJsKTtcbiAgICBjb25zdCBzZXJ2aWNlTGF5ZXJJbmZvID0gYXdhaXQgcmVxdWVzdCh1cmwgKyBcIi9sYXllcnNcIik7XG4gICAgY29uc3QgZm9ybWF0dGVkTGF5ZXJzID0gc2VydmljZUxheWVySW5mbyA9PT0gbnVsbCB8fCBzZXJ2aWNlTGF5ZXJJbmZvID09PSB2b2lkIDAgPyB2b2lkIDAgOiBzZXJ2aWNlTGF5ZXJJbmZvLmxheWVycy5tYXAoKGxheWVyKSA9PiB7XG4gICAgICBkZWxldGUgbGF5ZXIuZmllbGRzO1xuICAgICAgcmV0dXJuIGxheWVyO1xuICAgIH0pO1xuICAgIHNlcnZpY2VJbmZvLnRhYmxlcyA9IFsuLi5zZXJ2aWNlTGF5ZXJJbmZvID09PSBudWxsIHx8IHNlcnZpY2VMYXllckluZm8gPT09IHZvaWQgMCA/IHZvaWQgMCA6IHNlcnZpY2VMYXllckluZm8udGFibGVzXTtcbiAgICBzZXJ2aWNlSW5mby5sYXllcnMgPSBbLi4uZm9ybWF0dGVkTGF5ZXJzXTtcbiAgICByZXR1cm4geyByZXN1bHQ6IHNlcnZpY2VJbmZvIH07XG4gIH1cbiAgY2F0Y2ggKGVycm9yKSB7XG4gICAgaWYgKCFpc1NlY3VyZSAmJiAoKChlcnJvciA9PT0gbnVsbCB8fCBlcnJvciA9PT0gdm9pZCAwID8gdm9pZCAwIDogZXJyb3IuY29kZSkgPT09IDQ5OSAmJiAoZXJyb3IgPT09IG51bGwgfHwgZXJyb3IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGVycm9yLm1lc3NhZ2UpID09PSBcIlRva2VuIFJlcXVpcmVkXCIpIHx8IGVycm9yLmNvZGUgPT09IDQwMykgJiYgdXNlcikge1xuICAgICAgcmV0dXJuIGZldGNoRmVhdHVyZVNlcnZpY2VJbmZvRm9yT3ZlcndyaXRlKGl0ZW0sIHBvcnRhbCwgdHJ1ZSwgdXNlcik7XG4gICAgfVxuICAgIGNvbnNvbGUuZXJyb3IoZXJyb3IpO1xuICAgIHJldHVybiB7IGVycm9yOiB7IGNvZGU6IFwidW5oYW5kbGVkRXJyb3JcIiB9IH07XG4gIH1cbn07XG5jb25zdCByZXNldFNlcnZpY2VUaXRsZSA9IGFzeW5jIChpdGVtKSA9PiB7XG4gIGxldCBrZXl3b3JkcyA9IGl0ZW0udHlwZUtleXdvcmRzLnRvU3RyaW5nKCk7XG4gIGNvbnN0IHVwZGF0ZUNvbnRlbnQgPSB7XG4gICAgdGl0bGU6IGl0ZW0udGl0bGUgfHwgXCJcIixcbiAgICB0YWdzOiBpdGVtLnRhZ3MudG9TdHJpbmcoKSB8fCBcIlwiXG4gIH07XG4gIGlmIChpdGVtLnR5cGVLZXl3b3Jkcy5pbmRleE9mKFwiSW52b2x2ZWQgTG9va3VwXCIpICE9PSAtMSkge1xuICAgIGtleXdvcmRzICs9IFwiLHNob3dVbm1hdGNoZWRBZGRyZXNzZXNcIjtcbiAgICB1cGRhdGVDb250ZW50W1widHlwZUtleXdvcmRzXCJdID0ga2V5d29yZHM7XG4gIH1cbiAgdHJ5IHtcbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHVwZGF0ZUl0ZW0oaXRlbS5pZCwgdXBkYXRlQ29udGVudCk7XG4gICAgY29uc3Qgam9iU3RhdHVzID0gYXdhaXQgZ2V0SXRlbVN0YXR1cyhpdGVtLmlkLCB7IHN1Y2Nlc3M6IHJlc3BvbnNlID09PSBudWxsIHx8IHJlc3BvbnNlID09PSB2b2lkIDAgPyB2b2lkIDAgOiByZXNwb25zZS5zdWNjZXNzIH0pO1xuICAgIGlmIChqb2JTdGF0dXMuc3RhdHVzID09PSBcImZhaWxlZFwiKSB7XG4gICAgICByZXR1cm4geyBlcnJvcjogeyBjb2RlOiBcInVuaGFuZGxlZEVycm9yXCIgfSB9O1xuICAgIH1cbiAgICByZXR1cm4geyByZXN1bHQ6IGpvYlN0YXR1cyB9O1xuICB9XG4gIGNhdGNoIChlcnJvcikge1xuICAgIGNvbnNvbGUuZXJyb3IoXCJlcnJvcjpcIiwgZXJyb3IpO1xuICAgIHJldHVybiB7IGVycm9yOiB7IGNvZGU6IFwidW5oYW5kbGVkRXJyb3JcIiB9IH07XG4gIH1cbn07XG4vL2ZvciB2ZWN0b3IgdGlsZSBzZXJ2aWNlIGNhc2VcbmNvbnN0IHVwZGF0ZUl0ZW1SZXNvdXJjZSA9IGFzeW5jIChpdGVtLCB1c2VyQ29udGVudFVybCwgYWRkSXRlbVByb3BzKSA9PiB7XG4gIGNvbnN0IGZvbGRlcklkID0gaXRlbS5mb2xkZXJJZCB8fCBpdGVtLm93bmVyRm9sZGVyO1xuICBjb25zdCB1cmwgPSBgJHt1c2VyQ29udGVudFVybH0vJHtmb2xkZXJJZCA/IGZvbGRlcklkIDogXCJcIn0vaXRlbXMvJHtpdGVtLmlkfS91cGRhdGVSZXNvdXJjZXNgO1xuICBjb25zdCBmb3JtRGF0YSA9IG5ldyBGb3JtRGF0YSgpO1xuICBmb3JtRGF0YS5zZXQoXCJmaWxlXCIsIGFkZEl0ZW1Qcm9wcy5maWxlKTtcbiAgZm9ybURhdGEuc2V0KFwicmVzb3VyY2VzUHJlZml4XCIsIFwic3R5bGVzXCIpO1xuICBmb3JtRGF0YS5zZXQoXCJmaWxlbmFtZVwiLCBcInJvb3QuanNvblwiKTtcbiAgdHJ5IHtcbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGZvcm1SZXF1ZXN0KHVybCwgZm9ybURhdGEsIHt9LCBcInBvc3RcIik7XG4gICAgcmV0dXJuIHsgcmVzdWx0OiByZXNwb25zZSB9O1xuICB9XG4gIGNhdGNoIChlcnJvcikge1xuICAgIGNvbnNvbGUuZXJyb3IoZXJyb3IpO1xuICAgIHJldHVybiB7IGVycm9yOiB7IGNvZGU6IFwidW5oYW5kbGVkRXJyb3JcIiB9IH07XG4gIH1cbn07XG5jb25zdCB1cGRhdGVUeXBlS2V5d29yZHMgPSBhc3luYyAocHVibGlzaFBhcmFtZXRlcnNKU09OLCBpdGVtLCBzZXJ2aWNlSXRlbUlkKSA9PiB7XG4gIGxldCB0eXBlS2V5d29yZHMgPSBbXCJDbG91ZCBEcml2ZVwiXTtcbiAgY29uc3QgcHVibGlzaFBhcmFtZXRlcnMgPSBKU09OLnBhcnNlKHB1Ymxpc2hQYXJhbWV0ZXJzSlNPTik7XG4gIGlmIChwdWJsaXNoUGFyYW1ldGVycy5sb2NhdGlvblR5cGUgPT09IFwiYWRkcmVzc1wiIHx8XG4gICAgKHB1Ymxpc2hQYXJhbWV0ZXJzLmxheWVyc1swXSAmJiBwdWJsaXNoUGFyYW1ldGVycy5sYXllcnNbMF0ubG9jYXRpb25UeXBlID09PSBcImFkZHJlc3NcIikpIHtcbiAgICB0eXBlS2V5d29yZHMucHVzaChcInNob3dVbm1hdGNoZWRBZGRyZXNzZXNcIik7XG4gICAgdHlwZUtleXdvcmRzLnB1c2goXCJJbnZvbHZlZCBMb29rdXBcIik7XG4gIH1cbiAgZWxzZSBpZiAocHVibGlzaFBhcmFtZXRlcnMubG9jYXRpb25UeXBlID09PSBcIm5vbmVcIiB8fFxuICAgIChwdWJsaXNoUGFyYW1ldGVycy5sYXllcnNbMF0gJiYgcHVibGlzaFBhcmFtZXRlcnMubGF5ZXJzWzBdLmxvY2F0aW9uVHlwZSA9PT0gXCJub25lXCIpKSB7XG4gICAgdHlwZUtleXdvcmRzLnB1c2goXCJUYWJsZVwiKTtcbiAgfVxuICBjb25zdCBmaW5hbFR5cGVLZXl3b3JkcyA9IHR5cGVLZXl3b3Jkcy5qb2luKFwiLFwiKTtcbiAgcmV0dXJuIGF3YWl0IHVwZGF0ZUl0ZW0oaXRlbS5pZCwge1xuICAgIGZvbGRlcklkOiBpdGVtID09PSBudWxsIHx8IGl0ZW0gPT09IHZvaWQgMCA/IHZvaWQgMCA6IGl0ZW0uZm9sZGVySWQsXG4gICAgaWQ6IHNlcnZpY2VJdGVtSWQsXG4gICAgdHlwZUtleXdvcmRzOiBmaW5hbFR5cGVLZXl3b3Jkc1xuICB9KTtcbn07XG5hc3luYyBmdW5jdGlvbiBnZXRUb2tlbkZyb21Qcm92aWRlcihwcm92aWRlcikge1xuICB0cnkge1xuICAgIGNvbnN0IHRva2VuID0gYXdhaXQgcHJvdmlkZXIuY29ubmVjdCgpO1xuICAgIHJldHVybiB7IHJlc3VsdDogdG9rZW4gfTtcbiAgfVxuICBjYXRjaCAoZXJyb3IpIHtcbiAgICByZXR1cm4geyBlcnJvcjogeyBjb2RlOiBcInVuaGFuZGxlZEVycm9yXCIgfSB9O1xuICB9XG59XG5cbmV4cG9ydCB7IGdldFB1Ymxpc2hQYXJhbWV0ZXJzIGFzIGEsIHVwZGF0ZUl0ZW1PdmVyd3JpdGUgYXMgYiwgdXBkYXRlSXRlbVJlc291cmNlIGFzIGMsIGZldGNoQW5kVXBkYXRlSXRlbSBhcyBmLCBnZXRUb2tlbkZyb21Qcm92aWRlciBhcyBnLCBwdWJsaXNoRm9yT3ZlcndyaXRlIGFzIHAsIHJlc2V0U2VydmljZVRpdGxlIGFzIHIsIHVwZGF0ZVR5cGVLZXl3b3JkcyBhcyB1IH07XG4iXSwibmFtZXMiOltdLCJzb3VyY2VSb290IjoiIn0=